<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="frida," />




  


  <link rel="alternate" href="/atom.xml" title="Sakuraのblog" type="application/atom+xml" />






<meta name="description" content="致谢本篇文章学到的内容来自且完全来自r0ysue的知识星球，推荐一下。 Frida环境https:&#x2F;&#x2F;github.com&#x2F;frida&#x2F;frida pyenvpython全版本随机切换，这里提供macOS上的配置方法 123brew updatebrew install pyenvecho -e &#39;if command -v pyenv 1&gt;&#x2F;dev&#x2F;null 2">
<meta property="og:type" content="article">
<meta property="og:title" content="Frida Android hook">
<meta property="og:url" content="http://eternalsakura13.com/2020/07/04/frida/index.html">
<meta property="og:site_name" content="Sakuraのblog">
<meta property="og:description" content="致谢本篇文章学到的内容来自且完全来自r0ysue的知识星球，推荐一下。 Frida环境https:&#x2F;&#x2F;github.com&#x2F;frida&#x2F;frida pyenvpython全版本随机切换，这里提供macOS上的配置方法 123brew updatebrew install pyenvecho -e &#39;if command -v pyenv 1&gt;&#x2F;dev&#x2F;null 2">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-07-061015.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-17-134140.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-17-134837.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-100849.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-120749.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121130.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121255.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121403.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125545.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125604.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125824.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-132438.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-29-092212.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-29-092522.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-004653.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-004915.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-033242.jpg">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-033633.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-034053.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-154643.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-155007.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-065833.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-103826.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104029.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104113.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104131.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-102552.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101517.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101821.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101843.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-121051.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-102944.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-102844.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-112221.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-120940.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-121012.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-120907.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161438.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161519.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161601.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161613.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-082029.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-095937.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-095955.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-100022.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-100042.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-122151.png">
<meta property="og:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-142324.png">
<meta property="article:published_time" content="2020-07-03T17:10:01.471Z">
<meta property="article:modified_time" content="2020-07-08T07:37:41.377Z">
<meta property="article:author" content="sakura">
<meta property="article:tag" content="frida">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-07-061015.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'QOPH9ID41Z',
      apiKey: '',
      indexName: 'sakura',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://eternalsakura13.com/2020/07/04/frida/"/>





  <title>Frida Android hook | Sakuraのblog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-113420358-1', 'auto');
  ga('send', 'pageview');
</script>





<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sakuraのblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-buglist">
          <a href="/buglist/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            BugList
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eternalsakura13.com/2020/07/04/frida/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sakura">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/sakura_heart.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sakuraのblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Frida Android hook</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-04T01:10:01+08:00">
                2020-07-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android%E9%80%86%E5%90%91/" itemprop="url" rel="index">
                    <span itemprop="name">Android逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/04/frida/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/07/04/frida/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/07/04/frida/" class="leancloud_visitors" data-flag-title="Frida Android hook">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><p>本篇文章学到的内容来自且完全来自r0ysue的知识星球，推荐一下。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-07-061015.png" alt=""></p>
<h2 id="Frida环境"><a href="#Frida环境" class="headerlink" title="Frida环境"></a>Frida环境</h2><p><a href="https://github.com/frida/frida" target="_blank" rel="noopener">https://github.com/frida/frida</a></p>
<h3 id="pyenv"><a href="#pyenv" class="headerlink" title="pyenv"></a>pyenv</h3><p>python全版本随机切换，这里提供<a href="https://github.com/pyenv/pyenv#homebrew-on-macos" target="_blank" rel="noopener">macOS上的配置方法</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br><span class="line">brew install pyenv</span><br><span class="line">echo -e &#39;if command -v pyenv 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1; then\n  eval &quot;$(pyenv init -)&quot;\nfi&#39; &gt;&gt; ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">下载一个3.8.2，下载真的很慢，要慢慢等</span><br><span class="line">pyenv install 3.8.2</span><br><span class="line"></span><br><span class="line">pyenv versions</span><br><span class="line">sakura@sakuradeMacBook-Pro:~$ pyenv versions</span><br><span class="line">  system</span><br><span class="line">* 3.8.2 (set by &#x2F;Users&#x2F;sakura&#x2F;.python-version)</span><br><span class="line">切换到我们装的</span><br><span class="line">pyenv local 3.8.2</span><br><span class="line">python -V</span><br><span class="line">pip -V</span><br><span class="line">原本系统自带的</span><br><span class="line">python local system</span><br><span class="line">python -V</span><br></pre></td></tr></table></figure>
<p>另外当你需要临时禁用pyenv的时候<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-17-134140.png" alt=""><br>把这个注释了然后另开终端就好了。</p>
<p>关于卸载某个python版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Uninstalling Python Versions</span><br><span class="line">As time goes on, you will accumulate Python versions in your $(pyenv root)&#x2F;versions directory.</span><br><span class="line"></span><br><span class="line">To remove old Python versions, pyenv uninstall command to automate the removal process.</span><br><span class="line"></span><br><span class="line">Alternatively, simply rm -rf the directory of the version you want to remove. You can find the directory of a particular Python version with the pyenv prefix command, e.g. pyenv prefix 2.6.8.</span><br></pre></td></tr></table></figure>
<h3 id="frida安装"><a href="#frida安装" class="headerlink" title="frida安装"></a>frida安装</h3><p>如果直接按下述安装则会直接安装frida和frida-tools的最新版本。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install frida-tools</span><br><span class="line">frida --version</span><br><span class="line">frida-ps --version</span><br></pre></td></tr></table></figure>
<p>我们也可以自由安装旧版本的frida，例如12.8.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pyenv install 3.7.7</span><br><span class="line">pyenv local 3.7.7</span><br><span class="line">pip install frida&#x3D;&#x3D;12.8.0</span><br><span class="line">pip install frida-tools&#x3D;&#x3D;5.3.0</span><br></pre></td></tr></table></figure>
<p>老版本frida和对应关系<br>对应关系很好找<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-17-134837.png" alt=""></p>
<h3 id="安装objection"><a href="#安装objection" class="headerlink" title="安装objection"></a>安装objection</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyenv local 3.8.2</span><br><span class="line">pip install objection</span><br><span class="line">objection -h</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyenv local 3.7.7</span><br><span class="line">pip install objection&#x3D;&#x3D;1.8.4</span><br><span class="line">objection -h</span><br></pre></td></tr></table></figure>

<h3 id="frida使用"><a href="#frida使用" class="headerlink" title="frida使用"></a>frida使用</h3><p>下载frida-server并解压，在这里下载<a href="https://github.com/frida/frida/releases/download/12.8.0/frida-server-12.8.0-android-arm64.xz" target="_blank" rel="noopener">frida-server-12.8.0</a></p>
<p>先adb shell，然后切换到root权限,把之前push进来的frida server改个名字叫fs<br>然后运行frida</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb push &#x2F;Users&#x2F;sakura&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida-server-12.8.0-android-arm64 &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">chmod +x fs</span><br><span class="line">.&#x2F;fs</span><br></pre></td></tr></table></figure>
<p>如果要监听端口，就</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;fs -l 0.0.0.0:8888</span><br></pre></td></tr></table></figure>
<h3 id="frida开发环境搭建"><a href="#frida开发环境搭建" class="headerlink" title="frida开发环境搭建"></a>frida开发环境搭建</h3><ol>
<li>安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;oleavr&#x2F;frida-agent-example.git</span><br><span class="line">cd frida-agent-example&#x2F;</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure></li>
<li>使用vscode打开此工程，在agent文件夹下编写js，会有智能提示。</li>
<li><code>npm run watch</code>会监控代码修改自动编译生成js文件</li>
<li>python脚本或者cli加载_agent.js<br><code>frida -U -f com.example.android --no-pause -l _agent.js</code></li>
</ol>
<p>下面是测试脚本</p>
<p><code>s1.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"sakura"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>

<p><code>loader.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device8 = frida.get_device_manager().add_remote_device(<span class="string">"192.168.0.9:8888"</span>)</span><br><span class="line">pid = device8.spawn(<span class="string">"com.android.settings"</span>)</span><br><span class="line">device8.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device8.attach(pid)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"si.js"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.load()</span><br><span class="line">input() <span class="comment">#等待输入</span></span><br></pre></td></tr></table></figure>
<p>解释一下，这个脚本就是先通过<code>frida.get_device_manager().add_remote_device</code>来找到device,然后spawn方式启动settings，然后attach到上面，并执行frida脚本。</p>
<h2 id="FRIDA基础"><a href="#FRIDA基础" class="headerlink" title="FRIDA基础"></a>FRIDA基础</h2><h3 id="frida查看当前存在的进程"><a href="#frida查看当前存在的进程" class="headerlink" title="frida查看当前存在的进程"></a>frida查看当前存在的进程</h3><p><code>frida-ps -U</code>查看通过usb连接的android手机上的进程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ frida-ps --help</span><br><span class="line">Usage: frida-ps [options]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --version             show program&#39;s version number and exit</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -D ID, --device&#x3D;ID    connect to device with the given ID</span><br><span class="line">  -U, --usb             connect to USB device</span><br><span class="line">  -R, --remote          connect to remote frida-server</span><br><span class="line">  -H HOST, --host&#x3D;HOST  connect to remote frida-server on HOST</span><br><span class="line">  -a, --applications    list only applications</span><br><span class="line">  -i, --installed       include all installed applications</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ frida-ps -U</span><br><span class="line">  PID  Name</span><br><span class="line">-----  ---------------------------------------------------</span><br><span class="line"> 3640  ATFWD-daemon</span><br><span class="line">  707  adbd</span><br><span class="line">  728  adsprpcd</span><br><span class="line">26041  android.hardware.audio@2.0-service</span><br><span class="line">  741  android.hardware.biometrics.fingerprint@</span><br></pre></td></tr></table></figure>
<p>通过grep过滤就可以找到我们想要的包名。</p>
<h3 id="frida打印参数和修改返回值"><a href="#frida打印参数和修改返回值" class="headerlink" title="frida打印参数和修改返回值"></a>frida打印参数和修改返回值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myapplication.example.com.frida_demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String total = <span class="string">"@@@###@@@"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">            Log.d(<span class="string">"sakura.string"</span> , fun(<span class="string">"LoWeRcAsE Me!!!!!!!!!"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">"sakura.Sum"</span> , String.valueOf(x+y));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">fun</span><span class="params">(String x)</span></span>&#123;</span><br><span class="line">        total +=x;</span><br><span class="line">        <span class="keyword">return</span> x.toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">secret</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Enter the Script!"</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Inside Java perform"</span>);</span><br><span class="line">        <span class="keyword">var</span> MainActivity = Java.use(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>);</span><br><span class="line">        <span class="comment">// 重载找到指定的函数</span></span><br><span class="line">        MainActivity.fun.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//打印参数</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"original call : str:"</span> + str);</span><br><span class="line">            <span class="comment">//修改结果</span></span><br><span class="line">            <span class="keyword">var</span> ret_value = <span class="string">"sakura"</span>;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ frida-ps -U | grep frida</span><br><span class="line">8738  frida-helper-32</span><br><span class="line">8897  myapplication.example.com.frida_demo</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; -f是通过spawn，也就是重启apk注入js</span><br><span class="line">sakura@sakuradeMacBook-Pro:~$ frida -U -f myapplication.example.com.frida_demo -l frida_demo.js</span><br><span class="line">...</span><br><span class="line">original call : str:LoWeRcAsE Me!!!!!!!!!</span><br><span class="line">12-21 04:46:49.875 9594-9594&#x2F;myapplication.example.com.frida_demo D&#x2F;sakura.string: sakura</span><br></pre></td></tr></table></figure>

<h3 id="frida寻找instance，主动调用。"><a href="#frida寻找instance，主动调用。" class="headerlink" title="frida寻找instance，主动调用。"></a>frida寻找instance，主动调用。</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Enter the Script!"</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Inside Java perform"</span>);</span><br><span class="line">        <span class="keyword">var</span> MainActivity = Java.use(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>);</span><br><span class="line">        <span class="comment">//overload 选择被重载的对象</span></span><br><span class="line">        MainActivity.fun.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//打印参数</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"original call : str:"</span> + str);</span><br><span class="line">            <span class="comment">//修改结果</span></span><br><span class="line">            <span class="keyword">var</span> ret_value = <span class="string">"sakura"</span>;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 寻找类型为classname的实例</span></span><br><span class="line">        Java.choose(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"find instance :"</span> + x);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"result of secret func:"</span> + x.secret());</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>

<h3 id="frida-rpc"><a href="#frida-rpc" class="headerlink" title="frida rpc"></a>frida rpc</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callFun</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"begin"</span>);</span><br><span class="line">        Java.choose(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"find instance :"</span> + x);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"result of fun(string) func:"</span> + x.fun(Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(<span class="string">"sakura"</span>)));</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    callfun: callFun</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">"myapplication.example.com.frida_demo"</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"frida_demo_rpc_call.js"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span><span class="params">(message, payload)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line">    print(payload)</span><br><span class="line"></span><br><span class="line">script.on(<span class="string">"message"</span>, my_message_handler)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">script.exports.callfun()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;gitsource&#x2F;frida-agent-example&#x2F;agent$ python frida_demo_rpc_loader.py </span><br><span class="line">begin</span><br><span class="line">find instance :myapplication.example.com.frida_demo.MainActivity@1d4b09d</span><br><span class="line">result of fun(string):sakura</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="frida动态修改"><a href="#frida动态修改" class="headerlink" title="frida动态修改"></a>frida动态修改</h3><p>即将手机上的app的内容发送到PC上的frida python程序，然后处理后返回给app，然后app再做后续的流程，核心是理解<code>send/recv</code>函数</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"please input username and password"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/editText"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"40dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">"username"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:maxLength</span>=<span class="string">"20"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">"1.0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">"0.095"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/editText2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"40dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">"password"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:maxLength</span>=<span class="string">"20"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">"0.239"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"35dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"right|center_horizontal"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"提交"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:visibility</span>=<span class="string">"visible"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">"0.745"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    EditText username_et;</span><br><span class="line">    EditText password_et;</span><br><span class="line">    TextView message_tv;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        password_et = (EditText) <span class="keyword">this</span>.findViewById(R.id.editText2);</span><br><span class="line">        username_et = (EditText) <span class="keyword">this</span>.findViewById(R.id.editText);</span><br><span class="line">        message_tv = ((TextView) findViewById(R.id.textView));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.findViewById(R.id.button).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (username_et.getText().toString().compareTo(<span class="string">"admin"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    message_tv.setText(<span class="string">"You cannot login as admin"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//hook target</span></span><br><span class="line">                message_tv.setText(<span class="string">"Sending to the server :"</span> + Base64.encodeToString((username_et.getText().toString() + <span class="string">":"</span> + password_et.getText().toString()).getBytes(), Base64.DEFAULT));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先分析问题，我的最终目标是让message_tv.setText可以”发送”username为admin的base64字符串。<br>那肯定是hook TextView.setText这个函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Script loaded successfully "</span>);</span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tv_class = Java.use(<span class="string">"android.widget.TextView"</span>);</span><br><span class="line">    tv_class.setText.overload(<span class="string">"java.lang.CharSequence"</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> string_to_send = x.toString();</span><br><span class="line">        <span class="keyword">var</span> string_to_recv;</span><br><span class="line">        send(string_to_send); <span class="comment">// send data to python code</span></span><br><span class="line">        recv(<span class="function"><span class="keyword">function</span> (<span class="params">received_json_object</span>) </span>&#123;</span><br><span class="line">            string_to_recv = received_json_object.my_data</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"string_to_recv: "</span> + string_to_recv);</span><br><span class="line">        &#125;).wait(); <span class="comment">//block execution till the message is received</span></span><br><span class="line">        <span class="keyword">var</span> my_string = Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(string_to_recv);</span><br><span class="line">        <span class="keyword">this</span>.setText(my_string);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span><span class="params">(message, payload)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line">    print(payload)</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">"type"</span>] == <span class="string">"send"</span>:</span><br><span class="line">        print(message[<span class="string">"payload"</span>])</span><br><span class="line">        data = message[<span class="string">"payload"</span>].split(<span class="string">":"</span>)[<span class="number">1</span>].strip()</span><br><span class="line">        print( <span class="string">'message:'</span>, message)</span><br><span class="line">        <span class="comment">#data = data.decode("base64")</span></span><br><span class="line">        <span class="comment">#data = data</span></span><br><span class="line">        data = str(base64.b64decode(data))</span><br><span class="line">        print( <span class="string">'data:'</span>,data)</span><br><span class="line">        user, pw = data.split(<span class="string">":"</span>)</span><br><span class="line">        print( <span class="string">'pw:'</span>,pw)</span><br><span class="line">        <span class="comment">#data = ("admin" + ":" + pw).encode("base64")</span></span><br><span class="line">        data = str(base64.b64encode((<span class="string">"admin"</span> + <span class="string">":"</span> + pw).encode()))</span><br><span class="line">        print( <span class="string">"encoded data:"</span>, data)</span><br><span class="line">        script.post(&#123;<span class="string">"my_data"</span>: data&#125;)  <span class="comment"># send JSON object</span></span><br><span class="line">        print( <span class="string">"Modified data sent"</span>)</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">"myapplication.example.com.frida_demo"</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"frida_demo2.js"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.on(<span class="string">"message"</span>, my_message_handler)</span><br><span class="line">script.load()</span><br><span class="line">input()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;gitsource&#x2F;frida-agent-example&#x2F;agent$ python frida_demo_rpc_loader2.py </span><br><span class="line">Script loaded successfully </span><br><span class="line">&#123;&#39;type&#39;: &#39;send&#39;, &#39;payload&#39;: &#39;Sending to the server :c2FrdXJhOjEyMzQ1Ng&#x3D;&#x3D;\n&#39;&#125;</span><br><span class="line">None</span><br><span class="line">Sending to the server :c2FrdXJhOjEyMzQ1Ng&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">message: &#123;&#39;type&#39;: &#39;send&#39;, &#39;payload&#39;: &#39;Sending to the server :c2FrdXJhOjEyMzQ1Ng&#x3D;&#x3D;\n&#39;&#125;</span><br><span class="line">data: b&#39;sakura:123456&#39;</span><br><span class="line">pw: 123456&#39;</span><br><span class="line">encoded data: b&#39;YWRtaW46MTIzNDU2Jw&#x3D;&#x3D;&#39;</span><br><span class="line">Modified data sent</span><br><span class="line">string_to_recv: b&#39;YWRtaW46MTIzNDU2Jw&#x3D;&#x3D;&#39;</span><br></pre></td></tr></table></figure>
<p>参考链接：<a href="https://github.com/Mind0xP/Frida-Python-Binding" target="_blank" rel="noopener">https://github.com/Mind0xP/Frida-Python-Binding</a></p>
<h3 id="API-List"><a href="#API-List" class="headerlink" title="API List"></a>API List</h3><ul>
<li><p><code>Java.choose(className: string, callbacks: Java.ChooseCallbacks): void</code><br>通过扫描Java VM的堆来枚举className类的live instance。</p>
</li>
<li><p><code>Java.use(className: string): Java.Wrapper&lt;{}&gt;</code><br>动态为className生成JavaScript Wrapper，可以通过调用<code>$new()</code>来调用构造函数来实例化对象。<br>在实例上调用<code>$dispose()</code>以对其进行显式清理，或者等待JavaScript对象被gc。 </p>
</li>
<li><p><code>Java.perform(fn: () =&gt; void): void</code><br>Function to run while attached to the VM.<br>Ensures that the current thread is attached to the VM and calls fn. (This isn’t necessary in callbacks from Java.)<br>Will defer calling fn if the app’s class loader is not available yet. Use Java.performNow() if access to the app’s classes is not needed.</p>
</li>
<li><p><code>send(message: any, data?: ArrayBuffer | number[]): void</code><br>任何JSON可序列化的值。<br>将JSON序列化后的message发送到您的基于Frida的应用程序，并包含(可选)一些原始二进制数据。<br>The latter is useful if you e.g. dumped some memory using NativePointer#readByteArray().</p>
</li>
<li><p><code>recv(callback: MessageCallback): MessageRecvOperation</code><br>Requests callback to be called on the next message received from your Frida-based application.<br>This will only give you one message, so you need to call recv() again to receive the next one.</p>
</li>
<li><p><code>wait(): void</code><br>堵塞，直到message已经receive并且callback已经执行完毕并返回</p>
</li>
</ul>
<h2 id="Frida动静态结合分析"><a href="#Frida动静态结合分析" class="headerlink" title="Frida动静态结合分析"></a>Frida动静态结合分析</h2><h3 id="Objection"><a href="#Objection" class="headerlink" title="Objection"></a>Objection</h3><ul>
<li>参考这篇文章<br><a href="https://www.anquanke.com/post/id/197657" target="_blank" rel="noopener">实用FRIDA进阶：内存漫游、hook anywhere、抓包</a></li>
<li>objection<br><a href="https://pypi.org/project/objection/" target="_blank" rel="noopener">https://pypi.org/project/objection/</a></li>
</ul>
<h4 id="objection启动并注入内存"><a href="#objection启动并注入内存" class="headerlink" title="objection启动并注入内存"></a>objection启动并注入内存</h4><p><code>objection -d -g package_name explore</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -d -g com.android.settings explore</span><br><span class="line">[debug] Agent path is: &#x2F;Users&#x2F;sakura&#x2F;.pyenv&#x2F;versions&#x2F;3.7.7&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;objection&#x2F;agent.js</span><br><span class="line">[debug] Injecting agent...</span><br><span class="line">Using USB device &#96;Google Pixel&#96;</span><br><span class="line">[debug] Attempting to attach to process: &#96;com.android.settings&#96;</span><br><span class="line">[debug] Process attached!</span><br><span class="line">Agent injected and responds ok!</span><br><span class="line"></span><br><span class="line">     _   _         _   _</span><br><span class="line"> ___| |_|_|___ ___| |_|_|___ ___</span><br><span class="line">| . | . | | -_|  _|  _| | . |   |</span><br><span class="line">|___|___| |___|___|_| |_|___|_|_|</span><br><span class="line">      |___|(object)inject(ion) v1.8.4</span><br><span class="line"></span><br><span class="line">     Runtime Mobile Exploration</span><br><span class="line">        by: @leonjza from @sensepost</span><br><span class="line"></span><br><span class="line">[tab] for command suggestions</span><br><span class="line">com.android.settings on (google: 8.1.0) [usb] #</span><br></pre></td></tr></table></figure>
<h4 id="objection-memory"><a href="#objection-memory" class="headerlink" title="objection memory"></a>objection memory</h4><h5 id="查看内存中加载的module-memory-list-modules"><a href="#查看内存中加载的module-memory-list-modules" class="headerlink" title="查看内存中加载的module memory list modules"></a>查看内存中加载的module <code>memory list modules</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # memory list modules</span><br><span class="line">Save the output by adding &#96;--json modules.json&#96; to this command</span><br><span class="line">Name                                             Base          Size                  Path</span><br><span class="line">-----------------------------------------------  ------------  --------------------  ---------------------------------------------------------------</span><br><span class="line">app_process64                                    0x64ce143000  32768 (32.0 KiB)      &#x2F;system&#x2F;bin&#x2F;app_process64</span><br><span class="line">libandroid_runtime.so                            0x7a90bc3000  1990656 (1.9 MiB)     &#x2F;system&#x2F;lib64&#x2F;libandroid_runtime.so</span><br><span class="line">libbinder.so                                     0x7a9379f000  557056 (544.0 KiB)    &#x2F;system&#x2F;lib64&#x2F;libbinder.so</span><br></pre></td></tr></table></figure>
<h5 id="查看库的导出函数-memory-list-exports-libssl-so"><a href="#查看库的导出函数-memory-list-exports-libssl-so" class="headerlink" title="查看库的导出函数 memory list exports libssl.so"></a>查看库的导出函数 <code>memory list exports libssl.so</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # memory list exports libssl.so</span><br><span class="line">Save the output by adding &#96;--json exports.json&#96; to this command</span><br><span class="line">Type      Name                                                   Address</span><br><span class="line">--------  -----------------------------------------------------  ------------</span><br><span class="line">function  SSL_use_certificate_ASN1                               0x7c8ff006f8</span><br><span class="line">function  SSL_CTX_set_dos_protection_cb                          0x7c8ff077b8</span><br><span class="line">function  SSL_SESSION_set_ex_data                                0x7c8ff098f4</span><br><span class="line">function  SSL_CTX_set_session_psk_dhe_timeout                    0x7c8ff0a754</span><br><span class="line">function  SSL_CTX_sess_accept                                    0x7c8ff063b8</span><br><span class="line">function  SSL_select_next_proto                                  0x7c8ff06a74</span><br></pre></td></tr></table></figure>
<h5 id="dump内存空间"><a href="#dump内存空间" class="headerlink" title="dump内存空间"></a>dump内存空间</h5><ul>
<li><code>memory dump all 文件名</code></li>
<li><code>memory dump from_base 起始地址 字节数 文件名</code><h5 id="搜索内存空间"><a href="#搜索内存空间" class="headerlink" title="搜索内存空间"></a>搜索内存空间</h5><code>Usage: memory search &quot;&lt;pattern eg: 41 41 41 ?? 41&gt;&quot; (--string) (--offsets-only)</code></li>
</ul>
<h4 id="objection-android"><a href="#objection-android" class="headerlink" title="objection android"></a>objection android</h4><h5 id="内存堆搜索实例-android-heap-search-instances-类名"><a href="#内存堆搜索实例-android-heap-search-instances-类名" class="headerlink" title="内存堆搜索实例 android heap search instances 类名"></a>内存堆搜索实例 <code>android heap search instances 类名</code></h5><p>在堆上搜索类的实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -g myapplication.example.com.frida_demo explore</span><br><span class="line">Using USB device &#96;Google Pixel&#96;</span><br><span class="line">Agent injected and responds ok!</span><br><span class="line"></span><br><span class="line">[usb] # android heap search instances myapplication.example.com.frida_demo</span><br><span class="line">.MainActivity</span><br><span class="line">Class instance enumeration complete for myapplication.example.com.frida_demo.MainActivity</span><br><span class="line">Handle    Class                                              toString()</span><br><span class="line">--------  -------------------------------------------------  ---------------------------------------------------------</span><br><span class="line">0x2102    myapplication.example.com.frida_demo.MainActivity  myapplication.example.com.frida_demo.MainActivity@5b1b0af</span><br></pre></td></tr></table></figure>
<h5 id="调用实例的方法-android-heap-execute-实例ID-实例方法"><a href="#调用实例的方法-android-heap-execute-实例ID-实例方法" class="headerlink" title="调用实例的方法 android heap execute 实例ID 实例方法"></a>调用实例的方法 <code>android heap execute 实例ID 实例方法</code></h5><h5 id="查看当前可用的activity或者service-android-hooking-list-activities-services"><a href="#查看当前可用的activity或者service-android-hooking-list-activities-services" class="headerlink" title="查看当前可用的activity或者service android hooking list activities/services"></a>查看当前可用的activity或者service <code>android hooking list activities/services</code></h5><h5 id="直接启动activity或者服务-android-intent-launch-activity-launch-service-activity-服务"><a href="#直接启动activity或者服务-android-intent-launch-activity-launch-service-activity-服务" class="headerlink" title="直接启动activity或者服务 android intent launch_activity/launch_service activity/服务"></a>直接启动activity或者服务 <code>android intent launch_activity/launch_service activity/服务</code></h5><p><code>android intent launch_activity com.android.settings.DisplaySettings</code><br>这个命令比较有趣的是用在如果有些设计的不好，可能就直接绕过了密码锁屏等直接进去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking list services</span><br><span class="line">com.android.settings.SettingsDumpService</span><br><span class="line">com.android.settings.TetherService</span><br><span class="line">com.android.settings.bluetooth.BluetoothPairingService</span><br></pre></td></tr></table></figure>
<h5 id="列出内存中所有的类-android-hooking-list-classes"><a href="#列出内存中所有的类-android-hooking-list-classes" class="headerlink" title="列出内存中所有的类 android hooking list classes"></a>列出内存中所有的类 <code>android hooking list classes</code></h5><h5 id="在内存中所有已加载的类中搜索包含特定关键词的类。-android-hooking-search-classes-display"><a href="#在内存中所有已加载的类中搜索包含特定关键词的类。-android-hooking-search-classes-display" class="headerlink" title="在内存中所有已加载的类中搜索包含特定关键词的类。 android hooking search classes display"></a>在内存中所有已加载的类中搜索包含特定关键词的类。 <code>android hooking search classes display</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking search classes display</span><br><span class="line">[Landroid.icu.text.DisplayContext$Type;</span><br><span class="line">[Landroid.icu.text.DisplayContext;</span><br><span class="line">[Landroid.view.Display$Mode;</span><br><span class="line">android.hardware.display.DisplayManager</span><br><span class="line">android.hardware.display.DisplayManager$DisplayListener</span><br><span class="line">android.hardware.display.DisplayManagerGlobal</span><br></pre></td></tr></table></figure>
<h5 id="内存中搜索指定类的所有方法-android-hooking-list-class-methods-类名"><a href="#内存中搜索指定类的所有方法-android-hooking-list-class-methods-类名" class="headerlink" title="内存中搜索指定类的所有方法 android hooking list class_methods 类名"></a>内存中搜索指定类的所有方法 <code>android hooking list class_methods 类名</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking list class_methods java.nio.charset.Charset</span><br><span class="line">private static java.nio.charset.Charset java.nio.charset.Charset.lookup(java.lang.String)</span><br><span class="line">private static java.nio.charset.Charset java.nio.charset.Charset.lookup2(java.lang.String)</span><br><span class="line">private static java.nio.charset.Charset java.nio.charset.Charset.lookupViaProviders(java.lang.String)</span><br></pre></td></tr></table></figure>
<h5 id="在内存中所有已加载的类的方法中搜索包含特定关键词的方法-android-hooking-search-methods-display"><a href="#在内存中所有已加载的类的方法中搜索包含特定关键词的方法-android-hooking-search-methods-display" class="headerlink" title="在内存中所有已加载的类的方法中搜索包含特定关键词的方法 android hooking search methods display"></a>在内存中所有已加载的类的方法中搜索包含特定关键词的方法 <code>android hooking search methods display</code></h5><p>知道名字开始在内存里搜就很有用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking search methods display</span><br><span class="line">Warning, searching all classes may take some time and in some cases, crash the target application.</span><br><span class="line">Continue? [y&#x2F;N]: y</span><br><span class="line">Found 5529 classes, searching methods (this may take some time)...</span><br><span class="line">android.app.ActionBar.getDisplayOptions</span><br><span class="line">android.app.ActionBar.setDefaultDisplayHomeAsUpEnabled</span><br><span class="line">android.app.ActionBar.setDisplayHomeAsUpEnabled</span><br></pre></td></tr></table></figure>
<h5 id="hook类的方法（hook类里的所有方法-具体某个方法）"><a href="#hook类的方法（hook类里的所有方法-具体某个方法）" class="headerlink" title="hook类的方法（hook类里的所有方法/具体某个方法）"></a>hook类的方法（hook类里的所有方法/具体某个方法）</h5><ul>
<li><code>android hooking watch class 类名</code><br>这样就可以hook这个类里面的所有方法，每次调用都会被log出来。</li>
<li><code>android hooking watch class 类名 --dump-args --dump-backtrace --dump-return</code><br>在上面的基础上，额外dump参数，栈回溯，返回值 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class xxx.MainActivity --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure></li>
<li><code>android hooking watch class_method 方法名</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;可以直接hook到所有重载</span><br><span class="line">android hooking watch class_method xxx.MainActivity.fun --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure>
<h4 id="grep-trick和文件保存"><a href="#grep-trick和文件保存" class="headerlink" title="grep trick和文件保存"></a>grep trick和文件保存</h4>objection log默认是不能用grep过滤的，但是可以通过<code>objection run xxx | grep yyy的</code>方式，从终端通过管道来过滤。<br>用法如下<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -g com.android.settings run memory list modules | grep libc</span><br><span class="line">Warning: Output is not to a terminal (fd&#x3D;1).</span><br><span class="line">libcutils.so                                     0x7a94a1c000  81920 (80.0 KiB)      &#x2F;system&#x2F;lib64&#x2F;libcutils.so</span><br><span class="line">libc++.so                                        0x7a9114e000  983040 (960.0 KiB)    &#x2F;system&#x2F;lib64&#x2F;libc++.so</span><br><span class="line">libc.so                                          0x7a9249d000  892928 (872.0 KiB)    &#x2F;system&#x2F;lib64&#x2F;libc.so</span><br><span class="line">libcrypto.so                                     0x7a92283000  1155072 (1.1 MiB)     &#x2F;system&#x2F;lib64&#x2F;libcrypto.so</span><br></pre></td></tr></table></figure>
有的命令后面可以通过<code>--json logfile</code>来直接保存结果到文件里。<br>有的可以通过查看<code>.objection</code>文件里的输出log来查看结果。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;.objection$ cat *log | grep -i display</span><br><span class="line">android.hardware.display.DisplayManager</span><br><span class="line">android.hardware.display.DisplayManager$DisplayListener</span><br><span class="line">android.hardware.display.DisplayManagerGlobal</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="案例学习"><a href="#案例学习" class="headerlink" title="案例学习"></a>案例学习</h3><h4 id="案例学习case1-《仿VX数据库原型取证逆向分析》"><a href="#案例学习case1-《仿VX数据库原型取证逆向分析》" class="headerlink" title="案例学习case1:《仿VX数据库原型取证逆向分析》"></a>案例学习case1:《仿VX数据库原型取证逆向分析》</h4><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&tid=1082706" target="_blank" rel="noopener">附件链接</a><br><a href="https://github.com/nelenkov/android-backup-extractor" target="_blank" rel="noopener">android-backup-extractor工具链接</a></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-100849.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn$ java -version</span><br><span class="line">java version &quot;1.8.0_141&quot;</span><br><span class="line"></span><br><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn$ java -jar abe-all.jar unpack 1.ab 1.tar</span><br><span class="line">0% 1% 2% 3% 4% 5% 6% 7% 8% 9% 10% 11% 12% 13% 14% 15% 16% 17% 18% 19% 20% 21% 22% 23% 24% 25% 26% 27% 28% 29% 30% 31% 32% 33% 34% 35% 36% 37% 38% 39% 40% 41% 42% 43% 44% 45% 46% 47% 48% 49% 50% 51% 52% 53% 54% 55% 56% 57% 58% 59% 60% 61% 62% 63% 64% 65% 66% 67% 68% 69% 70% 71% 72% 73% 74% 75% 76% 77% 78% 79% 80% 81% 82% 83% 84% 85% 86% 87% 88% 89% 90% 91% 92% 93% 94% 95% 96% 97% 98% 99% 100%</span><br><span class="line">9097216 bytes written to 1.tar.</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn&#x2F;apps&#x2F;com.example.yaphetshan.tencentwelcome$ ls</span><br><span class="line">Encryto.db _manifest  a          db</span><br></pre></td></tr></table></figure>
<p>装个夜神模拟器玩</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:&#x2F;Applications&#x2F;NoxAppPlayer.app&#x2F;Contents&#x2F;MacOS$ .&#x2F;adb connect 127.0.0.1:62001</span><br><span class="line">* daemon not running. starting it now on port 5037 *</span><br><span class="line">adb E  5139 141210 usb_osx.cpp:138] Unable to create an interface plug-in (e00002be)</span><br><span class="line">* daemon started successfully *</span><br><span class="line">connected to 127.0.0.1:62001</span><br><span class="line">sakura@sakuradeMacBook-Pro:&#x2F;Applications&#x2F;NoxAppPlayer.app&#x2F;Contents&#x2F;MacOS$ .&#x2F;adb shell</span><br><span class="line">dream2qltechn:&#x2F; # whoami</span><br><span class="line">root</span><br><span class="line">dream2qltechn:&#x2F; # uname -a</span><br><span class="line">Linux localhost 4.0.9+ #222 SMP PREEMPT Sat Mar 14 18:24:36 HKT 2020 i686</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-120749.png" alt=""></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121130.png" alt=""></p>
<p>肯定还是先定位目标字符串<code>Wait a Minute,What was happend?</code><br>jadx搜索字符串<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121255.png" alt=""></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121403.png" alt=""></p>
<p>重点在a()代码里，其实是根据明文的name和password，然后<code>aVar.a(a2 + aVar.b(a2, contentValues.getAsString(&quot;password&quot;))).substring(0, 7)</code>再做一遍复杂的计算并截取7位当做密码，传入getWritableDatabase去解密demo.db数据库。</p>
<p>所以我们hook一下getWritableDatabase即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -U</span><br><span class="line">...</span><br><span class="line">5662  com.example.yaphetshan.tencentwelcome</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">objection -d -g com.example.yaphetshan.tencentwelcome explore</span><br></pre></td></tr></table></figure>
<p>看一下源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package net.sqlcipher.database;</span><br><span class="line">...</span><br><span class="line">public abstract class SQLiteOpenHelper &#123;</span><br><span class="line">    ...</span><br><span class="line">    public synchronized SQLiteDatabase getWritableDatabase(char[] cArr) &#123;</span><br></pre></td></tr></table></figure>
<p>也可以objection search一下这个method</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...mple.yaphetshan.tencentwelcome on (samsung: 7.1.2) [usb] # android hooking search methods getWritableDatabase</span><br><span class="line">Warning, searching all classes may take some time and in some cases, crash the target application.</span><br><span class="line">Continue? [y&#x2F;N]: y</span><br><span class="line">Found 4650 classes, searching methods (this may take some time)...</span><br><span class="line"></span><br><span class="line">android.database.sqlite.SQLiteOpenHelper.getWritableDatabase</span><br><span class="line">...</span><br><span class="line">net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase</span><br></pre></td></tr></table></figure>
<p>hook一下这个method</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[usb] # android hooking watch class_method net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase --dump-args --dump-backtrace --dump-return</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Attempting to watch class \u001b[32mnet.sqlcipher.database.SQLiteOpenHelper\u001b[39m and method \u001b[32mgetWritableDatabase\u001b[39m.&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Attempting to watch class net.sqlcipher.database.SQLiteOpenHelper and method getWritableDatabase.</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Hooking \u001b[32mnet.sqlcipher.database.SQLiteOpenHelper\u001b[39m.\u001b[92mgetWritableDatabase\u001b[39m(\u001b[31mjava.lang.String\u001b[39m)&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Hooking net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(java.lang.String)</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Hooking \u001b[32mnet.sqlcipher.database.SQLiteOpenHelper\u001b[39m.\u001b[92mgetWritableDatabase\u001b[39m(\u001b[31m[C\u001b[39m)&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Hooking net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase([C)</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Registering job \u001b[94mjytq1qeyllq\u001b[39m. Type: \u001b[92mwatch-method for: net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase\u001b[39m&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Registering job jytq1qeyllq. Type: watch-method for: net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase</span><br><span class="line">...mple.yaphetshan.tencentwelcome on (samsung: 7.1.2) [usb] #</span><br></pre></td></tr></table></figure>

<p>hook好之后再打开这个apk<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125545.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125604.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(agent) [1v488x28gcs] Called net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(java.lang.String)</span><br><span class="line">...</span><br><span class="line">(agent) [1v488x28gcs] Backtrace:</span><br><span class="line">	net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(Native Method)</span><br><span class="line">	com.example.yaphetshan.tencentwelcome.MainActivity.a(MainActivity.java:55)</span><br><span class="line">	com.example.yaphetshan.tencentwelcome.MainActivity.onCreate(MainActivity.java:42)</span><br><span class="line">	android.app.Activity.performCreate(Activity.java:6692)</span><br><span class="line">...</span><br><span class="line">(agent) [1v488x28gcs] Arguments net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(ae56f99)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...mple.yaphetshan.tencentwelcome on (samsung: 7.1.2) [usb] # jobs list</span><br><span class="line">Job ID         Hooks  Type</span><br><span class="line">-----------  -------  -----------------------------------------------------------------------------</span><br><span class="line">1v488x28gcs        2  watch-method for: net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase</span><br></pre></td></tr></table></figure>
<p>找到参数<code>ae56f99</code><br>剩下的就是用这个密码去打开加密的db。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125824.png" alt=""><br>然后base64解密一下就好了。</p>
<p>还有一种策略是主动调用,基于数据流的主动调用分析是非常有意思的。<br>即自己去调用a函数以触发getWritableDatabase的数据库解密。<br>先寻找a所在类的实例，然后hook getWritableDatabase，最终主动调用a。<br>这里幸运的是a没有什么奇奇怪怪的参数需要我们传入，主动调用这种策略在循环注册等地方可能就会有需求8.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> [usb] # android heap search instances com.example.yaphetshan.tencentwelcome.MainActivity</span><br><span class="line">Class instance enumeration complete for com.example.yaphetshan.tencentwelcome.MainActivity</span><br><span class="line">Handle    Class                                               toString()</span><br><span class="line">--------  --------------------------------------------------  ----------------------------------------------------------</span><br><span class="line">0x20078a  com.example.yaphetshan.tencentwelcome.MainActivity  com.example.yaphetshan.tencentwelcome.MainActivity@1528f80</span><br><span class="line"></span><br><span class="line"> [usb] # android hooking watch class_method net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase --dump-args --dump-backtrace --dump-return</span><br><span class="line"></span><br><span class="line">[usb] # android heap execute 0x20078a a</span><br><span class="line"></span><br><span class="line">(agent) [taupgwkum4h] Arguments net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(ae56f99)</span><br></pre></td></tr></table></figure>
<h4 id="案例学习case2-主动调用爆破密码"><a href="#案例学习case2-主动调用爆破密码" class="headerlink" title="案例学习case2:主动调用爆破密码"></a>案例学习case2:主动调用爆破密码</h4><p><a href="https://bbs.pediy.com/thread-257745.htm" target="_blank" rel="noopener">附件链接</a></p>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-132438.png" alt=""></p>
<p>因为直接找<code>Unfortunately,note the right PIN :(</code>找不到，可能是把字符串藏在什么资源文件里了。<br>review代码之后找到校验的核心函数，逻辑就是将input编码一下之后和密码比较，这肯定是什么不可逆的加密。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verifyPassword</span><span class="params">(Context context, String input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.length() != <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] v = encodePassword(input);</span><br><span class="line">    <span class="keyword">byte</span>[] p = <span class="string">"09042ec2c2c08c4cbece042681caf1d13984f24a"</span>.getBytes();</span><br><span class="line">    <span class="keyword">if</span> (v.length != p.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; v.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v[i] != p[i]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就爆破一下密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -U | grep qualification</span><br><span class="line">7660  org.teamsik.ahe17.qualification.easy</span><br><span class="line"></span><br><span class="line">frida -U org.teamsik.ahe17.qualification.easy -l force.js</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"In Java perform"</span>)</span><br><span class="line">        <span class="keyword">var</span> verify = Java.use(<span class="string">"org.teamsik.ahe17.qualification.Verifier"</span>)</span><br><span class="line">        <span class="keyword">var</span> stringClass = Java.use(<span class="string">"java.lang.String"</span>)</span><br><span class="line">        <span class="keyword">var</span> p = stringClass.$<span class="keyword">new</span>(<span class="string">"09042ec2c2c08c4cbece042681caf1d13984f24a"</span>)</span><br><span class="line">        <span class="keyword">var</span> pSign = p.getBytes()</span><br><span class="line">        <span class="comment">// var pStr = stringClass.$new(pSign)</span></span><br><span class="line">        <span class="comment">// console.log(parseInt(pStr))</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">999</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">var</span> v = stringClass.$<span class="keyword">new</span>(<span class="built_in">String</span>(i))</span><br><span class="line">            <span class="keyword">var</span> vSign = verify.encodePassword(v)</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(stringClass.$<span class="keyword">new</span>(pSign)) == <span class="built_in">parseInt</span>(stringClass.$<span class="keyword">new</span>(vSign))) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"yes: "</span> + v)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"not :"</span> + v)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">not :9080</span><br><span class="line">not :9081</span><br><span class="line">not :9082</span><br><span class="line">yes: 9083</span><br></pre></td></tr></table></figure>
<p>这里注意parseInt</p>
<h2 id="Frida-hook基础-一"><a href="#Frida-hook基础-一" class="headerlink" title="Frida hook基础(一)"></a>Frida hook基础(一)</h2><ul>
<li>调用静态函数和调用非静态函数</li>
<li>设置(同名)成员变量</li>
<li>内部类，枚举类的函数并hook，trace原型1</li>
<li>查找接口，hook动态加载dex</li>
<li>枚举class，trace原型2</li>
<li>objection不能切换classloader</li>
</ul>
<h3 id="Frida-hook-打印参数、返回值-设置返回值-主动调用"><a href="#Frida-hook-打印参数、返回值-设置返回值-主动调用" class="headerlink" title="Frida hook : 打印参数、返回值/设置返回值/主动调用"></a>Frida hook : 打印参数、返回值/设置返回值/主动调用</h3><p>demo就不贴了，还是先定位登录失败点，然后搜索字符串。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* access modifiers changed from: private */</span></span><br><span class="line">    <span class="keyword">public</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        <span class="keyword">this</span>.mContext = <span class="keyword">this</span>;</span><br><span class="line">        setContentView((<span class="keyword">int</span>) R.layout.activity_login);</span><br><span class="line">        <span class="keyword">final</span> EditText editText = (EditText) findViewById(R.id.username);</span><br><span class="line">        <span class="keyword">final</span> EditText editText2 = (EditText) findViewById(R.id.password);</span><br><span class="line">        ((Button) findViewById(R.id.login)).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                String obj = editText.getText().toString();</span><br><span class="line">                String obj2 = editText2.getText().toString();</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(obj) || TextUtils.isEmpty(obj2)) &#123;</span><br><span class="line">                    Toast.makeText(LoginActivity.<span class="keyword">this</span>.mContext, <span class="string">"username or password is empty."</span>, <span class="number">1</span>).show();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LoginActivity.a(obj, obj).equals(obj2)) &#123;</span><br><span class="line">                    LoginActivity.<span class="keyword">this</span>.startActivity(<span class="keyword">new</span> Intent(LoginActivity.<span class="keyword">this</span>.mContext, FridaActivity1<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">                    LoginActivity.<span class="keyword">this</span>.finishActivity(<span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Toast.makeText(LoginActivity.<span class="keyword">this</span>.mContext, <span class="string">"Login failed."</span>, <span class="number">1</span>).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>LoginActivity.a(obj, obj).equals(obj2)</code>分析之后可得obj2来自password，由从username得来的obj，经过a函数运算之后得到一个值，这两个值相等则登录成功。<br>所以这里关键是hook a函数的参数，最简脚本如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印参数、返回值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.LoginActivity"</span>).a.overload(<span class="string">'java.lang.String'</span>, <span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str, str2</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.a(str, str2);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"args0:"</span>+str+<span class="string">" args1:"</span>+str2+<span class="string">" result:"</span>+result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(Login)</span><br></pre></td></tr></table></figure>
<p>观察输入和输出,这里也可以直接主动调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        <span class="keyword">var</span> login = Java.use(<span class="string">"com.example.androiddemo.Activity.LoginActivity"</span>)</span><br><span class="line">        <span class="keyword">var</span> result = login.a(<span class="string">"1234"</span>,<span class="string">"1234"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(login)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">start</span><br><span class="line">4e4feaea959d426155a480dc07ef92f4754ee93edbe56d993d74f131497e66fb</span><br><span class="line">然后</span><br><span class="line">adb shell input text &quot;4e4feaea959d426155a480dc07ef92f4754ee93edbe56d993d74f131497e66fb&quot;</span><br></pre></td></tr></table></figure>

<p>接下来是第一关</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFridaActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Button mNextCheck;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* access modifiers changed from: protected */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView((<span class="keyword">int</span>) R.layout.activity_frida);</span><br><span class="line">        <span class="keyword">this</span>.mNextCheck = (Button) findViewById(R.id.next_check);</span><br><span class="line">        <span class="keyword">this</span>.mNextCheck.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        Button button = <span class="keyword">this</span>.mNextCheck;</span><br><span class="line">        button.setText(getNextCheckTitle() + <span class="string">"，点击进入下一关"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        onCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"Check Failed!"</span>, <span class="number">1</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity1</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span>[] table = &#123;<span class="string">'L'</span>, <span class="string">'K'</span>, <span class="string">'N'</span>, <span class="string">'M'</span>, <span class="string">'O'</span>, <span class="string">'Q'</span>, <span class="string">'P'</span>, <span class="string">'R'</span>, <span class="string">'S'</span>, <span class="string">'A'</span>, <span class="string">'T'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'E'</span>, <span class="string">'D'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>, <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'Z'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'o'</span>, <span class="string">'d'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'j'</span>, <span class="string">'i'</span>, <span class="string">'k'</span>, <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'6'</span>, <span class="string">'5'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'+'</span>, <span class="string">'/'</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"当前第1关"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (a(b(<span class="string">"请输入密码:"</span>)).equals(<span class="string">"R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL="</span>)) &#123;</span><br><span class="line">                CheckSuccess();</span><br><span class="line">                startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity2<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">                finishActivity(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">a</span><span class="params">(<span class="keyword">byte</span>[] bArr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= bArr.length - <span class="number">1</span>; i += <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bArr2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">byte</span> b = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i2 = <span class="number">0</span>; i2 &lt;= <span class="number">2</span>; i2++) &#123;</span><br><span class="line">                <span class="keyword">int</span> i3 = i + i2;</span><br><span class="line">                <span class="keyword">if</span> (i3 &lt;= bArr.length - <span class="number">1</span>) &#123;</span><br><span class="line">                    bArr2[i2] = (<span class="keyword">byte</span>) (b | ((bArr[i3] &amp; <span class="number">255</span>) &gt;&gt;&gt; ((i2 * <span class="number">2</span>) + <span class="number">2</span>)));</span><br><span class="line">                    b = (<span class="keyword">byte</span>) ((((bArr[i3] &amp; <span class="number">255</span>) &lt;&lt; (((<span class="number">2</span> - i2) * <span class="number">2</span>) + <span class="number">2</span>)) &amp; <span class="number">255</span>) &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bArr2[i2] = b;</span><br><span class="line">                    b = <span class="number">64</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            bArr2[<span class="number">3</span>] = b;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i4 = <span class="number">0</span>; i4 &lt;= <span class="number">3</span>; i4++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bArr2[i4] &lt;= <span class="number">63</span>) &#123;</span><br><span class="line">                    sb.append(table[bArr2[i4]]);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(<span class="string">'='</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] b(String str) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            GZIPOutputStream gZIPOutputStream = <span class="keyword">new</span> GZIPOutputStream(byteArrayOutputStream);</span><br><span class="line">            gZIPOutputStream.write(str.getBytes());</span><br><span class="line">            gZIPOutputStream.finish();</span><br><span class="line">            gZIPOutputStream.close();</span><br><span class="line">            <span class="keyword">byte</span>[] byteArray = byteArrayOutputStream.toByteArray();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                byteArrayOutputStream.close();</span><br><span class="line">                <span class="keyword">return</span> byteArray;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> byteArray;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键函数在<code>a(b(&quot;请输入密码:&quot;)).equals(&quot;R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=&quot;)</code><br>这里应该直接hook a，让其返回值为<code>R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=</code>就可以进入下一关了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity1"</span>).a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL="</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Frida-hook-主动调用静态-非静态函数-以及-设置静态-非静态成员变量的值"><a href="#Frida-hook-主动调用静态-非静态函数-以及-设置静态-非静态成员变量的值" class="headerlink" title="Frida hook : 主动调用静态/非静态函数 以及 设置静态/非静态成员变量的值"></a>Frida hook : 主动调用静态/非静态函数 以及 设置静态/非静态成员变量的值</h3><p>总结:</p>
<ul>
<li>静态函数直接use class然后调用方法，非静态函数需要先choose实例然后调用</li>
<li>设置成员变量的值，写法是<code>xx.value = yy</code>，其他方面和函数一样。</li>
<li>如果有一个成员变量和成员函数的名字相同，则在其前面加一个<code>_</code>，如<code>_xx.value = yy</code></li>
</ul>
<p>然后是第二关</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity2</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> static_bool_var = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> bool_var = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"当前第2关"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setStatic_bool_var</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        static_bool_var = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBool_var</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bool_var = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!static_bool_var || !<span class="keyword">this</span>.bool_var) &#123;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity3<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        finishActivity(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一关的关键在于下面的if判断要为false，则<code>static_bool_var</code>和<code>this.bool_var</code>都要为true。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (!static_bool_var || !this.bool_var) &#123;</span><br><span class="line">            super.CheckFailed();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这样就要调用<code>setBool_var</code>和<code>setStatic_bool_var</code>两个函数了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function ch2() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        console.log(&quot;start&quot;)</span><br><span class="line">        var FridaActivity2 &#x3D; Java.use(&quot;com.example.androiddemo.Activity.FridaActivity2&quot;)</span><br><span class="line">        &#x2F;&#x2F;hook静态函数直接调用</span><br><span class="line">        FridaActivity2.setStatic_bool_var()</span><br><span class="line">        &#x2F;&#x2F;hook动态函数，找到instance实例，从实例调用函数方法</span><br><span class="line">        Java.choose(&quot;com.example.androiddemo.Activity.FridaActivity2&quot;, &#123;</span><br><span class="line">            onMatch: function (instance) &#123;</span><br><span class="line">                instance.setBool_var()</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: function () &#123;</span><br><span class="line">                console.log(&quot;end&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(ch2)</span><br></pre></td></tr></table></figure>

<p>接下来是第三关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class FridaActivity3 extends BaseFridaActivity &#123;</span><br><span class="line">    private static boolean static_bool_var &#x3D; false;</span><br><span class="line">    private boolean bool_var &#x3D; false;</span><br><span class="line">    private boolean same_name_bool_var &#x3D; false;</span><br><span class="line"></span><br><span class="line">    public String getNextCheckTitle() &#123;</span><br><span class="line">        return &quot;当前第3关&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void same_name_bool_var() &#123;</span><br><span class="line">        Log.d(&quot;Frida&quot;, static_bool_var + &quot; &quot; + this.bool_var + &quot; &quot; + this.same_name_bool_var);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onCheck() &#123;</span><br><span class="line">        if (!static_bool_var || !this.bool_var || !this.same_name_bool_var) &#123;</span><br><span class="line">            super.CheckFailed();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(new Intent(this, FridaActivity4.class));</span><br><span class="line">        finishActivity(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键还是让<code>if (!static_bool_var || !this.bool_var || !this.same_name_bool_var)</code>为false，则三个变量都要为true</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        <span class="keyword">var</span> FridaActivity3 = Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity3"</span>)</span><br><span class="line">        FridaActivity3.static_bool_var.value = <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        Java.choose(<span class="string">"com.example.androiddemo.Activity.FridaActivity3"</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                instance.bool_var.value = <span class="literal">true</span></span><br><span class="line">                instance._same_name_bool_var.value = <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里要注意类里有一个成员函数和成员变量都叫做<code>same_name_bool_var</code>，这种时候在成员变量前加一个<code>_</code>，修改值的形式为<code>xx.value = yy</code></p>
<h3 id="Frida-hook-内部类，枚举类的函数并hook，trace原型1"><a href="#Frida-hook-内部类，枚举类的函数并hook，trace原型1" class="headerlink" title="Frida hook : 内部类，枚举类的函数并hook，trace原型1"></a>Frida hook : 内部类，枚举类的函数并hook，trace原型1</h3><p>总结:</p>
<ul>
<li>对于内部类，通过<code>类名$内部类名</code>去use或者choose</li>
<li>对use得到的clazz应用反射，如<code>clazz.class.getDeclaredMethods()</code>可以得到类里面声明的所有方法，即可以枚举类里面的所有函数。</li>
</ul>
<p>接下来是第四关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class FridaActivity4 extends BaseFridaActivity &#123;</span><br><span class="line">    public String getNextCheckTitle() &#123;</span><br><span class="line">        return &quot;当前第4关&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class InnerClasses &#123;</span><br><span class="line">        public static boolean check1() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check2() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check3() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check4() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check5() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check6() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private InnerClasses() &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onCheck() &#123;</span><br><span class="line">        if (!InnerClasses.check1() || !InnerClasses.check2() || !InnerClasses.check3() || !InnerClasses.check4() || !InnerClasses.check5() || !InnerClasses.check6()) &#123;</span><br><span class="line">            super.CheckFailed();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(new Intent(this, FridaActivity5.class));</span><br><span class="line">        finishActivity(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一关的关键是让<code>if (!InnerClasses.check1() || !InnerClasses.check2() || !InnerClasses.check3() || !InnerClasses.check4() || !InnerClasses.check5() || !InnerClasses.check6())</code>中的所有check全部返回true。</p>
<p>其实这里唯一的问题就是寻找内部类<code>InnerClasses</code>，对于内部类的hook，通过<code>类名$内部类名</code>去use。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch4</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> InnerClasses = Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        InnerClasses.check1.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check2.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check3.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check4.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check5.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check6.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用反射，获取类中的所有method声明，然后字符串拼接去获取到方法名，例如下面的check1，然后就可以批量hook，而不用像我上面那样一个一个写。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inner_classes = Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>)</span><br><span class="line"><span class="keyword">var</span> all_methods = inner_classes.class.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check1(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check2(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check3(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check4(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check5(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check6()</span><br></pre></td></tr></table></figure>

<h3 id="Frida-hook-hook动态加载的dex，与查找interface，"><a href="#Frida-hook-hook动态加载的dex，与查找interface，" class="headerlink" title="Frida hook : hook动态加载的dex，与查找interface，"></a>Frida hook : hook动态加载的dex，与查找interface，</h3><p>总结:</p>
<ul>
<li>通过<code>enumerateClassLoaders</code>来枚举加载进内存的classloader，再<code>loader.findClass(xxx)</code>寻找是否包括我们想要的interface的实现类，最后通过<code>Java.classFactory.loader = loader</code>来切换classloader，从而加载该实现类。</li>
</ul>
<p>第五关比较有趣，它的check函数是动态加载进来的。<br>java里有interface的概念，是指一系列抽象的接口，需要类来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.androiddemo.Dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CheckInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">check</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicCheck</span> <span class="keyword">implements</span> <span class="title">CheckInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity5</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CheckInterface DynamicDexCheck = <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CheckInterface <span class="title">getDynamicDexCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.DynamicDexCheck == <span class="keyword">null</span>) &#123;</span><br><span class="line">            loaddex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.DynamicDexCheck;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* access modifiers changed from: protected */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        loaddex();</span><br><span class="line">        <span class="comment">//this.DynamicDexCheck = (CheckInterface) new DexClassLoader(str, filesDir.getAbsolutePath(), (String) null, getClassLoader()).loadClass("com.example.androiddemo.Dynamic.DynamicCheck").newInstance();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getDynamicDexCheck() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">"onClick loaddex Failed!"</span>, <span class="number">1</span>).show();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getDynamicDexCheck().check()) &#123;</span><br><span class="line">            CheckSuccess();</span><br><span class="line">            startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity6<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">            finishActivity(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有个loaddex其实就是先从资源文件加载classloader到内存里，再loadClass DynamicCheck，创建出一个实例，最终调用这个实例的check。<br>所以现在我们就要先枚举class loader，找到能实例化我们要的class的那个class loader，然后把它设置成Java的默认class factory的loader。<br>现在就可以用这个class loader来使用<code>.use</code>去import一个给定的类。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch5</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Java.choose("com.example.androiddemo.Activity.FridaActivity5",&#123;</span></span><br><span class="line">        <span class="comment">//     onMatch:function(x)&#123;</span></span><br><span class="line">        <span class="comment">//         console.log(x.getDynamicDexCheck().$className)</span></span><br><span class="line">        <span class="comment">//     &#125;,onComplete:function()&#123;&#125;</span></span><br><span class="line">        <span class="comment">// &#125;)</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        Java.enumerateClassLoaders(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">loader</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.findClass(<span class="string">"com.example.androiddemo.Dynamic.DynamicCheck"</span>))&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">"Successfully found loader"</span>)</span><br><span class="line">                        <span class="built_in">console</span>.log(loader);</span><br><span class="line">                        Java.classFactory.loader = loader ;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(error)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"find error:"</span> + error)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end1"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Dynamic.DynamicCheck"</span>).check.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"end2"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(ch5)</span><br></pre></td></tr></table></figure>
<p>todo有一个疑问<br><a href="https://github.com/frida/frida/issues/1049" target="_blank" rel="noopener">https://github.com/frida/frida/issues/1049</a></p>
<h3 id="Frida-hook-枚举class，trace原型2"><a href="#Frida-hook-枚举class，trace原型2" class="headerlink" title="Frida hook : 枚举class，trace原型2"></a>Frida hook : 枚举class，trace原型2</h3><p>总结: 通过<code>Java.enumerateLoadedClasses</code>来枚举类，然后<code>name.indexOf(str)</code>过滤一下并hook。</p>
<p>接下来是第六关</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.androiddemo.Activity.Frida6.Frida6Class0;</span><br><span class="line"><span class="keyword">import</span> com.example.androiddemo.Activity.Frida6.Frida6Class1;</span><br><span class="line"><span class="keyword">import</span> com.example.androiddemo.Activity.Frida6.Frida6Class2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity6</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"当前第6关"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Frida6Class0.check() || !Frida6Class1.check() || !Frida6Class2.check()) &#123;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity7<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        finishActivity(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这关是import了一些类，然后调用类里的静态方法，所以我们枚举所有的类，然后过滤一下，并把过滤出来的结果hook上，改掉其返回值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch6</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">name, handle</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (name.indexOf(<span class="string">"com.example.androiddemo.Activity.Frida6"</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"name:"</span> + name + <span class="string">" handle:"</span> + handle)</span><br><span class="line">                    Java.use(name).check.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Frida-hook-搜索interface的具体实现类"><a href="#Frida-hook-搜索interface的具体实现类" class="headerlink" title="Frida hook : 搜索interface的具体实现类"></a>Frida hook : 搜索interface的具体实现类</h3><p>利用反射得到类里面实现的interface数组，并打印出来。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">more</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">class_name</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (class_name.indexOf(<span class="string">"com.example.androiddemo"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">var</span> hook_cls = Java.use(class_name)</span><br><span class="line">                    <span class="keyword">var</span> interfaces = hook_cls.class.getInterfaces()</span><br><span class="line">                    <span class="keyword">if</span> (interfaces.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(class_name + <span class="string">": "</span>)</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> interfaces) &#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">"\t"</span>, interfaces[i].toString())</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Frida-hook基础（二"><a href="#Frida-hook基础（二" class="headerlink" title="Frida hook基础（二)"></a>Frida hook基础（二)</h2><ul>
<li>spawn/attach</li>
<li>各种主动调用</li>
<li>hook函数和hook构造函数</li>
<li>调用栈/简单脚本</li>
<li>动态加载自己的dex</li>
</ul>
<p>题目下载地址:<br><a href="https://github.com/tlamb96/kgb_messenger" target="_blank" rel="noopener">https://github.com/tlamb96/kgb_messenger</a></p>
<h3 id="spawn-attach"><a href="#spawn-attach" class="headerlink" title="spawn/attach"></a>spawn/attach</h3><p>firda的-f参数代表span启动<br><code>frida -U -f com.tlamb96.spetsnazmessenger -l frida_russian.js --no-pause</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* access modifiers changed from: protected */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView((<span class="keyword">int</span>) R.layout.activity_main);</span><br><span class="line">        String property = System.getProperty(<span class="string">"user.home"</span>);</span><br><span class="line">        String str = System.getenv(<span class="string">"USER"</span>);</span><br><span class="line">        <span class="keyword">if</span> (property == <span class="keyword">null</span> || property.isEmpty() || !property.equals(<span class="string">"Russia"</span>)) &#123;</span><br><span class="line">            a(<span class="string">"Integrity Error"</span>, <span class="string">"This app can only run on Russian devices."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.isEmpty() || !str.equals(getResources().getString(R.string.User))) &#123;</span><br><span class="line">            a(<span class="string">"Integrity Error"</span>, <span class="string">"Must be on the user whitelist."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a.a(<span class="keyword">this</span>);</span><br><span class="line">            startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, LoginActivity<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个题目比较简单，但是因为这个check是在<code>onCreate</code>里，所以app刚启动就自动检查，所以这里需要用spawn的方式去启动frida脚本hook，而不是attach。<br>这里有两个检查，一个是检查property的值，一个是检查str的值。<br>分别从<code>System.getProperty</code>和<code>System.getenv</code>里获取，hook住这两个函数就行。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-29-092212.png" alt=""><br>这里要注意从资源文件里找到<code>User</code>的值。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.use(<span class="string">"java.lang.System"</span>).getProperty.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Russia"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Java.use(<span class="string">"java.lang.System"</span>).getenv.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"RkxBR3s1N0VSTDFOR180UkNIM1J9Cg=="</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<p>接下来进入到login功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLogin</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        EditText editText = (EditText) findViewById(R.id.login_username);</span><br><span class="line">        EditText editText2 = (EditText) findViewById(R.id.login_password);</span><br><span class="line">        <span class="keyword">this</span>.n = editText.getText().toString();</span><br><span class="line">        <span class="keyword">this</span>.o = editText2.getText().toString();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.n != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.o != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.n.isEmpty() &amp;&amp; !<span class="keyword">this</span>.o.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.n.equals(getResources().getString(R.string.username))) &#123;</span><br><span class="line">                Toast.makeText(<span class="keyword">this</span>, <span class="string">"User not recognized."</span>, <span class="number">0</span>).show();</span><br><span class="line">                editText.setText(<span class="string">""</span>);</span><br><span class="line">                editText2.setText(<span class="string">""</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!j()) &#123;</span><br><span class="line">                Toast.makeText(<span class="keyword">this</span>, <span class="string">"Incorrect password."</span>, <span class="number">0</span>).show();</span><br><span class="line">                editText.setText(<span class="string">""</span>);</span><br><span class="line">                editText2.setText(<span class="string">""</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i();</span><br><span class="line">                startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, MessengerActivity<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">j</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span> b : <span class="keyword">this</span>.m.digest(<span class="keyword">this</span>.o.getBytes())) &#123;</span><br><span class="line">            str = str + String.format(<span class="string">"%x"</span>, <span class="keyword">new</span> Object[]&#123;Byte.valueOf(b)&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str.equals(getResources().getString(R.string.password));</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">i</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] cArr = &#123;<span class="string">'('</span>, <span class="string">'W'</span>, <span class="string">'D'</span>, <span class="string">')'</span>, <span class="string">'T'</span>, <span class="string">'P'</span>, <span class="string">':'</span>, <span class="string">'#'</span>, <span class="string">'?'</span>, <span class="string">'T'</span>&#125;;</span><br><span class="line">        cArr[<span class="number">0</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">0</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">1</span>));</span><br><span class="line">        cArr[<span class="number">1</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">1</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">0</span>));</span><br><span class="line">        cArr[<span class="number">2</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">2</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">4</span>));</span><br><span class="line">        cArr[<span class="number">3</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">3</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">4</span>));</span><br><span class="line">        cArr[<span class="number">4</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">4</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">7</span>));</span><br><span class="line">        cArr[<span class="number">5</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">5</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">0</span>));</span><br><span class="line">        cArr[<span class="number">6</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">6</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">2</span>));</span><br><span class="line">        cArr[<span class="number">7</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">7</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">3</span>));</span><br><span class="line">        cArr[<span class="number">8</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">8</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">6</span>));</span><br><span class="line">        cArr[<span class="number">9</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">9</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">8</span>));</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"FLAG&#123;"</span> + <span class="keyword">new</span> String(cArr) + <span class="string">"&#125;"</span>, <span class="number">1</span>).show();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-29-092522.png" alt=""><br>从资源文件里找到username,密码则是要算一个j()函数，要让它返回true，顺便打印一下i函数toast到界面的flag。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.use(<span class="string">"com.tlamb96.kgbmessenger.LoginActivity"</span>).j.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">Java.use(<span class="string">"android.widget.Toast"</span>).makeText.overload(<span class="string">'android.content.Context'</span>, <span class="string">'java.lang.CharSequence'</span>, <span class="string">'int'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x, y, z</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> flag = Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(y)</span><br><span class="line">    <span class="built_in">console</span>.log(flag)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">[Google Pixel::com.tlamb96.spetsnazmessenger]-&gt; FLAG&#123;G&amp;qG13     R0&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Frida-hook-hook构造函数-打印栈回溯"><a href="#Frida-hook-hook构造函数-打印栈回溯" class="headerlink" title="Frida hook :hook构造函数/打印栈回溯"></a>Frida hook :hook构造函数/打印栈回溯</h3><p>总结:<br>hook构造函数实现通过use取得类，然后<code>clazz.$init.implementation = callback</code> hook构造函数。</p>
<p>我们先学习一下怎么hook构造函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.katya, <span class="string">"Archer, you up?"</span>, <span class="string">"2:20 am"</span>, <span class="keyword">true</span>));</span><br><span class="line">...</span><br><span class="line"><span class="keyword">package</span> com.tlamb96.kgbmessenger.b;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">a</span><span class="params">(<span class="keyword">int</span> i, String str, String str2, <span class="keyword">boolean</span> z)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f448a = i;</span><br><span class="line">        <span class="keyword">this</span>.b = str;</span><br><span class="line">        <span class="keyword">this</span>.c = str2;</span><br><span class="line">        <span class="keyword">this</span>.d = z;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用<code>$init</code>来hook构造函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Java.use(<span class="string">"com.tlamb96.kgbmessenger.b.a"</span>).$init.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">i, str1, str2, z</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.$init(i, str1, str2, z)</span><br><span class="line">            <span class="built_in">console</span>.log(i, str1, str2, z)</span><br><span class="line">            printStack(<span class="string">"com.tlamb96.kgbmessenger.b.a"</span>)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Frida-hook-打印栈回溯"><a href="#Frida-hook-打印栈回溯" class="headerlink" title="Frida hook : 打印栈回溯"></a>Frida hook : 打印栈回溯</h3><p>打印栈回溯</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">"java.lang.Exception"</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$<span class="keyword">new</span>(<span class="string">"Exception"</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">"\\n"</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"============================="</span> + name + <span class="string">" Stack strat======================="</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(replaceStr);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"============================="</span> + name + <span class="string">" Stack end=======================\r\n"</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出就是这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Google Pixel::com.tlamb96.spetsnazmessenger]-&gt; 2131558449 111 02:27 下午 false</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;com.tlamb96.kgbmessenger.b.a Stack strat&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">com.tlamb96.kgbmessenger.b.a.&lt;init&gt;(Native Method)</span><br><span class="line">com.tlamb96.kgbmessenger.MessengerActivity.onSendMessage(Unknown Source:40)</span><br><span class="line">java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">android.support.v7.app.m$a.onClick(Unknown Source:25)</span><br><span class="line">android.view.View.performClick(View.java:6294)</span><br><span class="line">android.view.View$PerformClick.run(View.java:24770)</span><br><span class="line">android.os.Handler.handleCallback(Handler.java:790)</span><br><span class="line">android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">android.os.Looper.loop(Looper.java:164)</span><br><span class="line">android.app.ActivityThread.main(ActivityThread.java:6494)</span><br><span class="line">java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;com.tlamb96.kgbmessenger.b.a Stack end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>
<h3 id="Frida-hook-手动加载dex并调用"><a href="#Frida-hook-手动加载dex并调用" class="headerlink" title="Frida hook : 手动加载dex并调用"></a>Frida hook : 手动加载dex并调用</h3><p>总结：<br>编译出dex之后，通过<code>Java.openClassFile(&quot;xxx.dex&quot;).load()</code>加载，这样我们就可以正常通过<code>Java.use</code>调用里面的方法了。</p>
<p>现在我们来继续解决这个问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSendMessage</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    EditText editText = (EditText) findViewById(R.id.edittext_chatbox);</span><br><span class="line">    String obj = editText.getText().toString();</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(obj)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.o.add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.user, obj, j(), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.n.c();</span><br><span class="line">        <span class="keyword">if</span> (a(obj.toString()).equals(<span class="keyword">this</span>.p)) &#123;</span><br><span class="line">            Log.d(<span class="string">"MessengerActivity"</span>, <span class="string">"Successfully asked Boris for the password."</span>);</span><br><span class="line">            <span class="keyword">this</span>.q = obj.toString();</span><br><span class="line">            <span class="keyword">this</span>.o.add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.boris, <span class="string">"Only if you ask nicely"</span>, j(), <span class="keyword">true</span>));</span><br><span class="line">            <span class="keyword">this</span>.n.c();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (b(obj.toString()).equals(<span class="keyword">this</span>.r)) &#123;</span><br><span class="line">            Log.d(<span class="string">"MessengerActivity"</span>, <span class="string">"Successfully asked Boris nicely for the password."</span>);</span><br><span class="line">            <span class="keyword">this</span>.s = obj.toString();</span><br><span class="line">            <span class="keyword">this</span>.o.add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.boris, <span class="string">"Wow, no one has ever been so nice to me! Here you go friend: FLAG&#123;"</span> + i() + <span class="string">"&#125;"</span>, j(), <span class="keyword">true</span>));</span><br><span class="line">            <span class="keyword">this</span>.n.c();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.m.b(<span class="keyword">this</span>.m.getAdapter().a() - <span class="number">1</span>);</span><br><span class="line">        editText.setText(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新的一关是一个聊天框，分析一下代码可知，obj是我们输入的内容，输入完了之后，加到一个<code>this.o</code>的ArrayList里。<br>关键的if判断就是<code>if (a(obj.toString()).equals(this.p))</code>和<code>if (b(obj.toString()).equals(this.r))</code>，所有hook a和b函数，让它们的返回值等于下面的字符串即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String p = <span class="string">"V@]EAASB\u0012WZF\u0012e,a$7(&amp;am2(3.\u0003"</span>;</span><br><span class="line"><span class="keyword">private</span> String q;</span><br><span class="line"><span class="keyword">private</span> String r = <span class="string">"\u0000dslp&#125;oQ\u0000 dks$|M\u0000h +AYQg\u0000P*!M$gQ\u0000"</span>;</span><br><span class="line"><span class="keyword">private</span> String s;</span><br></pre></td></tr></table></figure>
<p>但实际上这题比我想象中的还要麻烦，这题的逻辑上是如果通过了a和b这两个函数的计算，等于对应的值之后，会把用来计算的obj的值赋值给q和s，然后根据这个q和s来计算出最终的flag。<br>所以如果不逆向算法，通过hook的方式通过了a和b的计算，obj的值还是错误的，也计算不出正确的flag。</p>
<p>这样就逆向一下算法好了，先自己写一个apk，用java去实现注册机。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-004653.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-004915.png" alt=""><br>可以直接把class文件转成dex，不复述，我比较懒，所以我直接解压apk找到<code>classes.dex</code>，并push到手机上。<br>然后用frida加载这个dex，并调用里面的方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dex = Java.openClassFile(<span class="string">"/data/local/tmp/classes.dex"</span>).load();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"decode_P:"</span>+Java.use(<span class="string">"myapplication.example.com.reversea.reverseA"</span>).decode_P());</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"r_to_hex:"</span>+Java.use(<span class="string">"myapplication.example.com.reversea.reverseA"</span>).r_to_hex());</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">decode_P:Boris, give me the password</span><br><span class="line">r_to_hex:<span class="number">0064736</span>c707d6f510020646b73247c4d0068202b4159516700502a214d24675100</span><br></pre></td></tr></table></figure>

<h2 id="Frida打印与参数构造"><a href="#Frida打印与参数构造" class="headerlink" title="Frida打印与参数构造"></a>Frida打印与参数构造</h2><ul>
<li>数组/(字符串)对象数组/gson/Java.array</li>
<li>对象/多态、强转Java.cast/接口Java.register</li>
<li>泛型、List、Map、Set、迭代打印</li>
<li>non-ascii 、 child-gating、rpc 上传到PC上打印<h3 id="char-Object-Object"><a href="#char-Object-Object" class="headerlink" title="char[]/[Object Object]"></a>char[]/[Object Object]</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Log.d(<span class="string">"SimpleArray"</span>, <span class="string">"onCreate: SImpleArray"</span>);</span><br><span class="line"><span class="keyword">char</span> arr[][] = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">4</span>][]; <span class="comment">// 创建一个4行的二维数组</span></span><br><span class="line">arr[<span class="number">0</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'春'</span>, <span class="string">'眠'</span>, <span class="string">'不'</span>, <span class="string">'觉'</span>, <span class="string">'晓'</span> &#125;; <span class="comment">// 为每一行赋值</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'处'</span>, <span class="string">'处'</span>, <span class="string">'闻'</span>, <span class="string">'啼'</span>, <span class="string">'鸟'</span> &#125;;</span><br><span class="line">arr[<span class="number">2</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'夜'</span>, <span class="string">'来'</span>, <span class="string">'风'</span>, <span class="string">'雨'</span>, <span class="string">'声'</span> &#125;;</span><br><span class="line">arr[<span class="number">3</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'花'</span>, <span class="string">'落'</span>, <span class="string">'知'</span>, <span class="string">'多'</span>, <span class="string">'少'</span> &#125;;</span><br><span class="line">Log.d(<span class="string">"SimpleArray"</span>, <span class="string">"-----横版-----"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123; <span class="comment">// 循环4行</span></span><br><span class="line">    Log.d(<span class="string">"SimpleArraysToString"</span>, Arrays.toString(arr[i]));</span><br><span class="line">    Log.d(<span class="string">"SimpleStringBytes"</span>, Arrays.toString (Arrays.toString (arr[i]).getBytes()));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++) &#123; <span class="comment">// 循环5列</span></span><br><span class="line">        Log.d(<span class="string">"SimpleArray"</span>, Character.toString(arr[i][j])); <span class="comment">// 输出数组中的元素</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.d(<span class="string">"SimpleArray"</span>, <span class="string">","</span>);<span class="comment">// 如果是一、三句，输出逗号</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.d(<span class="string">"SimpleArray"</span>, <span class="string">"。"</span>);<span class="comment">// 如果是二、四句，输出句号</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Java.openClassFile(<span class="string">"/data/local/tmp/r0gson.dex"</span>).load();</span><br><span class="line"><span class="keyword">const</span> gson = Java.use(<span class="string">'com.r0ysue.gson.Gson'</span>);</span><br><span class="line"></span><br><span class="line">Java.use(<span class="string">"java.lang.Character"</span>).toString.overload(<span class="string">'char'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">char</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(char);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"char,result"</span>,char,result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[C'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">charArray</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(charArray);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"charArray,result:"</span>,charArray,result)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"charArray Object Object:"</span>,gson.$<span class="keyword">new</span>().toJson(charArray));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里的<code>[C</code>是JNI函数签名<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-033242.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-033633.png" alt=""></li>
</ul>
<h3 id="byte"><a href="#byte" class="headerlink" title="byte[]"></a>byte[]</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Java.openClassFile(<span class="string">"/data/local/tmp/r0gson.dex"</span>).load();</span><br><span class="line"><span class="keyword">const</span> gson = Java.use(<span class="string">'com.r0ysue.gson.Gson'</span>);</span><br><span class="line"></span><br><span class="line">Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[B'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">byteArray</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(byteArray);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"byteArray,result):"</span>,byteArray,result)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"byteArray Object Object:"</span>,gson.$<span class="keyword">new</span>().toJson(byteArray));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-034053.png" alt=""></p>
<h3 id="java-array构造"><a href="#java-array构造" class="headerlink" title="java array构造"></a>java array构造</h3><p>如果不只是想打印出结果，而是要替换原本的参数，就要先自己构造出一个charArray,使用<code>Java.array</code>API</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a Java array with elements of the specified `type`, from a</span></span><br><span class="line"><span class="comment"> * JavaScript array `elements`. The resulting Java array behaves like</span></span><br><span class="line"><span class="comment"> * a JS array, but can be passed by reference to Java APIs in order to</span></span><br><span class="line"><span class="comment"> * allow them to modify its contents.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>type Type name of elements.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>elements Array of JavaScript values to use for constructing the</span></span><br><span class="line"><span class="comment"> *                 Java array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">function array(type: string, elements: any[]): any[];</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[C'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">charArray</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newCharArray = Java.array(<span class="string">'char'</span>, [ <span class="string">'一'</span>,<span class="string">'去'</span>,<span class="string">'二'</span>,<span class="string">'三'</span>,<span class="string">'里'</span> ]);</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(newCharArray);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"newCharArray,result:"</span>,newCharArray,result)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"newCharArray Object Object:"</span>,gson.$<span class="keyword">new</span>().toJson(newCharArray));</span><br><span class="line">    <span class="keyword">var</span> newResult = Java.use(<span class="string">'java.lang.String'</span>).$<span class="keyword">new</span>(Java.array(<span class="string">'char'</span>, [ <span class="string">'烟'</span>,<span class="string">'村'</span>,<span class="string">'四'</span>,<span class="string">'五'</span>,<span class="string">'家'</span>]))</span><br><span class="line">    <span class="keyword">return</span> newResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以用来构造参数重发包，用在爬虫上。</p>
<h3 id="类的多态：转型-Java-cast"><a href="#类的多态：转型-Java-cast" class="headerlink" title="类的多态：转型/Java.cast"></a>类的多态：转型/Java.cast</h3><p>可以通过<code>getClass().getName().toString()</code>来查看当前实例的类型。<br>找到一个instance，通过<code>Java.cast</code>来强制转换对象的类型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a JavaScript wrapper given the existing instance at `handle` of</span></span><br><span class="line"><span class="comment"> * given class `klass` as returned from `Java.use()`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>handle An existing wrapper or a JNI handle.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>klass Class wrapper for type to cast to.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cast</span>(<span class="params">handle: Wrapper | NativePointerValue, klass: Wrapper</span>): <span class="title">Wrapper</span>;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Water</span> </span>&#123; <span class="comment">// 水 类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">flow</span><span class="params">(Water W)</span> </span>&#123; <span class="comment">// 水 的方法</span></span><br><span class="line">        <span class="comment">// SomeSentence</span></span><br><span class="line">        Log.d(<span class="string">"2Object"</span>, <span class="string">"water flow: I`m flowing"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"water flow: I`m flowing"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">still</span><span class="params">(Water W)</span> </span>&#123; <span class="comment">// 水 的方法</span></span><br><span class="line">        <span class="comment">// SomeSentence</span></span><br><span class="line">        Log.d(<span class="string">"2Object"</span>, <span class="string">"water still: still water runs deep!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"water still: still water runs deep!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Juice</span> <span class="keyword">extends</span> <span class="title">Water</span> </span>&#123; <span class="comment">// 果汁 类 继承了水类</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fillEnergy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">"2Object"</span>, <span class="string">"Juice: i`m fillingEnergy!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Juice: i`m fillingEnergy!"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> JuiceHandle = <span class="literal">null</span> ;</span><br><span class="line">Java.choose(<span class="string">"com.r0ysue.a0526printout.Juice"</span>,&#123;</span><br><span class="line">    onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"found juice instance"</span>,instance);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"juice instance call fill"</span>,instance.fillEnergy());</span><br><span class="line">        JuiceHandle = instance;</span><br><span class="line">    &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"juice handle search completed!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Saved juice handle :"</span>,JuiceHandle);</span><br><span class="line"><span class="keyword">var</span> WaterHandle = Java.cast(JuiceHandle,Java.use(<span class="string">"com.r0ysue.a0526printout.Water"</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"call Waterhandle still method:"</span>,WaterHandle.still(WaterHandle));</span><br></pre></td></tr></table></figure>
<h3 id="interface-Java-registerClass"><a href="#interface-Java-registerClass" class="headerlink" title="interface/Java.registerClass"></a>interface/Java.registerClass</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">liquid</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">flow</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>frida提供能力去创建一个新的java class</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a new Java class.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param </span>spec Object describing the class to be created.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerClass</span>(<span class="params">spec: ClassSpec</span>): <span class="title">Wrapper</span>;</span></span><br></pre></td></tr></table></figure>

<p>首先获取要实现的interface，然后调用registerClass来实现interface。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> liquid = Java.use(<span class="string">"com.r0ysue.a0526printout.liquid"</span>);</span><br><span class="line">        <span class="keyword">var</span> beer = Java.registerClass(&#123;</span><br><span class="line">            name: <span class="string">'com.r0ysue.a0526printout.beer'</span>,</span><br><span class="line">            implements: [liquid],</span><br><span class="line">            methods: &#123;</span><br><span class="line">                flow: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"look, beer is flowing!"</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"look, beer is flowing!"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"beer.bubble:"</span>,beer.$<span class="keyword">new</span>().flow())      </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="成员内部类-匿名内部类"><a href="#成员内部类-匿名内部类" class="headerlink" title="成员内部类/匿名内部类"></a>成员内部类/匿名内部类</h3><p>看smali或者枚举出来的类。</p>
<h3 id="hook-enum"><a href="#hook-enum" class="headerlink" title="hook enum"></a>hook enum</h3><p>关于java枚举，从这篇文章了解。<br><a href="https://www.cnblogs.com/jingmoxukong/p/6098351.html" target="_blank" rel="noopener">https://www.cnblogs.com/jingmoxukong/p/6098351.html</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Signal &#123;</span><br><span class="line">    GREEN, YELLOW, RED</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrafficLight</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Signal color = Signal.RED;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"4enum"</span>, <span class="string">"enum "</span>+ color.getClass().getName().toString());</span><br><span class="line">        <span class="keyword">switch</span> (color) &#123;</span><br><span class="line">            <span class="keyword">case</span> RED:</span><br><span class="line">                color = Signal.GREEN;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YELLOW:</span><br><span class="line">                color = Signal.RED;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> GREEN:</span><br><span class="line">                color = Signal.YELLOW;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">"com.r0ysue.a0526printout.Signal"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"instance.name:"</span>,instance.name());</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"instance.getDeclaringClass:"</span>,instance.getDeclaringClass());                </span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"search completed!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="打印hash-map"><a href="#打印hash-map" class="headerlink" title="打印hash map"></a>打印hash map</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">"java.util.HashMap"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(instance.toString().indexOf(<span class="string">"ISBN"</span>)!= <span class="number">-1</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"instance.toString:"</span>,instance.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"search complete!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h3 id="打印non-ascii"><a href="#打印non-ascii" class="headerlink" title="打印non-ascii"></a>打印non-ascii</h3><p><a href="https://api-caller.com/2019/03/30/frida-note/#non-ascii" target="_blank" rel="noopener">https://api-caller.com/2019/03/30/frida-note/#non-ascii</a><br>类名非ASCII字符串时，先编码打印出来, 再用编码后的字符串去 hook.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//场景hook cls.forName寻找目标类的classloader。</span></span><br><span class="line">    cls.forName.overload(<span class="string">'java.lang.String'</span>, <span class="string">'boolean'</span>, <span class="string">'java.lang.ClassLoader'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg1, arg2, arg3</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> clsName = cls.forName(arg1, arg2, arg3);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'oriClassName:'</span> + arg1)</span><br><span class="line">        <span class="keyword">var</span> base64Name = <span class="built_in">encodeURIComponent</span>(arg1)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'encodeName:'</span> + base64Name);</span><br><span class="line">        <span class="comment">//通过日志确认base64后的非ascii字符串，下面对比并打印classloader</span></span><br><span class="line">        <span class="comment">//clsName为特殊字符o.ÎÉ«</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">'o.%CE%99%C9%AB'</span> == base64Name) &#123;</span><br><span class="line">            <span class="comment">//打印classloader</span></span><br><span class="line">            <span class="built_in">console</span>.log(arg3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clsName;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Frida-native-hook-NDK开发入门"><a href="#Frida-native-hook-NDK开发入门" class="headerlink" title="Frida native hook : NDK开发入门"></a>Frida native hook : NDK开发入门</h2><p><a href="https://www.jianshu.com/p/87ce6f565d37" target="_blank" rel="noopener">https://www.jianshu.com/p/87ce6f565d37</a></p>
<ul>
<li>extern “C”与名称修饰<ul>
<li>通过c++filt工具可以直接还原得到原来的函数名</li>
<li><a href="https://zh.wikipedia.org/zh-hans/%E5%90%8D%E5%AD%97%E4%BF%AE%E9%A5%B0" target="_blank" rel="noopener">https://zh.wikipedia.org/zh-hans/%E5%90%8D%E5%AD%97%E4%BF%AE%E9%A5%B0</a></li>
<li>通过extern “C”导出的JNI函数不会被name mangling</li>
</ul>
</li>
<li>JNI参数与基本类型</li>
<li>第一个NDK程序<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-154643.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-155007.png" alt=""></li>
<li>JNI log<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG <span class="meta-string">"sakura1328"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,TAG,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,TAG,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++"</span>;</span><br><span class="line">    LOGD(<span class="string">"sakura1328"</span>);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="title">extends</span> <span class="title">AppCompatActivity</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> TAG = <span class="string">"sakura"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the 'native-lib' library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = (TextView) findViewById(R.id.sample_text);</span><br><span class="line">        tv.setText(stringFromJNI());</span><br><span class="line">        Log.d(TAG, stringFromJNI());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the 'native-lib' native library,</span></span><br><span class="line"><span class="comment">     * which is packaged with this application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> native <span class="keyword">String</span> <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Frida-native-hook-JNIEnv和反射"><a href="#Frida-native-hook-JNIEnv和反射" class="headerlink" title="Frida native hook : JNIEnv和反射"></a>Frida native hook : JNIEnv和反射</h2><h3 id="以jni字符串来掌握基本的JNIEnv用法"><a href="#以jni字符串来掌握基本的JNIEnv用法" class="headerlink" title="以jni字符串来掌握基本的JNIEnv用法"></a>以jni字符串来掌握基本的JNIEnv用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringWithJNI</span><span class="params">(String context)</span></span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">extern <span class="string">"C"</span></span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringWithJNI(JNIEnv *env, jobject instance,</span><br><span class="line">                                                                    jstring context_) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *context = env-&gt;GetStringUTFChars(context_, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> context_size = env-&gt;GetStringUTFLength(context_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"%s\n"</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(context_, context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"sakura1328"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">22</span>:<span class="number">30</span>:<span class="number">00.548</span> <span class="number">15764</span>-<span class="number">15764</span>/myapplication.example.com.ndk_demo D/sakura1328: sakura</span><br></pre></td></tr></table></figure>

<h3 id="Java反射"><a href="#Java反射" class="headerlink" title="Java反射"></a>Java反射</h3><p>总结: 多去读一下java的反射API。</p>
<p><a href="https://www.jianshu.com/p/9be58ee20dee" target="_blank" rel="noopener">Java高级特性——反射</a></p>
<ul>
<li>查找调用各种API接口、JNI、frida/xposed原理的一部分</li>
<li>反射基本API</li>
<li>反射修改访问控制、修改属性值</li>
<li>JNI so调用反射进入java世界</li>
<li>xposed/Frida hook原理</li>
</ul>
<p>这里其实有一个伏笔，就是为什么我们要trace artmethod，hook artmethod是因为有些so混淆得非常厉害，然后也就很难静态分析看出so里面调用了哪些java函数，也不是通过类似JNI的GetMethodID这样来调用的。<br>而是通过类似findclass这种方法先得到类，然后再反射调用app里面的某个java函数。</p>
<p>所以去hook它执行的位置，每一个java函数对于Android源码而言都是一个artmethod结构体，然后hook拿到artmethod实例以后调用类函数，打印这个函数的名称。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"sakura"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the 'native-lib' library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = (TextView) findViewById(R.id.sample_text);</span><br><span class="line">        tv.setText(stringWithJNI(<span class="string">"sakura"</span>));</span><br><span class="line"><span class="comment">//        Log.d(TAG, stringFromJNI());</span></span><br><span class="line"><span class="comment">//        Log.d(TAG, stringWithJNI("sakura"));</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            testClass();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClass</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException </span>&#123;</span><br><span class="line">        Test sakuraTest = <span class="keyword">new</span> Test();</span><br><span class="line">        <span class="comment">// 获得Class的方法（三种）</span></span><br><span class="line">        Class testClazz = MainActivity.class.getClassLoader().loadClass("myapplication.example.com.ndk_demo.Test");</span><br><span class="line">        Class testClazz2 = Class.forName(<span class="string">"myapplication.example.com.ndk_demo.Test"</span>);</span><br><span class="line">        Class testClazz3 = Test<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        Log.i(TAG, <span class="string">"Classloader.loadClass-&gt;"</span> + testClazz);</span><br><span class="line">        Log.i(TAG, <span class="string">"Classloader.loadClass-&gt;"</span> + testClazz2);</span><br><span class="line">        Log.i(TAG, <span class="string">"Classloader.loadClass-&gt;"</span> + testClazz3.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得类中属性相关的方法</span></span><br><span class="line">        Field publicStaticField = testClazz3.getDeclaredField(<span class="string">"publicStaticField"</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredField-&gt;"</span> + publicStaticField);</span><br><span class="line"></span><br><span class="line">        Field publicField = testClazz3.getDeclaredField(<span class="string">"publicField"</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredField-&gt;"</span> + publicField);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于Field的get方法，如果是static，则传入null即可;如果不是，则需要传入一个类的实例</span></span><br><span class="line">        String valueStaticPublic = (String) publicStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"publicStaticField.get-&gt;"</span> + valueStaticPublic);</span><br><span class="line"></span><br><span class="line">        String valuePublic = (String) publicField.get(sakuraTest);</span><br><span class="line">        Log.i(TAG, <span class="string">"publicField.get-&gt;"</span> + valuePublic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于private属性，需要设置Accessible</span></span><br><span class="line">        Field privateStaticField = testClazz3.getDeclaredField(<span class="string">"privateStaticField"</span>);</span><br><span class="line">        privateStaticField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        String valuePrivte = (String) privateStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"modified before privateStaticField.get-&gt;"</span> + valuePrivte);</span><br><span class="line"></span><br><span class="line">        privateStaticField.set(<span class="keyword">null</span>, <span class="string">"modified"</span>);</span><br><span class="line"></span><br><span class="line">        valuePrivte = (String) privateStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"modified after privateStaticField.get-&gt;"</span> + valuePrivte);</span><br><span class="line"></span><br><span class="line">        Field[] fields = testClazz3.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field i : fields) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"testClazz3.getDeclaredFields-&gt;"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得类中method相关的方法</span></span><br><span class="line">        Method publicStaticMethod = testClazz3.getDeclaredMethod(<span class="string">"publicStaticFunc"</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredMethod-&gt;"</span> + publicStaticMethod);</span><br><span class="line"></span><br><span class="line">        publicStaticMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Method publicMethod = testClazz3.getDeclaredMethod(<span class="string">"publicFunc"</span>, java.lang.String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredMethod-&gt;"</span> + publicMethod);</span><br><span class="line"></span><br><span class="line">        publicMethod.invoke(sakuraTest, <span class="string">" sakura"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the 'native-lib' native library,</span></span><br><span class="line"><span class="comment">     * which is packaged with this application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringWithJNI</span><span class="params">(String context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"sakura_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String publicStaticField = <span class="string">"i am a publicStaticField"</span>;</span><br><span class="line">    <span class="keyword">public</span> String publicField = <span class="string">"i am a publicField"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String privateStaticField = <span class="string">"i am a privateStaticField"</span>;</span><br><span class="line">    <span class="keyword">private</span> String privateField = <span class="string">"i am a privateField"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publicStaticFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"I`m from publicStaticFunc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publicFunc</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"I`m from publicFunc"</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">privateStaticFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"I`m from privateFunc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">privateFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"I`m from privateFunc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.784</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: Classloader.loadClass-&gt;<span class="class"><span class="keyword">class</span> <span class="title">myapplication</span>.<span class="title">example</span>.<span class="title">com</span>.<span class="title">ndk_demo</span>.<span class="title">Test</span></span></span><br><span class="line">12-26 23:57:11.784 17682-17682/myapplication.example.com.ndk_demo I/sakura: Classloader.loadClass-&gt;class myapplication.example.com.ndk_demo.Test</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.784</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: Classloader.loadClass-&gt;myapplication.example.com.ndk_demo.Test</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredField-&gt;<span class="keyword">public</span> <span class="keyword">static</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredField-&gt;<span class="keyword">public</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: publicStaticField.get-&gt;i am a publicStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: publicField.get-&gt;i am a publicField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: modified before privateStaticField.get-&gt;i am a privateStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: modified after privateStaticField.get-&gt;modified</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">private</span> java.lang.String myapplication.example.com.ndk_demo.Test.privateField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">public</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String myapplication.example.com.ndk_demo.Test.TAG</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">private</span> <span class="keyword">static</span> java.lang.String myapplication.example.com.ndk_demo.Test.privateStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">public</span> <span class="keyword">static</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredMethod-&gt;<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> myapplication.example.com.ndk_demo.Test.publicStaticFunc()</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo D/sakura_test: I`m from publicStaticFunc</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.786</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredMethod-&gt;<span class="keyword">public</span> <span class="keyword">void</span> myapplication.example.com.ndk_demo.Test.publicFunc(java.lang.String)</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.786</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo D/sakura_test: I`m from publicFunc sakura</span><br></pre></td></tr></table></figure>

<p><code>memory list modules</code><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-065833.png" alt=""></p>
<h2 id="Frida反调试"><a href="#Frida反调试" class="headerlink" title="Frida反调试"></a>Frida反调试</h2><p>这一节的主要内容就是关于反调试的原理和如何破解反调试，重要内容还是看文章理解即可。<br>因为我并不需要做反调试相关的工作，所以部分内容略过。</p>
<ul>
<li>Frida反调试与反反调试基本思路<br>（Java层API、Native层API、Syscall)<ul>
<li><a href="https://github.com/qtfreet00/AntiFrida" target="_blank" rel="noopener">AntiFrida</a></li>
<li><a href="https://github.com/b-mueller/frida-detection-demo" target="_blank" rel="noopener">frida-detection-demo</a></li>
<li><a href="https://bbs.pediy.com/thread-217482.htm" target="_blank" rel="noopener">多种特征检测Frida</a></li>
<li><a href="https://yq.aliyun.com/articles/71120" target="_blank" rel="noopener">来自高维的对抗 - 逆向TinyTool自制</a></li>
<li><a href="https://bbs.pediy.com/thread-253868.htm" target="_blank" rel="noopener">Unicorn 在 Android 的应用</a></li>
</ul>
</li>
</ul>
<h2 id="Frida-native-hook-符号hook-JNI、art-amp-libc"><a href="#Frida-native-hook-符号hook-JNI、art-amp-libc" class="headerlink" title="Frida native hook : 符号hook JNI、art&amp;libc"></a>Frida native hook : 符号hook JNI、art&amp;libc</h2><h3 id="Native函数的Java-Hook及主动调用"><a href="#Native函数的Java-Hook及主动调用" class="headerlink" title="Native函数的Java Hook及主动调用"></a>Native函数的Java Hook及主动调用</h3><p>对native函数的java层hook和主动调用和普通java函数完全一致，略过。</p>
<h3 id="jni-h头文件导入"><a href="#jni-h头文件导入" class="headerlink" title="jni.h头文件导入"></a><code>jni.h</code>头文件导入</h3><p>导入jni.h，先search一下这个文件在哪。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Library&#x2F;Android&#x2F;sdk$ find .&#x2F; -name &quot;jni.h&quot;</span><br><span class="line">.&#x2F;&#x2F;ndk-bundle&#x2F;sysroot&#x2F;usr&#x2F;include&#x2F;jni.h</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-103826.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error &#x2F;Users&#x2F;sakura&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk-bundle&#x2F;sysroot&#x2F;usr&#x2F;include&#x2F;jni.h,27: Can&#39;t open include file &#39;stdarg.h&#39;</span><br><span class="line">Total 1 errors</span><br><span class="line">Caching &#39;Exports&#39;... ok</span><br></pre></td></tr></table></figure>
<p>报错，所以拷贝一份jni.h出来</p>
<p>将这两个头文件导入删掉<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104029.png" alt=""></p>
<p>导入成功<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104113.png" alt=""></p>
<p>现在就能识别_JNIEnv了，如图<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104131.png" alt=""></p>
<h3 id="JNI函数符号hook"><a href="#JNI函数符号hook" class="headerlink" title="JNI函数符号hook"></a>JNI函数符号hook</h3><p>先查看一下导出了哪些函数。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-102552.png" alt=""></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++"</span>;</span><br><span class="line">    LOGD(<span class="string">"sakura1328"</span>);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringWithJNI(JNIEnv *env, jobject instance,</span><br><span class="line">                                                                    jstring context_) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *context = env-&gt;GetStringUTFChars(context_, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> context_size = env-&gt;GetStringUTFLength(context_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"%s\n"</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(context_, context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"sakura1328"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有几个需要的API。</p>
<ul>
<li>首先是找到是否so被加载，通过<code>Process.enumerateModules()</code>,这个API可以枚举被加载到内存的modules。</li>
<li>然后通过<code>Module.findBaseAddress(module name)</code>来查找要hook的函数所在的so的基地址，如果找不到就返回null。</li>
<li>然后可以通过<code>findExportByName(moduleName: string, exportName: string): NativePointer</code>来查找导出函数的绝对地址。如果不知道moduleName是什么，可以传入一个null进入，但是会花费一些时间遍历所有的module。如果找不到就返回null。</li>
<li>找到地址之后，就可以拦截function/instruction的执行。通过<code>Interceptor.attach</code>。使用方法见下代码。</li>
<li>另外为了将jstring的值打印出来，可以使用jenv的函数getStringUtfChars，就像正常的写native程序一样。<br><code>Java.vm.getEnv().getStringUtfChars(args[2], null).readCString()</code></li>
</ul>
<p>这里我是循环调用的string_with_jni，如果不循环调用，那就要主动调用一下这个函数，或者hook dlopen。<br>hook dlopen的方法在<a href="https://github.com/lasting-yang/frida_dump/blob/master/dump_dex.js" target="_blank" rel="noopener">这个代码</a>可以参考。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_native</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(Process.enumerateModules()));</span></span><br><span class="line">    <span class="keyword">var</span> libnative_addr = Module.findBaseAddress(<span class="string">"libnative-lib.so"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"libnative_addr is: "</span> + libnative_addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (libnative_addr) &#123;</span><br><span class="line">        <span class="keyword">var</span> string_with_jni_addr = Module.findExportByName(<span class="string">"libnative-lib.so"</span>, </span><br><span class="line">        <span class="string">"Java_myapplication_example_com_ndk_1demo_MainActivity_stringWithJNI"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"string_with_jni_addr is: "</span> + string_with_jni_addr)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(string_with_jni_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"string_with_jni args: "</span> + args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>])</span><br><span class="line">            <span class="built_in">console</span>.log(Java.vm.getEnv().getStringUtfChars(args[<span class="number">2</span>], <span class="literal">null</span>).readCString())</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"retval:"</span>, retval)</span><br><span class="line">            <span class="built_in">console</span>.log(Java.vm.getEnv().getStringUtfChars(retval, <span class="literal">null</span>).readCString())</span><br><span class="line">            <span class="keyword">var</span> newRetval = Java.vm.getEnv().newStringUtf(<span class="string">"new retval from hook_native"</span>);</span><br><span class="line">            retval.replace(ptr(newRetval));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">libnative_addr is: 0x7a0842f000</span><br><span class="line">string_with_jni_addr is: 0x7a08436194</span><br><span class="line">[Google Pixel::myapplication.example.com.ndk_demo]-&gt; string_with_jni args: 0x7a106cc1c0 0x7ff0b71da4 0x7ff0b71da8</span><br><span class="line">sakura</span><br><span class="line">retval: 0x75</span><br><span class="line">sakura1328</span><br></pre></td></tr></table></figure>
<p>这里还写了一个hook env里的GetStringUTFChars的代码，和上面一样，不赘述了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_art</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> addr_GetStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//console.log( JSON.stringify(Process.enumerateModules()));</span></span><br><span class="line">    <span class="keyword">var</span> symbols = Process.findModuleByName(<span class="string">"libart.so"</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;symbols.length;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i].name;</span><br><span class="line">        <span class="keyword">if</span>((symbol.indexOf(<span class="string">"CheckJNI"</span>)==<span class="number">-1</span>)&amp;&amp;(symbol.indexOf(<span class="string">"JNI"</span>)&gt;=<span class="number">0</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span>(symbol.indexOf(<span class="string">"GetStringUTFChars"</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(symbols[i].name);</span><br><span class="line">                <span class="built_in">console</span>.log(symbols[i].address);</span><br><span class="line">                addr_GetStringUTFChars = symbols[i].address;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"addr_GetStringUTFChars:"</span>, addr_GetStringUTFChars);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        Interceptor.attach(addr_GetStringUTFChars, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"addr_GetStringUTFChars OnEnter args[0],args[1]"</span>,args[<span class="number">0</span>],args[<span class="number">1</span>]);</span><br><span class="line">                <span class="comment">//console.log(hexdump(args[0].readPointer()));</span></span><br><span class="line">                <span class="comment">//console.log(Java.vm.tryGetEnv().getStringUtfChars(args[0]).readCString()); </span></span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"addr_GetStringUTFChars OnLeave"</span>,ptr(retval).readCString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JNI函数参数、返回值打印和替换"><a href="#JNI函数参数、返回值打印和替换" class="headerlink" title="JNI函数参数、返回值打印和替换"></a>JNI函数参数、返回值打印和替换</h3><ul>
<li>libc函数符号hook</li>
<li>libc函数参数、返回值打印和替换<br>hook libc的也和上面的完全一样，也不赘述了。<br>所以看到这里，究其本质就是找到导出符号和它所在的so基地址了。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_libc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = Process.findModuleByName(<span class="string">"libc.so"</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;symbols.length;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i].name;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(symbol.indexOf(<span class="string">"pthread_create"</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//console.log(symbols[i].name);</span></span><br><span class="line">            <span class="comment">//console.log(symbols[i].address);</span></span><br><span class="line">            pthread_create_addr = symbols[i].address;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"pthread_create_addr,"</span>,pthread_create_addr);</span><br><span class="line">    Interceptor.attach(pthread_create_addr,&#123;</span><br><span class="line">        onEnter:<span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"pthread_create_addr args[0],args[1],args[2],args[3]:"</span>,args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>],args[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"retval is:"</span>,retval)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Frida-native-hook-JNI-Onload-动态注册-inline-hook-native层调用栈打印"><a href="#Frida-native-hook-JNI-Onload-动态注册-inline-hook-native层调用栈打印" class="headerlink" title="Frida native hook : JNI_Onload/动态注册/inline_hook/native层调用栈打印"></a>Frida native hook : JNI_Onload/动态注册/inline_hook/native层调用栈打印</h2><p><a href="https://github.com/android/ndk-samples" target="_blank" rel="noopener">https://github.com/android/ndk-samples</a></p>
<h3 id="JNI-Onload-动态注册原理"><a href="#JNI-Onload-动态注册原理" class="headerlink" title="JNI_Onload/动态注册原理"></a>JNI_Onload/动态注册原理</h3><ul>
<li>JNI_Onload/动态注册/Frida hook RegisterNative<ul>
<li><a href="https://zhuanlan.kanxue.com/article-4482.htm" target="_blank" rel="noopener">JNI与动态注册</a></li>
<li><a href="https://eternalsakura13.com/2018/02/08/jni2/">native 方法的动态注册</a></li>
<li><a href="https://github.com/lasting-yang/frida_hook_libart" target="_blank" rel="noopener">Frida hook art</a></li>
</ul>
</li>
</ul>
<p>详细的内容参见我写的文章，这里只给出栗子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Log.d(TAG,stringFromJNI2());</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI2</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">stringFromJNI2</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JNIEnv *env,</span></span></span><br><span class="line"><span class="function"><span class="params">        jclass clazz)</span> </span>&#123;</span><br><span class="line">    jclass testClass = env-&gt;FindClass(<span class="string">"myapplication/example/com/ndk_demo/Test"</span>);</span><br><span class="line">    jfieldID publicStaticField = env-&gt;GetStaticFieldID(testClass, <span class="string">"publicStaticField"</span>,</span><br><span class="line">                                                       <span class="string">"Ljava/lang/String;"</span>);</span><br><span class="line">    jstring publicStaticFieldValue = (jstring) env-&gt;GetStaticObjectField(testClass,</span><br><span class="line">                                                                         publicStaticField);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *value_ptr = env-&gt;GetStringUTFChars(publicStaticFieldValue, <span class="literal">NULL</span>);</span><br><span class="line">    LOGD(<span class="string">"now content is %s"</span>, value_ptr);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++ stringFromJNI2"</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span> </span>&#123;</span><br><span class="line">    JNIEnv *env;</span><br><span class="line">    vm-&gt;GetEnv((<span class="keyword">void</span> **) &amp;env, JNI_VERSION_1_6);</span><br><span class="line">    JNINativeMethod methods[] = &#123;</span><br><span class="line">            &#123;<span class="string">"stringFromJNI2"</span>, <span class="string">"()Ljava/lang/String;"</span>, (<span class="keyword">void</span> *) stringFromJNI2&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    env-&gt;RegisterNatives(env-&gt;FindClass(<span class="string">"myapplication/example/com/ndk_demo/MainActivity"</span>), methods,</span><br><span class="line">                         <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Frida-hook-RegisterNative"><a href="#Frida-hook-RegisterNative" class="headerlink" title="Frida hook RegisterNative"></a>Frida hook RegisterNative</h3><p>使用下面这个脚本来打印出RegisterNatives的参数，这里需要注意的是使用了enumerateSymbolsSync,它是enumerateSymbols的同步版本。<br>另外和我们之前通过<code>Java.vm.tryGetEnv().getStringUtfChars</code>来调用env里的方法不同。<br>这里则是通过将之前找到的getStringUtfChars函数地址和参数信息封装起来，直接调用，具体的原理我没有深入分析，先记住用法。<br>原理其实是一样的，都是<strong>根据符号找到地址，然后hook符号地址，然后打印参数</strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">const</span> NativeFunction: NativeFunctionConstructor;</span><br><span class="line"></span><br><span class="line">interface NativeFunctionConstructor &#123;</span><br><span class="line">    <span class="keyword">new</span>(address: NativePointerValue, <span class="attr">retType</span>: NativeType, <span class="attr">argTypes</span>: NativeType[], abiOrOptions?: NativeABI | NativeFunctionOptions): NativeFunction;</span><br><span class="line">    readonly prototype: NativeFunction;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> funcGetStringUTFChars = <span class="keyword">new</span> NativeFunction(addrGetStringUTFChars, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ishook_libart = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_libart</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ishook_libart === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> symbols = Module.enumerateSymbolsSync(<span class="string">"libart.so"</span>);</span><br><span class="line">    <span class="keyword">var</span> addrGetStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrNewStringUTF = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrFindClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrAllocObject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrCallObjectMethod = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetObjectClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrReleaseStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI17GetStringUTFCharsEP7_JNIEnvP8_jstringPh"</span>) &#123;</span><br><span class="line">            addrGetStringUTFChars = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetStringUTFChars is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI12NewStringUTFEP7_JNIEnvPKc"</span>) &#123;</span><br><span class="line">            addrNewStringUTF = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"NewStringUTF is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI9FindClassEP7_JNIEnvPKc"</span>) &#123;</span><br><span class="line">            addrFindClass = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"FindClass is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI11GetMethodIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetMethodID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetMethodID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI17GetStaticMethodIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetStaticMethodID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetStaticMethodID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI10GetFieldIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetFieldID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetFieldID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI16GetStaticFieldIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetStaticFieldID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetStaticFieldID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi"</span>) &#123;</span><br><span class="line">            addrRegisterNatives = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"RegisterNatives is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI11AllocObjectEP7_JNIEnvP7_jclass"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrAllocObject = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"AllocObject is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI16CallObjectMethodEP7_JNIEnvP8_jobjectP10_jmethodIDz"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrCallObjectMethod = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"CallObjectMethod is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI14GetObjectClassEP7_JNIEnvP8_jobject"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrGetObjectClass = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetObjectClass is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI21ReleaseStringUTFCharsEP7_JNIEnvP8_jstringPKc"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrReleaseStringUTFChars = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"ReleaseStringUTFChars is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        Interceptor.attach(addrRegisterNatives, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"[RegisterNatives] method_count:"</span>, args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">var</span> env = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">var</span> funcAllocObject = <span class="keyword">new</span> NativeFunction(addrAllocObject, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcGetMethodID = <span class="keyword">new</span> NativeFunction(addrGetMethodID, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcCallObjectMethod = <span class="keyword">new</span> NativeFunction(addrCallObjectMethod, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcGetObjectClass = <span class="keyword">new</span> NativeFunction(addrGetObjectClass, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcGetStringUTFChars = <span class="keyword">new</span> NativeFunction(addrGetStringUTFChars, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcReleaseStringUTFChars = <span class="keyword">new</span> NativeFunction(addrReleaseStringUTFChars, <span class="string">"void"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> clz_obj = funcAllocObject(env, java_class);</span><br><span class="line">                <span class="keyword">var</span> mid_getClass = funcGetMethodID(env, java_class, Memory.allocUtf8String(<span class="string">"getClass"</span>), Memory.allocUtf8String(<span class="string">"()Ljava/lang/Class;"</span>));</span><br><span class="line">                <span class="keyword">var</span> clz_obj2 = funcCallObjectMethod(env, clz_obj, mid_getClass);</span><br><span class="line">                <span class="keyword">var</span> cls = funcGetObjectClass(env, clz_obj2);</span><br><span class="line">                <span class="keyword">var</span> mid_getName = funcGetMethodID(env, cls, Memory.allocUtf8String(<span class="string">"getName"</span>), Memory.allocUtf8String(<span class="string">"()Ljava/lang/String;"</span>));</span><br><span class="line">                <span class="keyword">var</span> name_jstring = funcCallObjectMethod(env, clz_obj2, mid_getName);</span><br><span class="line">                <span class="keyword">var</span> name_pchar = funcGetStringUTFChars(env, name_jstring, ptr(<span class="number">0</span>));</span><br><span class="line">                <span class="keyword">var</span> class_name = ptr(name_pchar).readCString();</span><br><span class="line">                funcReleaseStringUTFChars(env, name_jstring, name_pchar);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//console.log(class_name);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> methods_ptr = ptr(args[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">var</span> name_ptr = Memory.readPointer(methods_ptr.add(i * Process.pointerSize * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">var</span> sig_ptr = Memory.readPointer(methods_ptr.add(i * Process.pointerSize * <span class="number">3</span> + Process.pointerSize));</span><br><span class="line">                    <span class="keyword">var</span> fnPtr_ptr = Memory.readPointer(methods_ptr.add(i * Process.pointerSize * <span class="number">3</span> + Process.pointerSize * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> name = Memory.readCString(name_ptr);</span><br><span class="line">                    <span class="keyword">var</span> sig = Memory.readCString(sig_ptr);</span><br><span class="line">                    <span class="keyword">var</span> find_module = Process.findModuleByAddress(fnPtr_ptr);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"[RegisterNatives] java_class:"</span>, class_name, <span class="string">"name:"</span>, name, <span class="string">"sig:"</span>, sig, <span class="string">"fnPtr:"</span>, fnPtr_ptr, <span class="string">"module_name:"</span>, find_module.name, <span class="string">"module_base:"</span>, find_module.base, <span class="string">"offset:"</span>, ptr(fnPtr_ptr).sub(find_module.base));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ishook_libart = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hook_libart();</span><br></pre></td></tr></table></figure>
<p>结果很明显的打印了出来，包括动态注册的函数的名字，函数签名，加载地址和在so里的偏移量，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RegisterNatives] java_class: myapplication.example.com.ndk_demo.MainActivity name: stringFromJNI2 sig: ()Ljava&#x2F;lang&#x2F;String; fnPtr: 0x79f8698484 module_name: libnative-lib.so module_base: 0x79f8691000 offset: 0x7484</span><br></pre></td></tr></table></figure>
<p>最后测试一下yang开源的一个hook art的脚本，很有意思，trace出了非常多的需要的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frida -U --no-pause -f package_name -l hook_art.js</span><br><span class="line">...</span><br><span class="line">[FindClass] name:myapplication&#x2F;example&#x2F;com&#x2F;ndk_demo&#x2F;Test</span><br><span class="line">[GetStaticFieldID] name:publicStaticField, sig:Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">[GetStringUTFChars] result:i am a publicStaticField</span><br><span class="line">[NewStringUTF] bytes:Hello from C++ stringFromJNI2</span><br><span class="line">[GetStringUTFChars] result:sakura</span><br></pre></td></tr></table></figure>

<h3 id="native层调用栈打印"><a href="#native层调用栈打印" class="headerlink" title="native层调用栈打印"></a>native层调用栈打印</h3><p>直接使用frida提供的接口打印栈回溯。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(f, &#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'RegisterNatives called from:\n'</span> +</span><br><span class="line">        Thread.backtrace(<span class="keyword">this</span>.context, Backtracer.ACCURATE)</span><br><span class="line">        .map(DebugSymbol.fromAddress).join(<span class="string">'\n'</span>) + <span class="string">'\n'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>效果如下,我加到了hook registerNative的地方。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Google Pixel::myapplication.example.com.ndk_demo]-&gt; RegisterNatives called from:</span><br><span class="line">0x7a100be03c libart.so!0xe103c</span><br><span class="line">0x7a100be038 libart.so!0xe1038</span><br><span class="line">0x79f85699a0 libnative-lib.so!_ZN7_JNIEnv15RegisterNativesEP7_jclassPK15JNINativeMethodi+0x44</span><br><span class="line">0x79f85698e0 libnative-lib.so!JNI_OnLoad+0x90</span><br><span class="line">0x7a102b9fd4 libart.so!_ZN3art9JavaVMExt17LoadNativeLibraryEP7_JNIEnvRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEP8_jobjectP8_jstringPS9_+0x638</span><br><span class="line">0x7a08e3820c libopenjdkjvm.so!JVM_NativeLoad+0x110</span><br><span class="line">0x70b921c4 boot.oat!oatexec+0xa81c4</span><br></pre></td></tr></table></figure>
<h3 id="主动调用去进行方法参数替换"><a href="#主动调用去进行方法参数替换" class="headerlink" title="主动调用去进行方法参数替换"></a>主动调用去进行方法参数替换</h3><p>使用<code>Interceptor.replace</code>，不赘述。主要目的还是为了改掉函数原本的执行行为，而不是仅仅打印一些信息。</p>
<h3 id="inline-hook"><a href="#inline-hook" class="headerlink" title="inline hook"></a>inline hook</h3><p>inline hook简单理解就是不是hook函数开始执行的地方，而是hook函数中间执行的指令<br>整体来说没什么区别，就是把找函数符号地址改成从so里找到偏移，然后加到so基地址上就行,注意一下它的attach的callback。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Callback to invoke when an instruction is about to be executed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">type InstructionProbeCallback = <span class="function">(<span class="params"><span class="keyword">this</span>: InvocationContext, args: InvocationArguments</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">type InvocationContext = PortableInvocationContext | WindowsInvocationContext | UnixInvocationContext;</span><br><span class="line"></span><br><span class="line">interface PortableInvocationContext &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return address.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    returnAddress: NativePointer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CPU registers. You may also update register values by assigning to these keys.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    context: CpuContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * OS thread ID.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    threadId: ThreadId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Call depth of relative to other invocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    depth: number;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * User-defined invocation data. Useful if you want to read an argument in `onEnter` and act on it in `onLeave`.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    [x: string]: any;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">interface Arm64CpuContext extends PortableCpuContext &#123;</span><br><span class="line">    x0: NativePointer;</span><br><span class="line">    x1: NativePointer;</span><br><span class="line">    x2: NativePointer;</span><br><span class="line">    x3: NativePointer;</span><br><span class="line">    x4: NativePointer;</span><br><span class="line">    x5: NativePointer;</span><br><span class="line">    x6: NativePointer;</span><br><span class="line">    x7: NativePointer;</span><br><span class="line">    x8: NativePointer;</span><br><span class="line">    x9: NativePointer;</span><br><span class="line">    x10: NativePointer;</span><br><span class="line">    x11: NativePointer;</span><br><span class="line">    x12: NativePointer;</span><br><span class="line">    x13: NativePointer;</span><br><span class="line">    x14: NativePointer;</span><br><span class="line">    x15: NativePointer;</span><br><span class="line">    x16: NativePointer;</span><br><span class="line">    x17: NativePointer;</span><br><span class="line">    x18: NativePointer;</span><br><span class="line">    x19: NativePointer;</span><br><span class="line">    x20: NativePointer;</span><br><span class="line">    x21: NativePointer;</span><br><span class="line">    x22: NativePointer;</span><br><span class="line">    x23: NativePointer;</span><br><span class="line">    x24: NativePointer;</span><br><span class="line">    x25: NativePointer;</span><br><span class="line">    x26: NativePointer;</span><br><span class="line">    x27: NativePointer;</span><br><span class="line">    x28: NativePointer;</span><br><span class="line"></span><br><span class="line">    fp: NativePointer;</span><br><span class="line">    lr: NativePointer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我的so是自己编译的，具体的汇编代码如下,总之这里很明显在775C时，x0里保存的是一个指向”sakura”这个字符串的指针。(其实我也不是很看得懂arm64了已经，就随便hook了一下)<br>所以hook这个指令，然后<code>Memory.readCString(this.context.x0);</code>打印出来，结果如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000772</span>C ; __unwind &#123;</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000772</span>C                 SUB             SP, SP, #<span class="number">0x40</span></span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007730</span>                 STP             X29, X30, [SP,#<span class="number">0x30</span>+var_s0]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007734</span>                 ADD             X29, SP, #<span class="number">0x30</span></span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007738</span> ; <span class="number">6</span>:   v6 = a1;</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007738</span>                 MOV             X8, XZR</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000773</span>C                 STUR            X0, [X29,#var_8]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007740</span> ; <span class="number">7</span>:   v5 = a3;</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007740</span>                 STUR            X1, [X29,#var_10]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007744</span>                 STR             X2, [SP,#<span class="number">0x30</span>+var_18]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007748</span> ; <span class="number">8</span>:   v4 = (<span class="keyword">const</span> <span class="keyword">char</span> *)_JNIEnv::GetStringUTFChars(a1, a3, <span class="number">0L</span>L);</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007748</span>                 LDUR            X0, [X29,#var_8]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000774</span>C                 LDR             X1, [SP,#<span class="number">0x30</span>+var_18]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007750</span>                 MOV             X2, X8</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007754</span>                 BL              ._ZN7_JNIEnv17GetStringUTFCharsEP8_jstringPh ; _JNIEnv::GetStringUTFChars(_jstring *,uchar *)</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007758</span>                 STR             X0, [SP,#<span class="number">0x30</span>+var_20]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000775</span>C ; <span class="number">9</span>:   <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)_JNIEnv::GetStringUTFLength(v6, v5) &gt; <span class="number">0</span> )</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000775</span>C                 LDUR            X0, [X29,#var_8]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007760</span>                 LDR             X1, [SP,#<span class="number">0x30</span>+var_18]</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inline_hook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libnative_lib_addr = Module.findBaseAddress(<span class="string">"libnative-lib.so"</span>);</span><br><span class="line">    <span class="keyword">if</span> (libnative_lib_addr) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"libnative_lib_addr:"</span>, libnative_lib_addr);</span><br><span class="line">        <span class="keyword">var</span> addr_775C = libnative_lib_addr.add(<span class="number">0x775C</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"addr_775C:"</span>, addr_775C);</span><br><span class="line"></span><br><span class="line">        Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            Interceptor.attach(addr_775C, &#123;</span><br><span class="line">                onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> name = <span class="keyword">this</span>.context.x0.readCString()</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"addr_775C OnEnter :"</span>, <span class="keyword">this</span>.returnAddress, name);</span><br><span class="line">                &#125;,</span><br><span class="line">                onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">"retval is :"</span>, retval) </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(inline_hook())</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Attaching...                                                            </span><br><span class="line">libnative_lib_addr: 0x79fabe0000</span><br><span class="line">addr_775C: 0x79fabe775c</span><br><span class="line">TypeError: cannot read property &#39;apply&#39; of undefined</span><br><span class="line">    at [anon] (..&#x2F;..&#x2F;..&#x2F;frida-gum&#x2F;bindings&#x2F;gumjs&#x2F;duktape.c:56618)</span><br><span class="line">    at frida&#x2F;runtime&#x2F;core.js:55</span><br><span class="line">[Google Pixel::myapplication.example.com.ndk_demo]-&gt; addr_775C OnEnter : 0x79fabe7758 sakura</span><br><span class="line">addr_775C OnEnter : 0x79fabe7758 sakura</span><br></pre></td></tr></table></figure>

<p>到这里已经可以总结一下我目前的学习了，需要补充一些frida api的学习，比如NativePointr里居然有个readCString，这些API是需要再看看的。</p>
<h2 id="Frida-native-hook-Frida-hook-native-app实战"><a href="#Frida-native-hook-Frida-hook-native-app实战" class="headerlink" title="Frida native hook : Frida hook native app实战"></a>Frida native hook : Frida hook native app实战</h2><ul>
<li>破解Frida全端口检测的native层反调试<ul>
<li>hook libc的pthread_create函数</li>
</ul>
</li>
<li>破解TracePid的native反调试<ul>
<li>target: <a href="https://gtoad.github.io/2017/06/25/Android-Anti-Debug/" target="_blank" rel="noopener">https://gtoad.github.io/2017/06/25/Android-Anti-Debug/</a></li>
<li>solve : hook libc的fgets函数</li>
</ul>
</li>
<li>native层修改参数、返回值</li>
<li>静态分析<code>JNI_Onload</code></li>
<li>动态trace主动注册 &amp; IDA溯源</li>
<li>动态trace JNI、libc函数 &amp; IDA溯源</li>
<li>native层主动调用、打调用栈</li>
<li>主动调用libc读写文件</li>
</ul>
<p>看下logcat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">n&#x2F;u0a128 for activity com.gdufs.xman&#x2F;.MainActivity</span><br><span class="line">12-28 05:53:26.898 26615 26615 V com.gdufs.xman: JNI_OnLoad()</span><br><span class="line">12-28 05:53:26.898 26615 26615 V com.gdufs.xman: RegisterNatives() --&gt; nativeMethod() ok</span><br><span class="line">12-28 05:53:26.898 26615 26615 D com.gdufs.xman m&#x3D;: 0</span><br><span class="line">12-28 05:53:26.980 26615 26615 D com.gdufs.xman m&#x3D;: Xman</span><br></pre></td></tr></table></figure>

<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101517.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101821.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101843.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;gitsource&#x2F;frida-agent-example&#x2F;agent$ frida -U --no-pause -f com.gdufs.xman -l hook_reg.js</span><br><span class="line">...</span><br><span class="line">[Google Pixel::com.gdufs.xman]-&gt; [RegisterNatives] method_count: 0x3</span><br><span class="line">[RegisterNatives] java_class: com.gdufs.xman.MyApp name: initSN sig: ()V fnPtr: 0xd4ddf3b1 module_name: libmyjni.so module_base: 0xd4dde000 offset: 0x13b1</span><br><span class="line">[RegisterNatives] java_class: com.gdufs.xman.MyApp name: saveSN sig: (Ljava&#x2F;lang&#x2F;String;)V fnPtr: 0xd4ddf1f9 module_name: libmyjni.so module_base: 0xd4dde000 offset: 0x11f9</span><br><span class="line">[RegisterNatives] java_class: com.gdufs.xman.MyApp name: work sig: ()V fnPtr: 0xd4ddf4cd module_name: libmyjni.so module_base: 0xd4dde000 offset: 0x14cd</span><br></pre></td></tr></table></figure>
<ul>
<li>initSN<br>感觉意思应该是从<code>/sdcard/reg.dat</code>里读一个值，然后和<code>EoPAoY62@ElRD</code>进行比较。<br>最后setValue，从导出函数看一下，最后推测第一个参数应该是JNIEnv *env，然后就看到了给字段m赋值。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-121051.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-102944.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-102844.png" alt=""></li>
<li>saveSN<br>这个看上去就是根据str的值，去变换”W3_arE_whO_we_ARE”字符串，然后写入到<code>/sdcard/reg.dat</code>里<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-112221.png" alt=""></li>
</ul>
<p>结合一下看，只要initSN检查到<code>/sdcard/reg.dat</code>里是<code>EoPAoY62@ElRD</code>，应该就会给m设置成1。<br>只要m的值是1，就能走到work()函数的逻辑。</p>
<p>参考<a href="https://frida.re/docs/javascript-api/#file" target="_blank" rel="noopener">frida的file api</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="keyword">new</span> File(<span class="string">"/sdcard/reg.dat"</span>,<span class="string">'w'</span>)</span><br><span class="line">    file.write(<span class="string">"EoPAoY62@ElRD"</span>)</span><br><span class="line">    file.flush()</span><br><span class="line">    file.close()</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main())</span><br></pre></td></tr></table></figure>

<p>这样我们继续看work的逻辑<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-120940.png" alt=""></p>
<p>v2是从getValue得到的，看上去就是m字段的值，此时应该是1，一会hook一下看看。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-121012.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NewStringUTF] bytes:输入即是flag,格式为xman&#123;……&#125;！</span><br></pre></td></tr></table></figure>
<p>callWork里又调用了work函数，死循环了。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-120907.png" alt=""></p>
<p>那看来看去最后还是回到了initSN，那其实我们看的顺序似乎错了。<br>理一下逻辑，n2执行完保存到文件，然后n1 check一下，所以最后还是要逆n2的算法，pass。</p>
<h2 id="Frida-trace四件套"><a href="#Frida-trace四件套" class="headerlink" title="Frida trace四件套"></a>Frida trace四件套</h2><h3 id="jni-trace-trace-jni"><a href="#jni-trace-trace-jni" class="headerlink" title="jni trace : trace jni"></a>jni trace : trace jni</h3><p><a href="https://github.com/chame1eon/jnitrace" target="_blank" rel="noopener">https://github.com/chame1eon/jnitrace</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pip install jnitrace</span><br><span class="line"></span><br><span class="line">Requirement already satisfied: frida&gt;&#x3D;12.5.0 in &#x2F;Users&#x2F;sakura&#x2F;.pyenv&#x2F;versions&#x2F;3.7.7&#x2F;lib&#x2F;python3.7&#x2F;site-packages (from jnitrace) (12.8.0)</span><br><span class="line">Requirement already satisfied: colorama in &#x2F;Users&#x2F;sakura&#x2F;.pyenv&#x2F;versions&#x2F;3.7.7&#x2F;lib&#x2F;python3.7&#x2F;site-packages (from jnitrace) (0.4.3)</span><br><span class="line">Collecting hexdump (from jnitrace)</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;55&#x2F;b3&#x2F;279b1d57fa3681725d0db8820405cdcb4e62a9239c205e4ceac4391c78e4&#x2F;hexdump-3.3.zip</span><br><span class="line">Installing collected packages: hexdump, jnitrace</span><br><span class="line">  Running setup.py install for hexdump ... done</span><br><span class="line">  Running setup.py install for jnitrace ... done</span><br><span class="line">Successfully installed hexdump-3.3 jnitrace-3.0.8</span><br></pre></td></tr></table></figure>

<p>usage: <code>jnitrace [options] -l libname target</code><br>默认应该是spawn运行的，</p>
<ul>
<li><code>-m</code>来指定是<code>spawn</code>还是<code>attach</code></li>
<li><code>-b</code>指定是<code>fuzzy</code>还是<code>accurate</code></li>
<li><code>-i &lt;regex&gt;</code>指定一个正则表达式来过滤出方法名，例如<code>-i Get -i RegisterNatives</code>就会只打印出名字里包含Get或者RegisterNatives的JNI methods。</li>
<li><code>-e &lt;regex&gt;</code>和<code>-i</code>相反，同样通过正则表达式来过滤，但这次会将指定的内容忽略掉。</li>
<li><code>-I &lt;string&gt;</code>trace导出的方法，jnitrace认为导出的函数应该是从Java端能够直接调用的函数，所以可以包括使用RegisterNatives来注册的函数，例如<code>-I stringFromJNI -I nativeMethod([B)V</code>，就包括导出名里有stringFromJNI，以及使用RegisterNames来注册，并带有nativeMethod([B)V签名的函数。</li>
<li><code>-o path/output.json</code>，导出输出到文件里。</li>
<li><code>-p path/to/script.js</code>，用于在加载jnitrace脚本之前将指定路径的Frida脚本加载到目标进程中，这可以用于在jnitrace启动之前对抗反调试。</li>
<li><code>-a path/to/script.js</code>，用于在加载jnitrace脚本之后将指定路径的Frida脚本加载到目标进程中</li>
<li><code>--ignore-env</code>，不打印所有的JNIEnv函数</li>
<li><code>--ignore-vm</code>，不打印所有的JavaVM函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn&#x2F;0620&#x2F;0620&#x2F;xman&#x2F;resources&#x2F;lib&#x2F;armeabi-v7a$ jnitrace -l libmyjni.so com.gdufs.xman</span><br><span class="line">Tracing. Press any key to quit...</span><br><span class="line">Traced library &quot;libmyjni.so&quot; loaded from path &quot;&#x2F;data&#x2F;app&#x2F;com.gdufs.xman-X0HkzLhbptSc0tjGZ3yQ2g&#x3D;&#x3D;&#x2F;lib&#x2F;arm&quot;.</span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    355 ms [+] JavaVM-&gt;GetEnv</span><br><span class="line">    355 ms |- JavaVM*          : 0xefe99140</span><br><span class="line">    355 ms |- void**           : 0xda13e028</span><br><span class="line">    355 ms |:     0xeff312a0</span><br><span class="line">    355 ms |- jint             : 65542</span><br><span class="line">    355 ms |&#x3D; jint             : 0</span><br><span class="line"></span><br><span class="line">    355 ms ------------------------Backtrace------------------------</span><br><span class="line">    355 ms |-&gt; 0xda13a51b: JNI_OnLoad+0x12 (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    529 ms [+] JNIEnv-&gt;FindClass</span><br><span class="line">    529 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    529 ms |- char*            : 0xda13bdef</span><br><span class="line">    529 ms |:     com&#x2F;gdufs&#x2F;xman&#x2F;MyApp</span><br><span class="line">    529 ms |&#x3D; jclass           : 0x81    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line"></span><br><span class="line">    529 ms ------------------------Backtrace------------------------</span><br><span class="line">    529 ms |-&gt; 0xda13a539: JNI_OnLoad+0x30 (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    584 ms [+] JNIEnv-&gt;RegisterNatives</span><br><span class="line">    584 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    584 ms |- jclass           : 0x81    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line">    584 ms |- JNINativeMethod* : 0xda13e004</span><br><span class="line">    584 ms |:     0xda13a3b1 - initSN()V</span><br><span class="line">    584 ms |:     0xda13a1f9 - saveSN(Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    584 ms |:     0xda13a4cd - work()V</span><br><span class="line">    584 ms |- jint             : 3</span><br><span class="line">    584 ms |&#x3D; jint             : 0</span><br><span class="line"></span><br><span class="line">    584 ms ------------------------Backtrace------------------------</span><br><span class="line">    584 ms |-&gt; 0xda13a553: JNI_OnLoad+0x4a (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    638 ms [+] JNIEnv-&gt;FindClass</span><br><span class="line">    638 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    638 ms |- char*            : 0xda13bdef</span><br><span class="line">    638 ms |:     com&#x2F;gdufs&#x2F;xman&#x2F;MyApp</span><br><span class="line">    638 ms |&#x3D; jclass           : 0x71    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line"></span><br><span class="line">    638 ms -----------------------Backtrace-----------------------</span><br><span class="line">    638 ms |-&gt; 0xda13a377: setValue+0x12 (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    688 ms [+] JNIEnv-&gt;GetStaticFieldID</span><br><span class="line">    688 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    688 ms |- jclass           : 0x71    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line">    688 ms |- char*            : 0xda13be04</span><br><span class="line">    688 ms |:     m</span><br><span class="line">    688 ms |- char*            : 0xda13be06</span><br><span class="line">    688 ms |:     I</span><br><span class="line">    688 ms |&#x3D; jfieldID         : 0xf1165004    &#123; m:I &#125;</span><br><span class="line"></span><br><span class="line">    688 ms -----------------------Backtrace-----------------------</span><br><span class="line">    688 ms |-&gt; 0xda13a38d: setValue+0x28 (libmyjni.so:0xda139000)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="strace-trace-syscall"><a href="#strace-trace-syscall" class="headerlink" title="strace : trace syscall"></a>strace : trace syscall</h3><p><a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/strace.html" target="_blank" rel="noopener">https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/strace.html</a></p>
<h3 id="frida-trace-trace-libc-or-more"><a href="#frida-trace-trace-libc-or-more" class="headerlink" title="frida-trace : trace libc(or more)"></a>frida-trace : trace libc(or more)</h3><p><a href="https://frida.re/docs/frida-trace/" target="_blank" rel="noopener">https://frida.re/docs/frida-trace/</a></p>
<p>Usage:<code>frida-trace [options] target</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -i &quot;strcmp&quot; -f com.gdufs.xman</span><br><span class="line">...</span><br><span class="line">  5634 ms  strcmp(s1&#x3D;&quot;fi&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;da&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;es&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;eu-ES&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;et-EE&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;et-EE&quot;, s2&#x3D;&quot;es-US&quot;)</span><br></pre></td></tr></table></figure>

<ul>
<li>art trace: <a href="https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_artmethod.js" target="_blank" rel="noopener">hook artmethod</a></li>
</ul>
<h3 id="hook-artmethod-trace-java函数调用"><a href="#hook-artmethod-trace-java函数调用" class="headerlink" title="hook_artmethod : trace java函数调用"></a>hook_artmethod : trace java函数调用</h3><p><a href="https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_artmethod.js" target="_blank" rel="noopener">https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_artmethod.js</a></p>
<h3 id="修改AOSP源码打印"><a href="#修改AOSP源码打印" class="headerlink" title="修改AOSP源码打印"></a>修改AOSP源码打印</h3><p><a href="https://bbs.pediy.com/thread-255653-1.htm" target="_blank" rel="noopener">改aosp源码trace信息</a></p>
<h2 id="Frida-native-hook-init-array开发和自动化逆向"><a href="#Frida-native-hook-init-array开发和自动化逆向" class="headerlink" title="Frida native hook : init_array开发和自动化逆向"></a>Frida native hook : init_array开发和自动化逆向</h2><h3 id="init-array原理"><a href="#init-array原理" class="headerlink" title="init_array原理"></a>init_array原理</h3><p>常见的保护都会在init_array里面做，关于其原理，主要阅读以下文章即可。</p>
<ul>
<li><a href="https://www.cnblogs.com/bingghost/p/6297325.html" target="_blank" rel="noopener">IDA调试android so的.init_array数组</a></li>
<li><a href="https://www.dllhook.com/post/213.html" target="_blank" rel="noopener">Android NDK中.init段和.init_array段函数的定义方式</a></li>
<li><a href="https://wooyun.js.org/drops/Android%20Linker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html" target="_blank" rel="noopener">Linker学习笔记</a></li>
</ul>
<h3 id="IDA静态分析init-array"><a href="#IDA静态分析init-array" class="headerlink" title="IDA静态分析init_array"></a>IDA静态分析init_array</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译生成后在.init段 [名字不可更改]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">void</span> _init(<span class="keyword">void</span>) &#123;</span><br><span class="line">    LOGD(<span class="string">"Enter init......"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译生成后在.init_array段 [名字可以更改]</span></span><br><span class="line">__attribute__((__constructor__)) <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sakura_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LOGD(<span class="string">"Enter sakura_init......"</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">2016</span><span class="number">-12</span><span class="number">-29</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">23.017</span> <span class="number">5160</span><span class="number">-5160</span>/com.example.ndk_demo D/sakura1328: Enter init......</span><br><span class="line"><span class="number">2016</span><span class="number">-12</span><span class="number">-29</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">23.017</span> <span class="number">5160</span><span class="number">-5160</span>/com.example.ndk_demo D/sakura1328: Enter sakura_init......</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161438.png" alt=""><br>IDA快捷键<code>shift+F7</code>找到segment，然后就可以找到<code>.init_array</code>段，然后就可以找到里面保存的函数地址。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161519.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161601.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161613.png" alt=""></p>
<h3 id="IDA动态调试so"><a href="#IDA动态调试so" class="headerlink" title="IDA动态调试so"></a>IDA动态调试so</h3><ul>
<li><p>打开要调试的apk，找到入口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;.gradle&#x2F;caches$ adb shell dumpsys activity top | grep TASK</span><br><span class="line">TASK com.android.systemui id&#x3D;29 userId&#x3D;0</span><br><span class="line">TASK null id&#x3D;26 userId&#x3D;0</span><br><span class="line">TASK com.example.ndk_demo id&#x3D;161 userId&#x3D;0</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动apk,并让设备将处于一个Waiting For Debugger的状态<br><code>adb shell am start -D -n com.example.ndk_demo/.MainActivity</code></p>
</li>
<li><p>执行android_server64</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sailfish:&#x2F;data&#x2F;local&#x2F;tmp # .&#x2F;android_server64</span><br><span class="line">IDA Android 64-bit remote debug server(ST) v1.22. Hex-Rays (c) 2004-2017</span><br><span class="line">Listening on 0.0.0.0:23946...</span><br></pre></td></tr></table></figure>
</li>
<li><p>新开一个窗口使用forward程序进行端口转发：<code>adb forward tcp:23946 tcp:23946</code></p>
</li>
</ul>
<p><code>adb  forward  tcp:&lt;本地机器的网络端口号&gt;  tcp:&lt;模拟器或是真机的网络端口号&gt;</code><br>例:adb [-d|-e|-s <serialNumber>] forward tcp:6100 tcp:7100 表示把本机的6100端口号与模拟器的7100端口建立起相关，当模拟器或真机向自己的7100端口发送了数据，那们我们可以在本机的6100端口读取其发送的内容，这是一个很关键的命令，以后我们使用jdb调试apk之前，就要用它先把目标进程和本地端口建立起关联</p>
<ul>
<li><p>打开IDA，选择菜单Debugger -&gt; Attach -&gt; Remote ARM Linux/Android debugger</p>
</li>
<li><p>打开IDA，选择菜单Debugger -&gt; Process options, 填好，然后选择进程去attach。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-082029.png" alt=""></p>
</li>
<li><p>查看待调试的进程<code>adb jdwp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ adb jdwp</span><br><span class="line">10436</span><br></pre></td></tr></table></figure>
</li>
<li><p>转发端口<code>adb forward tcp:8700 jdwp:10436</code>，将该进程的调试端口和本机的8700绑定。</p>
</li>
<li><p>jdb连接调试端口，从而让程序继续运行 <code>jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700</code></p>
</li>
<li><p>找到断点并断下。</p>
</li>
</ul>
<p>打开module<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-095937.png" alt=""><br>找到linker64<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-095955.png" alt=""><br>找到call array函数<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-100022.png" alt=""><br>下断并按F9断下<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-100042.png" alt=""></p>
<p>最终我确实可以调试到<code>.init_array</code>的初始化，具体的代码分析见<a href="https://wooyun.js.org/drops/Android%20Linker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html" target="_blank" rel="noopener">Linker学习笔记</a>这里。</p>
<h3 id="init-array-amp-amp-JNI-Onload-“自吐”"><a href="#init-array-amp-amp-JNI-Onload-“自吐”" class="headerlink" title="init_array &amp;&amp; JNI_Onload “自吐”"></a>init_array &amp;&amp; JNI_Onload “自吐”</h3><h4 id="JNI-Onload"><a href="#JNI-Onload" class="headerlink" title="JNI_Onload"></a>JNI_Onload</h4><p>目标是找到动态注册的函数的地址，因为这种函数没有导出。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JNINativeMethod methods[] = &#123;</span><br><span class="line">            &#123;<span class="string">"stringFromJNI2"</span>, <span class="string">"()Ljava/lang/String;"</span>, (<span class="keyword">void</span> *) stringFromJNI2&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    env-&gt;RegisterNatives(env-&gt;FindClass(<span class="string">"com/example/ndk_demo/MainActivity"</span>), methods,</span><br><span class="line">                         <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>首先<code>jnitrace -m spawn -i &quot;RegisterNatives&quot; -l libnative-lib.so com.example.ndk_demo</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">525 ms [+] JNIEnv-&gt;RegisterNatives</span><br><span class="line">525 ms |- JNIEnv*          : 0x7a106cc1c0</span><br><span class="line">525 ms |- jclass           : 0x89    &#123; com&#x2F;example&#x2F;ndk_demo&#x2F;MainActivity &#125;</span><br><span class="line">525 ms |- JNINativeMethod* : 0x7ff0b71120</span><br><span class="line">525 ms |:     0x79f00d36b0 - stringFromJNI2()Ljava&#x2F;lang&#x2F;String;</span><br></pre></td></tr></table></figure>
<p>然后<code>objection -d -g com.example.ndk_demo run memory list modules explore | grep demo</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -d -g com.example.ndk_demo run memory list modules explore | grep demo</span><br><span class="line">[debug] Attempting to attach to process: &#96;com.example.ndk_demo&#96;</span><br><span class="line">Warning: Output is not to a terminal (fd&#x3D;1).</span><br><span class="line">base.odex                                        0x79f0249000  106496 (104.0 KiB)    &#x2F;data&#x2F;app&#x2F;com.example.ndk_demo-HGAFhnKyKCSIpzn227pwXw&#x3D;&#x3D;&#x2F;oat&#x2F;arm64&#x2F;base.odex</span><br><span class="line">libnative-lib.so                                 0x79f00c4000  221184 (216.0 KiB)    &#x2F;data&#x2F;app&#x2F;com.example.ndk_demo-HGAFhnKyKCSIpzn227pwXw&#x3D;&#x3D;&#x2F;lib&#x2F;arm64&#x2F;libnative...</span><br></pre></td></tr></table></figure>
<p>offset = 0x79f00d36b0 - 0x79f00c4000 = 0xf6b0</p>
<p>这样就找到了<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-122151.png" alt=""></p>
<h4 id="init-array"><a href="#init-array" class="headerlink" title="init_array"></a>init_array</h4><p>没有支持arm64，可以在安装app的时候<code>adb install --abi armeabi-v7a</code>强制让app运行在32位模式</p>
<p>这个脚本整体来说就是hook callfunction，然后打印出init_array里面的函数地址和参数等。</p>
<p>从源码看，关键就是call_array这里调用的call_function，第一个参数代表这是注册的init_array里面的function，第二个参数则是init_array里存储的函数的地址。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_array</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* array_name __unused,</span></span></span><br><span class="line"><span class="function"><span class="params">                       F* functions,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">size_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">bool</span> reverse,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">const</span> <span class="keyword">char</span>* realpath)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (functions == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  TRACE(<span class="string">"[ Calling %s (size %zd) @ %p for '%s' ]"</span>, array_name, count, functions, realpath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">begin</span> = reverse ? (count - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">end</span> = reverse ? <span class="number">-1</span> : count;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">step</span> = reverse ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="built_in">begin</span>; i != <span class="built_in">end</span>; i += <span class="built_in">step</span>) &#123;</span><br><span class="line">    TRACE(<span class="string">"[ %s[%d] == %p ]"</span>, array_name, i, functions[i]);</span><br><span class="line">    call_function(<span class="string">"function"</span>, functions[i], realpath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  TRACE(<span class="string">"[ Done calling %s for '%s' ]"</span>, array_name, realpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds()</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">"0"</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">"0"</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">"0"</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">"00"</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">"0"</span> + mSecond : mSecond;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">":"</span> + minute + <span class="string">":"</span> + second + <span class="string">":"</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"["</span> + time + <span class="string">"]"</span> + <span class="string">"-&gt;threadid:"</span> + threadid + <span class="string">"--"</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooklinker</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> linkername = <span class="string">"linker"</span>;</span><br><span class="line">    <span class="keyword">var</span> call_function_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> arch = Process.arch;</span><br><span class="line">    LogPrint(<span class="string">"Process run in:"</span> + arch);</span><br><span class="line">    <span class="keyword">if</span> (arch.endsWith(<span class="string">"arm"</span>)) &#123;</span><br><span class="line">        linkername = <span class="string">"linker"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        linkername = <span class="string">"linker64"</span>;</span><br><span class="line">        LogPrint(<span class="string">"arm64 is not supported yet!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> symbols = Module.enumerateSymbolsSync(linkername);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="comment">//LogPrint(linkername + "-&gt;" + symbol.name + "---" + symbol.address);</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"__dl__ZL13call_functionPKcPFviPPcS2_ES0_"</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">            call_function_addr = symbol.address;</span><br><span class="line">            LogPrint(<span class="string">"linker-&gt;"</span> + symbol.name + <span class="string">"---"</span> + symbol.address)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (call_function_addr != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> func_call_function = <span class="keyword">new</span> NativeFunction(call_function_addr, <span class="string">'void'</span>, [<span class="string">'pointer'</span>, <span class="string">'pointer'</span>, <span class="string">'pointer'</span>]);</span><br><span class="line">        Interceptor.replace(<span class="keyword">new</span> NativeFunction(call_function_addr,</span><br><span class="line">            <span class="string">'void'</span>, [<span class="string">'pointer'</span>, <span class="string">'pointer'</span>, <span class="string">'pointer'</span>]), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1, arg2</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> functiontype = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> functionaddr = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> sopath = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (arg0 != <span class="literal">null</span>) &#123;</span><br><span class="line">                functiontype = Memory.readCString(arg0);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (arg1 != <span class="literal">null</span>) &#123;</span><br><span class="line">                functionaddr = arg1;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (arg2 != <span class="literal">null</span>) &#123;</span><br><span class="line">                sopath = Memory.readCString(arg2);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> modulebaseaddr = Module.findBaseAddress(sopath);</span><br><span class="line">            LogPrint(<span class="string">"after load:"</span> + sopath + <span class="string">"--start call_function,type:"</span> + functiontype + <span class="string">"--addr:"</span> + functionaddr + <span class="string">"---baseaddr:"</span> + modulebaseaddr);</span><br><span class="line">            <span class="keyword">if</span> (sopath.indexOf(<span class="string">'libnative-lib.so'</span>) &gt;= <span class="number">0</span> &amp;&amp; functiontype == <span class="string">"DT_INIT"</span>) &#123;</span><br><span class="line">                LogPrint(<span class="string">"after load:"</span> + sopath + <span class="string">"--ignore call_function,type:"</span> + functiontype + <span class="string">"--addr:"</span> + functionaddr + <span class="string">"---baseaddr:"</span> + modulebaseaddr);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                func_call_function(arg0, arg1, arg2);</span><br><span class="line">                LogPrint(<span class="string">"after load:"</span> + sopath + <span class="string">"--end call_function,type:"</span> + functiontype + <span class="string">"--addr:"</span> + functionaddr + <span class="string">"---baseaddr:"</span> + modulebaseaddr);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="string">'void'</span>, [<span class="string">'pointer'</span>, <span class="string">'pointer'</span>, <span class="string">'pointer'</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(hooklinker)</span><br></pre></td></tr></table></figure>
<p>我调试了一下linker64，因为没有导出call_function的地址，所以不能直接hook符号名，而是要根据偏移去hook，以后再说。<br>其实要看<code>init_array</code>，直接shift+F7去segment里面找<code>.init_array</code>段就可以了，这里主要是为了反反调试，因为可能反调试会加在init_array里，hook call_function就可以让它不加载反调试程序。</p>
<h3 id="native层未导出函数主动调用（任意符号和地址）"><a href="#native层未导出函数主动调用（任意符号和地址）" class="headerlink" title="native层未导出函数主动调用（任意符号和地址）"></a>native层未导出函数主动调用（任意符号和地址）</h3><p>现在我想要主动调用sakura_add来打印值,可以ida打开找符号，或者根据偏移，总之最终用这个NativePointer指针来初始化一个NativeFunction来调用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_com_example_ndk_1demo_MainActivity_sakuraWithInt(JNIEnv *env, jobject thiz, jint a, jint b) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement sakuraWithInt()</span></span><br><span class="line">    <span class="keyword">return</span> sakura_add(a,b);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sakura_add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = a+b;</span><br><span class="line">    LOGD(<span class="string">"sakura add a+b:"</span>,sum);</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-142324.png" alt=""></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libnative_lib_addr = Module.findBaseAddress(<span class="string">"libnative-lib.so"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"libnative_lib_addr is :"</span>, libnative_lib_addr);</span><br><span class="line">    <span class="keyword">if</span> (libnative_lib_addr) &#123;</span><br><span class="line">        <span class="keyword">var</span> sakura_add_addr1 = Module.findExportByName(<span class="string">"libnative-lib.so"</span>, <span class="string">"_Z10sakura_addii"</span>);</span><br><span class="line">        <span class="keyword">var</span> sakura_add_addr2 = libnative_lib_addr.add(<span class="number">0x0F56C</span>) ;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"sakura_add_addr1 "</span>, sakura_add_addr1);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"sakura_add_addr2 "</span>, sakura_add_addr2)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sakura_add1 = <span class="keyword">new</span> NativeFunction(sakura_add_addr1, <span class="string">"int"</span>, [<span class="string">"int"</span>, <span class="string">"int"</span>]);</span><br><span class="line">    <span class="keyword">var</span> sakura_add2 = <span class="keyword">new</span> NativeFunction(sakura_add_addr2, <span class="string">"int"</span>, [<span class="string">"int"</span>, <span class="string">"int"</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"sakura_add1 result is :"</span>, sakura_add1(<span class="number">200</span>, <span class="number">33</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"sakura_add2 result is :"</span>, sakura_add2(<span class="number">100</span>, <span class="number">133</span>));</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main())</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">libnative_lib_addr is : <span class="number">0x79fa1c5000</span></span><br><span class="line">sakura_add_addr1  <span class="number">0x79fa1d456c</span></span><br><span class="line">sakura_add_addr2  <span class="number">0x79fa1d456c</span></span><br><span class="line">sakura_add1 result is : <span class="number">233</span></span><br><span class="line">sakura_add2 result is : <span class="number">233</span></span><br></pre></td></tr></table></figure>

<h2 id="C-C-hook"><a href="#C-C-hook" class="headerlink" title="C/C++ hook"></a>C/C++ hook</h2><p>//todo</p>
<h3 id="Native-JNI层参数打印和主动调用参数构造"><a href="#Native-JNI层参数打印和主动调用参数构造" class="headerlink" title="Native/JNI层参数打印和主动调用参数构造"></a>Native/JNI层参数打印和主动调用参数构造</h3><p>jni的基本类型要通过调用jni相关的api转化成c++对象，才能打印和调用。<br>jni主动调用的时候，参数构造有两种方式，一种是<code>Java.vm.getenv</code>，另一种是hook获取env之后来调用jni相关的api构造参数。</p>
<h3 id="C-C-编成so并引入Frida调用其中的函数"><a href="#C-C-编成so并引入Frida调用其中的函数" class="headerlink" title="C/C++编成so并引入Frida调用其中的函数"></a>C/C++编成so并引入Frida调用其中的函数</h3>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/frida/" rel="tag"># frida</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/27/flex/" rel="next" title="Flex中文文档">
                <i class="fa fa-chevron-left"></i> Flex中文文档
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/06/cscd/" rel="prev" title="cscd">
                cscd <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/sakura_heart.png"
                alt="sakura" />
            
              <p class="site-author-name" itemprop="name">sakura</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">106</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/eternalsakura" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:eternalsakura13@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/sakura1328/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/eternalsakura13" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://exp101t.blogspot.com/" title="Murasaki" target="_blank">Murasaki</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://elphet.blogspot.com" title="bobb" target="_blank">bobb</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://thunderjie.github.io/" title="Thunderj" target="_blank">Thunderj</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://dwfault.github.io/" title="dwfalut" target="_blank">dwfalut</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://p1umer.github.io/" title="P1umer" target="_blank">P1umer</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://pcat.cc/" title="pcat" target="_blank">pcat</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#致谢"><span class="nav-number">1.</span> <span class="nav-text">致谢</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida环境"><span class="nav-number">2.</span> <span class="nav-text">Frida环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pyenv"><span class="nav-number">2.1.</span> <span class="nav-text">pyenv</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida安装"><span class="nav-number">2.2.</span> <span class="nav-text">frida安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装objection"><span class="nav-number">2.3.</span> <span class="nav-text">安装objection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida使用"><span class="nav-number">2.4.</span> <span class="nav-text">frida使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida开发环境搭建"><span class="nav-number">2.5.</span> <span class="nav-text">frida开发环境搭建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FRIDA基础"><span class="nav-number">3.</span> <span class="nav-text">FRIDA基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#frida查看当前存在的进程"><span class="nav-number">3.1.</span> <span class="nav-text">frida查看当前存在的进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida打印参数和修改返回值"><span class="nav-number">3.2.</span> <span class="nav-text">frida打印参数和修改返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida寻找instance，主动调用。"><span class="nav-number">3.3.</span> <span class="nav-text">frida寻找instance，主动调用。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida-rpc"><span class="nav-number">3.4.</span> <span class="nav-text">frida rpc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida动态修改"><span class="nav-number">3.5.</span> <span class="nav-text">frida动态修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API-List"><span class="nav-number">3.6.</span> <span class="nav-text">API List</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida动静态结合分析"><span class="nav-number">4.</span> <span class="nav-text">Frida动静态结合分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Objection"><span class="nav-number">4.1.</span> <span class="nav-text">Objection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#objection启动并注入内存"><span class="nav-number">4.1.1.</span> <span class="nav-text">objection启动并注入内存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#objection-memory"><span class="nav-number">4.1.2.</span> <span class="nav-text">objection memory</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#查看内存中加载的module-memory-list-modules"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">查看内存中加载的module memory list modules</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查看库的导出函数-memory-list-exports-libssl-so"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">查看库的导出函数 memory list exports libssl.so</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#dump内存空间"><span class="nav-number">4.1.2.3.</span> <span class="nav-text">dump内存空间</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#搜索内存空间"><span class="nav-number">4.1.2.4.</span> <span class="nav-text">搜索内存空间</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#objection-android"><span class="nav-number">4.1.3.</span> <span class="nav-text">objection android</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#内存堆搜索实例-android-heap-search-instances-类名"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">内存堆搜索实例 android heap search instances 类名</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#调用实例的方法-android-heap-execute-实例ID-实例方法"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">调用实例的方法 android heap execute 实例ID 实例方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查看当前可用的activity或者service-android-hooking-list-activities-services"><span class="nav-number">4.1.3.3.</span> <span class="nav-text">查看当前可用的activity或者service android hooking list activities&#x2F;services</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#直接启动activity或者服务-android-intent-launch-activity-launch-service-activity-服务"><span class="nav-number">4.1.3.4.</span> <span class="nav-text">直接启动activity或者服务 android intent launch_activity&#x2F;launch_service activity&#x2F;服务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#列出内存中所有的类-android-hooking-list-classes"><span class="nav-number">4.1.3.5.</span> <span class="nav-text">列出内存中所有的类 android hooking list classes</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在内存中所有已加载的类中搜索包含特定关键词的类。-android-hooking-search-classes-display"><span class="nav-number">4.1.3.6.</span> <span class="nav-text">在内存中所有已加载的类中搜索包含特定关键词的类。 android hooking search classes display</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#内存中搜索指定类的所有方法-android-hooking-list-class-methods-类名"><span class="nav-number">4.1.3.7.</span> <span class="nav-text">内存中搜索指定类的所有方法 android hooking list class_methods 类名</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在内存中所有已加载的类的方法中搜索包含特定关键词的方法-android-hooking-search-methods-display"><span class="nav-number">4.1.3.8.</span> <span class="nav-text">在内存中所有已加载的类的方法中搜索包含特定关键词的方法 android hooking search methods display</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#hook类的方法（hook类里的所有方法-具体某个方法）"><span class="nav-number">4.1.3.9.</span> <span class="nav-text">hook类的方法（hook类里的所有方法&#x2F;具体某个方法）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grep-trick和文件保存"><span class="nav-number">4.1.4.</span> <span class="nav-text">grep trick和文件保存</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例学习"><span class="nav-number">4.2.</span> <span class="nav-text">案例学习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#案例学习case1-《仿VX数据库原型取证逆向分析》"><span class="nav-number">4.2.1.</span> <span class="nav-text">案例学习case1:《仿VX数据库原型取证逆向分析》</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#案例学习case2-主动调用爆破密码"><span class="nav-number">4.2.2.</span> <span class="nav-text">案例学习case2:主动调用爆破密码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-hook基础-一"><span class="nav-number">5.</span> <span class="nav-text">Frida hook基础(一)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-打印参数、返回值-设置返回值-主动调用"><span class="nav-number">5.1.</span> <span class="nav-text">Frida hook : 打印参数、返回值&#x2F;设置返回值&#x2F;主动调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-主动调用静态-非静态函数-以及-设置静态-非静态成员变量的值"><span class="nav-number">5.2.</span> <span class="nav-text">Frida hook : 主动调用静态&#x2F;非静态函数 以及 设置静态&#x2F;非静态成员变量的值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-内部类，枚举类的函数并hook，trace原型1"><span class="nav-number">5.3.</span> <span class="nav-text">Frida hook : 内部类，枚举类的函数并hook，trace原型1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-hook动态加载的dex，与查找interface，"><span class="nav-number">5.4.</span> <span class="nav-text">Frida hook : hook动态加载的dex，与查找interface，</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-枚举class，trace原型2"><span class="nav-number">5.5.</span> <span class="nav-text">Frida hook : 枚举class，trace原型2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-搜索interface的具体实现类"><span class="nav-number">5.6.</span> <span class="nav-text">Frida hook : 搜索interface的具体实现类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-hook基础（二"><span class="nav-number">6.</span> <span class="nav-text">Frida hook基础（二)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#spawn-attach"><span class="nav-number">6.1.</span> <span class="nav-text">spawn&#x2F;attach</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-hook构造函数-打印栈回溯"><span class="nav-number">6.2.</span> <span class="nav-text">Frida hook :hook构造函数&#x2F;打印栈回溯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-打印栈回溯"><span class="nav-number">6.3.</span> <span class="nav-text">Frida hook : 打印栈回溯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-手动加载dex并调用"><span class="nav-number">6.4.</span> <span class="nav-text">Frida hook : 手动加载dex并调用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida打印与参数构造"><span class="nav-number">7.</span> <span class="nav-text">Frida打印与参数构造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#char-Object-Object"><span class="nav-number">7.1.</span> <span class="nav-text">char[]&#x2F;[Object Object]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#byte"><span class="nav-number">7.2.</span> <span class="nav-text">byte[]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java-array构造"><span class="nav-number">7.3.</span> <span class="nav-text">java array构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类的多态：转型-Java-cast"><span class="nav-number">7.4.</span> <span class="nav-text">类的多态：转型&#x2F;Java.cast</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#interface-Java-registerClass"><span class="nav-number">7.5.</span> <span class="nav-text">interface&#x2F;Java.registerClass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员内部类-匿名内部类"><span class="nav-number">7.6.</span> <span class="nav-text">成员内部类&#x2F;匿名内部类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook-enum"><span class="nav-number">7.7.</span> <span class="nav-text">hook enum</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打印hash-map"><span class="nav-number">7.8.</span> <span class="nav-text">打印hash map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打印non-ascii"><span class="nav-number">7.9.</span> <span class="nav-text">打印non-ascii</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-native-hook-NDK开发入门"><span class="nav-number">8.</span> <span class="nav-text">Frida native hook : NDK开发入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-native-hook-JNIEnv和反射"><span class="nav-number">9.</span> <span class="nav-text">Frida native hook : JNIEnv和反射</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#以jni字符串来掌握基本的JNIEnv用法"><span class="nav-number">9.1.</span> <span class="nav-text">以jni字符串来掌握基本的JNIEnv用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Java反射"><span class="nav-number">9.2.</span> <span class="nav-text">Java反射</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida反调试"><span class="nav-number">10.</span> <span class="nav-text">Frida反调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-native-hook-符号hook-JNI、art-amp-libc"><span class="nav-number">11.</span> <span class="nav-text">Frida native hook : 符号hook JNI、art&amp;libc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native函数的Java-Hook及主动调用"><span class="nav-number">11.1.</span> <span class="nav-text">Native函数的Java Hook及主动调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jni-h头文件导入"><span class="nav-number">11.2.</span> <span class="nav-text">jni.h头文件导入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI函数符号hook"><span class="nav-number">11.3.</span> <span class="nav-text">JNI函数符号hook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI函数参数、返回值打印和替换"><span class="nav-number">11.4.</span> <span class="nav-text">JNI函数参数、返回值打印和替换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-native-hook-JNI-Onload-动态注册-inline-hook-native层调用栈打印"><span class="nav-number">12.</span> <span class="nav-text">Frida native hook : JNI_Onload&#x2F;动态注册&#x2F;inline_hook&#x2F;native层调用栈打印</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI-Onload-动态注册原理"><span class="nav-number">12.1.</span> <span class="nav-text">JNI_Onload&#x2F;动态注册原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida-hook-RegisterNative"><span class="nav-number">12.2.</span> <span class="nav-text">Frida hook RegisterNative</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#native层调用栈打印"><span class="nav-number">12.3.</span> <span class="nav-text">native层调用栈打印</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主动调用去进行方法参数替换"><span class="nav-number">12.4.</span> <span class="nav-text">主动调用去进行方法参数替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inline-hook"><span class="nav-number">12.5.</span> <span class="nav-text">inline hook</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-native-hook-Frida-hook-native-app实战"><span class="nav-number">13.</span> <span class="nav-text">Frida native hook : Frida hook native app实战</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-trace四件套"><span class="nav-number">14.</span> <span class="nav-text">Frida trace四件套</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jni-trace-trace-jni"><span class="nav-number">14.1.</span> <span class="nav-text">jni trace : trace jni</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#strace-trace-syscall"><span class="nav-number">14.2.</span> <span class="nav-text">strace : trace syscall</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida-trace-trace-libc-or-more"><span class="nav-number">14.3.</span> <span class="nav-text">frida-trace : trace libc(or more)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook-artmethod-trace-java函数调用"><span class="nav-number">14.4.</span> <span class="nav-text">hook_artmethod : trace java函数调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改AOSP源码打印"><span class="nav-number">14.5.</span> <span class="nav-text">修改AOSP源码打印</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida-native-hook-init-array开发和自动化逆向"><span class="nav-number">15.</span> <span class="nav-text">Frida native hook : init_array开发和自动化逆向</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#init-array原理"><span class="nav-number">15.1.</span> <span class="nav-text">init_array原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDA静态分析init-array"><span class="nav-number">15.2.</span> <span class="nav-text">IDA静态分析init_array</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDA动态调试so"><span class="nav-number">15.3.</span> <span class="nav-text">IDA动态调试so</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init-array-amp-amp-JNI-Onload-“自吐”"><span class="nav-number">15.4.</span> <span class="nav-text">init_array &amp;&amp; JNI_Onload “自吐”</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JNI-Onload"><span class="nav-number">15.4.1.</span> <span class="nav-text">JNI_Onload</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#init-array"><span class="nav-number">15.4.2.</span> <span class="nav-text">init_array</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#native层未导出函数主动调用（任意符号和地址）"><span class="nav-number">15.5.</span> <span class="nav-text">native层未导出函数主动调用（任意符号和地址）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-C-hook"><span class="nav-number">16.</span> <span class="nav-text">C&#x2F;C++ hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native-JNI层参数打印和主动调用参数构造"><span class="nav-number">16.1.</span> <span class="nav-text">Native&#x2F;JNI层参数打印和主动调用参数构造</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#C-C-编成so并引入Frida调用其中的函数"><span class="nav-number">16.2.</span> <span class="nav-text">C&#x2F;C++编成so并引入Frida调用其中的函数</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sakura</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'oSjxVuchxdK82iyIiuzHtfiV-gzGzoHsz',
        appKey: 'MK8tCWwU3RWlWQdEA0wOH8Dw',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("oSjxVuchxdK82iyIiuzHtfiV-gzGzoHsz", "MK8tCWwU3RWlWQdEA0wOH8Dw");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
